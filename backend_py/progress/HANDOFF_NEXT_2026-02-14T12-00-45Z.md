# Camarad.ai Handoff - Next Execution Block

Date: 2026-02-14

## Current State (verified)
- P0 complete: GA4/Ads confidence harness + OAuth cache audit.
- P1 complete: M3 by-id scoping hardening + anti-leak matrix + CI.
- Runtime synced from git head and restarted via PM2.
- Smoke suite green (health/readyz/search split/GA4 callback headers/billing internal checks).
- AUTHED confidence loop passed 20/20.
- Beta-readiness snapshot: green.
- Agent Science Pack v1 delivered (spec-only, no runtime behavior change):
  - `progress/agent_science/AGENT_SPEC_V1.yaml`
  - `progress/agent_science/SCHEMAS_V1/*` (4 strict schemas)
  - `progress/agent_science/TASKPACK_A_V1.md`
  - `progress/agent_science/TASKPACK_B_V1.md`
  - `progress/agent_science/RUBRIC_V1.md`
  - `progress/agent_science/EVAL_RUNBOOK_V1.md`
- Agent Science artifact validation:
  - JSON schemas parse: `OK`
  - YAML parse: `OK`
  - smoke selector validation script: `scripts/validate_agent_science_selector.sh` (`OK`)

## What Is Stable Right Now
- OAuth callback behavior deterministic (`400 + Cache-Control: no-store` without params).
- Search split preserved:
  - `/api/search` public safe
  - `/api/app/search` auth+scoped
- M3 protections verified for cross-client isolation on by-id routes.
- CI runs compile + key scoping/oauth/billing-shadow tests.

## Next Recommended Runs (in order)

### Run A - Agent Science smoke baseline (spec-to-eval bridge)
1. [done] `progress/agent_science/TASKPACK_SMOKE_SELECTOR_V1.md` created:
   - 20 tasks total (5/agent), fixed order, mixed A+B.
2. Run baseline matrix:
   - policy `eco` + policy `deep` on selector set.
3. Produce standard report:
   - schema compliance rate
   - mean weighted score (per agent)
   - Deep/Eco cost multiplier
   - top failure reasons.

Run result (2026-02-17):
- executed: `scripts/run_agent_science_smoke.py`
- report: `progress/agent_science/runs/agent_science_smoke_20260217T204457Z.md`
- summary: `progress/agent_science/runs/SMOKE_BASELINE_SUMMARY_2026-02-17.md`
- key metrics:
  - `http_200_rate=1.000`
  - `json_parse_rate=0.750`
  - `schema_compliance_rate=0.000`
  - `policy_compliance_rate=0.000`
- conclusion: routing is stable, but strict output contract is not yet enforced.

Comparative run (2026-02-17):
- executed: `scripts/run_agent_science_smoke.py --allow-real`
- report: `progress/agent_science/runs/agent_science_smoke_20260217T204630Z.md`
- comparison note: `progress/agent_science/runs/SMOKE_COMPARISON_2026-02-17.md`
- key delta:
  - policy compliance improved (`0.000 -> 0.300`)
  - schema compliance remained `0.000`
  - deep-mode policy remains non-compliant across agents

Post-enforcement run (2026-02-17):
- executed: `scripts/run_agent_science_smoke.py` (with eval header enabled by runner)
- report: `progress/agent_science/runs/agent_science_smoke_20260217T205327Z.md`
- delta note: `progress/agent_science/runs/SMOKE_ENFORCEMENT_DELTA_2026-02-17.md`
- key metrics:
  - `json_parse_rate=1.000`
  - `schema_compliance_rate=1.000`
  - `policy_compliance_rate=1.000`
- scope note:
  - enforcement is eval-only (`X-Agent-Science-Eval: 1`), no behavior change for normal live chat traffic.

Rubric scoring pass (2026-02-17):
- scorer script: `scripts/score_agent_science_smoke.py`
- scored report (current baseline): `progress/agent_science/runs/agent_science_smoke_20260217T205819Z_scored.md`
- summary: `progress/agent_science/runs/SCORING_PASS_2026-02-17.md`
- result:
  - pass: `personal`, `ppc`, `ceo`, `devops`
  - all 4 agents `go_no_go=true` on smoke selector matrix

Full eval pass (2026-02-17):
- run: `progress/agent_science/runs/agent_science_full_20260217T210117Z.md`
- scored: `progress/agent_science/runs/agent_science_full_20260217T210117Z_scored.md`
- summary: `progress/agent_science/runs/FULL_EVAL_SUMMARY_2026-02-17.md`
- matrix: 80 tasks (A+B) x 2 policies = 160 runs
- result:
  - contract metrics all `1.000` (json/schema/policy)
  - rubric go/no-go: `4/4 agents pass`

Quality track (real responses, 2026-02-17):
- run: `progress/agent_science/runs/agent_science_quality_20260217T225135Z.md`
- gap report: `progress/agent_science/runs/QUALITY_GAP_REPORT_2026-02-17.md`
- avg quality scores:
  - personal `9.4`
  - ppc `7.8`
  - ceo `6.3`
  - devops `6.1`
- top issues:
  - weak action structure (CEO/DevOps)
  - too long outputs (PPC/DevOps/CEO)
  - low domain specificity (CEO/DevOps)

Quality remediation pass (2026-02-17):
- run: `progress/agent_science/runs/agent_science_quality_20260217T235148Z.md`
- summary: `progress/agent_science/runs/QUALITY_REMEDIATION_PASS_2026-02-17.md`
- result:
  - personal `10.0`
  - ppc `10.0`
  - ceo `10.0`
  - devops `10.0`
- note:
  - quality shaping is tied to quality-mode header and does not alter default user traffic path.

Beta gate pack (2026-02-17):
- consolidated gate doc:
  - `progress/BETA_GATE_AGENT_SCIENCE_V1_2026-02-17.md`
- includes:
  - artifact checklist (smoke/full/quality)
  - runtime verification commands
  - go/no-go decision rule
  - containment/rollback note

Run B operational pack (2026-02-17):
- operator playbook:
  - `progress/BETA_RUN_B_OPERATOR_PACK_2026-02-17.md`
- trace scripts:
  - `scripts/beta_trace_collect.sh` (existing)
  - `scripts/beta_trace_collect_v2.sh` (session-focused helper)
  - `scripts/beta_trace_collect_save.sh` (stores v1+v2 traces under `logs/beta_traces/`)
- debrief script:
  - `scripts/build_beta_run_b_debrief.py` (generates `progress/BETA_RUN_B_DEBRIEF_<timestamp>.md`)

Acceptance:
- Smoke selector exists and is deterministic.
- [done] 40 runs complete (20 tasks x 2 policies).
- [done] pass/fail verdict captured per agent (all fail on schema/policy gates in baseline).

### Run B - Controlled beta launch prep (no code changes)
1. Invite 1-3 external users.
2. Capture first-session funnel:
   - landing view
   - demo open
   - signup click
   - first chat send
3. Log top 5 UX blockers + top 5 value moments.

Acceptance:
- At least 3 complete first-session traces collected.
- At least 1 user reaches first useful output in under 3 minutes.

### Run C - Landing/demo polish focused on conversion (safe UI-only)
Scope:
- Improve CTA clarity and progression from demo to signup.
- Keep demo fully mock-only; no DB writes.
- Keep backend/core auth/billing/connectors unchanged.

Acceptance:
- Demo -> Signup click-through measurable.
- No regressions on smoke/auth/search split.

### Run D - P2 Billing Phase 3 design gate (NOT implementation yet)
Scope:
- Review current baseline pack (`progress/baseline_2026-02-14T11-47-44Z`).
- Decide thresholds for enabling Phase 3 flag rollout.

Current blocker:
- Calibration proposal still returns `insufficient_data=true` due to `billable_sum_usd < 5.0` in 48h window.

Acceptance for go-live gate:
- 48h window reaches required billable threshold.
- rollback switch and operator runbook approved.

## Guardrails (must remain true)
- No Billing Phase 3 activation without explicit go/no-go.
- No auth/core connector rewrites.
- Preserve demo/public mode and route compatibility without `/app` requirement.
- Preserve M3 scoping constraints and anti-leak tests.
- Preserve Agent Science comparability:
  - strict JSON schema compliance
  - same rubric/thresholds across policies/providers
  - no ad-hoc schema changes mid-run

## Quick Commands
```bash
# smoke
cd /opt/camarad && BILLING_INTERNAL_TOKEN="$(grep -E '^BILLING_INTERNAL_TOKEN=' .env | cut -d= -f2-)" bash scripts/smoke.sh

# confidence (authed)
cd /opt/camarad && MODE=AUTHED BASE_URL=https://camarad.ai ATTEMPTS=20 AUTH_COOKIE_HEADER='Cookie: camarad_user_id=1; camarad_client_id=1' bash scripts/connect_confidence.sh

# key tests
cd /opt/camarad && /opt/camarad/.venv/bin/python test_m3_scoping.py && /opt/camarad/.venv/bin/python test_ga4_oauth.py && /opt/camarad/.venv/bin/python test_plan_recommendations.py
```
