# Status Snapshot - 2026-02-12

## Executive Summary

Camarad.ai a trecut de la sandbox local mock-first la productie functionala cu:
- auth real (Google OAuth via Coolbits),
- onboarding real,
- conectori Google Ads si GA4 pe date reale (cu fallback sigur),
- billing/Stripe integrat in Settings,
- pricing public dedicat,
- UX major rearanjat pentru chat-centric workflow.

Stackul este stabil in productie, iar focusul curent este polish pe GA4 OAuth edge cases + planuri Stripe/entitlements + grounding pentru primii agenti reali.

### Update P0/P1 (2026-02-13)
- P0 confidence pass tooling livrat:
  - `scripts/connect_confidence.sh` (20-attempt harness GA4 + Ads, mod AUTHED/MOCK, retry pe 502/503/504, fail-fast pe 401/404).
  - `docs/OAUTH_CLOUDFLARE_AUDIT.md` (paths obligatorii pentru bypass + comenzi `curl -I` + expected headers).
  - `scripts/smoke.sh` actualizat: callback GA4 trebuie sa raspunda explicit `400` + `Cache-Control: no-store`.
- P1 M3 by-id audit extins:
  - hardening by-id pentru boardroom meetings (`user_id` + `client_id` scope) si `PATCH /api/client_connectors/<id>` (izolare cross-client owned).
  - `test_m3_scoping.py` extins cu matrix by-id:
    - flow by-id (client A vs B),
    - client connector by-id patch isolation,
    - boardroom meeting by-id isolation + missing scope 400.
- CI livrat:
  - `.github/workflows/ci.yml` ruleaza `py_compile` + `test_m3_scoping.py` + `test_ga4_oauth.py` + `test_plan_recommendations.py`.

## Ce este livrat end-to-end pana acum

### 1) Foundation + Deploy
- Deploy edge finalizat pe:
  - `camarad.ai`
  - `www.camarad.ai`
  - `api.camarad.ai`
- Runtime: Gunicorn sub PM2, Nginx reverse proxy, SSL activ.
- Health checks: `/healthz`, `/readyz`.
- Backup automat local: script + timer daily.
- Log hygiene: filtrare trafic de scan zgomotos.

### 2) Auth real + onboarding real
- `/signup` functional cu Google OAuth prin Coolbits.
- Session bridge real in Camarad (`/api/auth/session`, `/api/auth/status`, `/api/auth/logout`).
- Onboarding real (`/onboarding`, `POST /api/auth/onboarding`).
- Private routes gated corect pentru user neautentificat.

### 3) UX/Product updates majore
- Sidebar refactor:
  - `Home` inlocuit cu `Chat` (routing default spre chat)
  - user menu mutat in footer sidebar (fixed)
  - top `New Chat` redundant eliminat
- Chat Home v2:
  - grid compact de agenti, responsive (5/4/3/2/1 coloane in functie de viewport)
  - quick select + filtrare workspace
- Avatar pipeline placeholder imbunatatit (contained strict in cerc).
- Branding Camarad actualizat (logo + icon usage in zone critice).

### 3.1) Landing polish + onboarding wow (incremental)
- Landing v1 extins:
  - autocomplete public (`GET /api/search`) pentru agenti/conectori/template-uri
  - hardening public search: query sanitization + max length + deterministic results (fara scoping headers/DB sensitive lookup)
  - split search surface: `GET /api/search` (public, static-safe) + `GET /api/app/search` (auth required, scoped)
  - CTA principal `Start with Google` (`/signup?next=/app`)
  - CTA secundar `Try demo (no login)` (`/chat-demo`)
  - blocuri explicite: "What you get in 60 seconds", "How it works", "Proof layer"
- Demo onboarding safe:
  - ruta publica `/chat-demo` (mock-only, fara DB writes)
  - suport `?demo=1` pe `/chat` pentru user neautentificat
  - banner clar "No saving Â· Mock responses"
- Ops:
  - smoke script extins cu verificari `/`, `/signup`, `/chat-demo`, `/api/search?q=ppc`

### 4) Connectors: Google Ads (M2.A)
- Gateway Coolbits activat cu feature flag + fallback mock robust.
- Rezolvat flow MCC:
  - selector cont + support MCC ID
  - listing child accounts din manager account
- Date reale afisate in UI (campaigns/live metrics), cu mapare payload stabilizata.
- Eliminat consum CT pentru operatiuni de configurare connector.
- Date-range control disponibil direct in taburile de lucru (nu doar in Settings).

### 5) Connectors: GA4 (M2.B partial complete)
- GA4 live wiring functional pe taburi principale (overview + analytics views).
- Date reale vizibile din Coolbits in productie.
- Persista edge case OAuth callback (intermitent 404 in unele redirecturi/host-uri), dar conexiunea devine activa dupa refresh in majoritatea cazurilor.
- Necesita inchidere finala pentru flow OAuth determinist pe toate host-urile.

### 6) Agents real runtime (start)
- Agentii ruleaza pe model live (Vertex path existent din Coolbits).
- Primii agenti activi pentru iteratie:
  - Personal Assistant
  - PPC Specialist
  - SEO & Content Strategist
- Stare curenta: functionali, dar inca necesita grounding fin pe rol (evitare raspunsuri generice de tip "I am a large language model...").

### 7) Orchestrator demo readiness
- Template live introdus: `Growth War Room (Live Ads + GA4)`.
- Ruleaza cap-coada cu trace, folosind date reale cand gateway este ON.
- Fallback mock explicit cand sursa reala nu raspunde.

### 8) Billing/Stripe + Pricing
- Billing tab dedicat in Settings.
- Flux de upgrade directionat spre Stripe checkout (nu simpla schimbare locala de plan).
- Enforced: planurile paid cer subscriptie activa.
- Pagina publica `/pricing` livrata + link in landing footer.
- Moneda normalizata la EUR in pricing/billing payload-uri Camarad.
- Adaugate linkuri rapide `Billing & Subscriptions` si `Pricing` in meniul user.

### 10) Billing telemetry engine (shadow mode)
- Faza 1: livrata (non-blocking, fara debit real CT):
  - `usage_ledger` extins cu request idempotency (`request_id`), provider/model/tokens/latency/cost fields.
  - logging shadow introdus pe punctele grele (chat, spend, flow/rag/asset/boardroom paths).
  - `request_id` propagat frontend->backend pentru corelare determinista.
- Faza 2: in executie (tot shadow, fara impact pe balanta):
  - tabele `pricing_catalog` + `ct_rates` initializate.
  - calcul `billable_usd` + `ct_shadow_debit` in finalize helper.
  - `ct_actual_debit` corelat din `/api/user/spend` pe acelasi `request_id`.
  - endpoint intern `GET /api/billing/cost-telemetry` securizat cu `X-Internal-Token`, include:
    - agregate 24h/7d,
    - top models/agents,
    - delta `ct_shadow - ct_actual`,
    - ultimele tranzactii.
  - adaugat endpoint intern `POST /api/billing/shadow-sync`:
    - seed automat pricing pentru modelele observate in usage (fallback heuristic),
    - backfill shadow pentru request-uri recente cu tokens, dar fara cost calculat.
  - telemetry extins cu `implied_ct_value_usd` (24h/7d) + indicatori de coverage (`rows_with_tokens/cost/billable`).
  - auto-calibrare shadow v1:
    - `GET /api/billing/calibration-proposal?window_hours=...` (read-only, cu guardrails si confidence),
    - `POST /api/billing/calibration-apply` (recalc server-side, aplica doar daca datele sunt suficiente; altfel `409`).
  - apply inchide rata anterioara din `ct_rates` si creeaza versiune noua marcata explicit `scope=shadow` in notes.
- Validare:
  - smoke local trecut (insert shadow + telemetry auth + snapshot fields),
  - compile backend trecut.

### 9) Public legal/trust pages
- `/legal`, `/privacy`, `/terms` populate v1 real.
- `/pricing` inclus in navigatia publica.

## Ce ramane deschis (prioritar)

1. **GA4 OAuth callback polish**
- elimina definitiv redirect-urile 404 de dupa consent.
- unifica callback behavior pentru toate host-urile folosite (`coolbits.ai`, `cloud.cblm.ai`, `camarad.ai` unde e cazul).

2. **Stripe entitlements alignment**
- planurile din UI trebuie aliniate 1:1 cu produse/price IDs reale din Stripe.
- limitele (workspaces/projects/agents/connectors/tokens) trebuie aplicate server-side unitar.

2.1 **Calibrare economica pe date reale (nou)**
- ruleaza 48h shadow telemetry pe trafic real.
- fixeaza `ct_value`, `buffer`, `margin` dupa delta reala si target de marja.
- abia dupa calibrare activeaza debitul CT bazat pe cost real.

3. **Agent grounding v1**
- definire rol + boundaries + handoff rules pentru cei 3 agenti principali.
- introducere sugestii contextuale dinamice in chat composer.

4. **Client-scoping audit (M3)**
- audit endpoint-uri + teste anti-leak cross-client.

## Stare milestone (roadmap quick view)

- M0 Edge Migration Baseline: `done`
- M1 Reliability Hardening: `done` (cu mici operatiuni de mentenanta continue)
- M2.A Google Ads real: `done`
- M2.B GA4 real: `in_progress (80-90%)`
- M2.C Billing/Stripe productionization: `in_progress`
- M2.C.1 Billing telemetry shadow (truth-first): `done (Faza 1)` + `in_progress (Faza 2)`
- M3 Client-scoping audit: `next`
- M4 Orchestrator production pack: `in_progress`

## Operational notes

- Coolbits ramane backend comercial principal (OAuth + gateway + billing source), Camarad consumator.
- Directia strategica discutata: convergenta Coolbits/Camarad pe feature parity (single product core, branding diferit).
- Recomandare: unificare entitlement + billing + connector gateway intr-un strat comun, apoi UI parity incremental.

### Daily confidence run (2026-02-14T11:56:11Z)
- GA4/Ads AUTHED confidence harness:         Result: 20/20 attempts passed.
- Smoke suite: green (healthz/readyz/public search/app-search guard/GA4 callback no-store/billing internal checks)
- Notes: no new critical errors in PM2 logs (only expected Gunicorn/gevent SystemExit on restarts).

### Update P2 (2026-02-14)
- Billing Phase 3 code path added behind flag `BILLING_PHASE3_ENABLED` (OFF by default).
- New idempotent phase3 debit by `request_id` with server-side caps (`MAX_CT_PER_REQUEST`, `MAX_DAILY_CT_PER_WORKSPACE`).
- `/api/billing/cost-telemetry` extended with `phase3` metrics (`applied_count`, `ct_debit_applied_sum`, `cap_reject_count`, reasons).
- Added `test_billing_phase3.py` for flag OFF/ON behavior, idempotency, and cap rejection without debit.
