{% extends "base.html" %}

{% block content %}
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2>Connectors & Integrations</h2>
          <div class="input-group" style="width: 300px;">
            <input type="text" class="form-control bg-dark text-light border-secondary" placeholder="Search connectors..." id="searchInput">
            <button class="btn btn-outline-secondary" type="button"><i class="bi bi-search"></i></button>
          </div>
        </div>

        <!-- Content Area -->
        <div id="contentArea">
          <!-- Connectors List -->
          <div id="connectorsList">
            <!-- Google Stack -->
            <h6 class="text-muted mb-3 mt-4">Google Stack</h6>
            <div class="row g-3 mb-4">
              <div class="col-md-6 col-lg-4">
                <div class="card bg-dark border-secondary h-100">
                  <div class="card-body">
                    <h6 class="card-title">Google Ads</h6>
                    <p class="card-text text-muted small">Campaign reporting and spend insights</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-warning text-dark connector-status" data-slug="google-ads">Soon</span>
                      <button class="btn btn-sm btn-outline-primary" data-slug="google-ads" onclick="configureConnector('google-ads', 'Google Ads')">Configure</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="card bg-dark border-secondary h-100">
                  <div class="card-body">
                    <h6 class="card-title">Google Analytics 4 (GA4)</h6>
                    <p class="card-text text-muted small">Traffic, engagement, and events analytics</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-warning text-dark connector-status" data-slug="ga4">Soon</span>
                      <button class="btn btn-sm btn-outline-primary" data-slug="ga4" onclick="configureConnector('ga4', 'Google Analytics 4 (GA4)')">Configure</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="card bg-dark border-secondary h-100">
                  <div class="card-body">
                    <h6 class="card-title">Google Search Console</h6>
                    <p class="card-text text-muted small">SEO performance and indexing</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-warning text-dark">Soon</span>
                      <button class="btn btn-sm btn-outline-primary" onclick="configureConnector('google-search-console', 'Google Search Console')">Configure</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="card bg-dark border-secondary h-100">
                  <div class="card-body">
                    <h6 class="card-title">Google Tag Manager</h6>
                    <p class="card-text text-muted small">Tag and event management</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-warning text-dark">Soon</span>
                      <button class="btn btn-sm btn-outline-primary" onclick="configureConnector('google-tag-manager', 'Google Tag Manager')">Configure</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="card bg-dark border-secondary h-100">
                  <div class="card-body">
                    <h6 class="card-title">Google Business Profile (GBP)</h6>
                    <p class="card-text text-muted small">Local business listings</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-warning text-dark">Soon</span>
                      <button class="btn btn-sm btn-outline-primary" onclick="configureConnector('google-business-profile', 'Google Business Profile (GBP)')">Configure</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="card bg-dark border-secondary h-100">
                  <div class="card-body">
                    <h6 class="card-title">Google Merchant Center</h6>
                    <p class="card-text text-muted small">Product feed and shopping</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-warning text-dark">Soon</span>
                      <button class="btn btn-sm btn-outline-primary" onclick="configureConnector('google-merchant-center', 'Google Merchant Center')">Configure</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="card bg-dark border-secondary h-100">
                  <div class="card-body">
                    <h6 class="card-title">Google Calendar</h6>
                    <p class="card-text text-muted small">Events and availability</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-warning text-dark">Soon</span>
                      <button class="btn btn-sm btn-outline-primary" onclick="configureConnector('google-calendar', 'Google Calendar')">Configure</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="card bg-dark border-secondary h-100">
                  <div class="card-body">
                    <h6 class="card-title">Google Drive / Docs / Sheets</h6>
                    <p class="card-text text-muted small">File storage and docs</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-warning text-dark">Soon</span>
                      <button class="btn btn-sm btn-outline-primary" onclick="configureConnector('google-drive', 'Google Drive / Docs / Sheets')">Configure</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="card bg-dark border-secondary h-100">
                  <div class="card-body">
                    <h6 class="card-title">Gmail</h6>
                    <p class="card-text text-muted small">Email access and labels</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-warning text-dark">Soon</span>
                      <button class="btn btn-sm btn-outline-primary" onclick="configureConnector('gmail', 'Gmail')">Configure</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="card bg-dark border-secondary h-100">
                  <div class="card-body">
                    <h6 class="card-title">Google Cloud Platform</h6>
                    <p class="card-text text-muted small">Cloud infra and services</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-warning text-dark">Soon</span>
                      <button class="btn btn-sm btn-outline-primary" onclick="configureConnector('google-cloud-platform', 'Google Cloud Platform')">Configure</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="card bg-dark border-secondary h-100">
                  <div class="card-body">
                    <h6 class="card-title">Google Gemini</h6>
                    <p class="card-text text-muted small">AI model access</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-warning text-dark">Soon</span>
                      <button class="btn btn-sm btn-outline-primary" onclick="configureConnector('google-gemini', 'Google Gemini')">Configure</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Meta & Social Ads -->
            <h6 class="text-muted mb-3">Meta & Social Ads</h6>
            <div class="row g-3 mb-4">
              <div class="col-md-6 col-lg-4">
                <div class="card bg-dark border-secondary h-100">
                  <div class="card-body">
                    <h6 class="card-title">Meta Ads (Facebook + Instagram)</h6>
                    <p class="card-text text-muted small">Social media advertising</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-warning text-dark">Soon</span>
                      <button class="btn btn-sm btn-outline-primary" onclick="configureConnector('meta-ads', 'Meta Ads (Facebook + Instagram)')">Configure</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="card bg-dark border-secondary h-100">
                  <div class="card-body">
                    <h6 class="card-title">TikTok Ads</h6>
                    <p class="card-text text-muted small">Short-form video ads</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-warning text-dark">Soon</span>
                      <button class="btn btn-sm btn-outline-primary" onclick="configureConnector('tiktok-ads', 'TikTok Ads')">Configure</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="card bg-dark border-secondary h-100">
                  <div class="card-body">
                    <h6 class="card-title">LinkedIn Ads</h6>
                    <p class="card-text text-muted small">B2B professional ads</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-warning text-dark">Soon</span>
                      <button class="btn btn-sm btn-outline-primary" onclick="configureConnector('linkedin-ads', 'LinkedIn Ads')">Configure</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="card bg-dark border-secondary h-100">
                  <div class="card-body">
                    <h6 class="card-title">Twitter/X Ads</h6>
                    <p class="card-text text-muted small">Real-time conversation ads</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-warning text-dark">Soon</span>
                      <button class="btn btn-sm btn-outline-primary" onclick="configureConnector('twitter-ads', 'Twitter/X Ads')">Configure</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="card bg-dark border-secondary h-100">
                  <div class="card-body">
                    <h6 class="card-title">Pinterest Ads</h6>
                    <p class="card-text text-muted small">Visual discovery ads</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-warning text-dark">Soon</span>
                      <button class="btn btn-sm btn-outline-primary" onclick="configureConnector('pinterest-ads', 'Pinterest Ads')">Configure</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="card bg-dark border-secondary h-100">
                  <div class="card-body">
                    <h6 class="card-title">Snapchat Ads</h6>
                    <p class="card-text text-muted small">Youth-focused ads</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-warning text-dark">Soon</span>
                      <button class="btn btn-sm btn-outline-primary" onclick="configureConnector('snapchat-ads', 'Snapchat Ads')">Configure</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- AI & LLM Stack -->
            <h6 class="text-muted mb-3">AI & LLM Stack</h6>
            <div class="row g-3 mb-4">
              <div class="col-md-6 col-lg-4">
                <div class="card bg-dark border-secondary h-100">
                  <div class="card-body">
                    <h6 class="card-title">xAI / Grok API</h6>
                    <p class="card-text text-muted small">Grok model access</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-warning text-dark">Soon</span>
                      <button class="btn btn-sm btn-outline-primary" onclick="configureConnector('xai-grok', 'xAI / Grok API')">Configure</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="card bg-dark border-secondary h-100">
                  <div class="card-body">
                    <h6 class="card-title">OpenAI</h6>
                    <p class="card-text text-muted small">GPT-4o, o1, etc.</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-warning text-dark">Soon</span>
                      <button class="btn btn-sm btn-outline-primary" onclick="configureConnector('openai', 'OpenAI')">Configure</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="card bg-dark border-secondary h-100">
                  <div class="card-body">
                    <h6 class="card-title">Anthropic (Claude)</h6>
                    <p class="card-text text-muted small">Claude 3.5, etc.</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-warning text-dark">Soon</span>
                      <button class="btn btn-sm btn-outline-primary" onclick="configureConnector('anthropic', 'Anthropic (Claude)')">Configure</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="card bg-dark border-secondary h-100">
                  <div class="card-body">
                    <h6 class="card-title">Google Gemini</h6>
                    <p class="card-text text-muted small">Gemini models</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-warning text-dark">Soon</span>
                      <button class="btn btn-sm btn-outline-primary" onclick="configureConnector('google-gemini-ai', 'Google Gemini')">Configure</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="card bg-dark border-secondary h-100">
                  <div class="card-body">
                    <h6 class="card-title">Meta Llama</h6>
                    <p class="card-text text-muted small">Llama via Groq/Together</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-warning text-dark">Soon</span>
                      <button class="btn btn-sm btn-outline-primary" onclick="configureConnector('meta-llama', 'Meta Llama')">Configure</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="card bg-dark border-secondary h-100">
                  <div class="card-body">
                    <h6 class="card-title">Mistral</h6>
                    <p class="card-text text-muted small">Mistral models</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-warning text-dark">Soon</span>
                      <button class="btn btn-sm btn-outline-primary" onclick="configureConnector('mistral', 'Mistral')">Configure</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="card bg-dark border-secondary h-100">
                  <div class="card-body">
                    <h6 class="card-title">Cohere</h6>
                    <p class="card-text text-muted small">Cohere models</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-warning text-dark">Soon</span>
                      <button class="btn btn-sm btn-outline-primary" onclick="configureConnector('cohere', 'Cohere')">Configure</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="card bg-dark border-secondary h-100">
                  <div class="card-body">
                    <h6 class="card-title">Perplexity API</h6>
                    <p class="card-text text-muted small">Perplexity search</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-warning text-dark">Soon</span>
                      <button class="btn btn-sm btn-outline-primary" onclick="configureConnector('perplexity', 'Perplexity API')">Configure</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="card bg-dark border-secondary h-100">
                  <div class="card-body">
                    <h6 class="card-title">Hugging Face Inference</h6>
                    <p class="card-text text-muted small">Open models</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-warning text-dark">Soon</span>
                      <button class="btn btn-sm btn-outline-primary" onclick="configureConnector('hugging-face', 'Hugging Face Inference')">Configure</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="card bg-dark border-secondary h-100">
                  <div class="card-body">
                    <h6 class="card-title">Groq</h6>
                    <p class="card-text text-muted small">Fast inference</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-warning text-dark">Soon</span>
                      <button class="btn btn-sm btn-outline-primary" onclick="configureConnector('groq', 'Groq')">Configure</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Development & Infra -->
            <h6 class="text-muted mb-3">Development & Infra</h6>
            <div class="row g-3 mb-4">
              <div class="col-md-6 col-lg-4">
                <div class="card bg-dark border-secondary h-100">
                  <div class="card-body">
                    <h6 class="card-title">GitHub</h6>
                    <p class="card-text text-muted small">Repos, commits, issues, PRs</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-warning text-dark">Soon</span>
                      <button class="btn btn-sm btn-outline-primary" onclick="configureConnector('github', 'GitHub')">Configure</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="card bg-dark border-secondary h-100">
                  <div class="card-body">
                    <h6 class="card-title">GitLab</h6>
                    <p class="card-text text-muted small">GitLab repos and CI</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-warning text-dark">Soon</span>
                      <button class="btn btn-sm btn-outline-primary" onclick="configureConnector('gitlab', 'GitLab')">Configure</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="card bg-dark border-secondary h-100">
                  <div class="card-body">
                    <h6 class="card-title">Bitbucket</h6>
                    <p class="card-text text-muted small">Atlassian repos</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-warning text-dark">Soon</span>
                      <button class="btn btn-sm btn-outline-primary" onclick="configureConnector('bitbucket', 'Bitbucket')">Configure</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="card bg-dark border-secondary h-100">
                  <div class="card-body">
                    <h6 class="card-title">Docker Hub</h6>
                    <p class="card-text text-muted small">Container registry</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-warning text-dark">Soon</span>
                      <button class="btn btn-sm btn-outline-primary" onclick="configureConnector('docker-hub', 'Docker Hub')">Configure</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="card bg-dark border-secondary h-100">
                  <div class="card-body">
                    <h6 class="card-title">AWS</h6>
                    <p class="card-text text-muted small">EC2/S3/Lambda</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-warning text-dark">Soon</span>
                      <button class="btn btn-sm btn-outline-primary" onclick="configureConnector('aws', 'AWS')">Configure</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="card bg-dark border-secondary h-100">
                  <div class="card-body">
                    <h6 class="card-title">Microsoft Azure</h6>
                    <p class="card-text text-muted small">Cloud services</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-warning text-dark">Soon</span>
                      <button class="btn btn-sm btn-outline-primary" onclick="configureConnector('azure', 'Microsoft Azure')">Configure</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="card bg-dark border-secondary h-100">
                  <div class="card-body">
                    <h6 class="card-title">Vercel</h6>
                    <p class="card-text text-muted small">Frontend deployment</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-warning text-dark">Soon</span>
                      <button class="btn btn-sm btn-outline-primary" onclick="configureConnector('vercel', 'Vercel')">Configure</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="card bg-dark border-secondary h-100">
                  <div class="card-body">
                    <h6 class="card-title">Netlify</h6>
                    <p class="card-text text-muted small">Static hosting</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-warning text-dark">Soon</span>
                      <button class="btn btn-sm btn-outline-primary" onclick="configureConnector('netlify', 'Netlify')">Configure</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="card bg-dark border-secondary h-100">
                  <div class="card-body">
                    <h6 class="card-title">Render</h6>
                    <p class="card-text text-muted small">Full-stack hosting</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-warning text-dark">Soon</span>
                      <button class="btn btn-sm btn-outline-primary" onclick="configureConnector('render', 'Render')">Configure</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="card bg-dark border-secondary h-100">
                  <div class="card-body">
                    <h6 class="card-title">Sentry</h6>
                    <p class="card-text text-muted small">Error tracking</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-warning text-dark">Soon</span>
                      <button class="btn btn-sm btn-outline-primary" onclick="configureConnector('sentry', 'Sentry')">Configure</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="card bg-dark border-secondary h-100">
                  <div class="card-body">
                    <h6 class="card-title">Datadog</h6>
                    <p class="card-text text-muted small">Monitoring</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-warning text-dark">Soon</span>
                      <button class="btn btn-sm btn-outline-primary" onclick="configureConnector('datadog', 'Datadog')">Configure</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="card bg-dark border-secondary h-100">
                  <div class="card-body">
                    <h6 class="card-title">SonarQube</h6>
                    <p class="card-text text-muted small">Code quality</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-warning text-dark">Soon</span>
                      <button class="btn btn-sm btn-outline-primary" onclick="configureConnector('sonarqube', 'SonarQube')">Configure</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="card bg-dark border-secondary h-100">
                  <div class="card-body">
                    <h6 class="card-title">Snyk</h6>
                    <p class="card-text text-muted small">Security scanning</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-warning text-dark">Soon</span>
                      <button class="btn btn-sm btn-outline-primary" onclick="configureConnector('snyk', 'Snyk')">Configure</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="card bg-dark border-secondary h-100">
                  <div class="card-body">
                    <h6 class="card-title">GitHub Actions</h6>
                    <p class="card-text text-muted small">CI/CD</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-warning text-dark">Soon</span>
                      <button class="btn btn-sm btn-outline-primary" onclick="configureConnector('github-actions', 'GitHub Actions')">Configure</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="card bg-dark border-secondary h-100">
                  <div class="card-body">
                    <h6 class="card-title">Jenkins</h6>
                    <p class="card-text text-muted small">CI/CD</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-warning text-dark">Soon</span>
                      <button class="btn btn-sm btn-outline-primary" onclick="configureConnector('jenkins', 'Jenkins')">Configure</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Finance & Payments -->
            <h6 class="text-muted mb-3">Finance & Payments</h6>
            <div class="row g-3 mb-4">
              <div class="col-md-6 col-lg-4">
                <div class="card bg-dark border-secondary h-100">
                  <div class="card-body">
                    <h6 class="card-title">Stripe</h6>
                    <p class="card-text text-muted small">Payments, subscriptions</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-warning text-dark">Soon</span>
                      <button class="btn btn-sm btn-outline-primary" onclick="configureConnector('stripe', 'Stripe')">Configure</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="card bg-dark border-secondary h-100">
                  <div class="card-body">
                    <h6 class="card-title">PayPal</h6>
                    <p class="card-text text-muted small">Payments</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-warning text-dark">Soon</span>
                      <button class="btn btn-sm btn-outline-primary" onclick="configureConnector('paypal', 'PayPal')">Configure</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="card bg-dark border-secondary h-100">
                  <div class="card-body">
                    <h6 class="card-title">QuickBooks</h6>
                    <p class="card-text text-muted small">Accounting</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-warning text-dark">Soon</span>
                      <button class="btn btn-sm btn-outline-primary" onclick="configureConnector('quickbooks', 'QuickBooks')">Configure</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="card bg-dark border-secondary h-100">
                  <div class="card-body">
                    <h6 class="card-title">Xero</h6>
                    <p class="card-text text-muted small">Accounting</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-warning text-dark">Soon</span>
                      <button class="btn btn-sm btn-outline-primary" onclick="configureConnector('xero', 'Xero')">Configure</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="card bg-dark border-secondary h-100">
                  <div class="card-body">
                    <h6 class="card-title">Shopify</h6>
                    <p class="card-text text-muted small">E-commerce store</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-warning text-dark">Soon</span>
                      <button class="btn btn-sm btn-outline-primary" onclick="configureConnector('shopify', 'Shopify')">Configure</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- CRM & Marketing Automation -->
            <h6 class="text-muted mb-3">CRM & Marketing Automation</h6>
            <div class="row g-3 mb-4">
              <div class="col-md-6 col-lg-4">
                <div class="card bg-dark border-secondary h-100">
                  <div class="card-body">
                    <h6 class="card-title">HubSpot</h6>
                    <p class="card-text text-muted small">CRM and marketing</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-warning text-dark">Soon</span>
                      <button class="btn btn-sm btn-outline-primary" onclick="configureConnector('hubspot', 'HubSpot')">Configure</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="card bg-dark border-secondary h-100">
                  <div class="card-body">
                    <h6 class="card-title">Salesforce</h6>
                    <p class="card-text text-muted small">Enterprise CRM</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-warning text-dark">Soon</span>
                      <button class="btn btn-sm btn-outline-primary" onclick="configureConnector('salesforce', 'Salesforce')">Configure</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="card bg-dark border-secondary h-100">
                  <div class="card-body">
                    <h6 class="card-title">Pipedrive</h6>
                    <p class="card-text text-muted small">Sales pipeline</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-warning text-dark">Soon</span>
                      <button class="btn btn-sm btn-outline-primary" onclick="configureConnector('pipedrive', 'Pipedrive')">Configure</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="card bg-dark border-secondary h-100">
                  <div class="card-body">
                    <h6 class="card-title">Mailchimp</h6>
                    <p class="card-text text-muted small">Email marketing</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-warning text-dark">Soon</span>
                      <button class="btn btn-sm btn-outline-primary" onclick="configureConnector('mailchimp', 'Mailchimp')">Configure</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="card bg-dark border-secondary h-100">
                  <div class="card-body">
                    <h6 class="card-title">Klaviyo</h6>
                    <p class="card-text text-muted small">E-commerce email</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-warning text-dark">Soon</span>
                      <button class="btn btn-sm btn-outline-primary" onclick="configureConnector('klaviyo', 'Klaviyo')">Configure</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="card bg-dark border-secondary h-100">
                  <div class="card-body">
                    <h6 class="card-title">Zapier</h6>
                    <p class="card-text text-muted small">Automation</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-warning text-dark">Soon</span>
                      <button class="btn btn-sm btn-outline-primary" onclick="configureConnector('zapier', 'Zapier')">Configure</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Personal Productivity -->
            <h6 class="text-muted mb-3">Personal Productivity</h6>
            <div class="row g-3 mb-4">
              <div class="col-md-6 col-lg-4">
                <div class="card bg-dark border-secondary h-100">
                  <div class="card-body">
                    <h6 class="card-title">Notion</h6>
                    <p class="card-text text-muted small">Notes and wikis</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-warning text-dark">Soon</span>
                      <button class="btn btn-sm btn-outline-primary" onclick="configureConnector('notion', 'Notion')">Configure</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="card bg-dark border-secondary h-100">
                  <div class="card-body">
                    <h6 class="card-title">Todoist</h6>
                    <p class="card-text text-muted small">Task management</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-warning text-dark">Soon</span>
                      <button class="btn btn-sm btn-outline-primary" onclick="configureConnector('todoist', 'Todoist')">Configure</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="card bg-dark border-secondary h-100">
                  <div class="card-body">
                    <h6 class="card-title">TickTick</h6>
                    <p class="card-text text-muted small">Tasks and habits</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-warning text-dark">Soon</span>
                      <button class="btn btn-sm btn-outline-primary" onclick="configureConnector('ticktick', 'TickTick')">Configure</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="card bg-dark border-secondary h-100">
                  <div class="card-body">
                    <h6 class="card-title">Strava</h6>
                    <p class="card-text text-muted small">Fitness tracking</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-warning text-dark">Soon</span>
                      <button class="btn btn-sm btn-outline-primary" onclick="configureConnector('strava', 'Strava')">Configure</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="card bg-dark border-secondary h-100">
                  <div class="card-body">
                    <h6 class="card-title">MyFitnessPal</h6>
                    <p class="card-text text-muted small">Nutrition</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-warning text-dark">Soon</span>
                      <button class="btn btn-sm btn-outline-primary" onclick="configureConnector('myfitnesspal', 'MyFitnessPal')">Configure</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="card bg-dark border-secondary h-100">
                  <div class="card-body">
                    <h6 class="card-title">Telegram</h6>
                    <p class="card-text text-muted small">Messaging</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-warning text-dark">Soon</span>
                      <button class="btn btn-sm btn-outline-primary" onclick="configureConnector('telegram', 'Telegram')">Configure</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Others -->
            <h6 class="text-muted mb-3">Others</h6>
            <div class="row g-3 mb-4">
              <div class="col-md-6 col-lg-4">
                <div class="card bg-dark border-secondary h-100">
                  <div class="card-body">
                    <h6 class="card-title">Canva</h6>
                    <p class="card-text text-muted small">Design</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-warning text-dark">Soon</span>
                      <button class="btn btn-sm btn-outline-primary" onclick="configureConnector('canva', 'Canva')">Configure</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="card bg-dark border-secondary h-100">
                  <div class="card-body">
                    <h6 class="card-title">Figma</h6>
                    <p class="card-text text-muted small">Collaborative design</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-warning text-dark">Soon</span>
                      <button class="btn btn-sm btn-outline-primary" onclick="configureConnector('figma', 'Figma')">Configure</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="card bg-dark border-secondary h-100">
                  <div class="card-body">
                    <h6 class="card-title">Hotjar</h6>
                    <p class="card-text text-muted small">User behavior</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-warning text-dark">Soon</span>
                      <button class="btn btn-sm btn-outline-primary" onclick="configureConnector('hotjar', 'Hotjar')">Configure</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="card bg-dark border-secondary h-100">
                  <div class="card-body">
                    <h6 class="card-title">Microsoft Clarity</h6>
                    <p class="card-text text-muted small">Heatmaps</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-warning text-dark">Soon</span>
                      <button class="btn btn-sm btn-outline-primary" onclick="configureConnector('microsoft-clarity', 'Microsoft Clarity')">Configure</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 col-lg-4">
                <div class="card bg-dark border-secondary h-100">
                  <div class="card-body">
                    <h6 class="card-title">SEMrush</h6>
                    <p class="card-text text-muted small">SEO tools</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-warning text-dark">Soon</span>
                      <button class="btn btn-sm btn-outline-primary" onclick="configureConnector('semrush', 'SEMrush')">Configure</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Generic Connector Panel (non Google Ads) -->
          <div id="connectorPanel" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h4 id="panelTitle">Configure Connector</h4>
              <button class="btn btn-outline-secondary" onclick="closePanel()">← Back to List</button>
            </div>
            <ul class="nav nav-tabs mb-4" id="panelTabs">
              <li class="nav-item">
                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#panelAuth" type="button">Connect / Auth</button>
              </li>
              <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#panelFetch" type="button">Fetch Data</button>
              </li>
              <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#panelSettings" type="button">Settings</button>
              </li>
              <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#panelTest" type="button">Test</button>
              </li>
            </ul>
            <div class="tab-content">
              <div class="tab-pane fade show active" id="panelAuth">
                <h6>Authentication</h6>
                <p class="text-muted">Mock OAuth flow – click to simulate connection.</p>
                <div class="mb-3">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="connectorConnected" onchange="updateAuthStatus()">
                    <label class="form-check-label" for="connectorConnected">Connected</label>
                  </div>
                </div>
                <button class="btn btn-primary" onclick="mockConnectPanel()">Connect Account</button>
                <div id="panelAuthStatus" class="mt-3"></div>
              </div>
              <div class="tab-pane fade" id="panelFetch">
                <h6>Fetch Data</h6>
                <p class="text-muted">Simulate fetching real data from the connector.</p>
                <button class="btn btn-success" onclick="mockFetchPanel()">Test Fetch</button>
                <pre id="panelFetchResult" class="bg-dark p-3 mt-3 rounded" style="max-height:300px; overflow:auto;"></pre>
              </div>
              <div class="tab-pane fade" id="panelSettings">
                <h6>Settings</h6>
                <div id="panelSettingsContent" class="mt-3"></div>
              </div>
              <div class="tab-pane fade" id="panelTest">
                <h6>Test Connection</h6>
                <button class="btn btn-info" onclick="mockTestPanel()">Run Test</button>
                <pre id="panelTestResult" class="bg-dark p-3 mt-3 rounded"></pre>
              </div>
            </div>
            <div class="mt-4">
              <button type="button" class="btn btn-primary" onclick="saveConnectorConfigPanel()">Save Configuration</button>
            </div>
          </div>

          <!-- ═══════════════════════════════════════════════════════════════
               GOOGLE ADS RICH PANEL
               ═══════════════════════════════════════════════════════════════ -->
          <div id="googleAdsPanel" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div class="d-flex align-items-center gap-3">
                <h4 class="mb-0"><i class="bi bi-google text-primary"></i> Google Ads</h4>
                <span id="gadsConnBadge" class="badge bg-secondary">Disconnected</span>
              </div>
              <button class="btn btn-outline-secondary" onclick="closePanel()">← Back to List</button>
            </div>

            <!-- Account Selector Bar -->
            <div class="card bg-dark border-secondary mb-3">
              <div class="card-body py-2">
                <div class="row align-items-center g-2">
                  <div class="col-auto"><label class="form-label mb-0 small text-muted">Account:</label></div>
                  <div class="col-md-4">
                    <select id="gadsAccountSelect" class="form-select form-select-sm bg-dark text-light" onchange="gadsLoadAccount()">
                      <option value="">— Select Account —</option>
                    </select>
                  </div>
                  <div class="col-md-3">
                    <div class="input-group input-group-sm">
                      <span class="input-group-text bg-dark text-light border-secondary" data-bs-toggle="tooltip" title="Paste exact Manager Account ID (MCC), e.g. 123-456-7890. We use it to list child client accounts from that manager.">
                        MCC ID
                      </span>
                      <input id="gadsMccId" type="text" class="form-control bg-dark text-light border-secondary" placeholder="123-456-7890" onblur="gadsApplyMccId()">
                      <button class="btn btn-outline-info" type="button" onclick="gadsApplyMccId()"><i class="bi bi-arrow-repeat"></i></button>
                    </div>
                  </div>
                  <div class="col-auto">
                    <button class="btn btn-sm btn-outline-success" onclick="gadsConnect()"><i class="bi bi-plug"></i> Connect</button>
                  </div>
                  <div class="col-auto ms-auto">
                    <span id="gadsAccountInfo" class="small text-muted"></span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Tabs -->
            <ul class="nav nav-tabs nav-fill mb-3" id="gadsTabs">
              <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#gadsOverview" type="button"><i class="bi bi-speedometer2"></i> Overview</button></li>
              <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#gadsCampaigns" type="button"><i class="bi bi-megaphone"></i> Campaigns</button></li>
              <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#gadsPacing" type="button"><i class="bi bi-graph-up"></i> Budget Pacing</button></li>
              <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#gadsReports" type="button"><i class="bi bi-file-earmark-bar-graph"></i> Reports</button></li>
              <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#gadsAssets" type="button"><i class="bi bi-pencil-square"></i> Asset Generator</button></li>
              <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#gadsApiTest" type="button"><i class="bi bi-terminal"></i> Test API</button></li>
              <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#gadsSettings" type="button"><i class="bi bi-gear"></i> Settings</button></li>
            </ul>

            <div class="tab-content">
              <!-- ── Overview Tab ──────────────────────────────────── -->
              <div class="tab-pane fade show active" id="gadsOverview">
                <div id="gadsOverviewContent">
                  <div class="text-center text-muted py-5">
                    <i class="bi bi-plug" style="font-size: 3rem;"></i>
                    <p class="mt-3">Select an account and click <strong>Connect</strong> to load data.</p>
                  </div>
                </div>
              </div>

              <!-- ── Campaigns Tab ─────────────────────────────────── -->
              <div class="tab-pane fade" id="gadsCampaigns">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <h6 class="mb-0">Campaigns</h6>
                  <div class="d-flex gap-2 flex-wrap align-items-center">
                    <select id="gadsDateRange" class="form-select form-select-sm bg-dark text-light" style="width:auto;" onchange="gadsLoadAccount()">
                      <option value="7">Last 7 days</option>
                      <option value="14">Last 14 days</option>
                      <option value="30" selected>Last 30 days</option>
                      <option value="60">Last 60 days</option>
                      <option value="90">Last 90 days</option>
                    </select>
                    <select id="gadsCampFilter" class="form-select form-select-sm bg-dark text-light" style="width:auto;" onchange="gadsFilterCampaigns()">
                      <option value="all">All Status</option>
                      <option value="ENABLED">Enabled</option>
                      <option value="PAUSED">Paused</option>
                    </select>
                    <div class="input-group input-group-sm" style="width:130px;">
                      <span class="input-group-text bg-dark text-muted border-secondary" style="font-size:.75rem;">Min ROAS</span>
                      <input type="number" id="gadsCampMinRoas" class="form-control form-control-sm bg-dark text-light border-secondary" step="0.1" min="0" placeholder="0" onchange="gadsFilterCampaigns()">
                    </div>
                    <div class="input-group input-group-sm" style="width:140px;">
                      <span class="input-group-text bg-dark text-muted border-secondary" style="font-size:.75rem;">Min Spend</span>
                      <input type="number" id="gadsCampMinSpend" class="form-control form-control-sm bg-dark text-light border-secondary" step="100" min="0" placeholder="0" onchange="gadsFilterCampaigns()">
                    </div>
                    <button class="btn btn-sm btn-outline-info" onclick="gadsExportCampaignsCSV()"><i class="bi bi-download"></i> CSV</button>
                  </div>
                </div>
                <div class="table-responsive">
                  <table class="table table-dark table-striped table-hover table-sm" id="gadsCampaignsTable">
                    <thead>
                      <tr>
                        <th style="cursor:pointer" onclick="gadsSortCampaigns('name')">Campaign <i class="bi bi-chevron-expand"></i></th>
                        <th>Type</th>
                        <th>Status</th>
                        <th style="cursor:pointer" onclick="gadsSortCampaigns('impressions')">Impr. <i class="bi bi-chevron-expand"></i></th>
                        <th style="cursor:pointer" onclick="gadsSortCampaigns('clicks')">Clicks <i class="bi bi-chevron-expand"></i></th>
                        <th>CTR</th>
                        <th>Avg CPC</th>
                        <th style="cursor:pointer" onclick="gadsSortCampaigns('spent')">Cost <i class="bi bi-chevron-expand"></i></th>
                        <th style="cursor:pointer" onclick="gadsSortCampaigns('conversions')">Conv. <i class="bi bi-chevron-expand"></i></th>
                        <th>Cost/Conv</th>
                        <th style="cursor:pointer" onclick="gadsSortCampaigns('roas')">ROAS <i class="bi bi-chevron-expand"></i></th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody id="gadsCampaignsBody"></tbody>
                    <tfoot id="gadsCampaignsFoot"></tfoot>
                  </table>
                </div>
                <!-- Keywords sub-panel -->
                <div id="gadsKeywordsPanel" style="display:none;" class="mt-3">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0" id="gadsKeywordsTitle">Keywords</h6>
                    <button class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('gadsKeywordsPanel').style.display='none'">Close</button>
                  </div>
                  <div class="table-responsive">
                    <table class="table table-dark table-sm table-striped">
                      <thead><tr><th>Keyword</th><th>Match</th><th>Status</th><th>Impr.</th><th>Clicks</th><th>CTR</th><th>CPC</th><th>QS</th></tr></thead>
                      <tbody id="gadsKeywordsBody"></tbody>
                    </table>
                  </div>
                </div>
              </div>

              <!-- ── Budget Pacing Tab ─────────────────────────────── -->
              <div class="tab-pane fade" id="gadsPacing">
                <h6 class="mb-3">Budget Pacing & Utilization</h6>
                <div id="gadsPacingContent"></div>
              </div>

              <!-- ── Reports Tab ───────────────────────────────────── -->
              <div class="tab-pane fade" id="gadsReports">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <h6 class="mb-0">Reports</h6>
                  <div class="d-flex gap-2">
                    <select id="gadsReportType" class="form-select form-select-sm bg-dark text-light" style="width:auto;">
                      <option value="campaign_performance">Campaign Performance</option>
                      <option value="budget_pacing">Budget Pacing</option>
                    </select>
                    <button class="btn btn-sm btn-success" onclick="gadsGenerateReport()"><i class="bi bi-play-fill"></i> Generate</button>
                    <button class="btn btn-sm btn-outline-info" onclick="gadsExportReportCSV()"><i class="bi bi-download"></i> Export CSV</button>
                  </div>
                </div>
                <div id="gadsReportResult"></div>
              </div>

              <!-- ── Asset Generator Tab ───────────────────────────── -->
              <div class="tab-pane fade" id="gadsAssets">
                <h6>RSA Asset Generator</h6>
                <p class="text-muted small">Enter a keyword or product name → get 5 headlines, 5 descriptions, and a live ad preview card.</p>
                <div class="row g-3 mb-3">
                  <div class="col-md-5">
                    <label class="form-label small">Keyword / Product</label>
                    <input type="text" id="gadsAssetProduct" class="form-control form-control-sm bg-dark text-light" placeholder="e.g. running shoes, CRM software" value="">
                  </div>
                  <div class="col-md-3">
                    <label class="form-label small">Tone</label>
                    <select id="gadsAssetTone" class="form-select form-select-sm bg-dark text-light">
                      <option value="professional">Professional</option>
                      <option value="casual">Casual / Friendly</option>
                      <option value="urgent">Urgent / FOMO</option>
                    </select>
                  </div>
                  <div class="col-md-2">
                    <label class="form-label small">Language</label>
                    <select id="gadsAssetLang" class="form-select form-select-sm bg-dark text-light">
                      <option value="en">English</option>
                      <option value="ro">Română</option>
                      <option value="de">Deutsch</option>
                    </select>
                  </div>
                  <div class="col-md-2 d-flex align-items-end">
                    <button class="btn btn-sm btn-primary w-100" onclick="gadsGenerateAssets()"><i class="bi bi-magic"></i> Generate</button>
                  </div>
                </div>
                <div id="gadsAssetsResult"></div>
              </div>

              <!-- ── Test API Call Tab ──────────────────────────────── -->
              <div class="tab-pane fade" id="gadsApiTest">
                <h6>Google Ads API Test Console</h6>
                <p class="text-muted small">Simulate real API calls against the Google Ads API v17.</p>
                <div class="row g-3 mb-3">
                  <div class="col-md-2">
                    <label class="form-label small">Method</label>
                    <select id="gadsApiMethod" class="form-select form-select-sm bg-dark text-light">
                      <option value="GET">GET</option>
                      <option value="POST">POST</option>
                    </select>
                  </div>
                  <div class="col-md-8">
                    <label class="form-label small">Endpoint</label>
                    <select id="gadsApiEndpoint" class="form-select form-select-sm bg-dark text-light">
                      <option value="/v17/customers/123456/campaigns">/v17/customers/{id}/campaigns</option>
                      <option value="/v17/customers/123456/adGroups">/v17/customers/{id}/adGroups</option>
                      <option value="/v17/customers/123456/keywords">/v17/customers/{id}/keywords</option>
                      <option value="/v17/customers/123456/metrics">/v17/customers/{id}/metrics</option>
                      <option value="/v17/customers/123456/reports">/v17/customers/{id}/reports</option>
                    </select>
                  </div>
                  <div class="col-md-2 d-flex align-items-end">
                    <button class="btn btn-sm btn-warning w-100" onclick="gadsTestApiCall()"><i class="bi bi-send"></i> Send</button>
                  </div>
                </div>
                <div id="gadsApiResult"></div>
              </div>

              <!-- ── Settings Tab ──────────────────────────────────── -->
              <div class="tab-pane fade" id="gadsSettings">
                <h6>Connector Settings</h6>
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label">Account Level</label>
                    <select id="gadsSettingLevel" class="form-select bg-dark text-light">
                      <option>MCC (Manager Account)</option>
                      <option>Single Client Account</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Default Date Range</label>
                    <select id="gadsSettingDateRange" class="form-select bg-dark text-light">
                      <option value="7">Last 7 days</option>
                      <option value="30" selected>Last 30 days</option>
                      <option value="90">Last 90 days</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Auto-refresh interval</label>
                    <select id="gadsSettingRefresh" class="form-select bg-dark text-light">
                      <option value="0">Manual only</option>
                      <option value="300">Every 5 min</option>
                      <option value="900">Every 15 min</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Metrics to display</label>
                    <div class="d-flex flex-wrap gap-2">
                      <div class="form-check"><input class="form-check-input gads-metric-check" type="checkbox" value="impressions" checked><label class="form-check-label small">Impressions</label></div>
                      <div class="form-check"><input class="form-check-input gads-metric-check" type="checkbox" value="clicks" checked><label class="form-check-label small">Clicks</label></div>
                      <div class="form-check"><input class="form-check-input gads-metric-check" type="checkbox" value="conversions" checked><label class="form-check-label small">Conversions</label></div>
                      <div class="form-check"><input class="form-check-input gads-metric-check" type="checkbox" value="roas" checked><label class="form-check-label small">ROAS</label></div>
                      <div class="form-check"><input class="form-check-input gads-metric-check" type="checkbox" value="ctr"><label class="form-check-label small">CTR</label></div>
                    </div>
                  </div>
                </div>
                <div class="mt-4">
                  <button class="btn btn-primary" onclick="gadsSaveSettings()"><i class="bi bi-save"></i> Save Settings</button>
                </div>
              </div>
            </div>
          </div>
          <!-- ═══ END GOOGLE ADS PANEL ═══ -->

          <!-- ═══════════════════════════════════════════════════════════════
               GA4 RICH PANEL
               ═══════════════════════════════════════════════════════════════ -->
          <div id="ga4Panel" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div class="d-flex align-items-center gap-3">
                <h4 class="mb-0"><i class="bi bi-bar-chart-line text-warning"></i> Google Analytics 4</h4>
                <span id="ga4ConnBadge" class="badge bg-secondary">Disconnected</span>
              </div>
              <button class="btn btn-outline-secondary" onclick="closePanel()">← Back to List</button>
            </div>

            <!-- Property Selector Bar -->
            <div class="card bg-dark border-secondary mb-3">
              <div class="card-body py-2">
                <div class="row align-items-center g-2">
                  <div class="col-auto"><label class="form-label mb-0 small text-muted">Property:</label></div>
                  <div class="col-md-4">
                    <select id="ga4PropertySelect" class="form-select form-select-sm bg-dark text-light" onchange="ga4LoadProperty()">
                      <option value="">— Select Property —</option>
                    </select>
                  </div>
                  <div class="col-auto"><label class="form-label mb-0 small text-muted">Date Range:</label></div>
                  <div class="col-md-2">
                    <select id="ga4DateRange" class="form-select form-select-sm bg-dark text-light" onchange="ga4LoadProperty()">
                      <option value="7days">Last 7 days</option>
                      <option value="14days">Last 14 days</option>
                      <option value="30days" selected>Last 30 days</option>
                      <option value="60days">Last 60 days</option>
                      <option value="90days">Last 90 days</option>
                    </select>
                  </div>
                  <div class="col-auto">
                    <button class="btn btn-sm btn-outline-info" onclick="ga4LoadProperty()"><i class="bi bi-arrow-repeat"></i></button>
                  </div>
                  <div class="col-auto">
                    <button class="btn btn-sm btn-outline-success" onclick="ga4Connect()"><i class="bi bi-plug"></i> Connect</button>
                  </div>
                  <div class="col-auto ms-auto">
                    <span id="ga4PropertyInfo" class="small text-muted"></span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Tabs -->
            <ul class="nav nav-tabs nav-fill mb-3" id="ga4Tabs">
              <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#ga4Overview" type="button"><i class="bi bi-speedometer2"></i> Overview</button></li>
              <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#ga4Pages" type="button"><i class="bi bi-file-earmark-text"></i> Pages</button></li>
              <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#ga4Sources" type="button"><i class="bi bi-signpost-2"></i> Sources</button></li>
              <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#ga4Events" type="button"><i class="bi bi-lightning"></i> Events</button></li>
              <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#ga4Funnel" type="button"><i class="bi bi-funnel"></i> Funnels</button></li>
              <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#ga4Audience" type="button"><i class="bi bi-people"></i> Audience</button></li>
              <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#ga4ApiTest" type="button"><i class="bi bi-terminal"></i> Test API</button></li>
              <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#ga4Settings" type="button"><i class="bi bi-gear"></i> Settings</button></li>
            </ul>

            <div class="tab-content">
              <!-- ── Overview Tab ──────────────────────────────────── -->
              <div class="tab-pane fade show active" id="ga4Overview">
                <div id="ga4OverviewContent">
                  <div class="text-center text-muted py-5">
                    <i class="bi bi-bar-chart-line" style="font-size: 3rem;"></i>
                    <p class="mt-3">Select a property and click <strong>Connect</strong> to load analytics.</p>
                  </div>
                </div>
              </div>

              <!-- ── Pages Tab ─────────────────────────────────────── -->
              <div class="tab-pane fade" id="ga4Pages">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <h6 class="mb-0">Top Pages & Screens</h6>
                  <button class="btn btn-sm btn-outline-info" onclick="ga4ExportCSV('pages')"><i class="bi bi-download"></i> CSV</button>
                </div>
                <div class="table-responsive">
                  <table class="table table-dark table-striped table-hover table-sm">
                    <thead><tr><th>Page Path</th><th>Title</th><th>Views</th><th>Sessions</th><th>Users</th><th>Avg. Time</th><th>Bounce</th><th>Conv.</th></tr></thead>
                    <tbody id="ga4PagesBody"></tbody>
                  </table>
                </div>
              </div>

              <!-- ── Sources Tab ────────────────────────────────────── -->
              <div class="tab-pane fade" id="ga4Sources">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <h6 class="mb-0">Traffic Sources / Medium</h6>
                  <button class="btn btn-sm btn-outline-info" onclick="ga4ExportCSV('sources')"><i class="bi bi-download"></i> CSV</button>
                </div>
                <div class="table-responsive">
                  <table class="table table-dark table-striped table-hover table-sm">
                    <thead><tr><th>Source</th><th>Medium</th><th>Sessions</th><th>Users</th><th>Conversions</th><th>Revenue</th><th>Bounce</th></tr></thead>
                    <tbody id="ga4SourcesBody"></tbody>
                  </table>
                </div>
              </div>

              <!-- ── Events Tab ─────────────────────────────────────── -->
              <div class="tab-pane fade" id="ga4Events">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <h6 class="mb-0">Events</h6>
                  <div class="d-flex gap-2">
                    <select id="ga4EventFilter" class="form-select form-select-sm bg-dark text-light" style="width:auto;" onchange="ga4RenderEvents()">
                      <option value="all">All Categories</option>
                      <option value="Auto">Auto-collected</option>
                      <option value="Ecommerce">Ecommerce</option>
                      <option value="Custom">Custom</option>
                    </select>
                    <button class="btn btn-sm btn-outline-info" onclick="ga4ExportCSV('events')"><i class="bi bi-download"></i> CSV</button>
                  </div>
                </div>
                <div class="table-responsive">
                  <table class="table table-dark table-striped table-hover table-sm">
                    <thead><tr><th>Event Name</th><th>Category</th><th>Count</th><th>Users</th><th>Per Session</th><th>Value</th></tr></thead>
                    <tbody id="ga4EventsBody"></tbody>
                  </table>
                </div>
              </div>

              <!-- ── Funnel Tab ─────────────────────────────────────── -->
              <div class="tab-pane fade" id="ga4Funnel">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <h6 class="mb-0">Funnel Analysis</h6>
                  <select id="ga4FunnelType" class="form-select form-select-sm bg-dark text-light" style="width:auto;" onchange="ga4LoadFunnel()">
                    <option value="ecommerce">E-commerce Purchase</option>
                    <option value="lead_gen">Lead Generation</option>
                  </select>
                </div>
                <div id="ga4FunnelContent"></div>
              </div>

              <!-- ── Audience Tab (Devices + Countries) ────────────── -->
              <div class="tab-pane fade" id="ga4Audience">
                <div class="row g-4">
                  <div class="col-md-5">
                    <h6 class="mb-3"><i class="bi bi-phone"></i> Devices</h6>
                    <div id="ga4DevicesContent"></div>
                  </div>
                  <div class="col-md-7">
                    <h6 class="mb-3"><i class="bi bi-globe2"></i> Countries</h6>
                    <div class="table-responsive">
                      <table class="table table-dark table-striped table-sm">
                        <thead><tr><th>Country</th><th>Sessions</th><th>Users</th><th>Conv.</th><th>Revenue</th><th>%</th></tr></thead>
                        <tbody id="ga4CountriesBody"></tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>

              <!-- ── Test API Tab ──────────────────────────────────── -->
              <div class="tab-pane fade" id="ga4ApiTest">
                <h6>GA4 Data API Test Console</h6>
                <p class="text-muted small">Simulate calls to the Google Analytics Data API v1beta.</p>
                <div class="row g-3 mb-3">
                  <div class="col-md-2">
                    <label class="form-label small">Method</label>
                    <select id="ga4ApiMethod" class="form-select form-select-sm bg-dark text-light">
                      <option value="POST">POST</option>
                      <option value="GET">GET</option>
                    </select>
                  </div>
                  <div class="col-md-8">
                    <label class="form-label small">Endpoint</label>
                    <select id="ga4ApiEndpoint" class="form-select form-select-sm bg-dark text-light">
                      <option value="/v1beta/properties/GA4_PROP/runReport">runReport (dimensions + metrics)</option>
                      <option value="/v1beta/properties/GA4_PROP/runRealtimeReport">runRealtimeReport (live users)</option>
                      <option value="/v1beta/properties/GA4_PROP/metadata">metadata (available dimensions & metrics)</option>
                    </select>
                  </div>
                  <div class="col-md-2 d-flex align-items-end">
                    <button class="btn btn-sm btn-warning w-100" onclick="ga4TestApiCall()"><i class="bi bi-send"></i> Send</button>
                  </div>
                </div>
                <div id="ga4ApiResult"></div>
              </div>

              <!-- ── Settings Tab ──────────────────────────────────── -->
              <div class="tab-pane fade" id="ga4Settings">
                <h6>Connector Settings</h6>
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label">Default Date Range</label>
                    <select id="ga4SettingDateRange" class="form-select bg-dark text-light">
                      <option value="7">Last 7 days</option>
                      <option value="30" selected>Last 30 days</option>
                      <option value="90">Last 90 days</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Auto-refresh</label>
                    <select id="ga4SettingRefresh" class="form-select bg-dark text-light">
                      <option value="0">Manual only</option>
                      <option value="300">Every 5 min</option>
                      <option value="900">Every 15 min</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Metrics to display</label>
                    <div class="d-flex flex-wrap gap-2">
                      <div class="form-check"><input class="form-check-input ga4-metric-chk" type="checkbox" value="sessions" checked><label class="form-check-label small">Sessions</label></div>
                      <div class="form-check"><input class="form-check-input ga4-metric-chk" type="checkbox" value="users" checked><label class="form-check-label small">Users</label></div>
                      <div class="form-check"><input class="form-check-input ga4-metric-chk" type="checkbox" value="conversions" checked><label class="form-check-label small">Conversions</label></div>
                      <div class="form-check"><input class="form-check-input ga4-metric-chk" type="checkbox" value="bounce_rate" checked><label class="form-check-label small">Bounce Rate</label></div>
                      <div class="form-check"><input class="form-check-input ga4-metric-chk" type="checkbox" value="engagement"><label class="form-check-label small">Engagement</label></div>
                      <div class="form-check"><input class="form-check-input ga4-metric-chk" type="checkbox" value="revenue"><label class="form-check-label small">Revenue</label></div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Default Dimensions</label>
                    <div class="d-flex flex-wrap gap-2">
                      <div class="form-check"><input class="form-check-input ga4-dim-chk" type="checkbox" value="date" checked><label class="form-check-label small">Date</label></div>
                      <div class="form-check"><input class="form-check-input ga4-dim-chk" type="checkbox" value="page_path" checked><label class="form-check-label small">Page Path</label></div>
                      <div class="form-check"><input class="form-check-input ga4-dim-chk" type="checkbox" value="source_medium" checked><label class="form-check-label small">Source/Medium</label></div>
                      <div class="form-check"><input class="form-check-input ga4-dim-chk" type="checkbox" value="device"><label class="form-check-label small">Device</label></div>
                      <div class="form-check"><input class="form-check-input ga4-dim-chk" type="checkbox" value="country"><label class="form-check-label small">Country</label></div>
                    </div>
                  </div>
                </div>
                <div class="mt-4">
                  <button class="btn btn-primary" onclick="ga4SaveSettings()"><i class="bi bi-save"></i> Save Settings</button>
                </div>
              </div>
            </div>
          </div>
          <!-- ═══ END GA4 PANEL ═══ -->

          <!-- ═══════════════════════════════════════════════════════════════
               GOOGLE SEARCH CONSOLE RICH PANEL
               ═══════════════════════════════════════════════════════════════ -->
          <div id="gscPanel" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div class="d-flex align-items-center gap-3">
                <h4 class="mb-0"><i class="bi bi-search text-success"></i> Google Search Console</h4>
                <span id="gscConnBadge" class="badge bg-secondary">Disconnected</span>
              </div>
              <button class="btn btn-outline-secondary" onclick="closePanel()">← Back to List</button>
            </div>

            <!-- Property Selector Bar -->
            <div class="card bg-dark border-secondary mb-3">
              <div class="card-body py-2">
                <div class="row align-items-center g-2">
                  <div class="col-auto"><label class="form-label mb-0 small text-muted">Property:</label></div>
                  <div class="col-md-5">
                    <select id="gscPropertySelect" class="form-select form-select-sm bg-dark text-light" onchange="gscLoadProperty()">
                      <option value="">— Select Property —</option>
                    </select>
                  </div>
                  <div class="col-auto">
                    <button class="btn btn-sm btn-outline-success" onclick="gscConnect()"><i class="bi bi-plug"></i> Connect</button>
                  </div>
                  <div class="col-auto ms-auto">
                    <span id="gscPropertyInfo" class="small text-muted"></span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Tabs -->
            <ul class="nav nav-tabs nav-fill mb-3" id="gscTabs">
              <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#gscOverview" type="button"><i class="bi bi-speedometer2"></i> Overview</button></li>
              <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#gscQueries" type="button"><i class="bi bi-search"></i> Queries</button></li>
              <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#gscPages" type="button"><i class="bi bi-file-earmark-text"></i> Pages</button></li>
              <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#gscCountries" type="button"><i class="bi bi-globe2"></i> Countries</button></li>
              <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#gscIndexCoverage" type="button"><i class="bi bi-diagram-3"></i> Index Coverage</button></li>
              <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#gscSitemaps" type="button"><i class="bi bi-map"></i> Sitemaps</button></li>
              <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#gscApiTest" type="button"><i class="bi bi-terminal"></i> Test API</button></li>
              <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#gscSettings" type="button"><i class="bi bi-gear"></i> Settings</button></li>
            </ul>

            <div class="tab-content">
              <!-- ── Overview Tab ──────────────────────────────────── -->
              <div class="tab-pane fade show active" id="gscOverview">
                <div id="gscOverviewContent">
                  <div class="text-center text-muted py-5">
                    <i class="bi bi-search" style="font-size: 3rem;"></i>
                    <p class="mt-3">Select a property and click <strong>Connect</strong> to load Search Console data.</p>
                  </div>
                </div>
              </div>

              <!-- ── Queries Tab ───────────────────────────────────── -->
              <div class="tab-pane fade" id="gscQueries">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <h6 class="mb-0">Top Search Queries</h6>
                  <div class="d-flex gap-2 align-items-center">
                    <input type="text" id="gscQueryFilter" class="form-control form-control-sm bg-dark text-light border-secondary" style="width:180px;" placeholder="Filter queries..." oninput="gscRenderQueries()">
                    <select id="gscQuerySort" class="form-select form-select-sm bg-dark text-light" style="width:auto;" onchange="gscRenderQueries()">
                      <option value="clicks">Sort by Clicks</option>
                      <option value="impressions">Sort by Impressions</option>
                      <option value="ctr">Sort by CTR</option>
                      <option value="position">Sort by Position</option>
                    </select>
                    <button class="btn btn-sm btn-outline-info" onclick="gscExportCSV('queries')"><i class="bi bi-download"></i> CSV</button>
                  </div>
                </div>
                <div class="table-responsive">
                  <table class="table table-dark table-striped table-hover table-sm">
                    <thead>
                      <tr>
                        <th>Query</th>
                        <th>Clicks</th>
                        <th>Impressions</th>
                        <th>CTR</th>
                        <th>Avg. Position</th>
                      </tr>
                    </thead>
                    <tbody id="gscQueriesBody"></tbody>
                    <tfoot id="gscQueriesFoot"></tfoot>
                  </table>
                </div>
              </div>

              <!-- ── Pages Tab ─────────────────────────────────────── -->
              <div class="tab-pane fade" id="gscPages">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <h6 class="mb-0">Top Pages</h6>
                  <button class="btn btn-sm btn-outline-info" onclick="gscExportCSV('pages')"><i class="bi bi-download"></i> CSV</button>
                </div>
                <div class="table-responsive">
                  <table class="table table-dark table-striped table-hover table-sm">
                    <thead><tr><th>Page</th><th>Clicks</th><th>Impressions</th><th>CTR</th><th>Avg. Position</th></tr></thead>
                    <tbody id="gscPagesBody"></tbody>
                  </table>
                </div>
              </div>

              <!-- ── Countries Tab ─────────────────────────────────── -->
              <div class="tab-pane fade" id="gscCountries">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <h6 class="mb-0">Performance by Country</h6>
                  <button class="btn btn-sm btn-outline-info" onclick="gscExportCSV('countries')"><i class="bi bi-download"></i> CSV</button>
                </div>
                <div id="gscCountriesContent"></div>
              </div>

              <!-- ── Index Coverage Tab ────────────────────────────── -->
              <div class="tab-pane fade" id="gscIndexCoverage">
                <h6 class="mb-3">Index Coverage Report</h6>
                <div id="gscIndexContent">
                  <p class="text-muted text-center">Connect to load index coverage data.</p>
                </div>
              </div>

              <!-- ── Sitemaps Tab ──────────────────────────────────── -->
              <div class="tab-pane fade" id="gscSitemaps">
                <h6 class="mb-3">Submitted Sitemaps</h6>
                <div id="gscSitemapsContent">
                  <p class="text-muted text-center">Connect to load sitemap data.</p>
                </div>
              </div>

              <!-- ── Test API Call Tab ──────────────────────────────── -->
              <div class="tab-pane fade" id="gscApiTest">
                <h6>Search Console API Test Console</h6>
                <p class="text-muted small">Simulate real API calls against the Google Search Console API v3.</p>
                <div class="row g-3 mb-3">
                  <div class="col-md-2">
                    <label class="form-label small">Method</label>
                    <select id="gscApiMethod" class="form-select form-select-sm bg-dark text-light">
                      <option value="POST">POST</option>
                      <option value="GET">GET</option>
                    </select>
                  </div>
                  <div class="col-md-8">
                    <label class="form-label small">Endpoint</label>
                    <select id="gscApiEndpoint" class="form-select form-select-sm bg-dark text-light">
                      <option value="/webmasters/v3/sites/sc-domain:camarad.ai/searchAnalytics/query">/v3/sites/{property}/searchAnalytics/query</option>
                      <option value="/webmasters/v3/sites/sc-domain:camarad.ai/sitemaps">/v3/sites/{property}/sitemaps</option>
                      <option value="/webmasters/v3/urlInspection/index:inspect">/v3/urlInspection/index:inspect</option>
                    </select>
                  </div>
                  <div class="col-md-2 d-flex align-items-end">
                    <button class="btn btn-sm btn-warning w-100" onclick="gscTestApiCall()"><i class="bi bi-send"></i> Send</button>
                  </div>
                </div>
                <div id="gscApiResult"></div>
              </div>

              <!-- ── Settings Tab ──────────────────────────────────── -->
              <div class="tab-pane fade" id="gscSettings">
                <h6>Connector Settings</h6>
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label">Property Type</label>
                    <select id="gscSettingType" class="form-select bg-dark text-light">
                      <option>Domain Property</option>
                      <option>URL Prefix</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Default Date Range</label>
                    <select id="gscSettingDateRange" class="form-select bg-dark text-light">
                      <option value="7">Last 7 days</option>
                      <option value="28" selected>Last 28 days</option>
                      <option value="90">Last 3 months</option>
                      <option value="180">Last 6 months</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Search Type</label>
                    <select id="gscSettingSearchType" class="form-select bg-dark text-light">
                      <option value="web" selected>Web</option>
                      <option value="image">Image</option>
                      <option value="video">Video</option>
                      <option value="news">News</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Auto-refresh interval</label>
                    <select id="gscSettingRefresh" class="form-select bg-dark text-light">
                      <option value="0">Manual only</option>
                      <option value="3600">Every hour</option>
                      <option value="86400">Daily</option>
                    </select>
                  </div>
                </div>
                <div class="mt-4">
                  <button class="btn btn-primary" onclick="gscSaveSettings()"><i class="bi bi-save"></i> Save Settings</button>
                </div>
              </div>
            </div>
          </div>
          <!-- ═══ END GSC PANEL ═══ -->

          <!-- ═══════════════════════════════════════════════════════════════
               GOOGLE TAG MANAGER RICH PANEL
               ═══════════════════════════════════════════════════════════════ -->
          <div id="gtmPanel" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div class="d-flex align-items-center gap-3">
                <h4 class="mb-0"><i class="bi bi-tag text-info"></i> Google Tag Manager</h4>
                <span id="gtmConnBadge" class="badge bg-secondary">Disconnected</span>
              </div>
              <button class="btn btn-outline-secondary" onclick="closePanel()">← Back to List</button>
            </div>

            <!-- Container Selector Bar -->
            <div class="card bg-dark border-secondary mb-3">
              <div class="card-body py-2">
                <div class="row align-items-center g-2">
                  <div class="col-auto"><label class="form-label mb-0 small text-muted">Container:</label></div>
                  <div class="col-md-5">
                    <select id="gtmContainerSelect" class="form-select form-select-sm bg-dark text-light" onchange="gtmLoadContainer()">
                      <option value="">— Select Container —</option>
                    </select>
                  </div>
                  <div class="col-auto">
                    <button class="btn btn-sm btn-outline-success" onclick="gtmConnect()"><i class="bi bi-plug"></i> Connect</button>
                  </div>
                  <div class="col-auto ms-auto">
                    <span id="gtmContainerInfo" class="small text-muted"></span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Tabs -->
            <ul class="nav nav-tabs nav-fill mb-3" id="gtmTabs">
              <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#gtmOverview" type="button"><i class="bi bi-speedometer2"></i> Overview</button></li>
              <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#gtmTags" type="button"><i class="bi bi-tags"></i> Tags</button></li>
              <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#gtmTriggers" type="button"><i class="bi bi-lightning"></i> Triggers</button></li>
              <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#gtmVariables" type="button"><i class="bi bi-braces"></i> Variables</button></li>
              <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#gtmVersions" type="button"><i class="bi bi-clock-history"></i> Versions</button></li>
              <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#gtmPreview" type="button"><i class="bi bi-bug"></i> Preview</button></li>
              <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#gtmApiTest" type="button"><i class="bi bi-terminal"></i> Test API</button></li>
              <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#gtmSettings" type="button"><i class="bi bi-gear"></i> Settings</button></li>
            </ul>

            <div class="tab-content">
              <!-- ── Overview Tab ──────────────────────────────────── -->
              <div class="tab-pane fade show active" id="gtmOverview">
                <div id="gtmOverviewContent">
                  <div class="text-center text-muted py-5">
                    <i class="bi bi-tag" style="font-size: 3rem;"></i>
                    <p class="mt-3">Select a container and click <strong>Connect</strong> to load GTM data.</p>
                  </div>
                </div>
              </div>

              <!-- ── Tags Tab ──────────────────────────────────────── -->
              <div class="tab-pane fade" id="gtmTags">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <h6 class="mb-0">Tags</h6>
                  <div class="d-flex gap-2 align-items-center">
                    <select id="gtmTagFilter" class="form-select form-select-sm bg-dark text-light" style="width:auto;" onchange="gtmRenderTags()">
                      <option value="all">All Types</option>
                      <option value="GA4 Event">GA4 Event</option>
                      <option value="Google Ads">Google Ads</option>
                      <option value="Custom HTML">Custom HTML</option>
                    </select>
                    <select id="gtmTagStatusFilter" class="form-select form-select-sm bg-dark text-light" style="width:auto;" onchange="gtmRenderTags()">
                      <option value="all">All Status</option>
                      <option value="Enabled">Enabled</option>
                      <option value="Paused">Paused</option>
                    </select>
                    <button class="btn btn-sm btn-outline-info" onclick="gtmExportCSV('tags')"><i class="bi bi-download"></i> CSV</button>
                  </div>
                </div>
                <div class="table-responsive">
                  <table class="table table-dark table-striped table-hover table-sm">
                    <thead>
                      <tr><th>Tag Name</th><th>Type</th><th>Status</th><th>Fires On</th><th>Fires (7d)</th><th>Last Fired</th></tr>
                    </thead>
                    <tbody id="gtmTagsBody"></tbody>
                    <tfoot id="gtmTagsFoot"></tfoot>
                  </table>
                </div>
              </div>

              <!-- ── Triggers Tab ──────────────────────────────────── -->
              <div class="tab-pane fade" id="gtmTriggers">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <h6 class="mb-0">Triggers</h6>
                  <button class="btn btn-sm btn-outline-info" onclick="gtmExportCSV('triggers')"><i class="bi bi-download"></i> CSV</button>
                </div>
                <div class="table-responsive">
                  <table class="table table-dark table-striped table-hover table-sm">
                    <thead><tr><th>Trigger Name</th><th>Type</th><th>Fires On</th><th>Filters</th><th>Used by Tags</th></tr></thead>
                    <tbody id="gtmTriggersBody"></tbody>
                  </table>
                </div>
              </div>

              <!-- ── Variables Tab ─────────────────────────────────── -->
              <div class="tab-pane fade" id="gtmVariables">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <h6 class="mb-0">Variables</h6>
                  <div class="d-flex gap-2 align-items-center">
                    <select id="gtmVarScopeFilter" class="form-select form-select-sm bg-dark text-light" style="width:auto;" onchange="gtmRenderVariables()">
                      <option value="all">All Scopes</option>
                      <option value="Built-in">Built-in</option>
                      <option value="User-Defined">User-Defined</option>
                      <option value="Global">Global</option>
                    </select>
                    <button class="btn btn-sm btn-outline-info" onclick="gtmExportCSV('variables')"><i class="bi bi-download"></i> CSV</button>
                  </div>
                </div>
                <div class="table-responsive">
                  <table class="table table-dark table-striped table-hover table-sm">
                    <thead><tr><th>Name</th><th>Type</th><th>Value / Template</th><th>Scope</th></tr></thead>
                    <tbody id="gtmVariablesBody"></tbody>
                  </table>
                </div>
              </div>

              <!-- ── Versions Tab ──────────────────────────────────── -->
              <div class="tab-pane fade" id="gtmVersions">
                <h6 class="mb-3">Version History & Changelog</h6>
                <div id="gtmVersionsContent">
                  <p class="text-muted text-center">Connect to load version history.</p>
                </div>
              </div>

              <!-- ── Preview Tab ───────────────────────────────────── -->
              <div class="tab-pane fade" id="gtmPreview">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <h6 class="mb-0"><i class="bi bi-bug"></i> Tag Assistant / Preview Mode</h6>
                  <button class="btn btn-sm btn-info" id="gtmPreviewBtn" onclick="gtmStartPreview()"><i class="bi bi-play-fill"></i> Start Preview</button>
                </div>
                <div id="gtmPreviewContent">
                  <div class="text-center text-muted py-4">
                    <i class="bi bi-bug" style="font-size: 2.5rem;"></i>
                    <p class="mt-2">Click <strong>Start Preview</strong> to simulate Tag Assistant debug mode.</p>
                  </div>
                </div>
              </div>

              <!-- ── Test API Call Tab ──────────────────────────────── -->
              <div class="tab-pane fade" id="gtmApiTest">
                <h6>Tag Manager API v2 Test Console</h6>
                <p class="text-muted small">Simulate real API calls against the Google Tag Manager API v2.</p>
                <div class="row g-3 mb-3">
                  <div class="col-md-2">
                    <label class="form-label small">Method</label>
                    <select id="gtmApiMethod" class="form-select form-select-sm bg-dark text-light">
                      <option value="GET">GET</option>
                      <option value="POST">POST</option>
                    </select>
                  </div>
                  <div class="col-md-8">
                    <label class="form-label small">Endpoint</label>
                    <select id="gtmApiEndpoint" class="form-select form-select-sm bg-dark text-light">
                      <option value="/tagmanager/v2/accounts/ACC/containers/GTM-WX4R7N2/workspaces/Default/tags">/v2/.../workspaces/{ws}/tags</option>
                      <option value="/tagmanager/v2/accounts/ACC/containers/GTM-WX4R7N2/workspaces/Default/triggers">/v2/.../workspaces/{ws}/triggers</option>
                      <option value="/tagmanager/v2/accounts/ACC/containers/GTM-WX4R7N2/workspaces/Default/variables">/v2/.../workspaces/{ws}/variables</option>
                      <option value="/tagmanager/v2/accounts/ACC/containers/GTM-WX4R7N2/versions">/v2/.../containers/{id}/versions</option>
                    </select>
                  </div>
                  <div class="col-md-2 d-flex align-items-end">
                    <button class="btn btn-sm btn-warning w-100" onclick="gtmTestApiCall()"><i class="bi bi-send"></i> Send</button>
                  </div>
                </div>
                <div id="gtmApiResult"></div>
              </div>

              <!-- ── Settings Tab ──────────────────────────────────── -->
              <div class="tab-pane fade" id="gtmSettings">
                <h6>Connector Settings</h6>
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label">Workspace</label>
                    <select id="gtmSettingWorkspace" class="form-select bg-dark text-light">
                      <option>Default</option>
                      <option>Production</option>
                      <option>Staging</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Environment</label>
                    <select id="gtmSettingEnv" class="form-select bg-dark text-light">
                      <option value="live" selected>Live</option>
                      <option value="latest">Latest</option>
                      <option value="staging">Staging</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Debug Mode</label>
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" id="gtmSettingDebug">
                      <label class="form-check-label" for="gtmSettingDebug">Enable debug / verbose logging</label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Auto-publish</label>
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" id="gtmSettingAutoPublish">
                      <label class="form-check-label" for="gtmSettingAutoPublish">Auto-publish on save (staging only)</label>
                    </div>
                  </div>
                </div>
                <div class="mt-4">
                  <button class="btn btn-primary" onclick="gtmSaveSettings()"><i class="bi bi-save"></i> Save Settings</button>
                </div>
              </div>
            </div>
          </div>
          <!-- ═══ END GTM PANEL ═══ -->
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════════════════════════════════════════════════ -->
<!-- META ADS (Facebook + Instagram) — Full Rich Connector Panel               -->
<!-- ═══════════════════════════════════════════════════════════════════════════ -->
<div id="metaAdsPanel" style="display:none;">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h4 class="mb-0"><i class="bi bi-meta text-primary"></i> Meta Ads <small class="text-muted">(Facebook + Instagram)</small></h4>
      <span class="small text-muted">Marketing API v19.0 — Business Manager Integration</span>
    </div>
    <div class="d-flex gap-2 align-items-center">
      <span id="metaConnBadge" class="badge bg-secondary">Disconnected</span>
      <button class="btn btn-sm btn-primary" onclick="metaConnect()"><i class="bi bi-plug"></i> Connect</button>
      <button class="btn btn-sm btn-outline-secondary" onclick="closePanel()"><i class="bi bi-x-lg"></i></button>
    </div>
  </div>

  <!-- Ad Account Selector -->
  <div class="d-flex gap-3 align-items-center mb-3">
    <select class="form-select form-select-sm bg-dark text-light border-secondary" id="metaAccountSelect" style="max-width:360px;" onchange="metaLoadAccount()">
      <option value="">— Select Ad Account —</option>
    </select>
    <span class="small text-muted" id="metaAccountInfo"></span>
  </div>

  <!-- 8 Tabs -->
  <ul class="nav nav-tabs nav-fill mb-3" role="tablist">
    <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#metaTabOverview">Overview</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#metaTabCampaigns">Campaigns</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#metaTabAdSets">Ad Sets</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#metaTabAds">Ads</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#metaTabBudget">Budget & Pacing</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#metaTabReports">Reports</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#metaTabTestApi">Test API</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#metaTabSettings">Settings</a></li>
  </ul>

  <div class="tab-content">
    <!-- Overview Tab -->
    <div class="tab-pane fade show active" id="metaTabOverview">
      <div id="metaOverviewContent"><div class="text-center text-muted py-5">Select an ad account and connect to view overview</div></div>
    </div>

    <!-- Campaigns Tab -->
    <div class="tab-pane fade" id="metaTabCampaigns">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="d-flex gap-2">
          <select class="form-select form-select-sm bg-dark text-light border-secondary" id="metaCampStatusFilter" style="width:140px;" onchange="metaRenderCampaigns()">
            <option value="all">All Status</option>
            <option value="ACTIVE">Active</option>
            <option value="PAUSED">Paused</option>
          </select>
          <select class="form-select form-select-sm bg-dark text-light border-secondary" id="metaCampObjectiveFilter" style="width:160px;" onchange="metaRenderCampaigns()">
            <option value="all">All Objectives</option>
            <option value="CONVERSIONS">Conversions</option>
            <option value="REACH">Reach</option>
            <option value="VIDEO_VIEWS">Video Views</option>
            <option value="APP_INSTALLS">App Installs</option>
            <option value="MESSAGES">Messages</option>
          </select>
        </div>
        <button class="btn btn-sm btn-outline-info" onclick="metaExportCSV('campaigns')"><i class="bi bi-download"></i> CSV</button>
      </div>
      <div class="table-responsive">
        <table class="table table-dark table-striped table-hover table-sm">
          <thead><tr><th>Campaign</th><th>Objective</th><th>Status</th><th>Spend</th><th>Reach</th><th>Clicks</th><th>CTR</th><th>ROAS</th><th>Conversions</th></tr></thead>
          <tbody id="metaCampaignsBody"></tbody>
          <tfoot id="metaCampaignsFoot"></tfoot>
        </table>
      </div>
    </div>

    <!-- Ad Sets Tab -->
    <div class="tab-pane fade" id="metaTabAdSets">
      <div class="d-flex gap-2 align-items-center mb-2">
        <select class="form-select form-select-sm bg-dark text-light border-secondary" id="metaAdSetCampSelect" style="width:280px;" onchange="metaLoadAdSets()">
          <option value="">— Select Campaign —</option>
        </select>
        <button class="btn btn-sm btn-outline-info" onclick="metaExportCSV('adsets')"><i class="bi bi-download"></i> CSV</button>
      </div>
      <div class="table-responsive">
        <table class="table table-dark table-striped table-hover table-sm">
          <thead><tr><th>Ad Set</th><th>Status</th><th>Targeting</th><th>Budget/Day</th><th>Spend</th><th>Reach</th><th>Clicks</th><th>CPC</th><th>Conversions</th></tr></thead>
          <tbody id="metaAdSetsBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Ads Tab -->
    <div class="tab-pane fade" id="metaTabAds">
      <div class="d-flex gap-2 align-items-center mb-2">
        <select class="form-select form-select-sm bg-dark text-light border-secondary" id="metaAdSetSelect" style="width:280px;" onchange="metaLoadAds()">
          <option value="">— Select Ad Set —</option>
        </select>
        <button class="btn btn-sm btn-outline-info" onclick="metaExportCSV('ads')"><i class="bi bi-download"></i> CSV</button>
      </div>
      <div id="metaAdsContent"><div class="text-muted small">Select an ad set to view ads</div></div>
    </div>

    <!-- Budget & Pacing Tab -->
    <div class="tab-pane fade" id="metaTabBudget">
      <div id="metaBudgetContent"><div class="text-center text-muted py-5">Connect to view budget pacing</div></div>
    </div>

    <!-- Reports Tab -->
    <div class="tab-pane fade" id="metaTabReports">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <button class="btn btn-sm btn-primary" onclick="metaGenerateReport()"><i class="bi bi-file-earmark-bar-graph"></i> Generate Report</button>
        <button class="btn btn-sm btn-outline-info" onclick="metaExportCSV('report')"><i class="bi bi-download"></i> Export CSV</button>
      </div>
      <div id="metaReportContent"><div class="text-center text-muted py-5">Click "Generate Report" to create a custom report</div></div>
    </div>

    <!-- Test API Tab -->
    <div class="tab-pane fade" id="metaTabTestApi">
      <div class="d-flex gap-2 mb-3">
        <select class="form-select form-select-sm bg-dark text-light border-secondary" id="metaApiMethod" style="width:100px;">
          <option>GET</option><option>POST</option>
        </select>
        <select class="form-select form-select-sm bg-dark text-light border-secondary" id="metaApiEndpoint">
          <option value="campaigns">GET /act_{id}/campaigns</option>
          <option value="adsets">GET /act_{id}/adsets</option>
          <option value="ads">GET /act_{id}/ads</option>
          <option value="insights">GET /act_{id}/insights</option>
        </select>
        <button class="btn btn-sm btn-info" onclick="metaTestApiCall()"><i class="bi bi-send"></i> Send</button>
      </div>
      <div id="metaApiResult"><div class="text-muted small">Select an endpoint and click Send</div></div>
    </div>

    <!-- Settings Tab -->
    <div class="tab-pane fade" id="metaTabSettings">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label small">Ad Account Level</label>
          <select class="form-select form-select-sm bg-dark text-light border-secondary" id="metaSettingLevel">
            <option>Ad Account</option><option>Campaign</option><option>Ad Set</option>
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label small">Date Range</label>
          <select class="form-select form-select-sm bg-dark text-light border-secondary" id="metaSettingDateRange">
            <option>Last 7 days</option><option selected>Last 30 days</option><option>Last 90 days</option><option>This month</option>
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label small">Pixel ID</label>
          <input class="form-control form-control-sm bg-dark text-light border-secondary" id="metaSettingPixelId" value="pixel_987654321" />
        </div>
        <div class="col-md-6">
          <label class="form-label small">Attribution Window</label>
          <select class="form-select form-select-sm bg-dark text-light border-secondary" id="metaSettingAttribution">
            <option>1-day click</option><option selected>7-day click, 1-day view</option><option>28-day click, 1-day view</option>
          </select>
        </div>
        <div class="col-12">
          <label class="form-label small">Metrics to Display</label>
          <div class="row">
            <div class="col-3"><div class="form-check"><input class="form-check-input" type="checkbox" id="metaMetricReach" checked><label class="form-check-label small" for="metaMetricReach">Reach</label></div></div>
            <div class="col-3"><div class="form-check"><input class="form-check-input" type="checkbox" id="metaMetricImpressions" checked><label class="form-check-label small" for="metaMetricImpressions">Impressions</label></div></div>
            <div class="col-3"><div class="form-check"><input class="form-check-input" type="checkbox" id="metaMetricSpend" checked><label class="form-check-label small" for="metaMetricSpend">Spend</label></div></div>
            <div class="col-3"><div class="form-check"><input class="form-check-input" type="checkbox" id="metaMetricClicks" checked><label class="form-check-label small" for="metaMetricClicks">Clicks</label></div></div>
            <div class="col-3"><div class="form-check"><input class="form-check-input" type="checkbox" id="metaMetricCPC" checked><label class="form-check-label small" for="metaMetricCPC">CPC</label></div></div>
            <div class="col-3"><div class="form-check"><input class="form-check-input" type="checkbox" id="metaMetricROAS" checked><label class="form-check-label small" for="metaMetricROAS">ROAS</label></div></div>
            <div class="col-3"><div class="form-check"><input class="form-check-input" type="checkbox" id="metaMetricConversions" checked><label class="form-check-label small" for="metaMetricConversions">Conversions</label></div></div>
            <div class="col-3"><div class="form-check"><input class="form-check-input" type="checkbox" id="metaMetricFrequency"><label class="form-check-label small" for="metaMetricFrequency">Frequency</label></div></div>
          </div>
        </div>
        <div class="col-12">
          <button class="btn btn-primary" onclick="metaSaveSettings()"><i class="bi bi-save"></i> Save Settings</button>
        </div>
      </div>
    </div>
  </div>
  <!-- ═══ END META ADS PANEL ═══ -->
</div>

<!-- ═══════════════════════════════════════════════════════════════════════ -->
<!-- TIKTOK ADS RICH PANEL                                                 -->
<!-- ═══════════════════════════════════════════════════════════════════════ -->
<div id="tiktokAdsPanel" style="display:none;">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4><i class="bi bi-tiktok"></i> TikTok Ads</h4>
    <button class="btn btn-outline-secondary btn-sm" onclick="closePanel()"><i class="bi bi-x-lg"></i> Close</button>
  </div>
  <!-- Status badge -->
  <div class="mb-3" id="tiktokStatusBadge">
    <span class="badge bg-secondary">Checking…</span>
  </div>
  <!-- Tabs -->
  <ul class="nav nav-tabs mb-3" role="tablist">
    <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tiktokOverviewTab">Overview</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tiktokCampaignsTab">Campaigns</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tiktokAdGroupsTab">Ad Groups</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tiktokAdsTab">Ads</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tiktokBudgetTab">Budget & Pacing</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tiktokReportsTab">Reports</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tiktokTestApiTab">Test API</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tiktokSettingsTab">Settings</a></li>
  </ul>
  <div class="tab-content">
    <!-- Overview -->
    <div class="tab-pane fade show active" id="tiktokOverviewTab">
      <button class="btn btn-primary btn-sm mb-3" onclick="tiktokConnect()"><i class="bi bi-plug"></i> Connect & Load</button>
      <div id="tiktokOverviewContent"><p class="text-muted">Click Connect & Load to fetch TikTok Ads overview.</p></div>
    </div>
    <!-- Campaigns -->
    <div class="tab-pane fade" id="tiktokCampaignsTab">
      <div class="d-flex gap-2 mb-3">
        <select class="form-select form-select-sm bg-dark text-light w-auto" id="tiktokCampStatusFilter" onchange="tiktokRenderCampaigns()">
          <option value="ALL">All Statuses</option><option value="ACTIVE">Active</option><option value="PAUSED">Paused</option>
        </select>
        <select class="form-select form-select-sm bg-dark text-light w-auto" id="tiktokCampObjectiveFilter" onchange="tiktokRenderCampaigns()">
          <option value="ALL">All Objectives</option><option value="VIDEO_VIEWS">Video Views</option><option value="CONVERSIONS">Conversions</option><option value="REACH">Reach</option><option value="ENGAGEMENT">Engagement</option><option value="APP_INSTALL">App Install</option>
        </select>
        <button class="btn btn-outline-success btn-sm ms-auto" onclick="tiktokExportCSV('campaigns')"><i class="bi bi-download"></i> CSV</button>
      </div>
      <div class="table-responsive">
        <table class="table table-dark table-striped table-sm">
          <thead><tr><th>Campaign</th><th>Objective</th><th>Status</th><th>Spend</th><th>Video Views</th><th>Completion %</th><th>Engagement %</th><th>ROAS</th></tr></thead>
          <tbody id="tiktokCampaignsBody"></tbody>
          <tfoot id="tiktokCampaignsFoot"></tfoot>
        </table>
      </div>
    </div>
    <!-- Ad Groups -->
    <div class="tab-pane fade" id="tiktokAdGroupsTab">
      <div class="d-flex gap-2 mb-3">
        <select class="form-select form-select-sm bg-dark text-light w-auto" id="tiktokAdGroupCampaignSelect" onchange="tiktokLoadAdGroups()">
          <option value="">Select campaign…</option>
        </select>
      </div>
      <div class="table-responsive">
        <table class="table table-dark table-striped table-sm">
          <thead><tr><th>Ad Group</th><th>Status</th><th>Budget</th><th>Spend</th><th>Video Views</th><th>Completion %</th><th>Targeting</th></tr></thead>
          <tbody id="tiktokAdGroupsBody"></tbody>
        </table>
      </div>
    </div>
    <!-- Ads -->
    <div class="tab-pane fade" id="tiktokAdsTab">
      <div class="d-flex gap-2 mb-3">
        <select class="form-select form-select-sm bg-dark text-light w-auto" id="tiktokAdsAdGroupSelect" onchange="tiktokLoadAds()">
          <option value="">Select ad group…</option>
        </select>
      </div>
      <div id="tiktokAdsContent" class="row g-3"></div>
    </div>
    <!-- Budget & Pacing -->
    <div class="tab-pane fade" id="tiktokBudgetTab">
      <div id="tiktokBudgetContent"><p class="text-muted">Connect to view budget pacing data.</p></div>
    </div>
    <!-- Reports -->
    <div class="tab-pane fade" id="tiktokReportsTab">
      <button class="btn btn-primary btn-sm mb-3" onclick="tiktokGenerateReport()"><i class="bi bi-file-earmark-bar-graph"></i> Generate Report</button>
      <button class="btn btn-outline-success btn-sm mb-3" onclick="tiktokExportCSV('report')"><i class="bi bi-download"></i> Export CSV</button>
      <div id="tiktokReportContent"><p class="text-muted">Click Generate Report to create a TikTok performance report.</p></div>
    </div>
    <!-- Test API -->
    <div class="tab-pane fade" id="tiktokTestApiTab">
      <div class="d-flex gap-2 mb-3">
        <select class="form-select form-select-sm bg-dark text-light w-auto" id="tiktokApiEndpoint">
          <option value="campaign/get">campaign/get</option>
          <option value="adgroup/get">adgroup/get</option>
          <option value="ad/get">ad/get</option>
          <option value="report/integrated/get">report/integrated/get</option>
        </select>
        <button class="btn btn-warning btn-sm" onclick="tiktokTestApiCall()"><i class="bi bi-lightning"></i> Run Test Call</button>
      </div>
      <pre id="tiktokApiResult" class="bg-dark text-success p-3 rounded" style="max-height:400px;overflow:auto;">Select an endpoint and click Run Test Call.</pre>
    </div>
    <!-- Settings -->
    <div class="tab-pane fade" id="tiktokSettingsTab">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Ad Account</label>
          <select class="form-select bg-dark text-light" id="tiktokSettingsAccount">
            <option value="adv_987654321">TechStart TikTok (adv_987654321)</option>
            <option value="adv_123456789">Personal Brand TikTok (adv_123456789)</option>
            <option value="adv_456789012">Ecom Shop TikTok (adv_456789012)</option>
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">Date Range</label>
          <select class="form-select bg-dark text-light" id="tiktokSettingsDateRange">
            <option value="7">Last 7 days</option>
            <option value="30" selected>Last 30 days</option>
            <option value="90">Last 90 days</option>
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">TikTok Pixel ID</label>
          <input type="text" class="form-control bg-dark text-light" id="tiktokSettingsPixel" value="CPIXEL_987654321" placeholder="Pixel ID">
        </div>
        <div class="col-md-6">
          <label class="form-label">Attribution Window</label>
          <select class="form-select bg-dark text-light" id="tiktokSettingsAttribution">
            <option value="1d_click">1-day click</option>
            <option value="7d_click" selected>7-day click</option>
            <option value="28d_click">28-day click</option>
            <option value="7d_click_1d_view">7-day click + 1-day view</option>
          </select>
        </div>
        <div class="col-12">
          <label class="form-label">Metrics to Fetch</label>
          <div class="row">
            <div class="col-3"><div class="form-check"><input class="form-check-input" type="checkbox" id="tiktokMetricReach" checked><label class="form-check-label small" for="tiktokMetricReach">Reach</label></div></div>
            <div class="col-3"><div class="form-check"><input class="form-check-input" type="checkbox" id="tiktokMetricViews" checked><label class="form-check-label small" for="tiktokMetricViews">Video Views</label></div></div>
            <div class="col-3"><div class="form-check"><input class="form-check-input" type="checkbox" id="tiktokMetricCompletion" checked><label class="form-check-label small" for="tiktokMetricCompletion">Completion Rate</label></div></div>
            <div class="col-3"><div class="form-check"><input class="form-check-input" type="checkbox" id="tiktokMetricEngagement" checked><label class="form-check-label small" for="tiktokMetricEngagement">Engagement</label></div></div>
            <div class="col-3"><div class="form-check"><input class="form-check-input" type="checkbox" id="tiktokMetricSpend" checked><label class="form-check-label small" for="tiktokMetricSpend">Spend</label></div></div>
            <div class="col-3"><div class="form-check"><input class="form-check-input" type="checkbox" id="tiktokMetricROAS" checked><label class="form-check-label small" for="tiktokMetricROAS">ROAS</label></div></div>
            <div class="col-3"><div class="form-check"><input class="form-check-input" type="checkbox" id="tiktokMetricConversions" checked><label class="form-check-label small" for="tiktokMetricConversions">Conversions</label></div></div>
            <div class="col-3"><div class="form-check"><input class="form-check-input" type="checkbox" id="tiktokMetricShares"><label class="form-check-label small" for="tiktokMetricShares">Shares</label></div></div>
          </div>
        </div>
        <div class="col-12">
          <button class="btn btn-primary" onclick="tiktokSaveSettings()"><i class="bi bi-save"></i> Save Settings</button>
        </div>
      </div>
    </div>
  </div>
  <!-- ═══ END TIKTOK ADS PANEL ═══ -->
</div>

<!-- ═══════════════════════════════════════════════════════════════════════ -->
<!-- LINKEDIN ADS RICH PANEL                                               -->
<!-- ═══════════════════════════════════════════════════════════════════════ -->
<div id="linkedinAdsPanel" style="display:none;">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4><i class="bi bi-linkedin"></i> LinkedIn Ads</h4>
    <button class="btn btn-outline-secondary btn-sm" onclick="closePanel()"><i class="bi bi-x-lg"></i> Close</button>
  </div>
  <div class="mb-3" id="linkedinStatusBadge">
    <span class="badge bg-secondary">Checking…</span>
  </div>
  <ul class="nav nav-tabs mb-3" role="tablist">
    <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#linkedinOverviewTab">Overview</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#linkedinCampaignsTab">Campaigns</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#linkedinAdSetsTab">Ad Sets</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#linkedinAdsTab">Ads</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#linkedinBudgetTab">Budget & Pacing</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#linkedinReportsTab">Reports</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#linkedinTestApiTab">Test API</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#linkedinSettingsTab">Settings</a></li>
  </ul>
  <div class="tab-content">
    <!-- Overview -->
    <div class="tab-pane fade show active" id="linkedinOverviewTab">
      <button class="btn btn-primary btn-sm mb-3" onclick="linkedinConnect()"><i class="bi bi-plug"></i> Connect & Load</button>
      <div id="linkedinOverviewContent"><p class="text-muted">Click Connect & Load to fetch LinkedIn Ads overview.</p></div>
    </div>
    <!-- Campaigns -->
    <div class="tab-pane fade" id="linkedinCampaignsTab">
      <div class="d-flex gap-2 mb-3">
        <select class="form-select form-select-sm bg-dark text-light w-auto" id="linkedinCampStatusFilter" onchange="linkedinRenderCampaigns()">
          <option value="ALL">All Statuses</option><option value="ACTIVE">Active</option><option value="PAUSED">Paused</option>
        </select>
        <select class="form-select form-select-sm bg-dark text-light w-auto" id="linkedinCampObjectiveFilter" onchange="linkedinRenderCampaigns()">
          <option value="ALL">All Objectives</option><option value="LEAD_GENERATION">Lead Generation</option><option value="BRAND_AWARENESS">Brand Awareness</option><option value="WEBSITE_VISITS">Website Visits</option><option value="ENGAGEMENT">Engagement</option><option value="VIDEO_VIEWS">Video Views</option>
        </select>
        <button class="btn btn-outline-success btn-sm ms-auto" onclick="linkedinExportCSV('campaigns')"><i class="bi bi-download"></i> CSV</button>
      </div>
      <div class="table-responsive">
        <table class="table table-dark table-striped table-sm">
          <thead><tr><th>Campaign</th><th>Objective</th><th>Format</th><th>Status</th><th>Spend</th><th>Impressions</th><th>CTR</th><th>Leads</th><th>Cost/Lead</th><th>ROAS</th></tr></thead>
          <tbody id="linkedinCampaignsBody"></tbody>
          <tfoot id="linkedinCampaignsFoot"></tfoot>
        </table>
      </div>
    </div>
    <!-- Ad Sets -->
    <div class="tab-pane fade" id="linkedinAdSetsTab">
      <div class="d-flex gap-2 mb-3">
        <select class="form-select form-select-sm bg-dark text-light w-auto" id="linkedinAdSetCampaignSelect" onchange="linkedinLoadAdSets()">
          <option value="">Select campaign…</option>
        </select>
      </div>
      <div class="table-responsive">
        <table class="table table-dark table-striped table-sm">
          <thead><tr><th>Ad Set</th><th>Status</th><th>Budget</th><th>Spend</th><th>Leads</th><th>CTR</th><th>Targeting</th></tr></thead>
          <tbody id="linkedinAdSetsBody"></tbody>
        </table>
      </div>
    </div>
    <!-- Ads -->
    <div class="tab-pane fade" id="linkedinAdsTab">
      <div class="d-flex gap-2 mb-3">
        <select class="form-select form-select-sm bg-dark text-light w-auto" id="linkedinAdsAdSetSelect" onchange="linkedinLoadAds()">
          <option value="">Select ad set…</option>
        </select>
      </div>
      <div id="linkedinAdsContent" class="row g-3"></div>
    </div>
    <!-- Budget & Pacing -->
    <div class="tab-pane fade" id="linkedinBudgetTab">
      <div id="linkedinBudgetContent"><p class="text-muted">Connect to view budget pacing data.</p></div>
    </div>
    <!-- Reports -->
    <div class="tab-pane fade" id="linkedinReportsTab">
      <button class="btn btn-primary btn-sm mb-3" onclick="linkedinGenerateReport()"><i class="bi bi-file-earmark-bar-graph"></i> Generate Report</button>
      <button class="btn btn-outline-success btn-sm mb-3" onclick="linkedinExportCSV('report')"><i class="bi bi-download"></i> Export CSV</button>
      <div id="linkedinReportContent"><p class="text-muted">Click Generate Report to create a LinkedIn performance report.</p></div>
    </div>
    <!-- Test API -->
    <div class="tab-pane fade" id="linkedinTestApiTab">
      <div class="d-flex gap-2 mb-3">
        <select class="form-select form-select-sm bg-dark text-light w-auto" id="linkedinApiEndpoint">
          <option value="adCampaignsV2">adCampaignsV2 (Campaigns)</option>
          <option value="adCreativesV2">adCreativesV2 (Creatives)</option>
          <option value="adAnalyticsV2">adAnalyticsV2 (Analytics)</option>
          <option value="adInsightsV2">adInsightsV2 (Insights)</option>
        </select>
        <button class="btn btn-warning btn-sm" onclick="linkedinTestApiCall()"><i class="bi bi-lightning"></i> Run Test Call</button>
      </div>
      <pre id="linkedinApiResult" class="bg-dark text-success p-3 rounded" style="max-height:400px;overflow:auto;">Select an endpoint and click Run Test Call.</pre>
    </div>
    <!-- Settings -->
    <div class="tab-pane fade" id="linkedinSettingsTab">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Ad Account</label>
          <select class="form-select bg-dark text-light" id="linkedinSettingsAccount">
            <option value="li_acc_987654321">TechStart B2B (li_acc_987654321)</option>
            <option value="li_acc_123456789">Consulting Firm Ads (li_acc_123456789)</option>
            <option value="li_acc_456789012">Startup Founders Ads (li_acc_456789012)</option>
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">Date Range</label>
          <select class="form-select bg-dark text-light" id="linkedinSettingsDateRange">
            <option value="7">Last 7 days</option>
            <option value="30" selected>Last 30 days</option>
            <option value="90">Last 90 days</option>
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">Lead Form ID</label>
          <input type="text" class="form-control bg-dark text-light" id="linkedinSettingsLeadForm" value="LF_987654321" placeholder="Lead Form ID">
        </div>
        <div class="col-md-6">
          <label class="form-label">Conversion Window</label>
          <select class="form-select bg-dark text-light" id="linkedinSettingsConvWindow">
            <option value="1d">1-day post-click</option>
            <option value="7d" selected>7-day post-click</option>
            <option value="30d">30-day post-click</option>
            <option value="90d">90-day post-click + view</option>
          </select>
        </div>
        <div class="col-12">
          <label class="form-label">Metrics to Fetch</label>
          <div class="row">
            <div class="col-3"><div class="form-check"><input class="form-check-input" type="checkbox" id="liMetricImpressions" checked><label class="form-check-label small" for="liMetricImpressions">Impressions</label></div></div>
            <div class="col-3"><div class="form-check"><input class="form-check-input" type="checkbox" id="liMetricClicks" checked><label class="form-check-label small" for="liMetricClicks">Clicks</label></div></div>
            <div class="col-3"><div class="form-check"><input class="form-check-input" type="checkbox" id="liMetricLeads" checked><label class="form-check-label small" for="liMetricLeads">Leads</label></div></div>
            <div class="col-3"><div class="form-check"><input class="form-check-input" type="checkbox" id="liMetricCPL" checked><label class="form-check-label small" for="liMetricCPL">Cost/Lead</label></div></div>
            <div class="col-3"><div class="form-check"><input class="form-check-input" type="checkbox" id="liMetricSpend" checked><label class="form-check-label small" for="liMetricSpend">Spend</label></div></div>
            <div class="col-3"><div class="form-check"><input class="form-check-input" type="checkbox" id="liMetricROAS" checked><label class="form-check-label small" for="liMetricROAS">ROAS</label></div></div>
            <div class="col-3"><div class="form-check"><input class="form-check-input" type="checkbox" id="liMetricEngagement" checked><label class="form-check-label small" for="liMetricEngagement">Engagement</label></div></div>
            <div class="col-3"><div class="form-check"><input class="form-check-input" type="checkbox" id="liMetricFollows"><label class="form-check-label small" for="liMetricFollows">Follows</label></div></div>
          </div>
        </div>
        <div class="col-12">
          <button class="btn btn-primary" onclick="linkedinSaveSettings()"><i class="bi bi-save"></i> Save Settings</button>
        </div>
      </div>
    </div>
  </div>
  <!-- ═══ END LINKEDIN ADS PANEL ═══ -->
</div>

<!-- ═══════════════════════════════════════════════════════════════════════ -->
<!-- STRIPE RICH PANEL (Phase 18) — 8 tabs                                -->
<!-- ═══════════════════════════════════════════════════════════════════════ -->
<div id="stripePanel" style="display:none;" class="mt-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0"><i class="bi bi-stripe" style="color:#635bff;"></i> Stripe Dashboard</h4>
    <button class="btn btn-outline-secondary btn-sm" onclick="closePanel()"><i class="bi bi-x-lg"></i> Close</button>
  </div>
  <ul class="nav nav-tabs mb-3" role="tablist">
    <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#stripeOverview">Overview</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#stripeSubs">Subscriptions</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#stripePayments">Payments</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#stripeCustomers">Customers</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#stripeBudget">Revenue & Pacing</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#stripeReports">Reports</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#stripeTestApi">Test API</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#stripeSettings">Settings</a></li>
  </ul>
  <div class="tab-content">
    <!-- Overview -->
    <div class="tab-pane fade show active" id="stripeOverview">
      <div class="d-flex align-items-center gap-3 mb-3">
        <label class="text-muted mb-0">Account:</label>
        <select id="stripeAccountSelect" class="form-select form-select-sm bg-dark text-light" style="width:260px;" onchange="stripeLoadAccount()"></select>
        <button class="btn btn-sm btn-outline-light" onclick="stripeConnect()" id="stripeConnectBtn"><i class="bi bi-plug"></i> Connect</button>
        <span id="stripeConnStatus" class="badge bg-secondary ms-2">Not Connected</span>
      </div>
      <div id="stripeOverviewContent"><p class="text-muted">Click Connect to load Stripe data…</p></div>
    </div>
    <!-- Subscriptions -->
    <div class="tab-pane fade" id="stripeSubs">
      <div class="d-flex gap-2 mb-3">
        <select id="stripeSubStatusFilter" class="form-select form-select-sm bg-dark text-light" style="width:150px;" onchange="stripeLoadSubs()">
          <option value="">All Statuses</option><option value="active">Active</option><option value="trialing">Trialing</option><option value="canceled">Canceled</option><option value="past_due">Past Due</option>
        </select>
        <select id="stripeSubPlanFilter" class="form-select form-select-sm bg-dark text-light" style="width:150px;" onchange="stripeLoadSubs()">
          <option value="">All Plans</option><option value="Pro Monthly">Pro Monthly</option><option value="Pro Annual">Pro Annual</option><option value="Basic Monthly">Basic Monthly</option><option value="Enterprise">Enterprise</option>
        </select>
        <button class="btn btn-sm btn-outline-success ms-auto" onclick="stripeExportCSV('subscriptions')"><i class="bi bi-download"></i> CSV</button>
      </div>
      <table class="table table-dark table-striped table-sm"><thead><tr><th>Sub ID</th><th>Customer</th><th>Plan</th><th>Amount</th><th>Status</th><th>Interval</th><th>Period End</th></tr></thead>
        <tbody id="stripeSubsBody"></tbody>
        <tfoot id="stripeSubsFoot"></tfoot>
      </table>
    </div>
    <!-- Payments -->
    <div class="tab-pane fade" id="stripePayments">
      <div class="d-flex gap-2 mb-3">
        <select id="stripePayStatusFilter" class="form-select form-select-sm bg-dark text-light" style="width:150px;" onchange="stripeLoadPayments()">
          <option value="">All Statuses</option><option value="succeeded">Succeeded</option><option value="refunded">Refunded</option><option value="failed">Failed</option>
        </select>
        <button class="btn btn-sm btn-outline-success ms-auto" onclick="stripeExportCSV('payments')"><i class="bi bi-download"></i> CSV</button>
      </div>
      <table class="table table-dark table-striped table-sm"><thead><tr><th>Payment ID</th><th>Amount</th><th>Status</th><th>Customer</th><th>Description</th><th>Card</th><th>Date</th></tr></thead>
        <tbody id="stripePaymentsBody"></tbody>
      </table>
    </div>
    <!-- Customers -->
    <div class="tab-pane fade" id="stripeCustomers">
      <div class="d-flex gap-2 mb-3">
        <select id="stripeCustStatusFilter" class="form-select form-select-sm bg-dark text-light" style="width:150px;" onchange="stripeLoadCustomers()">
          <option value="">All Statuses</option><option value="active">Active</option><option value="trialing">Trialing</option><option value="canceled">Canceled</option><option value="past_due">Past Due</option>
        </select>
        <button class="btn btn-sm btn-outline-success ms-auto" onclick="stripeExportCSV('customers')"><i class="bi bi-download"></i> CSV</button>
      </div>
      <table class="table table-dark table-striped table-sm"><thead><tr><th>Customer</th><th>Email</th><th>Plan</th><th>LTV</th><th>Status</th><th>Country</th><th>Since</th></tr></thead>
        <tbody id="stripeCustomersBody"></tbody>
      </table>
    </div>
    <!-- Revenue & Pacing -->
    <div class="tab-pane fade" id="stripeBudget">
      <div id="stripeBudgetContent"><p class="text-muted">Connect to load revenue pacing…</p></div>
    </div>
    <!-- Reports -->
    <div class="tab-pane fade" id="stripeReports">
      <button class="btn btn-sm btn-outline-primary mb-3" onclick="stripeGenerateReport()"><i class="bi bi-table"></i> Generate Revenue Report</button>
      <button class="btn btn-sm btn-outline-success mb-3 ms-2" onclick="stripeExportCSV('report')"><i class="bi bi-download"></i> Export CSV</button>
      <div id="stripeReportContent"></div>
    </div>
    <!-- Test API -->
    <div class="tab-pane fade" id="stripeTestApi">
      <div class="d-flex gap-2 mb-3">
        <select id="stripeApiEndpoint" class="form-select form-select-sm bg-dark text-light" style="width:250px;">
          <option value="customers">GET /v1/customers</option>
          <option value="charges">GET /v1/charges</option>
          <option value="subscriptions">GET /v1/subscriptions</option>
          <option value="balance">GET /v1/balance</option>
        </select>
        <button class="btn btn-sm" style="background:#635bff;color:#fff;" onclick="stripeTestApiCall()"><i class="bi bi-send"></i> Test Call</button>
      </div>
      <pre id="stripeApiResult" class="bg-dark text-success p-3 rounded" style="max-height:420px;overflow:auto;font-size:.82rem;"></pre>
    </div>
    <!-- Settings -->
    <div class="tab-pane fade" id="stripeSettings">
      <div class="row g-3">
        <div class="col-md-6">
          <h6>Account Mode</h6>
          <select id="stripeSettingsMode" class="form-select bg-dark text-light mb-3"><option>Live</option><option>Test</option></select>
          <h6>Currency</h6>
          <select id="stripeSettingsCurrency" class="form-select bg-dark text-light mb-3"><option>USD</option><option>EUR</option><option>GBP</option></select>
          <h6>Webhook URL (mock)</h6>
          <input type="text" id="stripeSettingsWebhook" class="form-control bg-dark text-light" value="https://yourapp.com/webhooks/stripe">
        </div>
        <div class="col-md-6">
          <h6>Metrics to Track</h6>
          <div class="form-check"><input class="form-check-input" type="checkbox" id="stripeMetricRevenue" checked><label class="form-check-label" for="stripeMetricRevenue">Revenue</label></div>
          <div class="form-check"><input class="form-check-input" type="checkbox" id="stripeMetricMRR" checked><label class="form-check-label" for="stripeMetricMRR">MRR / ARR</label></div>
          <div class="form-check"><input class="form-check-input" type="checkbox" id="stripeMetricSubs" checked><label class="form-check-label" for="stripeMetricSubs">Active Subscriptions</label></div>
          <div class="form-check"><input class="form-check-input" type="checkbox" id="stripeMetricChurn" checked><label class="form-check-label" for="stripeMetricChurn">Churn Rate</label></div>
          <div class="form-check"><input class="form-check-input" type="checkbox" id="stripeMetricLTV"><label class="form-check-label" for="stripeMetricLTV">LTV / CAC</label></div>
          <div class="form-check"><input class="form-check-input" type="checkbox" id="stripeMetricRunway"><label class="form-check-label" for="stripeMetricRunway">Cash Runway</label></div>
        </div>
      </div>
      <button class="btn btn-sm mt-3" style="background:#635bff;color:#fff;" onclick="stripeSaveSettings()"><i class="bi bi-save"></i> Save Settings</button>
    </div>
  </div>
</div>
<!-- ═══ END STRIPE PANEL ═══ -->
</div>

<!-- ═══════════════════════════════════════════════════════════════════════ -->
<!-- SHOPIFY RICH PANEL (Phase 19) — 8 tabs                               -->
<!-- ═══════════════════════════════════════════════════════════════════════ -->
<div id="shopifyPanel" style="display:none;" class="mt-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0"><i class="bi bi-bag-check" style="color:#96bf48;"></i> Shopify Dashboard</h4>
    <button class="btn btn-outline-secondary btn-sm" onclick="closePanel()"><i class="bi bi-x-lg"></i> Close</button>
  </div>
  <ul class="nav nav-tabs mb-3" role="tablist">
    <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#shopifyOverview">Overview</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#shopifyProducts">Products</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#shopifyOrders">Orders</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#shopifyAbandoned">Abandoned Carts</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#shopifyCustomers">Customers</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#shopifyReports">Reports</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#shopifyTestApi">Test API</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#shopifySettings">Settings</a></li>
  </ul>
  <div class="tab-content">
    <!-- Overview -->
    <div class="tab-pane fade show active" id="shopifyOverview">
      <div class="d-flex align-items-center gap-3 mb-3">
        <label class="text-muted mb-0">Store:</label>
        <select id="shopifyStoreSelect" class="form-select form-select-sm bg-dark text-light" style="width:280px;" onchange="shopifyLoadStore()"></select>
        <button class="btn btn-sm btn-outline-light" onclick="shopifyConnect()" id="shopifyConnectBtn"><i class="bi bi-plug"></i> Connect</button>
        <span id="shopifyConnStatus" class="badge bg-secondary ms-2">Not Connected</span>
      </div>
      <div id="shopifyOverviewContent"><p class="text-muted">Click Connect to load store data…</p></div>
    </div>
    <!-- Products -->
    <div class="tab-pane fade" id="shopifyProducts">
      <div class="d-flex gap-2 mb-3">
        <select id="shopifyProdStatusFilter" class="form-select form-select-sm bg-dark text-light" style="width:140px;" onchange="shopifyLoadProducts()">
          <option value="">All Statuses</option><option value="active">Active</option><option value="draft">Draft</option><option value="archived">Archived</option>
        </select>
        <select id="shopifyProdCollFilter" class="form-select form-select-sm bg-dark text-light" style="width:160px;" onchange="shopifyLoadProducts()">
          <option value="">All Collections</option><option value="Best Sellers">Best Sellers</option><option value="Work From Home">Work From Home</option><option value="Gaming">Gaming</option><option value="Under $30">Under $30</option>
        </select>
        <button class="btn btn-sm btn-outline-success ms-auto" onclick="shopifyExportCSV('products')"><i class="bi bi-download"></i> CSV</button>
      </div>
      <table class="table table-dark table-striped table-sm"><thead><tr><th>Product</th><th>Price</th><th>Compare</th><th>Inventory</th><th>Status</th><th>Collection</th><th>Variants</th></tr></thead>
        <tbody id="shopifyProductsBody"></tbody>
      </table>
    </div>
    <!-- Orders -->
    <div class="tab-pane fade" id="shopifyOrders">
      <div class="d-flex gap-2 mb-3">
        <select id="shopifyOrderStatusFilter" class="form-select form-select-sm bg-dark text-light" style="width:160px;" onchange="shopifyLoadOrders()">
          <option value="">All Statuses</option><option value="fulfilled">Fulfilled</option><option value="unfulfilled">Unfulfilled</option><option value="partially_fulfilled">Partially Fulfilled</option><option value="cancelled">Cancelled</option>
        </select>
        <button class="btn btn-sm btn-outline-success ms-auto" onclick="shopifyExportCSV('orders')"><i class="bi bi-download"></i> CSV</button>
      </div>
      <table class="table table-dark table-striped table-sm"><thead><tr><th>Order</th><th>Customer</th><th>Total</th><th>Items</th><th>Status</th><th>Payment</th><th>Date</th></tr></thead>
        <tbody id="shopifyOrdersBody"></tbody>
      </table>
    </div>
    <!-- Abandoned Carts -->
    <div class="tab-pane fade" id="shopifyAbandoned">
      <div id="shopifyAbandonedContent"><p class="text-muted">Connect to load abandoned carts…</p></div>
    </div>
    <!-- Customers -->
    <div class="tab-pane fade" id="shopifyCustomers">
      <div class="d-flex gap-2 mb-3">
        <select id="shopifyCustStatusFilter" class="form-select form-select-sm bg-dark text-light" style="width:140px;" onchange="shopifyLoadCustomers()">
          <option value="">All</option><option value="active">Active</option><option value="inactive">Inactive</option>
        </select>
        <button class="btn btn-sm btn-outline-success ms-auto" onclick="shopifyExportCSV('customers')"><i class="bi bi-download"></i> CSV</button>
      </div>
      <table class="table table-dark table-striped table-sm"><thead><tr><th>Customer</th><th>Email</th><th>Orders</th><th>Total Spent</th><th>AOV</th><th>Country</th><th>Tags</th></tr></thead>
        <tbody id="shopifyCustomersBody"></tbody>
      </table>
    </div>
    <!-- Reports -->
    <div class="tab-pane fade" id="shopifyReports">
      <button class="btn btn-sm btn-outline-primary mb-3" onclick="shopifyGenerateReport()"><i class="bi bi-table"></i> Generate Store Report</button>
      <button class="btn btn-sm btn-outline-success mb-3 ms-2" onclick="shopifyExportCSV('report')"><i class="bi bi-download"></i> Export CSV</button>
      <div id="shopifyReportContent"></div>
    </div>
    <!-- Test API -->
    <div class="tab-pane fade" id="shopifyTestApi">
      <div class="d-flex gap-2 mb-3">
        <select id="shopifyApiEndpoint" class="form-select form-select-sm bg-dark text-light" style="width:280px;">
          <option value="products">GET /admin/api/products.json</option>
          <option value="orders">GET /admin/api/orders.json</option>
          <option value="customers">GET /admin/api/customers.json</option>
        </select>
        <button class="btn btn-sm" style="background:#96bf48;color:#fff;" onclick="shopifyTestApiCall()"><i class="bi bi-send"></i> Test Call</button>
      </div>
      <pre id="shopifyApiResult" class="bg-dark text-success p-3 rounded" style="max-height:420px;overflow:auto;font-size:.82rem;"></pre>
    </div>
    <!-- Settings -->
    <div class="tab-pane fade" id="shopifySettings">
      <div class="row g-3">
        <div class="col-md-6">
          <h6>Store Domain</h6>
          <input type="text" id="shopifySettingsDomain" class="form-control bg-dark text-light mb-3" value="techstart-store.myshopify.com">
          <h6>Currency</h6>
          <select id="shopifySettingsCurrency" class="form-select bg-dark text-light mb-3"><option>USD</option><option>EUR</option><option>GBP</option></select>
          <h6>Timezone</h6>
          <select id="shopifySettingsTimezone" class="form-select bg-dark text-light"><option>America/New_York</option><option>Europe/Berlin</option><option>Europe/London</option><option>Asia/Tokyo</option></select>
        </div>
        <div class="col-md-6">
          <h6>Metrics to Track</h6>
          <div class="form-check"><input class="form-check-input" type="checkbox" id="shopifyMetricRevenue" checked><label class="form-check-label" for="shopifyMetricRevenue">Revenue</label></div>
          <div class="form-check"><input class="form-check-input" type="checkbox" id="shopifyMetricOrders" checked><label class="form-check-label" for="shopifyMetricOrders">Orders</label></div>
          <div class="form-check"><input class="form-check-input" type="checkbox" id="shopifyMetricAOV" checked><label class="form-check-label" for="shopifyMetricAOV">Average Order Value</label></div>
          <div class="form-check"><input class="form-check-input" type="checkbox" id="shopifyMetricConversion" checked><label class="form-check-label" for="shopifyMetricConversion">Conversion Rate</label></div>
          <div class="form-check"><input class="form-check-input" type="checkbox" id="shopifyMetricAbandoned"><label class="form-check-label" for="shopifyMetricAbandoned">Abandoned Carts</label></div>
          <div class="form-check"><input class="form-check-input" type="checkbox" id="shopifyMetricNewCust"><label class="form-check-label" for="shopifyMetricNewCust">New Customers</label></div>
        </div>
      </div>
      <button class="btn btn-sm mt-3" style="background:#96bf48;color:#fff;" onclick="shopifySaveSettings()"><i class="bi bi-save"></i> Save Settings</button>
    </div>
  </div>
</div>
<!-- ═══ END SHOPIFY PANEL ═══ -->

<!-- ═══════════════════════════════════════════════════════════════════════ -->
<!-- HUBSPOT RICH PANEL (Phase 20) — 8 Tabs                               -->
<!-- ═══════════════════════════════════════════════════════════════════════ -->
<div id="hubspotPanel" style="display:none;">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4><i class="bi bi-bullseye" style="color:#ff7a59;"></i> HubSpot CRM <span id="hubspotConnStatus" class="badge bg-secondary ms-2">Not Connected</span></h4>
    <button class="btn btn-outline-light btn-sm" onclick="closePanel()"><i class="bi bi-arrow-left"></i> Back</button>
  </div>
  <ul class="nav nav-tabs mb-3" role="tablist">
    <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#hubspotOverviewTab" style="color:#ff7a59;">Overview</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#hubspotContactsTab">Contacts</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#hubspotCompaniesTab">Companies</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#hubspotDealsTab">Deals</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#hubspotCampaignsTab">Email Campaigns</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#hubspotReportsTab">Reports</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#hubspotApiTab">Test API</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#hubspotSettingsTab">Settings</a></li>
  </ul>
  <div class="tab-content">
    <!-- Overview -->
    <div class="tab-pane fade show active" id="hubspotOverviewTab">
      <div class="d-flex gap-2 mb-3">
        <select id="hubspotPortalSelect" class="form-select form-select-sm bg-dark text-light" style="max-width:300px;" onchange="hubspotLoadPortal()"></select>
        <button id="hubspotConnectBtn" class="btn btn-sm" style="background:#ff7a59;color:#fff;" onclick="hubspotConnect()"><i class="bi bi-plug"></i> Connect</button>
      </div>
      <div id="hubspotOverviewContent"><p class="text-muted">Click Connect to load CRM data…</p></div>
    </div>
    <!-- Contacts -->
    <div class="tab-pane fade" id="hubspotContactsTab">
      <div class="d-flex gap-2 mb-3">
        <select id="hubspotContactStageFilter" class="form-select form-select-sm bg-dark text-light" style="max-width:200px;" onchange="hubspotLoadContacts()">
          <option value="">All Stages</option>
          <option value="Subscriber">Subscriber</option>
          <option value="Lead">Lead</option>
          <option value="Marketing Qualified Lead">MQL</option>
          <option value="Sales Qualified Lead">SQL</option>
          <option value="Opportunity">Opportunity</option>
          <option value="Customer">Customer</option>
          <option value="Evangelist">Evangelist</option>
        </select>
        <select id="hubspotContactOwnerFilter" class="form-select form-select-sm bg-dark text-light" style="max-width:180px;" onchange="hubspotLoadContacts()">
          <option value="">All Owners</option>
          <option value="Sarah Chen">Sarah Chen</option>
          <option value="Alex Müller">Alex Müller</option>
          <option value="Diego Santos">Diego Santos</option>
        </select>
        <button class="btn btn-sm btn-outline-light ms-auto" onclick="hubspotExportCSV('contacts')"><i class="bi bi-download"></i> CSV</button>
      </div>
      <div class="table-responsive"><table class="table table-dark table-striped table-sm">
        <thead><tr><th>Name</th><th>Email</th><th>Company</th><th>Stage</th><th>Status</th><th>Owner</th><th>Last Activity</th></tr></thead>
        <tbody id="hubspotContactsBody"></tbody>
      </table></div>
    </div>
    <!-- Companies -->
    <div class="tab-pane fade" id="hubspotCompaniesTab">
      <div class="d-flex gap-2 mb-3">
        <select id="hubspotCompanyIndustryFilter" class="form-select form-select-sm bg-dark text-light" style="max-width:200px;" onchange="hubspotLoadCompanies()">
          <option value="">All Industries</option>
          <option value="Technology">Technology</option>
          <option value="SaaS">SaaS</option>
          <option value="IT Services">IT Services</option>
          <option value="Consulting">Consulting</option>
          <option value="Financial Services">Financial Services</option>
          <option value="Retail">Retail</option>
          <option value="Cloud Computing">Cloud Computing</option>
          <option value="Digital Marketing">Digital Marketing</option>
          <option value="Media">Media & Entertainment</option>
        </select>
        <button class="btn btn-sm btn-outline-light ms-auto" onclick="hubspotExportCSV('companies')"><i class="bi bi-download"></i> CSV</button>
      </div>
      <div class="table-responsive"><table class="table table-dark table-striped table-sm">
        <thead><tr><th>Company</th><th>Domain</th><th>Industry</th><th>Revenue</th><th>Employees</th><th>Deals</th><th>Contacts</th><th>Stage</th></tr></thead>
        <tbody id="hubspotCompaniesBody"></tbody>
      </table></div>
    </div>
    <!-- Deals -->
    <div class="tab-pane fade" id="hubspotDealsTab">
      <div class="d-flex gap-2 mb-3">
        <select id="hubspotDealStageFilter" class="form-select form-select-sm bg-dark text-light" style="max-width:220px;" onchange="hubspotLoadDeals()">
          <option value="">All Stages</option>
          <option value="Appointment Scheduled">Appointment Scheduled</option>
          <option value="Qualified to Buy">Qualified to Buy</option>
          <option value="Presentation Scheduled">Presentation Scheduled</option>
          <option value="Decision Maker Bought-In">Decision Maker Bought-In</option>
          <option value="Contract Sent">Contract Sent</option>
          <option value="Closed Won">Closed Won</option>
          <option value="Closed Lost">Closed Lost</option>
        </select>
        <button class="btn btn-sm btn-outline-light ms-auto" onclick="hubspotExportCSV('deals')"><i class="bi bi-download"></i> CSV</button>
      </div>
      <div class="table-responsive"><table class="table table-dark table-striped table-sm">
        <thead><tr><th>Deal</th><th>Amount</th><th>Stage</th><th>Probability</th><th>Company</th><th>Contact</th><th>Close Date</th></tr></thead>
        <tbody id="hubspotDealsBody"></tbody>
      </table></div>
    </div>
    <!-- Email Campaigns -->
    <div class="tab-pane fade" id="hubspotCampaignsTab">
      <div class="d-flex gap-2 mb-3">
        <select id="hubspotCampaignStatusFilter" class="form-select form-select-sm bg-dark text-light" style="max-width:180px;" onchange="hubspotLoadCampaigns()">
          <option value="">All Status</option>
          <option value="sent">Sent</option>
          <option value="active">Active</option>
          <option value="draft">Draft</option>
        </select>
        <button class="btn btn-sm btn-outline-light ms-auto" onclick="hubspotExportCSV('campaigns')"><i class="bi bi-download"></i> CSV</button>
      </div>
      <div class="table-responsive"><table class="table table-dark table-striped table-sm">
        <thead><tr><th>Campaign</th><th>Subject</th><th>Type</th><th>Sent</th><th>Opens</th><th>Open Rate</th><th>Clicks</th><th>CTR</th><th>Status</th></tr></thead>
        <tbody id="hubspotCampaignsBody"></tbody>
      </table></div>
    </div>
    <!-- Reports -->
    <div class="tab-pane fade" id="hubspotReportsTab">
      <div class="d-flex gap-2 mb-3">
        <button class="btn btn-sm" style="background:#ff7a59;color:#fff;" onclick="hubspotGenerateReport()"><i class="bi bi-bar-chart-line"></i> Generate Report</button>
        <button class="btn btn-sm btn-outline-light" onclick="hubspotExportCSV('report')"><i class="bi bi-download"></i> Export CSV</button>
      </div>
      <div id="hubspotReportContent"><p class="text-muted">Click Generate to build a CRM daily report…</p></div>
    </div>
    <!-- Test API -->
    <div class="tab-pane fade" id="hubspotApiTab">
      <div class="card bg-dark border-secondary mb-3"><div class="card-body">
        <h6><i class="bi bi-terminal" style="color:#ff7a59;"></i> HubSpot CRM API v3 Test</h6>
        <div class="d-flex gap-2 mb-2">
          <select id="hubspotApiEndpoint" class="form-select form-select-sm bg-dark text-light" style="max-width:250px;">
            <option value="contacts">GET /crm/v3/objects/contacts</option>
            <option value="deals">GET /crm/v3/objects/deals</option>
            <option value="companies">GET /crm/v3/objects/companies</option>
          </select>
          <button class="btn btn-sm" style="background:#ff7a59;color:#fff;" onclick="hubspotTestApiCall()"><i class="bi bi-play-fill"></i> Run</button>
        </div>
        <pre id="hubspotApiResult" class="bg-black text-success p-3 rounded" style="max-height:350px;overflow-y:auto;font-size:0.8rem;">Waiting…</pre>
      </div></div>
    </div>
    <!-- Settings -->
    <div class="tab-pane fade" id="hubspotSettingsTab">
      <div class="card bg-dark border-secondary"><div class="card-body">
        <h6><i class="bi bi-gear" style="color:#ff7a59;"></i> HubSpot Settings</h6>
        <div class="mb-3">
          <label class="form-label small">Portal Hub Domain</label>
          <input type="text" id="hubspotSettingsDomain" class="form-control form-control-sm bg-dark text-light" value="techstart.hubspot.com">
        </div>
        <div class="mb-3">
          <label class="form-label small">API Key (mock)</label>
          <input type="text" id="hubspotSettingsApiKey" class="form-control form-control-sm bg-dark text-light" value="pat-mock-xxxx-xxxx-xxxx" readonly>
        </div>
        <div class="mb-3">
          <label class="form-label small">Default Owner</label>
          <select id="hubspotSettingsOwner" class="form-select form-select-sm bg-dark text-light">
            <option>All Owners</option>
            <option>Sarah Chen</option>
            <option>Alex Müller</option>
            <option>Diego Santos</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label small">Metrics to Track</label>
          <div class="row">
            <div class="col-6">
              <div class="form-check"><input class="form-check-input" type="checkbox" checked id="hsMetricContacts"><label class="form-check-label small" for="hsMetricContacts">Contacts</label></div>
              <div class="form-check"><input class="form-check-input" type="checkbox" checked id="hsMetricDeals"><label class="form-check-label small" for="hsMetricDeals">Deals</label></div>
              <div class="form-check"><input class="form-check-input" type="checkbox" checked id="hsMetricRevenue"><label class="form-check-label small" for="hsMetricRevenue">Revenue</label></div>
            </div>
            <div class="col-6">
              <div class="form-check"><input class="form-check-input" type="checkbox" checked id="hsMetricEmail"><label class="form-check-label small" for="hsMetricEmail">Email Opens</label></div>
              <div class="form-check"><input class="form-check-input" type="checkbox" id="hsMetricTasks"><label class="form-check-label small" for="hsMetricTasks">Open Tasks</label></div>
              <div class="form-check"><input class="form-check-input" type="checkbox" id="hsMetricLeads"><label class="form-check-label small" for="hsMetricLeads">New Leads</label></div>
            </div>
          </div>
        </div>
      </div></div>
      <button class="btn btn-sm mt-3" style="background:#ff7a59;color:#fff;" onclick="hubspotSaveSettings()"><i class="bi bi-save"></i> Save Settings</button>
    </div>
  </div>
</div>
<!-- ═══ END HUBSPOT PANEL ═══ -->

<!-- ═══════════════════════════════════════════════════════════════════════════ -->
<!-- SALESFORCE RICH PANEL (Phase 21) -->
<!-- ═══════════════════════════════════════════════════════════════════════════ -->
<div id="salesforcePanel" style="display:none;" class="p-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0"><i class="bi bi-cloud-fill" style="color:#00a1e0;"></i> Salesforce CRM</h4>
    <div>
      <button class="btn btn-sm btn-outline-info me-2" id="sfConnectBtn" onclick="salesforceConnect()"><i class="bi bi-plug"></i> Connect Org</button>
      <button class="btn btn-sm btn-outline-secondary" onclick="closePanel()"><i class="bi bi-x-lg"></i> Close</button>
    </div>
  </div>
  <div id="sfConnectionAlert" class="alert alert-secondary py-2 small" style="display:none;"></div>

  <!-- Org Selector -->
  <div class="mb-3">
    <label class="form-label small text-muted">Salesforce Org</label>
    <select id="sfOrgSelect" class="form-select form-select-sm bg-dark text-light" style="max-width:400px;" onchange="salesforceLoadOrg()">
      <option value="">— Select org —</option>
    </select>
  </div>

  <!-- Tabs -->
  <ul class="nav nav-tabs nav-fill mb-3" role="tablist" style="border-bottom-color:#00a1e0;">
    <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#sfOverview">Overview</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#sfLeads">Leads</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#sfOpportunities">Opportunities</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#sfAccounts">Accounts</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#sfCampaigns">Campaigns</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#sfReports">Reports</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#sfTestApi">Test API</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#sfSettings">Settings</a></li>
  </ul>

  <div class="tab-content">
    <!-- Overview Tab -->
    <div class="tab-pane fade show active" id="sfOverview">
      <div id="sfOverviewKPIs" class="row g-3 mb-4"></div>
      <div class="row g-3">
        <div class="col-md-7">
          <div class="card bg-dark border-secondary"><div class="card-body">
            <h6 class="card-title text-info"><i class="bi bi-funnel-fill"></i> Pipeline by Stage</h6>
            <div id="sfPipelineStages"></div>
          </div></div>
        </div>
        <div class="col-md-5">
          <div class="card bg-dark border-secondary"><div class="card-body">
            <h6 class="card-title text-info"><i class="bi bi-graph-up-arrow"></i> Monthly Revenue</h6>
            <div id="sfMonthlyRevenue"></div>
          </div></div>
        </div>
      </div>
    </div>

    <!-- Leads Tab -->
    <div class="tab-pane fade" id="sfLeads">
      <div class="d-flex gap-2 mb-3 flex-wrap">
        <select id="sfLeadStatusFilter" class="form-select form-select-sm bg-dark text-light" style="width:200px;" onchange="salesforceLoadLeads()">
          <option value="">All Statuses</option>
          <option value="Open">Open</option>
          <option value="Working">Working</option>
          <option value="Converted">Converted</option>
          <option value="Unqualified">Unqualified</option>
        </select>
        <select id="sfLeadRatingFilter" class="form-select form-select-sm bg-dark text-light" style="width:150px;" onchange="salesforceLoadLeads()">
          <option value="">All Ratings</option>
          <option value="Hot">Hot</option>
          <option value="Warm">Warm</option>
          <option value="Cold">Cold</option>
        </select>
        <button class="btn btn-sm btn-outline-info ms-auto" onclick="salesforceExportCSV('leads')"><i class="bi bi-download"></i> Export CSV</button>
      </div>
      <div class="table-responsive" style="max-height:460px;overflow:auto;">
        <table class="table table-sm table-dark table-hover">
          <thead style="position:sticky;top:0;background:#1a1d21;z-index:2;">
            <tr><th>Name</th><th>Company</th><th>Title</th><th>Status</th><th>Source</th><th>Rating</th><th>Owner</th><th>Country</th><th>Last Activity</th></tr>
          </thead>
          <tbody id="sfLeadsBody"></tbody>
        </table>
      </div>
      <div id="sfLeadsSummary" class="text-muted small mt-2"></div>
    </div>

    <!-- Opportunities Tab -->
    <div class="tab-pane fade" id="sfOpportunities">
      <div class="d-flex gap-2 mb-3 flex-wrap">
        <select id="sfOppStageFilter" class="form-select form-select-sm bg-dark text-light" style="width:220px;" onchange="salesforceLoadOpportunities()">
          <option value="">All Stages</option>
          <option value="Prospecting">Prospecting</option>
          <option value="Qualification">Qualification</option>
          <option value="Needs Analysis">Needs Analysis</option>
          <option value="Value Proposition">Value Proposition</option>
          <option value="Proposal">Proposal/Price Quote</option>
          <option value="Negotiation">Negotiation/Review</option>
          <option value="Closed Won">Closed Won</option>
          <option value="Closed Lost">Closed Lost</option>
        </select>
        <button class="btn btn-sm btn-outline-info ms-auto" onclick="salesforceExportCSV('opportunities')"><i class="bi bi-download"></i> Export CSV</button>
      </div>
      <div class="table-responsive" style="max-height:460px;overflow:auto;">
        <table class="table table-sm table-dark table-hover">
          <thead style="position:sticky;top:0;background:#1a1d21;z-index:2;">
            <tr><th>Name</th><th>Account</th><th>Amount</th><th>Stage</th><th>Probability</th><th>Close Date</th><th>Type</th><th>Forecast</th><th>Owner</th></tr>
          </thead>
          <tbody id="sfOppsBody"></tbody>
        </table>
      </div>
      <div id="sfOppsSummary" class="text-muted small mt-2"></div>
    </div>

    <!-- Accounts Tab -->
    <div class="tab-pane fade" id="sfAccounts">
      <div class="d-flex gap-2 mb-3 flex-wrap">
        <select id="sfAccountTypeFilter" class="form-select form-select-sm bg-dark text-light" style="width:180px;" onchange="salesforceLoadAccounts()">
          <option value="">All Types</option>
          <option value="Customer">Customer</option>
          <option value="Prospect">Prospect</option>
        </select>
        <button class="btn btn-sm btn-outline-info ms-auto" onclick="salesforceExportCSV('accounts')"><i class="bi bi-download"></i> Export CSV</button>
      </div>
      <div class="table-responsive" style="max-height:460px;overflow:auto;">
        <table class="table table-sm table-dark table-hover">
          <thead style="position:sticky;top:0;background:#1a1d21;z-index:2;">
            <tr><th>Name</th><th>Industry</th><th>Revenue</th><th>Employees</th><th>Type</th><th>Rating</th><th>Open Opps</th><th>Total Won</th><th>Owner</th></tr>
          </thead>
          <tbody id="sfAccountsBody"></tbody>
        </table>
      </div>
      <div id="sfAccountsSummary" class="text-muted small mt-2"></div>
    </div>

    <!-- Campaigns Tab -->
    <div class="tab-pane fade" id="sfCampaigns">
      <div class="d-flex gap-2 mb-3 flex-wrap">
        <select id="sfCampaignStatusFilter" class="form-select form-select-sm bg-dark text-light" style="width:180px;" onchange="salesforceLoadCampaigns()">
          <option value="">All Statuses</option>
          <option value="Active">Active</option>
          <option value="Completed">Completed</option>
          <option value="Planned">Planned</option>
        </select>
        <button class="btn btn-sm btn-outline-info ms-auto" onclick="salesforceExportCSV('campaigns')"><i class="bi bi-download"></i> Export CSV</button>
      </div>
      <div class="table-responsive" style="max-height:460px;overflow:auto;">
        <table class="table table-sm table-dark table-hover">
          <thead style="position:sticky;top:0;background:#1a1d21;z-index:2;">
            <tr><th>Name</th><th>Type</th><th>Status</th><th>Budget</th><th>Cost</th><th>Members</th><th>Responses</th><th>Converted</th><th>ROI %</th></tr>
          </thead>
          <tbody id="sfCampaignsBody"></tbody>
        </table>
      </div>
      <div id="sfCampaignsSummary" class="text-muted small mt-2"></div>
    </div>

    <!-- Reports Tab -->
    <div class="tab-pane fade" id="sfReports">
      <div class="d-flex gap-2 mb-3">
        <button class="btn btn-sm" style="background:#00a1e0;color:#fff;" onclick="salesforceGenerateReport()"><i class="bi bi-bar-chart-line"></i> Generate Daily Report</button>
        <button class="btn btn-sm btn-outline-info" onclick="salesforceExportCSV('reports')"><i class="bi bi-download"></i> Export CSV</button>
      </div>
      <div class="table-responsive" style="max-height:460px;overflow:auto;">
        <table class="table table-sm table-dark table-hover">
          <thead style="position:sticky;top:0;background:#1a1d21;z-index:2;">
            <tr><th>Date</th><th>New Leads</th><th>Converted</th><th>Opps Created</th><th>Closed Won</th><th>Revenue</th><th>Pipeline Added</th><th>Activities</th><th>Cases Closed</th></tr>
          </thead>
          <tbody id="sfReportsBody"></tbody>
        </table>
      </div>
      <div id="sfReportsSummary" class="text-muted small mt-2"></div>
    </div>

    <!-- Test API Tab -->
    <div class="tab-pane fade" id="sfTestApi">
      <div class="d-flex gap-2 mb-3">
        <select id="sfApiEndpoint" class="form-select form-select-sm bg-dark text-light" style="width:280px;">
          <option value="leads">SOQL: SELECT FROM Lead</option>
          <option value="opportunities">SOQL: SELECT FROM Opportunity</option>
          <option value="accounts">SOQL: SELECT FROM Account</option>
        </select>
        <button class="btn btn-sm" style="background:#00a1e0;color:#fff;" onclick="salesforceTestApiCall()"><i class="bi bi-send"></i> Test Call</button>
      </div>
      <pre id="sfApiResult" class="bg-dark text-success p-3 rounded" style="max-height:420px;overflow:auto;font-size:.82rem;"></pre>
    </div>

    <!-- Settings Tab -->
    <div class="tab-pane fade" id="sfSettings">
      <div class="row g-3">
        <div class="col-md-6">
          <h6>Instance URL</h6>
          <input type="text" id="sfSettingsInstance" class="form-control bg-dark text-light mb-3" value="https://techstart.my.salesforce.com">
          <h6>API Version</h6>
          <select id="sfSettingsApiVersion" class="form-select bg-dark text-light mb-3">
            <option>v59.0</option><option>v58.0</option><option>v57.0</option>
          </select>
          <h6>Default Owner</h6>
          <input type="text" id="sfSettingsOwner" class="form-control bg-dark text-light" value="James Wilson">
        </div>
        <div class="col-md-6">
          <h6>Objects to Sync</h6>
          <div class="form-check"><input class="form-check-input" type="checkbox" id="sfObjLead" checked><label class="form-check-label small" for="sfObjLead">Leads</label></div>
          <div class="form-check"><input class="form-check-input" type="checkbox" id="sfObjOpp" checked><label class="form-check-label small" for="sfObjOpp">Opportunities</label></div>
          <div class="form-check"><input class="form-check-input" type="checkbox" id="sfObjAccount" checked><label class="form-check-label small" for="sfObjAccount">Accounts</label></div>
          <div class="form-check"><input class="form-check-input" type="checkbox" id="sfObjContact" checked><label class="form-check-label small" for="sfObjContact">Contacts</label></div>
          <div class="form-check"><input class="form-check-input" type="checkbox" id="sfObjCampaign" checked><label class="form-check-label small" for="sfObjCampaign">Campaigns</label></div>
          <div class="form-check"><input class="form-check-input" type="checkbox" id="sfObjCase"><label class="form-check-label small" for="sfObjCase">Cases</label></div>
          <div class="form-check"><input class="form-check-input" type="checkbox" id="sfObjTask"><label class="form-check-label small" for="sfObjTask">Tasks / Activities</label></div>
        </div>
      </div>
      <button class="btn btn-sm mt-3" style="background:#00a1e0;color:#fff;" onclick="salesforceSaveSettings()"><i class="bi bi-save"></i> Save Settings</button>
    </div>
  </div>
</div>
<!-- ═══ END SALESFORCE PANEL ═══ -->

<!-- ═══════════════════════════════════════════════════════════════════════════ -->
<!-- QUICKBOOKS RICH PANEL (Phase 22) -->
<!-- ═══════════════════════════════════════════════════════════════════════════ -->
<div id="quickbooksPanel" style="display:none;" class="p-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0"><i class="bi bi-journal-text" style="color:#2CA01C;"></i> QuickBooks Online</h4>
    <div>
      <button class="btn btn-sm btn-outline-success me-2" id="qbConnectBtn" onclick="quickbooksConnect()"><i class="bi bi-plug"></i> Connect Company</button>
      <button class="btn btn-sm btn-outline-secondary" onclick="closePanel()"><i class="bi bi-x-lg"></i> Close</button>
    </div>
  </div>
  <div id="qbConnectionAlert" class="alert alert-secondary py-2 small" style="display:none;"></div>

  <!-- Company Selector -->
  <div class="mb-3">
    <label class="form-label small text-muted">QuickBooks Company</label>
    <select id="qbCompanySelect" class="form-select form-select-sm bg-dark text-light" style="max-width:400px;" onchange="quickbooksLoadCompany()">
      <option value="">— Select company —</option>
    </select>
  </div>

  <!-- Tabs -->
  <ul class="nav nav-tabs nav-fill mb-3" role="tablist" style="border-bottom-color:#2CA01C;">
    <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#qbOverview">Overview</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#qbInvoices">Invoices</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#qbExpenses">Expenses</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#qbBanking">Banking</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#qbReports">Reports</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#qbTestApi">Test API</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#qbSettings">Settings</a></li>
  </ul>

  <div class="tab-content">
    <!-- Overview Tab -->
    <div class="tab-pane fade show active" id="qbOverview">
      <div id="qbOverviewKPIs" class="row g-3 mb-4"></div>
      <div class="row g-3">
        <div class="col-md-7">
          <div class="card bg-dark border-secondary"><div class="card-body">
            <h6 class="card-title text-success"><i class="bi bi-graph-up"></i> Monthly P&L</h6>
            <div id="qbMonthlyPnl"></div>
          </div></div>
        </div>
        <div class="col-md-5">
          <div class="card bg-dark border-secondary"><div class="card-body">
            <h6 class="card-title text-success"><i class="bi bi-pie-chart-fill"></i> Expense Breakdown</h6>
            <div id="qbExpenseBreakdown"></div>
          </div></div>
        </div>
      </div>
    </div>

    <!-- Invoices Tab -->
    <div class="tab-pane fade" id="qbInvoices">
      <div class="d-flex gap-2 mb-3 flex-wrap">
        <select id="qbInvoiceStatusFilter" class="form-select form-select-sm bg-dark text-light" style="width:180px;" onchange="quickbooksLoadInvoices()">
          <option value="">All Statuses</option>
          <option value="Open">Open</option>
          <option value="Paid">Paid</option>
          <option value="Overdue">Overdue</option>
        </select>
        <button class="btn btn-sm btn-outline-success ms-auto" onclick="quickbooksExportCSV('invoices')"><i class="bi bi-download"></i> Export CSV</button>
      </div>
      <div class="table-responsive" style="max-height:460px;overflow:auto;">
        <table class="table table-sm table-dark table-hover">
          <thead style="position:sticky;top:0;background:#1a1d21;z-index:2;">
            <tr><th>Invoice #</th><th>Customer</th><th>Amount</th><th>Balance</th><th>Status</th><th>Due Date</th><th>Terms</th><th>Items</th></tr>
          </thead>
          <tbody id="qbInvoicesBody"></tbody>
        </table>
      </div>
      <div id="qbInvoicesSummary" class="text-muted small mt-2"></div>
    </div>

    <!-- Expenses Tab -->
    <div class="tab-pane fade" id="qbExpenses">
      <div class="d-flex gap-2 mb-3 flex-wrap">
        <select id="qbExpenseCategoryFilter" class="form-select form-select-sm bg-dark text-light" style="width:200px;" onchange="quickbooksLoadExpenses()">
          <option value="">All Categories</option>
          <option value="Cloud Services">Cloud Services</option>
          <option value="Marketing">Marketing & Ads</option>
          <option value="Office">Office & Rent</option>
          <option value="Software">Software Licenses</option>
          <option value="Professional">Professional Services</option>
        </select>
        <button class="btn btn-sm btn-outline-success ms-auto" onclick="quickbooksExportCSV('expenses')"><i class="bi bi-download"></i> Export CSV</button>
      </div>
      <div class="table-responsive" style="max-height:460px;overflow:auto;">
        <table class="table table-sm table-dark table-hover">
          <thead style="position:sticky;top:0;background:#1a1d21;z-index:2;">
            <tr><th>ID</th><th>Vendor</th><th>Category</th><th>Amount</th><th>Date</th><th>Method</th><th>Status</th><th>Description</th></tr>
          </thead>
          <tbody id="qbExpensesBody"></tbody>
        </table>
      </div>
      <div id="qbExpensesSummary" class="text-muted small mt-2"></div>
    </div>

    <!-- Banking Tab -->
    <div class="tab-pane fade" id="qbBanking">
      <div class="d-flex gap-2 mb-3 flex-wrap">
        <select id="qbBankingTypeFilter" class="form-select form-select-sm bg-dark text-light" style="width:160px;" onchange="quickbooksLoadBanking()">
          <option value="">All Types</option>
          <option value="Credit">Credits</option>
          <option value="Debit">Debits</option>
        </select>
        <button class="btn btn-sm btn-outline-success ms-auto" onclick="quickbooksExportCSV('banking')"><i class="bi bi-download"></i> Export CSV</button>
      </div>
      <div class="table-responsive" style="max-height:460px;overflow:auto;">
        <table class="table table-sm table-dark table-hover">
          <thead style="position:sticky;top:0;background:#1a1d21;z-index:2;">
            <tr><th>Date</th><th>Description</th><th>Amount</th><th>Type</th><th>Account</th><th>Category</th><th>Status</th></tr>
          </thead>
          <tbody id="qbBankingBody"></tbody>
        </table>
      </div>
      <div id="qbBankingSummary" class="text-muted small mt-2"></div>
    </div>

    <!-- Reports Tab -->
    <div class="tab-pane fade" id="qbReports">
      <div class="d-flex gap-2 mb-3">
        <button class="btn btn-sm" style="background:#2CA01C;color:#fff;" onclick="quickbooksGenerateReport()"><i class="bi bi-bar-chart-line"></i> Generate Daily P&L</button>
        <button class="btn btn-sm btn-outline-success" onclick="quickbooksExportCSV('reports')"><i class="bi bi-download"></i> Export CSV</button>
      </div>
      <div class="table-responsive" style="max-height:460px;overflow:auto;">
        <table class="table table-sm table-dark table-hover">
          <thead style="position:sticky;top:0;background:#1a1d21;z-index:2;">
            <tr><th>Date</th><th>Revenue</th><th>COGS</th><th>Gross Profit</th><th>OpEx</th><th>Net Income</th><th>Invoices</th><th>Payments</th><th>Bills Paid</th></tr>
          </thead>
          <tbody id="qbReportsBody"></tbody>
        </table>
      </div>
      <div id="qbReportsSummary" class="text-muted small mt-2"></div>
    </div>

    <!-- Test API Tab -->
    <div class="tab-pane fade" id="qbTestApi">
      <div class="d-flex gap-2 mb-3">
        <select id="qbApiEndpoint" class="form-select form-select-sm bg-dark text-light" style="width:280px;">
          <option value="invoices">GET /v3/company/{id}/query?query=SELECT * FROM Invoice</option>
          <option value="expenses">GET /v3/company/{id}/query?query=SELECT * FROM Purchase</option>
          <option value="pnl">GET /v3/company/{id}/reports/ProfitAndLoss</option>
        </select>
        <button class="btn btn-sm" style="background:#2CA01C;color:#fff;" onclick="quickbooksTestApiCall()"><i class="bi bi-send"></i> Test Call</button>
      </div>
      <pre id="qbApiResult" class="bg-dark text-success p-3 rounded" style="max-height:420px;overflow:auto;font-size:.82rem;"></pre>
    </div>

    <!-- Settings Tab -->
    <div class="tab-pane fade" id="qbSettings">
      <div class="row g-3">
        <div class="col-md-6">
          <h6>Company Name</h6>
          <input type="text" id="qbSettingsCompany" class="form-control bg-dark text-light mb-3" value="TechStart Agency">
          <h6>Fiscal Year Start</h6>
          <select id="qbSettingsFiscalYear" class="form-select bg-dark text-light mb-3">
            <option>January</option><option>April</option><option>July</option><option>October</option>
          </select>
          <h6>Default Tax Rate (%)</h6>
          <input type="number" id="qbSettingsTaxRate" class="form-control bg-dark text-light" value="19">
        </div>
        <div class="col-md-6">
          <h6>Modules to Sync</h6>
          <div class="form-check"><input class="form-check-input" type="checkbox" id="qbModInvoices" checked><label class="form-check-label small" for="qbModInvoices">Invoices</label></div>
          <div class="form-check"><input class="form-check-input" type="checkbox" id="qbModExpenses" checked><label class="form-check-label small" for="qbModExpenses">Expenses</label></div>
          <div class="form-check"><input class="form-check-input" type="checkbox" id="qbModBanking" checked><label class="form-check-label small" for="qbModBanking">Bank Feeds</label></div>
          <div class="form-check"><input class="form-check-input" type="checkbox" id="qbModPayroll"><label class="form-check-label small" for="qbModPayroll">Payroll</label></div>
          <div class="form-check"><input class="form-check-input" type="checkbox" id="qbModInventory"><label class="form-check-label small" for="qbModInventory">Inventory</label></div>
          <div class="form-check"><input class="form-check-input" type="checkbox" id="qbModReports" checked><label class="form-check-label small" for="qbModReports">Financial Reports</label></div>
          <div class="form-check"><input class="form-check-input" type="checkbox" id="qbModTax" checked><label class="form-check-label small" for="qbModTax">Tax / VAT</label></div>
        </div>
      </div>
      <button class="btn btn-sm mt-3" style="background:#2CA01C;color:#fff;" onclick="quickbooksSaveSettings()"><i class="bi bi-save"></i> Save Settings</button>
    </div>
  </div>
</div>
<!-- ═══ END QUICKBOOKS PANEL ═══ -->

<!-- ═══════════════════════════════════════════════════════════════════════════ -->
<!-- MAILCHIMP PANEL — Email Marketing & Automation                            -->
<!-- ═══════════════════════════════════════════════════════════════════════════ -->
<div id="mailchimpPanel" style="display:none;" class="p-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div class="d-flex align-items-center gap-2">
      <i class="bi bi-envelope-paper-fill" style="font-size:1.7rem;color:#FFE01B;"></i>
      <h4 class="mb-0" style="color:#FFE01B;">Mailchimp</h4>
      <span id="mcConnBadge" class="badge bg-secondary ms-2">Disconnected</span>
    </div>
    <div class="d-flex gap-2">
      <button id="mcConnectBtn" class="btn btn-sm" style="background:#FFE01B;color:#241C15;" onclick="mailchimpToggleConnect()">Connect</button>
      <button class="btn btn-sm btn-outline-secondary" onclick="closePanel()"><i class="bi bi-x-lg"></i></button>
    </div>
  </div>

  <!-- Audience Selector -->
  <div class="mb-3">
    <label class="form-label text-muted small">Audience / List</label>
    <select id="mcAudienceSelect" class="form-select form-select-sm bg-dark text-light border-secondary" onchange="mailchimpLoadOverview()">
      <option value="all">All Audiences</option>
    </select>
  </div>

  <!-- Tabs -->
  <ul class="nav nav-tabs mb-3" role="tablist" style="border-color:#FFE01B;">
    <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#mcOverview" style="color:#FFE01B;">Overview</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#mcCampaigns" onclick="mailchimpLoadCampaigns()">Campaigns</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#mcAutomations" onclick="mailchimpLoadAutomations()">Automations</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#mcSegments" onclick="mailchimpLoadSegments()">Segments</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#mcReports" onclick="mailchimpLoadReports()">Reports</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#mcTestApi">Test API</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#mcSettings">Settings</a></li>
  </ul>

  <div class="tab-content">
    <!-- Overview Tab -->
    <div class="tab-pane fade show active" id="mcOverview">
      <div id="mcKpiRow" class="row g-2 mb-3"></div>
      <h6 class="text-muted mt-3">Monthly Performance Trend</h6>
      <div class="table-responsive">
        <table class="table table-sm table-dark table-striped">
          <thead><tr><th>Month</th><th>Sent</th><th>Opens</th><th>Clicks</th><th>Revenue</th></tr></thead>
          <tbody id="mcTrendBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Campaigns Tab -->
    <div class="tab-pane fade" id="mcCampaigns">
      <div class="d-flex gap-2 mb-2 flex-wrap">
        <select id="mcCampStatus" class="form-select form-select-sm bg-dark text-light border-secondary" style="width:140px;" onchange="mailchimpLoadCampaigns()">
          <option value="all">All Status</option><option value="sent">Sent</option><option value="draft">Draft</option><option value="scheduled">Scheduled</option>
        </select>
        <select id="mcCampType" class="form-select form-select-sm bg-dark text-light border-secondary" style="width:140px;" onchange="mailchimpLoadCampaigns()">
          <option value="all">All Types</option><option value="regular">Regular</option><option value="plaintext">Plaintext</option>
        </select>
        <select id="mcCampAudience" class="form-select form-select-sm bg-dark text-light border-secondary" style="width:180px;" onchange="mailchimpLoadCampaigns()">
          <option value="all">All Audiences</option>
        </select>
        <button class="btn btn-sm btn-outline-light ms-auto" onclick="mailchimpExportCampaigns()"><i class="bi bi-download"></i> CSV</button>
      </div>
      <div class="table-responsive">
        <table class="table table-sm table-dark table-striped">
          <thead><tr><th>Subject</th><th>Type</th><th>Status</th><th>Audience</th><th>Recipients</th><th>Opens</th><th>Clicks</th><th>Revenue</th><th>Send Time</th></tr></thead>
          <tbody id="mcCampaignsBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Automations Tab -->
    <div class="tab-pane fade" id="mcAutomations">
      <div class="d-flex gap-2 mb-2 flex-wrap">
        <select id="mcAutoStatus" class="form-select form-select-sm bg-dark text-light border-secondary" style="width:140px;" onchange="mailchimpLoadAutomations()">
          <option value="all">All Status</option><option value="active">Active</option><option value="paused">Paused</option>
        </select>
        <select id="mcAutoAudience" class="form-select form-select-sm bg-dark text-light border-secondary" style="width:180px;" onchange="mailchimpLoadAutomations()">
          <option value="all">All Audiences</option>
        </select>
        <button class="btn btn-sm btn-outline-light ms-auto" onclick="mailchimpExportAutomations()"><i class="bi bi-download"></i> CSV</button>
      </div>
      <div class="table-responsive">
        <table class="table table-sm table-dark table-striped">
          <thead><tr><th>Name</th><th>Trigger</th><th>Status</th><th>Audience</th><th>Emails</th><th>Sent</th><th>Open Rate</th><th>Click Rate</th></tr></thead>
          <tbody id="mcAutomationsBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Segments Tab -->
    <div class="tab-pane fade" id="mcSegments">
      <div class="d-flex gap-2 mb-2">
        <select id="mcSegAudience" class="form-select form-select-sm bg-dark text-light border-secondary" style="width:180px;" onchange="mailchimpLoadSegments()">
          <option value="all">All Audiences</option>
        </select>
        <button class="btn btn-sm btn-outline-light ms-auto" onclick="mailchimpExportSegments()"><i class="bi bi-download"></i> CSV</button>
      </div>
      <div class="table-responsive">
        <table class="table table-sm table-dark table-striped">
          <thead><tr><th>Name</th><th>Audience</th><th>Members</th><th>Conditions</th></tr></thead>
          <tbody id="mcSegmentsBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Reports Tab -->
    <div class="tab-pane fade" id="mcReports">
      <div class="d-flex justify-content-between mb-2">
        <span class="text-muted small">Unified report — Campaigns + Automations + Segments</span>
        <button class="btn btn-sm btn-outline-light" onclick="mailchimpExportReports()"><i class="bi bi-download"></i> CSV</button>
      </div>
      <div class="table-responsive" style="max-height:420px;overflow-y:auto;">
        <table class="table table-sm table-dark table-striped">
          <thead style="position:sticky;top:0;z-index:1;"><tr><th>Type</th><th>Name</th><th>Status</th><th>Audience</th><th>Recipients</th><th>Open Rate</th><th>Click Rate</th><th>Revenue</th></tr></thead>
          <tbody id="mcReportsBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Test API Tab -->
    <div class="tab-pane fade" id="mcTestApi">
      <div class="d-flex gap-2 mb-2">
        <select id="mcTestEndpoint" class="form-select form-select-sm bg-dark text-light border-secondary" style="width:200px;">
          <option value="campaigns">GET /3.0/campaigns</option>
          <option value="lists">GET /3.0/lists</option>
          <option value="automations">GET /3.0/automations</option>
        </select>
        <button class="btn btn-sm" style="background:#FFE01B;color:#241C15;" onclick="mailchimpTestApiCall()"><i class="bi bi-play-fill"></i> Send</button>
      </div>
      <pre id="mcTestResult" class="bg-dark text-light p-2 rounded" style="max-height:340px;overflow:auto;font-size:.78rem;">Select an endpoint and click Send.</pre>
    </div>

    <!-- Settings Tab -->
    <div class="tab-pane fade" id="mcSettings">
      <h6 class="text-muted">Mailchimp Configuration</h6>
      <div class="mb-2">
        <label class="form-label small text-light">API Key</label>
        <input id="mcSettingsApiKey" class="form-control form-control-sm bg-dark text-light border-secondary" placeholder="xxxxxxxxxxxxxxxx-us1">
      </div>
      <div class="mb-2">
        <label class="form-label small text-light">Server Prefix</label>
        <input id="mcSettingsServer" class="form-control form-control-sm bg-dark text-light border-secondary" value="us1" placeholder="us1">
      </div>
      <div class="mb-2">
        <label class="form-label small text-light">Default Audience</label>
        <select id="mcSettingsAudience" class="form-select form-select-sm bg-dark text-light border-secondary">
          <option value="">Auto-detect</option>
        </select>
      </div>
      <div class="mb-2">
        <label class="form-label small text-light">Sync Frequency</label>
        <select id="mcSettingsSync" class="form-select form-select-sm bg-dark text-light border-secondary">
          <option value="realtime">Real-time</option><option value="hourly" selected>Hourly</option><option value="daily">Daily</option>
        </select>
      </div>
      <button class="btn btn-sm mt-3" style="background:#FFE01B;color:#241C15;" onclick="mailchimpSaveSettings()"><i class="bi bi-save"></i> Save Settings</button>
    </div>
  </div>
</div>
<!-- ═══ END MAILCHIMP PANEL ═══ -->

<!-- ═══════════════════════════════════════════════════════════════════════════ -->
<!-- PAYPAL PANEL — Payments, Payouts & Disputes                               -->
<!-- ═══════════════════════════════════════════════════════════════════════════ -->
<div id="paypalPanel" style="display:none;" class="p-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div class="d-flex align-items-center gap-2">
      <i class="bi bi-paypal" style="font-size:1.7rem;color:#003087;"></i>
      <h4 class="mb-0" style="color:#0070BA;">PayPal</h4>
      <span id="ppConnBadge" class="badge bg-secondary ms-2">Disconnected</span>
    </div>
    <div class="d-flex gap-2">
      <button id="ppConnectBtn" class="btn btn-sm" style="background:#0070BA;color:#fff;" onclick="paypalToggleConnect()">Connect</button>
      <button class="btn btn-sm btn-outline-secondary" onclick="closePanel()"><i class="bi bi-x-lg"></i></button>
    </div>
  </div>

  <!-- Account Selector -->
  <div class="mb-3">
    <label class="form-label text-muted small">Business Account</label>
    <select id="ppAccountSelect" class="form-select form-select-sm bg-dark text-light border-secondary" onchange="paypalLoadOverview()">
      <option value="all">All Accounts</option>
    </select>
  </div>

  <!-- Tabs -->
  <ul class="nav nav-tabs mb-3" role="tablist" style="border-color:#0070BA;">
    <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#ppOverview" style="color:#0070BA;">Overview</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#ppTransactions" onclick="paypalLoadTransactions()">Transactions</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#ppPayouts" onclick="paypalLoadPayouts()">Payouts</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#ppDisputes" onclick="paypalLoadDisputes()">Disputes</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#ppReports" onclick="paypalLoadReports()">Reports</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#ppTestApi">Test API</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#ppSettings">Settings</a></li>
  </ul>

  <div class="tab-content">
    <!-- Overview Tab -->
    <div class="tab-pane fade show active" id="ppOverview">
      <div id="ppKpiRow" class="row g-2 mb-3"></div>
      <h6 class="text-muted mt-3">Monthly Performance Trend</h6>
      <div class="table-responsive">
        <table class="table table-sm table-dark table-striped">
          <thead><tr><th>Month</th><th>Payments</th><th>Revenue</th><th>Fees</th><th>Payouts</th><th>Disputes</th></tr></thead>
          <tbody id="ppTrendBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Transactions Tab -->
    <div class="tab-pane fade" id="ppTransactions">
      <div class="d-flex gap-2 mb-2 flex-wrap">
        <select id="ppTxnStatus" class="form-select form-select-sm bg-dark text-light border-secondary" style="width:150px;" onchange="paypalLoadTransactions()">
          <option value="all">All Status</option><option value="completed">Completed</option><option value="pending">Pending</option><option value="denied">Denied</option>
        </select>
        <select id="ppTxnType" class="form-select form-select-sm bg-dark text-light border-secondary" style="width:140px;" onchange="paypalLoadTransactions()">
          <option value="all">All Types</option><option value="sale">Sale</option><option value="refund">Refund</option><option value="payout">Payout</option>
        </select>
        <button class="btn btn-sm btn-outline-light ms-auto" onclick="paypalExportTransactions()"><i class="bi bi-download"></i> CSV</button>
      </div>
      <div class="table-responsive">
        <table class="table table-sm table-dark table-striped">
          <thead><tr><th>ID</th><th>Type</th><th>Status</th><th>Amount</th><th>Fee</th><th>Net</th><th>Payer</th><th>Description</th><th>Date</th></tr></thead>
          <tbody id="ppTransactionsBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Payouts Tab -->
    <div class="tab-pane fade" id="ppPayouts">
      <div class="d-flex gap-2 mb-2">
        <select id="ppPayoutStatus" class="form-select form-select-sm bg-dark text-light border-secondary" style="width:150px;" onchange="paypalLoadPayouts()">
          <option value="all">All Status</option><option value="completed">Completed</option><option value="pending">Pending</option>
        </select>
        <button class="btn btn-sm btn-outline-light ms-auto" onclick="paypalExportPayouts()"><i class="bi bi-download"></i> CSV</button>
      </div>
      <div class="table-responsive">
        <table class="table table-sm table-dark table-striped">
          <thead><tr><th>ID</th><th>Amount</th><th>Fee</th><th>Currency</th><th>Status</th><th>Bank</th><th>Batch</th><th>Date</th></tr></thead>
          <tbody id="ppPayoutsBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Disputes Tab -->
    <div class="tab-pane fade" id="ppDisputes">
      <div class="d-flex gap-2 mb-2 flex-wrap">
        <select id="ppDisputeStatus" class="form-select form-select-sm bg-dark text-light border-secondary" style="width:160px;" onchange="paypalLoadDisputes()">
          <option value="all">All Status</option><option value="open">Open</option><option value="under_review">Under Review</option><option value="resolved_buyer">Resolved (Buyer)</option><option value="resolved_seller">Resolved (Seller)</option>
        </select>
        <select id="ppDisputeReason" class="form-select form-select-sm bg-dark text-light border-secondary" style="width:200px;" onchange="paypalLoadDisputes()">
          <option value="all">All Reasons</option><option value="ITEM_NOT_RECEIVED">Item Not Received</option><option value="NOT_AS_DESCRIBED">Not As Described</option><option value="UNAUTHORISED">Unauthorised</option><option value="DUPLICATE_TRANSACTION">Duplicate</option>
        </select>
        <button class="btn btn-sm btn-outline-light ms-auto" onclick="paypalExportDisputes()"><i class="bi bi-download"></i> CSV</button>
      </div>
      <div class="table-responsive">
        <table class="table table-sm table-dark table-striped">
          <thead><tr><th>ID</th><th>Reason</th><th>Status</th><th>Amount</th><th>Buyer</th><th>Transaction</th><th>Created</th><th>Respond By</th></tr></thead>
          <tbody id="ppDisputesBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Reports Tab -->
    <div class="tab-pane fade" id="ppReports">
      <div class="d-flex justify-content-between mb-2">
        <span class="text-muted small">Unified report — Transactions + Payouts + Disputes</span>
        <button class="btn btn-sm btn-outline-light" onclick="paypalExportReports()"><i class="bi bi-download"></i> CSV</button>
      </div>
      <div class="table-responsive" style="max-height:420px;overflow-y:auto;">
        <table class="table table-sm table-dark table-striped">
          <thead style="position:sticky;top:0;z-index:1;"><tr><th>Type</th><th>Name</th><th>Status</th><th>Amount</th><th>Fee</th><th>Net</th><th>Currency</th><th>Counterparty</th><th>Date</th></tr></thead>
          <tbody id="ppReportsBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Test API Tab -->
    <div class="tab-pane fade" id="ppTestApi">
      <div class="d-flex gap-2 mb-2">
        <select id="ppTestEndpoint" class="form-select form-select-sm bg-dark text-light border-secondary" style="width:240px;">
          <option value="payments">GET /v1/reporting/payments</option>
          <option value="payouts">GET /v1/reporting/payouts</option>
          <option value="disputes">GET /v1/reporting/disputes</option>
        </select>
        <button class="btn btn-sm" style="background:#0070BA;color:#fff;" onclick="paypalTestApiCall()"><i class="bi bi-play-fill"></i> Send</button>
      </div>
      <pre id="ppTestResult" class="bg-dark text-light p-2 rounded" style="max-height:340px;overflow:auto;font-size:.78rem;">Select an endpoint and click Send.</pre>
    </div>

    <!-- Settings Tab -->
    <div class="tab-pane fade" id="ppSettings">
      <h6 class="text-muted">PayPal Configuration</h6>
      <div class="mb-2">
        <label class="form-label small text-light">Client ID</label>
        <input id="ppSettingsClientId" class="form-control form-control-sm bg-dark text-light border-secondary" placeholder="AaBbCcDdEeFf...">
      </div>
      <div class="mb-2">
        <label class="form-label small text-light">Client Secret</label>
        <input id="ppSettingsSecret" type="password" class="form-control form-control-sm bg-dark text-light border-secondary" placeholder="••••••••">
      </div>
      <div class="mb-2">
        <label class="form-label small text-light">Environment</label>
        <select id="ppSettingsEnv" class="form-select form-select-sm bg-dark text-light border-secondary">
          <option value="sandbox">Sandbox</option><option value="live" selected>Live</option>
        </select>
      </div>
      <div class="mb-2">
        <label class="form-label small text-light">Default Currency</label>
        <select id="ppSettingsCurrency" class="form-select form-select-sm bg-dark text-light border-secondary">
          <option value="USD" selected>USD</option><option value="EUR">EUR</option><option value="GBP">GBP</option>
        </select>
      </div>
      <div class="mb-2">
        <label class="form-label small text-light">Webhook URL</label>
        <input id="ppSettingsWebhook" class="form-control form-control-sm bg-dark text-light border-secondary" value="https://camarad.ai/webhooks/paypal" readonly>
      </div>
      <button class="btn btn-sm mt-3" style="background:#0070BA;color:#fff;" onclick="paypalSaveSettings()"><i class="bi bi-save"></i> Save Settings</button>
    </div>
  </div>
</div>
<!-- ═══ END PAYPAL PANEL ═══ -->

<!-- ═══════════════════════════════════════════════════════════════════════════ -->
<!-- ═══ NOTION PANEL ═══ -->
<!-- ═══════════════════════════════════════════════════════════════════════════ -->
<div id="notionPanel" style="display:none;">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h5 class="mb-0"><i class="bi bi-journal-text" style="color:#000;background:#fff;padding:2px 6px;border-radius:4px;"></i> Notion</h5>
    <button class="btn btn-sm btn-outline-secondary" onclick="closePanel()"><i class="bi bi-arrow-left"></i> Back</button>
  </div>

  <!-- Notion Tabs -->
  <ul class="nav nav-tabs mb-3" style="border-bottom-color:#444;">
    <li class="nav-item"><a class="nav-link active bg-dark text-light border-secondary" data-bs-toggle="tab" href="#notionOverview">Overview</a></li>
    <li class="nav-item"><a class="nav-link bg-dark text-light border-secondary" data-bs-toggle="tab" href="#notionPages">Pages</a></li>
    <li class="nav-item"><a class="nav-link bg-dark text-light border-secondary" data-bs-toggle="tab" href="#notionDatabases">Databases</a></li>
    <li class="nav-item"><a class="nav-link bg-dark text-light border-secondary" data-bs-toggle="tab" href="#notionBlocks">Blocks</a></li>
    <li class="nav-item"><a class="nav-link bg-dark text-light border-secondary" data-bs-toggle="tab" href="#notionCollaborators">Collaborators</a></li>
    <li class="nav-item"><a class="nav-link bg-dark text-light border-secondary" data-bs-toggle="tab" href="#notionReports">Reports</a></li>
    <li class="nav-item"><a class="nav-link bg-dark text-light border-secondary" data-bs-toggle="tab" href="#notionTestApi">Test API</a></li>
    <li class="nav-item"><a class="nav-link bg-dark text-light border-secondary" data-bs-toggle="tab" href="#notionSettings">Settings</a></li>
  </ul>

  <div class="tab-content">
    <!-- ── OVERVIEW TAB ── -->
    <div class="tab-pane fade show active" id="notionOverview">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <label class="form-label small text-light mb-1">Workspace</label>
          <select id="notionWorkspaceFilter" class="form-select form-select-sm bg-dark text-light border-secondary" style="width:240px;" onchange="notionLoadOverview()">
            <option value="all">All Workspaces</option>
          </select>
        </div>
        <button class="btn btn-sm" style="background:#000;color:#fff;border:1px solid #555;" onclick="notionLoadOverview()"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
      </div>
      <div id="notionOverviewKPIs" class="row g-3 mb-4"></div>
      <div id="notionOverviewChart"></div>
    </div>

    <!-- ── PAGES TAB ── -->
    <div class="tab-pane fade" id="notionPages">
      <div class="d-flex gap-2 mb-3 flex-wrap align-items-end">
        <div>
          <label class="form-label small text-light mb-1">Status</label>
          <select id="notionPagesStatus" class="form-select form-select-sm bg-dark text-light border-secondary" onchange="notionLoadPages()">
            <option value="">All</option>
            <option value="shared">Shared</option>
            <option value="private">Private</option>
          </select>
        </div>
        <div>
          <label class="form-label small text-light mb-1">Workspace</label>
          <select id="notionPagesWorkspace" class="form-select form-select-sm bg-dark text-light border-secondary" onchange="notionLoadPages()">
            <option value="">All</option>
            <option value="TechStart Team">TechStart Team</option>
            <option value="Personal Journal">Personal Journal</option>
            <option value="Project Wiki">Project Wiki</option>
          </select>
        </div>
        <button class="btn btn-sm btn-outline-light" onclick="notionExportPages()"><i class="bi bi-download"></i> CSV</button>
      </div>
      <div id="notionPagesTable"></div>
    </div>

    <!-- ── DATABASES TAB ── -->
    <div class="tab-pane fade" id="notionDatabases">
      <div class="d-flex gap-2 mb-3 flex-wrap align-items-end">
        <div>
          <label class="form-label small text-light mb-1">Type</label>
          <select id="notionDbType" class="form-select form-select-sm bg-dark text-light border-secondary" onchange="notionLoadDatabases()">
            <option value="">All</option>
            <option value="kanban">Kanban</option>
            <option value="table">Table</option>
            <option value="board">Board</option>
            <option value="calendar">Calendar</option>
            <option value="list">List</option>
            <option value="gallery">Gallery</option>
          </select>
        </div>
        <button class="btn btn-sm btn-outline-light" onclick="notionExportDatabases()"><i class="bi bi-download"></i> CSV</button>
      </div>
      <div id="notionDbTable"></div>
    </div>

    <!-- ── BLOCKS TAB ── -->
    <div class="tab-pane fade" id="notionBlocks">
      <div class="d-flex gap-2 mb-3 flex-wrap align-items-end">
        <div>
          <label class="form-label small text-light mb-1">Type</label>
          <select id="notionBlockType" class="form-select form-select-sm bg-dark text-light border-secondary" onchange="notionLoadBlocks()">
            <option value="">All</option>
            <option value="heading_1">Heading 1</option>
            <option value="heading_2">Heading 2</option>
            <option value="heading_3">Heading 3</option>
            <option value="paragraph">Paragraph</option>
            <option value="to_do">To-Do</option>
            <option value="callout">Callout</option>
            <option value="code">Code</option>
            <option value="quote">Quote</option>
            <option value="toggle">Toggle</option>
          </select>
        </div>
        <div>
          <label class="form-label small text-light mb-1">Search</label>
          <input id="notionBlockSearch" class="form-control form-control-sm bg-dark text-light border-secondary" placeholder="Search blocks…" style="width:200px;" onkeyup="notionLoadBlocks()">
        </div>
        <button class="btn btn-sm btn-outline-light" onclick="notionExportBlocks()"><i class="bi bi-download"></i> CSV</button>
      </div>
      <div id="notionBlocksTable"></div>
    </div>

    <!-- ── COLLABORATORS TAB ── -->
    <div class="tab-pane fade" id="notionCollaborators">
      <div class="d-flex gap-2 mb-3 flex-wrap align-items-end">
        <div>
          <label class="form-label small text-light mb-1">Role</label>
          <select id="notionCollabRole" class="form-select form-select-sm bg-dark text-light border-secondary" onchange="notionLoadCollaborators()">
            <option value="">All</option>
            <option value="Admin">Admin</option>
            <option value="Member">Member</option>
            <option value="Guest">Guest</option>
          </select>
        </div>
        <button class="btn btn-sm btn-outline-light" onclick="notionExportCollaborators()"><i class="bi bi-download"></i> CSV</button>
      </div>
      <div id="notionCollabTable"></div>
    </div>

    <!-- ── REPORTS TAB ── -->
    <div class="tab-pane fade" id="notionReports">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h6 class="mb-0 text-light">Unified Activity Report</h6>
        <button class="btn btn-sm btn-outline-light" onclick="notionExportReports()"><i class="bi bi-download"></i> CSV</button>
      </div>
      <div id="notionReportsTable"></div>
    </div>

    <!-- ── TEST API TAB ── -->
    <div class="tab-pane fade" id="notionTestApi">
      <h6 class="text-light mb-3">Simulate Notion API Calls</h6>
      <div class="d-flex gap-2 mb-3 flex-wrap">
        <button class="btn btn-sm" style="background:#000;color:#fff;border:1px solid #555;" onclick="notionTestApiCall('pages')"><i class="bi bi-file-earmark"></i> GET /v1/pages</button>
        <button class="btn btn-sm" style="background:#000;color:#fff;border:1px solid #555;" onclick="notionTestApiCall('databases')"><i class="bi bi-table"></i> GET /v1/databases</button>
        <button class="btn btn-sm" style="background:#000;color:#fff;border:1px solid #555;" onclick="notionTestApiCall('blocks')"><i class="bi bi-puzzle"></i> GET /v1/blocks</button>
      </div>
      <pre id="notionTestResult" class="bg-dark text-success p-3 rounded border border-secondary" style="max-height:350px;overflow:auto;font-size:.82rem;">Click a button above to test…</pre>
    </div>

    <!-- ── SETTINGS TAB ── -->
    <div class="tab-pane fade" id="notionSettings">
      <h6 class="text-light mb-3">Notion Integration Settings</h6>
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label small text-light">Internal Integration Token</label>
          <input id="ntSettingsToken" class="form-control form-control-sm bg-dark text-light border-secondary" value="secret_abc123xyz456…" type="password">
        </div>
        <div class="col-md-6">
          <label class="form-label small text-light">Notion API Version</label>
          <select id="ntSettingsVersion" class="form-select form-select-sm bg-dark text-light border-secondary">
            <option selected>2022-06-28</option>
            <option>2022-02-22</option>
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label small text-light">Default Workspace</label>
          <select id="ntSettingsWorkspace" class="form-select form-select-sm bg-dark text-light border-secondary">
            <option>TechStart Team</option>
            <option>Personal Journal</option>
            <option>Project Wiki</option>
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label small text-light">Sync Frequency</label>
          <select id="ntSettingsSync" class="form-select form-select-sm bg-dark text-light border-secondary">
            <option>Every 15 minutes</option>
            <option selected>Every hour</option>
            <option>Every 6 hours</option>
            <option>Daily</option>
          </select>
        </div>
      </div>
      <div class="mt-3">
        <label class="form-label small text-light">Webhook URL</label>
        <input id="ntSettingsWebhook" class="form-control form-control-sm bg-dark text-light border-secondary" value="https://camarad.ai/webhooks/notion" readonly>
      </div>
      <button class="btn btn-sm mt-3" style="background:#000;color:#fff;border:1px solid #555;" onclick="notionSaveSettings()"><i class="bi bi-save"></i> Save Settings</button>
    </div>
  </div>
</div>
<!-- ═══ END NOTION PANEL ═══ -->

<!-- ═══════════════════════════════════════════════════════════════════════════ -->
<!-- ═══ GITHUB PANEL ═══ -->
<!-- ═══════════════════════════════════════════════════════════════════════════ -->
<div id="githubPanel" style="display:none;">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h5 class="mb-0"><i class="bi bi-github" style="color:#fff;font-size:1.3rem;"></i> GitHub</h5>
    <button class="btn btn-sm btn-outline-secondary" onclick="closePanel()"><i class="bi bi-arrow-left"></i> Back</button>
  </div>

  <!-- GitHub Tabs -->
  <ul class="nav nav-tabs mb-3" style="border-bottom-color:#444;">
    <li class="nav-item"><a class="nav-link active bg-dark text-light border-secondary" data-bs-toggle="tab" href="#ghOverview">Overview</a></li>
    <li class="nav-item"><a class="nav-link bg-dark text-light border-secondary" data-bs-toggle="tab" href="#ghRepos">Repositories</a></li>
    <li class="nav-item"><a class="nav-link bg-dark text-light border-secondary" data-bs-toggle="tab" href="#ghCommits">Commits</a></li>
    <li class="nav-item"><a class="nav-link bg-dark text-light border-secondary" data-bs-toggle="tab" href="#ghIssues">Issues & PRs</a></li>
    <li class="nav-item"><a class="nav-link bg-dark text-light border-secondary" data-bs-toggle="tab" href="#ghActions">Actions</a></li>
    <li class="nav-item"><a class="nav-link bg-dark text-light border-secondary" data-bs-toggle="tab" href="#ghReports">Reports</a></li>
    <li class="nav-item"><a class="nav-link bg-dark text-light border-secondary" data-bs-toggle="tab" href="#ghTestApi">Test API</a></li>
    <li class="nav-item"><a class="nav-link bg-dark text-light border-secondary" data-bs-toggle="tab" href="#ghSettings">Settings</a></li>
  </ul>

  <div class="tab-content">
    <!-- ── OVERVIEW TAB ── -->
    <div class="tab-pane fade show active" id="ghOverview">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <label class="form-label small text-light mb-1">Account / Org</label>
          <select id="ghAccountFilter" class="form-select form-select-sm bg-dark text-light border-secondary" style="width:240px;" onchange="ghLoadOverview()">
            <option value="all">All Accounts</option>
          </select>
        </div>
        <button class="btn btn-sm" style="background:#238636;color:#fff;" onclick="ghLoadOverview()"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
      </div>
      <div id="ghOverviewKPIs" class="row g-3 mb-4"></div>
      <div id="ghOverviewChart"></div>
    </div>

    <!-- ── REPOSITORIES TAB ── -->
    <div class="tab-pane fade" id="ghRepos">
      <div class="d-flex gap-2 mb-3 flex-wrap align-items-end">
        <div>
          <label class="form-label small text-light mb-1">Visibility</label>
          <select id="ghRepoVisibility" class="form-select form-select-sm bg-dark text-light border-secondary" onchange="ghLoadRepos()">
            <option value="">All</option>
            <option value="public">Public</option>
            <option value="private">Private</option>
          </select>
        </div>
        <div>
          <label class="form-label small text-light mb-1">Language</label>
          <select id="ghRepoLanguage" class="form-select form-select-sm bg-dark text-light border-secondary" onchange="ghLoadRepos()">
            <option value="">All</option>
            <option value="Python">Python</option>
            <option value="TypeScript">TypeScript</option>
            <option value="Go">Go</option>
            <option value="Rust">Rust</option>
            <option value="Dart">Dart</option>
            <option value="HCL">HCL</option>
            <option value="YAML">YAML</option>
            <option value="SQL">SQL</option>
            <option value="Shell">Shell</option>
            <option value="MDX">MDX</option>
          </select>
        </div>
        <button class="btn btn-sm btn-outline-light" onclick="ghExportRepos()"><i class="bi bi-download"></i> CSV</button>
      </div>
      <div id="ghReposTable"></div>
    </div>

    <!-- ── COMMITS TAB ── -->
    <div class="tab-pane fade" id="ghCommits">
      <div class="d-flex gap-2 mb-3 flex-wrap align-items-end">
        <div>
          <label class="form-label small text-light mb-1">Repository</label>
          <select id="ghCommitRepo" class="form-select form-select-sm bg-dark text-light border-secondary" onchange="ghLoadCommits()">
            <option value="">All Repos</option>
          </select>
        </div>
        <div>
          <label class="form-label small text-light mb-1">Author</label>
          <select id="ghCommitAuthor" class="form-select form-select-sm bg-dark text-light border-secondary" onchange="ghLoadCommits()">
            <option value="">All Authors</option>
          </select>
        </div>
        <button class="btn btn-sm btn-outline-light" onclick="ghExportCommits()"><i class="bi bi-download"></i> CSV</button>
      </div>
      <div id="ghCommitsTable"></div>
    </div>

    <!-- ── ISSUES & PRs TAB ── -->
    <div class="tab-pane fade" id="ghIssues">
      <div class="d-flex gap-2 mb-3 flex-wrap align-items-end">
        <div>
          <label class="form-label small text-light mb-1">State</label>
          <select id="ghIssueState" class="form-select form-select-sm bg-dark text-light border-secondary" onchange="ghLoadIssues()">
            <option value="">All</option>
            <option value="open">Open</option>
            <option value="closed">Closed</option>
          </select>
        </div>
        <div>
          <label class="form-label small text-light mb-1">Type</label>
          <select id="ghIssueKind" class="form-select form-select-sm bg-dark text-light border-secondary" onchange="ghLoadIssues()">
            <option value="">All</option>
            <option value="issue">Issues</option>
            <option value="pr">Pull Requests</option>
          </select>
        </div>
        <button class="btn btn-sm btn-outline-light" onclick="ghExportIssues()"><i class="bi bi-download"></i> CSV</button>
      </div>
      <div id="ghIssuesTable"></div>
    </div>

    <!-- ── ACTIONS TAB ── -->
    <div class="tab-pane fade" id="ghActions">
      <div class="d-flex gap-2 mb-3 flex-wrap align-items-end">
        <div>
          <label class="form-label small text-light mb-1">Conclusion</label>
          <select id="ghActionConclusion" class="form-select form-select-sm bg-dark text-light border-secondary" onchange="ghLoadActions()">
            <option value="">All</option>
            <option value="success">Success</option>
            <option value="failure">Failure</option>
            <option value="cancelled">Cancelled</option>
          </select>
        </div>
        <div>
          <label class="form-label small text-light mb-1">Repository</label>
          <select id="ghActionRepo" class="form-select form-select-sm bg-dark text-light border-secondary" onchange="ghLoadActions()">
            <option value="">All Repos</option>
          </select>
        </div>
        <button class="btn btn-sm btn-outline-light" onclick="ghExportActions()"><i class="bi bi-download"></i> CSV</button>
      </div>
      <div id="ghActionsTable"></div>
    </div>

    <!-- ── REPORTS TAB ── -->
    <div class="tab-pane fade" id="ghReports">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h6 class="mb-0 text-light">Unified Activity Report</h6>
        <button class="btn btn-sm btn-outline-light" onclick="ghExportReports()"><i class="bi bi-download"></i> CSV</button>
      </div>
      <div id="ghReportsTable"></div>
    </div>

    <!-- ── TEST API TAB ── -->
    <div class="tab-pane fade" id="ghTestApi">
      <h6 class="text-light mb-3">Simulate GitHub REST API Calls</h6>
      <div class="d-flex gap-2 mb-3 flex-wrap">
        <button class="btn btn-sm" style="background:#238636;color:#fff;" onclick="ghTestApiCall('repos')"><i class="bi bi-folder"></i> GET /repos</button>
        <button class="btn btn-sm" style="background:#238636;color:#fff;" onclick="ghTestApiCall('commits')"><i class="bi bi-git"></i> GET /commits</button>
        <button class="btn btn-sm" style="background:#238636;color:#fff;" onclick="ghTestApiCall('issues')"><i class="bi bi-circle-fill"></i> GET /issues</button>
      </div>
      <pre id="ghTestResult" class="bg-dark text-success p-3 rounded border border-secondary" style="max-height:350px;overflow:auto;font-size:.82rem;">Click a button above to test…</pre>
    </div>

    <!-- ── SETTINGS TAB ── -->
    <div class="tab-pane fade" id="ghSettings">
      <h6 class="text-light mb-3">GitHub Integration Settings</h6>
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label small text-light">Personal Access Token (PAT)</label>
          <input id="ghSettingsToken" class="form-control form-control-sm bg-dark text-light border-secondary" value="ghp_XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX" type="password">
        </div>
        <div class="col-md-6">
          <label class="form-label small text-light">API Version</label>
          <select id="ghSettingsVersion" class="form-select form-select-sm bg-dark text-light border-secondary">
            <option selected>2022-11-28</option>
            <option>2022-08-09</option>
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label small text-light">Default Organization</label>
          <select id="ghSettingsOrg" class="form-select form-select-sm bg-dark text-light border-secondary">
            <option>TechStartHQ</option>
            <option>DevOpsLab</option>
            <option>alexcto (Personal)</option>
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label small text-light">Webhook Events</label>
          <select id="ghSettingsEvents" class="form-select form-select-sm bg-dark text-light border-secondary" multiple size="3">
            <option selected>push</option>
            <option selected>pull_request</option>
            <option>issues</option>
            <option>release</option>
            <option>workflow_run</option>
          </select>
        </div>
      </div>
      <div class="mt-3">
        <label class="form-label small text-light">Webhook URL</label>
        <input id="ghSettingsWebhook" class="form-control form-control-sm bg-dark text-light border-secondary" value="https://camarad.ai/webhooks/github" readonly>
      </div>
      <button class="btn btn-sm mt-3" style="background:#238636;color:#fff;" onclick="ghSaveSettings()"><i class="bi bi-save"></i> Save Settings</button>
    </div>
  </div>
</div>
<!-- ═══ END GITHUB PANEL ═══ -->

<!-- ═══════════════════════════════════════════════════════════════════════════ -->
<!-- TODOIST RICH PANEL                                                        -->
<!-- ═══════════════════════════════════════════════════════════════════════════ -->
<div id="todoistPanel" class="card bg-dark text-light border-secondary mb-4" style="display:none;">
  <div class="card-header d-flex justify-content-between align-items-center" style="background:#E44332;">
    <h5 class="mb-0"><i class="bi bi-check2-square"></i> Todoist — Task Management</h5>
    <button class="btn btn-sm btn-outline-light" onclick="closePanel()"><i class="bi bi-x-lg"></i></button>
  </div>
  <div class="card-body">
    <!-- Tabs -->
    <ul class="nav nav-tabs mb-3" role="tablist">
      <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tdOverview" style="color:#E44332;">Overview</a></li>
      <li class="nav-item"><a class="nav-link text-light" data-bs-toggle="tab" href="#tdTasks">Tasks</a></li>
      <li class="nav-item"><a class="nav-link text-light" data-bs-toggle="tab" href="#tdProjects">Projects</a></li>
      <li class="nav-item"><a class="nav-link text-light" data-bs-toggle="tab" href="#tdLabels">Labels & Filters</a></li>
      <li class="nav-item"><a class="nav-link text-light" data-bs-toggle="tab" href="#tdHabits">Habits & Recurring</a></li>
      <li class="nav-item"><a class="nav-link text-light" data-bs-toggle="tab" href="#tdReports">Reports</a></li>
      <li class="nav-item"><a class="nav-link text-light" data-bs-toggle="tab" href="#tdTestApi">Test API</a></li>
      <li class="nav-item"><a class="nav-link text-light" data-bs-toggle="tab" href="#tdSettings">Settings</a></li>
    </ul>
    <div class="tab-content">

      <!-- OVERVIEW TAB -->
      <div class="tab-pane fade show active" id="tdOverview">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h6>Todoist Overview</h6>
          <select class="form-select form-select-sm bg-dark text-light w-auto" id="tdOverviewProject" onchange="tdLoadOverview()">
            <option value="">All Projects</option>
          </select>
        </div>
        <div id="tdKpiCards" class="row g-3 mb-4"></div>
        <h6>Tasks Completed per Day</h6>
        <div id="tdDailyChart" class="d-flex align-items-end gap-2" style="height:120px;"></div>
        <div id="tdProjectStats" class="mt-4"></div>
      </div>

      <!-- TASKS TAB -->
      <div class="tab-pane fade" id="tdTasks">
        <div class="row g-2 mb-3">
          <div class="col-md-3">
            <select class="form-select form-select-sm bg-dark text-light" id="tdTaskStatus" onchange="tdLoadTasks()">
              <option value="">All Statuses</option>
              <option value="open">Open</option>
              <option value="completed">Completed</option>
            </select>
          </div>
          <div class="col-md-3">
            <select class="form-select form-select-sm bg-dark text-light" id="tdTaskPriority" onchange="tdLoadTasks()">
              <option value="">All Priorities</option>
              <option value="1">P1 — Urgent</option>
              <option value="2">P2 — High</option>
              <option value="3">P3 — Medium</option>
              <option value="4">P4 — Low</option>
            </select>
          </div>
          <div class="col-md-3">
            <select class="form-select form-select-sm bg-dark text-light" id="tdTaskProject" onchange="tdLoadTasks()">
              <option value="">All Projects</option>
            </select>
          </div>
          <div class="col-md-3">
            <select class="form-select form-select-sm bg-dark text-light" id="tdTaskLabel" onchange="tdLoadTasks()">
              <option value="">All Labels</option>
            </select>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-dark table-striped table-hover">
            <thead><tr><th>Task</th><th>Priority</th><th>Project</th><th>Labels</th><th>Due</th><th>Status</th><th>Assignee</th></tr></thead>
            <tbody id="tdTasksBody"></tbody>
          </table>
        </div>
        <button class="btn btn-sm mt-2" style="background:#E44332;color:#fff;" onclick="tdExportTasks()"><i class="bi bi-download"></i> Export CSV</button>
      </div>

      <!-- PROJECTS TAB -->
      <div class="tab-pane fade" id="tdProjects">
        <h6 class="mb-3">Projects Overview</h6>
        <div id="tdProjectCards" class="row g-3 mb-3"></div>
        <div class="table-responsive">
          <table class="table table-dark table-striped table-hover">
            <thead><tr><th>Project</th><th>View</th><th>Open</th><th>Completed</th><th>Overdue</th><th>Labels Used</th><th>Color</th></tr></thead>
            <tbody id="tdProjectsBody"></tbody>
          </table>
        </div>
        <button class="btn btn-sm mt-2" style="background:#E44332;color:#fff;" onclick="tdExportProjects()"><i class="bi bi-download"></i> Export CSV</button>
      </div>

      <!-- LABELS & FILTERS TAB -->
      <div class="tab-pane fade" id="tdLabels">
        <div class="row g-2 mb-3">
          <div class="col-md-4">
            <input type="text" class="form-control form-control-sm bg-dark text-light" placeholder="Search labels…" id="tdLabelSearch" oninput="tdLoadLabels()">
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-dark table-striped table-hover">
            <thead><tr><th>Label</th><th>Color</th><th>Tasks</th><th>Favorite</th><th>Order</th></tr></thead>
            <tbody id="tdLabelsBody"></tbody>
          </table>
        </div>
        <button class="btn btn-sm mt-2" style="background:#E44332;color:#fff;" onclick="tdExportLabels()"><i class="bi bi-download"></i> Export CSV</button>
      </div>

      <!-- HABITS & RECURRING TAB -->
      <div class="tab-pane fade" id="tdHabits">
        <div class="row g-2 mb-3">
          <div class="col-md-4">
            <select class="form-select form-select-sm bg-dark text-light" id="tdHabitFreq" onchange="tdLoadHabits()">
              <option value="">All Frequencies</option>
              <option value="daily">Daily</option>
              <option value="weekly">Weekly</option>
            </select>
          </div>
        </div>
        <div id="tdHabitCards" class="row g-3 mb-3"></div>
        <div class="table-responsive">
          <table class="table table-dark table-striped table-hover">
            <thead><tr><th>Habit</th><th>Frequency</th><th>Streak</th><th>Last Done</th><th>Next Due</th><th>Project</th><th>Labels</th></tr></thead>
            <tbody id="tdHabitsBody"></tbody>
          </table>
        </div>
        <button class="btn btn-sm mt-2" style="background:#E44332;color:#fff;" onclick="tdExportHabits()"><i class="bi bi-download"></i> Export CSV</button>
      </div>

      <!-- REPORTS TAB -->
      <div class="tab-pane fade" id="tdReports">
        <h6 class="mb-3">Unified Report — Tasks · Projects · Labels · Habits</h6>
        <div class="table-responsive">
          <table class="table table-dark table-striped table-hover">
            <thead><tr><th>Type</th><th>Name</th><th>Project</th><th>Priority</th><th>Status</th><th>Due</th><th>Labels</th></tr></thead>
            <tbody id="tdReportsBody"></tbody>
          </table>
        </div>
        <button class="btn btn-sm mt-2" style="background:#E44332;color:#fff;" onclick="tdExportReports()"><i class="bi bi-download"></i> Export CSV</button>
      </div>

      <!-- TEST API TAB -->
      <div class="tab-pane fade" id="tdTestApi">
        <h6>Test Todoist REST API</h6>
        <div class="row g-2 mb-3">
          <div class="col-md-4">
            <select class="form-select form-select-sm bg-dark text-light" id="tdTestEndpoint">
              <option value="tasks">GET /rest/v2/tasks</option>
              <option value="projects">GET /rest/v2/projects</option>
              <option value="labels">GET /rest/v2/labels</option>
            </select>
          </div>
          <div class="col-md-3">
            <button class="btn btn-sm w-100" style="background:#E44332;color:#fff;" onclick="tdTestApiCall()"><i class="bi bi-play-fill"></i> Send Request</button>
          </div>
        </div>
        <pre id="tdTestResult" class="bg-black text-success p-3 rounded" style="max-height:400px;overflow:auto;font-size:.85rem;"></pre>
      </div>

      <!-- SETTINGS TAB -->
      <div class="tab-pane fade" id="tdSettings">
        <h6>Todoist Settings</h6>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">API Token</label>
            <input type="password" class="form-control bg-dark text-light" id="tdApiToken" placeholder="••••••••••••••••••" value="td_mock_xxxxxxxxxxxx">
          </div>
          <div class="col-md-6">
            <label class="form-label">Default Project</label>
            <select class="form-select bg-dark text-light" id="tdDefaultProject">
              <option>Daily Tasks</option>
              <option>Marketing Q1</option>
              <option>Personal Goals</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Reminder (minutes before)</label>
            <select class="form-select bg-dark text-light" id="tdReminderMin">
              <option value="10">10 min</option>
              <option value="30" selected>30 min</option>
              <option value="60">1 hour</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Sync Frequency</label>
            <select class="form-select bg-dark text-light" id="tdSyncFreq">
              <option value="5">Every 5 min</option>
              <option value="15" selected>Every 15 min</option>
              <option value="60">Every hour</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Theme</label>
            <select class="form-select bg-dark text-light" id="tdTheme">
              <option value="todoist_dark" selected>Todoist Dark</option>
              <option value="todoist_light">Todoist Light</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Auto-Schedule Overdue</label>
            <div class="form-check form-switch mt-2">
              <input class="form-check-input" type="checkbox" id="tdAutoSchedule" checked>
              <label class="form-check-label" for="tdAutoSchedule">Reschedule overdue tasks to today</label>
            </div>
          </div>
        </div>
        <button class="btn btn-sm mt-3" style="background:#E44332;color:#fff;" onclick="tdSaveSettings()"><i class="bi bi-save"></i> Save Settings</button>
      </div>

    </div>
  </div>
</div>
<!-- ═══ END TODOIST PANEL ═══ -->

<!-- ═══════════════════════════════════════════════════════════════════════════ -->
<!-- TELEGRAM RICH PANEL                                                       -->
<!-- ═══════════════════════════════════════════════════════════════════════════ -->
<div id="telegramPanel" class="card bg-dark text-light border-secondary mb-4" style="display:none;">
  <div class="card-header d-flex justify-content-between align-items-center" style="background:#0088cc;">
    <h5 class="mb-0"><i class="bi bi-telegram"></i> Telegram — Messaging & Bots</h5>
    <button class="btn btn-sm btn-outline-light" onclick="closePanel()"><i class="bi bi-x-lg"></i></button>
  </div>
  <div class="card-body">
    <!-- Tabs -->
    <ul class="nav nav-tabs mb-3" role="tablist">
      <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tgOverview" style="color:#0088cc;">Overview</a></li>
      <li class="nav-item"><a class="nav-link text-light" data-bs-toggle="tab" href="#tgChats">Chats</a></li>
      <li class="nav-item"><a class="nav-link text-light" data-bs-toggle="tab" href="#tgChannels">Channels</a></li>
      <li class="nav-item"><a class="nav-link text-light" data-bs-toggle="tab" href="#tgBots">Bots</a></li>
      <li class="nav-item"><a class="nav-link text-light" data-bs-toggle="tab" href="#tgMessages">Messages</a></li>
      <li class="nav-item"><a class="nav-link text-light" data-bs-toggle="tab" href="#tgReports">Reports</a></li>
      <li class="nav-item"><a class="nav-link text-light" data-bs-toggle="tab" href="#tgTestApi">Test API</a></li>
      <li class="nav-item"><a class="nav-link text-light" data-bs-toggle="tab" href="#tgSettings">Settings</a></li>
    </ul>
    <div class="tab-content">

      <!-- OVERVIEW TAB -->
      <div class="tab-pane fade show active" id="tgOverview">
        <h6 class="mb-3">Telegram Overview</h6>
        <div id="tgKpiCards" class="row g-3 mb-4"></div>
        <h6>Messages per Day (Sent vs Received)</h6>
        <div id="tgDailyChart" class="d-flex align-items-end gap-2" style="height:140px;"></div>
        <div id="tgChatBreakdown" class="mt-4"></div>
      </div>

      <!-- CHATS TAB -->
      <div class="tab-pane fade" id="tgChats">
        <div class="row g-2 mb-3">
          <div class="col-md-4">
            <select class="form-select form-select-sm bg-dark text-light" id="tgChatType" onchange="tgLoadChats()">
              <option value="">All Types</option>
              <option value="private">Private</option>
              <option value="group">Group</option>
            </select>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-dark table-striped table-hover">
            <thead><tr><th>Chat</th><th>Type</th><th>Last Message</th><th>Time</th><th>Unread</th><th>Pinned</th></tr></thead>
            <tbody id="tgChatsBody"></tbody>
          </table>
        </div>
        <button class="btn btn-sm mt-2" style="background:#0088cc;color:#fff;" onclick="tgExportChats()"><i class="bi bi-download"></i> Export CSV</button>
      </div>

      <!-- CHANNELS TAB -->
      <div class="tab-pane fade" id="tgChannels">
        <div class="row g-2 mb-3">
          <div class="col-md-4">
            <select class="form-select form-select-sm bg-dark text-light" id="tgChannelType" onchange="tgLoadChannels()">
              <option value="">All Channels</option>
              <option value="public">Public</option>
              <option value="private">Private</option>
            </select>
          </div>
        </div>
        <div id="tgChannelCards" class="row g-3 mb-3"></div>
        <div class="table-responsive">
          <table class="table table-dark table-striped table-hover">
            <thead><tr><th>Channel</th><th>Username</th><th>Subscribers</th><th>Posts Today</th><th>Last Post</th><th>Type</th></tr></thead>
            <tbody id="tgChannelsBody"></tbody>
          </table>
        </div>
        <button class="btn btn-sm mt-2" style="background:#0088cc;color:#fff;" onclick="tgExportChannels()"><i class="bi bi-download"></i> Export CSV</button>
      </div>

      <!-- BOTS TAB -->
      <div class="tab-pane fade" id="tgBots">
        <div class="row g-2 mb-3">
          <div class="col-md-4">
            <select class="form-select form-select-sm bg-dark text-light" id="tgBotStatus" onchange="tgLoadBots()">
              <option value="">All Statuses</option>
              <option value="active">Active</option>
              <option value="paused">Paused</option>
            </select>
          </div>
        </div>
        <div id="tgBotCards" class="row g-3 mb-3"></div>
        <div class="table-responsive">
          <table class="table table-dark table-striped table-hover">
            <thead><tr><th>Bot</th><th>Username</th><th>Status</th><th>Commands</th><th>Messages Sent</th><th>Last Active</th></tr></thead>
            <tbody id="tgBotsBody"></tbody>
          </table>
        </div>
        <button class="btn btn-sm mt-2" style="background:#0088cc;color:#fff;" onclick="tgExportBots()"><i class="bi bi-download"></i> Export CSV</button>
      </div>

      <!-- MESSAGES TAB -->
      <div class="tab-pane fade" id="tgMessages">
        <div class="row g-2 mb-3">
          <div class="col-md-3">
            <select class="form-select form-select-sm bg-dark text-light" id="tgMsgChat" onchange="tgLoadMessages()">
              <option value="">All Chats</option>
            </select>
          </div>
          <div class="col-md-3">
            <input type="text" class="form-control form-control-sm bg-dark text-light" placeholder="Search messages…" id="tgMsgSearch" oninput="tgLoadMessages()">
          </div>
          <div class="col-md-3">
            <input type="text" class="form-control form-control-sm bg-dark text-light" placeholder="Filter by sender…" id="tgMsgFrom" oninput="tgLoadMessages()">
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-dark table-striped table-hover">
            <thead><tr><th>Chat</th><th>From</th><th>Message</th><th>Type</th><th>Date</th></tr></thead>
            <tbody id="tgMessagesBody"></tbody>
          </table>
        </div>
        <button class="btn btn-sm mt-2" style="background:#0088cc;color:#fff;" onclick="tgExportMessages()"><i class="bi bi-download"></i> Export CSV</button>
      </div>

      <!-- REPORTS TAB -->
      <div class="tab-pane fade" id="tgReports">
        <h6 class="mb-3">Unified Report — Chats · Channels · Bots · Messages</h6>
        <div class="table-responsive">
          <table class="table table-dark table-striped table-hover">
            <thead><tr><th>Type</th><th>Name</th><th>Detail</th><th>Status</th><th>Last Activity</th></tr></thead>
            <tbody id="tgReportsBody"></tbody>
          </table>
        </div>
        <button class="btn btn-sm mt-2" style="background:#0088cc;color:#fff;" onclick="tgExportReports()"><i class="bi bi-download"></i> Export CSV</button>
      </div>

      <!-- TEST API TAB -->
      <div class="tab-pane fade" id="tgTestApi">
        <h6>Test Telegram Bot API</h6>
        <div class="row g-2 mb-3">
          <div class="col-md-4">
            <select class="form-select form-select-sm bg-dark text-light" id="tgTestEndpoint">
              <option value="getUpdates">GET /getUpdates</option>
              <option value="sendMessage">POST /sendMessage</option>
              <option value="getMe">GET /getMe</option>
            </select>
          </div>
          <div class="col-md-3">
            <button class="btn btn-sm w-100" style="background:#0088cc;color:#fff;" onclick="tgTestApiCall()"><i class="bi bi-play-fill"></i> Send Request</button>
          </div>
        </div>
        <pre id="tgTestResult" class="bg-black text-success p-3 rounded" style="max-height:400px;overflow:auto;font-size:.85rem;"></pre>
      </div>

      <!-- SETTINGS TAB -->
      <div class="tab-pane fade" id="tgSettings">
        <h6>Telegram Settings</h6>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Bot Token</label>
            <input type="password" class="form-control bg-dark text-light" id="tgBotToken" placeholder="••••••••••••••••••" value="7654321:AAH_mock_bot_token_xxxx">
          </div>
          <div class="col-md-6">
            <label class="form-label">Default Chat</label>
            <select class="form-select bg-dark text-light" id="tgDefaultChat">
              <option>Personal Journal</option>
              <option>Team Marketing</option>
              <option>DevOps Alerts</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Notifications</label>
            <select class="form-select bg-dark text-light" id="tgNotifications">
              <option value="all" selected>All Messages</option>
              <option value="mentions">Mentions Only</option>
              <option value="none">Silent</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Privacy</label>
            <select class="form-select bg-dark text-light" id="tgPrivacy">
              <option value="show">Show Phone Number</option>
              <option value="hide" selected>Hide Phone Number</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Theme</label>
            <select class="form-select bg-dark text-light" id="tgTheme">
              <option value="dark" selected>Dark</option>
              <option value="light">Light</option>
              <option value="system">System</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Auto-Download Media</label>
            <div class="form-check form-switch mt-2">
              <input class="form-check-input" type="checkbox" id="tgAutoDownload" checked>
              <label class="form-check-label" for="tgAutoDownload">Download photos & files automatically</label>
            </div>
          </div>
        </div>
        <button class="btn btn-sm mt-3" style="background:#0088cc;color:#fff;" onclick="tgSaveSettings()"><i class="bi bi-save"></i> Save Settings</button>
      </div>

    </div>
  </div>
</div>
<!-- ═══ END TELEGRAM PANEL ═══ -->

<!-- ═══ AWS PANEL (Phase 29) ═══ -->
<div id="awsPanel" style="display:none;">
  <div class="d-flex align-items-center mb-4">
    <button class="btn btn-outline-secondary me-3" onclick="closePanel()"><i class="bi bi-arrow-left"></i></button>
    <i class="bi bi-cloud-fill me-2" style="font-size:1.5rem;color:#FF9900;"></i>
    <h4 class="mb-0" style="color:#FF9900;">Amazon Web Services</h4>
    <span class="badge bg-success ms-3" id="awsConnBadge">Connected</span>
  </div>

  <ul class="nav nav-tabs mb-3" id="awsTabs" role="tablist">
    <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#awsOverviewTab" style="color:#FF9900;">Overview</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#awsEc2Tab" style="color:#FF9900;">EC2</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#awsS3Tab" style="color:#FF9900;">S3</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#awsLambdaTab" style="color:#FF9900;">Lambda</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#awsCostTab" style="color:#FF9900;">Cost Explorer</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#awsReportsTab" style="color:#FF9900;">Reports</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#awsTestTab" style="color:#FF9900;">Test API</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#awsSettingsTab" style="color:#FF9900;">Settings</a></li>
  </ul>

  <div class="tab-content">
    <!-- OVERVIEW TAB -->
    <div class="tab-pane fade show active" id="awsOverviewTab">
      <div class="row g-3 mb-4" id="awsKpiCards">
        <div class="col-md-2"><div class="card bg-dark border-secondary"><div class="card-body text-center"><small class="text-muted">EC2 Instances</small><h4 class="mb-0" style="color:#FF9900;" id="awsKpiEc2">—</h4></div></div></div>
        <div class="col-md-2"><div class="card bg-dark border-secondary"><div class="card-body text-center"><small class="text-muted">Running</small><h4 class="mb-0 text-success" id="awsKpiRunning">—</h4></div></div></div>
        <div class="col-md-2"><div class="card bg-dark border-secondary"><div class="card-body text-center"><small class="text-muted">S3 Buckets</small><h4 class="mb-0 text-info" id="awsKpiS3">—</h4></div></div></div>
        <div class="col-md-2"><div class="card bg-dark border-secondary"><div class="card-body text-center"><small class="text-muted">S3 Storage</small><h4 class="mb-0 text-info" id="awsKpiStorage">—</h4></div></div></div>
        <div class="col-md-2"><div class="card bg-dark border-secondary"><div class="card-body text-center"><small class="text-muted">Lambda Funcs</small><h4 class="mb-0 text-primary" id="awsKpiLambda">—</h4></div></div></div>
        <div class="col-md-2"><div class="card bg-dark border-secondary"><div class="card-body text-center"><small class="text-muted">Monthly Cost</small><h4 class="mb-0 text-warning" id="awsKpiCost">—</h4></div></div></div>
      </div>
      <div class="row g-3 mb-4">
        <div class="col-md-3"><div class="card bg-dark border-secondary"><div class="card-body text-center"><small class="text-muted">Invocations (30d)</small><h4 class="mb-0" style="color:#FF9900;" id="awsKpiInvocations">—</h4></div></div></div>
        <div class="col-md-3"><div class="card bg-dark border-secondary"><div class="card-body text-center"><small class="text-muted">IAM Users</small><h4 class="mb-0 text-secondary" id="awsKpiIam">—</h4></div></div></div>
        <div class="col-md-3"><div class="card bg-dark border-secondary"><div class="card-body text-center"><small class="text-muted">Active Alarms</small><h4 class="mb-0 text-danger" id="awsKpiAlarms">—</h4></div></div></div>
        <div class="col-md-3"><div class="card bg-dark border-secondary"><div class="card-body text-center"><small class="text-muted">Cost Forecast</small><h4 class="mb-0 text-warning" id="awsKpiForecast">—</h4></div></div></div>
      </div>
      <h6 style="color:#FF9900;">Monthly Cost Trend</h6>
      <canvas id="awsCostTrendChart" height="100"></canvas>
      <h6 class="mt-4" style="color:#FF9900;">Service Cost Breakdown</h6>
      <div id="awsServiceBreakdown"></div>
    </div>

    <!-- EC2 TAB -->
    <div class="tab-pane fade" id="awsEc2Tab">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="d-flex gap-2">
          <select class="form-select form-select-sm bg-dark text-light" style="width:150px;" id="awsEc2StatusFilter" onchange="awsLoadEc2()">
            <option value="">All Statuses</option>
            <option value="running">Running</option>
            <option value="stopped">Stopped</option>
          </select>
          <select class="form-select form-select-sm bg-dark text-light" style="width:160px;" id="awsEc2AzFilter" onchange="awsLoadEc2()">
            <option value="">All AZs</option>
            <option value="us-east-1a">us-east-1a</option>
            <option value="us-east-1b">us-east-1b</option>
            <option value="us-east-1c">us-east-1c</option>
          </select>
        </div>
        <button class="btn btn-sm btn-outline-light" onclick="awsExportEc2()"><i class="bi bi-download"></i> CSV</button>
      </div>
      <div class="table-responsive">
        <table class="table table-dark table-striped table-hover">
          <thead><tr><th>Instance ID</th><th>Name</th><th>Type</th><th>AZ</th><th>Status</th><th>CPU</th><th>RAM</th><th>Storage</th><th>Public IP</th></tr></thead>
          <tbody id="awsEc2Body"></tbody>
        </table>
      </div>
    </div>

    <!-- S3 TAB -->
    <div class="tab-pane fade" id="awsS3Tab">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <select class="form-select form-select-sm bg-dark text-light" style="width:200px;" id="awsS3ClassFilter" onchange="awsLoadS3()">
          <option value="">All Storage Classes</option>
          <option value="STANDARD">Standard</option>
          <option value="STANDARD_IA">Standard-IA</option>
          <option value="INTELLIGENT_TIERING">Intelligent-Tiering</option>
          <option value="GLACIER">Glacier</option>
        </select>
        <button class="btn btn-sm btn-outline-light" onclick="awsExportS3()"><i class="bi bi-download"></i> CSV</button>
      </div>
      <div class="row g-3 mb-3" id="awsS3Cards"></div>
      <div class="table-responsive">
        <table class="table table-dark table-striped table-hover">
          <thead><tr><th>Bucket</th><th>Storage Class</th><th>Objects</th><th>Size (GB)</th><th>Versioning</th><th>Created</th><th>Last Modified</th></tr></thead>
          <tbody id="awsS3Body"></tbody>
        </table>
      </div>
    </div>

    <!-- LAMBDA TAB -->
    <div class="tab-pane fade" id="awsLambdaTab">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="d-flex gap-2">
          <select class="form-select form-select-sm bg-dark text-light" style="width:160px;" id="awsLambdaRuntimeFilter" onchange="awsLoadLambda()">
            <option value="">All Runtimes</option>
            <option value="python">Python</option>
            <option value="nodejs">Node.js</option>
          </select>
          <select class="form-select form-select-sm bg-dark text-light" style="width:140px;" id="awsLambdaStatusFilter" onchange="awsLoadLambda()">
            <option value="">All Statuses</option>
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
          </select>
        </div>
        <button class="btn btn-sm btn-outline-light" onclick="awsExportLambda()"><i class="bi bi-download"></i> CSV</button>
      </div>
      <div class="row g-3 mb-3" id="awsLambdaCards"></div>
      <div class="table-responsive">
        <table class="table table-dark table-striped table-hover">
          <thead><tr><th>Function</th><th>Runtime</th><th>Memory</th><th>Timeout</th><th>Invocations (30d)</th><th>Avg Duration</th><th>Errors (30d)</th><th>Status</th></tr></thead>
          <tbody id="awsLambdaBody"></tbody>
        </table>
      </div>
    </div>

    <!-- COST EXPLORER TAB -->
    <div class="tab-pane fade" id="awsCostTab">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <select class="form-select form-select-sm bg-dark text-light" style="width:160px;" id="awsCostServiceFilter" onchange="awsLoadCostExplorer()">
          <option value="">All Services</option>
          <option value="ec2">EC2</option>
          <option value="s3">S3</option>
          <option value="lambda">Lambda</option>
          <option value="rds">RDS</option>
          <option value="cloudfront">CloudFront</option>
        </select>
        <button class="btn btn-sm btn-outline-light" onclick="awsExportCost()"><i class="bi bi-download"></i> CSV</button>
      </div>
      <canvas id="awsCostChart" height="120"></canvas>
      <div class="table-responsive mt-3">
        <table class="table table-dark table-striped table-hover">
          <thead><tr><th>Month</th><th>EC2</th><th>S3</th><th>Lambda</th><th>RDS</th><th>CloudFront</th><th>Other</th><th>Total</th></tr></thead>
          <tbody id="awsCostBody"></tbody>
        </table>
      </div>
    </div>

    <!-- REPORTS TAB -->
    <div class="tab-pane fade" id="awsReportsTab">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h6 class="mb-0" style="color:#FF9900;">Unified AWS Report</h6>
        <button class="btn btn-sm btn-outline-light" onclick="awsExportReports()"><i class="bi bi-download"></i> CSV</button>
      </div>
      <div class="table-responsive">
        <table class="table table-dark table-striped table-hover">
          <thead><tr><th>Type</th><th>Name</th><th>Detail</th><th>Status</th><th>Metric</th></tr></thead>
          <tbody id="awsReportsBody"></tbody>
        </table>
      </div>
    </div>

    <!-- TEST API TAB -->
    <div class="tab-pane fade" id="awsTestTab">
      <div class="card bg-dark border-secondary">
        <div class="card-body">
          <h6 style="color:#FF9900;">AWS SDK Test Call</h6>
          <div class="mb-3">
            <label class="form-label text-muted">Select API Call</label>
            <select class="form-select bg-dark text-light" id="awsTestEndpoint">
              <option value="ec2-describe-instances">EC2: DescribeInstances</option>
              <option value="s3-list-buckets">S3: ListBuckets</option>
              <option value="lambda-list-functions">Lambda: ListFunctions</option>
              <option value="cloudwatch-get-alarms">CloudWatch: DescribeAlarms</option>
            </select>
          </div>
          <button class="btn btn-warning" onclick="awsTestApiCall()" style="background-color:#FF9900;border-color:#FF9900;">
            <i class="bi bi-play-fill"></i> Run Test
          </button>
          <pre class="mt-3 p-3 bg-black text-light rounded" id="awsTestResult" style="max-height:350px;overflow:auto;font-size:0.85rem;">Click "Run Test" to simulate an AWS SDK call…</pre>
        </div>
      </div>
    </div>

    <!-- SETTINGS TAB -->
    <div class="tab-pane fade" id="awsSettingsTab">
      <div class="card bg-dark border-secondary">
        <div class="card-body">
          <h6 style="color:#FF9900;">AWS Configuration</h6>
          <div class="mb-3">
            <label class="form-label text-muted">Default Region</label>
            <select class="form-select bg-dark text-light" id="awsSettingRegion">
              <option value="us-east-1">us-east-1 (N. Virginia)</option>
              <option value="us-west-2">us-west-2 (Oregon)</option>
              <option value="eu-west-1">eu-west-1 (Ireland)</option>
              <option value="eu-central-1">eu-central-1 (Frankfurt)</option>
              <option value="ap-southeast-1">ap-southeast-1 (Singapore)</option>
              <option value="ap-northeast-1">ap-northeast-1 (Tokyo)</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label text-muted">Account ID</label>
            <input type="text" class="form-control bg-dark text-light" id="awsSettingAccount" value="123456789012" readonly>
          </div>
          <div class="mb-3">
            <label class="form-label text-muted">Cost Alert Threshold</label>
            <div class="input-group">
              <span class="input-group-text bg-dark text-light">$</span>
              <input type="number" class="form-control bg-dark text-light" id="awsSettingCostAlert" value="5000">
              <span class="input-group-text bg-dark text-light">/month</span>
            </div>
          </div>
          <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" id="awsSettingAlarms" checked>
            <label class="form-check-label text-muted">Enable CloudWatch Alarms</label>
          </div>
          <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" id="awsSettingBilling" checked>
            <label class="form-check-label text-muted">Enable Billing Alerts</label>
          </div>
          <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" id="awsSettingMfa">
            <label class="form-check-label text-muted">Enforce MFA on IAM Users</label>
          </div>
          <div class="mb-3">
            <label class="form-label text-muted">IAM Role for Access</label>
            <select class="form-select bg-dark text-light" id="awsSettingRole">
              <option>CamaradReadOnlyRole</option>
              <option>CamaradAdminRole</option>
              <option>CamaradDevOpsRole</option>
            </select>
          </div>
          <button class="btn btn-warning" onclick="awsSaveSettings()" style="background-color:#FF9900;border-color:#FF9900;">
            <i class="bi bi-check-lg"></i> Save Settings
          </button>
          <span class="ms-2 text-success" id="awsSettingsSaved" style="display:none;">✓ Saved</span>
        </div>
      </div>
    </div>

  </div>
</div>
<!-- ═══ END AWS PANEL ═══ -->

<!-- ═══ VERCEL PANEL (Phase 30) ═══ -->
<div id="vercelPanel" style="display:none;">
  <div class="d-flex align-items-center mb-4">
    <button class="btn btn-outline-secondary me-3" onclick="closePanel()"><i class="bi bi-arrow-left"></i></button>
    <i class="bi bi-triangle-fill me-2" style="font-size:1.4rem;color:#000;background:#fff;border-radius:3px;padding:2px 4px;"></i>
    <h4 class="mb-0" style="color:#fff;">Vercel</h4>
    <span class="badge bg-success ms-3" id="vercelConnBadge">Connected</span>
  </div>

  <ul class="nav nav-tabs mb-3" id="vercelTabs" role="tablist">
    <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#vercelOverviewTab">Overview</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#vercelDeploymentsTab">Deployments</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#vercelDomainsTab">Domains</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#vercelLogsTab">Logs</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#vercelAnalyticsTab">Analytics</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#vercelReportsTab">Reports</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#vercelTestTab">Test API</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#vercelSettingsTab">Settings</a></li>
  </ul>

  <div class="tab-content">
    <!-- OVERVIEW TAB -->
    <div class="tab-pane fade show active" id="vercelOverviewTab">
      <div class="row g-3 mb-4" id="vercelKpiRow1">
        <div class="col-md-2"><div class="card bg-dark border-secondary"><div class="card-body text-center"><small class="text-muted">Total Deploys</small><h4 class="mb-0 text-white" id="vcKpiDeploys">—</h4></div></div></div>
        <div class="col-md-2"><div class="card bg-dark border-secondary"><div class="card-body text-center"><small class="text-muted">Today</small><h4 class="mb-0 text-success" id="vcKpiToday">—</h4></div></div></div>
        <div class="col-md-2"><div class="card bg-dark border-secondary"><div class="card-body text-center"><small class="text-muted">Domains</small><h4 class="mb-0 text-info" id="vcKpiDomains">—</h4></div></div></div>
        <div class="col-md-2"><div class="card bg-dark border-secondary"><div class="card-body text-center"><small class="text-muted">Bandwidth</small><h4 class="mb-0 text-primary" id="vcKpiBandwidth">—</h4></div></div></div>
        <div class="col-md-2"><div class="card bg-dark border-secondary"><div class="card-body text-center"><small class="text-muted">Builds/Mo</small><h4 class="mb-0 text-warning" id="vcKpiBuilds">—</h4></div></div></div>
        <div class="col-md-2"><div class="card bg-dark border-secondary"><div class="card-body text-center"><small class="text-muted">Avg Build</small><h4 class="mb-0 text-secondary" id="vcKpiAvgBuild">—</h4></div></div></div>
      </div>
      <div class="row g-3 mb-4">
        <div class="col-md-3"><div class="card bg-dark border-secondary"><div class="card-body text-center"><small class="text-muted">Projects</small><h4 class="mb-0 text-white" id="vcKpiProjects">—</h4></div></div></div>
        <div class="col-md-3"><div class="card bg-dark border-secondary"><div class="card-body text-center"><small class="text-muted">Edge Functions</small><h4 class="mb-0 text-info" id="vcKpiEdge">—</h4></div></div></div>
        <div class="col-md-3"><div class="card bg-dark border-secondary"><div class="card-body text-center"><small class="text-muted">Serverless (30d)</small><h4 class="mb-0 text-primary" id="vcKpiServerless">—</h4></div></div></div>
        <div class="col-md-3"><div class="card bg-dark border-secondary"><div class="card-body text-center"><small class="text-muted">Plan</small><h4 class="mb-0 text-success" id="vcKpiPlan">—</h4></div></div></div>
      </div>
      <h6>Deploy Trend (7 days)</h6>
      <canvas id="vercelDeployChart" height="100"></canvas>
    </div>

    <!-- DEPLOYMENTS TAB -->
    <div class="tab-pane fade" id="vercelDeploymentsTab">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="d-flex gap-2">
          <select class="form-select form-select-sm bg-dark text-light" style="width:140px;" id="vcDeployStateFilter" onchange="vcLoadDeployments()">
            <option value="">All States</option>
            <option value="READY">Ready</option>
            <option value="ERROR">Error</option>
            <option value="BUILDING">Building</option>
            <option value="CANCELED">Canceled</option>
          </select>
          <select class="form-select form-select-sm bg-dark text-light" style="width:140px;" id="vcDeployTargetFilter" onchange="vcLoadDeployments()">
            <option value="">All Targets</option>
            <option value="production">Production</option>
            <option value="preview">Preview</option>
          </select>
          <select class="form-select form-select-sm bg-dark text-light" style="width:160px;" id="vcDeployProjectFilter" onchange="vcLoadDeployments()">
            <option value="">All Projects</option>
            <option value="camarad-app">camarad-app</option>
            <option value="camarad-docs">camarad-docs</option>
            <option value="camarad-landing">camarad-landing</option>
            <option value="camarad-api">camarad-api</option>
          </select>
        </div>
        <button class="btn btn-sm btn-outline-light" onclick="vcExportDeployments()"><i class="bi bi-download"></i> CSV</button>
      </div>
      <div class="table-responsive">
        <table class="table table-dark table-striped table-hover">
          <thead><tr><th>UID</th><th>Project</th><th>Commit</th><th>Branch</th><th>Target</th><th>State</th><th>Duration</th><th>Creator</th><th>Date</th></tr></thead>
          <tbody id="vcDeploymentsBody"></tbody>
        </table>
      </div>
    </div>

    <!-- DOMAINS TAB -->
    <div class="tab-pane fade" id="vercelDomainsTab">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <select class="form-select form-select-sm bg-dark text-light" style="width:150px;" id="vcDomainStatusFilter" onchange="vcLoadDomains()">
          <option value="">All Statuses</option>
          <option value="valid">Valid</option>
          <option value="pending">Pending</option>
          <option value="expired">Expired</option>
        </select>
        <button class="btn btn-sm btn-outline-light" onclick="vcExportDomains()"><i class="bi bi-download"></i> CSV</button>
      </div>
      <div class="row g-3 mb-3" id="vcDomainCards"></div>
      <div class="table-responsive">
        <table class="table table-dark table-striped table-hover">
          <thead><tr><th>Domain</th><th>Project</th><th>Status</th><th>SSL</th><th>SSL Expiry</th><th>DNS</th><th>Redirect</th></tr></thead>
          <tbody id="vcDomainsBody"></tbody>
        </table>
      </div>
    </div>

    <!-- LOGS TAB -->
    <div class="tab-pane fade" id="vercelLogsTab">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="d-flex gap-2">
          <select class="form-select form-select-sm bg-dark text-light" style="width:170px;" id="vcLogDeployFilter" onchange="vcLoadLogs()">
            <option value="">All Deployments</option>
            <option value="dpl_abc001">dpl_abc001 (latest)</option>
            <option value="dpl_abc005">dpl_abc005 (error)</option>
            <option value="dpl_abc010">dpl_abc010</option>
            <option value="dpl_abc011">dpl_abc011 (building)</option>
            <option value="dpl_abc013">dpl_abc013 (OOM)</option>
          </select>
          <select class="form-select form-select-sm bg-dark text-light" style="width:120px;" id="vcLogLevelFilter" onchange="vcLoadLogs()">
            <option value="">All Levels</option>
            <option value="info">Info</option>
            <option value="warning">Warning</option>
            <option value="error">Error</option>
          </select>
          <input type="text" class="form-control form-control-sm bg-dark text-light" style="width:180px;" placeholder="Search logs…" id="vcLogSearch" onkeyup="vcLoadLogs()">
        </div>
        <button class="btn btn-sm btn-outline-light" onclick="vcExportLogs()"><i class="bi bi-download"></i> CSV</button>
      </div>
      <div class="table-responsive">
        <table class="table table-dark table-striped table-hover" style="font-size:0.85rem;">
          <thead><tr><th>Deployment</th><th>Timestamp</th><th>Level</th><th>Message</th><th>Source</th></tr></thead>
          <tbody id="vcLogsBody"></tbody>
        </table>
      </div>
    </div>

    <!-- ANALYTICS TAB -->
    <div class="tab-pane fade" id="vercelAnalyticsTab">
      <div class="row g-3 mb-4" id="vcAnalyticsKpis"></div>
      <h6>Daily Visitors (7 days)</h6>
      <canvas id="vercelVisitorsChart" height="100"></canvas>
      <div class="row mt-4">
        <div class="col-md-6">
          <h6>Top Pages</h6>
          <div class="table-responsive"><table class="table table-dark table-striped table-sm"><thead><tr><th>Path</th><th>Views</th><th>Visitors</th><th>Avg Duration</th></tr></thead><tbody id="vcTopPagesBody"></tbody></table></div>
        </div>
        <div class="col-md-6">
          <h6>Top Referrers</h6>
          <div class="table-responsive"><table class="table table-dark table-striped table-sm"><thead><tr><th>Source</th><th>Visitors</th><th>%</th></tr></thead><tbody id="vcReferrersBody"></tbody></table></div>
        </div>
      </div>
    </div>

    <!-- REPORTS TAB -->
    <div class="tab-pane fade" id="vercelReportsTab">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h6 class="mb-0">Unified Vercel Report</h6>
        <button class="btn btn-sm btn-outline-light" onclick="vcExportReports()"><i class="bi bi-download"></i> CSV</button>
      </div>
      <div class="table-responsive">
        <table class="table table-dark table-striped table-hover">
          <thead><tr><th>Type</th><th>Name</th><th>Detail</th><th>Status</th><th>Metric</th></tr></thead>
          <tbody id="vcReportsBody"></tbody>
        </table>
      </div>
    </div>

    <!-- TEST API TAB -->
    <div class="tab-pane fade" id="vercelTestTab">
      <div class="card bg-dark border-secondary">
        <div class="card-body">
          <h6>Vercel API Test Call</h6>
          <div class="mb-3">
            <label class="form-label text-muted">Select API Endpoint</label>
            <select class="form-select bg-dark text-light" id="vcTestEndpoint">
              <option value="list-deployments">GET /v6/deployments</option>
              <option value="list-domains">GET /v5/domains</option>
              <option value="get-project">GET /v9/projects/:id</option>
              <option value="create-deployment">POST /v13/deployments</option>
            </select>
          </div>
          <button class="btn btn-light" onclick="vcTestApiCall()"><i class="bi bi-play-fill"></i> Run Test</button>
          <pre class="mt-3 p-3 bg-black text-light rounded" id="vcTestResult" style="max-height:350px;overflow:auto;font-size:0.85rem;">Click "Run Test" to simulate a Vercel API call…</pre>
        </div>
      </div>
    </div>

    <!-- SETTINGS TAB -->
    <div class="tab-pane fade" id="vercelSettingsTab">
      <div class="card bg-dark border-secondary">
        <div class="card-body">
          <h6>Vercel Configuration</h6>
          <div class="mb-3">
            <label class="form-label text-muted">Team</label>
            <select class="form-select bg-dark text-light" id="vcSettingTeam">
              <option>TechStart Dev (team_abc123)</option>
              <option>Personal Projects (team_def456)</option>
              <option>Agency Clients (team_ghi789)</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label text-muted">Default Framework</label>
            <select class="form-select bg-dark text-light" id="vcSettingFramework">
              <option>Next.js</option>
              <option>Astro</option>
              <option>Nuxt</option>
              <option>SvelteKit</option>
              <option>Remix</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label text-muted">Node.js Version</label>
            <select class="form-select bg-dark text-light" id="vcSettingNode">
              <option>20.x (LTS)</option>
              <option>18.x</option>
              <option>22.x</option>
            </select>
          </div>
          <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" id="vcSettingAutoPromote" checked>
            <label class="form-check-label text-muted">Auto-promote to Production</label>
          </div>
          <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" id="vcSettingPreviewComments" checked>
            <label class="form-check-label text-muted">Preview Deployment Comments</label>
          </div>
          <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" id="vcSettingAnalytics">
            <label class="form-check-label text-muted">Web Analytics (Speed Insights)</label>
          </div>
          <div class="mb-3">
            <label class="form-label text-muted">Environment Variables</label>
            <div class="bg-black p-2 rounded" style="font-size:0.85rem;">
              <code>NEXT_PUBLIC_API_URL=https://api.camarad.ai</code><br>
              <code>DATABASE_URL=postgresql://***</code><br>
              <code>STRIPE_SECRET_KEY=sk_live_***</code>
            </div>
          </div>
          <button class="btn btn-light" onclick="vcSaveSettings()"><i class="bi bi-check-lg"></i> Save Settings</button>
          <span class="ms-2 text-success" id="vcSettingsSaved" style="display:none;">✓ Saved</span>
        </div>
      </div>
    </div>

  </div>
</div>
<!-- ═══ END VERCEL PANEL ═══ -->
</div>
<script>
  let currentConnector = null;

  // ═══════════════════════════════════════════════════════════════════════════
  // SHARED: Generic Connector Logic
  // ═══════════════════════════════════════════════════════════════════════════

  async function loadConnectorStatuses() {
    function ensureConnectorEmptyState(show) {
      var id = 'connectorsClientEmptyState';
      var box = document.getElementById(id);
      if (!box) {
        box = document.createElement('div');
        box.id = id;
        box.className = 'alert alert-secondary border-secondary mb-3';
        box.style.display = 'none';
        box.textContent = 'No connector accounts are linked to the active client yet. Showing full catalog.';
        var list = document.getElementById('connectorsList');
        if (list && list.parentNode) {
          list.parentNode.insertBefore(box, list);
        }
      }
      box.style.display = show ? '' : 'none';
    }

    function updateConnectorSectionVisibility() {
      document.querySelectorAll('#connectorsList .row.g-3').forEach(function(row) {
        var visible = false;
        row.querySelectorAll('.col-md-6').forEach(function(col) {
          if (col.style.display !== 'none') visible = true;
        });
        row.style.display = visible ? '' : 'none';
        var heading = row.previousElementSibling;
        if (heading && heading.tagName === 'H6') {
          heading.style.display = visible ? '' : 'none';
        }
      });
    }

    try {
      const [scopedResp, allResp] = await Promise.all([
        fetch('/api/connectors/list', { cache: 'no-store' }),
        fetch('/api/connectors/list?all=1', { cache: 'no-store' })
      ]);

      const scopedListRaw = await scopedResp.json();
      const allListRaw = await allResp.json();
      const scopedList = Array.isArray(scopedListRaw) ? scopedListRaw : [];
      const allList = Array.isArray(allListRaw) ? allListRaw : [];
      const scopedStatusMap = {};
      scopedList.forEach(function(item) {
        var slug = String(item.slug || '').trim();
        if (!slug) return;
        scopedStatusMap[slug] = item.status || scopedStatusMap[slug] || 'Disconnected';
      });
      const catalogMap = {};
      allList.forEach(function(item) {
        var slug = String(item.slug || '').trim();
        if (!slug) return;
        catalogMap[slug] = item;
      });

      const activeClientId = (window.CamaradClient && typeof window.CamaradClient.getActiveClientId === 'function')
        ? window.CamaradClient.getActiveClientId()
        : null;

      document.querySelectorAll('#connectorsList .card').forEach(function(card) {
        const btn = card.querySelector('button[onclick*="configureConnector"]');
        if (!btn) return;
        const match = btn.getAttribute('onclick').match(/configureConnector\('([^']+)'/);
        if (!match) return;
        const slug = match[1];

        const badge = card.querySelector('.badge');
        if (badge) {
          const catalogStatus = catalogMap[slug] ? catalogMap[slug].status : '';
          const status = activeClientId ? (scopedStatusMap[slug] || catalogStatus) : (catalogStatus || scopedStatusMap[slug]);
          const isLive = catalogMap[slug] ? !!catalogMap[slug].is_live : true;
          if (String(status || '').toLowerCase() === 'connected' || String(status || '').toLowerCase() === 'active') {
            badge.textContent = 'Connected';
            badge.className = 'badge bg-success';
          } else if (String(status || '').toLowerCase() === 'pending') {
            badge.textContent = 'Pending';
            badge.className = 'badge bg-warning text-dark';
          } else if (String(status || '').toLowerCase() === 'error') {
            badge.textContent = 'Error';
            badge.className = 'badge bg-danger';
          } else if (isLive) {
            badge.textContent = 'Disconnected';
            badge.className = 'badge bg-secondary';
          } else {
            badge.textContent = 'Soon';
            badge.className = 'badge bg-warning text-dark';
          }
        }
      });

      ensureConnectorEmptyState(!!activeClientId && scopedList.length === 0);
      updateConnectorSectionVisibility();
    } catch (err) {
      console.error('Error loading connector status', err);
    }
  }

  function updateBadge(slug, connected) {
    const card = document.querySelector(`[onclick*="configureConnector('${slug}'"]`);
    if (card) {
      const badge = card.closest('.card')?.querySelector('.badge') || card.querySelector('.badge');
      if (badge) {
        badge.className = connected ? 'badge bg-success' : 'badge bg-warning text-dark';
        badge.textContent = connected ? 'Connected' : 'Soon';
      }
    }
  }

  function updateAuthStatus() {
    const connected = document.getElementById('connectorConnected').checked;
    document.getElementById('panelAuthStatus').innerHTML = connected
      ? '<div class="alert alert-success">Connected successfully!</div>'
      : '<div class="alert alert-warning">Disconnected</div>';
  }

  function configureConnector(slug, name) {
    currentConnector = { slug, name };
    document.getElementById('connectorsList').style.display = 'none';

    // Google Ads gets its own rich panel
    if (slug === 'google-ads') {
      document.getElementById('connectorPanel').style.display = 'none';
      document.getElementById('ga4Panel').style.display = 'none';
      document.getElementById('gscPanel').style.display = 'none';
      document.getElementById('gtmPanel').style.display = 'none';
      document.getElementById('metaAdsPanel').style.display = 'none';
      document.getElementById('tiktokAdsPanel').style.display = 'none';
      document.getElementById('linkedinAdsPanel').style.display = 'none';
      document.getElementById('stripePanel').style.display = 'none';
      document.getElementById('shopifyPanel').style.display = 'none';
      document.getElementById('hubspotPanel').style.display = 'none';
      document.getElementById('salesforcePanel').style.display = 'none';
      document.getElementById('quickbooksPanel').style.display = 'none';
      document.getElementById('mailchimpPanel').style.display = 'none';
      document.getElementById('paypalPanel').style.display = 'none';
      document.getElementById('notionPanel').style.display = 'none';
      document.getElementById('githubPanel').style.display = 'none';
      document.getElementById('todoistPanel').style.display = 'none';
      document.getElementById('telegramPanel').style.display = 'none';
      document.getElementById('awsPanel').style.display = 'none';
      document.getElementById('vercelPanel').style.display = 'none';
      document.getElementById('googleAdsPanel').style.display = 'block';
      gadsInit();
      return;
    }

    // GA4 gets its own rich panel
    if (slug === 'ga4') {
      document.getElementById('connectorPanel').style.display = 'none';
      document.getElementById('googleAdsPanel').style.display = 'none';
      document.getElementById('gscPanel').style.display = 'none';
      document.getElementById('gtmPanel').style.display = 'none';
      document.getElementById('metaAdsPanel').style.display = 'none';
      document.getElementById('tiktokAdsPanel').style.display = 'none';
      document.getElementById('linkedinAdsPanel').style.display = 'none';
      document.getElementById('stripePanel').style.display = 'none';
      document.getElementById('shopifyPanel').style.display = 'none';
      document.getElementById('hubspotPanel').style.display = 'none';
      document.getElementById('salesforcePanel').style.display = 'none';
      document.getElementById('quickbooksPanel').style.display = 'none';
      document.getElementById('mailchimpPanel').style.display = 'none';
      document.getElementById('paypalPanel').style.display = 'none';
      document.getElementById('notionPanel').style.display = 'none';
      document.getElementById('githubPanel').style.display = 'none';
      document.getElementById('todoistPanel').style.display = 'none';
      document.getElementById('telegramPanel').style.display = 'none';
      document.getElementById('awsPanel').style.display = 'none';
      document.getElementById('vercelPanel').style.display = 'none';
      document.getElementById('ga4Panel').style.display = 'block';
      ga4Init();
      return;
    }

    // Google Search Console gets its own rich panel
    if (slug === 'google-search-console') {
      document.getElementById('connectorPanel').style.display = 'none';
      document.getElementById('googleAdsPanel').style.display = 'none';
      document.getElementById('ga4Panel').style.display = 'none';
      document.getElementById('gtmPanel').style.display = 'none';
      document.getElementById('metaAdsPanel').style.display = 'none';
      document.getElementById('tiktokAdsPanel').style.display = 'none';
      document.getElementById('linkedinAdsPanel').style.display = 'none';
      document.getElementById('stripePanel').style.display = 'none';
      document.getElementById('shopifyPanel').style.display = 'none';
      document.getElementById('hubspotPanel').style.display = 'none';
      document.getElementById('salesforcePanel').style.display = 'none';
      document.getElementById('quickbooksPanel').style.display = 'none';
      document.getElementById('mailchimpPanel').style.display = 'none';
      document.getElementById('paypalPanel').style.display = 'none';
      document.getElementById('notionPanel').style.display = 'none';
      document.getElementById('githubPanel').style.display = 'none';
      document.getElementById('todoistPanel').style.display = 'none';
      document.getElementById('telegramPanel').style.display = 'none';
      document.getElementById('awsPanel').style.display = 'none';
      document.getElementById('vercelPanel').style.display = 'none';
      document.getElementById('gscPanel').style.display = 'block';
      gscInit();
      return;
    }

    // Google Tag Manager gets its own rich panel
    if (slug === 'google-tag-manager') {
      document.getElementById('connectorPanel').style.display = 'none';
      document.getElementById('googleAdsPanel').style.display = 'none';
      document.getElementById('ga4Panel').style.display = 'none';
      document.getElementById('gscPanel').style.display = 'none';
      document.getElementById('metaAdsPanel').style.display = 'none';
      document.getElementById('tiktokAdsPanel').style.display = 'none';
      document.getElementById('linkedinAdsPanel').style.display = 'none';
      document.getElementById('stripePanel').style.display = 'none';
      document.getElementById('shopifyPanel').style.display = 'none';
      document.getElementById('hubspotPanel').style.display = 'none';
      document.getElementById('salesforcePanel').style.display = 'none';
      document.getElementById('quickbooksPanel').style.display = 'none';
      document.getElementById('mailchimpPanel').style.display = 'none';
      document.getElementById('paypalPanel').style.display = 'none';
      document.getElementById('notionPanel').style.display = 'none';
      document.getElementById('githubPanel').style.display = 'none';
      document.getElementById('todoistPanel').style.display = 'none';
      document.getElementById('telegramPanel').style.display = 'none';
      document.getElementById('awsPanel').style.display = 'none';
      document.getElementById('vercelPanel').style.display = 'none';
      document.getElementById('gtmPanel').style.display = 'block';
      gtmInit();
      return;
    }

    // Meta Ads gets its own rich panel
    if (slug === 'meta-ads') {
      document.getElementById('connectorPanel').style.display = 'none';
      document.getElementById('googleAdsPanel').style.display = 'none';
      document.getElementById('ga4Panel').style.display = 'none';
      document.getElementById('gscPanel').style.display = 'none';
      document.getElementById('gtmPanel').style.display = 'none';
      document.getElementById('tiktokAdsPanel').style.display = 'none';
      document.getElementById('linkedinAdsPanel').style.display = 'none';
      document.getElementById('stripePanel').style.display = 'none';
      document.getElementById('shopifyPanel').style.display = 'none';
      document.getElementById('hubspotPanel').style.display = 'none';
      document.getElementById('salesforcePanel').style.display = 'none';
      document.getElementById('quickbooksPanel').style.display = 'none';
      document.getElementById('mailchimpPanel').style.display = 'none';
      document.getElementById('paypalPanel').style.display = 'none';
      document.getElementById('notionPanel').style.display = 'none';
      document.getElementById('githubPanel').style.display = 'none';
      document.getElementById('todoistPanel').style.display = 'none';
      document.getElementById('telegramPanel').style.display = 'none';
      document.getElementById('awsPanel').style.display = 'none';
      document.getElementById('vercelPanel').style.display = 'none';
      document.getElementById('metaAdsPanel').style.display = 'block';
      metaInit();
      return;
    }

    // TikTok Ads gets its own rich panel
    if (slug === 'tiktok-ads') {
      document.getElementById('connectorPanel').style.display = 'none';
      document.getElementById('googleAdsPanel').style.display = 'none';
      document.getElementById('ga4Panel').style.display = 'none';
      document.getElementById('gscPanel').style.display = 'none';
      document.getElementById('gtmPanel').style.display = 'none';
      document.getElementById('metaAdsPanel').style.display = 'none';
      document.getElementById('linkedinAdsPanel').style.display = 'none';
      document.getElementById('stripePanel').style.display = 'none';
      document.getElementById('shopifyPanel').style.display = 'none';
      document.getElementById('hubspotPanel').style.display = 'none';
      document.getElementById('salesforcePanel').style.display = 'none';
      document.getElementById('quickbooksPanel').style.display = 'none';
      document.getElementById('mailchimpPanel').style.display = 'none';
      document.getElementById('paypalPanel').style.display = 'none';
      document.getElementById('notionPanel').style.display = 'none';
      document.getElementById('githubPanel').style.display = 'none';
      document.getElementById('todoistPanel').style.display = 'none';
      document.getElementById('telegramPanel').style.display = 'none';
      document.getElementById('awsPanel').style.display = 'none';
      document.getElementById('vercelPanel').style.display = 'none';
      document.getElementById('tiktokAdsPanel').style.display = 'block';
      tiktokInit();
      return;
    }

    // LinkedIn Ads gets its own rich panel
    if (slug === 'linkedin-ads') {
      document.getElementById('connectorPanel').style.display = 'none';
      document.getElementById('googleAdsPanel').style.display = 'none';
      document.getElementById('ga4Panel').style.display = 'none';
      document.getElementById('gscPanel').style.display = 'none';
      document.getElementById('gtmPanel').style.display = 'none';
      document.getElementById('metaAdsPanel').style.display = 'none';
      document.getElementById('tiktokAdsPanel').style.display = 'none';
      document.getElementById('stripePanel').style.display = 'none';
      document.getElementById('shopifyPanel').style.display = 'none';
      document.getElementById('hubspotPanel').style.display = 'none';
      document.getElementById('salesforcePanel').style.display = 'none';
      document.getElementById('quickbooksPanel').style.display = 'none';
      document.getElementById('mailchimpPanel').style.display = 'none';
      document.getElementById('paypalPanel').style.display = 'none';
      document.getElementById('notionPanel').style.display = 'none';
      document.getElementById('githubPanel').style.display = 'none';
      document.getElementById('todoistPanel').style.display = 'none';
      document.getElementById('telegramPanel').style.display = 'none';
      document.getElementById('awsPanel').style.display = 'none';
      document.getElementById('vercelPanel').style.display = 'none';
      document.getElementById('linkedinAdsPanel').style.display = 'block';
      linkedinInit();
      return;
    }

    // Stripe gets its own rich panel
    if (slug === 'stripe') {
      document.getElementById('connectorPanel').style.display = 'none';
      document.getElementById('googleAdsPanel').style.display = 'none';
      document.getElementById('ga4Panel').style.display = 'none';
      document.getElementById('gscPanel').style.display = 'none';
      document.getElementById('gtmPanel').style.display = 'none';
      document.getElementById('metaAdsPanel').style.display = 'none';
      document.getElementById('tiktokAdsPanel').style.display = 'none';
      document.getElementById('linkedinAdsPanel').style.display = 'none';
      document.getElementById('shopifyPanel').style.display = 'none';
      document.getElementById('hubspotPanel').style.display = 'none';
      document.getElementById('salesforcePanel').style.display = 'none';
      document.getElementById('quickbooksPanel').style.display = 'none';
      document.getElementById('mailchimpPanel').style.display = 'none';
      document.getElementById('paypalPanel').style.display = 'none';
      document.getElementById('notionPanel').style.display = 'none';
      document.getElementById('githubPanel').style.display = 'none';
      document.getElementById('todoistPanel').style.display = 'none';
      document.getElementById('telegramPanel').style.display = 'none';
      document.getElementById('awsPanel').style.display = 'none';
      document.getElementById('vercelPanel').style.display = 'none';
      document.getElementById('stripePanel').style.display = 'block';
      stripeInit();
      return;
    }

    // Shopify gets its own rich panel
    if (slug === 'shopify') {
      document.getElementById('connectorPanel').style.display = 'none';
      document.getElementById('googleAdsPanel').style.display = 'none';
      document.getElementById('ga4Panel').style.display = 'none';
      document.getElementById('gscPanel').style.display = 'none';
      document.getElementById('gtmPanel').style.display = 'none';
      document.getElementById('metaAdsPanel').style.display = 'none';
      document.getElementById('tiktokAdsPanel').style.display = 'none';
      document.getElementById('linkedinAdsPanel').style.display = 'none';
      document.getElementById('stripePanel').style.display = 'none';
      document.getElementById('hubspotPanel').style.display = 'none';
      document.getElementById('salesforcePanel').style.display = 'none';
      document.getElementById('quickbooksPanel').style.display = 'none';
      document.getElementById('mailchimpPanel').style.display = 'none';
      document.getElementById('paypalPanel').style.display = 'none';
      document.getElementById('notionPanel').style.display = 'none';
      document.getElementById('githubPanel').style.display = 'none';
      document.getElementById('todoistPanel').style.display = 'none';
      document.getElementById('telegramPanel').style.display = 'none';
      document.getElementById('awsPanel').style.display = 'none';
      document.getElementById('vercelPanel').style.display = 'none';
      document.getElementById('shopifyPanel').style.display = 'block';
      shopifyInit();
      return;
    }

    // HubSpot gets its own rich panel
    if (slug === 'hubspot') {
      document.getElementById('connectorPanel').style.display = 'none';
      document.getElementById('googleAdsPanel').style.display = 'none';
      document.getElementById('ga4Panel').style.display = 'none';
      document.getElementById('gscPanel').style.display = 'none';
      document.getElementById('gtmPanel').style.display = 'none';
      document.getElementById('metaAdsPanel').style.display = 'none';
      document.getElementById('tiktokAdsPanel').style.display = 'none';
      document.getElementById('linkedinAdsPanel').style.display = 'none';
      document.getElementById('stripePanel').style.display = 'none';
      document.getElementById('shopifyPanel').style.display = 'none';
      document.getElementById('salesforcePanel').style.display = 'none';
      document.getElementById('quickbooksPanel').style.display = 'none';
      document.getElementById('mailchimpPanel').style.display = 'none';
      document.getElementById('paypalPanel').style.display = 'none';
      document.getElementById('notionPanel').style.display = 'none';
      document.getElementById('githubPanel').style.display = 'none';
      document.getElementById('todoistPanel').style.display = 'none';
      document.getElementById('telegramPanel').style.display = 'none';
      document.getElementById('awsPanel').style.display = 'none';
      document.getElementById('vercelPanel').style.display = 'none';
      document.getElementById('hubspotPanel').style.display = 'block';
      hubspotInit();
      return;
    }

    // Salesforce gets its own rich panel
    if (slug === 'salesforce') {
      document.getElementById('connectorPanel').style.display = 'none';
      document.getElementById('googleAdsPanel').style.display = 'none';
      document.getElementById('ga4Panel').style.display = 'none';
      document.getElementById('gscPanel').style.display = 'none';
      document.getElementById('gtmPanel').style.display = 'none';
      document.getElementById('metaAdsPanel').style.display = 'none';
      document.getElementById('tiktokAdsPanel').style.display = 'none';
      document.getElementById('linkedinAdsPanel').style.display = 'none';
      document.getElementById('stripePanel').style.display = 'none';
      document.getElementById('shopifyPanel').style.display = 'none';
      document.getElementById('hubspotPanel').style.display = 'none';
      document.getElementById('quickbooksPanel').style.display = 'none';
      document.getElementById('mailchimpPanel').style.display = 'none';
      document.getElementById('paypalPanel').style.display = 'none';
      document.getElementById('notionPanel').style.display = 'none';
      document.getElementById('githubPanel').style.display = 'none';
      document.getElementById('todoistPanel').style.display = 'none';
      document.getElementById('telegramPanel').style.display = 'none';
      document.getElementById('awsPanel').style.display = 'none';
      document.getElementById('vercelPanel').style.display = 'none';
      document.getElementById('salesforcePanel').style.display = 'block';
      salesforceInit();
      return;
    }

    // QuickBooks gets its own rich panel
    if (slug === 'quickbooks') {
      document.getElementById('connectorPanel').style.display = 'none';
      document.getElementById('googleAdsPanel').style.display = 'none';
      document.getElementById('ga4Panel').style.display = 'none';
      document.getElementById('gscPanel').style.display = 'none';
      document.getElementById('gtmPanel').style.display = 'none';
      document.getElementById('metaAdsPanel').style.display = 'none';
      document.getElementById('tiktokAdsPanel').style.display = 'none';
      document.getElementById('linkedinAdsPanel').style.display = 'none';
      document.getElementById('stripePanel').style.display = 'none';
      document.getElementById('shopifyPanel').style.display = 'none';
      document.getElementById('hubspotPanel').style.display = 'none';
      document.getElementById('salesforcePanel').style.display = 'none';
      document.getElementById('mailchimpPanel').style.display = 'none';
      document.getElementById('paypalPanel').style.display = 'none';
      document.getElementById('notionPanel').style.display = 'none';
      document.getElementById('githubPanel').style.display = 'none';
      document.getElementById('todoistPanel').style.display = 'none';
      document.getElementById('telegramPanel').style.display = 'none';
      document.getElementById('awsPanel').style.display = 'none';
      document.getElementById('vercelPanel').style.display = 'none';
      document.getElementById('quickbooksPanel').style.display = 'block';
      quickbooksInit();
      return;
    }

    // Mailchimp gets its own rich panel
    if (slug === 'mailchimp') {
      document.getElementById('connectorPanel').style.display = 'none';
      document.getElementById('googleAdsPanel').style.display = 'none';
      document.getElementById('ga4Panel').style.display = 'none';
      document.getElementById('gscPanel').style.display = 'none';
      document.getElementById('gtmPanel').style.display = 'none';
      document.getElementById('metaAdsPanel').style.display = 'none';
      document.getElementById('tiktokAdsPanel').style.display = 'none';
      document.getElementById('linkedinAdsPanel').style.display = 'none';
      document.getElementById('stripePanel').style.display = 'none';
      document.getElementById('shopifyPanel').style.display = 'none';
      document.getElementById('hubspotPanel').style.display = 'none';
      document.getElementById('salesforcePanel').style.display = 'none';
      document.getElementById('quickbooksPanel').style.display = 'none';
      document.getElementById('paypalPanel').style.display = 'none';
      document.getElementById('notionPanel').style.display = 'none';
      document.getElementById('githubPanel').style.display = 'none';
      document.getElementById('todoistPanel').style.display = 'none';
      document.getElementById('telegramPanel').style.display = 'none';
      document.getElementById('awsPanel').style.display = 'none';
      document.getElementById('vercelPanel').style.display = 'none';
      document.getElementById('mailchimpPanel').style.display = 'block';
      mailchimpInit();
      return;
    }

    // PayPal gets its own rich panel
    if (slug === 'paypal') {
      document.getElementById('connectorPanel').style.display = 'none';
      document.getElementById('googleAdsPanel').style.display = 'none';
      document.getElementById('ga4Panel').style.display = 'none';
      document.getElementById('gscPanel').style.display = 'none';
      document.getElementById('gtmPanel').style.display = 'none';
      document.getElementById('metaAdsPanel').style.display = 'none';
      document.getElementById('tiktokAdsPanel').style.display = 'none';
      document.getElementById('linkedinAdsPanel').style.display = 'none';
      document.getElementById('stripePanel').style.display = 'none';
      document.getElementById('shopifyPanel').style.display = 'none';
      document.getElementById('hubspotPanel').style.display = 'none';
      document.getElementById('salesforcePanel').style.display = 'none';
      document.getElementById('quickbooksPanel').style.display = 'none';
      document.getElementById('mailchimpPanel').style.display = 'none';
      document.getElementById('notionPanel').style.display = 'none';
      document.getElementById('githubPanel').style.display = 'none';
      document.getElementById('todoistPanel').style.display = 'none';
      document.getElementById('telegramPanel').style.display = 'none';
      document.getElementById('awsPanel').style.display = 'none';
      document.getElementById('vercelPanel').style.display = 'none';
      document.getElementById('paypalPanel').style.display = 'block';
      paypalInit();
      return;
    }

    // Notion gets its own rich panel
    if (slug === 'notion') {
      document.getElementById('connectorPanel').style.display = 'none';
      document.getElementById('googleAdsPanel').style.display = 'none';
      document.getElementById('ga4Panel').style.display = 'none';
      document.getElementById('gscPanel').style.display = 'none';
      document.getElementById('gtmPanel').style.display = 'none';
      document.getElementById('metaAdsPanel').style.display = 'none';
      document.getElementById('tiktokAdsPanel').style.display = 'none';
      document.getElementById('linkedinAdsPanel').style.display = 'none';
      document.getElementById('stripePanel').style.display = 'none';
      document.getElementById('shopifyPanel').style.display = 'none';
      document.getElementById('hubspotPanel').style.display = 'none';
      document.getElementById('salesforcePanel').style.display = 'none';
      document.getElementById('quickbooksPanel').style.display = 'none';
      document.getElementById('mailchimpPanel').style.display = 'none';
      document.getElementById('paypalPanel').style.display = 'none';
      document.getElementById('githubPanel').style.display = 'none';
      document.getElementById('todoistPanel').style.display = 'none';
      document.getElementById('telegramPanel').style.display = 'none';
      document.getElementById('awsPanel').style.display = 'none';
      document.getElementById('vercelPanel').style.display = 'none';
      document.getElementById('notionPanel').style.display = 'block';
      notionInit();
      return;
    }

    // GitHub gets its own rich panel
    if (slug === 'github') {
      document.getElementById('connectorPanel').style.display = 'none';
      document.getElementById('googleAdsPanel').style.display = 'none';
      document.getElementById('ga4Panel').style.display = 'none';
      document.getElementById('gscPanel').style.display = 'none';
      document.getElementById('gtmPanel').style.display = 'none';
      document.getElementById('metaAdsPanel').style.display = 'none';
      document.getElementById('tiktokAdsPanel').style.display = 'none';
      document.getElementById('linkedinAdsPanel').style.display = 'none';
      document.getElementById('stripePanel').style.display = 'none';
      document.getElementById('shopifyPanel').style.display = 'none';
      document.getElementById('hubspotPanel').style.display = 'none';
      document.getElementById('salesforcePanel').style.display = 'none';
      document.getElementById('quickbooksPanel').style.display = 'none';
      document.getElementById('mailchimpPanel').style.display = 'none';
      document.getElementById('paypalPanel').style.display = 'none';
      document.getElementById('notionPanel').style.display = 'none';
      document.getElementById('todoistPanel').style.display = 'none';
      document.getElementById('telegramPanel').style.display = 'none';
      document.getElementById('awsPanel').style.display = 'none';
      document.getElementById('vercelPanel').style.display = 'none';
      document.getElementById('githubPanel').style.display = 'block';
      ghInit();
      return;
    }

    // Todoist gets its own rich panel
    if (slug === 'todoist') {
      document.getElementById('connectorPanel').style.display = 'none';
      document.getElementById('googleAdsPanel').style.display = 'none';
      document.getElementById('ga4Panel').style.display = 'none';
      document.getElementById('gscPanel').style.display = 'none';
      document.getElementById('gtmPanel').style.display = 'none';
      document.getElementById('metaAdsPanel').style.display = 'none';
      document.getElementById('tiktokAdsPanel').style.display = 'none';
      document.getElementById('linkedinAdsPanel').style.display = 'none';
      document.getElementById('stripePanel').style.display = 'none';
      document.getElementById('shopifyPanel').style.display = 'none';
      document.getElementById('hubspotPanel').style.display = 'none';
      document.getElementById('salesforcePanel').style.display = 'none';
      document.getElementById('quickbooksPanel').style.display = 'none';
      document.getElementById('mailchimpPanel').style.display = 'none';
      document.getElementById('paypalPanel').style.display = 'none';
      document.getElementById('notionPanel').style.display = 'none';
      document.getElementById('githubPanel').style.display = 'none';
      document.getElementById('telegramPanel').style.display = 'none';
      document.getElementById('awsPanel').style.display = 'none';
      document.getElementById('vercelPanel').style.display = 'none';
      document.getElementById('todoistPanel').style.display = 'block';
      tdInit();
      return;
    }

    // Telegram gets its own rich panel
    if (slug === 'telegram') {
      document.getElementById('connectorPanel').style.display = 'none';
      document.getElementById('googleAdsPanel').style.display = 'none';
      document.getElementById('ga4Panel').style.display = 'none';
      document.getElementById('gscPanel').style.display = 'none';
      document.getElementById('gtmPanel').style.display = 'none';
      document.getElementById('metaAdsPanel').style.display = 'none';
      document.getElementById('tiktokAdsPanel').style.display = 'none';
      document.getElementById('linkedinAdsPanel').style.display = 'none';
      document.getElementById('stripePanel').style.display = 'none';
      document.getElementById('shopifyPanel').style.display = 'none';
      document.getElementById('hubspotPanel').style.display = 'none';
      document.getElementById('salesforcePanel').style.display = 'none';
      document.getElementById('quickbooksPanel').style.display = 'none';
      document.getElementById('mailchimpPanel').style.display = 'none';
      document.getElementById('paypalPanel').style.display = 'none';
      document.getElementById('notionPanel').style.display = 'none';
      document.getElementById('githubPanel').style.display = 'none';
      document.getElementById('todoistPanel').style.display = 'none';
      document.getElementById('awsPanel').style.display = 'none';
      document.getElementById('vercelPanel').style.display = 'none';
      document.getElementById('telegramPanel').style.display = 'block';
      tgInit();
      return;
    }

    // AWS gets its own rich panel
    if (slug === 'aws') {
      document.getElementById('connectorPanel').style.display = 'none';
      document.getElementById('googleAdsPanel').style.display = 'none';
      document.getElementById('ga4Panel').style.display = 'none';
      document.getElementById('gscPanel').style.display = 'none';
      document.getElementById('gtmPanel').style.display = 'none';
      document.getElementById('metaAdsPanel').style.display = 'none';
      document.getElementById('tiktokAdsPanel').style.display = 'none';
      document.getElementById('linkedinAdsPanel').style.display = 'none';
      document.getElementById('stripePanel').style.display = 'none';
      document.getElementById('shopifyPanel').style.display = 'none';
      document.getElementById('hubspotPanel').style.display = 'none';
      document.getElementById('salesforcePanel').style.display = 'none';
      document.getElementById('quickbooksPanel').style.display = 'none';
      document.getElementById('mailchimpPanel').style.display = 'none';
      document.getElementById('paypalPanel').style.display = 'none';
      document.getElementById('notionPanel').style.display = 'none';
      document.getElementById('githubPanel').style.display = 'none';
      document.getElementById('todoistPanel').style.display = 'none';
      document.getElementById('telegramPanel').style.display = 'none';
      document.getElementById('vercelPanel').style.display = 'none';
      document.getElementById('awsPanel').style.display = 'block';
      awsInit();
      return;
    }

    // Vercel gets its own rich panel
    if (slug === 'vercel') {
      document.getElementById('connectorPanel').style.display = 'none';
      document.getElementById('googleAdsPanel').style.display = 'none';
      document.getElementById('ga4Panel').style.display = 'none';
      document.getElementById('gscPanel').style.display = 'none';
      document.getElementById('gtmPanel').style.display = 'none';
      document.getElementById('metaAdsPanel').style.display = 'none';
      document.getElementById('tiktokAdsPanel').style.display = 'none';
      document.getElementById('linkedinAdsPanel').style.display = 'none';
      document.getElementById('stripePanel').style.display = 'none';
      document.getElementById('shopifyPanel').style.display = 'none';
      document.getElementById('hubspotPanel').style.display = 'none';
      document.getElementById('salesforcePanel').style.display = 'none';
      document.getElementById('quickbooksPanel').style.display = 'none';
      document.getElementById('mailchimpPanel').style.display = 'none';
      document.getElementById('paypalPanel').style.display = 'none';
      document.getElementById('notionPanel').style.display = 'none';
      document.getElementById('githubPanel').style.display = 'none';
      document.getElementById('todoistPanel').style.display = 'none';
      document.getElementById('telegramPanel').style.display = 'none';
      document.getElementById('awsPanel').style.display = 'none';
      document.getElementById('vercelPanel').style.display = 'block';
      vcInit();
      return;
    }

    // All other connectors use generic panel
    document.getElementById('googleAdsPanel').style.display = 'none';
    document.getElementById('ga4Panel').style.display = 'none';
    document.getElementById('gscPanel').style.display = 'none';
    document.getElementById('gtmPanel').style.display = 'none';
    document.getElementById('metaAdsPanel').style.display = 'none';
    document.getElementById('tiktokAdsPanel').style.display = 'none';
    document.getElementById('linkedinAdsPanel').style.display = 'none';
    document.getElementById('stripePanel').style.display = 'none';
    document.getElementById('shopifyPanel').style.display = 'none';
    document.getElementById('hubspotPanel').style.display = 'none';
    document.getElementById('salesforcePanel').style.display = 'none';
    document.getElementById('quickbooksPanel').style.display = 'none';
    document.getElementById('mailchimpPanel').style.display = 'none';
    document.getElementById('paypalPanel').style.display = 'none';
    document.getElementById('notionPanel').style.display = 'none';
    document.getElementById('githubPanel').style.display = 'none';
    document.getElementById('todoistPanel').style.display = 'none';
    document.getElementById('telegramPanel').style.display = 'none';
    document.getElementById('awsPanel').style.display = 'none';
    document.getElementById('vercelPanel').style.display = 'none';
    document.getElementById('connectorPanel').style.display = 'block';
    document.getElementById('panelTitle').textContent = `Configure ${name}`;
    document.getElementById('panelAuthStatus').innerHTML = '';
    document.getElementById('panelFetchResult').textContent = '';
    document.getElementById('panelTestResult').textContent = '';
    document.getElementById('panelSettingsContent').innerHTML = getSettingsHTML(slug);
    const statuses = JSON.parse(localStorage.getItem('connector_statuses') || '{}');
    document.getElementById('connectorConnected').checked = statuses[slug] || false;
    updateAuthStatus();
  }

  function closePanel() {
    document.getElementById('connectorPanel').style.display = 'none';
    document.getElementById('googleAdsPanel').style.display = 'none';
    document.getElementById('ga4Panel').style.display = 'none';
    document.getElementById('gscPanel').style.display = 'none';
    document.getElementById('gtmPanel').style.display = 'none';
    document.getElementById('metaAdsPanel').style.display = 'none';
    document.getElementById('tiktokAdsPanel').style.display = 'none';
    document.getElementById('linkedinAdsPanel').style.display = 'none';
    document.getElementById('stripePanel').style.display = 'none';
    document.getElementById('shopifyPanel').style.display = 'none';
    document.getElementById('hubspotPanel').style.display = 'none';
    document.getElementById('salesforcePanel').style.display = 'none';
    document.getElementById('quickbooksPanel').style.display = 'none';
    document.getElementById('mailchimpPanel').style.display = 'none';
    document.getElementById('paypalPanel').style.display = 'none';
    document.getElementById('notionPanel').style.display = 'none';
    document.getElementById('githubPanel').style.display = 'none';
    document.getElementById('todoistPanel').style.display = 'none';
    document.getElementById('telegramPanel').style.display = 'none';
    document.getElementById('awsPanel').style.display = 'none';
    document.getElementById('vercelPanel').style.display = 'none';
    document.getElementById('connectorsList').style.display = 'block';
    currentConnector = null;
  }

  function getSettingsHTML(slug) {
    // GA4 and Google Ads have their own rich panels — no generic settings needed
    return '<p class="text-muted">No specific settings for this connector yet.</p>';
  }

  async function mockConnectPanel() {
    document.getElementById('panelAuthStatus').innerHTML = '<div class="alert alert-success">Mock connected! Account: test@demo.com</div>';
    try {
      await fetch(`/api/connectors/${currentConnector.slug}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: 'Connected', config: { account: 'test@demo.com' } })
      });
      loadConnectorStatuses();
    } catch (err) {
      console.error('Error saving connector status', err);
    }
  }

  function mockFetchPanel() {
    const mockData = {
      'ga4': { sessions: 8923, users: 6124, bounce_rate: "42.1%", top_pages: [{ page: "/home", views: 3456 }, { page: "/products", views: 2345 }] },
      'github': { recent_commits: [{ sha: "a1b2c3d4", message: "Fix auth bug", author: "john.doe" }, { sha: "e5f6g7h8", message: "Add feature", author: "jane.smith" }] },
      'stripe': { mrr: "$4,812", active_subs: 231, recent_charges: [{ id: "ch_123", amount: "$29.99", customer: "user@example.com" }] },
      'meta-ads': { campaigns: [{ name: "Brand Awareness", spend: "$567", impressions: 123456 }, { name: "Lead Gen", spend: "$890", impressions: 234567 }] },
    };
    const data = mockData[currentConnector.slug] || { message: "Mock data for " + currentConnector.slug };
    document.getElementById('panelFetchResult').textContent = JSON.stringify(data, null, 2);
  }

  function mockTestPanel() {
    document.getElementById('panelTestResult').innerHTML = '<div class="alert alert-info">Test successful! Response time: 320ms</div>';
  }

  async function saveConnectorConfigPanel() {
    const connected = document.getElementById('connectorConnected').checked;
    const status = connected ? 'Connected' : 'Disconnected';
    try {
      await fetch(`/api/connectors/${currentConnector.slug}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status, config: {} })
      });
    } catch (err) { console.error('Error saving:', err); }
    const statuses = JSON.parse(localStorage.getItem('connector_statuses') || '{}');
    statuses[currentConnector.slug] = connected;
    localStorage.setItem('connector_statuses', JSON.stringify(statuses));
    updateBadge(currentConnector.slug, connected);
    await loadConnectorStatuses();
    if (window.showToast) window.showToast('Connector Saved', currentConnector.name + ' configuration updated.', 'success');
    closePanel();
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // GOOGLE ADS: Full Mock Connector Engine
  // ═══════════════════════════════════════════════════════════════════════════

  let gadsState = {
    accounts: [],
    selectedAccount: null,
    campaigns: [],
    summary: null,
    sortCol: null,
    sortDir: 1,
    lastReport: null,
    connected: false,
    mccId: ''
  };

  async function gadsInit() {
    function normalizeGadsAccount(raw) {
      if (!raw || typeof raw !== 'object') return null;
      const parseId = (v) => {
        if (v === undefined || v === null) return '';
        let s = String(v).trim();
        if (!s) return '';
        const m = s.match(/customers\/([0-9-]+)/i);
        if (m) s = m[1];
        const digits = s.replace(/\D/g, '');
        if (digits.length === 10) return `${digits.slice(0,3)}-${digits.slice(3,6)}-${digits.slice(6)}`;
        return s;
      };
      const id = parseId(raw.id || raw.account_id || raw.accountId || raw.customer_id || raw.customerId || raw.cid || raw.resourceName || raw.resource_name);
      if (!id) return null;
      const typeRaw = String(raw.type || '').toUpperCase();
      const isManager = !!(raw.isManager || raw.manager || raw.is_manager);
      const type = (typeRaw === 'MCC' || typeRaw === 'MANAGER' || isManager) ? 'MCC' : 'Client';
      return {
        id,
        name: raw.name || raw.descriptiveName || raw.customerName || raw.label || `Account ${id}`,
        type,
        currency: raw.currency || raw.currencyCode || 'USD',
        timezone: raw.timezone || raw.timeZone || 'UTC'
      };
    }

    function normalizeMccId(value) {
      const digits = String(value || '').replace(/\D/g, '');
      if (digits.length === 10) {
        return `${digits.slice(0, 3)}-${digits.slice(3, 6)}-${digits.slice(6)}`;
      }
      return digits ? String(value || '').trim() : '';
    }

    async function refreshAccounts(preserveSelection) {
      const sel = document.getElementById('gadsAccountSelect');
      const prevSelected = preserveSelection ? String(sel.value || '') : '';
      try {
        const qs = gadsState.mccId ? (`?mcc_id=${encodeURIComponent(gadsState.mccId)}`) : '';
        const res = await fetch('/api/connectors/google-ads/accounts' + qs);
        const data = await res.json();
        const rawAccounts = Array.isArray(data.accounts) ? data.accounts : [];
        gadsState.accounts = rawAccounts.map(normalizeGadsAccount).filter(Boolean);
        sel.innerHTML = '<option value="">— Select Account —</option>';
        gadsState.accounts.forEach(a => {
          const opt = document.createElement('option');
          opt.value = a.id;
          opt.textContent = `${a.type === 'MCC' ? '👑 ' : ''}${a.name} (${a.id})`;
          sel.appendChild(opt);
        });
        const hasPrev = prevSelected && gadsState.accounts.some(a => String(a.id) === prevSelected);
        if (hasPrev) {
          sel.value = prevSelected;
        } else {
          const firstClient = gadsState.accounts.find(a => a.type === 'Client');
          if (firstClient) sel.value = firstClient.id;
        }
      } catch (e) { console.error('Failed to load accounts:', e); }
    }

    window.gadsApplyMccId = async function gadsApplyMccId() {
      const input = document.getElementById('gadsMccId');
      const nextMccId = normalizeMccId(input ? input.value : '');
      gadsState.mccId = nextMccId;
      if (input) input.value = nextMccId;
      try { localStorage.setItem('gads_mcc_id', nextMccId || ''); } catch (e) {}
      await refreshAccounts(true);
      if (window.showToast) {
        if (nextMccId) {
          window.showToast('Google Ads', `MCC filter applied: ${nextMccId}`, 'info');
        } else {
          window.showToast('Google Ads', 'MCC filter cleared.', 'info');
        }
      }
    };

    // Check connection status
    try {
      const res = await fetch('/api/connectors/google-ads');
      const data = await res.json();
      gadsState.connected = data.status === 'Connected';
      const cfg = (data && typeof data.config === 'object' && data.config) ? data.config : {};
      const cfgDaysRaw = String(cfg.date_range || '').toLowerCase();
      const daysSelect = document.getElementById('gadsDateRange');
      if (daysSelect) {
        const daysParsed = cfgDaysRaw.includes('7') ? '7'
          : cfgDaysRaw.includes('14') ? '14'
          : cfgDaysRaw.includes('60') ? '60'
          : cfgDaysRaw.includes('90') ? '90'
          : '30';
        daysSelect.value = daysParsed;
      }
      const persistedMcc = normalizeMccId(cfg.mcc_id || cfg.mccId || '');
      const localMcc = normalizeMccId(localStorage.getItem('gads_mcc_id') || '');
      gadsState.mccId = persistedMcc || localMcc || '';
      const badge = document.getElementById('gadsConnBadge');
      badge.textContent = gadsState.connected ? 'Connected' : 'Disconnected';
      badge.className = gadsState.connected ? 'badge bg-success' : 'badge bg-secondary';
    } catch (e) {
      gadsState.mccId = normalizeMccId(localStorage.getItem('gads_mcc_id') || '');
    }

    const mccInput = document.getElementById('gadsMccId');
    if (mccInput) mccInput.value = gadsState.mccId || '';
    await refreshAccounts(false);

    // enable tooltips in panel
    if (window.bootstrap && typeof window.bootstrap.Tooltip === 'function') {
      document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(function(el) {
        if (!el._bsTooltip) {
          try { el._bsTooltip = new window.bootstrap.Tooltip(el); } catch (e) {}
        }
      });
    }
  }

  async function gadsConnect() {
    const badge = document.getElementById('gadsConnBadge');
    badge.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Connecting...';
    badge.className = 'badge bg-info';

    // Fake delay
    await new Promise(r => setTimeout(r, 1200));

    gadsState.connected = true;
    badge.textContent = 'Connected';
    badge.className = 'badge bg-success';

    // Save to DB
    try {
      await fetch('/api/connectors/google-ads', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: 'Connected', config: { account: 'ads-manager@camarad.ai', mcc_id: gadsState.mccId || '' } })
      });
      loadConnectorStatuses();
    } catch (e) {}

    if (window.showToast) window.showToast('Google Ads', 'Connected successfully! Loading account data...', 'success');
    gadsLoadAccount();
  }

  async function gadsLoadAccount() {
    const accountId = document.getElementById('gadsAccountSelect').value;
    if (!accountId) return;
    const days = parseInt((document.getElementById('gadsDateRange') || {}).value || '30', 10) || 30;

    const acct = gadsState.accounts.find(a => a.id === accountId);
    gadsState.selectedAccount = acct;
    document.getElementById('gadsAccountInfo').textContent = acct
      ? `${acct.currency} · ${acct.timezone}`
      : '';

    // Load campaigns
    try {
      const mccQs = gadsState.mccId ? `&mcc_id=${encodeURIComponent(gadsState.mccId)}` : '';
      const res = await fetch(`/api/connectors/google-ads/campaigns?account_id=${accountId}&days=${days}${mccQs}`);
      const data = await res.json();
      gadsState.campaigns = data.campaigns || [];
      gadsState.summary = data.summary || {};
      gadsRenderOverview();
      gadsRenderCampaigns();
      gadsRenderPacing();
    } catch (e) { console.error('Failed to load campaigns:', e); }
  }

  // ── Overview Rendering ──────────────────────────────────────────────────
  function gadsRenderOverview() {
    const s = gadsState.summary;
    if (!s) return;
    const pct = s.budget_utilization || 0;
    const pctClass = pct < 70 ? 'bg-success' : (pct < 90 ? 'bg-warning' : 'bg-danger');

    document.getElementById('gadsOverviewContent').innerHTML = `
      <div class="row g-3 mb-4">
        <div class="col-md-3">
          <div class="card bg-dark border-info h-100">
            <div class="card-body text-center">
              <div class="text-muted small">Active Campaigns</div>
              <div class="display-6 text-info">${s.active_campaigns}<small class="text-muted fs-6">/${s.total_campaigns}</small></div>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-dark border-success h-100">
            <div class="card-body text-center">
              <div class="text-muted small">Total Spend</div>
              <div class="display-6 text-success">$${s.total_spent.toLocaleString()}</div>
              <div class="text-muted small">of $${s.total_budget.toLocaleString()} budget</div>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-dark border-primary h-100">
            <div class="card-body text-center">
              <div class="text-muted small">Total Conversions</div>
              <div class="display-6 text-primary">${s.total_conversions.toLocaleString()}</div>
              <div class="text-muted small">${s.total_clicks.toLocaleString()} clicks</div>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-dark border-warning h-100">
            <div class="card-body text-center">
              <div class="text-muted small">Avg. ROAS</div>
              <div class="display-6 text-warning">${s.avg_roas}x</div>
              <div class="text-muted small">${s.total_impressions.toLocaleString()} impr.</div>
            </div>
          </div>
        </div>
      </div>
      <div class="card bg-dark border-secondary">
        <div class="card-body">
          <div class="d-flex justify-content-between mb-1">
            <span class="small">Budget Utilization</span>
            <span class="small fw-bold">${pct}%</span>
          </div>
          <div class="progress" style="height: 20px;">
            <div class="progress-bar ${pctClass} progress-bar-striped progress-bar-animated"
                 role="progressbar" style="width: ${pct}%">${pct}%</div>
          </div>
          <div class="d-flex justify-content-between mt-1">
            <span class="small text-muted">$${s.total_spent.toLocaleString()} spent</span>
            <span class="small text-muted">$${(s.total_budget - s.total_spent).toLocaleString()} remaining</span>
          </div>
        </div>
      </div>
    `;
  }

  // ── Campaigns Table ─────────────────────────────────────────────────────
  function gadsRenderCampaigns(filter, minRoas, minSpend) {
    filter = filter || 'all';
    minRoas = minRoas || 0;
    minSpend = minSpend || 0;
    let camps = gadsState.campaigns;
    if (filter !== 'all') camps = camps.filter(c => c.status === filter);
    if (minRoas > 0) camps = camps.filter(c => c.roas >= minRoas);
    if (minSpend > 0) camps = camps.filter(c => c.spent >= minSpend);

    // Sort
    if (gadsState.sortCol) {
      camps.sort((a, b) => {
        const va = a[gadsState.sortCol], vb = b[gadsState.sortCol];
        return (typeof va === 'string' ? va.localeCompare(vb) : va - vb) * gadsState.sortDir;
      });
    }

    const body = document.getElementById('gadsCampaignsBody');
    body.innerHTML = '';
    camps.forEach(c => {
      const statusBadge = c.status === 'ENABLED'
        ? '<span class="badge bg-success">Enabled</span>'
        : '<span class="badge bg-secondary">Paused</span>';
      const roasClass = c.roas >= 4 ? 'text-success' : (c.roas >= 3 ? 'text-warning' : 'text-danger');
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="fw-semibold">${c.name}</td>
        <td><span class="badge bg-outline-secondary border">${c.type}</span></td>
        <td>${statusBadge}</td>
        <td>${c.impressions.toLocaleString()}</td>
        <td>${c.clicks.toLocaleString()}</td>
        <td>${c.ctr}%</td>
        <td>$${c.avg_cpc.toFixed(2)}</td>
        <td>$${c.spent.toLocaleString()}</td>
        <td>${c.conversions}</td>
        <td>$${c.cost_per_conv.toFixed(2)}</td>
        <td class="${roasClass} fw-bold">${c.roas}x</td>
        <td>
          <button class="btn btn-sm btn-outline-info py-0 px-1" onclick="gadsShowKeywords('${c.id}', '${c.name}')" title="Keywords">
            <i class="bi bi-key"></i>
          </button>
          <button class="btn btn-sm btn-outline-warning py-0 px-1" onclick="gadsToggleCampaign('${c.id}')" title="Toggle status">
            <i class="bi bi-${c.status === 'ENABLED' ? 'pause' : 'play'}"></i>
          </button>
        </td>
      `;
      body.appendChild(tr);
    });

    // Footer totals
    if (camps.length > 0) {
      const totals = camps.reduce((acc, c) => ({
        impressions: acc.impressions + c.impressions,
        clicks: acc.clicks + c.clicks,
        spent: acc.spent + c.spent,
        conversions: acc.conversions + c.conversions
      }), { impressions: 0, clicks: 0, spent: 0, conversions: 0 });
      const avgRoas = (camps.reduce((s, c) => s + c.roas, 0) / camps.length).toFixed(2);
      const foot = document.getElementById('gadsCampaignsFoot');
      foot.innerHTML = `<tr class="fw-bold table-secondary">
        <td>TOTAL (${camps.length})</td><td></td><td></td>
        <td>${totals.impressions.toLocaleString()}</td>
        <td>${totals.clicks.toLocaleString()}</td>
        <td>${(totals.clicks / totals.impressions * 100).toFixed(2)}%</td>
        <td>$${(totals.spent / totals.clicks).toFixed(2)}</td>
        <td>$${totals.spent.toLocaleString()}</td>
        <td>${totals.conversions}</td>
        <td>$${(totals.spent / totals.conversions).toFixed(2)}</td>
        <td class="text-warning">${avgRoas}x</td>
        <td></td>
      </tr>`;
    }
  }

  function gadsFilterCampaigns() {
    const status = document.getElementById('gadsCampFilter').value;
    const minRoas = parseFloat(document.getElementById('gadsCampMinRoas').value) || 0;
    const minSpend = parseFloat(document.getElementById('gadsCampMinSpend').value) || 0;
    gadsRenderCampaigns(status, minRoas, minSpend);
  }

  function gadsSortCampaigns(col) {
    if (gadsState.sortCol === col) gadsState.sortDir *= -1;
    else { gadsState.sortCol = col; gadsState.sortDir = 1; }
    gadsFilterCampaigns();
  }

  function gadsToggleCampaign(campId) {
    const c = gadsState.campaigns.find(x => x.id === campId);
    if (c) {
      c.status = c.status === 'ENABLED' ? 'PAUSED' : 'ENABLED';
      gadsFilterCampaigns();
      if (window.showToast) window.showToast('Campaign Updated', `${c.name} → ${c.status}`, 'info');
    }
  }

  async function gadsShowKeywords(campId, campName) {
    document.getElementById('gadsKeywordsTitle').textContent = `Keywords — ${campName}`;
    document.getElementById('gadsKeywordsPanel').style.display = 'block';
    const body = document.getElementById('gadsKeywordsBody');

    body.innerHTML = '<tr><td colspan="8" class="text-center"><span class="spinner-border spinner-border-sm"></span> Loading...</td></tr>';

    try {
      const mccQs = gadsState.mccId ? `&mcc_id=${encodeURIComponent(gadsState.mccId)}` : '';
      const accountId = (document.getElementById('gadsAccountSelect') || {}).value || '';
      const accQs = accountId ? `&account_id=${encodeURIComponent(accountId)}` : '';
      const res = await fetch(`/api/connectors/google-ads/keywords?campaign_id=${campId}${accQs}${mccQs}`);
      const data = await res.json();
      body.innerHTML = '';
      if (data.keywords && data.keywords.length > 0) {
        data.keywords.forEach(k => {
          const qsColor = k.quality_score >= 8 ? 'text-success' : (k.quality_score >= 6 ? 'text-warning' : 'text-danger');
          body.innerHTML += `<tr>
            <td>${k.keyword}</td>
            <td><span class="badge bg-outline-secondary border">${k.match_type}</span></td>
            <td>${k.status === 'ENABLED' ? '<span class="badge bg-success">Active</span>' : '<span class="badge bg-secondary">Paused</span>'}</td>
            <td>${k.impressions.toLocaleString()}</td>
            <td>${k.clicks.toLocaleString()}</td>
            <td>${k.ctr}%</td>
            <td>$${k.avg_cpc.toFixed(2)}</td>
            <td class="${qsColor} fw-bold">${k.quality_score}/10</td>
          </tr>`;
        });
      } else {
        body.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No keywords found for this campaign.</td></tr>';
      }
    } catch (e) {
      body.innerHTML = '<tr><td colspan="8" class="text-danger">Error loading keywords.</td></tr>';
    }
  }

  function gadsExportCampaignsCSV() {
    if (!gadsState.campaigns.length) return;
    const headers = ['Campaign', 'Type', 'Status', 'Impressions', 'Clicks', 'CTR', 'Avg CPC', 'Cost', 'Conversions', 'Cost/Conv', 'ROAS'];
    const rows = gadsState.campaigns.map(c => [
      c.name, c.type, c.status, c.impressions, c.clicks, c.ctr + '%', '$' + c.avg_cpc.toFixed(2),
      '$' + c.spent.toFixed(2), c.conversions, '$' + c.cost_per_conv.toFixed(2), c.roas + 'x'
    ]);
    downloadCSV('google_ads_campaigns.csv', headers, rows);
  }

  // ── Budget Pacing ───────────────────────────────────────────────────────
  function gadsRenderPacing() {
    const container = document.getElementById('gadsPacingContent');
    if (!gadsState.campaigns.length) {
      container.innerHTML = '<p class="text-muted text-center">No campaign data loaded.</p>';
      return;
    }
    let html = '';
    gadsState.campaigns.forEach(c => {
      const pct = Math.min(100, Math.round(c.spent / c.budget_total * 100));
      const barColor = pct < 70 ? 'bg-success' : (pct < 90 ? 'bg-warning' : 'bg-danger');
      const daysLeft = c.status === 'ENABLED' ? Math.max(1, Math.round((c.budget_total - c.spent) / c.budget_daily)) : 0;
      const statusIcon = pct < 70 ? '🟢' : (pct < 90 ? '🟡' : '🔴');
      html += `
        <div class="card bg-dark border-secondary mb-3">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div>
                <strong>${c.name}</strong>
                <span class="badge ${c.status === 'ENABLED' ? 'bg-success' : 'bg-secondary'} ms-2">${c.status}</span>
              </div>
              <div class="text-end">
                <span class="small">${statusIcon} $${c.spent.toLocaleString()} / $${c.budget_total.toLocaleString()}</span>
              </div>
            </div>
            <div class="progress mb-2" style="height: 24px;">
              <div class="progress-bar ${barColor} progress-bar-striped ${c.status === 'ENABLED' ? 'progress-bar-animated' : ''}"
                   role="progressbar" style="width: ${pct}%">${pct}%</div>
            </div>
            <div class="d-flex justify-content-between small text-muted">
              <span>Daily: $${c.budget_daily}/day</span>
              <span>Remaining: $${(c.budget_total - c.spent).toFixed(2)}</span>
              <span>${c.status === 'ENABLED' ? `~${daysLeft} days left` : 'Paused'}</span>
            </div>
          </div>
        </div>
      `;
    });
    container.innerHTML = html;
  }

  // ── Reports ─────────────────────────────────────────────────────────────
  async function gadsGenerateReport() {
    const accountId = document.getElementById('gadsAccountSelect').value;
    const reportType = document.getElementById('gadsReportType').value;
    const days = parseInt((document.getElementById('gadsDateRange') || {}).value || '30', 10) || 30;
    const container = document.getElementById('gadsReportResult');

    container.innerHTML = '<div class="text-center py-3"><span class="spinner-border"></span> Generating report...</div>';

    try {
      const mccQs = gadsState.mccId ? `&mcc_id=${encodeURIComponent(gadsState.mccId)}` : '';
      const res = await fetch(`/api/connectors/google-ads/reports?account_id=${accountId}&type=${reportType}&days=${days}${mccQs}`);
      const data = await res.json();
      gadsState.lastReport = data;

      if (!data.rows || data.rows.length === 0) {
        container.innerHTML = '<div class="alert alert-warning">No data available for this report.</div>';
        return;
      }

      const headers = Object.keys(data.rows[0]);
      let html = `<div class="small text-muted mb-2">Generated: ${data.generated_at} · ${data.rows.length} rows</div>`;
      html += '<div class="table-responsive"><table class="table table-dark table-striped table-sm"><thead><tr>';
      headers.forEach(h => html += `<th>${h}</th>`);
      html += '</tr></thead><tbody>';
      data.rows.forEach(row => {
        html += '<tr>';
        headers.forEach(h => {
          let val = row[h];
          // Color-code status indicators
          if (typeof val === 'string' && val.startsWith('🟢')) html += `<td class="text-success">${val}</td>`;
          else if (typeof val === 'string' && val.startsWith('🟡')) html += `<td class="text-warning">${val}</td>`;
          else if (typeof val === 'string' && val.startsWith('🔴')) html += `<td class="text-danger">${val}</td>`;
          else html += `<td>${val}</td>`;
        });
        html += '</tr>';
      });
      html += '</tbody></table></div>';
      container.innerHTML = html;
    } catch (e) {
      container.innerHTML = '<div class="alert alert-danger">Error generating report.</div>';
    }
  }

  function gadsExportReportCSV() {
    if (!gadsState.lastReport || !gadsState.lastReport.rows || !gadsState.lastReport.rows.length) {
      if (window.showToast) window.showToast('Export', 'Generate a report first.', 'warning');
      return;
    }
    const headers = Object.keys(gadsState.lastReport.rows[0]);
    const rows = gadsState.lastReport.rows.map(r => headers.map(h => r[h]));
    downloadCSV('google_ads_report.csv', headers, rows);
  }

  // ── Asset Generator ─────────────────────────────────────────────────────
  async function gadsGenerateAssets() {
    const product = document.getElementById('gadsAssetProduct').value.trim() || 'Premium Product';
    const tone = document.getElementById('gadsAssetTone').value;
    const lang = document.getElementById('gadsAssetLang').value;
    const container = document.getElementById('gadsAssetsResult');

    container.innerHTML = '<div class="text-center py-3"><span class="spinner-border"></span> Generating assets for "<strong>' + product + '</strong>"...</div>';

    try {
      const res = await fetch('/api/connectors/google-ads/generate-assets', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ product, tone, language: lang })
      });
      const data = await res.json();

      let html = '';

      // Google-style Ad Preview Card
      if (data.rsa_preview) {
        const p = data.rsa_preview;
        html += `
          <div class="card border-0 mb-4" style="background:#1a1a2e; border-radius:12px; overflow:hidden;">
            <div class="card-header d-flex align-items-center gap-2" style="background:#16213e; border:none;">
              <i class="bi bi-eye text-info"></i>
              <span class="fw-bold small">Live Ad Preview — Google Search</span>
              <span class="badge bg-secondary ms-auto">Desktop</span>
            </div>
            <div class="card-body" style="font-family: Arial, sans-serif; max-width:650px;">
              <div class="small" style="color:#969ba1;">Sponsored · www.${product.toLowerCase().replace(/\s+/g,'-')}.com</div>
              <a href="#" class="d-block mt-1 mb-1 text-decoration-none" style="color:#8ab4f8; font-size:1.15rem; line-height:1.3;">${p.headline_1} | ${p.headline_2} | ${p.headline_3}</a>
              <div style="color:#bdc1c6; font-size:.875rem; line-height:1.4;">${p.description_1}</div>
              <div style="color:#969ba1; font-size:.8rem;" class="mt-1">${p.description_2}</div>
              <div class="d-flex gap-3 mt-2">
                <span style="color:#8ab4f8; font-size:.8rem; cursor:pointer;">Shop Now ›</span>
                <span style="color:#8ab4f8; font-size:.8rem; cursor:pointer;">Free Shipping ›</span>
                <span style="color:#8ab4f8; font-size:.8rem; cursor:pointer;">Reviews ›</span>
              </div>
            </div>
          </div>
        `;
      }

      // Headlines (show first 5 for cleaner output)
      const topHeadlines = data.headlines.slice(0, 5);
      html += '<h6 class="mt-3"><i class="bi bi-type-h1"></i> Headlines <small class="text-muted">(max 30 chars)</small></h6>';
      html += '<div class="table-responsive"><table class="table table-dark table-sm"><thead><tr><th>#</th><th>Text</th><th>Chars</th><th>Status</th><th>Copy</th></tr></thead><tbody>';
      topHeadlines.forEach((h, i) => {
        const ok = h.chars <= 30;
        html += `<tr>
          <td>${i + 1}</td>
          <td>${h.text}</td>
          <td><span class="badge ${ok ? 'bg-success' : 'bg-danger'}">${h.chars}/30</span></td>
          <td>${ok ? '<span class="text-success">✅</span>' : '<span class="text-danger">⚠️ Over</span>'}</td>
          <td><button class="btn btn-sm btn-outline-secondary py-0 px-1" onclick="navigator.clipboard.writeText('${h.text.replace(/'/g,"\\'")}');if(window.showToast)showToast('Copied','Headline copied','info')"><i class="bi bi-clipboard"></i></button></td>
        </tr>`;
      });
      html += '</tbody></table></div>';

      // Descriptions (show first 5)
      const topDescs = data.descriptions.slice(0, 5);
      html += '<h6 class="mt-3"><i class="bi bi-text-paragraph"></i> Descriptions <small class="text-muted">(max 90 chars)</small></h6>';
      html += '<div class="table-responsive"><table class="table table-dark table-sm"><thead><tr><th>#</th><th>Text</th><th>Chars</th><th>Status</th><th>Copy</th></tr></thead><tbody>';
      topDescs.forEach((d, i) => {
        const ok = d.chars <= 90;
        html += `<tr>
          <td>${i + 1}</td>
          <td class="small">${d.text}</td>
          <td><span class="badge ${ok ? 'bg-success' : 'bg-danger'}">${d.chars}/90</span></td>
          <td>${ok ? '<span class="text-success">✅</span>' : '<span class="text-danger">⚠️ Over</span>'}</td>
          <td><button class="btn btn-sm btn-outline-secondary py-0 px-1" onclick="navigator.clipboard.writeText(\`${d.text.replace(/`/g,'\\`')}\`);if(window.showToast)showToast('Copied','Description copied','info')"><i class="bi bi-clipboard"></i></button></td>
        </tr>`;
      });
      html += '</tbody></table></div>';

      container.innerHTML = html;
    } catch (e) {
      container.innerHTML = '<div class="alert alert-danger">Error generating assets.</div>';
    }
  }

  // ── Test API Call ───────────────────────────────────────────────────────
  async function gadsTestApiCall() {
    const method = document.getElementById('gadsApiMethod').value;
    const endpoint = document.getElementById('gadsApiEndpoint').value;
    const container = document.getElementById('gadsApiResult');

    container.innerHTML = '<div class="text-center py-3"><span class="spinner-border spinner-border-sm"></span> Sending request...</div>';

    try {
      const res = await fetch('/api/connectors/google-ads/test-call', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ method, endpoint })
      });
      const data = await res.json();

      container.innerHTML = `
        <div class="row g-3">
          <div class="col-md-6">
            <div class="card bg-dark border-info">
              <div class="card-header bg-info bg-opacity-25 small fw-bold">
                <i class="bi bi-arrow-up-circle"></i> Request
              </div>
              <div class="card-body p-2">
                <pre class="mb-0 small" style="max-height:250px; overflow:auto; color:#8be9fd;">${method} ${endpoint}\n\nHeaders:\n${JSON.stringify(data.request.headers, null, 2)}</pre>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card bg-dark border-success">
              <div class="card-header bg-success bg-opacity-25 small fw-bold">
                <i class="bi bi-arrow-down-circle"></i> Response
                <span class="badge bg-success ms-2">${data.response.status_code}</span>
                <span class="badge bg-secondary ms-1">${data.latency_ms}ms</span>
              </div>
              <div class="card-body p-2">
                <pre class="mb-0 small" style="max-height:250px; overflow:auto; color:#50fa7b;">${JSON.stringify(data.response.body, null, 2)}</pre>
              </div>
            </div>
          </div>
        </div>
        <div class="mt-2 small text-muted">
          <i class="bi bi-speedometer"></i> Quota: ${data.quota.operations_remaining.toLocaleString()} / ${data.quota.daily_limit.toLocaleString()} operations remaining
        </div>
      `;
    } catch (e) {
      container.innerHTML = '<div class="alert alert-danger">API call failed.</div>';
    }
  }

  // ── Settings Save ───────────────────────────────────────────────────────
  async function gadsSaveSettings() {
    const config = {
      level: document.getElementById('gadsSettingLevel').value,
      date_range: document.getElementById('gadsSettingDateRange').value,
      refresh_interval: document.getElementById('gadsSettingRefresh').value,
      metrics: Array.from(document.querySelectorAll('.gads-metric-check:checked')).map(c => c.value)
    };
    try {
      await fetch('/api/connectors/google-ads', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: gadsState.connected ? 'Connected' : 'Disconnected', config: { ...config, mcc_id: gadsState.mccId || '' } })
      });
      if (window.showToast) window.showToast('Settings Saved', 'Google Ads connector settings updated.', 'success');
    } catch (e) {
      if (window.showToast) window.showToast('Error', 'Failed to save settings.', 'danger');
    }
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // GA4: Real-first via Coolbits gateway (mock fallback)
  // ═══════════════════════════════════════════════════════════════════════════

  let ga4State = {
    properties: [],
    selectedProperty: null,
    overview: null,
    pages: [],
    sources: [],
    events: [],
    devices: [],
    countries: [],
    connected: false,
    selectedPropertyId: '',
    sourceMode: ''
  };

  function ga4Num(v) {
    const n = Number(v);
    return Number.isFinite(n) ? n : 0;
  }

  function ga4FmtInt(v) { return ga4Num(v).toLocaleString(); }
  function ga4FmtMoney(v) { return '$' + ga4Num(v).toLocaleString(undefined, { maximumFractionDigits: 2 }); }
  function ga4FmtPct(v) {
    if (v == null || v === '') return '—';
    const n = parseFloat(String(v).replace('%', ''));
    return Number.isFinite(n) ? `${n}%` : String(v);
  }
  function ga4RangeValue() {
    const el = document.getElementById('ga4DateRange');
    return el && el.value ? el.value : '30days';
  }
  function ga4Query(propertyId) {
    const p = new URLSearchParams();
    if (propertyId) p.set('property_id', propertyId);
    p.set('range', ga4RangeValue());
    return p.toString();
  }

  function ga4SetBadge(connected) {
    const badge = document.getElementById('ga4ConnBadge');
    if (!badge) return;
    const mode = ga4State.sourceMode === 'coolbits' ? ' · Live via Coolbits' : (ga4State.sourceMode === 'mock' ? ' · Mock' : '');
    badge.textContent = (connected ? 'Connected' : 'Disconnected') + mode;
    badge.className = connected ? 'badge bg-success' : 'badge bg-secondary';
  }

  function ga4SetSourceMode(source) {
    ga4State.sourceMode = String(source || '').toLowerCase();
    ga4SetBadge(ga4State.connected);
    const info = document.getElementById('ga4PropertyInfo');
    if (info) {
      const p = ga4State.selectedProperty;
      const base = p ? `${p.stream || 'Property'} · ${p.timezone || 'UTC'}` : '';
      const suffix = ga4State.sourceMode === 'coolbits' ? ' · Live via Coolbits' : (ga4State.sourceMode === 'mock' ? ' · Mock (gateway off/fallback)' : '');
      info.textContent = `${base}${suffix}`.trim();
    }
  }

  async function ga4LoadProperties(preferredPropertyId) {
    const sel = document.getElementById('ga4PropertySelect');
    if (!sel) return;
    const previous = preferredPropertyId || sel.value || ga4State.selectedPropertyId || '';
    try {
      const res = await fetch('/api/connectors/ga4/properties');
      const data = await res.json();
      ga4SetSourceMode(data.source || '');
      ga4State.properties = Array.isArray(data.properties) ? data.properties : [];
      sel.innerHTML = '<option value="">— Select Property —</option>';
      ga4State.properties.forEach(p => {
        const opt = document.createElement('option');
        const id = String(p.id || '');
        const name = String(p.name || id || 'Property');
        opt.value = id;
        opt.textContent = `${name} (${id})`;
        sel.appendChild(opt);
      });
      if (previous && ga4State.properties.some(p => String(p.id) === previous)) {
        sel.value = previous;
      } else if (ga4State.properties.length) {
        sel.value = String(ga4State.properties[0].id || '');
      }
      ga4State.selectedPropertyId = sel.value || '';
    } catch (e) {
      console.error('GA4 properties load error:', e);
    }
  }

  async function ga4Init() {
    let preferredPropertyId = '';
    try {
      const res = await fetch('/api/connectors/ga4/status');
      const data = await res.json();
      ga4SetSourceMode(data.source || '');
      ga4State.connected = Boolean(data.connected) || String(data.status || '').toLowerCase() === 'connected';
      preferredPropertyId = String(data.selectedPropertyId || data.propertyId || '');
      ga4State.selectedPropertyId = preferredPropertyId;
    } catch (e) {
      ga4State.connected = false;
    }
    ga4SetBadge(ga4State.connected);
    await ga4LoadProperties(preferredPropertyId);
    if (ga4State.connected && ga4State.selectedPropertyId) {
      ga4LoadProperty();
    }
  }

  function ga4WaitForOAuthPopup(popupRef, timeoutMs) {
    return new Promise((resolve) => {
      let done = false;
      const origin = window.location.origin;
      let timer = null;
      const cleanup = () => {
        window.removeEventListener('message', onMsg);
        if (timer) clearTimeout(timer);
      };
      const onMsg = (event) => {
        if (done) return;
        if (!event || event.origin !== origin) return;
        const data = event.data || {};
        if (String(data.provider || '').toLowerCase() !== 'ga4') return;
        if (String(data.source || '').toLowerCase() !== 'camarad-ga4-oauth') return;
        done = true;
        cleanup();
        resolve(Boolean(data.ok));
      };
      window.addEventListener('message', onMsg);
      timer = setTimeout(() => {
        if (done) return;
        done = true;
        cleanup();
        resolve(false);
      }, Math.max(3000, Number(timeoutMs) || 20000));

      if (popupRef) {
        const closer = setInterval(() => {
          if (done) { clearInterval(closer); return; }
          if (popupRef.closed) { clearInterval(closer); }
        }, 500);
      }
    });
  }

  async function ga4Connect() {
    const badge = document.getElementById('ga4ConnBadge');
    if (badge) {
      badge.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Connecting...';
      badge.className = 'badge bg-info';
    }
    try {
      const authRes = await fetch('/api/connectors/ga4/auth-url');
      const authData = await authRes.json();
      let popup = null;
      if (authRes.ok && authData && authData.url) {
        popup = window.open(String(authData.url), 'ga4_oauth', 'width=980,height=780');
        if (!popup && window.showToast) {
          window.showToast('GA4', 'Popup blocked. Completing OAuth in same tab.', 'warning');
          window.location.href = String(authData.url);
          return;
        }
      } else if (window.showToast) {
        window.showToast('GA4', 'Open GA4 OAuth and finish connection in popup.', 'warning');
      }
      if (popup) {
        const ok = await ga4WaitForOAuthPopup(popup, 24000);
        if (ok) {
          const sres = await fetch('/api/connectors/ga4/status');
          const sdata = await sres.json();
          ga4SetSourceMode(sdata.source || '');
          ga4State.connected = Boolean(sdata.connected) || String(sdata.status || '').toLowerCase() === 'connected';
          ga4SetBadge(ga4State.connected);
          await fetch('/api/connectors/ga4', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: 'Connected', config: { provider: 'coolbits' } })
          });
          await ga4LoadProperties(String(sdata.selectedPropertyId || sdata.propertyId || ''));
          if (window.showToast) window.showToast('GA4', 'Connected! Loading analytics data...', 'success');
          loadConnectorStatuses();
          ga4LoadProperty();
          return;
        }
      }
    } catch (e) {}

    // Poll short window for fresh status.
    for (let i = 0; i < 12; i += 1) {
      await new Promise(r => setTimeout(r, 1000));
      try {
        const sres = await fetch('/api/connectors/ga4/status');
        const sdata = await sres.json();
        ga4SetSourceMode(sdata.source || '');
        const connected = Boolean(sdata.connected) || String(sdata.status || '').toLowerCase() === 'connected';
        if (connected) {
          ga4State.connected = true;
          ga4SetBadge(true);
          await fetch('/api/connectors/ga4', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: 'Connected', config: { provider: 'coolbits' } })
          });
          await ga4LoadProperties(String(sdata.selectedPropertyId || sdata.propertyId || ''));
          if (window.showToast) window.showToast('GA4', 'Connected! Loading analytics data...', 'success');
          loadConnectorStatuses();
          ga4LoadProperty();
          return;
        }
      } catch (e) {}
    }
    ga4SetBadge(false);
    if (window.showToast) window.showToast('GA4', 'Not connected yet. Complete OAuth, then click Connect again.', 'warning');
  }

  async function ga4LoadProperty() {
    const sel = document.getElementById('ga4PropertySelect');
    const propId = sel ? sel.value : '';
    if (!propId) return;

    ga4State.selectedPropertyId = propId;
    ga4State.selectedProperty = ga4State.properties.find(p => String(p.id) === String(propId)) || null;
    const info = document.getElementById('ga4PropertyInfo');
    if (info) {
      const p = ga4State.selectedProperty;
      const base = p ? `${p.stream || 'Property'} · ${p.timezone || 'UTC'}` : '';
      const suffix = ga4State.sourceMode === 'coolbits' ? ' · Live via Coolbits' : (ga4State.sourceMode === 'mock' ? ' · Mock (gateway off/fallback)' : '');
      info.textContent = `${base}${suffix}`.trim();
    }

    try {
      await fetch('/api/connectors/ga4/property', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ propertyId: propId })
      });
    } catch (e) {}

    const query = ga4Query(propId);
    try {
      const [ovRes, pgRes, srcRes, evRes, devRes, cntRes] = await Promise.all([
        fetch(`/api/connectors/ga4/overview?${query}`),
        fetch(`/api/connectors/ga4/pages?${query}`),
        fetch(`/api/connectors/ga4/sources?${query}`),
        fetch(`/api/connectors/ga4/events?${query}`),
        fetch(`/api/connectors/ga4/devices?${query}`),
        fetch(`/api/connectors/ga4/countries?${query}`),
      ]);
      ga4State.overview = await ovRes.json();
      ga4SetSourceMode(ga4State.overview && ga4State.overview.source ? ga4State.overview.source : '');
      const pgData = await pgRes.json(); ga4State.pages = Array.isArray(pgData.pages) ? pgData.pages : [];
      const srcData = await srcRes.json(); ga4State.sources = Array.isArray(srcData.sources) ? srcData.sources : [];
      const evData = await evRes.json(); ga4State.events = Array.isArray(evData.events) ? evData.events : [];
      const devData = await devRes.json(); ga4State.devices = Array.isArray(devData.devices) ? devData.devices : [];
      const cntData = await cntRes.json(); ga4State.countries = Array.isArray(cntData.countries) ? cntData.countries : [];

      ga4RenderOverview();
      ga4RenderPages();
      ga4RenderSources();
      ga4RenderEvents();
      ga4RenderDevices();
      ga4RenderCountries();
      ga4LoadFunnel();
    } catch (e) {
      console.error('GA4 load error:', e);
      if (window.showToast) window.showToast('GA4', 'Failed to load GA4 data.', 'danger');
    }
  }

  // ── Overview ────────────────────────────────────────────────────────────
  function ga4RenderOverview() {
    const o = ga4State.overview;
    if (!o) return;
    if (o.error === 'not_connected') {
      document.getElementById('ga4OverviewContent').innerHTML = '<div class="alert alert-warning">GA4 not connected in Coolbits yet.</div>';
      return;
    }
    const cmp = o.comparison || {};
    const kpiCard = (icon, label, value, comparison, color) => `
      <div class="col-md-3 col-6">
        <div class="card bg-dark border-${color} h-100">
          <div class="card-body text-center py-2">
            <div class="text-muted small"><i class="bi bi-${icon}"></i> ${label}</div>
            <div class="fs-4 fw-bold text-${color}">${value}</div>
            ${comparison ? `<div class="small ${String(comparison).startsWith('+') ? 'text-success' : 'text-danger'}">${comparison} vs prev.</div>` : ''}
          </div>
        </div>
      </div>`;

    document.getElementById('ga4OverviewContent').innerHTML = `
      <div class="row g-2 mb-3">
        ${kpiCard('graph-up', 'Sessions', ga4FmtInt(o.sessions), cmp.sessions, 'info')}
        ${kpiCard('people', 'Users', ga4FmtInt(o.users), cmp.users, 'primary')}
        ${kpiCard('check-circle', 'Conversions', ga4FmtInt(o.conversions), cmp.conversions, 'success')}
        ${kpiCard('currency-dollar', 'Revenue', ga4FmtMoney(o.revenue), cmp.revenue, 'warning')}
      </div>
      <div class="row g-2 mb-3">
        ${kpiCard('clock', 'Avg. Engagement', o.avg_engagement_time || '—', null, 'secondary')}
        ${kpiCard('arrow-return-left', 'Bounce Rate', o.bounce_rate || '—', null, 'danger')}
        ${kpiCard('heart', 'Engagement Rate', o.engagement_rate || '—', null, 'success')}
        ${kpiCard('lightning', 'Event Count', o.event_count != null ? ga4FmtInt(o.event_count) : '—', null, 'info')}
      </div>
      <div class="row g-2">
        <div class="col-md-4"><div class="card bg-dark border-secondary"><div class="card-body py-2 text-center"><div class="text-muted small">New Users</div><div class="fs-5">${ga4FmtInt(o.new_users)}</div></div></div></div>
        <div class="col-md-4"><div class="card bg-dark border-secondary"><div class="card-body py-2 text-center"><div class="text-muted small">Sessions/User</div><div class="fs-5">${o.sessions_per_user || '—'}</div></div></div></div>
        <div class="col-md-4"><div class="card bg-dark border-secondary"><div class="card-body py-2 text-center"><div class="text-muted small">Views/Session</div><div class="fs-5">${o.views_per_session || '—'}</div></div></div></div>
      </div>`;
  }

  // ── Pages ───────────────────────────────────────────────────────────────
  function ga4RenderPages() {
    const body = document.getElementById('ga4PagesBody');
    body.innerHTML = '';
    ga4State.pages.forEach(p => {
      const bounceVal = parseFloat(String(p.bounce_rate || '').replace('%', ''));
      const bounceClass = Number.isFinite(bounceVal) ? (bounceVal < 35 ? 'text-success' : (bounceVal < 50 ? 'text-warning' : 'text-danger')) : 'text-muted';
      body.innerHTML += `<tr>
        <td class="fw-semibold">${p.path || '—'}</td>
        <td class="small text-muted">${p.title || '—'}</td>
        <td>${ga4FmtInt(p.views)}</td>
        <td>${ga4FmtInt(p.sessions)}</td>
        <td>${ga4FmtInt(p.users)}</td>
        <td>${p.avg_time || '—'}</td>
        <td class="${bounceClass}">${p.bounce_rate || '—'}</td>
        <td>${ga4FmtInt(p.conversions)}</td>
      </tr>`;
    });
  }

  // ── Sources ─────────────────────────────────────────────────────────────
  function ga4RenderSources() {
    const body = document.getElementById('ga4SourcesBody');
    body.innerHTML = '';
    ga4State.sources.forEach(s => {
      body.innerHTML += `<tr>
        <td class="fw-semibold">${s.source || '(unknown)'}</td>
        <td><span class="badge bg-outline-secondary border">${s.medium || '(none)'}</span></td>
        <td>${ga4FmtInt(s.sessions)}</td>
        <td>${ga4FmtInt(s.users)}</td>
        <td>${ga4FmtInt(s.conversions)}</td>
        <td>${ga4FmtMoney(s.revenue)}</td>
        <td>${s.bounce_rate || '—'}</td>
      </tr>`;
    });
  }

  // ── Events ──────────────────────────────────────────────────────────────
  function ga4RenderEvents() {
    const filter = document.getElementById('ga4EventFilter').value;
    let events = ga4State.events;
    if (filter !== 'all') events = events.filter(e => String(e.category || '').toLowerCase() === String(filter).toLowerCase());

    const body = document.getElementById('ga4EventsBody');
    body.innerHTML = '';
    events.forEach(e => {
      const cat = String(e.category || 'Custom');
      const catBadge = cat === 'Auto' ? 'bg-secondary' : (cat === 'Ecommerce' ? 'bg-success' : 'bg-primary');
      body.innerHTML += `<tr>
        <td class="fw-semibold"><i class="bi bi-lightning-charge text-warning"></i> ${e.name || ''}</td>
        <td><span class="badge ${catBadge}">${cat}</span></td>
        <td>${ga4FmtInt(e.count)}</td>
        <td>${ga4FmtInt(e.users)}</td>
        <td>${Number.isFinite(Number(e.per_session)) ? Number(e.per_session).toFixed(2) : '0.00'}</td>
        <td>${e.value ? ga4FmtMoney(e.value) : '—'}</td>
      </tr>`;
    });
  }

  // ── Funnel ──────────────────────────────────────────────────────────────
  async function ga4LoadFunnel() {
    const type = document.getElementById('ga4FunnelType').value;
    const propId = document.getElementById('ga4PropertySelect').value;
    const container = document.getElementById('ga4FunnelContent');
    container.innerHTML = '<div class="text-center py-3"><span class="spinner-border spinner-border-sm"></span></div>';

    try {
      const qs = new URLSearchParams({
        property_id: propId || '',
        range: ga4RangeValue(),
        type: type || 'ecommerce',
      }).toString();
      const res = await fetch(`/api/connectors/ga4/funnel?${qs}`);
      const data = await res.json();

      let html = `<div class="card bg-dark border-secondary mb-3">
        <div class="card-header">${data.name || 'Funnel'} <span class="badge bg-info ms-2">Overall: ${data.overall_conversion || '—'}</span></div>
        <div class="card-body">`;

      (data.steps || []).forEach((step, i) => {
        const width = Math.max(0, Math.min(100, ga4Num(step.pct)));
        const color = i === 0 ? 'bg-info' : (i === (data.steps || []).length - 1 ? 'bg-success' : 'bg-primary');
        html += `
          <div class="mb-3">
            <div class="d-flex justify-content-between mb-1">
              <span class="fw-semibold">${step.name || 'Step'} <span class="text-muted small">(${step.event || ''})</span></span>
              <span>${ga4FmtInt(step.users)} users · <span class="fw-bold">${width}%</span></span>
            </div>
            <div class="progress" style="height: 28px;">
              <div class="progress-bar ${color} progress-bar-striped" role="progressbar" style="width: ${width}%">${width}%</div>
            </div>
            ${step.drop_off != null ? `<div class="small text-danger mt-1">↓ ${ga4Num(step.drop_off)}% drop-off</div>` : ''}
          </div>`;
      });

      html += '</div></div>';
      container.innerHTML = html;
    } catch (e) {
      container.innerHTML = '<div class="alert alert-danger">Error loading funnel.</div>';
    }
  }

  // ── Devices ─────────────────────────────────────────────────────────────
  function ga4RenderDevices() {
    const container = document.getElementById('ga4DevicesContent');
    if (!ga4State.devices.length) { container.innerHTML = '<p class="text-muted">No data.</p>'; return; }

    let html = '';
    const icons = { desktop: 'bi-laptop', mobile: 'bi-phone', tablet: 'bi-tablet' };
    const colors = { desktop: 'bg-info', mobile: 'bg-success', tablet: 'bg-warning' };

    ga4State.devices.forEach(d => {
      const category = String(d.category || 'unknown').toLowerCase();
      const pct = ga4Num(d.pct);
      html += `
        <div class="card bg-dark border-secondary mb-2">
          <div class="card-body py-2">
            <div class="d-flex justify-content-between align-items-center mb-1">
              <span><i class="bi ${icons[category] || 'bi-device-hdd'}"></i> <strong>${category}</strong></span>
              <span class="fw-bold">${pct}%</span>
            </div>
            <div class="progress mb-1" style="height: 16px;">
              <div class="progress-bar ${colors[category] || 'bg-primary'}" style="width: ${pct}%">${pct}%</div>
            </div>
            <div class="d-flex justify-content-between small text-muted">
              <span>${ga4FmtInt(d.sessions)} sessions</span>
              <span>${ga4FmtInt(d.conversions)} conv.</span>
              <span>Bounce: ${d.bounce_rate || '—'}</span>
            </div>
          </div>
        </div>`;
    });
    container.innerHTML = html;
  }

  // ── Countries ───────────────────────────────────────────────────────────
  function ga4RenderCountries() {
    const body = document.getElementById('ga4CountriesBody');
    body.innerHTML = '';
    ga4State.countries.forEach(c => {
      const pct = ga4Num(c.pct);
      body.innerHTML += `<tr>
        <td class="fw-semibold">${c.country || 'Unknown'}</td>
        <td>${ga4FmtInt(c.sessions)}</td>
        <td>${ga4FmtInt(c.users)}</td>
        <td>${ga4FmtInt(c.conversions)}</td>
        <td>${ga4FmtMoney(c.revenue)}</td>
        <td><div class="progress" style="height: 14px; width: 80px;"><div class="progress-bar bg-info" style="width: ${pct}%">${pct}%</div></div></td>
      </tr>`;
    });
  }

  // ── Test API ────────────────────────────────────────────────────────────
  async function ga4TestApiCall() {
    const method = document.getElementById('ga4ApiMethod').value;
    const endpoint = document.getElementById('ga4ApiEndpoint').value;
    const container = document.getElementById('ga4ApiResult');
    container.innerHTML = '<div class="text-center py-3"><span class="spinner-border spinner-border-sm"></span> Sending request...</div>';

    try {
      const res = await fetch('/api/connectors/ga4/test-call', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ method, endpoint })
      });
      const data = await res.json();

      container.innerHTML = `
        <div class="row g-3">
          <div class="col-md-6">
            <div class="card bg-dark border-info">
              <div class="card-header bg-info bg-opacity-25 small fw-bold">
                <i class="bi bi-arrow-up-circle"></i> Request
              </div>
              <div class="card-body p-2">
                <pre class="mb-0 small" style="max-height:280px; overflow:auto; color:#8be9fd;">${method} ${endpoint}\n\nHeaders:\n${JSON.stringify(data.request.headers, null, 2)}${data.request.body ? '\n\nBody:\n' + JSON.stringify(data.request.body, null, 2) : ''}</pre>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card bg-dark border-success">
              <div class="card-header bg-success bg-opacity-25 small fw-bold">
                <i class="bi bi-arrow-down-circle"></i> Response
                <span class="badge bg-success ms-2">${data.response.status_code}</span>
                <span class="badge bg-secondary ms-1">${data.latency_ms}ms</span>
              </div>
              <div class="card-body p-2">
                <pre class="mb-0 small" style="max-height:280px; overflow:auto; color:#50fa7b;">${JSON.stringify(data.response.body, null, 2)}</pre>
              </div>
            </div>
          </div>
        </div>
        <div class="mt-2 small text-muted">
          <i class="bi bi-speedometer"></i> Quota: ${data.quota.tokens_remaining.toLocaleString()} / ${data.quota.daily_limit.toLocaleString()} tokens remaining
        </div>
      `;
    } catch (e) {
      container.innerHTML = '<div class="alert alert-danger">API call failed.</div>';
    }
  }

  // ── CSV Export ──────────────────────────────────────────────────────────
  function ga4ExportCSV(type) {
    let headers, rows, filename;
    if (type === 'pages') {
      if (!ga4State.pages.length) return;
      headers = ['Path', 'Title', 'Views', 'Sessions', 'Users', 'Avg Time', 'Bounce Rate', 'Conversions'];
      rows = ga4State.pages.map(p => [p.path || '', p.title || '', ga4Num(p.views), ga4Num(p.sessions), ga4Num(p.users), p.avg_time || '', p.bounce_rate || '', ga4Num(p.conversions)]);
      filename = 'ga4_top_pages.csv';
    } else if (type === 'sources') {
      if (!ga4State.sources.length) return;
      headers = ['Source', 'Medium', 'Sessions', 'Users', 'Conversions', 'Revenue', 'Bounce Rate'];
      rows = ga4State.sources.map(s => [s.source || '', s.medium || '', ga4Num(s.sessions), ga4Num(s.users), ga4Num(s.conversions), ga4Num(s.revenue), s.bounce_rate || '']);
      filename = 'ga4_sources.csv';
    } else if (type === 'events') {
      if (!ga4State.events.length) return;
      headers = ['Event', 'Category', 'Count', 'Users', 'Per Session', 'Value'];
      rows = ga4State.events.map(e => [e.name || '', e.category || '', ga4Num(e.count), ga4Num(e.users), ga4Num(e.per_session), e.value != null ? ga4Num(e.value) : '']);
      filename = 'ga4_events.csv';
    } else return;
    downloadCSV(filename, headers, rows);
  }

  // ── Settings Save ───────────────────────────────────────────────────────
  async function ga4SaveSettings() {
    const config = {
      date_range: document.getElementById('ga4SettingDateRange').value,
      refresh_interval: document.getElementById('ga4SettingRefresh').value,
      metrics: Array.from(document.querySelectorAll('.ga4-metric-chk:checked')).map(c => c.value),
      dimensions: Array.from(document.querySelectorAll('.ga4-dim-chk:checked')).map(c => c.value)
    };
    try {
      await fetch('/api/connectors/ga4', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: ga4State.connected ? 'Connected' : 'Disconnected', config })
      });
      if (window.showToast) window.showToast('Settings Saved', 'GA4 connector settings updated.', 'success');
    } catch (e) {
      if (window.showToast) window.showToast('Error', 'Failed to save settings.', 'danger');
    }
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // GOOGLE SEARCH CONSOLE: Full Mock Connector Engine
  // ═══════════════════════════════════════════════════════════════════════════

  let gscState = {
    properties: [],
    selectedProperty: null,
    overview: null,
    queries: [],
    pages: [],
    countries: [],
    devices: [],
    indexCoverage: null,
    sitemaps: [],
    connected: false
  };

  async function gscInit() {
    try {
      const res = await fetch('/api/connectors/google-search-console/properties');
      const data = await res.json();
      gscState.properties = data.properties || [];
      const sel = document.getElementById('gscPropertySelect');
      sel.innerHTML = '<option value="">— Select Property —</option>';
      gscState.properties.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.id;
        const icon = p.type === 'Domain' ? '🌐' : '🔗';
        opt.textContent = `${icon} ${p.name} (${p.type})`;
        sel.appendChild(opt);
      });
      if (gscState.properties.length > 0) sel.value = gscState.properties[0].id;
    } catch (e) { console.error('GSC init failed:', e); }

    try {
      const res = await fetch('/api/connectors/google-search-console');
      const data = await res.json();
      gscState.connected = data.status === 'Connected';
      const badge = document.getElementById('gscConnBadge');
      badge.textContent = gscState.connected ? 'Connected' : 'Disconnected';
      badge.className = gscState.connected ? 'badge bg-success' : 'badge bg-secondary';
    } catch (e) {}
  }

  async function gscConnect() {
    const badge = document.getElementById('gscConnBadge');
    badge.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Verifying...';
    badge.className = 'badge bg-info';
    await new Promise(r => setTimeout(r, 1100));

    gscState.connected = true;
    badge.textContent = 'Connected';
    badge.className = 'badge bg-success';

    try {
      await fetch('/api/connectors/google-search-console', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: 'Connected', config: { account: 'webmaster@camarad.ai' } })
      });
      loadConnectorStatuses();
    } catch (e) {}

    if (window.showToast) window.showToast('Search Console', 'Connected! Loading property data...', 'success');
    gscLoadProperty();
  }

  async function gscLoadProperty() {
    const propId = document.getElementById('gscPropertySelect').value;
    if (!propId) return;

    const prop = gscState.properties.find(p => p.id === propId);
    gscState.selectedProperty = prop;
    document.getElementById('gscPropertyInfo').textContent = prop
      ? `${prop.type} · ${prop.permission_level} · ${prop.verified ? '✓ Verified' : '✗ Unverified'}`
      : '';

    try {
      const [overviewRes, queriesRes, pagesRes, countriesRes, devicesRes, indexRes, sitemapsRes] = await Promise.all([
        fetch(`/api/connectors/google-search-console/overview?property_id=${encodeURIComponent(propId)}`),
        fetch(`/api/connectors/google-search-console/queries?property_id=${encodeURIComponent(propId)}`),
        fetch(`/api/connectors/google-search-console/pages?property_id=${encodeURIComponent(propId)}`),
        fetch(`/api/connectors/google-search-console/countries?property_id=${encodeURIComponent(propId)}`),
        fetch(`/api/connectors/google-search-console/devices?property_id=${encodeURIComponent(propId)}`),
        fetch(`/api/connectors/google-search-console/index-coverage?property_id=${encodeURIComponent(propId)}`),
        fetch(`/api/connectors/google-search-console/sitemaps?property_id=${encodeURIComponent(propId)}`),
      ]);
      const [overviewData, queriesData, pagesData, countriesData, devicesData, indexData, sitemapsData] = await Promise.all([
        overviewRes.json(), queriesRes.json(), pagesRes.json(), countriesRes.json(), devicesRes.json(), indexRes.json(), sitemapsRes.json()
      ]);
      gscState.overview = overviewData;
      gscState.queries = queriesData.queries || [];
      gscState.pages = pagesData.pages || [];
      gscState.countries = countriesData.countries || [];
      gscState.devices = devicesData.devices || [];
      gscState.indexCoverage = indexData;
      gscState.sitemaps = sitemapsData.sitemaps || [];

      gscRenderOverview();
      gscRenderQueries();
      gscRenderPages();
      gscRenderCountries();
      gscRenderIndexCoverage();
      gscRenderSitemaps();
    } catch (e) { console.error('GSC load property failed:', e); }
  }

  // ── Overview ────────────────────────────────────────────────────────────
  function gscRenderOverview() {
    const o = gscState.overview;
    if (!o) return;
    const changeIcon = (v) => v > 0 ? `<span class="text-success">▲ ${v}%</span>` : (v < 0 ? `<span class="text-danger">▼ ${Math.abs(v)}%</span>` : '<span class="text-muted">— 0%</span>');
    const posChange = (v) => v < 0 ? `<span class="text-success">▲ ${Math.abs(v)}</span>` : (v > 0 ? `<span class="text-danger">▼ ${v}</span>` : '<span class="text-muted">— 0</span>');

    document.getElementById('gscOverviewContent').innerHTML = `
      <div class="row g-3 mb-4">
        <div class="col-md-3">
          <div class="card bg-dark border-primary h-100">
            <div class="card-body text-center">
              <div class="text-muted small">Total Clicks</div>
              <div class="display-6 text-primary">${o.total_clicks.toLocaleString()}</div>
              <div class="small">${changeIcon(o.clicks_change)} vs prev. period</div>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-dark border-info h-100">
            <div class="card-body text-center">
              <div class="text-muted small">Total Impressions</div>
              <div class="display-6 text-info">${(o.total_impressions / 1000).toFixed(0)}K</div>
              <div class="small">${changeIcon(o.impressions_change)} vs prev. period</div>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-dark border-success h-100">
            <div class="card-body text-center">
              <div class="text-muted small">Average CTR</div>
              <div class="display-6 text-success">${o.avg_ctr}%</div>
              <div class="small">${changeIcon(o.ctr_change)} vs prev. period</div>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-dark border-warning h-100">
            <div class="card-body text-center">
              <div class="text-muted small">Avg. Position</div>
              <div class="display-6 text-warning">${o.avg_position}</div>
              <div class="small">${posChange(o.position_change)} vs prev. period</div>
            </div>
          </div>
        </div>
      </div>

      <div class="row g-3 mb-3">
        <div class="col-md-4">
          <div class="card bg-dark border-secondary">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <span class="small text-muted">Top Query</span>
                <i class="bi bi-search text-info"></i>
              </div>
              <div class="fw-bold mt-1">${o.top_query}</div>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card bg-dark border-secondary">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <span class="small text-muted">Top Page</span>
                <i class="bi bi-file-earmark text-success"></i>
              </div>
              <div class="fw-bold mt-1">${o.top_page}</div>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card bg-dark border-secondary">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <span class="small text-muted">Index Status</span>
                <i class="bi bi-diagram-3 text-warning"></i>
              </div>
              <div class="fw-bold mt-1">${o.indexed_pages.toLocaleString()} indexed
                <span class="badge bg-danger ms-2">${o.crawl_errors} errors</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Devices breakdown -->
      <div class="card bg-dark border-secondary">
        <div class="card-body">
          <h6 class="mb-3"><i class="bi bi-phone"></i> Device Breakdown</h6>
          <div class="row g-2">
            ${gscState.devices.map(d => `
              <div class="col-md-4">
                <div class="d-flex justify-content-between align-items-center mb-1">
                  <span><i class="bi bi-${d.device === 'Mobile' ? 'phone' : (d.device === 'Desktop' ? 'laptop' : 'tablet')}"></i> ${d.device}</span>
                  <span class="small text-muted">${d.share}%</span>
                </div>
                <div class="progress" style="height:8px;">
                  <div class="progress-bar ${d.device === 'Mobile' ? 'bg-primary' : (d.device === 'Desktop' ? 'bg-success' : 'bg-warning')}"
                       style="width:${d.share}%"></div>
                </div>
                <div class="d-flex justify-content-between small text-muted mt-1">
                  <span>${d.clicks.toLocaleString()} clicks</span>
                  <span>CTR ${d.ctr}%</span>
                  <span>Pos. ${d.position}</span>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      </div>
    `;
  }

  // ── Queries Table ───────────────────────────────────────────────────────
  function gscRenderQueries() {
    const filter = (document.getElementById('gscQueryFilter')?.value || '').toLowerCase();
    const sortBy = document.getElementById('gscQuerySort')?.value || 'clicks';
    let items = [...gscState.queries];
    if (filter) items = items.filter(q => q.query.toLowerCase().includes(filter));
    items.sort((a, b) => sortBy === 'position' ? a[sortBy] - b[sortBy] : b[sortBy] - a[sortBy]);

    const body = document.getElementById('gscQueriesBody');
    if (!body) return;
    body.innerHTML = '';
    items.forEach(q => {
      const posClass = q.position <= 3 ? 'text-success' : (q.position <= 10 ? 'text-info' : (q.position <= 20 ? 'text-warning' : 'text-danger'));
      body.innerHTML += `<tr>
        <td class="fw-semibold">${q.query}</td>
        <td>${q.clicks.toLocaleString()}</td>
        <td>${q.impressions.toLocaleString()}</td>
        <td>${q.ctr}%</td>
        <td class="${posClass} fw-bold">${q.position}</td>
      </tr>`;
    });

    // Footer totals
    if (items.length > 0) {
      const totals = items.reduce((acc, q) => ({ clicks: acc.clicks + q.clicks, impressions: acc.impressions + q.impressions }), { clicks: 0, impressions: 0 });
      const avgPos = (items.reduce((s, q) => s + q.position, 0) / items.length).toFixed(1);
      const foot = document.getElementById('gscQueriesFoot');
      if (foot) {
        foot.innerHTML = `<tr class="fw-bold table-secondary">
          <td>TOTAL (${items.length})</td>
          <td>${totals.clicks.toLocaleString()}</td>
          <td>${totals.impressions.toLocaleString()}</td>
          <td>${(totals.clicks / totals.impressions * 100).toFixed(2)}%</td>
          <td>${avgPos}</td>
        </tr>`;
      }
    }
  }

  // ── Pages Table ─────────────────────────────────────────────────────────
  function gscRenderPages() {
    const body = document.getElementById('gscPagesBody');
    if (!body) return;
    body.innerHTML = '';
    gscState.pages.forEach(p => {
      const posClass = p.position <= 5 ? 'text-success' : (p.position <= 15 ? 'text-warning' : 'text-danger');
      body.innerHTML += `<tr>
        <td><code class="text-info">${p.page}</code></td>
        <td>${p.clicks.toLocaleString()}</td>
        <td>${p.impressions.toLocaleString()}</td>
        <td>${p.ctr}%</td>
        <td class="${posClass} fw-bold">${p.position}</td>
      </tr>`;
    });
  }

  // ── Countries ───────────────────────────────────────────────────────────
  function gscRenderCountries() {
    const container = document.getElementById('gscCountriesContent');
    if (!container) return;
    const totalClicks = gscState.countries.reduce((s, c) => s + c.clicks, 0);

    let html = '<div class="table-responsive"><table class="table table-dark table-striped table-sm"><thead><tr><th>Country</th><th>Clicks</th><th>Impressions</th><th>CTR</th><th>Avg. Position</th><th>Share</th></tr></thead><tbody>';
    gscState.countries.forEach(c => {
      const share = ((c.clicks / totalClicks) * 100).toFixed(1);
      html += `<tr>
        <td><span class="me-1">${getFlagEmoji(c.code)}</span> ${c.country}</td>
        <td>${c.clicks.toLocaleString()}</td>
        <td>${c.impressions.toLocaleString()}</td>
        <td>${c.ctr}%</td>
        <td>${c.position}</td>
        <td>
          <div class="d-flex align-items-center gap-2">
            <div class="progress flex-grow-1" style="height:6px;"><div class="progress-bar bg-success" style="width:${share}%"></div></div>
            <span class="small">${share}%</span>
          </div>
        </td>
      </tr>`;
    });
    html += '</tbody></table></div>';
    container.innerHTML = html;
  }

  function getFlagEmoji(countryCode) {
    if (!countryCode || countryCode.length !== 2) return '🏳️';
    return String.fromCodePoint(...[...countryCode.toUpperCase()].map(c => 0x1F1E6 - 65 + c.charCodeAt(0)));
  }

  // ── Index Coverage ──────────────────────────────────────────────────────
  function gscRenderIndexCoverage() {
    const ic = gscState.indexCoverage;
    if (!ic || !ic.summary) return;
    const s = ic.summary;
    const total = s.valid + s.warning + s.error + s.excluded;

    let html = `
      <div class="row g-3 mb-4">
        <div class="col-md-3">
          <div class="card bg-dark border-success h-100 text-center">
            <div class="card-body">
              <div class="display-6 text-success">${s.valid.toLocaleString()}</div>
              <div class="small text-muted">Valid Pages</div>
              <div class="progress mt-2" style="height:4px;"><div class="progress-bar bg-success" style="width:${(s.valid/total*100).toFixed(0)}%"></div></div>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-dark border-warning h-100 text-center">
            <div class="card-body">
              <div class="display-6 text-warning">${s.warning}</div>
              <div class="small text-muted">Warnings</div>
              <div class="progress mt-2" style="height:4px;"><div class="progress-bar bg-warning" style="width:${(s.warning/total*100).toFixed(0)}%"></div></div>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-dark border-danger h-100 text-center">
            <div class="card-body">
              <div class="display-6 text-danger">${s.error}</div>
              <div class="small text-muted">Errors</div>
              <div class="progress mt-2" style="height:4px;"><div class="progress-bar bg-danger" style="width:${(s.error/total*100).toFixed(0)}%"></div></div>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-dark border-secondary h-100 text-center">
            <div class="card-body">
              <div class="display-6 text-muted">${s.excluded}</div>
              <div class="small text-muted">Excluded</div>
              <div class="progress mt-2" style="height:4px;"><div class="progress-bar bg-secondary" style="width:${(s.excluded/total*100).toFixed(0)}%"></div></div>
            </div>
          </div>
        </div>
      </div>
    `;

    // Errors detail
    if (ic.errors && ic.errors.length) {
      html += '<h6 class="text-danger"><i class="bi bi-exclamation-triangle"></i> Errors</h6>';
      html += '<div class="table-responsive"><table class="table table-dark table-sm"><thead><tr><th>Issue Type</th><th>Pages</th><th>Trend</th></tr></thead><tbody>';
      ic.errors.forEach(e => {
        const trendIcon = e.trend === 'increasing' ? '📈' : (e.trend === 'decreasing' ? '📉' : '➡️');
        html += `<tr><td>${e.type}</td><td><span class="badge bg-danger">${e.pages}</span></td><td>${trendIcon} ${e.trend}</td></tr>`;
      });
      html += '</tbody></table></div>';
    }

    // Warnings detail
    if (ic.warnings && ic.warnings.length) {
      html += '<h6 class="text-warning mt-3"><i class="bi bi-exclamation-circle"></i> Warnings</h6>';
      html += '<div class="table-responsive"><table class="table table-dark table-sm"><thead><tr><th>Issue Type</th><th>Pages</th><th>Trend</th></tr></thead><tbody>';
      ic.warnings.forEach(w => {
        const trendIcon = w.trend === 'increasing' ? '📈' : (w.trend === 'decreasing' ? '📉' : '➡️');
        html += `<tr><td>${w.type}</td><td><span class="badge bg-warning text-dark">${w.pages}</span></td><td>${trendIcon} ${w.trend}</td></tr>`;
      });
      html += '</tbody></table></div>';
    }

    // Excluded breakdown
    if (ic.excluded && ic.excluded.length) {
      html += '<h6 class="text-muted mt-3"><i class="bi bi-slash-circle"></i> Excluded Pages Breakdown</h6>';
      html += '<div class="table-responsive"><table class="table table-dark table-sm"><thead><tr><th>Reason</th><th>Pages</th><th>Details</th></tr></thead><tbody>';
      ic.excluded.forEach(x => {
        html += `<tr><td>${x.type}</td><td>${x.pages}</td><td class="small text-muted">${x.reason}</td></tr>`;
      });
      html += '</tbody></table></div>';
    }

    document.getElementById('gscIndexContent').innerHTML = html;
  }

  // ── Sitemaps ────────────────────────────────────────────────────────────
  function gscRenderSitemaps() {
    const container = document.getElementById('gscSitemapsContent');
    if (!container) return;

    let html = '<div class="table-responsive"><table class="table table-dark table-striped table-sm"><thead><tr><th>Sitemap URL</th><th>Type</th><th>Status</th><th>Submitted</th><th>Last Read</th><th>URLs Discovered</th><th>Indexed</th><th>Coverage</th></tr></thead><tbody>';
    gscState.sitemaps.forEach(s => {
      const statusBadge = s.status === 'Success'
        ? '<span class="badge bg-success">Success</span>'
        : '<span class="badge bg-warning text-dark">' + s.status + '</span>';
      const coverage = ((s.indexed_urls / s.discovered_urls) * 100).toFixed(0);
      const covClass = coverage >= 80 ? 'bg-success' : (coverage >= 60 ? 'bg-warning' : 'bg-danger');
      html += `<tr>
        <td><code class="text-info small">${s.url}</code></td>
        <td>${s.type}</td>
        <td>${statusBadge}</td>
        <td class="small">${s.submitted}</td>
        <td class="small">${s.last_read}</td>
        <td>${s.discovered_urls.toLocaleString()}</td>
        <td>${s.indexed_urls.toLocaleString()}</td>
        <td>
          <div class="d-flex align-items-center gap-2">
            <div class="progress flex-grow-1" style="height:6px;"><div class="progress-bar ${covClass}" style="width:${coverage}%"></div></div>
            <span class="small">${coverage}%</span>
          </div>
        </td>
      </tr>`;
    });
    html += '</tbody></table></div>';
    container.innerHTML = html;
  }

  // ── CSV Export ──────────────────────────────────────────────────────────
  function gscExportCSV(type) {
    if (type === 'queries' && gscState.queries.length) {
      downloadCSV('gsc_queries.csv',
        ['Query', 'Clicks', 'Impressions', 'CTR', 'Avg Position'],
        gscState.queries.map(q => [q.query, q.clicks, q.impressions, q.ctr + '%', q.position])
      );
    } else if (type === 'pages' && gscState.pages.length) {
      downloadCSV('gsc_pages.csv',
        ['Page', 'Clicks', 'Impressions', 'CTR', 'Avg Position'],
        gscState.pages.map(p => [p.page, p.clicks, p.impressions, p.ctr + '%', p.position])
      );
    } else if (type === 'countries' && gscState.countries.length) {
      downloadCSV('gsc_countries.csv',
        ['Country', 'Code', 'Clicks', 'Impressions', 'CTR', 'Avg Position'],
        gscState.countries.map(c => [c.country, c.code, c.clicks, c.impressions, c.ctr + '%', c.position])
      );
    }
  }

  // ── Test API Call ───────────────────────────────────────────────────────
  async function gscTestApiCall() {
    const method = document.getElementById('gscApiMethod').value;
    const endpoint = document.getElementById('gscApiEndpoint').value;
    const container = document.getElementById('gscApiResult');
    container.innerHTML = '<div class="text-center py-3"><span class="spinner-border spinner-border-sm"></span> Sending request...</div>';

    try {
      const res = await fetch('/api/connectors/google-search-console/test-call', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ method, endpoint })
      });
      const data = await res.json();

      container.innerHTML = `
        <div class="row g-3">
          <div class="col-md-6">
            <div class="card bg-dark border-info">
              <div class="card-header bg-info bg-opacity-25 small fw-bold">
                <i class="bi bi-arrow-up-circle"></i> Request
              </div>
              <div class="card-body p-2">
                <pre class="mb-0 small" style="max-height:250px; overflow:auto; color:#8be9fd;">${method} ${endpoint}\n\nHeaders:\n${JSON.stringify(data.request.headers, null, 2)}${data.request.body ? '\n\nBody:\n' + JSON.stringify(data.request.body, null, 2) : ''}</pre>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card bg-dark border-success">
              <div class="card-header bg-success bg-opacity-25 small fw-bold">
                <i class="bi bi-arrow-down-circle"></i> Response
                <span class="badge bg-success ms-2">${data.response.status_code}</span>
                <span class="badge bg-secondary ms-1">${data.latency_ms}ms</span>
              </div>
              <div class="card-body p-2">
                <pre class="mb-0 small" style="max-height:250px; overflow:auto; color:#50fa7b;">${JSON.stringify(data.response.body, null, 2)}</pre>
              </div>
            </div>
          </div>
        </div>
        <div class="mt-2 small text-muted">
          <i class="bi bi-speedometer"></i> Quota: ${data.quota.queries_remaining.toLocaleString()} / ${data.quota.daily_limit.toLocaleString()} queries remaining
        </div>
      `;
    } catch (e) {
      container.innerHTML = '<div class="alert alert-danger">API call failed.</div>';
    }
  }

  // ── Settings Save ───────────────────────────────────────────────────────
  async function gscSaveSettings() {
    const config = {
      type: document.getElementById('gscSettingType').value,
      date_range: document.getElementById('gscSettingDateRange').value,
      search_type: document.getElementById('gscSettingSearchType').value,
      refresh_interval: document.getElementById('gscSettingRefresh').value
    };
    try {
      await fetch('/api/connectors/google-search-console', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: gscState.connected ? 'Connected' : 'Disconnected', config })
      });
      if (window.showToast) window.showToast('Settings Saved', 'Google Search Console settings updated.', 'success');
    } catch (e) {
      if (window.showToast) window.showToast('Error', 'Failed to save settings.', 'danger');
    }
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // GOOGLE TAG MANAGER: Full Mock Connector Engine
  // ═══════════════════════════════════════════════════════════════════════════

  let gtmState = {
    containers: [],
    selectedContainer: null,
    overview: null,
    tags: [],
    triggers: [],
    variables: [],
    versions: [],
    previewEvents: [],
    connected: false,
    previewRunning: false
  };

  async function gtmInit() {
    try {
      const res = await fetch('/api/connectors/google-tag-manager/containers');
      const data = await res.json();
      gtmState.containers = data.containers || [];
      const sel = document.getElementById('gtmContainerSelect');
      sel.innerHTML = '<option value="">— Select Container —</option>';
      gtmState.containers.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.id;
        const icon = c.type === 'Web' ? '🌐' : '📱';
        opt.textContent = `${icon} ${c.id} — ${c.name}`;
        sel.appendChild(opt);
      });
      if (gtmState.containers.length > 0) sel.value = gtmState.containers[0].id;
    } catch (e) { console.error('GTM init failed:', e); }

    try {
      const res = await fetch('/api/connectors/google-tag-manager');
      const data = await res.json();
      gtmState.connected = data.status === 'Connected';
      const badge = document.getElementById('gtmConnBadge');
      badge.textContent = gtmState.connected ? 'Connected' : 'Disconnected';
      badge.className = gtmState.connected ? 'badge bg-success' : 'badge bg-secondary';
    } catch (e) {}
  }

  async function gtmConnect() {
    const badge = document.getElementById('gtmConnBadge');
    badge.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Connecting...';
    badge.className = 'badge bg-info';
    await new Promise(r => setTimeout(r, 1000));

    gtmState.connected = true;
    badge.textContent = 'Connected';
    badge.className = 'badge bg-success';

    try {
      await fetch('/api/connectors/google-tag-manager', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: 'Connected', config: { account: 'tagmanager@camarad.ai' } })
      });
      loadConnectorStatuses();
    } catch (e) {}

    if (window.showToast) window.showToast('Tag Manager', 'Connected! Loading container data...', 'success');
    gtmLoadContainer();
  }

  async function gtmLoadContainer() {
    const containerId = document.getElementById('gtmContainerSelect').value;
    if (!containerId) return;

    const c = gtmState.containers.find(x => x.id === containerId);
    gtmState.selectedContainer = c;
    document.getElementById('gtmContainerInfo').textContent = c
      ? `${c.type} · Workspace: ${c.workspace} · ${c.public_id}`
      : '';

    try {
      const [overviewRes, tagsRes, triggersRes, variablesRes, versionsRes] = await Promise.all([
        fetch(`/api/connectors/google-tag-manager/overview?container_id=${containerId}`),
        fetch(`/api/connectors/google-tag-manager/tags?container_id=${containerId}`),
        fetch(`/api/connectors/google-tag-manager/triggers?container_id=${containerId}`),
        fetch(`/api/connectors/google-tag-manager/variables?container_id=${containerId}`),
        fetch(`/api/connectors/google-tag-manager/versions?container_id=${containerId}`),
      ]);
      const [overviewData, tagsData, triggersData, variablesData, versionsData] = await Promise.all([
        overviewRes.json(), tagsRes.json(), triggersRes.json(), variablesRes.json(), versionsRes.json()
      ]);
      gtmState.overview = overviewData;
      gtmState.tags = tagsData.tags || [];
      gtmState.triggers = triggersData.triggers || [];
      gtmState.variables = variablesData.variables || [];
      gtmState.versions = versionsData.versions || [];

      gtmRenderOverview();
      gtmRenderTags();
      gtmRenderTriggers();
      gtmRenderVariables();
      gtmRenderVersions();
    } catch (e) { console.error('GTM load container failed:', e); }
  }

  // ── Overview ────────────────────────────────────────────────────────────
  function gtmRenderOverview() {
    const o = gtmState.overview;
    if (!o) return;

    // Sparkline from daily_fires
    const maxFires = Math.max(...(o.daily_fires || []).map(d => d.fires));
    const sparkBars = (o.daily_fires || []).map(d => {
      const pct = Math.round(d.fires / maxFires * 100);
      return `<div class="d-flex flex-column align-items-center" style="flex:1;">
        <div style="width:100%;height:${pct}px;max-height:60px;background:linear-gradient(180deg,#0d6efd,#198754);border-radius:2px;min-height:4px;"></div>
        <div class="text-muted" style="font-size:.6rem;margin-top:2px;">${d.date.slice(5)}</div>
      </div>`;
    }).join('');

    document.getElementById('gtmOverviewContent').innerHTML = `
      <div class="row g-3 mb-4">
        <div class="col-md-2">
          <div class="card bg-dark border-info h-100 text-center">
            <div class="card-body py-2">
              <div class="text-muted small">Tags</div>
              <div class="fs-3 text-info">${o.tags_total}</div>
              <div class="small"><span class="text-success">${o.tags_enabled} active</span> · <span class="text-muted">${o.tags_paused} paused</span></div>
            </div>
          </div>
        </div>
        <div class="col-md-2">
          <div class="card bg-dark border-primary h-100 text-center">
            <div class="card-body py-2">
              <div class="text-muted small">Triggers</div>
              <div class="fs-3 text-primary">${o.triggers_total}</div>
            </div>
          </div>
        </div>
        <div class="col-md-2">
          <div class="card bg-dark border-success h-100 text-center">
            <div class="card-body py-2">
              <div class="text-muted small">Variables</div>
              <div class="fs-3 text-success">${o.variables_total}</div>
            </div>
          </div>
        </div>
        <div class="col-md-2">
          <div class="card bg-dark border-warning h-100 text-center">
            <div class="card-body py-2">
              <div class="text-muted small">Fired (7d)</div>
              <div class="fs-3 text-warning">${(o.tags_fired_7d / 1000).toFixed(1)}K</div>
            </div>
          </div>
        </div>
        <div class="col-md-2">
          <div class="card bg-dark border-danger h-100 text-center">
            <div class="card-body py-2">
              <div class="text-muted small">Errors (7d)</div>
              <div class="fs-3 ${o.errors_7d > 0 ? 'text-danger' : 'text-success'}">${o.errors_7d}</div>
              <div class="small text-muted">${o.warnings_7d} warnings</div>
            </div>
          </div>
        </div>
        <div class="col-md-2">
          <div class="card bg-dark border-secondary h-100 text-center">
            <div class="card-body py-2">
              <div class="text-muted small">Version</div>
              <div class="fs-3 text-light">v${o.current_version}</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Daily fires sparkline -->
      <div class="card bg-dark border-secondary mb-3">
        <div class="card-body">
          <div class="d-flex justify-content-between mb-2">
            <span class="small fw-bold">Tags Fired — Last 7 Days</span>
            <span class="small text-muted">${o.tags_fired_7d.toLocaleString()} total</span>
          </div>
          <div class="d-flex align-items-end gap-1" style="height:70px;">${sparkBars}</div>
        </div>
      </div>

      <!-- Publish info -->
      <div class="card bg-dark border-secondary">
        <div class="card-body py-2">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <i class="bi bi-cloud-arrow-up text-success"></i>
              <span class="small ms-2">Last published: <strong>${o.last_published}</strong> by ${o.published_by}</span>
            </div>
            <div>
              <span class="badge bg-secondary">Workspaces: ${(o.workspaces || []).join(', ')}</span>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  // ── Tags Table ──────────────────────────────────────────────────────────
  function gtmRenderTags() {
    const typeFilter = document.getElementById('gtmTagFilter')?.value || 'all';
    const statusFilter = document.getElementById('gtmTagStatusFilter')?.value || 'all';
    let items = [...gtmState.tags];
    if (typeFilter !== 'all') items = items.filter(t => t.type.includes(typeFilter));
    if (statusFilter !== 'all') items = items.filter(t => t.status === statusFilter);

    const body = document.getElementById('gtmTagsBody');
    if (!body) return;
    body.innerHTML = '';
    items.forEach(t => {
      const statusBadge = t.status === 'Enabled'
        ? '<span class="badge bg-success">Enabled</span>'
        : '<span class="badge bg-secondary">Paused</span>';
      const typeBadge = t.type.includes('GA4') ? 'bg-primary' : (t.type.includes('Google Ads') ? 'bg-warning text-dark' : 'bg-info text-dark');
      body.innerHTML += `<tr>
        <td class="fw-semibold">${t.name}</td>
        <td><span class="badge ${typeBadge}">${t.type}</span></td>
        <td>${statusBadge}</td>
        <td class="small">${t.fires_on}</td>
        <td>${t.fire_count_7d.toLocaleString()}</td>
        <td class="small text-muted">${t.last_fired || '—'}</td>
      </tr>`;
    });

    // Footer totals
    const foot = document.getElementById('gtmTagsFoot');
    if (foot && items.length > 0) {
      const totalFires = items.reduce((s, t) => s + t.fire_count_7d, 0);
      foot.innerHTML = `<tr class="fw-bold table-secondary">
        <td>TOTAL (${items.length})</td><td></td><td></td><td></td>
        <td>${totalFires.toLocaleString()}</td><td></td>
      </tr>`;
    }
  }

  // ── Triggers Table ──────────────────────────────────────────────────────
  function gtmRenderTriggers() {
    const body = document.getElementById('gtmTriggersBody');
    if (!body) return;
    body.innerHTML = '';
    gtmState.triggers.forEach(t => {
      const typeColor = t.type === 'Page View' ? 'bg-primary' : (t.type === 'Custom Event' ? 'bg-warning text-dark' :
        (t.type.includes('Click') ? 'bg-info text-dark' : 'bg-secondary'));
      body.innerHTML += `<tr>
        <td class="fw-semibold">${t.name}</td>
        <td><span class="badge ${typeColor}">${t.type}</span></td>
        <td class="small">${t.fires_on}</td>
        <td class="small">${t.filters.length > 0 ? t.filters.map(f => `<code class="text-warning">${f}</code>`).join('<br>') : '<span class="text-muted">None</span>'}</td>
        <td><span class="badge bg-outline-secondary border">${t.used_by_tags}</span></td>
      </tr>`;
    });
  }

  // ── Variables Table ─────────────────────────────────────────────────────
  function gtmRenderVariables() {
    const scopeFilter = document.getElementById('gtmVarScopeFilter')?.value || 'all';
    let items = [...gtmState.variables];
    if (scopeFilter !== 'all') items = items.filter(v => v.scope === scopeFilter);

    const body = document.getElementById('gtmVariablesBody');
    if (!body) return;
    body.innerHTML = '';
    items.forEach(v => {
      const scopeBadge = v.scope === 'Built-in' ? 'bg-secondary' : (v.scope === 'User-Defined' ? 'bg-info text-dark' : 'bg-success');
      body.innerHTML += `<tr>
        <td class="fw-semibold">${v.name}</td>
        <td class="small">${v.type}</td>
        <td><code class="text-warning small">${v.value}</code></td>
        <td><span class="badge ${scopeBadge}">${v.scope}</span></td>
      </tr>`;
    });
  }

  // ── Versions Timeline ───────────────────────────────────────────────────
  function gtmRenderVersions() {
    const container = document.getElementById('gtmVersionsContent');
    if (!container) return;

    let html = '';
    gtmState.versions.forEach((v, i) => {
      const isLatest = i === 0;
      html += `
        <div class="card bg-dark ${isLatest ? 'border-success' : 'border-secondary'} mb-3">
          <div class="card-body py-2">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <div class="d-flex align-items-center gap-2">
                  ${isLatest ? '<span class="badge bg-success">LIVE</span>' : ''}
                  <strong>${v.name}</strong>
                </div>
                <div class="small text-muted mt-1">${v.description}</div>
              </div>
              <div class="text-end">
                <div class="small text-muted">${v.published}</div>
                <div class="small text-muted">by ${v.published_by}</div>
              </div>
            </div>
            <div class="d-flex gap-3 mt-2">
              ${v.tags_added > 0 ? `<span class="badge bg-success bg-opacity-25 text-success">+${v.tags_added} tag${v.tags_added > 1 ? 's' : ''} added</span>` : ''}
              ${v.tags_modified > 0 ? `<span class="badge bg-warning bg-opacity-25 text-warning">${v.tags_modified} tag${v.tags_modified > 1 ? 's' : ''} modified</span>` : ''}
              ${v.tags_deleted > 0 ? `<span class="badge bg-danger bg-opacity-25 text-danger">${v.tags_deleted} tag${v.tags_deleted > 1 ? 's' : ''} deleted</span>` : ''}
              ${v.tags_added === 0 && v.tags_modified === 0 && v.tags_deleted === 0 ? '<span class="badge bg-secondary">No tag changes</span>' : ''}
            </div>
          </div>
        </div>
      `;
    });
    container.innerHTML = html;
  }

  // ── Preview Mode ────────────────────────────────────────────────────────
  async function gtmStartPreview() {
    const container = document.getElementById('gtmPreviewContent');
    const btn = document.getElementById('gtmPreviewBtn');

    if (gtmState.previewRunning) {
      gtmState.previewRunning = false;
      btn.innerHTML = '<i class="bi bi-play-fill"></i> Start Preview';
      btn.className = 'btn btn-sm btn-info';
      return;
    }

    gtmState.previewRunning = true;
    btn.innerHTML = '<i class="bi bi-stop-fill"></i> Stop Preview';
    btn.className = 'btn btn-sm btn-danger';

    container.innerHTML = '<div class="text-center py-3"><span class="spinner-border spinner-border-sm"></span> Starting Tag Assistant preview...</div>';
    await new Promise(r => setTimeout(r, 1200));

    try {
      const res = await fetch('/api/connectors/google-tag-manager/preview');
      const data = await res.json();
      gtmState.previewEvents = data.events || [];

      let html = `<div class="alert alert-info py-2 mb-3">
        <i class="bi bi-bug"></i> <strong>Tag Assistant</strong> — Preview mode active on <code>${data.container}</code>
        <span class="badge bg-success ms-2">Debug: ON</span>
      </div>`;

      // Summary bar
      const totalTagsFired = gtmState.previewEvents.reduce((s, e) => s + e.tags_fired.length, 0);
      html += `<div class="d-flex gap-3 mb-3">
        <span class="badge bg-primary">${gtmState.previewEvents.length} Events</span>
        <span class="badge bg-success">${totalTagsFired} Tags Fired</span>
      </div>`;

      // Event timeline
      gtmState.previewEvents.forEach((evt, i) => {
        const firedCount = evt.tags_fired.length;
        const notFiredCount = evt.tags_not_fired.length;
        html += `
          <div class="card bg-dark border-secondary mb-2">
            <div class="card-body py-2">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <span class="text-muted small me-2">${evt.timestamp}</span>
                  <strong class="text-info">${evt.event}</strong>
                  ${firedCount > 0 ? `<span class="badge bg-success ms-2">${firedCount} fired</span>` : ''}
                  ${notFiredCount > 0 ? `<span class="badge bg-secondary ms-1">${notFiredCount} not fired</span>` : ''}
                </div>
                <button class="btn btn-sm btn-outline-secondary py-0" onclick="document.getElementById('gtmEvtDetail${i}').classList.toggle('d-none')">
                  <i class="bi bi-chevron-down"></i>
                </button>
              </div>
              <div id="gtmEvtDetail${i}" class="d-none mt-2">
                ${firedCount > 0 ? `<div class="mb-1"><span class="small text-success fw-bold">Tags Fired:</span> ${evt.tags_fired.map(t => `<span class="badge bg-success bg-opacity-25 text-success me-1">${t}</span>`).join('')}</div>` : ''}
                ${notFiredCount > 0 ? `<div class="mb-1"><span class="small text-muted fw-bold">Not Fired:</span> ${evt.tags_not_fired.map(t => `<span class="badge bg-secondary me-1">${t}</span>`).join('')}</div>` : ''}
                <div class="mt-1"><span class="small text-muted">Data Layer:</span><pre class="mt-1 mb-0 p-2 rounded small" style="background:#161b22; max-height:120px; overflow:auto; color:#8be9fd;">${JSON.stringify(evt.data_layer, null, 2)}</pre></div>
              </div>
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    } catch (e) {
      container.innerHTML = '<div class="alert alert-danger">Failed to load preview events.</div>';
      gtmState.previewRunning = false;
      btn.innerHTML = '<i class="bi bi-play-fill"></i> Start Preview';
      btn.className = 'btn btn-sm btn-info';
    }
  }

  // ── CSV Export ──────────────────────────────────────────────────────────
  function gtmExportCSV(type) {
    if (type === 'tags' && gtmState.tags.length) {
      downloadCSV('gtm_tags.csv',
        ['Tag Name', 'Type', 'Status', 'Fires On', 'Fires 7d', 'Last Fired'],
        gtmState.tags.map(t => [t.name, t.type, t.status, t.fires_on, t.fire_count_7d, t.last_fired || ''])
      );
    } else if (type === 'triggers' && gtmState.triggers.length) {
      downloadCSV('gtm_triggers.csv',
        ['Trigger Name', 'Type', 'Fires On', 'Filters', 'Used by Tags'],
        gtmState.triggers.map(t => [t.name, t.type, t.fires_on, t.filters.join('; '), t.used_by_tags])
      );
    } else if (type === 'variables' && gtmState.variables.length) {
      downloadCSV('gtm_variables.csv',
        ['Name', 'Type', 'Value', 'Scope'],
        gtmState.variables.map(v => [v.name, v.type, v.value, v.scope])
      );
    }
  }

  // ── Test API Call ───────────────────────────────────────────────────────
  async function gtmTestApiCall() {
    const method = document.getElementById('gtmApiMethod').value;
    const endpoint = document.getElementById('gtmApiEndpoint').value;
    const container = document.getElementById('gtmApiResult');
    container.innerHTML = '<div class="text-center py-3"><span class="spinner-border spinner-border-sm"></span> Sending request...</div>';

    try {
      const res = await fetch('/api/connectors/google-tag-manager/test-call', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ method, endpoint })
      });
      const data = await res.json();

      container.innerHTML = `
        <div class="row g-3">
          <div class="col-md-6">
            <div class="card bg-dark border-info">
              <div class="card-header bg-info bg-opacity-25 small fw-bold">
                <i class="bi bi-arrow-up-circle"></i> Request
              </div>
              <div class="card-body p-2">
                <pre class="mb-0 small" style="max-height:250px; overflow:auto; color:#8be9fd;">${method} ${endpoint}\n\nHeaders:\n${JSON.stringify(data.request.headers, null, 2)}</pre>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card bg-dark border-success">
              <div class="card-header bg-success bg-opacity-25 small fw-bold">
                <i class="bi bi-arrow-down-circle"></i> Response
                <span class="badge bg-success ms-2">${data.response.status_code}</span>
                <span class="badge bg-secondary ms-1">${data.latency_ms}ms</span>
              </div>
              <div class="card-body p-2">
                <pre class="mb-0 small" style="max-height:250px; overflow:auto; color:#50fa7b;">${JSON.stringify(data.response.body, null, 2)}</pre>
              </div>
            </div>
          </div>
        </div>
        <div class="mt-2 small text-muted">
          <i class="bi bi-speedometer"></i> Quota: ${data.quota.operations_remaining.toLocaleString()} / ${data.quota.daily_limit.toLocaleString()} operations remaining
        </div>
      `;
    } catch (e) {
      container.innerHTML = '<div class="alert alert-danger">API call failed.</div>';
    }
  }

  // ── Settings Save ───────────────────────────────────────────────────────
  async function gtmSaveSettings() {
    const config = {
      workspace: document.getElementById('gtmSettingWorkspace').value,
      environment: document.getElementById('gtmSettingEnv').value,
      debug: document.getElementById('gtmSettingDebug').checked,
      auto_publish: document.getElementById('gtmSettingAutoPublish').checked
    };
    try {
      await fetch('/api/connectors/google-tag-manager', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: gtmState.connected ? 'Connected' : 'Disconnected', config })
      });
      if (window.showToast) window.showToast('Settings Saved', 'GTM connector settings updated.', 'success');
    } catch (e) {
      if (window.showToast) window.showToast('Error', 'Failed to save settings.', 'danger');
    }
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // META ADS (Facebook + Instagram): Full Mock Connector Engine
  // ═══════════════════════════════════════════════════════════════════════════

  let metaState = {
    accounts: [],
    selectedAccount: null,
    overview: null,
    campaigns: [],
    adsets: [],
    ads: [],
    budgetPacing: null,
    reportRows: [],
    connected: false
  };

  async function metaInit() {
    try {
      const res = await fetch('/api/connectors/meta-ads/accounts');
      const data = await res.json();
      metaState.accounts = data.accounts || [];
      const sel = document.getElementById('metaAccountSelect');
      sel.innerHTML = '<option value="">— Select Ad Account —</option>';
      metaState.accounts.forEach(a => {
        const opt = document.createElement('option');
        opt.value = a.id;
        opt.textContent = `${a.name} (${a.id})`;
        sel.appendChild(opt);
      });
      if (metaState.accounts.length > 0) sel.value = metaState.accounts[0].id;
    } catch (e) { console.error('Meta init failed:', e); }

    try {
      const res = await fetch('/api/connectors/meta-ads');
      const data = await res.json();
      metaState.connected = data.status === 'Connected';
      const badge = document.getElementById('metaConnBadge');
      badge.textContent = metaState.connected ? 'Connected' : 'Disconnected';
      badge.className = metaState.connected ? 'badge bg-success' : 'badge bg-secondary';
    } catch (e) {}
  }

  async function metaConnect() {
    const badge = document.getElementById('metaConnBadge');
    badge.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Connecting...';
    badge.className = 'badge bg-info';
    await new Promise(r => setTimeout(r, 1200));

    metaState.connected = true;
    badge.textContent = 'Connected';
    badge.className = 'badge bg-success';

    try {
      await fetch('/api/connectors/meta-ads', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: 'Connected', config: { account: 'business@meta.com' } })
      });
      loadConnectorStatuses();
    } catch (e) {}

    if (window.showToast) window.showToast('Meta Ads', 'Connected via Business Manager! Loading ad account data...', 'success');
    metaLoadAccount();
  }

  async function metaLoadAccount() {
    const accountId = document.getElementById('metaAccountSelect').value;
    if (!accountId) return;

    const a = metaState.accounts.find(x => x.id === accountId);
    metaState.selectedAccount = a;
    document.getElementById('metaAccountInfo').textContent = a
      ? `${a.business_name} · ${a.currency} · ${a.timezone}`
      : '';

    try {
      const [overviewRes, campaignsRes, budgetRes] = await Promise.all([
        fetch(`/api/connectors/meta-ads/overview?account_id=${accountId}`),
        fetch(`/api/connectors/meta-ads/campaigns?account_id=${accountId}`),
        fetch(`/api/connectors/meta-ads/budget-pacing?account_id=${accountId}`),
      ]);
      const [overviewData, campaignsData, budgetData] = await Promise.all([
        overviewRes.json(), campaignsRes.json(), budgetRes.json()
      ]);
      metaState.overview = overviewData;
      metaState.campaigns = campaignsData.campaigns || [];
      metaState.budgetPacing = budgetData;

      // Populate campaign dropdown for Ad Sets tab
      const campSel = document.getElementById('metaAdSetCampSelect');
      campSel.innerHTML = '<option value="">— Select Campaign —</option>';
      metaState.campaigns.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.id;
        opt.textContent = c.name;
        campSel.appendChild(opt);
      });

      metaRenderOverview();
      metaRenderCampaigns();
      metaRenderBudget();
    } catch (e) { console.error('Meta load account failed:', e); }
  }

  // ── Overview ────────────────────────────────────────────────────────────
  function metaRenderOverview() {
    const o = metaState.overview;
    if (!o) return;

    const delta = (val) => {
      if (!val) return '';
      const cls = val >= 0 ? 'text-success' : 'text-danger';
      const arrow = val >= 0 ? '▲' : '▼';
      return `<div class="small ${cls}">${arrow} ${Math.abs(val).toFixed(1)}%</div>`;
    };

    // Sparkline for daily spend
    const maxSpend = Math.max(...(o.daily_spend || []).map(d => d.spend));
    const sparkBars = (o.daily_spend || []).map(d => {
      const pct = Math.round(d.spend / maxSpend * 100);
      const roasColor = d.roas >= 4 ? '#198754' : (d.roas >= 3 ? '#ffc107' : '#dc3545');
      return `<div class="d-flex flex-column align-items-center" style="flex:1;">
        <div style="width:100%;height:${pct}px;max-height:60px;background:linear-gradient(180deg,#0d6efd,${roasColor});border-radius:2px;min-height:4px;" title="$${d.spend} · ROAS ${d.roas}x"></div>
        <div class="text-muted" style="font-size:.6rem;margin-top:2px;">${d.date.slice(5)}</div>
      </div>`;
    }).join('');

    document.getElementById('metaOverviewContent').innerHTML = `
      <div class="row g-3 mb-4">
        <div class="col-md-2">
          <div class="card bg-dark border-primary h-100 text-center">
            <div class="card-body py-2">
              <div class="text-muted small">Spend</div>
              <div class="fs-3 text-primary">$${(o.spend / 1000).toFixed(1)}K</div>
              ${delta(o.spend_change)}
            </div>
          </div>
        </div>
        <div class="col-md-2">
          <div class="card bg-dark border-info h-100 text-center">
            <div class="card-body py-2">
              <div class="text-muted small">Reach</div>
              <div class="fs-3 text-info">${(o.reach / 1000).toFixed(0)}K</div>
              ${delta(o.reach_change)}
            </div>
          </div>
        </div>
        <div class="col-md-2">
          <div class="card bg-dark border-secondary h-100 text-center">
            <div class="card-body py-2">
              <div class="text-muted small">Impressions</div>
              <div class="fs-3 text-light">${(o.impressions / 1000).toFixed(0)}K</div>
            </div>
          </div>
        </div>
        <div class="col-md-2">
          <div class="card bg-dark border-warning h-100 text-center">
            <div class="card-body py-2">
              <div class="text-muted small">ROAS</div>
              <div class="fs-3 text-warning">${o.roas.toFixed(1)}x</div>
              ${delta(o.roas_change)}
            </div>
          </div>
        </div>
        <div class="col-md-2">
          <div class="card bg-dark border-success h-100 text-center">
            <div class="card-body py-2">
              <div class="text-muted small">Conversions</div>
              <div class="fs-3 text-success">${o.conversions.toLocaleString()}</div>
              ${delta(o.conversions_change)}
            </div>
          </div>
        </div>
        <div class="col-md-2">
          <div class="card bg-dark border-danger h-100 text-center">
            <div class="card-body py-2">
              <div class="text-muted small">CPC / CPM</div>
              <div class="fs-4 text-danger">$${o.cpc.toFixed(2)}</div>
              <div class="small text-muted">CPM $${o.cpm.toFixed(2)}</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Daily spend sparkline -->
      <div class="card bg-dark border-secondary mb-3">
        <div class="card-body">
          <div class="d-flex justify-content-between mb-2">
            <span class="small fw-bold">Daily Spend & ROAS — Last 7 Days</span>
            <span class="small text-muted">Total: $${o.spend.toLocaleString()}</span>
          </div>
          <div class="d-flex align-items-end gap-1" style="height:70px;">${sparkBars}</div>
        </div>
      </div>

      <!-- Platform breakdown -->
      <div class="card bg-dark border-secondary">
        <div class="card-body py-2">
          <div class="fw-bold small mb-2"><i class="bi bi-pie-chart"></i> Platform Breakdown</div>
          <div class="row g-2">
            ${(o.platform_breakdown || []).map(p => `
              <div class="col-md-6">
                <div class="d-flex justify-content-between align-items-center p-2 rounded" style="background:#161b22;">
                  <span>${p.platform === 'Facebook' ? '<i class="bi bi-facebook text-primary"></i>' : '<i class="bi bi-instagram text-danger"></i>'} <strong>${p.platform}</strong></span>
                  <div class="text-end">
                    <span class="badge bg-primary">$${p.spend.toLocaleString()}</span>
                    <span class="badge bg-success">${p.conversions} conv</span>
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      </div>
    `;
  }

  // ── Campaigns Table ─────────────────────────────────────────────────────
  function metaRenderCampaigns() {
    const statusFilter = document.getElementById('metaCampStatusFilter')?.value || 'all';
    const objFilter = document.getElementById('metaCampObjectiveFilter')?.value || 'all';
    let items = [...metaState.campaigns];
    if (statusFilter !== 'all') items = items.filter(c => c.status === statusFilter);
    if (objFilter !== 'all') items = items.filter(c => c.objective === objFilter);

    const body = document.getElementById('metaCampaignsBody');
    if (!body) return;
    body.innerHTML = '';
    items.forEach(c => {
      const statusBadge = c.status === 'ACTIVE'
        ? '<span class="badge bg-success">Active</span>'
        : '<span class="badge bg-secondary">Paused</span>';
      const objColors = {CONVERSIONS:'bg-primary', REACH:'bg-info', VIDEO_VIEWS:'bg-warning text-dark', APP_INSTALLS:'bg-success', MESSAGES:'bg-secondary'};
      body.innerHTML += `<tr>
        <td class="fw-semibold">${c.name}</td>
        <td><span class="badge ${objColors[c.objective] || 'bg-secondary'}">${c.objective}</span></td>
        <td>${statusBadge}</td>
        <td>$${c.spend.toLocaleString()}</td>
        <td>${c.reach.toLocaleString()}</td>
        <td>${c.clicks.toLocaleString()}</td>
        <td>${c.ctr.toFixed(2)}%</td>
        <td>${c.roas > 0 ? c.roas.toFixed(1) + 'x' : '—'}</td>
        <td>${c.conversions > 0 ? c.conversions.toLocaleString() : '—'}</td>
      </tr>`;
    });

    const foot = document.getElementById('metaCampaignsFoot');
    if (foot && items.length > 0) {
      const totals = items.reduce((s, c) => ({
        spend: s.spend + c.spend, reach: s.reach + c.reach, clicks: s.clicks + c.clicks, conversions: s.conversions + c.conversions
      }), {spend:0, reach:0, clicks:0, conversions:0});
      foot.innerHTML = `<tr class="fw-bold table-secondary">
        <td>TOTAL (${items.length})</td><td></td><td></td>
        <td>$${totals.spend.toLocaleString()}</td>
        <td>${totals.reach.toLocaleString()}</td>
        <td>${totals.clicks.toLocaleString()}</td>
        <td></td><td></td>
        <td>${totals.conversions.toLocaleString()}</td>
      </tr>`;
    }
  }

  // ── Ad Sets ─────────────────────────────────────────────────────────────
  async function metaLoadAdSets() {
    const campId = document.getElementById('metaAdSetCampSelect').value;
    if (!campId) return;
    try {
      const res = await fetch(`/api/connectors/meta-ads/adsets?campaign_id=${campId}`);
      const data = await res.json();
      metaState.adsets = data.adsets || [];

      // Populate ad set dropdown for Ads tab
      const adSetSel = document.getElementById('metaAdSetSelect');
      adSetSel.innerHTML = '<option value="">— Select Ad Set —</option>';
      metaState.adsets.forEach(a => {
        const opt = document.createElement('option');
        opt.value = a.id;
        opt.textContent = a.name;
        adSetSel.appendChild(opt);
      });

      metaRenderAdSets();
    } catch (e) { console.error('Meta load adsets failed:', e); }
  }

  function metaRenderAdSets() {
    const body = document.getElementById('metaAdSetsBody');
    if (!body) return;
    body.innerHTML = '';
    metaState.adsets.forEach(a => {
      const targeting = a.targeting;
      const targetStr = `${targeting.gender} ${targeting.age_min}-${targeting.age_max}, ${targeting.interests.join(', ')}`;
      body.innerHTML += `<tr>
        <td class="fw-semibold">${a.name}</td>
        <td><span class="badge ${a.status === 'ACTIVE' ? 'bg-success' : 'bg-secondary'}">${a.status}</span></td>
        <td class="small">${targetStr}</td>
        <td>$${a.budget_daily}</td>
        <td>$${a.spend.toLocaleString()}</td>
        <td>${a.reach.toLocaleString()}</td>
        <td>${a.clicks.toLocaleString()}</td>
        <td>$${a.cpc.toFixed(2)}</td>
        <td>${a.conversions}</td>
      </tr>`;
    });
  }

  // ── Ads ─────────────────────────────────────────────────────────────────
  async function metaLoadAds() {
    const adsetId = document.getElementById('metaAdSetSelect').value;
    if (!adsetId) return;
    try {
      const res = await fetch(`/api/connectors/meta-ads/ads?adset_id=${adsetId}`);
      const data = await res.json();
      metaState.ads = data.ads || [];
      metaRenderAds();
    } catch (e) { console.error('Meta load ads failed:', e); }
  }

  function metaRenderAds() {
    const container = document.getElementById('metaAdsContent');
    if (!container || metaState.ads.length === 0) {
      if (container) container.innerHTML = '<div class="text-muted small">No ads found for this ad set</div>';
      return;
    }

    let html = '<div class="row g-3">';
    metaState.ads.forEach(ad => {
      const formatColors = {CAROUSEL:'bg-primary', VIDEO:'bg-danger', IMAGE:'bg-success', STORIES:'bg-warning text-dark', DYNAMIC:'bg-info text-dark'};
      html += `
        <div class="col-md-6">
          <div class="card bg-dark border-secondary">
            <div class="card-body py-2">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                  <div class="fw-bold">${ad.name}</div>
                  <span class="badge ${formatColors[ad.format] || 'bg-secondary'}">${ad.format}</span>
                  <span class="badge ${ad.status === 'ACTIVE' ? 'bg-success' : 'bg-secondary'}">${ad.status}</span>
                </div>
                <div class="text-end small text-muted">${ad.thumbnail}</div>
              </div>
              <div class="small mb-2">
                <strong>Headline:</strong> ${ad.headline}<br>
                <strong>CTA:</strong> <code class="text-info">${ad.cta}</code>
              </div>
              <div class="d-flex gap-2 flex-wrap">
                <span class="badge bg-primary bg-opacity-25 text-primary">${ad.impressions.toLocaleString()} imp</span>
                <span class="badge bg-info bg-opacity-25 text-info">${ad.clicks} clicks</span>
                <span class="badge bg-warning bg-opacity-25 text-warning">CTR ${ad.ctr}%</span>
                <span class="badge bg-success bg-opacity-25 text-success">${ad.conversions} conv</span>
                <span class="badge bg-danger bg-opacity-25 text-danger">$${ad.spend.toFixed(2)}</span>
              </div>
            </div>
          </div>
        </div>
      `;
    });
    html += '</div>';
    container.innerHTML = html;
  }

  // ── Budget & Pacing ─────────────────────────────────────────────────────
  function metaRenderBudget() {
    const b = metaState.budgetPacing;
    if (!b) return;

    const overallPct = Math.round((b.spent / b.total_budget) * 100);
    const pacingColor = b.pacing_status === 'ON_TRACK' ? 'bg-success' : (b.pacing_status === 'OVERPACING' ? 'bg-danger' : 'bg-warning');

    let campaignBars = '';
    (b.campaigns || []).forEach(c => {
      const campColor = c.pacing === 'ON_TRACK' ? 'bg-success' : (c.pacing === 'OVERPACING' ? 'bg-danger' : 'bg-warning');
      const campIcon = c.pacing === 'ON_TRACK' ? '✅' : (c.pacing === 'OVERPACING' ? '⚠️' : '🔽');
      campaignBars += `
        <div class="mb-3">
          <div class="d-flex justify-content-between small mb-1">
            <span>${campIcon} ${c.name}</span>
            <span>$${c.spent.toLocaleString()} / $${c.budget.toLocaleString()} <span class="badge ${campColor} badge-sm">${c.pacing}</span></span>
          </div>
          <div class="progress" style="height:12px;">
            <div class="progress-bar ${campColor}" style="width:${c.pct}%;">${c.pct}%</div>
          </div>
        </div>
      `;
    });

    document.getElementById('metaBudgetContent').innerHTML = `
      <!-- Overall pacing -->
      <div class="card bg-dark border-secondary mb-4">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div>
              <h6 class="mb-0">Overall Budget Pacing</h6>
              <span class="badge ${pacingColor}">${b.pacing_status.replace('_', ' ')}</span>
            </div>
            <div class="text-end">
              <div class="fs-4 fw-bold">$${b.spent.toLocaleString()} <span class="text-muted fs-6">/ $${b.total_budget.toLocaleString()}</span></div>
              <div class="small text-muted">Remaining: $${b.remaining.toLocaleString()} · ${b.days_remaining} days left</div>
            </div>
          </div>
          <div class="progress mb-2" style="height:20px;">
            <div class="progress-bar ${pacingColor}" style="width:${overallPct}%;">${overallPct}% Spent</div>
          </div>
          <div class="d-flex justify-content-between small text-muted">
            <span>Daily avg: $${b.daily_avg_spend.toLocaleString()}</span>
            <span>Projected: $${b.projected_spend.toLocaleString()}</span>
          </div>
        </div>
      </div>

      <!-- Per-campaign pacing -->
      <div class="card bg-dark border-secondary">
        <div class="card-body">
          <h6 class="mb-3">Campaign-Level Pacing</h6>
          ${campaignBars}
        </div>
      </div>
    `;
  }

  // ── Reports ─────────────────────────────────────────────────────────────
  async function metaGenerateReport() {
    const container = document.getElementById('metaReportContent');
    container.innerHTML = '<div class="text-center py-3"><span class="spinner-border spinner-border-sm"></span> Generating report...</div>';
    await new Promise(r => setTimeout(r, 800));

    try {
      const accountId = document.getElementById('metaAccountSelect').value || 'act_123456789';
      const res = await fetch(`/api/connectors/meta-ads/reports?account_id=${accountId}`);
      const data = await res.json();
      metaState.reportRows = data.rows || [];

      let html = `<div class="small text-muted mb-2">Generated at ${data.generated_at} · ${metaState.reportRows.length} rows</div>`;
      html += `<div class="table-responsive"><table class="table table-dark table-striped table-hover table-sm">
        <thead><tr><th>Date</th><th>Campaign</th><th>Objective</th><th>Spend</th><th>Reach</th><th>Impressions</th><th>Clicks</th><th>Conv.</th><th>CTR</th><th>ROAS</th></tr></thead>
        <tbody>`;
      // Show first 20 rows
      metaState.reportRows.slice(0, 20).forEach(r => {
        html += `<tr>
          <td class="small">${r.date}</td>
          <td class="small fw-semibold">${r.campaign}</td>
          <td><span class="badge bg-secondary">${r.objective}</span></td>
          <td>$${r.spend.toFixed(2)}</td>
          <td>${r.reach.toLocaleString()}</td>
          <td>${r.impressions.toLocaleString()}</td>
          <td>${r.clicks}</td>
          <td>${r.conversions}</td>
          <td>${r.ctr}%</td>
          <td>${r.roas > 0 ? r.roas + 'x' : '—'}</td>
        </tr>`;
      });
      html += '</tbody></table></div>';
      if (metaState.reportRows.length > 20) {
        html += `<div class="small text-muted">Showing 20 of ${metaState.reportRows.length} rows. Export CSV for full data.</div>`;
      }
      container.innerHTML = html;
    } catch (e) {
      container.innerHTML = '<div class="alert alert-danger">Failed to generate report.</div>';
    }
  }

  // ── CSV Export ──────────────────────────────────────────────────────────
  function metaExportCSV(type) {
    if (type === 'campaigns' && metaState.campaigns.length) {
      downloadCSV('meta_campaigns.csv',
        ['Campaign', 'Objective', 'Status', 'Spend', 'Reach', 'Impressions', 'Clicks', 'CTR', 'ROAS', 'Conversions'],
        metaState.campaigns.map(c => [c.name, c.objective, c.status, c.spend, c.reach, c.impressions, c.clicks, c.ctr, c.roas, c.conversions])
      );
    } else if (type === 'adsets' && metaState.adsets.length) {
      downloadCSV('meta_adsets.csv',
        ['Ad Set', 'Status', 'Gender', 'Age Range', 'Interests', 'Budget/Day', 'Spend', 'Reach', 'Clicks', 'CPC', 'Conversions'],
        metaState.adsets.map(a => [a.name, a.status, a.targeting.gender, `${a.targeting.age_min}-${a.targeting.age_max}`, a.targeting.interests.join('; '), a.budget_daily, a.spend, a.reach, a.clicks, a.cpc, a.conversions])
      );
    } else if (type === 'ads' && metaState.ads.length) {
      downloadCSV('meta_ads.csv',
        ['Ad Name', 'Format', 'Status', 'Headline', 'CTA', 'Impressions', 'Clicks', 'CTR', 'Spend', 'Conversions'],
        metaState.ads.map(a => [a.name, a.format, a.status, a.headline, a.cta, a.impressions, a.clicks, a.ctr, a.spend, a.conversions])
      );
    } else if (type === 'report' && metaState.reportRows.length) {
      downloadCSV('meta_report.csv',
        ['Date', 'Campaign', 'Objective', 'Spend', 'Reach', 'Impressions', 'Clicks', 'Conversions', 'CTR', 'ROAS'],
        metaState.reportRows.map(r => [r.date, r.campaign, r.objective, r.spend, r.reach, r.impressions, r.clicks, r.conversions, r.ctr, r.roas])
      );
    }
  }

  // ── Test API Call ───────────────────────────────────────────────────────
  async function metaTestApiCall() {
    const method = document.getElementById('metaApiMethod').value;
    const endpoint = document.getElementById('metaApiEndpoint').value;
    const container = document.getElementById('metaApiResult');
    container.innerHTML = '<div class="text-center py-3"><span class="spinner-border spinner-border-sm"></span> Sending request...</div>';

    try {
      const res = await fetch('/api/connectors/meta-ads/test-call', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ method, endpoint })
      });
      const data = await res.json();

      container.innerHTML = `
        <div class="row g-3">
          <div class="col-md-6">
            <div class="card bg-dark border-info">
              <div class="card-header bg-info bg-opacity-25 small fw-bold">
                <i class="bi bi-arrow-up-circle"></i> Request
              </div>
              <div class="card-body p-2">
                <pre class="mb-0 small" style="max-height:250px; overflow:auto; color:#8be9fd;">${method} ${data.request.endpoint}\n\nHeaders:\n${JSON.stringify(data.request.headers, null, 2)}</pre>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card bg-dark border-success">
              <div class="card-header bg-success bg-opacity-25 small fw-bold">
                <i class="bi bi-arrow-down-circle"></i> Response
                <span class="badge bg-success ms-2">${data.response.status_code}</span>
                <span class="badge bg-secondary ms-1">${data.latency_ms}ms</span>
              </div>
              <div class="card-body p-2">
                <pre class="mb-0 small" style="max-height:250px; overflow:auto; color:#50fa7b;">${JSON.stringify(data.response.body, null, 2)}</pre>
              </div>
            </div>
          </div>
        </div>
        <div class="mt-2 small text-muted">
          <i class="bi bi-speedometer"></i> Quota: ${data.quota.calls_remaining.toLocaleString()} / ${data.quota.hourly_limit.toLocaleString()} calls remaining (resets ${data.quota.reset_at})
        </div>
      `;
    } catch (e) {
      container.innerHTML = '<div class="alert alert-danger">API call failed.</div>';
    }
  }

  // ── Settings Save ───────────────────────────────────────────────────────
  async function metaSaveSettings() {
    const config = {
      level: document.getElementById('metaSettingLevel').value,
      date_range: document.getElementById('metaSettingDateRange').value,
      pixel_id: document.getElementById('metaSettingPixelId').value,
      attribution: document.getElementById('metaSettingAttribution').value,
      metrics: {
        reach: document.getElementById('metaMetricReach').checked,
        impressions: document.getElementById('metaMetricImpressions').checked,
        spend: document.getElementById('metaMetricSpend').checked,
        clicks: document.getElementById('metaMetricClicks').checked,
        cpc: document.getElementById('metaMetricCPC').checked,
        roas: document.getElementById('metaMetricROAS').checked,
        conversions: document.getElementById('metaMetricConversions').checked,
        frequency: document.getElementById('metaMetricFrequency').checked,
      }
    };
    try {
      await fetch('/api/connectors/meta-ads', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: metaState.connected ? 'Connected' : 'Disconnected', config })
      });
      if (window.showToast) window.showToast('Settings Saved', 'Meta Ads settings updated.', 'success');
    } catch (e) {
      if (window.showToast) window.showToast('Error', 'Failed to save settings.', 'danger');
    }
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // TIKTOK ADS JS ENGINE
  // ═══════════════════════════════════════════════════════════════════════════

  let tiktokState = { connected: false, account: null, campaigns: [], adGroups: [], ads: [], overview: null, report: null };

  function tiktokInit() {
    fetch('/api/connectors/tiktok-ads').then(r => r.json()).then(d => {
      tiktokState.connected = d.status === 'Connected';
      document.getElementById('tiktokStatusBadge').innerHTML = tiktokState.connected
        ? '<span class="badge bg-success"><i class="bi bi-check-circle"></i> Connected</span>'
        : '<span class="badge bg-secondary"><i class="bi bi-x-circle"></i> Disconnected</span>';
    }).catch(() => {});
  }

  async function tiktokConnect() {
    // Save connected status
    await fetch('/api/connectors/tiktok-ads', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({status:'Connected',config:{account:'adv_987654321'}})
    });
    tiktokState.connected = true;
    document.getElementById('tiktokStatusBadge').innerHTML = '<span class="badge bg-success"><i class="bi bi-check-circle"></i> Connected</span>';
    // Load overview
    await tiktokLoadAccount();
  }

  async function tiktokLoadAccount() {
    try {
      const [overviewRes, campaignsRes, budgetRes] = await Promise.all([
        fetch('/api/connectors/tiktok-ads/overview?advertiser_id=adv_987654321'),
        fetch('/api/connectors/tiktok-ads/campaigns'),
        fetch('/api/connectors/tiktok-ads/budget-pacing?advertiser_id=adv_987654321'),
      ]);
      const overviewData = await overviewRes.json();
      const campaignsData = await campaignsRes.json();
      const budgetData = await budgetRes.json();

      tiktokState.overview = overviewData.overview;
      tiktokState.campaigns = campaignsData.campaigns;
      tiktokState.budget = budgetData.pacing;

      tiktokRenderOverview();
      tiktokRenderCampaigns();
      tiktokRenderBudget();

      // Populate campaign dropdown for ad groups tab
      const campSelect = document.getElementById('tiktokAdGroupCampaignSelect');
      campSelect.innerHTML = '<option value="">Select campaign…</option>';
      tiktokState.campaigns.forEach(c => {
        campSelect.innerHTML += `<option value="${c.campaign_id}">${c.name}</option>`;
      });
    } catch(e) {
      document.getElementById('tiktokOverviewContent').innerHTML = '<div class="alert alert-danger">Failed to load TikTok data.</div>';
    }
  }

  function tiktokRenderOverview() {
    const o = tiktokState.overview;
    if (!o) return;

    // Sparkline SVG for daily spend + views
    let sparkSVG = '';
    if (o.daily_spend && o.daily_spend.length) {
      const maxS = Math.max(...o.daily_spend.map(d => d.spend));
      const maxV = Math.max(...o.daily_spend.map(d => d.views));
      const w = 340, h = 60;
      const spendPts = o.daily_spend.map((d, i) => `${(i/(o.daily_spend.length-1))*w},${h - (d.spend/maxS)*h}`).join(' ');
      const viewsPts = o.daily_spend.map((d, i) => `${(i/(o.daily_spend.length-1))*w},${h - (d.views/maxV)*h}`).join(' ');
      sparkSVG = `<svg width="${w}" height="${h}" class="mt-2">
        <polyline points="${spendPts}" fill="none" stroke="#00f2ea" stroke-width="2"/>
        <polyline points="${viewsPts}" fill="none" stroke="#ff0050" stroke-width="2" stroke-dasharray="4"/>
      </svg>
      <div class="mt-1"><small><span style="color:#00f2ea">━</span> Spend &nbsp; <span style="color:#ff0050">╌</span> Video Views</small></div>`;
    }

    // Placement breakdown
    let placementHTML = '';
    if (o.placement_breakdown && o.placement_breakdown.length) {
      placementHTML = '<h6 class="mt-3">Placement Breakdown</h6><div class="row g-2">';
      o.placement_breakdown.forEach(p => {
        placementHTML += `<div class="col-3"><div class="card bg-dark border-secondary"><div class="card-body text-center p-2">
          <small class="text-muted">${p.placement}</small><br><strong>${p.pct}%</strong><br>
          <small>$${p.spend.toLocaleString()}</small><br><small class="text-muted">${p.views.toLocaleString()} views</small>
        </div></div></div>`;
      });
      placementHTML += '</div>';
    }

    document.getElementById('tiktokOverviewContent').innerHTML = `
      <div class="row g-3 mb-3">
        <div class="col-md-2"><div class="card bg-dark border-info"><div class="card-body text-center p-2">
          <small class="text-muted">Spend</small><h5 class="mb-0">$${o.spend.toLocaleString()}</h5></div></div></div>
        <div class="col-md-2"><div class="card bg-dark border-info"><div class="card-body text-center p-2">
          <small class="text-muted">Video Views</small><h5 class="mb-0">${(o.video_views/1000).toFixed(0)}K</h5></div></div></div>
        <div class="col-md-2"><div class="card bg-dark border-info"><div class="card-body text-center p-2">
          <small class="text-muted">Completion Rate</small><h5 class="mb-0">${o.completion_rate}%</h5></div></div></div>
        <div class="col-md-2"><div class="card bg-dark border-info"><div class="card-body text-center p-2">
          <small class="text-muted">Engagement</small><h5 class="mb-0">${o.engagement_rate}%</h5></div></div></div>
        <div class="col-md-2"><div class="card bg-dark border-info"><div class="card-body text-center p-2">
          <small class="text-muted">ROAS</small><h5 class="mb-0">${o.roas}x</h5></div></div></div>
        <div class="col-md-2"><div class="card bg-dark border-info"><div class="card-body text-center p-2">
          <small class="text-muted">Conversions</small><h5 class="mb-0">${o.conversions.toLocaleString()}</h5></div></div></div>
      </div>
      <div class="row g-3 mb-3">
        <div class="col-md-2"><div class="card bg-dark border-secondary"><div class="card-body text-center p-2">
          <small class="text-muted">Reach</small><h5 class="mb-0">${(o.reach/1000).toFixed(0)}K</h5></div></div></div>
        <div class="col-md-2"><div class="card bg-dark border-secondary"><div class="card-body text-center p-2">
          <small class="text-muted">Clicks</small><h5 class="mb-0">${(o.clicks/1000).toFixed(1)}K</h5></div></div></div>
        <div class="col-md-2"><div class="card bg-dark border-secondary"><div class="card-body text-center p-2">
          <small class="text-muted">CPC</small><h5 class="mb-0">$${o.cpc}</h5></div></div></div>
        <div class="col-md-2"><div class="card bg-dark border-secondary"><div class="card-body text-center p-2">
          <small class="text-muted">Likes</small><h5 class="mb-0">${(o.likes/1000).toFixed(0)}K</h5></div></div></div>
        <div class="col-md-2"><div class="card bg-dark border-secondary"><div class="card-body text-center p-2">
          <small class="text-muted">Comments</small><h5 class="mb-0">${(o.comments/1000).toFixed(1)}K</h5></div></div></div>
        <div class="col-md-2"><div class="card bg-dark border-secondary"><div class="card-body text-center p-2">
          <small class="text-muted">Shares</small><h5 class="mb-0">${(o.shares/1000).toFixed(1)}K</h5></div></div></div>
      </div>
      <h6>Daily Spend & Video Views (7 days)</h6>
      ${sparkSVG}
      ${placementHTML}
    `;
  }

  function tiktokRenderCampaigns() {
    const statusF = document.getElementById('tiktokCampStatusFilter').value;
    const objF = document.getElementById('tiktokCampObjectiveFilter').value;
    let filtered = tiktokState.campaigns;
    if (statusF !== 'ALL') filtered = filtered.filter(c => c.status === statusF);
    if (objF !== 'ALL') filtered = filtered.filter(c => c.objective === objF);

    const tbody = document.getElementById('tiktokCampaignsBody');
    tbody.innerHTML = '';
    filtered.forEach(c => {
      const statusBadge = c.status === 'ACTIVE'
        ? '<span class="badge bg-success">Active</span>'
        : '<span class="badge bg-warning text-dark">Paused</span>';
      tbody.innerHTML += `<tr>
        <td>${c.name}</td><td><small>${c.objective}</small></td><td>${statusBadge}</td>
        <td>$${c.spend.toLocaleString()}</td><td>${c.video_views.toLocaleString()}</td>
        <td>${c.completion_rate}%</td><td>${c.engagement_rate}%</td>
        <td>${c.roas > 0 ? c.roas.toFixed(1)+'x' : '–'}</td>
      </tr>`;
    });

    // Totals
    const tfoot = document.getElementById('tiktokCampaignsFoot');
    const totSpend = filtered.reduce((s, c) => s + c.spend, 0);
    const totViews = filtered.reduce((s, c) => s + c.video_views, 0);
    const avgComp = filtered.length ? (filtered.reduce((s, c) => s + c.completion_rate, 0) / filtered.length).toFixed(1) : 0;
    const avgEng = filtered.length ? (filtered.reduce((s, c) => s + c.engagement_rate, 0) / filtered.length).toFixed(1) : 0;
    tfoot.innerHTML = `<tr class="fw-bold"><td>Total (${filtered.length})</td><td></td><td></td>
      <td>$${totSpend.toLocaleString()}</td><td>${totViews.toLocaleString()}</td>
      <td>${avgComp}%</td><td>${avgEng}%</td><td></td></tr>`;
  }

  async function tiktokLoadAdGroups() {
    const cid = document.getElementById('tiktokAdGroupCampaignSelect').value;
    if (!cid) return;
    try {
      const res = await fetch(`/api/connectors/tiktok-ads/adgroups?campaign_id=${cid}`);
      const data = await res.json();
      tiktokState.adGroups = data.ad_groups;
      tiktokRenderAdGroups();

      // Populate ad group dropdown in Ads tab
      const agSelect = document.getElementById('tiktokAdsAdGroupSelect');
      agSelect.innerHTML = '<option value="">Select ad group…</option>';
      tiktokState.adGroups.forEach(g => {
        agSelect.innerHTML += `<option value="${g.adgroup_id}">${g.name}</option>`;
      });
    } catch(e) {}
  }

  function tiktokRenderAdGroups() {
    const tbody = document.getElementById('tiktokAdGroupsBody');
    tbody.innerHTML = '';
    tiktokState.adGroups.forEach(g => {
      const t = g.targeting;
      const targetStr = [
        t.age ? `Age: ${t.age}` : '',
        t.gender ? `Gender: ${t.gender}` : '',
        t.interests ? t.interests.join(', ') : '',
        t.audiences ? `<br><small class="text-info">${t.audiences.join(', ')}</small>` : '',
        t.music ? `<br><small>🎵 ${t.music}</small>` : '',
      ].filter(Boolean).join(' · ');
      const statusBadge = g.status === 'ACTIVE'
        ? '<span class="badge bg-success">Active</span>'
        : '<span class="badge bg-warning text-dark">Paused</span>';
      tbody.innerHTML += `<tr>
        <td>${g.name}</td><td>${statusBadge}</td>
        <td>$${g.budget.toLocaleString()}</td><td>$${g.spend.toLocaleString()}</td>
        <td>${g.video_views.toLocaleString()}</td><td>${g.completion_rate}%</td>
        <td><small>${targetStr}</small></td>
      </tr>`;
    });
  }

  async function tiktokLoadAds() {
    const agid = document.getElementById('tiktokAdsAdGroupSelect').value;
    if (!agid) return;
    try {
      const res = await fetch(`/api/connectors/tiktok-ads/ads?adgroup_id=${agid}`);
      const data = await res.json();
      tiktokState.ads = data.ads;
      tiktokRenderAds();
    } catch(e) {}
  }

  function tiktokRenderAds() {
    const container = document.getElementById('tiktokAdsContent');
    container.innerHTML = '';
    tiktokState.ads.forEach(a => {
      const statusBadge = a.status === 'ACTIVE'
        ? '<span class="badge bg-success">Active</span>'
        : '<span class="badge bg-warning text-dark">Paused</span>';
      const formatBadge = a.format.includes('Spark') ? 'bg-info' : a.format.includes('TopView') ? 'bg-danger' : 'bg-primary';
      container.innerHTML += `<div class="col-md-6">
        <div class="card bg-dark border-secondary h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between mb-2">
              <span class="badge ${formatBadge}">${a.format}</span>
              ${statusBadge}
            </div>
            <div class="text-center mb-2" style="font-size:2.5rem">${a.thumbnail}</div>
            <h6>${a.name}</h6>
            <p class="text-muted small mb-1">"${a.headline}"</p>
            <span class="badge bg-outline-light border mb-2"><i class="bi bi-clock"></i> ${a.video_duration}</span>
            <span class="badge bg-outline-light border mb-2">${a.cta}</span>
            <div class="row text-center mt-2">
              <div class="col-4"><small class="text-muted">Views</small><br><strong>${a.video_views.toLocaleString()}</strong></div>
              <div class="col-4"><small class="text-muted">Complete</small><br><strong>${a.completion_rate}%</strong></div>
              <div class="col-4"><small class="text-muted">Engage</small><br><strong>${a.engagement_rate}%</strong></div>
            </div>
            <div class="row text-center mt-1">
              <div class="col-4"><small class="text-muted">❤️ ${a.likes.toLocaleString()}</small></div>
              <div class="col-4"><small class="text-muted">🔄 ${a.shares.toLocaleString()}</small></div>
              <div class="col-4"><small class="text-muted">💬 ${a.comments.toLocaleString()}</small></div>
            </div>
          </div>
        </div>
      </div>`;
    });
  }

  function tiktokRenderBudget() {
    const b = tiktokState.budget;
    if (!b) return;
    const pct = Math.round((b.overall_spent / b.overall_budget) * 100);
    const barColor = pct > 90 ? 'bg-danger' : pct > 75 ? 'bg-warning' : 'bg-info';
    const pacingBadge = b.pacing_status === 'ON_TRACK' ? '<span class="badge bg-success">On Track</span>'
      : b.pacing_status === 'OVERPACING' ? '<span class="badge bg-danger">Over-pacing</span>'
      : '<span class="badge bg-warning text-dark">Under-pacing</span>';

    let campaignGauges = '';
    b.campaigns.forEach(c => {
      const cPct = Math.round((c.spent / c.budget) * 100);
      const cColor = c.pacing === 'OVERPACING' ? 'bg-danger' : c.pacing === 'UNDERPACING' ? 'bg-warning' : c.pacing === 'PAUSED' ? 'bg-secondary' : 'bg-info';
      const pacingLabel = c.pacing === 'PAUSED' ? '<span class="badge bg-secondary">Paused</span>'
        : c.pacing === 'OVERPACING' ? '<span class="badge bg-danger">Over</span>'
        : c.pacing === 'UNDERPACING' ? '<span class="badge bg-warning text-dark">Under</span>'
        : '<span class="badge bg-success">OK</span>';
      campaignGauges += `<div class="mb-3">
        <div class="d-flex justify-content-between"><small>${c.name}</small>${pacingLabel}</div>
        <div class="progress" style="height:14px;">
          <div class="progress-bar ${cColor}" style="width:${Math.min(cPct,100)}%">${cPct}%</div>
        </div>
        <small class="text-muted">$${c.spent.toLocaleString()} / $${c.budget.toLocaleString()} · Avg $${c.daily_avg.toFixed(0)}/day</small>
      </div>`;
    });

    document.getElementById('tiktokBudgetContent').innerHTML = `
      <div class="card bg-dark border-info mb-4">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">Overall Budget</h6>${pacingBadge}
          </div>
          <div class="progress mb-2" style="height:22px;">
            <div class="progress-bar ${barColor}" style="width:${pct}%">${pct}% ($${b.overall_spent.toLocaleString()} / $${b.overall_budget.toLocaleString()})</div>
          </div>
          <small class="text-muted">Daily: $${b.daily_spent.toFixed(0)} / $${b.daily_budget} target · ${b.days_remaining} days remaining</small>
        </div>
      </div>
      <h6>Campaign Pacing</h6>
      ${campaignGauges}
    `;
  }

  async function tiktokGenerateReport() {
    try {
      const res = await fetch('/api/connectors/tiktok-ads/reports?advertiser_id=adv_987654321');
      const data = await res.json();
      tiktokState.report = data.rows;

      // Paginated table (first 20 rows)
      const page = tiktokState.report.slice(0, 20);
      let html = `<p class="text-muted">${data.total_rows} rows generated · Showing first 20</p>
        <div class="table-responsive"><table class="table table-dark table-striped table-sm">
        <thead><tr><th>Date</th><th>Campaign</th><th>Objective</th><th>Spend</th><th>Video Views</th><th>Completion %</th><th>Engagement %</th><th>ROAS</th></tr></thead><tbody>`;
      page.forEach(r => {
        html += `<tr><td>${r.date}</td><td>${r.campaign}</td><td><small>${r.objective}</small></td>
          <td>$${r.spend.toFixed(2)}</td><td>${r.video_views.toLocaleString()}</td>
          <td>${r.completion_rate}%</td><td>${r.engagement_rate}%</td>
          <td>${r.roas > 0 ? r.roas.toFixed(1)+'x' : '–'}</td></tr>`;
      });
      html += '</tbody></table></div>';
      document.getElementById('tiktokReportContent').innerHTML = html;
    } catch(e) {
      document.getElementById('tiktokReportContent').innerHTML = '<div class="alert alert-danger">Failed to generate report.</div>';
    }
  }

  function tiktokExportCSV(type) {
    if (type === 'campaigns' && tiktokState.campaigns.length) {
      downloadCSV('tiktok_campaigns.csv',
        ['Campaign','Objective','Status','Budget','Spend','Video Views','Completion Rate','Engagement Rate','ROAS'],
        tiktokState.campaigns.map(c => [c.name, c.objective, c.status, c.budget, c.spend, c.video_views, c.completion_rate+'%', c.engagement_rate+'%', c.roas])
      );
    } else if (type === 'report' && tiktokState.report) {
      downloadCSV('tiktok_report.csv',
        ['Date','Campaign','Objective','Spend','Video Views','Completion Rate','Engagement Rate','ROAS'],
        tiktokState.report.map(r => [r.date, r.campaign, r.objective, r.spend, r.video_views, r.completion_rate+'%', r.engagement_rate+'%', r.roas])
      );
    }
  }

  async function tiktokTestApiCall() {
    const endpoint = document.getElementById('tiktokApiEndpoint').value;
    document.getElementById('tiktokApiResult').textContent = 'Calling TikTok Marketing API…';
    try {
      const res = await fetch('/api/connectors/tiktok-ads/test-call', {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ endpoint, method: 'GET' })
      });
      const data = await res.json();
      document.getElementById('tiktokApiResult').textContent = JSON.stringify(data, null, 2);
    } catch(e) {
      document.getElementById('tiktokApiResult').textContent = 'Error: ' + e.message;
    }
  }

  async function tiktokSaveSettings() {
    const config = {
      account: document.getElementById('tiktokSettingsAccount').value,
      date_range: document.getElementById('tiktokSettingsDateRange').value,
      pixel_id: document.getElementById('tiktokSettingsPixel').value,
      attribution: document.getElementById('tiktokSettingsAttribution').value,
    };
    try {
      await fetch('/api/connectors/tiktok-ads', {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ status: tiktokState.connected ? 'Connected' : 'Disconnected', config })
      });
      if (window.showToast) window.showToast('Settings Saved', 'TikTok Ads settings updated.', 'success');
    } catch (e) {
      if (window.showToast) window.showToast('Error', 'Failed to save settings.', 'danger');
    }
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // LINKEDIN ADS JS ENGINE
  // ═══════════════════════════════════════════════════════════════════════════

  let linkedinState = { connected: false, account: null, campaigns: [], adSets: [], ads: [], overview: null, budget: null, report: null };

  function linkedinInit() {
    fetch('/api/connectors/linkedin-ads').then(r => r.json()).then(d => {
      linkedinState.connected = d.status === 'Connected';
      document.getElementById('linkedinStatusBadge').innerHTML = linkedinState.connected
        ? '<span class="badge bg-success"><i class="bi bi-check-circle"></i> Connected</span>'
        : '<span class="badge bg-secondary"><i class="bi bi-x-circle"></i> Disconnected</span>';
    }).catch(() => {});
  }

  async function linkedinConnect() {
    await fetch('/api/connectors/linkedin-ads', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({status:'Connected',config:{account:'li_acc_987654321'}})
    });
    linkedinState.connected = true;
    document.getElementById('linkedinStatusBadge').innerHTML = '<span class="badge bg-success"><i class="bi bi-check-circle"></i> Connected</span>';
    await linkedinLoadAccount();
  }

  async function linkedinLoadAccount() {
    try {
      const [overviewRes, campaignsRes, budgetRes] = await Promise.all([
        fetch('/api/connectors/linkedin-ads/overview?account_id=li_acc_987654321'),
        fetch('/api/connectors/linkedin-ads/campaigns'),
        fetch('/api/connectors/linkedin-ads/budget-pacing?account_id=li_acc_987654321'),
      ]);
      const overviewData = await overviewRes.json();
      const campaignsData = await campaignsRes.json();
      const budgetData = await budgetRes.json();

      linkedinState.overview = overviewData.overview;
      linkedinState.campaigns = campaignsData.campaigns;
      linkedinState.budget = budgetData.pacing;

      linkedinRenderOverview();
      linkedinRenderCampaigns();
      linkedinRenderBudget();

      // Populate campaign dropdown for ad sets tab
      const campSelect = document.getElementById('linkedinAdSetCampaignSelect');
      campSelect.innerHTML = '<option value="">Select campaign…</option>';
      linkedinState.campaigns.forEach(c => {
        campSelect.innerHTML += `<option value="${c.campaign_id}">${c.name}</option>`;
      });
    } catch(e) {
      document.getElementById('linkedinOverviewContent').innerHTML = '<div class="alert alert-danger">Failed to load LinkedIn data.</div>';
    }
  }

  function linkedinRenderOverview() {
    const o = linkedinState.overview;
    if (!o) return;

    // Sparkline: daily spend + leads
    let sparkSVG = '';
    if (o.daily_spend && o.daily_spend.length) {
      const maxS = Math.max(...o.daily_spend.map(d => d.spend));
      const maxL = Math.max(...o.daily_spend.map(d => d.leads));
      const w = 340, h = 60;
      const spendPts = o.daily_spend.map((d, i) => `${(i/(o.daily_spend.length-1))*w},${h - (d.spend/maxS)*h}`).join(' ');
      const leadsPts = o.daily_spend.map((d, i) => `${(i/(o.daily_spend.length-1))*w},${h - (d.leads/maxL)*h}`).join(' ');
      sparkSVG = `<svg width="${w}" height="${h}" class="mt-2">
        <polyline points="${spendPts}" fill="none" stroke="#0a66c2" stroke-width="2"/>
        <polyline points="${leadsPts}" fill="none" stroke="#44b35c" stroke-width="2" stroke-dasharray="4"/>
      </svg>
      <div class="mt-1"><small><span style="color:#0a66c2">━</span> Spend &nbsp; <span style="color:#44b35c">╌</span> Leads</small></div>`;
    }

    // Audience breakdown
    let audienceHTML = '';
    if (o.audience_breakdown && o.audience_breakdown.length) {
      audienceHTML = '<h6 class="mt-3">Audience Breakdown</h6><div class="row g-2">';
      o.audience_breakdown.forEach(a => {
        audienceHTML += `<div class="col-3"><div class="card bg-dark border-secondary"><div class="card-body text-center p-2">
          <small class="text-muted">${a.segment}</small><br><strong>${a.pct}%</strong><br>
          <small>$${a.spend.toLocaleString()}</small><br><small class="text-info">${a.leads} leads</small>
        </div></div></div>`;
      });
      audienceHTML += '</div>';
    }

    document.getElementById('linkedinOverviewContent').innerHTML = `
      <div class="row g-3 mb-3">
        <div class="col-md-2"><div class="card bg-dark border-primary"><div class="card-body text-center p-2">
          <small class="text-muted">Spend</small><h5 class="mb-0">$${o.spend.toLocaleString()}</h5></div></div></div>
        <div class="col-md-2"><div class="card bg-dark border-primary"><div class="card-body text-center p-2">
          <small class="text-muted">Leads</small><h5 class="mb-0">${o.leads}</h5></div></div></div>
        <div class="col-md-2"><div class="card bg-dark border-primary"><div class="card-body text-center p-2">
          <small class="text-muted">Cost/Lead</small><h5 class="mb-0">$${o.cost_per_lead.toFixed(2)}</h5></div></div></div>
        <div class="col-md-2"><div class="card bg-dark border-primary"><div class="card-body text-center p-2">
          <small class="text-muted">ROAS</small><h5 class="mb-0">${o.roas}x</h5></div></div></div>
        <div class="col-md-2"><div class="card bg-dark border-primary"><div class="card-body text-center p-2">
          <small class="text-muted">CTR</small><h5 class="mb-0">${o.ctr}%</h5></div></div></div>
        <div class="col-md-2"><div class="card bg-dark border-primary"><div class="card-body text-center p-2">
          <small class="text-muted">Conversions</small><h5 class="mb-0">${o.conversions}</h5></div></div></div>
      </div>
      <div class="row g-3 mb-3">
        <div class="col-md-2"><div class="card bg-dark border-secondary"><div class="card-body text-center p-2">
          <small class="text-muted">Impressions</small><h5 class="mb-0">${(o.impressions/1000).toFixed(0)}K</h5></div></div></div>
        <div class="col-md-2"><div class="card bg-dark border-secondary"><div class="card-body text-center p-2">
          <small class="text-muted">Clicks</small><h5 class="mb-0">${(o.clicks/1000).toFixed(1)}K</h5></div></div></div>
        <div class="col-md-2"><div class="card bg-dark border-secondary"><div class="card-body text-center p-2">
          <small class="text-muted">CPC</small><h5 class="mb-0">$${o.cpc}</h5></div></div></div>
        <div class="col-md-2"><div class="card bg-dark border-secondary"><div class="card-body text-center p-2">
          <small class="text-muted">Engagement</small><h5 class="mb-0">${o.engagement_rate}%</h5></div></div></div>
        <div class="col-md-2"><div class="card bg-dark border-secondary"><div class="card-body text-center p-2">
          <small class="text-muted">Follows</small><h5 class="mb-0">${o.follows}</h5></div></div></div>
        <div class="col-md-2"><div class="card bg-dark border-secondary"><div class="card-body text-center p-2">
          <small class="text-muted">Social Actions</small><h5 class="mb-0">${(o.social_actions/1000).toFixed(1)}K</h5></div></div></div>
      </div>
      <h6>Daily Spend & Leads (7 days)</h6>
      ${sparkSVG}
      ${audienceHTML}
    `;
  }

  function linkedinRenderCampaigns() {
    const statusF = document.getElementById('linkedinCampStatusFilter').value;
    const objF = document.getElementById('linkedinCampObjectiveFilter').value;
    let filtered = linkedinState.campaigns;
    if (statusF !== 'ALL') filtered = filtered.filter(c => c.status === statusF);
    if (objF !== 'ALL') filtered = filtered.filter(c => c.objective === objF);

    const tbody = document.getElementById('linkedinCampaignsBody');
    tbody.innerHTML = '';
    filtered.forEach(c => {
      const statusBadge = c.status === 'ACTIVE'
        ? '<span class="badge bg-success">Active</span>'
        : '<span class="badge bg-warning text-dark">Paused</span>';
      tbody.innerHTML += `<tr>
        <td>${c.name}</td><td><small>${c.objective.replace(/_/g,' ')}</small></td><td><small>${c.format.replace(/_/g,' ')}</small></td><td>${statusBadge}</td>
        <td>$${c.spend.toLocaleString()}</td><td>${c.impressions.toLocaleString()}</td>
        <td>${c.ctr}%</td><td>${c.leads}</td>
        <td>${c.cost_per_lead > 0 ? '$'+c.cost_per_lead.toFixed(2) : '–'}</td>
        <td>${c.roas > 0 ? c.roas.toFixed(1)+'x' : '–'}</td>
      </tr>`;
    });

    const tfoot = document.getElementById('linkedinCampaignsFoot');
    const totSpend = filtered.reduce((s, c) => s + c.spend, 0);
    const totImpressions = filtered.reduce((s, c) => s + c.impressions, 0);
    const totLeads = filtered.reduce((s, c) => s + c.leads, 0);
    const avgCTR = filtered.length ? (filtered.reduce((s, c) => s + c.ctr, 0) / filtered.length).toFixed(2) : 0;
    tfoot.innerHTML = `<tr class="fw-bold"><td>Total (${filtered.length})</td><td></td><td></td><td></td>
      <td>$${totSpend.toLocaleString()}</td><td>${totImpressions.toLocaleString()}</td>
      <td>${avgCTR}%</td><td>${totLeads}</td><td></td><td></td></tr>`;
  }

  async function linkedinLoadAdSets() {
    const cid = document.getElementById('linkedinAdSetCampaignSelect').value;
    if (!cid) return;
    try {
      const res = await fetch(`/api/connectors/linkedin-ads/adsets?campaign_id=${cid}`);
      const data = await res.json();
      linkedinState.adSets = data.ad_sets;
      linkedinRenderAdSets();

      // Populate ad set dropdown in Ads tab
      const asSelect = document.getElementById('linkedinAdsAdSetSelect');
      asSelect.innerHTML = '<option value="">Select ad set…</option>';
      linkedinState.adSets.forEach(s => {
        asSelect.innerHTML += `<option value="${s.adset_id}">${s.name}</option>`;
      });
    } catch(e) {}
  }

  function linkedinRenderAdSets() {
    const tbody = document.getElementById('linkedinAdSetsBody');
    tbody.innerHTML = '';
    linkedinState.adSets.forEach(s => {
      const t = s.targeting;
      const parts = [];
      if (t.job_titles) parts.push('🎯 ' + t.job_titles.join(', '));
      if (t.job_functions) parts.push('📋 ' + t.job_functions.join(', '));
      if (t.company_size) parts.push('🏢 ' + t.company_size + ' emp');
      if (t.industries && t.industries[0] !== 'All') parts.push('🏭 ' + t.industries.join(', '));
      if (t.seniority) parts.push('📊 ' + t.seniority);
      if (t.audiences) parts.push('<span class="text-info">👥 ' + t.audiences.join(', ') + '</span>');
      if (t.skills) parts.push('💡 ' + t.skills.join(', '));
      const targetStr = parts.join('<br>');
      const statusBadge = s.status === 'ACTIVE'
        ? '<span class="badge bg-success">Active</span>'
        : '<span class="badge bg-warning text-dark">Paused</span>';
      tbody.innerHTML += `<tr>
        <td>${s.name}</td><td>${statusBadge}</td>
        <td>$${s.budget.toLocaleString()}</td><td>$${s.spend.toLocaleString()}</td>
        <td>${s.leads}</td><td>${s.ctr}%</td>
        <td><small>${targetStr}</small></td>
      </tr>`;
    });
  }

  async function linkedinLoadAds() {
    const asid = document.getElementById('linkedinAdsAdSetSelect').value;
    if (!asid) return;
    try {
      const res = await fetch(`/api/connectors/linkedin-ads/ads?adset_id=${asid}`);
      const data = await res.json();
      linkedinState.ads = data.ads;
      linkedinRenderAds();
    } catch(e) {}
  }

  function linkedinRenderAds() {
    const container = document.getElementById('linkedinAdsContent');
    container.innerHTML = '';
    linkedinState.ads.forEach(a => {
      const statusBadge = a.status === 'ACTIVE'
        ? '<span class="badge bg-success">Active</span>'
        : '<span class="badge bg-warning text-dark">Paused</span>';
      const formatColor = a.format.includes('Video') ? 'bg-danger' : a.format.includes('Carousel') ? 'bg-info'
        : a.format.includes('Document') ? 'bg-warning text-dark' : a.format.includes('Message') ? 'bg-purple' : 'bg-primary';
      container.innerHTML += `<div class="col-md-6">
        <div class="card bg-dark border-secondary h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between mb-2">
              <span class="badge ${formatColor}">${a.format}</span>
              ${statusBadge}
            </div>
            <div class="text-center mb-2" style="font-size:2.5rem">${a.thumbnail}</div>
            <h6>${a.name}</h6>
            <p class="mb-1"><strong>"${a.headline}"</strong></p>
            <p class="text-muted small mb-2">${a.description}</p>
            <span class="badge bg-outline-light border mb-2">${a.cta}</span>
            <div class="row text-center mt-2">
              <div class="col-3"><small class="text-muted">Impr.</small><br><strong>${a.impressions.toLocaleString()}</strong></div>
              <div class="col-3"><small class="text-muted">CTR</small><br><strong>${a.ctr}%</strong></div>
              <div class="col-3"><small class="text-muted">Leads</small><br><strong>${a.leads}</strong></div>
              <div class="col-3"><small class="text-muted">CPL</small><br><strong>$${a.cost_per_lead.toFixed(2)}</strong></div>
            </div>
          </div>
        </div>
      </div>`;
    });
  }

  function linkedinRenderBudget() {
    const b = linkedinState.budget;
    if (!b) return;
    const pct = Math.round((b.overall_spent / b.overall_budget) * 100);
    const barColor = pct > 90 ? 'bg-danger' : pct > 75 ? 'bg-warning' : 'bg-primary';
    const pacingBadge = b.pacing_status === 'ON_TRACK' ? '<span class="badge bg-success">On Track</span>'
      : b.pacing_status === 'OVERPACING' ? '<span class="badge bg-danger">Over-pacing</span>'
      : '<span class="badge bg-warning text-dark">Under-pacing</span>';

    let campaignGauges = '';
    b.campaigns.forEach(c => {
      const cPct = Math.round((c.spent / c.budget) * 100);
      const cColor = c.pacing === 'OVERPACING' ? 'bg-danger' : c.pacing === 'UNDERPACING' ? 'bg-warning' : c.pacing === 'PAUSED' ? 'bg-secondary' : 'bg-primary';
      const pacingLabel = c.pacing === 'PAUSED' ? '<span class="badge bg-secondary">Paused</span>'
        : c.pacing === 'OVERPACING' ? '<span class="badge bg-danger">Over</span>'
        : c.pacing === 'UNDERPACING' ? '<span class="badge bg-warning text-dark">Under</span>'
        : '<span class="badge bg-success">OK</span>';
      campaignGauges += `<div class="mb-3">
        <div class="d-flex justify-content-between"><small>${c.name}</small>${pacingLabel}</div>
        <div class="progress" style="height:14px;">
          <div class="progress-bar ${cColor}" style="width:${Math.min(cPct,100)}%">${cPct}%</div>
        </div>
        <small class="text-muted">$${c.spent.toLocaleString()} / $${c.budget.toLocaleString()} · Avg $${c.daily_avg.toFixed(0)}/day</small>
      </div>`;
    });

    document.getElementById('linkedinBudgetContent').innerHTML = `
      <div class="card bg-dark border-primary mb-4">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">Overall Budget</h6>${pacingBadge}
          </div>
          <div class="progress mb-2" style="height:22px;">
            <div class="progress-bar ${barColor}" style="width:${pct}%">${pct}% ($${b.overall_spent.toLocaleString()} / $${b.overall_budget.toLocaleString()})</div>
          </div>
          <small class="text-muted">Daily: $${b.daily_spent.toFixed(0)} / $${b.daily_budget} target · ${b.days_remaining} days remaining</small>
        </div>
      </div>
      <h6>Campaign Pacing</h6>
      ${campaignGauges}
    `;
  }

  async function linkedinGenerateReport() {
    try {
      const res = await fetch('/api/connectors/linkedin-ads/reports?account_id=li_acc_987654321');
      const data = await res.json();
      linkedinState.report = data.rows;

      const page = linkedinState.report.slice(0, 20);
      let html = `<p class="text-muted">${data.total_rows} rows generated · Showing first 20</p>
        <div class="table-responsive"><table class="table table-dark table-striped table-sm">
        <thead><tr><th>Date</th><th>Campaign</th><th>Objective</th><th>Format</th><th>Spend</th><th>Impressions</th><th>CTR</th><th>Leads</th><th>Cost/Lead</th><th>ROAS</th></tr></thead><tbody>`;
      page.forEach(r => {
        html += `<tr><td>${r.date}</td><td>${r.campaign}</td><td><small>${r.objective.replace(/_/g,' ')}</small></td><td><small>${r.format.replace(/_/g,' ')}</small></td>
          <td>$${r.spend.toFixed(2)}</td><td>${r.impressions.toLocaleString()}</td>
          <td>${r.ctr}%</td><td>${r.leads}</td>
          <td>${r.cost_per_lead > 0 ? '$'+r.cost_per_lead.toFixed(2) : '–'}</td>
          <td>${r.roas > 0 ? r.roas.toFixed(1)+'x' : '–'}</td></tr>`;
      });
      html += '</tbody></table></div>';
      document.getElementById('linkedinReportContent').innerHTML = html;
    } catch(e) {
      document.getElementById('linkedinReportContent').innerHTML = '<div class="alert alert-danger">Failed to generate report.</div>';
    }
  }

  function linkedinExportCSV(type) {
    if (type === 'campaigns' && linkedinState.campaigns.length) {
      downloadCSV('linkedin_campaigns.csv',
        ['Campaign','Objective','Format','Status','Spend','Impressions','CTR','Leads','Cost/Lead','ROAS'],
        linkedinState.campaigns.map(c => [c.name, c.objective, c.format, c.status, c.spend, c.impressions, c.ctr+'%', c.leads, c.cost_per_lead, c.roas])
      );
    } else if (type === 'report' && linkedinState.report) {
      downloadCSV('linkedin_report.csv',
        ['Date','Campaign','Objective','Format','Spend','Impressions','CTR','Leads','Cost/Lead','ROAS'],
        linkedinState.report.map(r => [r.date, r.campaign, r.objective, r.format, r.spend, r.impressions, r.ctr+'%', r.leads, r.cost_per_lead, r.roas])
      );
    }
  }

  async function linkedinTestApiCall() {
    const endpoint = document.getElementById('linkedinApiEndpoint').value;
    document.getElementById('linkedinApiResult').textContent = 'Calling LinkedIn Marketing API…';
    try {
      const res = await fetch('/api/connectors/linkedin-ads/test-call', {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ endpoint, method: 'GET' })
      });
      const data = await res.json();
      document.getElementById('linkedinApiResult').textContent = JSON.stringify(data, null, 2);
    } catch(e) {
      document.getElementById('linkedinApiResult').textContent = 'Error: ' + e.message;
    }
  }

  async function linkedinSaveSettings() {
    const config = {
      account: document.getElementById('linkedinSettingsAccount').value,
      date_range: document.getElementById('linkedinSettingsDateRange').value,
      lead_form_id: document.getElementById('linkedinSettingsLeadForm').value,
      conv_window: document.getElementById('linkedinSettingsConvWindow').value,
    };
    try {
      await fetch('/api/connectors/linkedin-ads', {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ status: linkedinState.connected ? 'Connected' : 'Disconnected', config })
      });
      if (window.showToast) window.showToast('Settings Saved', 'LinkedIn Ads settings updated.', 'success');
    } catch (e) {
      if (window.showToast) window.showToast('Error', 'Failed to save settings.', 'danger');
    }
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // STRIPE JS ENGINE (Phase 18)
  // ═══════════════════════════════════════════════════════════════════════════

  const stripeState = { connected: false, accountId: '', accounts: [], overview: null, subs: [], payments: [], customers: [], report: [], reportPage: 0 };
  const STRIPE_PURPLE = '#635bff';

  async function stripeInit() {
    try {
      const r = await fetch('/api/connectors/stripe/accounts');
      const d = await r.json();
      stripeState.accounts = d.accounts;
      const sel = document.getElementById('stripeAccountSelect');
      sel.innerHTML = d.accounts.map(a => `<option value="${a.account_id}">${a.name} (${a.mode})</option>`).join('');
      // Check saved status
      const sr = await fetch('/api/connectors/stripe');
      const sd = await sr.json();
      if (sd.status === 'Connected') {
        stripeState.connected = true;
        stripeState.accountId = d.accounts[0].account_id;
        document.getElementById('stripeConnStatus').className = 'badge bg-success ms-2';
        document.getElementById('stripeConnStatus').textContent = 'Connected';
        document.getElementById('stripeConnectBtn').innerHTML = '<i class="bi bi-plug-fill"></i> Connected';
        stripeLoadAccount();
      }
    } catch (e) { console.error('stripeInit error', e); }
  }

  async function stripeConnect() {
    stripeState.connected = !stripeState.connected;
    const btn = document.getElementById('stripeConnectBtn');
    const badge = document.getElementById('stripeConnStatus');
    if (stripeState.connected) {
      btn.innerHTML = '<i class="bi bi-plug-fill"></i> Connected';
      badge.className = 'badge bg-success ms-2'; badge.textContent = 'Connected';
      stripeState.accountId = document.getElementById('stripeAccountSelect').value;
      await fetch('/api/connectors/stripe', { method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ status: 'Connected', config: { account: stripeState.accountId } }) });
      stripeLoadAccount();
    } else {
      btn.innerHTML = '<i class="bi bi-plug"></i> Connect';
      badge.className = 'badge bg-secondary ms-2'; badge.textContent = 'Not Connected';
      await fetch('/api/connectors/stripe', { method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ status: 'Disconnected', config: {} }) });
      document.getElementById('stripeOverviewContent').innerHTML = '<p class="text-muted">Click Connect to load Stripe data…</p>';
    }
    loadConnectorStatuses();
  }

  async function stripeLoadAccount() {
    stripeState.accountId = document.getElementById('stripeAccountSelect').value;
    if (!stripeState.connected) return;
    const [ovR, subR, payR, custR, pacR] = await Promise.all([
      fetch(`/api/connectors/stripe/overview?account_id=${stripeState.accountId}`),
      fetch('/api/connectors/stripe/subscriptions'),
      fetch('/api/connectors/stripe/payments'),
      fetch('/api/connectors/stripe/customers'),
      fetch(`/api/connectors/stripe/budget-pacing?account_id=${stripeState.accountId}`),
    ]);
    const ov = await ovR.json(); const sub = await subR.json(); const pay = await payR.json();
    const cust = await custR.json(); const pac = await pacR.json();
    stripeState.overview = ov.overview;
    stripeState.subs = sub.subscriptions;
    stripeState.payments = pay.payments;
    stripeState.customers = cust.customers;
    stripeState.pacing = pac.pacing;
    stripeRenderOverview();
    stripeRenderSubs();
    stripeRenderPayments();
    stripeRenderCustomers();
    stripeRenderBudget();
  }

  function stripeRenderOverview() {
    const o = stripeState.overview; if (!o) return;
    const fmt = (v, p='$') => p === '$' ? `$${Number(v).toLocaleString()}` : `${v}%`;
    const kpis = [
      { label: 'MRR', value: fmt(o.mrr), icon: 'bi-graph-up-arrow', color: STRIPE_PURPLE },
      { label: 'ARR', value: fmt(o.arr), icon: 'bi-calendar-check', color: '#00d4aa' },
      { label: 'Revenue Today', value: fmt(o.revenue_today), icon: 'bi-cash-coin', color: '#28a745' },
      { label: 'Revenue This Month', value: fmt(o.revenue_this_month), icon: 'bi-wallet2', color: '#17a2b8' },
      { label: 'Active Subs', value: o.active_subscriptions, icon: 'bi-people-fill', color: '#ffc107' },
      { label: 'New Subs', value: `+${o.new_subscriptions}`, icon: 'bi-person-plus', color: '#28a745' },
      { label: 'Churn Rate', value: fmt(o.churn_rate, '%'), icon: 'bi-person-dash', color: '#dc3545' },
      { label: 'Net Revenue', value: fmt(o.net_revenue), icon: 'bi-piggy-bank', color: '#6f42c1' },
      { label: 'ARPU', value: fmt(o.average_revenue_per_user), icon: 'bi-person-badge', color: '#fd7e14' },
      { label: 'LTV', value: fmt(o.lifetime_value), icon: 'bi-gem', color: '#e83e8c' },
      { label: 'CAC', value: fmt(o.cac), icon: 'bi-megaphone', color: '#20c997' },
      { label: 'LTV:CAC', value: `${o.ltv_cac_ratio}x`, icon: 'bi-bullseye', color: STRIPE_PURPLE },
    ];
    let h = '<div class="row g-2 mb-3">';
    kpis.forEach(k => {
      h += `<div class="col-md-2 col-sm-4"><div class="card bg-dark border-secondary h-100"><div class="card-body text-center p-2">
        <i class="bi ${k.icon}" style="color:${k.color};font-size:1.3rem;"></i>
        <div class="text-muted small">${k.label}</div><div class="fw-bold">${k.value}</div>
      </div></div></div>`;
    });
    h += '</div>';

    // MRR trend sparkline
    if (o.mrr_trend && o.mrr_trend.length) {
      const vals = o.mrr_trend.map(d => d.mrr);
      const max = Math.max(...vals); const min = Math.min(...vals);
      const w = 500, ht = 80, pad = 5;
      const pts = vals.map((v, i) => `${pad + i * ((w - 2*pad) / (vals.length - 1))},${ht - pad - ((v - min) / (max - min || 1)) * (ht - 2*pad)}`).join(' ');
      h += `<div class="card bg-dark border-secondary mb-3"><div class="card-body p-2">
        <h6 class="mb-1"><i class="bi bi-graph-up" style="color:${STRIPE_PURPLE}"></i> MRR Trend (6 months)</h6>
        <svg width="100%" viewBox="0 0 ${w} ${ht}" preserveAspectRatio="none">
          <polyline points="${pts}" fill="none" stroke="${STRIPE_PURPLE}" stroke-width="2.5"/>
          ${vals.map((v, i) => `<circle cx="${pad + i * ((w - 2*pad) / (vals.length - 1))}" cy="${ht - pad - ((v - min) / (max - min || 1)) * (ht - 2*pad)}" r="4" fill="${STRIPE_PURPLE}"/>`).join('')}
        </svg>
        <div class="d-flex justify-content-between text-muted small">${o.mrr_trend.map(d => `<span>${d.month}</span>`).join('')}</div>
      </div></div>`;
    }

    // Revenue by product
    if (o.revenue_by_product && o.revenue_by_product.length) {
      const colors = [STRIPE_PURPLE, '#00d4aa', '#ffc107', '#e83e8c'];
      h += `<div class="card bg-dark border-secondary"><div class="card-body p-2">
        <h6 class="mb-2"><i class="bi bi-pie-chart" style="color:${STRIPE_PURPLE}"></i> Revenue by Product</h6>
        <div class="row g-2">`;
      o.revenue_by_product.forEach((p, i) => {
        h += `<div class="col-md-3"><div class="d-flex align-items-center gap-2">
          <div style="width:12px;height:12px;border-radius:50%;background:${colors[i]}"></div>
          <div><div class="small text-muted">${p.product}</div><div class="fw-bold">$${p.revenue.toLocaleString()} <span class="text-muted small">(${p.pct}%)</span></div>
          <div class="small text-muted">${p.subscribers} subs</div></div></div></div>`;
      });
      h += '</div></div></div>';
    }
    document.getElementById('stripeOverviewContent').innerHTML = h;
  }

  async function stripeLoadSubs() {
    const status = document.getElementById('stripeSubStatusFilter').value;
    const plan = document.getElementById('stripeSubPlanFilter').value;
    let url = '/api/connectors/stripe/subscriptions?';
    if (status) url += `status=${status}&`;
    if (plan) url += `plan=${encodeURIComponent(plan)}&`;
    const r = await fetch(url); const d = await r.json();
    stripeState.subs = d.subscriptions;
    stripeRenderSubs();
  }

  function stripeRenderSubs() {
    const statusBadge = s => {
      const m = { active: 'bg-success', trialing: 'bg-info', canceled: 'bg-danger', past_due: 'bg-warning text-dark' };
      return `<span class="badge ${m[s] || 'bg-secondary'}">${s}</span>`;
    };
    const tbody = document.getElementById('stripeSubsBody');
    tbody.innerHTML = stripeState.subs.map(s =>
      `<tr><td class="small">${s.sub_id}</td><td>${s.customer_email}</td><td>${s.plan}</td>
       <td>$${s.amount.toFixed(2)}</td><td>${statusBadge(s.status)}</td><td>${s.interval}</td>
       <td>${s.current_period_end}</td></tr>`
    ).join('');
    const active = stripeState.subs.filter(s => s.status === 'active').length;
    const total = stripeState.subs.reduce((a, s) => a + (s.status === 'active' ? s.amount : 0), 0);
    document.getElementById('stripeSubsFoot').innerHTML = `<tr class="fw-bold"><td colspan="3">Active: ${active} / ${stripeState.subs.length}</td><td>$${total.toFixed(2)}/mo</td><td colspan="3"></td></tr>`;
  }

  async function stripeLoadPayments() {
    const status = document.getElementById('stripePayStatusFilter').value;
    let url = '/api/connectors/stripe/payments?';
    if (status) url += `status=${status}`;
    const r = await fetch(url); const d = await r.json();
    stripeState.payments = d.payments;
    stripeRenderPayments();
  }

  function stripeRenderPayments() {
    const statusBadge = s => {
      const m = { succeeded: 'bg-success', refunded: 'bg-warning text-dark', failed: 'bg-danger' };
      return `<span class="badge ${m[s] || 'bg-secondary'}">${s}</span>`;
    };
    document.getElementById('stripePaymentsBody').innerHTML = stripeState.payments.map(p =>
      `<tr><td class="small">${p.payment_id}</td><td>$${p.amount.toFixed(2)}</td><td>${statusBadge(p.status)}</td>
       <td>${p.customer_email}</td><td class="small">${p.description}</td><td>•••${p.card_last4}</td>
       <td class="small">${p.created.slice(0,10)}</td></tr>`
    ).join('');
  }

  async function stripeLoadCustomers() {
    const status = document.getElementById('stripeCustStatusFilter').value;
    let url = '/api/connectors/stripe/customers?';
    if (status) url += `status=${status}`;
    const r = await fetch(url); const d = await r.json();
    stripeState.customers = d.customers;
    stripeRenderCustomers();
  }

  function stripeRenderCustomers() {
    const statusBadge = s => {
      const m = { active: 'bg-success', trialing: 'bg-info', canceled: 'bg-danger', past_due: 'bg-warning text-dark' };
      return `<span class="badge ${m[s] || 'bg-secondary'}">${s}</span>`;
    };
    document.getElementById('stripeCustomersBody').innerHTML = stripeState.customers.map(c =>
      `<tr><td>${c.name}</td><td class="small">${c.email}</td><td>${c.plan}</td>
       <td>$${c.ltv.toFixed(2)}</td><td>${statusBadge(c.status)}</td><td>${c.country}</td>
       <td class="small">${c.created}</td></tr>`
    ).join('');
  }

  function stripeRenderBudget() {
    const p = stripeState.pacing; if (!p) return;
    const goalPct = Math.min(p.goal_pct, 100);
    const projPct = Math.min(p.projected_pct, 100);
    const pacingColor = p.pacing_status === 'AHEAD' ? '#28a745' : p.pacing_status === 'ON_TRACK' ? '#17a2b8' : '#dc3545';
    let h = `<div class="row g-3 mb-3">
      <div class="col-md-4"><div class="card bg-dark border-secondary"><div class="card-body text-center">
        <div class="text-muted small">Monthly Revenue Goal</div><h4>$${p.monthly_revenue_goal.toLocaleString()}</h4>
      </div></div></div>
      <div class="col-md-4"><div class="card bg-dark border-secondary"><div class="card-body text-center">
        <div class="text-muted small">Current Revenue</div><h4 class="text-success">$${p.current_revenue.toLocaleString()}</h4>
        <div class="progress mt-2" style="height:8px;"><div class="progress-bar" style="width:${goalPct}%;background:${STRIPE_PURPLE}"></div></div>
        <small class="text-muted">${p.goal_pct}% of goal</small>
      </div></div></div>
      <div class="col-md-4"><div class="card bg-dark border-secondary"><div class="card-body text-center">
        <div class="text-muted small">Projected Revenue</div><h4 style="color:${pacingColor}">$${p.projected_revenue.toLocaleString()}</h4>
        <span class="badge" style="background:${pacingColor}">${p.pacing_status}</span>
      </div></div></div>
    </div>`;

    // Cash runway
    h += `<div class="card bg-dark border-secondary mb-3"><div class="card-body">
      <h6><i class="bi bi-safe" style="color:${STRIPE_PURPLE}"></i> Cash Runway</h6>
      <div class="row g-2">
        <div class="col-md-4"><div class="text-muted small">Cash Balance</div><div class="fw-bold">$${p.cash_balance.toLocaleString()}</div></div>
        <div class="col-md-4"><div class="text-muted small">Monthly Burn</div><div class="fw-bold text-danger">$${p.monthly_burn.toLocaleString()}</div></div>
        <div class="col-md-4"><div class="text-muted small">Runway</div><div class="fw-bold" style="color:${STRIPE_PURPLE}">${p.cash_runway_months} months</div></div>
      </div>
      <div class="progress mt-2" style="height:12px;">
        <div class="progress-bar" style="width:${Math.min(p.cash_runway_months / 24 * 100, 100)}%;background:${STRIPE_PURPLE}"></div>
      </div>
    </div></div>`;

    // Per-product pacing
    h += `<h6><i class="bi bi-bar-chart-line" style="color:${STRIPE_PURPLE}"></i> Revenue by Product</h6>`;
    p.products.forEach(pr => {
      const pct = Math.min(pr.current / pr.goal * 100, 100).toFixed(1);
      const c = pr.pacing === 'AHEAD' ? '#28a745' : pr.pacing === 'ON_TRACK' ? '#17a2b8' : '#ffc107';
      h += `<div class="d-flex align-items-center gap-2 mb-2">
        <div style="width:140px;" class="small">${pr.name}</div>
        <div class="flex-grow-1"><div class="progress" style="height:14px;"><div class="progress-bar" style="width:${pct}%;background:${c}"></div></div></div>
        <div style="width:120px;" class="small text-end">$${pr.current.toLocaleString()} / $${pr.goal.toLocaleString()}</div>
        <span class="badge" style="background:${c};width:100px;">${pr.pacing}</span>
      </div>`;
    });
    document.getElementById('stripeBudgetContent').innerHTML = h;
  }

  async function stripeGenerateReport() {
    const r = await fetch(`/api/connectors/stripe/reports?account_id=${stripeState.accountId}`);
    const d = await r.json();
    stripeState.report = d.rows;
    stripeState.reportPage = 0;
    stripeRenderReport();
  }

  function stripeRenderReport() {
    const rows = stripeState.report;
    if (!rows.length) { document.getElementById('stripeReportContent').innerHTML = '<p class="text-muted">No data</p>'; return; }
    const perPage = 20;
    const start = stripeState.reportPage * perPage;
    const page = rows.slice(start, start + perPage);
    const totalPages = Math.ceil(rows.length / perPage);
    let h = `<p class="text-muted small">${rows.length} rows total — page ${stripeState.reportPage + 1}/${totalPages}</p>
      <table class="table table-dark table-striped table-sm"><thead><tr>
        <th>Date</th><th>Plan</th><th>Revenue</th><th>New Subs</th><th>Churned</th><th>Active</th><th>Refunds</th><th>Net Revenue</th></tr></thead><tbody>`;
    page.forEach(r => {
      h += `<tr><td>${r.date}</td><td>${r.plan}</td><td>$${r.revenue.toFixed(2)}</td>
        <td>${r.new_subscriptions}</td><td>${r.churned_subscriptions}</td><td>${r.active_subscriptions}</td>
        <td>$${r.refunds.toFixed(2)}</td><td>$${r.net_revenue.toFixed(2)}</td></tr>`;
    });
    h += '</tbody></table>';
    if (totalPages > 1) {
      h += '<div class="d-flex gap-2 mt-2">';
      if (stripeState.reportPage > 0) h += `<button class="btn btn-sm btn-outline-light" onclick="stripeState.reportPage--;stripeRenderReport()">← Prev</button>`;
      if (stripeState.reportPage < totalPages - 1) h += `<button class="btn btn-sm btn-outline-light" onclick="stripeState.reportPage++;stripeRenderReport()">Next →</button>`;
      h += '</div>';
    }
    document.getElementById('stripeReportContent').innerHTML = h;
  }

  function stripeExportCSV(type) {
    if (type === 'subscriptions') {
      downloadCSV('stripe_subscriptions.csv', ['Sub ID','Customer','Plan','Amount','Status','Interval','Period End'],
        stripeState.subs.map(s => [s.sub_id, s.customer_email, s.plan, s.amount, s.status, s.interval, s.current_period_end]));
    } else if (type === 'payments') {
      downloadCSV('stripe_payments.csv', ['Payment ID','Amount','Status','Customer','Description','Card','Date'],
        stripeState.payments.map(p => [p.payment_id, p.amount, p.status, p.customer_email, p.description, p.card_last4, p.created]));
    } else if (type === 'customers') {
      downloadCSV('stripe_customers.csv', ['Name','Email','Plan','LTV','Status','Country','Since'],
        stripeState.customers.map(c => [c.name, c.email, c.plan, c.ltv, c.status, c.country, c.created]));
    } else if (type === 'report') {
      downloadCSV('stripe_revenue_report.csv', ['Date','Plan','Revenue','New Subs','Churned','Active','Refunds','Net Revenue'],
        stripeState.report.map(r => [r.date, r.plan, r.revenue, r.new_subscriptions, r.churned_subscriptions, r.active_subscriptions, r.refunds, r.net_revenue]));
    }
  }

  async function stripeTestApiCall() {
    const endpoint = document.getElementById('stripeApiEndpoint').value;
    const el = document.getElementById('stripeApiResult');
    el.textContent = 'Calling Stripe API…';
    try {
      const r = await fetch('/api/connectors/stripe/test-call', {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ endpoint, method: 'GET' })
      });
      const d = await r.json();
      el.textContent = JSON.stringify(d, null, 2);
    } catch (e) { el.textContent = 'Error: ' + e.message; }
  }

  async function stripeSaveSettings() {
    const config = {
      mode: document.getElementById('stripeSettingsMode').value,
      currency: document.getElementById('stripeSettingsCurrency').value,
      webhook_url: document.getElementById('stripeSettingsWebhook').value,
    };
    try {
      await fetch('/api/connectors/stripe', {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ status: stripeState.connected ? 'Connected' : 'Disconnected', config })
      });
      if (window.showToast) window.showToast('Settings Saved', 'Stripe settings updated.', 'success');
    } catch (e) {
      if (window.showToast) window.showToast('Error', 'Failed to save settings.', 'danger');
    }
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // SHOPIFY JS ENGINE (Phase 19)
  // ═══════════════════════════════════════════════════════════════════════════

  const shopifyState = { connected: false, storeId: '', stores: [], overview: null, products: [], orders: [], carts: [], customers: [], report: [], reportPage: 0, pacing: null };
  const SHOPIFY_GREEN = '#96bf48';

  async function shopifyInit() {
    try {
      const r = await fetch('/api/connectors/shopify/stores');
      const d = await r.json();
      shopifyState.stores = d.stores;
      const sel = document.getElementById('shopifyStoreSelect');
      sel.innerHTML = d.stores.map(s => `<option value="${s.store_id}">${s.name} (${s.plan})</option>`).join('');
      const sr = await fetch('/api/connectors/shopify');
      const sd = await sr.json();
      if (sd.status === 'Connected') {
        shopifyState.connected = true;
        shopifyState.storeId = d.stores[0].store_id;
        document.getElementById('shopifyConnStatus').className = 'badge bg-success ms-2';
        document.getElementById('shopifyConnStatus').textContent = 'Connected';
        document.getElementById('shopifyConnectBtn').innerHTML = '<i class="bi bi-plug-fill"></i> Connected';
        shopifyLoadStore();
      }
    } catch (e) { console.error('shopifyInit error', e); }
  }

  async function shopifyConnect() {
    shopifyState.connected = !shopifyState.connected;
    const btn = document.getElementById('shopifyConnectBtn');
    const badge = document.getElementById('shopifyConnStatus');
    if (shopifyState.connected) {
      btn.innerHTML = '<i class="bi bi-plug-fill"></i> Connected';
      badge.className = 'badge bg-success ms-2'; badge.textContent = 'Connected';
      shopifyState.storeId = document.getElementById('shopifyStoreSelect').value;
      await fetch('/api/connectors/shopify', { method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ status: 'Connected', config: { store: shopifyState.storeId } }) });
      shopifyLoadStore();
    } else {
      btn.innerHTML = '<i class="bi bi-plug"></i> Connect';
      badge.className = 'badge bg-secondary ms-2'; badge.textContent = 'Not Connected';
      await fetch('/api/connectors/shopify', { method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ status: 'Disconnected', config: {} }) });
      document.getElementById('shopifyOverviewContent').innerHTML = '<p class="text-muted">Click Connect to load store data…</p>';
    }
    loadConnectorStatuses();
  }

  async function shopifyLoadStore() {
    shopifyState.storeId = document.getElementById('shopifyStoreSelect').value;
    if (!shopifyState.connected) return;
    const [ovR, prodR, ordR, cartR, custR, pacR] = await Promise.all([
      fetch(`/api/connectors/shopify/overview?store_id=${shopifyState.storeId}`),
      fetch('/api/connectors/shopify/products'),
      fetch('/api/connectors/shopify/orders'),
      fetch('/api/connectors/shopify/abandoned-carts'),
      fetch('/api/connectors/shopify/customers'),
      fetch(`/api/connectors/shopify/reports?store_id=${shopifyState.storeId}`),
    ]);
    const ov = await ovR.json(); const prod = await prodR.json(); const ord = await ordR.json();
    const cart = await cartR.json(); const cust = await custR.json(); const pac = await pacR.json();
    shopifyState.overview = ov.overview;
    shopifyState.products = prod.products;
    shopifyState.orders = ord.orders;
    shopifyState.carts = cart.carts;
    shopifyState.cartSummary = { total: cart.total, total_value: cart.total_value, recovered: cart.recovered, recovery_rate: cart.recovery_rate };
    shopifyState.customers = cust.customers;
    shopifyState.pacing = pac;
    shopifyRenderOverview();
    shopifyRenderProducts();
    shopifyRenderOrders();
    shopifyRenderAbandoned();
    shopifyRenderCustomers();
  }

  function shopifyRenderOverview() {
    const o = shopifyState.overview; if (!o) return;
    const kpis = [
      { label: 'Revenue Today', value: `$${o.revenue_today.toLocaleString()}`, icon: 'bi-cash-coin', color: SHOPIFY_GREEN },
      { label: 'Revenue This Month', value: `$${o.revenue_this_month.toLocaleString()}`, icon: 'bi-wallet2', color: '#28a745' },
      { label: 'Orders Today', value: o.orders_today, icon: 'bi-bag', color: '#17a2b8' },
      { label: 'Orders This Month', value: o.orders_this_month, icon: 'bi-bag-check', color: '#ffc107' },
      { label: 'AOV', value: `$${o.aov.toFixed(2)}`, icon: 'bi-receipt', color: '#6f42c1' },
      { label: 'Conversion Rate', value: `${o.conversion_rate}%`, icon: 'bi-funnel', color: '#fd7e14' },
      { label: 'Sessions Today', value: o.sessions_today.toLocaleString(), icon: 'bi-eye', color: '#20c997' },
      { label: 'New Customers', value: o.new_customers, icon: 'bi-person-plus', color: '#28a745' },
      { label: 'Returning', value: o.returning_customers, icon: 'bi-arrow-repeat', color: '#17a2b8' },
      { label: 'Abandoned Carts', value: o.abandoned_carts, icon: 'bi-cart-x', color: '#dc3545' },
      { label: 'Abandoned Value', value: `$${o.abandoned_cart_value.toLocaleString()}`, icon: 'bi-exclamation-triangle', color: '#ffc107' },
      { label: 'Recovery Rate', value: `${o.recovery_rate}%`, icon: 'bi-arrow-clockwise', color: '#e83e8c' },
    ];
    let h = '<div class="row g-2 mb-3">';
    kpis.forEach(k => {
      h += `<div class="col-md-2 col-sm-4"><div class="card bg-dark border-secondary h-100"><div class="card-body text-center p-2">
        <i class="bi ${k.icon}" style="color:${k.color};font-size:1.3rem;"></i>
        <div class="text-muted small">${k.label}</div><div class="fw-bold">${k.value}</div>
      </div></div></div>`;
    });
    h += '</div>';

    // Daily revenue sparkline
    if (o.daily_revenue && o.daily_revenue.length) {
      const vals = o.daily_revenue.map(d => d.revenue);
      const max = Math.max(...vals); const min = Math.min(...vals);
      const w = 500, ht = 80, pad = 5;
      const pts = vals.map((v, i) => `${pad + i * ((w - 2*pad) / (vals.length - 1))},${ht - pad - ((v - min) / (max - min || 1)) * (ht - 2*pad)}`).join(' ');
      h += `<div class="card bg-dark border-secondary mb-3"><div class="card-body p-2">
        <h6 class="mb-1"><i class="bi bi-graph-up" style="color:${SHOPIFY_GREEN}"></i> Daily Revenue (7 days)</h6>
        <svg width="100%" viewBox="0 0 ${w} ${ht}" preserveAspectRatio="none">
          <polyline points="${pts}" fill="none" stroke="${SHOPIFY_GREEN}" stroke-width="2.5"/>
          ${vals.map((v, i) => `<circle cx="${pad + i * ((w - 2*pad) / (vals.length - 1))}" cy="${ht - pad - ((v - min) / (max - min || 1)) * (ht - 2*pad)}" r="4" fill="${SHOPIFY_GREEN}"/>`).join('')}
        </svg>
        <div class="d-flex justify-content-between text-muted small">${o.daily_revenue.map(d => `<span>${d.date.slice(5)}</span>`).join('')}</div>
      </div></div>`;
    }

    // Sales by channel + top products
    if (o.sales_by_channel && o.sales_by_channel.length) {
      const colors = [SHOPIFY_GREEN, '#17a2b8', '#ffc107', '#fd7e14'];
      h += `<div class="row g-3 mb-3"><div class="col-md-5"><div class="card bg-dark border-secondary"><div class="card-body p-2">
        <h6 class="mb-2"><i class="bi bi-diagram-3" style="color:${SHOPIFY_GREEN}"></i> Sales by Channel</h6>`;
      o.sales_by_channel.forEach((ch, i) => {
        h += `<div class="d-flex align-items-center gap-2 mb-1">
          <div style="width:12px;height:12px;border-radius:50%;background:${colors[i]}"></div>
          <div class="flex-grow-1 small">${ch.channel}</div>
          <div class="small fw-bold">$${ch.revenue.toLocaleString()} (${ch.pct}%)</div></div>`;
      });
      h += '</div></div></div>';
      h += '<div class="col-md-7"><div class="card bg-dark border-secondary"><div class="card-body p-2">';
      h += `<h6 class="mb-2"><i class="bi bi-star" style="color:${SHOPIFY_GREEN}"></i> Top Products</h6>
        <table class="table table-dark table-sm mb-0"><thead><tr><th>Product</th><th>Price</th><th>Sold</th><th>Revenue</th><th>Stock</th></tr></thead><tbody>`;
      o.top_products.forEach(p => {
        const stockBadge = p.inventory < 50 ? 'bg-warning text-dark' : 'bg-success';
        h += `<tr><td class="small">${p.title}</td><td>$${p.price}</td><td>${p.sold}</td><td>$${p.revenue.toLocaleString()}</td><td><span class="badge ${stockBadge}">${p.inventory}</span></td></tr>`;
      });
      h += '</tbody></table></div></div></div></div>';
    }
    document.getElementById('shopifyOverviewContent').innerHTML = h;
  }

  async function shopifyLoadProducts() {
    const status = document.getElementById('shopifyProdStatusFilter').value;
    const collection = document.getElementById('shopifyProdCollFilter').value;
    let url = '/api/connectors/shopify/products?';
    if (status) url += `status=${status}&`;
    if (collection) url += `collection=${encodeURIComponent(collection)}`;
    const r = await fetch(url); const d = await r.json();
    shopifyState.products = d.products;
    shopifyRenderProducts();
  }

  function shopifyRenderProducts() {
    const statusBadge = s => {
      const m = { active: 'bg-success', draft: 'bg-warning text-dark', archived: 'bg-secondary' };
      return `<span class="badge ${m[s] || 'bg-secondary'}">${s}</span>`;
    };
    document.getElementById('shopifyProductsBody').innerHTML = shopifyState.products.map(p =>
      `<tr><td class="small">${p.title}</td><td>$${p.price.toFixed(2)}</td>
       <td>${p.compare_at_price ? '<s class="text-muted">$'+p.compare_at_price.toFixed(2)+'</s>' : '—'}</td>
       <td><span class="badge ${p.inventory === 0 ? 'bg-danger' : p.inventory < 50 ? 'bg-warning text-dark' : 'bg-success'}">${p.inventory}</span></td>
       <td>${statusBadge(p.status)}</td><td class="small">${p.collection}</td><td>${p.variants}</td></tr>`
    ).join('');
  }

  async function shopifyLoadOrders() {
    const status = document.getElementById('shopifyOrderStatusFilter').value;
    let url = '/api/connectors/shopify/orders?';
    if (status) url += `status=${status}`;
    const r = await fetch(url); const d = await r.json();
    shopifyState.orders = d.orders;
    shopifyRenderOrders();
  }

  function shopifyRenderOrders() {
    const statusBadge = s => {
      const m = { fulfilled: 'bg-success', unfulfilled: 'bg-warning text-dark', partially_fulfilled: 'bg-info', cancelled: 'bg-danger' };
      return `<span class="badge ${m[s] || 'bg-secondary'}">${s}</span>`;
    };
    const payBadge = s => {
      const m = { paid: 'bg-success', refunded: 'bg-danger', pending: 'bg-warning text-dark' };
      return `<span class="badge ${m[s] || 'bg-secondary'}">${s}</span>`;
    };
    document.getElementById('shopifyOrdersBody').innerHTML = shopifyState.orders.map(o =>
      `<tr><td class="fw-bold">${o.order_id}</td><td class="small">${o.customer_name}</td>
       <td>$${o.total.toFixed(2)}</td><td>${o.items}</td><td>${statusBadge(o.status)}</td>
       <td>${payBadge(o.payment_status)}</td><td class="small">${o.created.slice(0,10)}</td></tr>`
    ).join('');
  }

  function shopifyRenderAbandoned() {
    const s = shopifyState.cartSummary;
    const carts = shopifyState.carts;
    let h = `<div class="row g-3 mb-3">
      <div class="col-md-3"><div class="card bg-dark border-secondary"><div class="card-body text-center">
        <div class="text-muted small">Total Abandoned</div><h4 class="text-danger">${s.total}</h4></div></div></div>
      <div class="col-md-3"><div class="card bg-dark border-secondary"><div class="card-body text-center">
        <div class="text-muted small">Abandoned Value</div><h4 class="text-warning">$${s.total_value.toLocaleString()}</h4></div></div></div>
      <div class="col-md-3"><div class="card bg-dark border-secondary"><div class="card-body text-center">
        <div class="text-muted small">Recovered</div><h4 class="text-success">${s.recovered}</h4></div></div></div>
      <div class="col-md-3"><div class="card bg-dark border-secondary"><div class="card-body text-center">
        <div class="text-muted small">Recovery Rate</div>
        <div class="progress mt-2" style="height:18px;"><div class="progress-bar bg-success" style="width:${s.recovery_rate}%">${s.recovery_rate}%</div></div></div></div></div>
    </div>`;
    h += `<table class="table table-dark table-striped table-sm"><thead><tr><th>Cart</th><th>Customer</th><th>Items</th><th>Value</th><th>Email Sent</th><th>Recovered</th><th>Date</th></tr></thead><tbody>`;
    carts.forEach(c => {
      const items = c.items.map(i => `${i.title} ×${i.qty}`).join(', ');
      h += `<tr><td class="small">${c.cart_id}</td><td class="small">${c.customer_email}</td>
        <td class="small">${items}</td><td>$${c.total_value.toFixed(2)}</td>
        <td>${c.recovery_email_sent ? '<i class="bi bi-check-circle text-success"></i>' : '<i class="bi bi-x-circle text-muted"></i>'}</td>
        <td>${c.recovered ? '<span class="badge bg-success">Yes</span>' : '<span class="badge bg-danger">No</span>'}</td>
        <td class="small">${c.created.slice(0,10)}</td></tr>`;
    });
    h += '</tbody></table>';
    document.getElementById('shopifyAbandonedContent').innerHTML = h;
  }

  async function shopifyLoadCustomers() {
    const status = document.getElementById('shopifyCustStatusFilter').value;
    let url = '/api/connectors/shopify/customers?';
    if (status) url += `status=${status}`;
    const r = await fetch(url); const d = await r.json();
    shopifyState.customers = d.customers;
    shopifyRenderCustomers();
  }

  function shopifyRenderCustomers() {
    document.getElementById('shopifyCustomersBody').innerHTML = shopifyState.customers.map(c =>
      `<tr><td>${c.name}</td><td class="small">${c.email}</td><td>${c.orders_count}</td>
       <td>$${c.total_spent.toFixed(2)}</td><td>$${c.aov.toFixed(2)}</td><td>${c.country}</td>
       <td>${c.tags.map(t => `<span class="badge bg-secondary me-1">${t}</span>`).join('')}</td></tr>`
    ).join('');
  }

  async function shopifyGenerateReport() {
    const r = await fetch(`/api/connectors/shopify/reports?store_id=${shopifyState.storeId}`);
    const d = await r.json();
    shopifyState.report = d.rows;
    shopifyState.reportPage = 0;
    shopifyRenderReport();
  }

  function shopifyRenderReport() {
    const rows = shopifyState.report;
    if (!rows.length) { document.getElementById('shopifyReportContent').innerHTML = '<p class="text-muted">No data</p>'; return; }
    const perPage = 20;
    const start = shopifyState.reportPage * perPage;
    const page = rows.slice(start, start + perPage);
    const totalPages = Math.ceil(rows.length / perPage);
    let h = `<p class="text-muted small">${rows.length} rows — page ${shopifyState.reportPage + 1}/${totalPages}</p>
      <table class="table table-dark table-striped table-sm"><thead><tr>
        <th>Date</th><th>Revenue</th><th>Orders</th><th>AOV</th><th>New Cust</th><th>Returning</th><th>Abandoned</th><th>Sessions</th></tr></thead><tbody>`;
    page.forEach(r => {
      h += `<tr><td>${r.date}</td><td>$${r.revenue.toFixed(2)}</td><td>${r.orders}</td>
        <td>$${r.aov.toFixed(2)}</td><td>${r.new_customers}</td><td>${r.returning_customers}</td>
        <td>${r.abandoned_carts}</td><td>${r.sessions}</td></tr>`;
    });
    h += '</tbody></table>';
    if (totalPages > 1) {
      h += '<div class="d-flex gap-2 mt-2">';
      if (shopifyState.reportPage > 0) h += `<button class="btn btn-sm btn-outline-light" onclick="shopifyState.reportPage--;shopifyRenderReport()">← Prev</button>`;
      if (shopifyState.reportPage < totalPages - 1) h += `<button class="btn btn-sm btn-outline-light" onclick="shopifyState.reportPage++;shopifyRenderReport()">Next →</button>`;
      h += '</div>';
    }
    document.getElementById('shopifyReportContent').innerHTML = h;
  }

  function shopifyExportCSV(type) {
    if (type === 'products') {
      downloadCSV('shopify_products.csv', ['Title','Price','Inventory','Status','Collection','Variants'],
        shopifyState.products.map(p => [p.title, p.price, p.inventory, p.status, p.collection, p.variants]));
    } else if (type === 'orders') {
      downloadCSV('shopify_orders.csv', ['Order','Customer','Total','Items','Status','Payment','Date'],
        shopifyState.orders.map(o => [o.order_id, o.customer_name, o.total, o.items, o.status, o.payment_status, o.created]));
    } else if (type === 'customers') {
      downloadCSV('shopify_customers.csv', ['Name','Email','Orders','Total Spent','AOV','Country','Tags'],
        shopifyState.customers.map(c => [c.name, c.email, c.orders_count, c.total_spent, c.aov, c.country, c.tags.join(';')]));
    } else if (type === 'report') {
      downloadCSV('shopify_report.csv', ['Date','Revenue','Orders','AOV','New Customers','Returning','Abandoned','Sessions'],
        shopifyState.report.map(r => [r.date, r.revenue, r.orders, r.aov, r.new_customers, r.returning_customers, r.abandoned_carts, r.sessions]));
    }
  }

  async function shopifyTestApiCall() {
    const endpoint = document.getElementById('shopifyApiEndpoint').value;
    const el = document.getElementById('shopifyApiResult');
    el.textContent = 'Calling Shopify Admin API…';
    try {
      const r = await fetch('/api/connectors/shopify/test-call', {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ endpoint, method: 'GET' })
      });
      el.textContent = JSON.stringify(await r.json(), null, 2);
    } catch (e) { el.textContent = 'Error: ' + e.message; }
  }

  async function shopifySaveSettings() {
    const config = {
      domain: document.getElementById('shopifySettingsDomain').value,
      currency: document.getElementById('shopifySettingsCurrency').value,
      timezone: document.getElementById('shopifySettingsTimezone').value,
    };
    try {
      await fetch('/api/connectors/shopify', {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ status: shopifyState.connected ? 'Connected' : 'Disconnected', config })
      });
      if (window.showToast) window.showToast('Settings Saved', 'Shopify settings updated.', 'success');
    } catch (e) {
      if (window.showToast) window.showToast('Error', 'Failed to save settings.', 'danger');
    }
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // HUBSPOT JS ENGINE (Phase 20)
  // ═══════════════════════════════════════════════════════════════════════════

  const hubspotState = { connected: false, portalId: '', portals: [], overview: null, contacts: [], companies: [], deals: [], campaigns: [], report: [], reportPage: 0 };
  const HS_ORANGE = '#ff7a59';

  async function hubspotInit() {
    try {
      const r = await fetch('/api/connectors/hubspot/portals');
      const d = await r.json();
      hubspotState.portals = d.portals;
      const sel = document.getElementById('hubspotPortalSelect');
      sel.innerHTML = d.portals.map(p => `<option value="${p.portal_id}">${p.name} (${p.plan})</option>`).join('');
      const sr = await fetch('/api/connectors/hubspot');
      const sd = await sr.json();
      if (sd.status === 'Connected') {
        hubspotState.connected = true;
        hubspotState.portalId = d.portals[0].portal_id;
        document.getElementById('hubspotConnStatus').className = 'badge bg-success ms-2';
        document.getElementById('hubspotConnStatus').textContent = 'Connected';
        document.getElementById('hubspotConnectBtn').innerHTML = '<i class="bi bi-plug-fill"></i> Connected';
        hubspotLoadPortal();
      }
    } catch (e) { console.error('hubspotInit error', e); }
  }

  async function hubspotConnect() {
    hubspotState.connected = !hubspotState.connected;
    const btn = document.getElementById('hubspotConnectBtn');
    const badge = document.getElementById('hubspotConnStatus');
    if (hubspotState.connected) {
      btn.innerHTML = '<i class="bi bi-plug-fill"></i> Connected';
      badge.className = 'badge bg-success ms-2'; badge.textContent = 'Connected';
      hubspotState.portalId = document.getElementById('hubspotPortalSelect').value;
      await fetch('/api/connectors/hubspot', { method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ status: 'Connected', config: { portal: hubspotState.portalId } }) });
      hubspotLoadPortal();
    } else {
      btn.innerHTML = '<i class="bi bi-plug"></i> Connect';
      badge.className = 'badge bg-secondary ms-2'; badge.textContent = 'Not Connected';
      await fetch('/api/connectors/hubspot', { method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ status: 'Disconnected', config: {} }) });
      document.getElementById('hubspotOverviewContent').innerHTML = '<p class="text-muted">Click Connect to load CRM data…</p>';
    }
    loadConnectorStatuses();
  }

  async function hubspotLoadPortal() {
    hubspotState.portalId = document.getElementById('hubspotPortalSelect').value;
    if (!hubspotState.connected) return;
    const [ovR, conR, compR, dealR, campR] = await Promise.all([
      fetch(`/api/connectors/hubspot/overview?portal_id=${hubspotState.portalId}`),
      fetch('/api/connectors/hubspot/contacts'),
      fetch('/api/connectors/hubspot/companies'),
      fetch('/api/connectors/hubspot/deals'),
      fetch('/api/connectors/hubspot/campaigns'),
    ]);
    const ov = await ovR.json(); const con = await conR.json(); const comp = await compR.json();
    const deal = await dealR.json(); const camp = await campR.json();
    hubspotState.overview = ov.overview;
    hubspotState.contacts = con.contacts;
    hubspotState.companies = comp.companies;
    hubspotState.deals = deal.deals;
    hubspotState.campaigns = camp.campaigns;
    hubspotRenderOverview();
    hubspotRenderContacts();
    hubspotRenderCompanies();
    hubspotRenderDeals();
    hubspotRenderCampaigns();
  }

  function hubspotRenderOverview() {
    const o = hubspotState.overview; if (!o) return;
    const kpis = [
      { label: 'Total Contacts', value: o.total_contacts.toLocaleString(), icon: 'bi-people', color: HS_ORANGE },
      { label: 'New This Month', value: o.new_contacts_this_month, icon: 'bi-person-plus', color: '#28a745' },
      { label: 'Companies', value: o.total_companies, icon: 'bi-building', color: '#17a2b8' },
      { label: 'Total Deals', value: o.total_deals, icon: 'bi-briefcase', color: '#ffc107' },
      { label: 'Won This Month', value: o.deals_won_this_month, icon: 'bi-trophy', color: '#28a745' },
      { label: 'Open Deals Value', value: `$${o.open_deals_value.toLocaleString()}`, icon: 'bi-cash-stack', color: '#6f42c1' },
      { label: 'Won Revenue', value: `$${o.won_revenue_this_month.toLocaleString()}`, icon: 'bi-wallet2', color: HS_ORANGE },
      { label: 'Revenue Growth', value: `${o.revenue_growth}%`, icon: 'bi-graph-up-arrow', color: '#28a745' },
      { label: 'Pipeline Value', value: `$${o.pipeline_value.toLocaleString()}`, icon: 'bi-funnel', color: '#fd7e14' },
      { label: 'Avg Deal Size', value: `$${o.avg_deal_size.toLocaleString()}`, icon: 'bi-calculator', color: '#20c997' },
      { label: 'Open Tasks', value: o.open_tasks, icon: 'bi-list-task', color: '#17a2b8' },
      { label: 'Overdue Tasks', value: o.overdue_tasks, icon: 'bi-exclamation-circle', color: '#dc3545' },
      { label: 'Emails Sent', value: o.email_sends_this_month.toLocaleString(), icon: 'bi-envelope', color: '#6f42c1' },
      { label: 'Open Rate', value: `${o.email_open_rate}%`, icon: 'bi-envelope-open', color: HS_ORANGE },
      { label: 'Click Rate', value: `${o.email_click_rate}%`, icon: 'bi-cursor', color: '#ffc107' },
      { label: 'Form Submissions', value: o.form_submissions, icon: 'bi-ui-checks', color: '#28a745' },
      { label: 'Meetings Booked', value: o.meetings_booked, icon: 'bi-calendar-check', color: '#17a2b8' },
      { label: 'Calls Logged', value: o.calls_logged, icon: 'bi-telephone', color: '#fd7e14' },
    ];
    let h = '<div class="row g-2 mb-3">';
    kpis.forEach(k => {
      h += `<div class="col-md-2 col-sm-4"><div class="card bg-dark border-secondary h-100"><div class="card-body text-center p-2">
        <i class="bi ${k.icon}" style="color:${k.color};font-size:1.3rem;"></i>
        <div class="text-muted small">${k.label}</div><div class="fw-bold">${k.value}</div>
      </div></div></div>`;
    });
    h += '</div>';

    // Monthly deals sparkline
    if (o.monthly_deals && o.monthly_deals.length) {
      const vals = o.monthly_deals.map(d => d.revenue);
      const max = Math.max(...vals); const min = Math.min(...vals);
      const w = 500, ht = 80, pad = 5;
      const pts = vals.map((v, i) => `${pad + i * ((w - 2*pad) / (vals.length - 1))},${ht - pad - ((v - min) / (max - min || 1)) * (ht - 2*pad)}`).join(' ');
      h += `<div class="card bg-dark border-secondary mb-3"><div class="card-body p-2">
        <h6 class="mb-1"><i class="bi bi-graph-up" style="color:${HS_ORANGE}"></i> Monthly Revenue Trend</h6>
        <svg width="100%" viewBox="0 0 ${w} ${ht}" preserveAspectRatio="none">
          <polyline points="${pts}" fill="none" stroke="${HS_ORANGE}" stroke-width="2.5"/>
          ${vals.map((v, i) => `<circle cx="${pad + i * ((w - 2*pad) / (vals.length - 1))}" cy="${ht - pad - ((v - min) / (max - min || 1)) * (ht - 2*pad)}" r="4" fill="${HS_ORANGE}"/>`).join('')}
        </svg>
        <div class="d-flex justify-content-between text-muted small">${o.monthly_deals.map(d => `<span>${d.month.slice(5)}</span>`).join('')}</div>
      </div></div>`;
    }

    // Deal stage distribution + quarterly goal
    if (o.deal_stage_distribution && o.deal_stage_distribution.length) {
      const stageColors = { 'Appointment Scheduled': '#17a2b8', 'Qualified to Buy': '#ffc107', 'Presentation Scheduled': '#fd7e14', 'Decision Maker Bought-In': '#6f42c1', 'Contract Sent': '#20c997', 'Closed Won': '#28a745', 'Closed Lost': '#dc3545' };
      h += `<div class="row g-3 mb-3"><div class="col-md-7"><div class="card bg-dark border-secondary"><div class="card-body p-2">
        <h6 class="mb-2"><i class="bi bi-funnel" style="color:${HS_ORANGE}"></i> Deal Pipeline</h6>`;
      o.deal_stage_distribution.forEach(s => {
        const pct = Math.round((s.value / o.pipeline_value) * 100);
        const col = stageColors[s.stage] || '#6c757d';
        h += `<div class="mb-1"><div class="d-flex justify-content-between small"><span>${s.stage}</span><span>${s.count} deals · $${s.value.toLocaleString()}</span></div>
          <div class="progress" style="height:6px;"><div class="progress-bar" style="width:${pct}%;background:${col}"></div></div></div>`;
      });
      h += '</div></div></div>';

      // Quarterly goal gauge
      const goalPct = Math.min(Math.round((o.won_revenue_this_month / 50000) * 100), 100);
      h += `<div class="col-md-5"><div class="card bg-dark border-secondary"><div class="card-body p-2">
        <h6 class="mb-2"><i class="bi bi-bullseye" style="color:${HS_ORANGE}"></i> Quarterly Revenue Goal</h6>
        <div class="text-center mb-2"><h3 style="color:${HS_ORANGE}">$${o.won_revenue_this_month.toLocaleString()}</h3><span class="text-muted">of $50,000 goal</span></div>
        <div class="progress mb-2" style="height:20px;">
          <div class="progress-bar" style="width:${goalPct}%;background:${goalPct >= 80 ? '#28a745' : goalPct >= 50 ? '#ffc107' : '#dc3545'}">${goalPct}%</div>
        </div>
        <div class="d-flex justify-content-between text-muted small">
          <span>Growth: <span class="text-success">+${o.revenue_growth}%</span></span>
          <span>Avg Deal: $${o.avg_deal_size.toLocaleString()}</span>
        </div>
      </div></div></div></div>`;
    }
    document.getElementById('hubspotOverviewContent').innerHTML = h;
  }

  async function hubspotLoadContacts() {
    const stage = document.getElementById('hubspotContactStageFilter').value;
    const owner = document.getElementById('hubspotContactOwnerFilter').value;
    let url = '/api/connectors/hubspot/contacts?';
    if (stage) url += `lifecycle_stage=${encodeURIComponent(stage)}&`;
    if (owner) url += `owner=${encodeURIComponent(owner)}`;
    const r = await fetch(url); const d = await r.json();
    hubspotState.contacts = d.contacts;
    hubspotRenderContacts();
  }

  function hubspotRenderContacts() {
    const stageBadge = s => {
      const m = { 'Customer': 'bg-success', 'Evangelist': 'bg-primary', 'Sales Qualified Lead': 'bg-info', 'Marketing Qualified Lead': 'bg-warning text-dark', 'Opportunity': 'bg-purple', 'Lead': 'bg-secondary', 'Subscriber': 'bg-dark border border-secondary' };
      return `<span class="badge ${m[s] || 'bg-secondary'}">${s}</span>`;
    };
    const statusBadge = s => {
      const m = { 'Connected': 'bg-success', 'In Progress': 'bg-info', 'New': 'bg-warning text-dark', 'Open': 'bg-secondary', 'Open Deal': 'bg-primary', 'Attempting to Reach': 'bg-danger' };
      return `<span class="badge ${m[s] || 'bg-secondary'}">${s}</span>`;
    };
    document.getElementById('hubspotContactsBody').innerHTML = hubspotState.contacts.map(c =>
      `<tr><td class="fw-bold small">${c.name}</td><td class="small">${c.email}</td><td class="small">${c.company}</td>
       <td>${stageBadge(c.lifecycle_stage)}</td><td>${statusBadge(c.lead_status)}</td>
       <td class="small">${c.owner}</td><td class="small">${c.last_activity}</td></tr>`
    ).join('');
  }

  async function hubspotLoadCompanies() {
    const industry = document.getElementById('hubspotCompanyIndustryFilter').value;
    let url = '/api/connectors/hubspot/companies?';
    if (industry) url += `industry=${encodeURIComponent(industry)}`;
    const r = await fetch(url); const d = await r.json();
    hubspotState.companies = d.companies;
    hubspotRenderCompanies();
  }

  function hubspotRenderCompanies() {
    const stageBadge = s => {
      const m = { 'Customer': 'bg-success', 'Opportunity': 'bg-info', 'Sales Qualified Lead': 'bg-warning text-dark', 'Marketing Qualified Lead': 'bg-secondary', 'Lead': 'bg-dark border border-secondary' };
      return `<span class="badge ${m[s] || 'bg-secondary'}">${s}</span>`;
    };
    document.getElementById('hubspotCompaniesBody').innerHTML = hubspotState.companies.map(c =>
      `<tr><td class="fw-bold small">${c.name}</td><td class="small">${c.domain}</td><td class="small">${c.industry}</td>
       <td>$${(c.annual_revenue/1000000).toFixed(1)}M</td><td>${c.employees}</td>
       <td>${c.deals_count}</td><td>${c.contacts_count}</td><td>${stageBadge(c.lifecycle_stage)}</td></tr>`
    ).join('');
  }

  async function hubspotLoadDeals() {
    const stage = document.getElementById('hubspotDealStageFilter').value;
    let url = '/api/connectors/hubspot/deals?';
    if (stage) url += `stage=${encodeURIComponent(stage)}`;
    const r = await fetch(url); const d = await r.json();
    hubspotState.deals = d.deals;
    hubspotRenderDeals();
  }

  function hubspotRenderDeals() {
    const stageBadge = s => {
      const m = { 'Closed Won': 'bg-success', 'Closed Lost': 'bg-danger', 'Contract Sent': 'bg-info', 'Decision Maker Bought-In': 'bg-primary',
                  'Presentation Scheduled': 'bg-warning text-dark', 'Qualified to Buy': 'bg-secondary', 'Appointment Scheduled': 'bg-dark border border-secondary' };
      return `<span class="badge ${m[s] || 'bg-secondary'}">${s}</span>`;
    };
    document.getElementById('hubspotDealsBody').innerHTML = hubspotState.deals.map(d =>
      `<tr><td class="fw-bold small">${d.name}</td><td>$${d.amount.toLocaleString()}</td>
       <td>${stageBadge(d.stage)}</td><td>${d.probability}%</td>
       <td class="small">${d.company}</td><td class="small">${d.contact}</td><td class="small">${d.close_date}</td></tr>`
    ).join('');
  }

  async function hubspotLoadCampaigns() {
    const status = document.getElementById('hubspotCampaignStatusFilter').value;
    let url = '/api/connectors/hubspot/campaigns?';
    if (status) url += `status=${status}`;
    const r = await fetch(url); const d = await r.json();
    hubspotState.campaigns = d.campaigns;
    hubspotRenderCampaigns();
  }

  function hubspotRenderCampaigns() {
    const statusBadge = s => {
      const m = { sent: 'bg-success', active: 'bg-info', draft: 'bg-secondary' };
      return `<span class="badge ${m[s] || 'bg-secondary'}">${s}</span>`;
    };
    document.getElementById('hubspotCampaignsBody').innerHTML = hubspotState.campaigns.map(c =>
      `<tr><td class="fw-bold small">${c.name}</td><td class="small">${c.subject}</td><td class="small">${c.type}</td>
       <td>${c.sent.toLocaleString()}</td><td>${c.opens.toLocaleString()}</td>
       <td><span class="badge ${c.open_rate > 40 ? 'bg-success' : c.open_rate > 25 ? 'bg-warning text-dark' : 'bg-danger'}">${c.open_rate}%</span></td>
       <td>${c.clicks.toLocaleString()}</td>
       <td><span class="badge ${c.click_rate > 10 ? 'bg-success' : c.click_rate > 3 ? 'bg-warning text-dark' : 'bg-secondary'}">${c.click_rate}%</span></td>
       <td>${statusBadge(c.status)}</td></tr>`
    ).join('');
  }

  async function hubspotGenerateReport() {
    const r = await fetch(`/api/connectors/hubspot/reports?portal_id=${hubspotState.portalId}`);
    const d = await r.json();
    hubspotState.report = d.rows;
    hubspotState.reportPage = 0;
    hubspotRenderReport();
  }

  function hubspotRenderReport() {
    const rows = hubspotState.report;
    if (!rows.length) { document.getElementById('hubspotReportContent').innerHTML = '<p class="text-muted">No data</p>'; return; }
    const perPage = 20;
    const start = hubspotState.reportPage * perPage;
    const page = rows.slice(start, start + perPage);
    const totalPages = Math.ceil(rows.length / perPage);
    let h = `<p class="text-muted small">${rows.length} rows — page ${hubspotState.reportPage + 1}/${totalPages}</p>
      <table class="table table-dark table-striped table-sm"><thead><tr>
        <th>Date</th><th>Contacts</th><th>Deals Created</th><th>Deals Closed</th><th>Revenue</th><th>Emails</th><th>Opens</th><th>Forms</th><th>Meetings</th></tr></thead><tbody>`;
    page.forEach(r => {
      h += `<tr><td>${r.date}</td><td>${r.contacts_added}</td><td>${r.deals_created}</td>
        <td>${r.deals_closed}</td><td>$${r.revenue.toFixed(2)}</td><td>${r.emails_sent}</td>
        <td>${r.email_opens}</td><td>${r.form_submissions}</td><td>${r.meetings_booked}</td></tr>`;
    });
    h += '</tbody></table>';
    if (totalPages > 1) {
      h += '<div class="d-flex gap-2 mt-2">';
      if (hubspotState.reportPage > 0) h += `<button class="btn btn-sm btn-outline-light" onclick="hubspotState.reportPage--;hubspotRenderReport()">← Prev</button>`;
      if (hubspotState.reportPage < totalPages - 1) h += `<button class="btn btn-sm btn-outline-light" onclick="hubspotState.reportPage++;hubspotRenderReport()">Next →</button>`;
      h += '</div>';
    }
    document.getElementById('hubspotReportContent').innerHTML = h;
  }

  function hubspotExportCSV(type) {
    if (type === 'contacts') {
      downloadCSV('hubspot_contacts.csv', ['Name','Email','Company','Stage','Status','Owner','Last Activity'],
        hubspotState.contacts.map(c => [c.name, c.email, c.company, c.lifecycle_stage, c.lead_status, c.owner, c.last_activity]));
    } else if (type === 'companies') {
      downloadCSV('hubspot_companies.csv', ['Company','Domain','Industry','Revenue','Employees','Deals','Contacts','Stage'],
        hubspotState.companies.map(c => [c.name, c.domain, c.industry, c.annual_revenue, c.employees, c.deals_count, c.contacts_count, c.lifecycle_stage]));
    } else if (type === 'deals') {
      downloadCSV('hubspot_deals.csv', ['Deal','Amount','Stage','Probability','Company','Contact','Close Date'],
        hubspotState.deals.map(d => [d.name, d.amount, d.stage, d.probability, d.company, d.contact, d.close_date]));
    } else if (type === 'campaigns') {
      downloadCSV('hubspot_campaigns.csv', ['Campaign','Subject','Type','Sent','Opens','Open Rate','Clicks','CTR','Status'],
        hubspotState.campaigns.map(c => [c.name, c.subject, c.type, c.sent, c.opens, c.open_rate, c.clicks, c.click_rate, c.status]));
    } else if (type === 'report') {
      downloadCSV('hubspot_report.csv', ['Date','Contacts','Deals Created','Deals Closed','Revenue','Emails','Opens','Forms','Meetings'],
        hubspotState.report.map(r => [r.date, r.contacts_added, r.deals_created, r.deals_closed, r.revenue, r.emails_sent, r.email_opens, r.form_submissions, r.meetings_booked]));
    }
  }

  async function hubspotTestApiCall() {
    const endpoint = document.getElementById('hubspotApiEndpoint').value;
    const el = document.getElementById('hubspotApiResult');
    el.textContent = 'Calling HubSpot CRM API v3…';
    try {
      const r = await fetch('/api/connectors/hubspot/test-call', {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ endpoint, method: 'GET' })
      });
      el.textContent = JSON.stringify(await r.json(), null, 2);
    } catch (e) { el.textContent = 'Error: ' + e.message; }
  }

  async function hubspotSaveSettings() {
    const config = {
      domain: document.getElementById('hubspotSettingsDomain').value,
      owner: document.getElementById('hubspotSettingsOwner').value,
    };
    try {
      await fetch('/api/connectors/hubspot', {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ status: hubspotState.connected ? 'Connected' : 'Disconnected', config })
      });
      if (window.showToast) window.showToast('Settings Saved', 'HubSpot settings updated.', 'success');
    } catch (e) {
      if (window.showToast) window.showToast('Error', 'Failed to save settings.', 'danger');
    }
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // SALESFORCE ENGINE (Phase 21)
  // ═══════════════════════════════════════════════════════════════════════════
  const salesforceState = { connected: false, orgId: '', orgs: [], leads: [], opportunities: [], accounts: [], campaigns: [], reports: [] };

  async function salesforceInit() {
    try {
      const res = await fetch('/api/connectors/salesforce/orgs');
      const data = await res.json();
      salesforceState.orgs = data.orgs || [];
      const sel = document.getElementById('sfOrgSelect');
      sel.innerHTML = '<option value="">— Select org —</option>';
      salesforceState.orgs.forEach(o => {
        sel.innerHTML += `<option value="${o.org_id}">${o.name} (${o.edition})</option>`;
      });
      // Check saved status
      try {
        const sr = await fetch('/api/connectors/salesforce');
        const sd = await sr.json();
        if (sd.status === 'Connected') {
          salesforceState.connected = true;
          document.getElementById('sfConnectBtn').innerHTML = '<i class="bi bi-plug-fill"></i> Connected';
          document.getElementById('sfConnectBtn').classList.replace('btn-outline-info', 'btn-info');
          document.getElementById('sfConnectionAlert').style.display = 'block';
          document.getElementById('sfConnectionAlert').className = 'alert alert-info py-2 small';
          document.getElementById('sfConnectionAlert').textContent = '✓ Connected to Salesforce CRM';
          if (salesforceState.orgs.length > 0) {
            sel.value = salesforceState.orgs[0].org_id;
            salesforceLoadOrg();
          }
        }
      } catch(e) {}
    } catch (e) {
      console.error('Salesforce init error:', e);
    }
  }

  async function salesforceConnect() {
    salesforceState.connected = !salesforceState.connected;
    const btn = document.getElementById('sfConnectBtn');
    const alert = document.getElementById('sfConnectionAlert');
    if (salesforceState.connected) {
      btn.innerHTML = '<i class="bi bi-plug-fill"></i> Connected';
      btn.classList.replace('btn-outline-info', 'btn-info');
      alert.style.display = 'block';
      alert.className = 'alert alert-info py-2 small';
      alert.textContent = '✓ Connected to Salesforce CRM';
      await fetch('/api/connectors/salesforce', {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ status: 'Connected', config: { org: salesforceState.orgs[0]?.name || 'TechStart Production' }})
      });
      if (salesforceState.orgs.length > 0) {
        document.getElementById('sfOrgSelect').value = salesforceState.orgs[0].org_id;
        salesforceLoadOrg();
      }
    } else {
      btn.innerHTML = '<i class="bi bi-plug"></i> Connect Org';
      btn.classList.replace('btn-info', 'btn-outline-info');
      alert.style.display = 'block';
      alert.className = 'alert alert-secondary py-2 small';
      alert.textContent = 'Disconnected from Salesforce';
      await fetch('/api/connectors/salesforce', {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ status: 'Disconnected', config: {} })
      });
    }
    loadConnectorStatuses();
  }

  async function salesforceLoadOrg() {
    const orgId = document.getElementById('sfOrgSelect').value;
    if (!orgId) return;
    salesforceState.orgId = orgId;
    await Promise.all([
      salesforceLoadOverview(orgId),
      salesforceLoadLeads(),
      salesforceLoadOpportunities(),
      salesforceLoadAccounts(),
      salesforceLoadCampaigns()
    ]);
  }

  async function salesforceLoadOverview(orgId) {
    try {
      const res = await fetch(`/api/connectors/salesforce/overview?org_id=${orgId || salesforceState.orgId}`);
      const data = await res.json();
      const o = data.overview;
      salesforceRenderOverview(o);
    } catch (e) { console.error('SF overview error:', e); }
  }

  function salesforceRenderOverview(o) {
    const kpiContainer = document.getElementById('sfOverviewKPIs');
    const kpis = [
      { label: 'Total Leads', value: o.total_leads?.toLocaleString(), icon: 'person-lines-fill', color: '#00a1e0' },
      { label: 'Lead Conv. Rate', value: o.lead_conversion_rate + '%', icon: 'arrow-repeat', color: '#2ecc71' },
      { label: 'Open Opps', value: o.open_opportunities?.toLocaleString(), icon: 'lightning-fill', color: '#f39c12' },
      { label: 'Win Rate', value: o.win_rate + '%', icon: 'trophy-fill', color: '#27ae60' },
      { label: 'Pipeline', value: '$' + (o.pipeline_value / 1000).toFixed(0) + 'K', icon: 'funnel-fill', color: '#3498db' },
      { label: 'Closed Won MTD', value: '$' + (o.closed_won_this_month / 1000).toFixed(0) + 'K', icon: 'cash-stack', color: '#00a1e0' },
      { label: 'Avg Deal Size', value: '$' + (o.avg_deal_size || 0).toLocaleString(), icon: 'tag-fill', color: '#9b59b6' },
      { label: 'Avg Cycle (days)', value: o.avg_sales_cycle_days, icon: 'clock-history', color: '#e74c3c' },
    ];
    kpiContainer.innerHTML = kpis.map(k => `
      <div class="col-6 col-md-3">
        <div class="card bg-dark border-secondary h-100"><div class="card-body text-center py-2">
          <i class="bi bi-${k.icon}" style="color:${k.color};font-size:1.4rem;"></i>
          <div class="fw-bold fs-5 mt-1" style="color:${k.color};">${k.value}</div>
          <div class="text-muted small">${k.label}</div>
        </div></div>
      </div>`).join('');

    // Pipeline stages
    const stageDiv = document.getElementById('sfPipelineStages');
    const stages = o.opportunity_stage_distribution || [];
    const maxVal = Math.max(...stages.map(s => s.value), 1);
    stageDiv.innerHTML = stages.map(s => `
      <div class="d-flex align-items-center mb-2">
        <div class="text-light small" style="width:140px;flex-shrink:0;">${s.stage}</div>
        <div class="flex-grow-1 mx-2">
          <div class="progress" style="height:18px;background:#2a2d31;">
            <div class="progress-bar" style="width:${(s.value/maxVal*100).toFixed(1)}%;background:#00a1e0;" role="progressbar">$${(s.value/1000).toFixed(0)}K</div>
          </div>
        </div>
        <span class="badge bg-secondary">${s.count}</span>
      </div>`).join('');

    // Monthly revenue
    const revDiv = document.getElementById('sfMonthlyRevenue');
    const months = o.monthly_pipeline || [];
    const maxWon = Math.max(...months.map(m => m.won), 1);
    revDiv.innerHTML = months.map(m => `
      <div class="d-flex align-items-center mb-2">
        <div class="text-light small" style="width:70px;">${m.month}</div>
        <div class="flex-grow-1 mx-2">
          <div class="progress" style="height:14px;background:#2a2d31;">
            <div class="progress-bar bg-success" style="width:${(m.won/maxWon*100).toFixed(1)}%;" role="progressbar">$${(m.won/1000).toFixed(0)}K</div>
          </div>
        </div>
      </div>`).join('');
  }

  async function salesforceLoadLeads() {
    const status = document.getElementById('sfLeadStatusFilter').value;
    const rating = document.getElementById('sfLeadRatingFilter').value;
    let url = '/api/connectors/salesforce/leads?';
    if (status) url += `status=${encodeURIComponent(status)}&`;
    if (rating) url += `rating=${encodeURIComponent(rating)}&`;
    try {
      const res = await fetch(url);
      const data = await res.json();
      salesforceState.leads = data.leads || [];
      salesforceRenderLeads();
    } catch(e) { console.error('SF leads error:', e); }
  }

  function salesforceRenderLeads() {
    const statusBadge = s => {
      const colors = { 'working': 'primary', 'open': 'info', 'converted': 'success', 'unqualified': 'secondary' };
      const key = Object.keys(colors).find(k => s.toLowerCase().includes(k)) || 'secondary';
      return `<span class="badge bg-${colors[key]}">${s}</span>`;
    };
    const ratingBadge = r => {
      const c = { 'Hot': 'danger', 'Warm': 'warning', 'Cold': 'info' };
      return `<span class="badge bg-${c[r] || 'secondary'}">${r}</span>`;
    };
    const tbody = document.getElementById('sfLeadsBody');
    tbody.innerHTML = salesforceState.leads.map(l => `<tr>
      <td class="text-light">${l.name}</td><td>${l.company}</td><td class="text-muted small">${l.title}</td>
      <td>${statusBadge(l.status)}</td><td><span class="badge bg-dark border">${l.source}</span></td>
      <td>${ratingBadge(l.rating)}</td><td class="text-muted">${l.owner}</td>
      <td><span class="badge bg-dark border">${l.country}</span></td><td class="text-muted small">${l.last_activity}</td>
    </tr>`).join('');
    document.getElementById('sfLeadsSummary').textContent = `Showing ${salesforceState.leads.length} leads`;
  }

  async function salesforceLoadOpportunities() {
    const stage = document.getElementById('sfOppStageFilter').value;
    let url = '/api/connectors/salesforce/opportunities?';
    if (stage) url += `stage=${encodeURIComponent(stage)}&`;
    try {
      const res = await fetch(url);
      const data = await res.json();
      salesforceState.opportunities = data.opportunities || [];
      salesforceRenderOpportunities();
    } catch(e) { console.error('SF opps error:', e); }
  }

  function salesforceRenderOpportunities() {
    const stageBadge = s => {
      const colors = { 'Closed Won': 'success', 'Closed Lost': 'danger', 'Negotiation': 'warning', 'Proposal': 'info', 'Prospecting': 'secondary', 'Qualification': 'light' };
      const key = Object.keys(colors).find(k => s.includes(k)) || 'primary';
      return `<span class="badge bg-${colors[key]}">${s}</span>`;
    };
    const fcBadge = f => {
      const c = { 'Commit': 'success', 'Best Case': 'info', 'Pipeline': 'warning', 'Closed': 'success', 'Omitted': 'secondary' };
      return `<span class="badge bg-${c[f] || 'secondary'}">${f}</span>`;
    };
    const tbody = document.getElementById('sfOppsBody');
    tbody.innerHTML = salesforceState.opportunities.map(o => `<tr>
      <td class="text-light">${o.name}</td><td>${o.account}</td>
      <td class="text-success fw-bold">$${o.amount.toLocaleString()}</td>
      <td>${stageBadge(o.stage)}</td><td>${o.probability}%</td><td>${o.close_date}</td>
      <td><span class="badge bg-dark border">${o.type}</span></td>
      <td>${fcBadge(o.forecast_category)}</td><td class="text-muted">${o.owner}</td>
    </tr>`).join('');
    const totalPipeline = salesforceState.opportunities.filter(o => !o.stage.includes('Closed')).reduce((s, o) => s + o.amount, 0);
    document.getElementById('sfOppsSummary').textContent = `Showing ${salesforceState.opportunities.length} opportunities · Open pipeline: $${totalPipeline.toLocaleString()}`;
  }

  async function salesforceLoadAccounts() {
    const type = document.getElementById('sfAccountTypeFilter').value;
    let url = '/api/connectors/salesforce/accounts?';
    if (type) url += `type=${encodeURIComponent(type)}&`;
    try {
      const res = await fetch(url);
      const data = await res.json();
      salesforceState.accounts = data.accounts || [];
      salesforceRenderAccounts();
    } catch(e) { console.error('SF accounts error:', e); }
  }

  function salesforceRenderAccounts() {
    const tbody = document.getElementById('sfAccountsBody');
    tbody.innerHTML = salesforceState.accounts.map(a => `<tr>
      <td class="text-light">${a.name}</td><td>${a.industry}</td>
      <td class="text-success">$${(a.annual_revenue / 1000000).toFixed(1)}M</td>
      <td>${a.employees.toLocaleString()}</td>
      <td><span class="badge bg-${a.type === 'Customer' ? 'success' : 'info'}">${a.type}</span></td>
      <td><span class="badge bg-${a.rating === 'Hot' ? 'danger' : a.rating === 'Warm' ? 'warning' : 'info'}">${a.rating}</span></td>
      <td>${a.open_opportunities}</td>
      <td class="text-success">$${a.total_won.toLocaleString()}</td>
      <td class="text-muted">${a.owner}</td>
    </tr>`).join('');
    const totalRev = salesforceState.accounts.reduce((s, a) => s + a.annual_revenue, 0);
    document.getElementById('sfAccountsSummary').textContent = `Showing ${salesforceState.accounts.length} accounts · Total revenue: $${(totalRev / 1000000).toFixed(1)}M`;
  }

  async function salesforceLoadCampaigns() {
    const status = document.getElementById('sfCampaignStatusFilter').value;
    let url = '/api/connectors/salesforce/campaigns?';
    if (status) url += `status=${encodeURIComponent(status)}&`;
    try {
      const res = await fetch(url);
      const data = await res.json();
      salesforceState.campaigns = data.campaigns || [];
      salesforceRenderCampaigns();
    } catch(e) { console.error('SF campaigns error:', e); }
  }

  function salesforceRenderCampaigns() {
    const statusBadge = s => {
      const c = { 'Active': 'success', 'Completed': 'secondary', 'Planned': 'info' };
      return `<span class="badge bg-${c[s] || 'secondary'}">${s}</span>`;
    };
    const tbody = document.getElementById('sfCampaignsBody');
    tbody.innerHTML = salesforceState.campaigns.map(c => `<tr>
      <td class="text-light">${c.name}</td>
      <td><span class="badge bg-dark border">${c.type}</span></td>
      <td>${statusBadge(c.status)}</td>
      <td>$${c.budget.toLocaleString()}</td>
      <td>$${c.actual_cost.toLocaleString()}</td>
      <td>${c.members.toLocaleString()}</td>
      <td>${c.responses.toLocaleString()}</td>
      <td>${c.converted}</td>
      <td class="text-${c.roi > 100 ? 'success' : c.roi > 0 ? 'warning' : 'muted'} fw-bold">${c.roi}%</td>
    </tr>`).join('');
    document.getElementById('sfCampaignsSummary').textContent = `Showing ${salesforceState.campaigns.length} campaigns`;
  }

  async function salesforceGenerateReport() {
    try {
      const res = await fetch('/api/connectors/salesforce/reports');
      const data = await res.json();
      salesforceState.reports = data.rows || [];
      salesforceRenderReports();
    } catch(e) { console.error('SF reports error:', e); }
  }

  function salesforceRenderReports() {
    const tbody = document.getElementById('sfReportsBody');
    tbody.innerHTML = salesforceState.reports.map(r => `<tr>
      <td class="text-light">${r.date}</td><td>${r.new_leads}</td><td>${r.converted_leads}</td>
      <td>${r.opps_created}</td><td>${r.opps_closed_won}</td>
      <td class="text-success">$${r.revenue.toLocaleString()}</td>
      <td class="text-info">$${r.pipeline_added.toLocaleString()}</td>
      <td>${r.activities}</td><td>${r.cases_closed}</td>
    </tr>`).join('');
    document.getElementById('sfReportsSummary').textContent = `Showing ${salesforceState.reports.length} daily rows`;
  }

  function salesforceExportCSV(type) {
    if (type === 'leads') {
      downloadCSV('salesforce_leads.csv', ['Name','Company','Title','Status','Source','Rating','Owner','Country','Last Activity'],
        salesforceState.leads.map(l => [l.name, l.company, l.title, l.status, l.source, l.rating, l.owner, l.country, l.last_activity]));
    } else if (type === 'opportunities') {
      downloadCSV('salesforce_opportunities.csv', ['Name','Account','Amount','Stage','Probability','Close Date','Type','Forecast','Owner'],
        salesforceState.opportunities.map(o => [o.name, o.account, o.amount, o.stage, o.probability, o.close_date, o.type, o.forecast_category, o.owner]));
    } else if (type === 'accounts') {
      downloadCSV('salesforce_accounts.csv', ['Name','Industry','Revenue','Employees','Type','Rating','Open Opps','Total Won','Owner'],
        salesforceState.accounts.map(a => [a.name, a.industry, a.annual_revenue, a.employees, a.type, a.rating, a.open_opportunities, a.total_won, a.owner]));
    } else if (type === 'campaigns') {
      downloadCSV('salesforce_campaigns.csv', ['Name','Type','Status','Budget','Cost','Members','Responses','Converted','ROI'],
        salesforceState.campaigns.map(c => [c.name, c.type, c.status, c.budget, c.actual_cost, c.members, c.responses, c.converted, c.roi]));
    } else if (type === 'reports') {
      downloadCSV('salesforce_daily_report.csv', ['Date','New Leads','Converted','Opps Created','Closed Won','Revenue','Pipeline Added','Activities','Cases Closed'],
        salesforceState.reports.map(r => [r.date, r.new_leads, r.converted_leads, r.opps_created, r.opps_closed_won, r.revenue, r.pipeline_added, r.activities, r.cases_closed]));
    }
  }

  async function salesforceTestApiCall() {
    const endpoint = document.getElementById('sfApiEndpoint').value;
    const resultEl = document.getElementById('sfApiResult');
    resultEl.textContent = 'Calling Salesforce REST API …';
    try {
      const res = await fetch('/api/connectors/salesforce/test-call', {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ endpoint, method: 'GET' })
      });
      const data = await res.json();
      resultEl.textContent = JSON.stringify(data, null, 2);
    } catch(e) {
      resultEl.textContent = 'Error: ' + e.message;
    }
  }

  async function salesforceSaveSettings() {
    const config = {
      instance: document.getElementById('sfSettingsInstance').value,
      api_version: document.getElementById('sfSettingsApiVersion').value,
      owner: document.getElementById('sfSettingsOwner').value,
    };
    try {
      await fetch('/api/connectors/salesforce', {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ status: salesforceState.connected ? 'Connected' : 'Disconnected', config })
      });
      if (window.showToast) window.showToast('Settings Saved', 'Salesforce settings updated.', 'success');
    } catch (e) {
      if (window.showToast) window.showToast('Error', 'Failed to save settings.', 'danger');
    }
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // QUICKBOOKS ENGINE (Phase 22)
  // ═══════════════════════════════════════════════════════════════════════════
  const quickbooksState = { connected: false, companyId: '', companies: [], invoices: [], expenses: [], banking: [], reports: [] };

  async function quickbooksInit() {
    try {
      const res = await fetch('/api/connectors/quickbooks/companies');
      const data = await res.json();
      quickbooksState.companies = data.companies || [];
      const sel = document.getElementById('qbCompanySelect');
      sel.innerHTML = '<option value="">— Select company —</option>';
      quickbooksState.companies.forEach(c => {
        sel.innerHTML += `<option value="${c.company_id}">${c.name} (${c.industry})</option>`;
      });
      try {
        const sr = await fetch('/api/connectors/quickbooks');
        const sd = await sr.json();
        if (sd.status === 'Connected') {
          quickbooksState.connected = true;
          document.getElementById('qbConnectBtn').innerHTML = '<i class="bi bi-plug-fill"></i> Connected';
          document.getElementById('qbConnectBtn').classList.replace('btn-outline-success', 'btn-success');
          document.getElementById('qbConnectionAlert').style.display = 'block';
          document.getElementById('qbConnectionAlert').className = 'alert alert-success py-2 small';
          document.getElementById('qbConnectionAlert').textContent = '✓ Connected to QuickBooks Online';
          if (quickbooksState.companies.length > 0) {
            sel.value = quickbooksState.companies[0].company_id;
            quickbooksLoadCompany();
          }
        }
      } catch(e) {}
    } catch (e) {
      console.error('QuickBooks init error:', e);
    }
  }

  async function quickbooksConnect() {
    quickbooksState.connected = !quickbooksState.connected;
    const btn = document.getElementById('qbConnectBtn');
    const alert = document.getElementById('qbConnectionAlert');
    if (quickbooksState.connected) {
      btn.innerHTML = '<i class="bi bi-plug-fill"></i> Connected';
      btn.classList.replace('btn-outline-success', 'btn-success');
      alert.style.display = 'block';
      alert.className = 'alert alert-success py-2 small';
      alert.textContent = '✓ Connected to QuickBooks Online';
      await fetch('/api/connectors/quickbooks', {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ status: 'Connected', config: { company: quickbooksState.companies[0]?.name || 'TechStart Agency' }})
      });
      if (quickbooksState.companies.length > 0) {
        document.getElementById('qbCompanySelect').value = quickbooksState.companies[0].company_id;
        quickbooksLoadCompany();
      }
    } else {
      btn.innerHTML = '<i class="bi bi-plug"></i> Connect Company';
      btn.classList.replace('btn-success', 'btn-outline-success');
      alert.style.display = 'block';
      alert.className = 'alert alert-secondary py-2 small';
      alert.textContent = 'Disconnected from QuickBooks';
      await fetch('/api/connectors/quickbooks', {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ status: 'Disconnected', config: {} })
      });
    }
    loadConnectorStatuses();
  }

  async function quickbooksLoadCompany() {
    const cid = document.getElementById('qbCompanySelect').value;
    if (!cid) return;
    quickbooksState.companyId = cid;
    await Promise.all([
      quickbooksLoadOverview(cid),
      quickbooksLoadInvoices(),
      quickbooksLoadExpenses(),
      quickbooksLoadBanking()
    ]);
  }

  async function quickbooksLoadOverview(cid) {
    try {
      const res = await fetch(`/api/connectors/quickbooks/overview?company_id=${cid || quickbooksState.companyId}`);
      const data = await res.json();
      quickbooksRenderOverview(data.overview);
    } catch (e) { console.error('QB overview error:', e); }
  }

  function quickbooksRenderOverview(o) {
    const kpiContainer = document.getElementById('qbOverviewKPIs');
    const kpis = [
      { label: 'Revenue', value: '$' + (o.total_revenue || 0).toLocaleString(), icon: 'cash-coin', color: '#2CA01C' },
      { label: 'Expenses', value: '$' + (o.total_expenses || 0).toLocaleString(), icon: 'credit-card-2-back', color: '#e74c3c' },
      { label: 'Net Profit', value: '$' + (o.net_profit || 0).toLocaleString(), icon: 'graph-up-arrow', color: '#3498db' },
      { label: 'Profit Margin', value: (o.profit_margin || 0) + '%', icon: 'percent', color: '#27ae60' },
      { label: 'Cash on Hand', value: '$' + (o.cash_on_hand || 0).toLocaleString(), icon: 'safe', color: '#f39c12' },
      { label: 'Cash Flow', value: '$' + (o.cash_flow || 0).toLocaleString(), icon: 'arrow-left-right', color: '#9b59b6' },
      { label: 'Accts Receivable', value: '$' + (o.accounts_receivable || 0).toLocaleString(), icon: 'receipt', color: '#2CA01C' },
      { label: 'Accts Payable', value: '$' + (o.accounts_payable || 0).toLocaleString(), icon: 'receipt-cutoff', color: '#e67e22' },
    ];
    kpiContainer.innerHTML = kpis.map(k => `
      <div class="col-6 col-md-3">
        <div class="card bg-dark border-secondary h-100"><div class="card-body text-center py-2">
          <i class="bi bi-${k.icon}" style="color:${k.color};font-size:1.4rem;"></i>
          <div class="fw-bold fs-5 mt-1" style="color:${k.color};">${k.value}</div>
          <div class="text-muted small">${k.label}</div>
        </div></div>
      </div>`).join('');

    // Monthly P&L bars
    const pnlDiv = document.getElementById('qbMonthlyPnl');
    const months = o.monthly_pnl || [];
    const maxRev = Math.max(...months.map(m => m.revenue), 1);
    pnlDiv.innerHTML = months.map(m => `
      <div class="mb-2">
        <div class="d-flex justify-content-between small mb-1">
          <span class="text-light">${m.month}</span>
          <span class="text-success">$${(m.profit/1000).toFixed(1)}K profit</span>
        </div>
        <div class="progress" style="height:16px;background:#2a2d31;">
          <div class="progress-bar bg-success" style="width:${(m.revenue/maxRev*100).toFixed(1)}%;" role="progressbar">$${(m.revenue/1000).toFixed(1)}K</div>
        </div>
        <div class="progress mt-1" style="height:10px;background:#2a2d31;">
          <div class="progress-bar bg-danger" style="width:${(m.expenses/maxRev*100).toFixed(1)}%;opacity:.7;" role="progressbar"></div>
        </div>
      </div>`).join('');

    // Expense breakdown
    const expDiv = document.getElementById('qbExpenseBreakdown');
    const cats = o.expense_by_category || [];
    const catColors = ['#3498db', '#e74c3c', '#f39c12', '#2ecc71', '#9b59b6', '#1abc9c'];
    expDiv.innerHTML = cats.map((c, i) => `
      <div class="d-flex align-items-center mb-2">
        <div style="width:12px;height:12px;border-radius:50%;background:${catColors[i % catColors.length]};flex-shrink:0;" class="me-2"></div>
        <div class="text-light small flex-grow-1">${c.category}</div>
        <div class="text-muted small me-2">${c.pct}%</div>
        <div class="fw-bold small" style="color:${catColors[i % catColors.length]};">$${c.amount.toLocaleString()}</div>
      </div>`).join('');
  }

  async function quickbooksLoadInvoices() {
    const status = document.getElementById('qbInvoiceStatusFilter').value;
    let url = '/api/connectors/quickbooks/invoices?';
    if (status) url += `status=${encodeURIComponent(status)}&`;
    try {
      const res = await fetch(url);
      const data = await res.json();
      quickbooksState.invoices = data.invoices || [];
      quickbooksRenderInvoices();
    } catch(e) { console.error('QB invoices error:', e); }
  }

  function quickbooksRenderInvoices() {
    const statusBadge = s => {
      const c = { 'Paid': 'success', 'Open': 'info', 'Overdue': 'danger' };
      return `<span class="badge bg-${c[s] || 'secondary'}">${s}</span>`;
    };
    const tbody = document.getElementById('qbInvoicesBody');
    tbody.innerHTML = quickbooksState.invoices.map(inv => `<tr>
      <td class="text-light">${inv.invoice_id}</td><td>${inv.customer}</td>
      <td class="text-success">$${inv.amount.toLocaleString()}</td>
      <td class="${inv.balance_due > 0 ? 'text-warning' : 'text-muted'}">$${inv.balance_due.toLocaleString()}</td>
      <td>${statusBadge(inv.status)}</td><td>${inv.due_date}</td>
      <td><span class="badge bg-dark border">${inv.terms}</span></td>
      <td class="text-muted small">${inv.items}</td>
    </tr>`).join('');
    const totalAmt = quickbooksState.invoices.reduce((s, i) => s + i.amount, 0);
    const totalDue = quickbooksState.invoices.reduce((s, i) => s + i.balance_due, 0);
    document.getElementById('qbInvoicesSummary').textContent = `Showing ${quickbooksState.invoices.length} invoices · Total: $${totalAmt.toLocaleString()} · Outstanding: $${totalDue.toLocaleString()}`;
  }

  async function quickbooksLoadExpenses() {
    const cat = document.getElementById('qbExpenseCategoryFilter').value;
    let url = '/api/connectors/quickbooks/expenses?';
    if (cat) url += `category=${encodeURIComponent(cat)}&`;
    try {
      const res = await fetch(url);
      const data = await res.json();
      quickbooksState.expenses = data.expenses || [];
      quickbooksRenderExpenses();
    } catch(e) { console.error('QB expenses error:', e); }
  }

  function quickbooksRenderExpenses() {
    const tbody = document.getElementById('qbExpensesBody');
    tbody.innerHTML = quickbooksState.expenses.map(e => `<tr>
      <td class="text-muted">${e.expense_id}</td><td class="text-light">${e.vendor}</td>
      <td><span class="badge bg-dark border">${e.category}</span></td>
      <td class="text-danger">$${e.amount.toLocaleString()}</td>
      <td>${e.date}</td>
      <td class="text-muted small">${e.payment_method}</td>
      <td><span class="badge bg-${e.status === 'Paid' ? 'success' : 'warning'}">${e.status}</span></td>
      <td class="text-muted small">${e.description}</td>
    </tr>`).join('');
    const totalExp = quickbooksState.expenses.reduce((s, e) => s + e.amount, 0);
    document.getElementById('qbExpensesSummary').textContent = `Showing ${quickbooksState.expenses.length} expenses · Total: $${totalExp.toLocaleString()}`;
  }

  async function quickbooksLoadBanking() {
    const type = document.getElementById('qbBankingTypeFilter').value;
    let url = '/api/connectors/quickbooks/banking?';
    if (type) url += `type=${encodeURIComponent(type)}&`;
    try {
      const res = await fetch(url);
      const data = await res.json();
      quickbooksState.banking = data.transactions || [];
      quickbooksRenderBanking();
    } catch(e) { console.error('QB banking error:', e); }
  }

  function quickbooksRenderBanking() {
    const tbody = document.getElementById('qbBankingBody');
    tbody.innerHTML = quickbooksState.banking.map(t => `<tr>
      <td>${t.date}</td><td class="text-light">${t.description}</td>
      <td class="${t.amount >= 0 ? 'text-success' : 'text-danger'} fw-bold">$${Math.abs(t.amount).toLocaleString()}</td>
      <td><span class="badge bg-${t.type === 'Credit' ? 'success' : 'danger'}">${t.type}</span></td>
      <td class="text-muted small">${t.account}</td>
      <td>${t.category ? `<span class="badge bg-dark border">${t.category}</span>` : '<span class="badge bg-warning text-dark">Uncategorized</span>'}</td>
      <td>${t.categorized ? '<i class="bi bi-check-circle-fill text-success"></i>' : '<i class="bi bi-exclamation-circle text-warning"></i>'}</td>
    </tr>`).join('');
    const credits = quickbooksState.banking.filter(t => t.type === 'Credit').reduce((s, t) => s + t.amount, 0);
    const debits = quickbooksState.banking.filter(t => t.type === 'Debit').reduce((s, t) => s + Math.abs(t.amount), 0);
    const uncat = quickbooksState.banking.filter(t => !t.categorized).length;
    document.getElementById('qbBankingSummary').textContent = `${quickbooksState.banking.length} transactions · In: $${credits.toLocaleString()} · Out: $${debits.toLocaleString()} · ${uncat} uncategorized`;
  }

  async function quickbooksGenerateReport() {
    try {
      const res = await fetch('/api/connectors/quickbooks/reports');
      const data = await res.json();
      quickbooksState.reports = data.rows || [];
      quickbooksRenderReports();
    } catch(e) { console.error('QB reports error:', e); }
  }

  function quickbooksRenderReports() {
    const tbody = document.getElementById('qbReportsBody');
    tbody.innerHTML = quickbooksState.reports.map(r => `<tr>
      <td class="text-light">${r.date}</td>
      <td class="text-success">$${r.revenue.toLocaleString()}</td>
      <td class="text-muted">$${r.cost_of_goods.toLocaleString()}</td>
      <td class="text-info">$${r.gross_profit.toLocaleString()}</td>
      <td class="text-danger">$${r.operating_expenses.toLocaleString()}</td>
      <td class="fw-bold ${r.net_income >= 0 ? 'text-success' : 'text-danger'}">$${r.net_income.toLocaleString()}</td>
      <td>${r.invoices_sent}</td><td>${r.payments_received}</td><td>${r.bills_paid}</td>
    </tr>`).join('');
    document.getElementById('qbReportsSummary').textContent = `Showing ${quickbooksState.reports.length} daily rows`;
  }

  function quickbooksExportCSV(type) {
    if (type === 'invoices') {
      downloadCSV('quickbooks_invoices.csv', ['Invoice #','Customer','Amount','Balance Due','Status','Due Date','Terms','Items'],
        quickbooksState.invoices.map(i => [i.invoice_id, i.customer, i.amount, i.balance_due, i.status, i.due_date, i.terms, i.items]));
    } else if (type === 'expenses') {
      downloadCSV('quickbooks_expenses.csv', ['ID','Vendor','Category','Amount','Date','Method','Status','Description'],
        quickbooksState.expenses.map(e => [e.expense_id, e.vendor, e.category, e.amount, e.date, e.payment_method, e.status, e.description]));
    } else if (type === 'banking') {
      downloadCSV('quickbooks_banking.csv', ['Date','Description','Amount','Type','Account','Category','Categorized'],
        quickbooksState.banking.map(t => [t.date, t.description, t.amount, t.type, t.account, t.category || '', t.categorized]));
    } else if (type === 'reports') {
      downloadCSV('quickbooks_daily_pnl.csv', ['Date','Revenue','COGS','Gross Profit','OpEx','Net Income','Invoices Sent','Payments','Bills Paid'],
        quickbooksState.reports.map(r => [r.date, r.revenue, r.cost_of_goods, r.gross_profit, r.operating_expenses, r.net_income, r.invoices_sent, r.payments_received, r.bills_paid]));
    }
  }

  async function quickbooksTestApiCall() {
    const endpoint = document.getElementById('qbApiEndpoint').value;
    const resultEl = document.getElementById('qbApiResult');
    resultEl.textContent = 'Calling QuickBooks API …';
    try {
      const res = await fetch('/api/connectors/quickbooks/test-call', {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ endpoint, method: 'GET' })
      });
      const data = await res.json();
      resultEl.textContent = JSON.stringify(data, null, 2);
    } catch(e) {
      resultEl.textContent = 'Error: ' + e.message;
    }
  }

  async function quickbooksSaveSettings() {
    const config = {
      company: document.getElementById('qbSettingsCompany').value,
      fiscal_year: document.getElementById('qbSettingsFiscalYear').value,
      tax_rate: document.getElementById('qbSettingsTaxRate').value,
    };
    try {
      await fetch('/api/connectors/quickbooks', {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ status: quickbooksState.connected ? 'Connected' : 'Disconnected', config })
      });
      if (window.showToast) window.showToast('Settings Saved', 'QuickBooks settings updated.', 'success');
    } catch (e) {
      if (window.showToast) window.showToast('Error', 'Failed to save settings.', 'danger');
    }
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // MAILCHIMP  –  Email Marketing & Automation Engine
  // ═══════════════════════════════════════════════════════════════════════════
  const mailchimpState = { connected: false, audiences: [], overview: null, campaigns: [], automations: [], segments: [], reports: [] };

  async function mailchimpInit() {
    try {
      const saved = await fetch('/api/connectors/mailchimp').then(r => r.json());
      if (saved.status === 'Connected') { mailchimpState.connected = true; }
    } catch {}
    mailchimpUpdateUI();
    await mailchimpLoadAudiences();
    await mailchimpLoadOverview();
  }

  function mailchimpUpdateUI() {
    const badge = document.getElementById('mcConnBadge');
    const btn   = document.getElementById('mcConnectBtn');
    if (mailchimpState.connected) {
      badge.textContent = 'Connected'; badge.className = 'badge bg-success ms-2';
      btn.textContent = 'Disconnect'; btn.style.background = '#dc3545'; btn.style.color = '#fff';
    } else {
      badge.textContent = 'Disconnected'; badge.className = 'badge bg-secondary ms-2';
      btn.textContent = 'Connect'; btn.style.background = '#FFE01B'; btn.style.color = '#241C15';
    }
  }

  async function mailchimpToggleConnect() {
    mailchimpState.connected = !mailchimpState.connected;
    mailchimpUpdateUI();
    try {
      await fetch('/api/connectors/mailchimp', {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ status: mailchimpState.connected ? 'Connected' : 'Disconnected' })
      });
    } catch {}
    if (mailchimpState.connected) { await mailchimpLoadAudiences(); await mailchimpLoadOverview(); }
    if (window.showToast) window.showToast('Mailchimp', mailchimpState.connected ? 'Connected to Mailchimp' : 'Disconnected from Mailchimp', mailchimpState.connected ? 'success' : 'warning');
  }

  async function mailchimpLoadAudiences() {
    try {
      mailchimpState.audiences = await fetch('/api/connectors/mailchimp/audiences').then(r => r.json());
      const selects = ['mcAudienceSelect','mcCampAudience','mcAutoAudience','mcSegAudience','mcSettingsAudience'];
      selects.forEach(id => {
        const sel = document.getElementById(id);
        const val = sel.value;
        while (sel.options.length > 1) sel.remove(1);
        mailchimpState.audiences.forEach(a => {
          const opt = document.createElement('option');
          opt.value = a.name; opt.textContent = `${a.name} (${a.member_count.toLocaleString()})`;
          sel.appendChild(opt);
        });
        sel.value = val || 'all';
      });
    } catch {}
  }

  async function mailchimpLoadOverview() {
    const aud = document.getElementById('mcAudienceSelect').value;
    try {
      mailchimpState.overview = await fetch(`/api/connectors/mailchimp/overview?audience=${encodeURIComponent(aud)}`).then(r => r.json());
      mailchimpRenderOverview();
    } catch {}
  }

  function mailchimpRenderOverview() {
    const ov = mailchimpState.overview; if (!ov) return;
    const kpiRow = document.getElementById('mcKpiRow');
    kpiRow.innerHTML = ov.kpis.map(k => `
      <div class="col-md-4 col-lg-2">
        <div class="card bg-dark border-secondary h-100">
          <div class="card-body p-2 text-center">
            <div class="text-muted small">${k.label}</div>
            <div class="fs-5 fw-bold" style="color:#FFE01B;">${k.value}</div>
            <small class="${k.trend==='up'?'text-success':k.trend==='down'?'text-danger':'text-muted'}">${k.change}</small>
          </div>
        </div>
      </div>`).join('');
    const tbody = document.getElementById('mcTrendBody');
    tbody.innerHTML = (ov.monthly_trend||[]).map(t => `
      <tr><td>${t.month}</td><td>${t.sent}</td><td>${t.opens.toLocaleString()}</td><td>${t.clicks.toLocaleString()}</td><td>$${t.revenue.toLocaleString()}</td></tr>`).join('');
  }

  async function mailchimpLoadCampaigns() {
    const status = document.getElementById('mcCampStatus').value;
    const ctype  = document.getElementById('mcCampType').value;
    const aud    = document.getElementById('mcCampAudience').value;
    try {
      mailchimpState.campaigns = await fetch(`/api/connectors/mailchimp/campaigns?status=${status}&type=${ctype}&audience=${encodeURIComponent(aud)}`).then(r => r.json());
      mailchimpRenderCampaigns();
    } catch {}
  }

  function mailchimpRenderCampaigns() {
    const tbody = document.getElementById('mcCampaignsBody');
    tbody.innerHTML = mailchimpState.campaigns.map(c => {
      const statusBadge = c.status === 'sent' ? 'success' : c.status === 'draft' ? 'secondary' : 'info';
      return `<tr>
        <td title="${c.subject}">${c.subject.length > 40 ? c.subject.substring(0,40)+'…' : c.subject}</td>
        <td><span class="badge bg-dark border">${c.type}</span></td>
        <td><span class="badge bg-${statusBadge}">${c.status}</span></td>
        <td>${c.audience}</td>
        <td>${c.recipients.toLocaleString()}</td>
        <td>${c.opens.toLocaleString()}</td>
        <td>${c.clicks.toLocaleString()}</td>
        <td>${c.revenue ? '$'+c.revenue.toLocaleString() : '—'}</td>
        <td>${c.send_time || '—'}</td>
      </tr>`;
    }).join('');
  }

  async function mailchimpLoadAutomations() {
    const status = document.getElementById('mcAutoStatus').value;
    const aud    = document.getElementById('mcAutoAudience').value;
    try {
      mailchimpState.automations = await fetch(`/api/connectors/mailchimp/automations?status=${status}&audience=${encodeURIComponent(aud)}`).then(r => r.json());
      mailchimpRenderAutomations();
    } catch {}
  }

  function mailchimpRenderAutomations() {
    const tbody = document.getElementById('mcAutomationsBody');
    tbody.innerHTML = mailchimpState.automations.map(a => {
      const statusBadge = a.status === 'active' ? 'success' : 'warning';
      return `<tr>
        <td>${a.name}</td>
        <td><code>${a.trigger}</code></td>
        <td><span class="badge bg-${statusBadge}">${a.status}</span></td>
        <td>${a.audience}</td>
        <td>${a.emails_in_series}</td>
        <td>${a.emails_sent.toLocaleString()}</td>
        <td>${a.open_rate}%</td>
        <td>${a.click_rate}%</td>
      </tr>`;
    }).join('');
  }

  async function mailchimpLoadSegments() {
    const aud = document.getElementById('mcSegAudience').value;
    try {
      mailchimpState.segments = await fetch(`/api/connectors/mailchimp/segments?audience=${encodeURIComponent(aud)}`).then(r => r.json());
      mailchimpRenderSegments();
    } catch {}
  }

  function mailchimpRenderSegments() {
    const tbody = document.getElementById('mcSegmentsBody');
    tbody.innerHTML = mailchimpState.segments.map(s => `
      <tr><td>${s.name}</td><td>${s.audience}</td><td>${s.member_count.toLocaleString()}</td><td><code>${s.conditions}</code></td></tr>`).join('');
  }

  async function mailchimpLoadReports() {
    try {
      mailchimpState.reports = await fetch('/api/connectors/mailchimp/reports').then(r => r.json());
      mailchimpRenderReports();
    } catch {}
  }

  function mailchimpRenderReports() {
    const tbody = document.getElementById('mcReportsBody');
    tbody.innerHTML = mailchimpState.reports.map(r => {
      const typeBadge = r.type === 'Campaign' ? 'primary' : r.type === 'Automation' ? 'info' : 'secondary';
      return `<tr>
        <td><span class="badge bg-${typeBadge}">${r.type}</span></td>
        <td title="${r.name}">${r.name.length > 35 ? r.name.substring(0,35)+'…' : r.name}</td>
        <td><span class="badge bg-${r.status==='sent'||r.status==='active'?'success':'secondary'}">${r.status}</span></td>
        <td>${r.audience}</td>
        <td>${r.recipients.toLocaleString()}</td>
        <td>${r.open_rate}%</td>
        <td>${r.click_rate}%</td>
        <td>${r.revenue ? '$'+r.revenue.toLocaleString() : '—'}</td>
      </tr>`;
    }).join('');
  }

  function mailchimpExportCampaigns() {
    downloadCSV('mailchimp_campaigns.csv',
      ['Subject','Type','Status','Audience','Recipients','Opens','Clicks','Revenue','Send Time'],
      mailchimpState.campaigns.map(c => [c.subject,c.type,c.status,c.audience,c.recipients,c.opens,c.clicks,c.revenue,c.send_time||'']));
  }
  function mailchimpExportAutomations() {
    downloadCSV('mailchimp_automations.csv',
      ['Name','Trigger','Status','Audience','Emails','Sent','Open Rate','Click Rate'],
      mailchimpState.automations.map(a => [a.name,a.trigger,a.status,a.audience,a.emails_in_series,a.emails_sent,a.open_rate,a.click_rate]));
  }
  function mailchimpExportSegments() {
    downloadCSV('mailchimp_segments.csv',
      ['Name','Audience','Members','Conditions'],
      mailchimpState.segments.map(s => [s.name,s.audience,s.member_count,s.conditions]));
  }
  function mailchimpExportReports() {
    downloadCSV('mailchimp_reports.csv',
      ['Type','Name','Status','Audience','Recipients','Open Rate','Click Rate','Revenue'],
      mailchimpState.reports.map(r => [r.type,r.name,r.status,r.audience,r.recipients,r.open_rate,r.click_rate,r.revenue]));
  }

  async function mailchimpTestApiCall() {
    const endpoint = document.getElementById('mcTestEndpoint').value;
    const pre = document.getElementById('mcTestResult');
    pre.textContent = 'Calling Mailchimp API…';
    try {
      const res = await fetch('/api/connectors/mailchimp/test-call', {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ endpoint, method: 'GET' })
      });
      const data = await res.json();
      pre.textContent = JSON.stringify(data, null, 2);
    } catch (e) { pre.textContent = 'Error: ' + e.message; }
  }

  async function mailchimpSaveSettings() {
    const config = {
      api_key: document.getElementById('mcSettingsApiKey').value,
      server: document.getElementById('mcSettingsServer').value,
      default_audience: document.getElementById('mcSettingsAudience').value,
      sync_frequency: document.getElementById('mcSettingsSync').value,
    };
    try {
      await fetch('/api/connectors/mailchimp', {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ status: mailchimpState.connected ? 'Connected' : 'Disconnected', config })
      });
      if (window.showToast) window.showToast('Settings Saved', 'Mailchimp settings updated.', 'success');
    } catch (e) {
      if (window.showToast) window.showToast('Error', 'Failed to save settings.', 'danger');
    }
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // PAYPAL  –  Payments, Payouts & Disputes Engine
  // ═══════════════════════════════════════════════════════════════════════════
  const paypalState = { connected: false, accounts: [], overview: null, transactions: [], payouts: [], disputes: [], reports: [] };

  async function paypalInit() {
    try {
      const saved = await fetch('/api/connectors/paypal').then(r => r.json());
      if (saved.status === 'Connected') { paypalState.connected = true; }
    } catch {}
    paypalUpdateUI();
    await paypalLoadAccounts();
    await paypalLoadOverview();
  }

  function paypalUpdateUI() {
    const badge = document.getElementById('ppConnBadge');
    const btn   = document.getElementById('ppConnectBtn');
    if (paypalState.connected) {
      badge.textContent = 'Connected'; badge.className = 'badge bg-success ms-2';
      btn.textContent = 'Disconnect'; btn.style.background = '#dc3545'; btn.style.color = '#fff';
    } else {
      badge.textContent = 'Disconnected'; badge.className = 'badge bg-secondary ms-2';
      btn.textContent = 'Connect'; btn.style.background = '#0070BA'; btn.style.color = '#fff';
    }
  }

  async function paypalToggleConnect() {
    paypalState.connected = !paypalState.connected;
    paypalUpdateUI();
    try {
      await fetch('/api/connectors/paypal', {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ status: paypalState.connected ? 'Connected' : 'Disconnected' })
      });
    } catch {}
    if (paypalState.connected) { await paypalLoadAccounts(); await paypalLoadOverview(); }
    if (window.showToast) window.showToast('PayPal', paypalState.connected ? 'Connected to PayPal' : 'Disconnected from PayPal', paypalState.connected ? 'success' : 'warning');
  }

  async function paypalLoadAccounts() {
    try {
      paypalState.accounts = await fetch('/api/connectors/paypal/accounts').then(r => r.json());
      const sel = document.getElementById('ppAccountSelect');
      const val = sel.value;
      while (sel.options.length > 1) sel.remove(1);
      paypalState.accounts.forEach(a => {
        const opt = document.createElement('option');
        opt.value = a.email; opt.textContent = `${a.email} (${a.currency})`;
        sel.appendChild(opt);
      });
      sel.value = val || 'all';
    } catch {}
  }

  async function paypalLoadOverview() {
    const acc = document.getElementById('ppAccountSelect').value;
    try {
      paypalState.overview = await fetch(`/api/connectors/paypal/overview?account=${encodeURIComponent(acc)}`).then(r => r.json());
      paypalRenderOverview();
    } catch {}
  }

  function paypalRenderOverview() {
    const ov = paypalState.overview; if (!ov) return;
    const kpiRow = document.getElementById('ppKpiRow');
    kpiRow.innerHTML = ov.kpis.map(k => `
      <div class="col-md-3 col-lg-3">
        <div class="card bg-dark border-secondary h-100">
          <div class="card-body p-2 text-center">
            <div class="text-muted small">${k.label}</div>
            <div class="fs-5 fw-bold" style="color:#0070BA;">${k.value}</div>
            <small class="${k.trend==='up'?'text-success':k.trend==='down'?'text-danger':'text-muted'}">${k.change}</small>
          </div>
        </div>
      </div>`).join('');
    const tbody = document.getElementById('ppTrendBody');
    tbody.innerHTML = (ov.monthly_trend||[]).map(t => `
      <tr><td>${t.month}</td><td>${t.payments}</td><td>$${t.revenue.toLocaleString()}</td><td>$${t.fees.toLocaleString()}</td><td>$${t.payouts.toLocaleString()}</td><td>${t.disputes}</td></tr>`).join('');
  }

  async function paypalLoadTransactions() {
    const status = document.getElementById('ppTxnStatus').value;
    const ttype  = document.getElementById('ppTxnType').value;
    try {
      paypalState.transactions = await fetch(`/api/connectors/paypal/transactions?status=${status}&type=${ttype}`).then(r => r.json());
      paypalRenderTransactions();
    } catch {}
  }

  function paypalRenderTransactions() {
    const tbody = document.getElementById('ppTransactionsBody');
    tbody.innerHTML = paypalState.transactions.map(t => {
      const statusBadge = t.status === 'completed' ? 'success' : t.status === 'pending' ? 'warning' : 'danger';
      const typeBadge = t.type === 'sale' ? 'primary' : t.type === 'refund' ? 'warning' : 'info';
      const amtClass = t.amount >= 0 ? 'text-success' : 'text-danger';
      return `<tr>
        <td><code class="small">${t.id.substring(0,16)}…</code></td>
        <td><span class="badge bg-${typeBadge}">${t.type}</span></td>
        <td><span class="badge bg-${statusBadge}">${t.status}</span></td>
        <td class="${amtClass}">$${t.amount.toLocaleString(undefined,{minimumFractionDigits:2})}</td>
        <td>$${t.fee.toFixed(2)}</td>
        <td class="${amtClass}">$${t.net.toLocaleString(undefined,{minimumFractionDigits:2})}</td>
        <td>${t.payer}</td>
        <td title="${t.description}">${t.description.length > 30 ? t.description.substring(0,30)+'…' : t.description}</td>
        <td>${t.date}</td>
      </tr>`;
    }).join('');
  }

  async function paypalLoadPayouts() {
    const status = document.getElementById('ppPayoutStatus').value;
    try {
      paypalState.payouts = await fetch(`/api/connectors/paypal/payouts?status=${status}`).then(r => r.json());
      paypalRenderPayouts();
    } catch {}
  }

  function paypalRenderPayouts() {
    const tbody = document.getElementById('ppPayoutsBody');
    tbody.innerHTML = paypalState.payouts.map(p => {
      const statusBadge = p.status === 'completed' ? 'success' : 'warning';
      return `<tr>
        <td><code>${p.id}</code></td>
        <td>$${p.amount.toLocaleString(undefined,{minimumFractionDigits:2})}</td>
        <td>$${p.fee.toFixed(2)}</td>
        <td>${p.currency}</td>
        <td><span class="badge bg-${statusBadge}">${p.status}</span></td>
        <td>${p.bank}</td>
        <td><code>${p.batch_id}</code></td>
        <td>${p.date}</td>
      </tr>`;
    }).join('');
  }

  async function paypalLoadDisputes() {
    const status = document.getElementById('ppDisputeStatus').value;
    const reason = document.getElementById('ppDisputeReason').value;
    try {
      paypalState.disputes = await fetch(`/api/connectors/paypal/disputes?status=${status}&reason=${reason}`).then(r => r.json());
      paypalRenderDisputes();
    } catch {}
  }

  function paypalRenderDisputes() {
    const tbody = document.getElementById('ppDisputesBody');
    tbody.innerHTML = paypalState.disputes.map(d => {
      const statusMap = {'open':'danger','under_review':'warning','resolved_buyer':'info','resolved_seller':'success'};
      const badge = statusMap[d.status] || 'secondary';
      return `<tr>
        <td><code>${d.id}</code></td>
        <td>${d.reason.replace(/_/g,' ')}</td>
        <td><span class="badge bg-${badge}">${d.status.replace(/_/g,' ')}</span></td>
        <td class="text-danger">$${d.amount.toFixed(2)}</td>
        <td>${d.buyer}</td>
        <td><code class="small">${d.transaction.substring(0,16)}…</code></td>
        <td>${d.created}</td>
        <td>${d.respond_by}</td>
      </tr>`;
    }).join('');
  }

  async function paypalLoadReports() {
    try {
      paypalState.reports = await fetch('/api/connectors/paypal/reports').then(r => r.json());
      paypalRenderReports();
    } catch {}
  }

  function paypalRenderReports() {
    const tbody = document.getElementById('ppReportsBody');
    tbody.innerHTML = paypalState.reports.map(r => {
      const typeBadge = r.type === 'Transaction' ? 'primary' : r.type === 'Payout' ? 'info' : 'danger';
      const amtClass = r.amount >= 0 ? 'text-success' : 'text-danger';
      return `<tr>
        <td><span class="badge bg-${typeBadge}">${r.type}</span></td>
        <td title="${r.name}">${r.name.length > 30 ? r.name.substring(0,30)+'…' : r.name}</td>
        <td><span class="badge bg-${r.status==='completed'||r.status==='resolved_seller'?'success':r.status==='open'?'danger':'secondary'}">${r.status}</span></td>
        <td class="${amtClass}">$${r.amount.toLocaleString(undefined,{minimumFractionDigits:2})}</td>
        <td>$${r.fee.toFixed(2)}</td>
        <td class="${amtClass}">$${r.net.toLocaleString(undefined,{minimumFractionDigits:2})}</td>
        <td>${r.currency}</td>
        <td>${r.counterparty}</td>
        <td>${r.date}</td>
      </tr>`;
    }).join('');
  }

  function paypalExportTransactions() {
    downloadCSV('paypal_transactions.csv',
      ['ID','Type','Status','Amount','Fee','Net','Currency','Payer','Description','Date'],
      paypalState.transactions.map(t => [t.id,t.type,t.status,t.amount,t.fee,t.net,t.currency,t.payer,t.description,t.date]));
  }
  function paypalExportPayouts() {
    downloadCSV('paypal_payouts.csv',
      ['ID','Amount','Fee','Currency','Status','Bank','Batch','Date'],
      paypalState.payouts.map(p => [p.id,p.amount,p.fee,p.currency,p.status,p.bank,p.batch_id,p.date]));
  }
  function paypalExportDisputes() {
    downloadCSV('paypal_disputes.csv',
      ['ID','Reason','Status','Amount','Buyer','Transaction','Created','Respond By'],
      paypalState.disputes.map(d => [d.id,d.reason,d.status,d.amount,d.buyer,d.transaction,d.created,d.respond_by]));
  }
  function paypalExportReports() {
    downloadCSV('paypal_reports.csv',
      ['Type','Name','Status','Amount','Fee','Net','Currency','Counterparty','Date'],
      paypalState.reports.map(r => [r.type,r.name,r.status,r.amount,r.fee,r.net,r.currency,r.counterparty,r.date]));
  }

  async function paypalTestApiCall() {
    const endpoint = document.getElementById('ppTestEndpoint').value;
    const pre = document.getElementById('ppTestResult');
    pre.textContent = 'Calling PayPal API…';
    try {
      const res = await fetch('/api/connectors/paypal/test-call', {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ endpoint, method: 'GET' })
      });
      const data = await res.json();
      pre.textContent = JSON.stringify(data, null, 2);
    } catch (e) { pre.textContent = 'Error: ' + e.message; }
  }

  async function paypalSaveSettings() {
    const config = {
      client_id: document.getElementById('ppSettingsClientId').value,
      environment: document.getElementById('ppSettingsEnv').value,
      currency: document.getElementById('ppSettingsCurrency').value,
      webhook: document.getElementById('ppSettingsWebhook').value,
    };
    try {
      await fetch('/api/connectors/paypal', {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ status: paypalState.connected ? 'Connected' : 'Disconnected', config })
      });
      if (window.showToast) window.showToast('Settings Saved', 'PayPal settings updated.', 'success');
    } catch (e) {
      if (window.showToast) window.showToast('Error', 'Failed to save settings.', 'danger');
    }
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // NOTION ENGINE
  // ═══════════════════════════════════════════════════════════════════════════

  let notionState = { connected: false, workspaces: [], currentWorkspace: 'all' };

  async function notionInit() {
    // Load status
    try {
      const res = await fetch('/api/connectors');
      const s = await res.json();
      notionState.connected = (s['notion'] === 'Connected');
    } catch {}
    // Load workspaces
    await notionLoadWorkspaces();
    // Load overview
    await notionLoadOverview();
    // Load all tabs data
    await Promise.all([notionLoadPages(), notionLoadDatabases(), notionLoadBlocks(), notionLoadCollaborators(), notionLoadReports()]);
  }

  async function notionLoadWorkspaces() {
    try {
      const res = await fetch('/api/connectors/notion/workspaces');
      notionState.workspaces = await res.json();
      const sel = document.getElementById('notionWorkspaceFilter');
      sel.innerHTML = '<option value="all">All Workspaces</option>';
      notionState.workspaces.forEach(w => {
        sel.innerHTML += `<option value="${w.id}">${w.icon} ${w.name}</option>`;
      });
    } catch {}
  }

  async function notionLoadOverview() {
    const ws = document.getElementById('notionWorkspaceFilter').value;
    try {
      const res = await fetch(`/api/connectors/notion/overview?workspace=${ws}`);
      const d = await res.json();
      notionRenderOverview(d, ws);
    } catch {}
  }

  function notionRenderOverview(d, ws) {
    const kpis = [
      { label: 'Total Pages', value: (d.total_pages||0).toLocaleString(), color: 'text-success', icon: 'bi-file-earmark-text' },
      { label: 'Databases', value: (d.total_databases||0).toLocaleString(), color: 'text-info', icon: 'bi-table' },
      { label: 'Blocks', value: (d.total_blocks||0).toLocaleString(), color: 'text-primary', icon: 'bi-puzzle' },
      { label: 'Collaborators', value: (d.collaborators||0).toLocaleString(), color: 'text-warning', icon: 'bi-people' },
      { label: 'Integrations', value: (d.active_integrations||0).toLocaleString(), color: 'text-light', icon: 'bi-plug' },
      { label: 'API Calls Today', value: (d.api_calls_today||0).toLocaleString(), color: 'text-success', icon: 'bi-lightning' },
    ];
    document.getElementById('notionOverviewKPIs').innerHTML = kpis.map(k => `
      <div class="col-md-2 col-sm-4">
        <div class="card bg-dark border-secondary h-100">
          <div class="card-body text-center p-2">
            <i class="bi ${k.icon} ${k.color}" style="font-size:1.3rem;"></i>
            <div class="small text-muted mt-1">${k.label}</div>
            <div class="fw-bold ${k.color}" style="font-size:1.2rem;">${k.value}</div>
          </div>
        </div>
      </div>`).join('');

    // Trend chart (only for "all" workspace)
    let chartHtml = '';
    if (ws === 'all' && d.monthly_trend) {
      chartHtml = `<h6 class="text-light mt-3 mb-2">Pages Created (Monthly Trend)</h6>
        <div class="d-flex align-items-end gap-2" style="height:120px;">`;
      const maxVal = Math.max(...d.monthly_trend.map(t => t.pages_created));
      d.monthly_trend.forEach(t => {
        const h = maxVal > 0 ? Math.round((t.pages_created / maxVal) * 100) : 0;
        chartHtml += `<div class="text-center flex-fill">
          <div style="background:#000;height:${h}px;border-radius:4px 4px 0 0;border:1px solid #555;"></div>
          <div class="small text-muted mt-1">${t.month.slice(5)}</div>
          <div class="small text-light">${t.pages_created}</div>
        </div>`;
      });
      chartHtml += '</div>';
    }
    document.getElementById('notionOverviewChart').innerHTML = chartHtml;
  }

  // ── Pages ──
  async function notionLoadPages() {
    const status = document.getElementById('notionPagesStatus')?.value || '';
    const workspace = document.getElementById('notionPagesWorkspace')?.value || '';
    let url = '/api/connectors/notion/pages?';
    if (status) url += `status=${status}&`;
    if (workspace) url += `workspace=${encodeURIComponent(workspace)}&`;
    try {
      const res = await fetch(url);
      const pages = await res.json();
      notionRenderPages(pages);
    } catch {}
  }

  function notionRenderPages(pages) {
    if (!pages.length) { document.getElementById('notionPagesTable').innerHTML = '<p class="text-muted">No pages found.</p>'; return; }
    let html = `<table class="table table-dark table-striped table-sm"><thead><tr>
      <th>Icon</th><th>Title</th><th>Workspace</th><th>Parent</th><th>Status</th><th>Author</th><th>Last Edited</th>
    </tr></thead><tbody>`;
    pages.forEach(p => {
      const badge = p.status === 'shared' ? 'bg-success' : 'bg-secondary';
      html += `<tr><td>${p.icon}</td><td>${p.title}</td><td>${p.workspace}</td><td>${p.parent}</td>
        <td><span class="badge ${badge}">${p.status}</span></td><td>${p.author}</td><td>${p.last_edited}</td></tr>`;
    });
    html += '</tbody></table>';
    document.getElementById('notionPagesTable').innerHTML = html;
  }

  function notionExportPages() {
    const table = document.querySelector('#notionPagesTable table');
    if (!table) return;
    const rows = []; table.querySelectorAll('tr').forEach(tr => {
      const cells = []; tr.querySelectorAll('th,td').forEach(td => cells.push(td.textContent.trim()));
      rows.push(cells);
    });
    downloadCSV('notion_pages.csv', rows[0], rows.slice(1));
  }

  // ── Databases ──
  async function notionLoadDatabases() {
    const dbType = document.getElementById('notionDbType')?.value || '';
    let url = '/api/connectors/notion/databases?';
    if (dbType) url += `type=${dbType}&`;
    try {
      const res = await fetch(url);
      const dbs = await res.json();
      notionRenderDatabases(dbs);
    } catch {}
  }

  function notionRenderDatabases(dbs) {
    if (!dbs.length) { document.getElementById('notionDbTable').innerHTML = '<p class="text-muted">No databases found.</p>'; return; }
    let html = `<table class="table table-dark table-striped table-sm"><thead><tr>
      <th>Title</th><th>Workspace</th><th>Type</th><th>Items</th><th>Properties</th><th>Last Edited</th>
    </tr></thead><tbody>`;
    const typeBadge = { kanban: 'bg-primary', table: 'bg-info', board: 'bg-warning', calendar: 'bg-success', list: 'bg-secondary', gallery: 'bg-danger' };
    dbs.forEach(d => {
      html += `<tr><td>${d.title}</td><td>${d.workspace}</td>
        <td><span class="badge ${typeBadge[d.type]||'bg-secondary'}">${d.type}</span></td>
        <td>${d.items}</td><td class="small">${d.properties.join(', ')}</td><td>${d.last_edited}</td></tr>`;
    });
    html += '</tbody></table>';
    document.getElementById('notionDbTable').innerHTML = html;
  }

  function notionExportDatabases() {
    const table = document.querySelector('#notionDbTable table');
    if (!table) return;
    const rows = []; table.querySelectorAll('tr').forEach(tr => {
      const cells = []; tr.querySelectorAll('th,td').forEach(td => cells.push(td.textContent.trim()));
      rows.push(cells);
    });
    downloadCSV('notion_databases.csv', rows[0], rows.slice(1));
  }

  // ── Blocks ──
  async function notionLoadBlocks() {
    const blockType = document.getElementById('notionBlockType')?.value || '';
    const query = document.getElementById('notionBlockSearch')?.value || '';
    let url = '/api/connectors/notion/blocks?';
    if (blockType) url += `type=${blockType}&`;
    if (query) url += `q=${encodeURIComponent(query)}&`;
    try {
      const res = await fetch(url);
      const blocks = await res.json();
      notionRenderBlocks(blocks);
    } catch {}
  }

  function notionRenderBlocks(blocks) {
    if (!blocks.length) { document.getElementById('notionBlocksTable').innerHTML = '<p class="text-muted">No blocks found.</p>'; return; }
    let html = `<table class="table table-dark table-striped table-sm"><thead><tr>
      <th>Type</th><th>Page</th><th>Content</th><th>Last Edited</th>
    </tr></thead><tbody>`;
    const typeColor = { heading_1: 'text-warning', heading_2: 'text-info', heading_3: 'text-primary',
      to_do: 'text-success', paragraph: 'text-light', callout: 'text-danger', code: 'text-info',
      quote: 'text-muted', toggle: 'text-light', bulleted_list_item: 'text-light', table_row: 'text-light' };
    blocks.forEach(b => {
      html += `<tr><td><span class="${typeColor[b.type]||'text-light'}">${b.type.replace(/_/g,' ')}</span></td>
        <td>${b.page}</td><td class="small">${b.content}</td><td>${b.last_edited}</td></tr>`;
    });
    html += '</tbody></table>';
    document.getElementById('notionBlocksTable').innerHTML = html;
  }

  function notionExportBlocks() {
    const table = document.querySelector('#notionBlocksTable table');
    if (!table) return;
    const rows = []; table.querySelectorAll('tr').forEach(tr => {
      const cells = []; tr.querySelectorAll('th,td').forEach(td => cells.push(td.textContent.trim()));
      rows.push(cells);
    });
    downloadCSV('notion_blocks.csv', rows[0], rows.slice(1));
  }

  // ── Collaborators ──
  async function notionLoadCollaborators() {
    const role = document.getElementById('notionCollabRole')?.value || '';
    let url = '/api/connectors/notion/collaborators?';
    if (role) url += `role=${role}&`;
    try {
      const res = await fetch(url);
      const collabs = await res.json();
      notionRenderCollaborators(collabs);
    } catch {}
  }

  function notionRenderCollaborators(collabs) {
    if (!collabs.length) { document.getElementById('notionCollabTable').innerHTML = '<p class="text-muted">No collaborators found.</p>'; return; }
    let html = `<table class="table table-dark table-striped table-sm"><thead><tr>
      <th></th><th>Name</th><th>Email</th><th>Role</th><th>Pages Edited</th><th>Last Active</th>
    </tr></thead><tbody>`;
    const roleBadge = { Admin: 'bg-danger', Member: 'bg-primary', Guest: 'bg-secondary' };
    collabs.forEach(c => {
      html += `<tr>
        <td><span class="badge bg-dark border border-secondary" style="font-size:.75rem;">${c.avatar}</span></td>
        <td>${c.name}</td><td class="small">${c.email}</td>
        <td><span class="badge ${roleBadge[c.role]||'bg-secondary'}">${c.role}</span></td>
        <td>${c.pages_edited}</td><td>${c.last_active}</td></tr>`;
    });
    html += '</tbody></table>';
    document.getElementById('notionCollabTable').innerHTML = html;
  }

  function notionExportCollaborators() {
    const table = document.querySelector('#notionCollabTable table');
    if (!table) return;
    const rows = []; table.querySelectorAll('tr').forEach(tr => {
      const cells = []; tr.querySelectorAll('th,td').forEach(td => cells.push(td.textContent.trim()));
      rows.push(cells);
    });
    downloadCSV('notion_collaborators.csv', rows[0], rows.slice(1));
  }

  // ── Reports ──
  async function notionLoadReports() {
    try {
      const res = await fetch('/api/connectors/notion/reports');
      const rows = await res.json();
      notionRenderReports(rows);
    } catch {}
  }

  function notionRenderReports(rows) {
    if (!rows.length) { document.getElementById('notionReportsTable').innerHTML = '<p class="text-muted">No data.</p>'; return; }
    let html = `<table class="table table-dark table-striped table-sm"><thead><tr>
      <th>Type</th><th>Title</th><th>Workspace</th><th>Detail</th><th>Date</th><th>Author</th>
    </tr></thead><tbody>`;
    const typeBadge = { Page: 'bg-success', Database: 'bg-info', Block: 'bg-warning' };
    rows.forEach(r => {
      html += `<tr><td><span class="badge ${typeBadge[r.type]||'bg-secondary'}">${r.type}</span></td>
        <td>${r.title}</td><td>${r.workspace}</td><td class="small">${r.detail}</td><td>${r.date}</td><td>${r.author}</td></tr>`;
    });
    html += '</tbody></table>';
    document.getElementById('notionReportsTable').innerHTML = html;
  }

  function notionExportReports() {
    const table = document.querySelector('#notionReportsTable table');
    if (!table) return;
    const rows = []; table.querySelectorAll('tr').forEach(tr => {
      const cells = []; tr.querySelectorAll('th,td').forEach(td => cells.push(td.textContent.trim()));
      rows.push(cells);
    });
    downloadCSV('notion_reports.csv', rows[0], rows.slice(1));
  }

  // ── Test API ──
  async function notionTestApiCall(endpoint) {
    document.getElementById('notionTestResult').textContent = `Calling Notion API /v1/${endpoint}…`;
    try {
      const res = await fetch('/api/connectors/notion/test-call', {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ endpoint, method: 'GET' })
      });
      const data = await res.json();
      document.getElementById('notionTestResult').textContent = JSON.stringify(data, null, 2);
    } catch (e) {
      document.getElementById('notionTestResult').textContent = 'Error: ' + e.message;
    }
  }

  // ── Settings ──
  async function notionSaveSettings() {
    const config = {
      token: document.getElementById('ntSettingsToken').value,
      api_version: document.getElementById('ntSettingsVersion').value,
      default_workspace: document.getElementById('ntSettingsWorkspace').value,
      sync_frequency: document.getElementById('ntSettingsSync').value,
      webhook: document.getElementById('ntSettingsWebhook').value,
    };
    try {
      await fetch('/api/connectors/notion', {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ status: notionState.connected ? 'Connected' : 'Disconnected', config })
      });
      if (window.showToast) window.showToast('Settings Saved', 'Notion settings updated.', 'success');
    } catch (e) {
      if (window.showToast) window.showToast('Error', 'Failed to save settings.', 'danger');
    }
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // GITHUB ENGINE
  // ═══════════════════════════════════════════════════════════════════════════

  let ghState = { connected: false, accounts: [], repos: [] };

  async function ghInit() {
    try {
      const res = await fetch('/api/connectors');
      const s = await res.json();
      ghState.connected = (s['github'] === 'Connected');
    } catch {}
    await ghLoadAccounts();
    await ghLoadOverview();
    await Promise.all([ghLoadRepos(), ghLoadCommits(), ghLoadIssues(), ghLoadActions(), ghLoadReports()]);
  }

  async function ghLoadAccounts() {
    try {
      const res = await fetch('/api/connectors/github/accounts');
      ghState.accounts = await res.json();
      // populate overview filter
      const sel = document.getElementById('ghAccountFilter');
      sel.innerHTML = '<option value="all">All Accounts</option>';
      ghState.accounts.forEach(a => {
        const icon = a.type === 'Organization' ? '🏢' : '👤';
        sel.innerHTML += `<option value="${a.id}">${icon} ${a.name} (${a.login})</option>`;
      });
    } catch {}
  }

  // ── Overview ──
  async function ghLoadOverview() {
    const acct = document.getElementById('ghAccountFilter').value;
    try {
      const res = await fetch(`/api/connectors/github/overview?account=${acct}`);
      const d = await res.json();
      ghRenderOverview(d, acct);
    } catch {}
  }

  function ghRenderOverview(d, acct) {
    const kpis = [
      { label: 'Repositories', value: (d.total_repos||0).toLocaleString(), color: 'text-light', icon: 'bi-folder' },
      { label: 'Stars', value: (d.total_stars||0).toLocaleString(), color: 'text-warning', icon: 'bi-star-fill' },
      { label: 'Forks', value: (d.total_forks||0).toLocaleString(), color: 'text-info', icon: 'bi-diagram-2' },
      { label: 'Open Issues', value: (d.open_issues||0).toLocaleString(), color: 'text-danger', icon: 'bi-exclamation-circle' },
      { label: 'Open PRs', value: (d.open_prs||0).toLocaleString(), color: 'text-success', icon: 'bi-arrow-left-right' },
      { label: 'Commits (30d)', value: (d.total_commits_30d||0).toLocaleString(), color: 'text-primary', icon: 'bi-git' },
      { label: 'Contributors', value: (d.contributors||0).toLocaleString(), color: 'text-light', icon: 'bi-people' },
      { label: 'Action Runs (30d)', value: (d.actions_runs_30d||0).toLocaleString(), color: 'text-success', icon: 'bi-play-circle' },
    ];
    document.getElementById('ghOverviewKPIs').innerHTML = kpis.map(k => `
      <div class="col-lg-3 col-md-4 col-sm-6">
        <div class="card bg-dark border-secondary h-100">
          <div class="card-body text-center p-2">
            <i class="bi ${k.icon} ${k.color}" style="font-size:1.3rem;"></i>
            <div class="small text-muted mt-1">${k.label}</div>
            <div class="fw-bold ${k.color}" style="font-size:1.2rem;">${k.value}</div>
          </div>
        </div>
      </div>`).join('');

    let chartHtml = '';
    if (acct === 'all' && d.weekly_commits) {
      chartHtml = `<h6 class="text-light mt-3 mb-2">Commits Per Week</h6>
        <div class="d-flex align-items-end gap-2" style="height:120px;">`;
      const maxVal = Math.max(...d.weekly_commits.map(w => w.commits));
      d.weekly_commits.forEach(w => {
        const h = maxVal > 0 ? Math.round((w.commits / maxVal) * 100) : 0;
        chartHtml += `<div class="text-center flex-fill">
          <div style="background:#238636;height:${h}px;border-radius:4px 4px 0 0;"></div>
          <div class="small text-muted mt-1">${w.week.slice(5)}</div>
          <div class="small text-light">${w.commits}</div>
        </div>`;
      });
      chartHtml += '</div>';
    }
    document.getElementById('ghOverviewChart').innerHTML = chartHtml;
  }

  // ── Repositories ──
  async function ghLoadRepos() {
    const vis = document.getElementById('ghRepoVisibility')?.value || '';
    const lang = document.getElementById('ghRepoLanguage')?.value || '';
    let url = '/api/connectors/github/repos?';
    if (vis) url += `visibility=${vis}&`;
    if (lang) url += `language=${encodeURIComponent(lang)}&`;
    try {
      const res = await fetch(url);
      const repos = await res.json();
      ghState.repos = repos;
      ghRenderRepos(repos);
      // populate commit/action repo filters
      const repoNames = [...new Set(repos.map(r => r.name))];
      ['ghCommitRepo', 'ghActionRepo'].forEach(selId => {
        const sel = document.getElementById(selId);
        if (!sel) return;
        const prev = sel.value;
        sel.innerHTML = '<option value="">All Repos</option>';
        repoNames.forEach(n => sel.innerHTML += `<option value="${n}">${n}</option>`);
        sel.value = prev;
      });
      // populate author filter
      const authors = [...new Set((await (await fetch('/api/connectors/github/commits')).json()).map(c => c.author))];
      const authSel = document.getElementById('ghCommitAuthor');
      if (authSel) {
        authSel.innerHTML = '<option value="">All Authors</option>';
        authors.forEach(a => authSel.innerHTML += `<option value="${a}">${a}</option>`);
      }
    } catch {}
  }

  function ghRenderRepos(repos) {
    if (!repos.length) { document.getElementById('ghReposTable').innerHTML = '<p class="text-muted">No repositories found.</p>'; return; }
    let html = `<table class="table table-dark table-striped table-sm"><thead><tr>
      <th>Name</th><th>Owner</th><th>Language</th><th>⭐</th><th>🍴</th><th>Issues</th><th>Visibility</th><th>Last Push</th>
    </tr></thead><tbody>`;
    const langColors = { Python: '#3572A5', TypeScript: '#3178C6', Go: '#00ADD8', Rust: '#DEA584',
      Dart: '#00B4AB', HCL: '#844FBA', YAML: '#CB171E', SQL: '#E38C00', Shell: '#89E051', MDX: '#FCB32C' };
    repos.forEach(r => {
      const dot = `<span style="color:${langColors[r.language]||'#ccc'};">●</span>`;
      const visBadge = r.visibility === 'public' ? '<span class="badge bg-success">public</span>' : '<span class="badge bg-secondary">private</span>';
      html += `<tr><td><strong>${r.name}</strong></td><td>${r.owner}</td><td>${dot} ${r.language}</td>
        <td>${r.stars}</td><td>${r.forks}</td><td>${r.open_issues}</td><td>${visBadge}</td><td>${r.last_push}</td></tr>`;
    });
    html += '</tbody></table>';
    document.getElementById('ghReposTable').innerHTML = html;
  }

  function ghExportRepos() {
    const t = document.querySelector('#ghReposTable table');
    if (!t) return;
    const rows = []; t.querySelectorAll('tr').forEach(tr => { const c = []; tr.querySelectorAll('th,td').forEach(td => c.push(td.textContent.trim())); rows.push(c); });
    downloadCSV('github_repos.csv', rows[0], rows.slice(1));
  }

  // ── Commits ──
  async function ghLoadCommits() {
    const repo = document.getElementById('ghCommitRepo')?.value || '';
    const author = document.getElementById('ghCommitAuthor')?.value || '';
    let url = '/api/connectors/github/commits?';
    if (repo) url += `repo=${encodeURIComponent(repo)}&`;
    if (author) url += `author=${encodeURIComponent(author)}&`;
    try {
      const res = await fetch(url);
      const commits = await res.json();
      ghRenderCommits(commits);
    } catch {}
  }

  function ghRenderCommits(commits) {
    if (!commits.length) { document.getElementById('ghCommitsTable').innerHTML = '<p class="text-muted">No commits found.</p>'; return; }
    let html = `<table class="table table-dark table-striped table-sm"><thead><tr>
      <th>SHA</th><th>Repo</th><th>Author</th><th>Message</th><th>+/-</th><th>Files</th><th>Date</th>
    </tr></thead><tbody>`;
    commits.forEach(c => {
      html += `<tr><td><code class="text-info">${c.sha}</code></td><td>${c.repo}</td><td>${c.author}</td>
        <td class="small">${c.message}</td>
        <td><span class="text-success">+${c.additions}</span> <span class="text-danger">-${c.deletions}</span></td>
        <td>${c.files_changed}</td><td>${c.date.slice(0,10)}</td></tr>`;
    });
    html += '</tbody></table>';
    document.getElementById('ghCommitsTable').innerHTML = html;
  }

  function ghExportCommits() {
    const t = document.querySelector('#ghCommitsTable table');
    if (!t) return;
    const rows = []; t.querySelectorAll('tr').forEach(tr => { const c = []; tr.querySelectorAll('th,td').forEach(td => c.push(td.textContent.trim())); rows.push(c); });
    downloadCSV('github_commits.csv', rows[0], rows.slice(1));
  }

  // ── Issues & PRs ──
  async function ghLoadIssues() {
    const state = document.getElementById('ghIssueState')?.value || '';
    const kind = document.getElementById('ghIssueKind')?.value || '';
    let url = '/api/connectors/github/issues?';
    if (state) url += `state=${state}&`;
    if (kind) url += `kind=${kind}&`;
    try {
      const res = await fetch(url);
      const issues = await res.json();
      ghRenderIssues(issues);
    } catch {}
  }

  function ghRenderIssues(issues) {
    if (!issues.length) { document.getElementById('ghIssuesTable').innerHTML = '<p class="text-muted">No issues/PRs found.</p>'; return; }
    let html = `<table class="table table-dark table-striped table-sm"><thead><tr>
      <th>#</th><th>Type</th><th>Repo</th><th>Title</th><th>State</th><th>Labels</th><th>Assignee</th><th>Comments</th><th>Updated</th>
    </tr></thead><tbody>`;
    issues.forEach(i => {
      const typeIcon = i.kind === 'pr' ? '<span class="text-success"><i class="bi bi-arrow-left-right"></i> PR</span>' : '<span class="text-warning"><i class="bi bi-circle-fill"></i> Issue</span>';
      const stateBadge = i.state === 'open' ? '<span class="badge bg-success">open</span>' : '<span class="badge bg-danger">closed</span>';
      const labels = i.labels.map(l => `<span class="badge bg-secondary me-1">${l}</span>`).join('');
      html += `<tr><td>${i.number}</td><td>${typeIcon}</td><td>${i.repo}</td><td class="small">${i.title}</td>
        <td>${stateBadge}</td><td>${labels}</td><td>${i.assignee}</td><td>${i.comments}</td><td>${i.updated}</td></tr>`;
    });
    html += '</tbody></table>';
    document.getElementById('ghIssuesTable').innerHTML = html;
  }

  function ghExportIssues() {
    const t = document.querySelector('#ghIssuesTable table');
    if (!t) return;
    const rows = []; t.querySelectorAll('tr').forEach(tr => { const c = []; tr.querySelectorAll('th,td').forEach(td => c.push(td.textContent.trim())); rows.push(c); });
    downloadCSV('github_issues.csv', rows[0], rows.slice(1));
  }

  // ── Actions ──
  async function ghLoadActions() {
    const conclusion = document.getElementById('ghActionConclusion')?.value || '';
    const repo = document.getElementById('ghActionRepo')?.value || '';
    let url = '/api/connectors/github/actions?';
    if (conclusion) url += `conclusion=${conclusion}&`;
    if (repo) url += `repo=${encodeURIComponent(repo)}&`;
    try {
      const res = await fetch(url);
      const actions = await res.json();
      ghRenderActions(actions);
    } catch {}
  }

  function ghRenderActions(actions) {
    if (!actions.length) { document.getElementById('ghActionsTable').innerHTML = '<p class="text-muted">No workflow runs found.</p>'; return; }
    let html = `<table class="table table-dark table-striped table-sm"><thead><tr>
      <th>Workflow</th><th>Repo</th><th>Branch</th><th>Event</th><th>Status</th><th>Duration</th><th>Started</th>
    </tr></thead><tbody>`;
    const conclusionBadge = { success: 'bg-success', failure: 'bg-danger', cancelled: 'bg-secondary' };
    actions.forEach(a => {
      const badge = a.conclusion ? `<span class="badge ${conclusionBadge[a.conclusion]||'bg-warning'}">${a.conclusion}</span>` : '<span class="badge bg-info">running</span>';
      const dur = a.duration_sec ? `${Math.floor(a.duration_sec/60)}m ${a.duration_sec%60}s` : '—';
      html += `<tr><td>${a.workflow}</td><td>${a.repo}</td><td><code>${a.branch}</code></td>
        <td>${a.event}</td><td>${badge}</td><td>${dur}</td><td>${a.started.slice(0,10)}</td></tr>`;
    });
    html += '</tbody></table>';
    document.getElementById('ghActionsTable').innerHTML = html;
  }

  function ghExportActions() {
    const t = document.querySelector('#ghActionsTable table');
    if (!t) return;
    const rows = []; t.querySelectorAll('tr').forEach(tr => { const c = []; tr.querySelectorAll('th,td').forEach(td => c.push(td.textContent.trim())); rows.push(c); });
    downloadCSV('github_actions.csv', rows[0], rows.slice(1));
  }

  // ── Reports ──
  async function ghLoadReports() {
    try {
      const res = await fetch('/api/connectors/github/reports');
      const rows = await res.json();
      ghRenderReports(rows);
    } catch {}
  }

  function ghRenderReports(rows) {
    if (!rows.length) { document.getElementById('ghReportsTable').innerHTML = '<p class="text-muted">No data.</p>'; return; }
    let html = `<table class="table table-dark table-striped table-sm"><thead><tr>
      <th>Type</th><th>Title</th><th>Detail</th><th>Status</th><th>Date</th>
    </tr></thead><tbody>`;
    const typeBadge = { Repository: 'bg-primary', Commit: 'bg-info', Issue: 'bg-warning', PR: 'bg-success', Action: 'bg-secondary' };
    rows.forEach(r => {
      html += `<tr><td><span class="badge ${typeBadge[r.type]||'bg-secondary'}">${r.type}</span></td>
        <td>${r.title}</td><td class="small">${r.detail}</td><td>${r.status}</td><td>${r.date}</td></tr>`;
    });
    html += '</tbody></table>';
    document.getElementById('ghReportsTable').innerHTML = html;
  }

  function ghExportReports() {
    const t = document.querySelector('#ghReportsTable table');
    if (!t) return;
    const rows = []; t.querySelectorAll('tr').forEach(tr => { const c = []; tr.querySelectorAll('th,td').forEach(td => c.push(td.textContent.trim())); rows.push(c); });
    downloadCSV('github_reports.csv', rows[0], rows.slice(1));
  }

  // ── Test API ──
  async function ghTestApiCall(endpoint) {
    document.getElementById('ghTestResult').textContent = `Calling GitHub API /${endpoint}…`;
    try {
      const res = await fetch('/api/connectors/github/test-call', {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ endpoint, method: 'GET' })
      });
      const data = await res.json();
      document.getElementById('ghTestResult').textContent = JSON.stringify(data, null, 2);
    } catch (e) {
      document.getElementById('ghTestResult').textContent = 'Error: ' + e.message;
    }
  }

  // ── Settings ──
  async function ghSaveSettings() {
    const evtSel = document.getElementById('ghSettingsEvents');
    const events = [...evtSel.selectedOptions].map(o => o.value);
    const config = {
      token: document.getElementById('ghSettingsToken').value,
      api_version: document.getElementById('ghSettingsVersion').value,
      default_org: document.getElementById('ghSettingsOrg').value,
      webhook_events: events,
      webhook: document.getElementById('ghSettingsWebhook').value,
    };
    try {
      await fetch('/api/connectors/github', {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ status: ghState.connected ? 'Connected' : 'Disconnected', config })
      });
      if (window.showToast) window.showToast('Settings Saved', 'GitHub settings updated.', 'success');
    } catch (e) {
      if (window.showToast) window.showToast('Error', 'Failed to save settings.', 'danger');
    }
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // TODOIST JS ENGINE
  // ═══════════════════════════════════════════════════════════════════════════
  let tdState = { connected: false, projects: [], labels: [] };

  async function tdInit() {
    tdState.connected = JSON.parse(localStorage.getItem('connector_statuses') || '{}')['todoist'] || false;
    await tdLoadProjects();
    await tdLoadLabels();
    tdPopulateFilters();
    tdLoadOverview();
    tdLoadTasks();
    tdLoadProjectsDetail();
    tdLoadHabits();
    tdLoadReports();
  }

  async function tdLoadProjects() {
    try {
      const r = await fetch('/api/connectors/todoist/projects');
      tdState.projects = await r.json();
    } catch(e) { tdState.projects = []; }
  }

  async function tdLoadLabels() {
    try {
      const search = (document.getElementById('tdLabelSearch')?.value || '').trim();
      const url = '/api/connectors/todoist/labels' + (search ? `?search=${encodeURIComponent(search)}` : '');
      const r = await fetch(url);
      const data = await r.json();
      tdState.labels = data;
      tdRenderLabels(data);
    } catch(e) { tdState.labels = []; }
  }

  function tdPopulateFilters() {
    // Overview project filter
    const ovSel = document.getElementById('tdOverviewProject');
    if (ovSel) {
      ovSel.innerHTML = '<option value="">All Projects</option>' +
        tdState.projects.map(p => `<option value="${p.name}">${p.name}</option>`).join('');
    }
    // Tasks project filter
    const tpSel = document.getElementById('tdTaskProject');
    if (tpSel) {
      tpSel.innerHTML = '<option value="">All Projects</option>' +
        tdState.projects.map(p => `<option value="${p.name}">${p.name}</option>`).join('');
    }
    // Tasks label filter
    const tlSel = document.getElementById('tdTaskLabel');
    if (tlSel) {
      tlSel.innerHTML = '<option value="">All Labels</option>' +
        tdState.labels.map(l => `<option value="${l.name}">${l.name}</option>`).join('');
    }
  }

  // ── Overview ──
  async function tdLoadOverview() {
    const proj = document.getElementById('tdOverviewProject')?.value || '';
    const url = '/api/connectors/todoist/overview' + (proj ? `?project=${encodeURIComponent(proj)}` : '');
    try {
      const r = await fetch(url);
      if (!r.ok) return;
      const data = await r.json();
      tdRenderOverview(data);
    } catch(e) {}
  }

  function tdRenderOverview(data) {
    const k = data.kpis;
    const kpis = [
      { label: 'Tasks Today',       value: k.tasks_today,         color: '#E44332' },
      { label: 'Overdue',           value: k.overdue,             color: '#dc3545' },
      { label: 'Completed (Week)',  value: k.completed_this_week, color: '#198754' },
      { label: 'Streak',            value: k.productivity_streak + 'd', color: '#ffc107' },
      { label: 'Open Tasks',        value: k.open_tasks,          color: '#0dcaf0' },
      { label: 'Total Completed',   value: k.completed_total,     color: '#6f42c1' },
      { label: 'Completion Rate',   value: k.avg_completion_rate + '%', color: '#20c997' },
      { label: 'Recurring Active',  value: k.recurring_active,    color: '#fd7e14' },
    ];
    document.getElementById('tdKpiCards').innerHTML = kpis.map(kp => `
      <div class="col-md-3 col-6"><div class="card bg-dark border-secondary h-100"><div class="card-body text-center">
        <small class="text-muted">${kp.label}</small><h4 style="color:${kp.color}">${kp.value}</h4>
      </div></div></div>`).join('');

    // Daily chart
    const days = data.daily_completed || [];
    const max = Math.max(...days.map(d => d.count), 1);
    document.getElementById('tdDailyChart').innerHTML = days.map(d => {
      const h = Math.max((d.count / max) * 100, 4);
      return `<div class="text-center flex-fill"><div style="height:${h}px;background:#E44332;border-radius:4px 4px 0 0;" title="${d.count} tasks"></div><small class="text-muted">${d.day}</small></div>`;
    }).join('');

    // Project stats
    const ps = data.project_stats || [];
    document.getElementById('tdProjectStats').innerHTML = ps.length ? `
      <h6>Per-Project Breakdown</h6>
      <table class="table table-dark table-sm table-striped"><thead><tr><th>Project</th><th>Open</th><th>Completed</th><th>Overdue</th></tr></thead>
      <tbody>${ps.map(p => `<tr><td>${p.project}</td><td>${p.open}</td><td class="text-success">${p.completed}</td><td class="text-danger">${p.overdue}</td></tr>`).join('')}</tbody></table>` : '';
  }

  // ── Tasks ──
  async function tdLoadTasks() {
    const params = new URLSearchParams();
    const st = document.getElementById('tdTaskStatus')?.value;   if (st) params.set('status', st);
    const pr = document.getElementById('tdTaskPriority')?.value; if (pr) params.set('priority', pr);
    const pj = document.getElementById('tdTaskProject')?.value;  if (pj) params.set('project', pj);
    const lb = document.getElementById('tdTaskLabel')?.value;    if (lb) params.set('label', lb);
    try {
      const r = await fetch('/api/connectors/todoist/tasks?' + params);
      const data = await r.json();
      tdRenderTasks(data);
    } catch(e) {}
  }

  function tdRenderTasks(rows) {
    const pColors = { 1: 'text-danger', 2: 'text-warning', 3: 'text-info', 4: 'text-muted' };
    document.getElementById('tdTasksBody').innerHTML = rows.map(t => `
      <tr>
        <td>${t.is_completed ? '<i class="bi bi-check-circle-fill text-success"></i>' : '<i class="bi bi-circle"></i>'} ${t.content}</td>
        <td class="${pColors[t.priority] || 'text-muted'}">P${t.priority}</td>
        <td>${t.project}</td>
        <td>${t.labels.map(l => `<span class="badge bg-secondary me-1">${l}</span>`).join('')}</td>
        <td>${t.due}</td>
        <td>${t.is_completed ? '<span class="badge bg-success">Done</span>' : '<span class="badge bg-warning text-dark">Open</span>'}</td>
        <td><small>${t.assignee}</small></td>
      </tr>`).join('') || '<tr><td colspan="7" class="text-muted text-center">No tasks match filters</td></tr>';
  }

  // ── Projects Detail ──
  async function tdLoadProjectsDetail() {
    try {
      const r = await fetch('/api/connectors/todoist/projects-detail');
      const data = await r.json();
      tdRenderProjectsDetail(data);
    } catch(e) {}
  }

  function tdRenderProjectsDetail(rows) {
    const colorMap = { berry_red: '#b8255f', blue: '#4073ff', green: '#299438', red: '#db4035', orange: '#ff9933', teal: '#158fad', violet: '#af38eb' };
    // Cards
    document.getElementById('tdProjectCards').innerHTML = rows.map(p => `
      <div class="col-md-4"><div class="card bg-dark border-secondary h-100"><div class="card-body">
        <h6><span style="display:inline-block;width:12px;height:12px;border-radius:50%;background:${colorMap[p.color] || '#888'};margin-right:6px;"></span>${p.name}</h6>
        <div class="d-flex justify-content-between">
          <span class="text-muted">Open <strong>${p.open_tasks}</strong></span>
          <span class="text-success">Done <strong>${p.completed_tasks}</strong></span>
          <span class="text-danger">Overdue <strong>${p.overdue_tasks}</strong></span>
        </div>
        <small class="text-muted mt-1 d-block">View: ${p.view_style} · ${p.task_count} total</small>
      </div></div></div>`).join('');
    // Table
    document.getElementById('tdProjectsBody').innerHTML = rows.map(p => `
      <tr>
        <td><span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${colorMap[p.color] || '#888'};margin-right:6px;"></span>${p.name}</td>
        <td>${p.view_style}</td>
        <td>${p.open_tasks}</td>
        <td class="text-success">${p.completed_tasks}</td>
        <td class="text-danger">${p.overdue_tasks}</td>
        <td>${(p.labels_used || []).map(l => `<span class="badge bg-secondary me-1">${l}</span>`).join('')}</td>
        <td>${p.color}</td>
      </tr>`).join('');
  }

  // ── Labels ──
  function tdRenderLabels(rows) {
    const colorMap = { red: '#db4035', blue: '#4073ff', green: '#299438', violet: '#af38eb', orange: '#ff9933', teal: '#158fad', charcoal: '#808080', magenta: '#e05194', yellow: '#fad000', lime_green: '#7ecc49' };
    document.getElementById('tdLabelsBody').innerHTML = rows.map(l => `
      <tr>
        <td><span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${colorMap[l.color] || '#888'};margin-right:6px;"></span>${l.name}</td>
        <td>${l.color}</td>
        <td>${l.task_count}</td>
        <td>${l.is_favorite ? '<i class="bi bi-star-fill text-warning"></i>' : '<i class="bi bi-star text-muted"></i>'}</td>
        <td>${l.order}</td>
      </tr>`).join('') || '<tr><td colspan="5" class="text-muted text-center">No labels match</td></tr>';
  }

  // ── Habits ──
  async function tdLoadHabits() {
    const freq = document.getElementById('tdHabitFreq')?.value || '';
    const url = '/api/connectors/todoist/habits' + (freq ? `?frequency=${freq}` : '');
    try {
      const r = await fetch(url);
      const data = await r.json();
      tdRenderHabits(data);
    } catch(e) {}
  }

  function tdRenderHabits(rows) {
    const streakColor = s => s >= 10 ? '#198754' : s >= 5 ? '#ffc107' : '#dc3545';
    // Cards
    document.getElementById('tdHabitCards').innerHTML = rows.map(h => `
      <div class="col-md-4 col-6"><div class="card bg-dark border-secondary h-100"><div class="card-body text-center">
        <h6>${h.content}</h6>
        <div style="font-size:2rem;color:${streakColor(h.streak)};">${h.streak}d</div>
        <small class="text-muted">${h.frequency} · Next: ${h.next_due}</small>
      </div></div></div>`).join('');
    // Table
    document.getElementById('tdHabitsBody').innerHTML = rows.map(h => `
      <tr>
        <td>${h.content}</td>
        <td><span class="badge bg-secondary">${h.frequency}</span></td>
        <td style="color:${streakColor(h.streak)};font-weight:bold;">${h.streak} days</td>
        <td>${h.last_done}</td>
        <td>${h.next_due}</td>
        <td>${h.project}</td>
        <td>${h.labels.map(l => `<span class="badge bg-secondary me-1">${l}</span>`).join('')}</td>
      </tr>`).join('') || '<tr><td colspan="7" class="text-muted text-center">No habits match</td></tr>';
  }

  // ── Reports ──
  async function tdLoadReports() {
    try {
      const r = await fetch('/api/connectors/todoist/reports');
      const data = await r.json();
      tdRenderReports(data);
    } catch(e) {}
  }

  function tdRenderReports(rows) {
    const typeIcon = { Task: 'bi-check2-square', Project: 'bi-folder', Label: 'bi-tag', Habit: 'bi-arrow-repeat' };
    const typeColor = { Task: '#E44332', Project: '#4073ff', Label: '#ffc107', Habit: '#198754' };
    document.getElementById('tdReportsBody').innerHTML = rows.map(r => `
      <tr>
        <td><i class="bi ${typeIcon[r.type] || 'bi-dot'}" style="color:${typeColor[r.type] || '#888'};"></i> ${r.type}</td>
        <td>${r.name}</td>
        <td>${r.project}</td>
        <td>${r.priority}</td>
        <td>${r.status}</td>
        <td>${r.due}</td>
        <td>${r.labels}</td>
      </tr>`).join('');
  }

  // ── Test API ──
  async function tdTestApiCall() {
    const ep = document.getElementById('tdTestEndpoint').value;
    const pre = document.getElementById('tdTestResult');
    pre.textContent = 'Calling Todoist API…';
    try {
      const r = await fetch('/api/connectors/todoist/test-call', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ endpoint: ep })
      });
      const data = await r.json();
      pre.textContent = JSON.stringify(data, null, 2);
    } catch(e) {
      pre.textContent = 'Error: ' + e.message;
    }
  }

  // ── Settings ──
  async function tdSaveSettings() {
    const config = {
      api_token: document.getElementById('tdApiToken')?.value,
      default_project: document.getElementById('tdDefaultProject')?.value,
      reminder_min: document.getElementById('tdReminderMin')?.value,
      sync_freq: document.getElementById('tdSyncFreq')?.value,
      theme: document.getElementById('tdTheme')?.value,
      auto_schedule: document.getElementById('tdAutoSchedule')?.checked,
    };
    try {
      await fetch('/api/connectors/todoist', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ status: tdState.connected ? 'Connected' : 'Disconnected', config })
      });
      if (window.showToast) window.showToast('Settings Saved', 'Todoist settings updated.', 'success');
    } catch(e) {
      if (window.showToast) window.showToast('Error', 'Failed to save settings.', 'danger');
    }
  }

  // ── CSV Exports ──
  function tdExportTasks()    { const rows = [...document.getElementById('tdTasksBody').querySelectorAll('tr')].map(r => [...r.cells].map(c => c.textContent.trim())); downloadCSV('todoist_tasks.csv', ['Task','Priority','Project','Labels','Due','Status','Assignee'], rows); }
  function tdExportProjects() { const rows = [...document.getElementById('tdProjectsBody').querySelectorAll('tr')].map(r => [...r.cells].map(c => c.textContent.trim())); downloadCSV('todoist_projects.csv', ['Project','View','Open','Completed','Overdue','Labels','Color'], rows); }
  function tdExportLabels()   { const rows = [...document.getElementById('tdLabelsBody').querySelectorAll('tr')].map(r => [...r.cells].map(c => c.textContent.trim())); downloadCSV('todoist_labels.csv', ['Label','Color','Tasks','Favorite','Order'], rows); }
  function tdExportHabits()   { const rows = [...document.getElementById('tdHabitsBody').querySelectorAll('tr')].map(r => [...r.cells].map(c => c.textContent.trim())); downloadCSV('todoist_habits.csv', ['Habit','Frequency','Streak','Last Done','Next Due','Project','Labels'], rows); }
  function tdExportReports()  { const rows = [...document.getElementById('tdReportsBody').querySelectorAll('tr')].map(r => [...r.cells].map(c => c.textContent.trim())); downloadCSV('todoist_reports.csv', ['Type','Name','Project','Priority','Status','Due','Labels'], rows); }

  // ═══════════════════════════════════════════════════════════════════════════
  // TELEGRAM JS ENGINE
  // ═══════════════════════════════════════════════════════════════════════════
  let tgState = { connected: false, chats: [] };

  async function tgInit() {
    tgState.connected = JSON.parse(localStorage.getItem('connector_statuses') || '{}')['telegram'] || false;
    await tgLoadChatsData();
    tgPopulateFilters();
    tgLoadOverview();
    tgLoadChats();
    tgLoadChannels();
    tgLoadBots();
    tgLoadMessages();
    tgLoadReports();
  }

  async function tgLoadChatsData() {
    try {
      const r = await fetch('/api/connectors/telegram/chats');
      tgState.chats = await r.json();
    } catch(e) { tgState.chats = []; }
  }

  function tgPopulateFilters() {
    const sel = document.getElementById('tgMsgChat');
    if (sel) {
      sel.innerHTML = '<option value="">All Chats</option>' +
        tgState.chats.map(c => `<option value="${c.title}">${c.title}</option>`).join('');
    }
  }

  // ── Overview ──
  async function tgLoadOverview() {
    try {
      const r = await fetch('/api/connectors/telegram/overview');
      const data = await r.json();
      tgRenderOverview(data);
    } catch(e) {}
  }

  function tgRenderOverview(data) {
    const k = data.kpis;
    const kpis = [
      { label: 'Messages Sent',      value: k.messages_sent.toLocaleString(),    color: '#0088cc' },
      { label: 'Messages Received',  value: k.messages_received.toLocaleString(), color: '#198754' },
      { label: 'Unread',             value: k.unread,                            color: '#ffc107' },
      { label: 'Active Chats',       value: k.active_chats,                      color: '#0dcaf0' },
      { label: 'Active Bots',        value: k.active_bots,                       color: '#6f42c1' },
      { label: 'Channels',           value: k.channels_subscribed,               color: '#fd7e14' },
    ];
    document.getElementById('tgKpiCards').innerHTML = kpis.map(kp => `
      <div class="col-md-2 col-4"><div class="card bg-dark border-secondary h-100"><div class="card-body text-center">
        <small class="text-muted">${kp.label}</small><h4 style="color:${kp.color}">${kp.value}</h4>
      </div></div></div>`).join('');

    // Daily chart — stacked bars
    const days = data.daily_messages || [];
    const max = Math.max(...days.map(d => d.sent + d.received), 1);
    document.getElementById('tgDailyChart').innerHTML = days.map(d => {
      const hS = Math.max((d.sent / max) * 100, 3);
      const hR = Math.max((d.received / max) * 100, 3);
      return `<div class="text-center flex-fill">
        <div style="height:${hS}px;background:#0088cc;border-radius:4px 4px 0 0;" title="Sent: ${d.sent}"></div>
        <div style="height:${hR}px;background:#198754;border-radius:0 0 4px 4px;" title="Recv: ${d.received}"></div>
        <small class="text-muted">${d.day}</small></div>`;
    }).join('');

    // Chat type breakdown
    const ct = data.chat_type_breakdown || {};
    document.getElementById('tgChatBreakdown').innerHTML = `
      <h6>Chat Types</h6>
      <div class="d-flex gap-3">
        <div class="p-3 bg-dark border border-secondary rounded text-center flex-fill"><small class="text-muted">Private</small><h4 class="text-info">${ct.private || 0}</h4></div>
        <div class="p-3 bg-dark border border-secondary rounded text-center flex-fill"><small class="text-muted">Group</small><h4 class="text-success">${ct.group || 0}</h4></div>
      </div>`;
  }

  // ── Chats ──
  async function tgLoadChats() {
    const t = document.getElementById('tgChatType')?.value || '';
    const url = '/api/connectors/telegram/chats' + (t ? `?type=${t}` : '');
    try {
      const r = await fetch(url);
      const data = await r.json();
      tgRenderChats(data);
    } catch(e) {}
  }

  function tgRenderChats(rows) {
    document.getElementById('tgChatsBody').innerHTML = rows.map(c => `
      <tr>
        <td>${c.pinned ? '<i class="bi bi-pin-fill text-warning me-1"></i>' : ''}${c.title}</td>
        <td><span class="badge ${c.type === 'private' ? 'bg-info' : 'bg-success'}">${c.type}</span></td>
        <td><small>${c.last_message}</small></td>
        <td><small class="text-muted">${new Date(c.last_time).toLocaleString()}</small></td>
        <td>${c.unread > 0 ? `<span class="badge bg-danger">${c.unread}</span>` : '<span class="text-muted">0</span>'}</td>
        <td>${c.pinned ? '<i class="bi bi-pin-fill text-warning"></i>' : ''}</td>
      </tr>`).join('') || '<tr><td colspan="6" class="text-muted text-center">No chats match</td></tr>';
  }

  // ── Channels ──
  async function tgLoadChannels() {
    const t = document.getElementById('tgChannelType')?.value || '';
    const url = '/api/connectors/telegram/channels' + (t ? `?type=${t}` : '');
    try {
      const r = await fetch(url);
      const data = await r.json();
      tgRenderChannels(data);
    } catch(e) {}
  }

  function tgRenderChannels(rows) {
    // Cards
    document.getElementById('tgChannelCards').innerHTML = rows.map(ch => `
      <div class="col-md-4"><div class="card bg-dark border-secondary h-100"><div class="card-body">
        <h6><i class="bi bi-megaphone-fill" style="color:#0088cc;"></i> ${ch.title}</h6>
        <div class="d-flex justify-content-between">
          <span class="text-muted">${ch.subscribers.toLocaleString()} subs</span>
          <span class="text-info">${ch.posts_today} posts today</span>
        </div>
        <small class="text-muted mt-1 d-block">${ch.username || 'Private'} · ${ch.type}</small>
      </div></div></div>`).join('');
    // Table
    document.getElementById('tgChannelsBody').innerHTML = rows.map(ch => `
      <tr>
        <td>${ch.title}</td>
        <td>${ch.username || '<span class="text-muted">—</span>'}</td>
        <td>${ch.subscribers.toLocaleString()}</td>
        <td>${ch.posts_today}</td>
        <td><small>${ch.last_post}</small></td>
        <td><span class="badge ${ch.type === 'public' ? 'bg-success' : 'bg-secondary'}">${ch.type}</span></td>
      </tr>`).join('');
  }

  // ── Bots ──
  async function tgLoadBots() {
    const s = document.getElementById('tgBotStatus')?.value || '';
    const url = '/api/connectors/telegram/bots' + (s ? `?status=${s}` : '');
    try {
      const r = await fetch(url);
      const data = await r.json();
      tgRenderBots(data);
    } catch(e) {}
  }

  function tgRenderBots(rows) {
    const statusColor = { active: '#198754', paused: '#ffc107' };
    // Cards
    document.getElementById('tgBotCards').innerHTML = rows.map(b => `
      <div class="col-md-4 col-6"><div class="card bg-dark border-secondary h-100"><div class="card-body text-center">
        <h6><i class="bi bi-robot" style="color:#0088cc;"></i> ${b.name}</h6>
        <span class="badge" style="background:${statusColor[b.status] || '#6c757d'}">${b.status}</span>
        <div class="mt-2"><small class="text-muted">${b.username} · ${b.messages_sent} msgs</small></div>
      </div></div></div>`).join('');
    // Table
    document.getElementById('tgBotsBody').innerHTML = rows.map(b => `
      <tr>
        <td>${b.name}</td>
        <td><code>${b.username}</code></td>
        <td><span class="badge" style="background:${statusColor[b.status] || '#6c757d'}">${b.status}</span></td>
        <td>${b.commands.map(c => `<code class="me-1">${c}</code>`).join('')}</td>
        <td>${b.messages_sent}</td>
        <td><small class="text-muted">${new Date(b.last_active).toLocaleString()}</small></td>
      </tr>`).join('') || '<tr><td colspan="6" class="text-muted text-center">No bots match</td></tr>';
  }

  // ── Messages ──
  async function tgLoadMessages() {
    const params = new URLSearchParams();
    const ch = document.getElementById('tgMsgChat')?.value;     if (ch) params.set('chat', ch);
    const sr = document.getElementById('tgMsgSearch')?.value;   if (sr) params.set('search', sr);
    const fr = document.getElementById('tgMsgFrom')?.value;     if (fr) params.set('from', fr);
    try {
      const r = await fetch('/api/connectors/telegram/messages?' + params);
      const data = await r.json();
      tgRenderMessages(data);
    } catch(e) {}
  }

  function tgRenderMessages(rows) {
    const typeIcon = { text: 'bi-chat-text', alert: 'bi-exclamation-triangle-fill text-warning' };
    document.getElementById('tgMessagesBody').innerHTML = rows.map(m => `
      <tr>
        <td>${m.chat}</td>
        <td>${m.from.startsWith('@') ? `<code>${m.from}</code>` : m.from}</td>
        <td><small>${m.text}</small></td>
        <td><i class="bi ${typeIcon[m.type] || 'bi-chat'}"></i> ${m.type}</td>
        <td><small class="text-muted">${new Date(m.date).toLocaleString()}</small></td>
      </tr>`).join('') || '<tr><td colspan="5" class="text-muted text-center">No messages match</td></tr>';
  }

  // ── Reports ──
  async function tgLoadReports() {
    try {
      const r = await fetch('/api/connectors/telegram/reports');
      const data = await r.json();
      tgRenderReports(data);
    } catch(e) {}
  }

  function tgRenderReports(rows) {
    const typeIcon = { Chat: 'bi-chat-dots', Channel: 'bi-megaphone', Bot: 'bi-robot', Message: 'bi-envelope' };
    const typeColor = { Chat: '#0088cc', Channel: '#fd7e14', Bot: '#6f42c1', Message: '#198754' };
    document.getElementById('tgReportsBody').innerHTML = rows.map(r => `
      <tr>
        <td><i class="bi ${typeIcon[r.type] || 'bi-dot'}" style="color:${typeColor[r.type] || '#888'};"></i> ${r.type}</td>
        <td>${r.name}</td>
        <td>${r.detail}</td>
        <td>${r.status}</td>
        <td><small class="text-muted">${new Date(r.last_activity).toLocaleString()}</small></td>
      </tr>`).join('');
  }

  // ── Test API ──
  async function tgTestApiCall() {
    const ep = document.getElementById('tgTestEndpoint').value;
    const pre = document.getElementById('tgTestResult');
    pre.textContent = 'Calling Telegram Bot API…';
    try {
      const r = await fetch('/api/connectors/telegram/test-call', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ endpoint: ep })
      });
      const data = await r.json();
      pre.textContent = JSON.stringify(data, null, 2);
    } catch(e) {
      pre.textContent = 'Error: ' + e.message;
    }
  }

  // ── Settings ──
  async function tgSaveSettings() {
    const config = {
      bot_token: document.getElementById('tgBotToken')?.value,
      default_chat: document.getElementById('tgDefaultChat')?.value,
      notifications: document.getElementById('tgNotifications')?.value,
      privacy: document.getElementById('tgPrivacy')?.value,
      theme: document.getElementById('tgTheme')?.value,
      auto_download: document.getElementById('tgAutoDownload')?.checked,
    };
    try {
      await fetch('/api/connectors/telegram', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ status: tgState.connected ? 'Connected' : 'Disconnected', config })
      });
      if (window.showToast) window.showToast('Settings Saved', 'Telegram settings updated.', 'success');
    } catch(e) {
      if (window.showToast) window.showToast('Error', 'Failed to save settings.', 'danger');
    }
  }

  // ── CSV Exports ──
  function tgExportChats()    { const rows = [...document.getElementById('tgChatsBody').querySelectorAll('tr')].map(r => [...r.cells].map(c => c.textContent.trim())); downloadCSV('telegram_chats.csv', ['Chat','Type','Last Message','Time','Unread','Pinned'], rows); }
  function tgExportChannels() { const rows = [...document.getElementById('tgChannelsBody').querySelectorAll('tr')].map(r => [...r.cells].map(c => c.textContent.trim())); downloadCSV('telegram_channels.csv', ['Channel','Username','Subscribers','Posts Today','Last Post','Type'], rows); }
  function tgExportBots()     { const rows = [...document.getElementById('tgBotsBody').querySelectorAll('tr')].map(r => [...r.cells].map(c => c.textContent.trim())); downloadCSV('telegram_bots.csv', ['Bot','Username','Status','Commands','Messages Sent','Last Active'], rows); }
  function tgExportMessages() { const rows = [...document.getElementById('tgMessagesBody').querySelectorAll('tr')].map(r => [...r.cells].map(c => c.textContent.trim())); downloadCSV('telegram_messages.csv', ['Chat','From','Message','Type','Date'], rows); }
  function tgExportReports()  { const rows = [...document.getElementById('tgReportsBody').querySelectorAll('tr')].map(r => [...r.cells].map(c => c.textContent.trim())); downloadCSV('telegram_reports.csv', ['Type','Name','Detail','Status','Last Activity'], rows); }

  // ═══════════════════════════════════════════════════════════════════════════
  // AWS ENGINE  (Phase 29)
  // ═══════════════════════════════════════════════════════════════════════════
  let awsState = {};

  async function awsInit() {
    awsState = {};
    awsLoadOverview();
  }

  /* ── Overview ─────────────────────────────────────────────────────── */
  async function awsLoadOverview() {
    try {
      const r = await fetch('/api/connectors/aws/overview');
      const d = await r.json();
      awsState.overview = d;
      awsRenderOverview(d);
    } catch(e) { console.error('AWS overview error', e); }
  }

  function awsRenderOverview(d) {
    document.getElementById('awsKpiEc2').textContent = d.ec2_instances_total;
    document.getElementById('awsKpiRunning').textContent = d.ec2_instances_running;
    document.getElementById('awsKpiS3').textContent = d.s3_buckets;
    document.getElementById('awsKpiStorage').textContent = d.s3_total_storage_gb.toLocaleString() + ' GB';
    document.getElementById('awsKpiLambda').textContent = d.lambda_functions;
    document.getElementById('awsKpiCost').textContent = '$' + d.monthly_cost_current.toLocaleString();
    document.getElementById('awsKpiInvocations').textContent = d.lambda_invocations_30d.toLocaleString();
    document.getElementById('awsKpiIam').textContent = d.iam_users;
    document.getElementById('awsKpiAlarms').textContent = d.active_alarms;
    document.getElementById('awsKpiForecast').textContent = '$' + d.monthly_cost_forecast.toLocaleString();
    // Cost trend chart
    const ctx = document.getElementById('awsCostTrendChart');
    if (ctx && typeof Chart !== 'undefined') {
      if (awsState.costTrendChart) awsState.costTrendChart.destroy();
      awsState.costTrendChart = new Chart(ctx, { type: 'bar', data: { labels: d.monthly_cost_trend.map(m => m.month), datasets: [{ label: 'Monthly Cost ($)', data: d.monthly_cost_trend.map(m => m.cost), backgroundColor: '#FF9900', borderColor: '#FF9900', borderWidth: 1 }] }, options: { responsive: true, plugins: { legend: { labels: { color: '#ccc' } } }, scales: { x: { ticks: { color: '#999' } }, y: { ticks: { color: '#999', callback: v => '$'+v.toLocaleString() } } } } });
    }
    // Service breakdown
    let html = '<div class="row g-2">';
    d.service_breakdown.forEach(s => {
      const colors = {'EC2':'#FF9900','S3':'#569A31','Lambda':'#D86613','RDS':'#3B48CC','CloudFront':'#8C4FFF','Other':'#6c757d'};
      html += `<div class="col-md-2"><div class="card bg-dark border-secondary"><div class="card-body text-center"><small class="text-muted">${s.service}</small><h5 class="mb-0" style="color:${colors[s.service]||'#FF9900'}">$${s.cost.toLocaleString()}</h5><small class="text-muted">${s.pct}%</small></div></div></div>`;
    });
    html += '</div>';
    document.getElementById('awsServiceBreakdown').innerHTML = html;
  }

  /* ── EC2 ──────────────────────────────────────────────────────────── */
  async function awsLoadEc2() {
    const status = document.getElementById('awsEc2StatusFilter').value;
    const az = document.getElementById('awsEc2AzFilter').value;
    let url = '/api/connectors/aws/ec2?';
    if (status) url += `status=${status}&`;
    if (az) url += `az=${az}&`;
    try {
      const r = await fetch(url);
      const d = await r.json();
      awsState.ec2 = d;
      awsRenderEc2(d);
    } catch(e) { console.error('AWS EC2 error', e); }
  }

  function awsRenderEc2(data) {
    const b = document.getElementById('awsEc2Body');
    b.innerHTML = data.map(i => {
      const sc = i.status === 'running' ? 'text-success' : 'text-danger';
      const cpuColor = i.cpu_pct > 80 ? 'text-danger' : i.cpu_pct > 50 ? 'text-warning' : 'text-success';
      return `<tr><td><code>${i.instance_id}</code></td><td>${i.name}</td><td>${i.type}</td><td>${i.az}</td><td class="${sc}">${i.status}</td><td class="${cpuColor}">${i.cpu_pct}%</td><td>${i.ram_gb} GB</td><td>${i.storage_gb} GB</td><td>${i.public_ip || '—'}</td></tr>`;
    }).join('');
  }

  /* ── S3 ──────────────────────────────────────────────────────────── */
  async function awsLoadS3() {
    const sc = document.getElementById('awsS3ClassFilter').value;
    let url = '/api/connectors/aws/s3?';
    if (sc) url += `storage_class=${sc}&`;
    try {
      const r = await fetch(url);
      const d = await r.json();
      awsState.s3 = d;
      awsRenderS3(d);
    } catch(e) { console.error('AWS S3 error', e); }
  }

  function awsRenderS3(data) {
    // Cards
    const totalSize = data.reduce((a,b) => a + b.size_gb, 0);
    const totalObjects = data.reduce((a,b) => a + b.objects, 0);
    document.getElementById('awsS3Cards').innerHTML = `
      <div class="col-md-3"><div class="card bg-dark border-secondary"><div class="card-body text-center"><small class="text-muted">Total Buckets</small><h4 class="mb-0" style="color:#569A31">${data.length}</h4></div></div></div>
      <div class="col-md-3"><div class="card bg-dark border-secondary"><div class="card-body text-center"><small class="text-muted">Total Objects</small><h4 class="mb-0" style="color:#569A31">${totalObjects.toLocaleString()}</h4></div></div></div>
      <div class="col-md-3"><div class="card bg-dark border-secondary"><div class="card-body text-center"><small class="text-muted">Total Storage</small><h4 class="mb-0" style="color:#569A31">${totalSize.toLocaleString()} GB</h4></div></div></div>
      <div class="col-md-3"><div class="card bg-dark border-secondary"><div class="card-body text-center"><small class="text-muted">Versioned</small><h4 class="mb-0" style="color:#569A31">${data.filter(b => b.versioning).length} / ${data.length}</h4></div></div></div>`;
    // Table
    document.getElementById('awsS3Body').innerHTML = data.map(b => `<tr><td><code>${b.name}</code></td><td><span class="badge bg-secondary">${b.storage_class}</span></td><td>${b.objects.toLocaleString()}</td><td>${b.size_gb.toLocaleString()}</td><td>${b.versioning ? '<i class="bi bi-check-circle-fill text-success"></i>' : '<i class="bi bi-x-circle text-danger"></i>'}</td><td>${b.created}</td><td>${b.last_modified}</td></tr>`).join('');
  }

  /* ── Lambda ──────────────────────────────────────────────────────── */
  async function awsLoadLambda() {
    const runtime = document.getElementById('awsLambdaRuntimeFilter').value;
    const status = document.getElementById('awsLambdaStatusFilter').value;
    let url = '/api/connectors/aws/lambda?';
    if (runtime) url += `runtime=${runtime}&`;
    if (status) url += `status=${status}&`;
    try {
      const r = await fetch(url);
      const d = await r.json();
      awsState.lambda = d;
      awsRenderLambda(d);
    } catch(e) { console.error('AWS Lambda error', e); }
  }

  function awsRenderLambda(data) {
    // Summary cards
    const totalInv = data.reduce((a,b) => a + b.invocations_30d, 0);
    const totalErr = data.reduce((a,b) => a + b.errors_30d, 0);
    const avgDur = data.filter(f => f.invocations_30d > 0).reduce((a,b,_,arr) => a + b.avg_duration_ms/arr.length, 0);
    document.getElementById('awsLambdaCards').innerHTML = `
      <div class="col-md-3"><div class="card bg-dark border-secondary"><div class="card-body text-center"><small class="text-muted">Functions</small><h4 class="mb-0" style="color:#D86613">${data.length}</h4></div></div></div>
      <div class="col-md-3"><div class="card bg-dark border-secondary"><div class="card-body text-center"><small class="text-muted">Total Invocations</small><h4 class="mb-0" style="color:#D86613">${totalInv.toLocaleString()}</h4></div></div></div>
      <div class="col-md-3"><div class="card bg-dark border-secondary"><div class="card-body text-center"><small class="text-muted">Total Errors</small><h4 class="mb-0 text-danger">${totalErr.toLocaleString()}</h4></div></div></div>
      <div class="col-md-3"><div class="card bg-dark border-secondary"><div class="card-body text-center"><small class="text-muted">Avg Duration</small><h4 class="mb-0" style="color:#D86613">${Math.round(avgDur)} ms</h4></div></div></div>`;
    // Table
    document.getElementById('awsLambdaBody').innerHTML = data.map(f => {
      const sc = f.status === 'active' ? 'text-success' : 'text-secondary';
      const durColor = f.avg_duration_ms > 3000 ? 'text-danger' : f.avg_duration_ms > 1000 ? 'text-warning' : 'text-success';
      return `<tr><td><code>${f.name}</code></td><td><span class="badge bg-secondary">${f.runtime}</span></td><td>${f.memory_mb} MB</td><td>${f.timeout_s}s</td><td>${f.invocations_30d.toLocaleString()}</td><td class="${durColor}">${f.avg_duration_ms} ms</td><td class="${f.errors_30d > 100 ? 'text-danger' : ''}">${f.errors_30d}</td><td class="${sc}">${f.status}</td></tr>`;
    }).join('');
  }

  /* ── Cost Explorer ──────────────────────────────────────────────── */
  async function awsLoadCostExplorer() {
    const svc = document.getElementById('awsCostServiceFilter').value;
    let url = '/api/connectors/aws/cost-explorer?';
    if (svc) url += `service=${svc}&`;
    try {
      const r = await fetch(url);
      const d = await r.json();
      awsState.cost = d;
      awsRenderCostExplorer(d, svc);
    } catch(e) { console.error('AWS cost error', e); }
  }

  function awsRenderCostExplorer(data, svcFilter) {
    const ctx = document.getElementById('awsCostChart');
    if (ctx && typeof Chart !== 'undefined') {
      if (awsState.costChart) awsState.costChart.destroy();
      if (svcFilter) {
        awsState.costChart = new Chart(ctx, { type: 'bar', data: { labels: data.map(d=>d.month), datasets: [{ label: svcFilter.toUpperCase()+' ($)', data: data.map(d=>d.cost), backgroundColor: '#FF9900' }] }, options: { responsive: true, plugins: { legend: { labels: { color: '#ccc' } } }, scales: { x:{ticks:{color:'#999'}}, y:{ticks:{color:'#999', callback: v=>'$'+v}} } } });
      } else {
        const colors = {'ec2':'#FF9900','s3':'#569A31','lambda':'#D86613','rds':'#3B48CC','cloudfront':'#8C4FFF','other':'#6c757d'};
        const services = ['ec2','s3','lambda','rds','cloudfront','other'];
        awsState.costChart = new Chart(ctx, { type: 'bar', data: { labels: data.map(d=>d.month), datasets: services.map(s => ({ label: s.toUpperCase(), data: data.map(d=>d[s]), backgroundColor: colors[s] })) }, options: { responsive: true, plugins: { legend: { labels: { color: '#ccc' } } }, scales: { x: { stacked: true, ticks: { color: '#999' } }, y: { stacked: true, ticks: { color: '#999', callback: v => '$'+v.toLocaleString() } } } } });
      }
    }
    // Table
    const body = document.getElementById('awsCostBody');
    if (svcFilter) {
      body.innerHTML = data.map(r => `<tr><td>${r.month}</td><td colspan="6">—</td><td class="text-warning">$${r.cost.toLocaleString()}</td></tr>`).join('');
    } else {
      body.innerHTML = data.map(r => `<tr><td>${r.month}</td><td>$${r.ec2.toLocaleString()}</td><td>$${r.s3.toLocaleString()}</td><td>$${r.lambda.toLocaleString()}</td><td>$${r.rds.toLocaleString()}</td><td>$${r.cloudfront.toLocaleString()}</td><td>$${r.other.toLocaleString()}</td><td class="text-warning fw-bold">$${r.total.toLocaleString()}</td></tr>`).join('');
    }
  }

  /* ── Reports ─────────────────────────────────────────────────────── */
  async function awsLoadReports() {
    try {
      const r = await fetch('/api/connectors/aws/reports');
      const d = await r.json();
      awsState.reports = d;
      awsRenderReports(d);
    } catch(e) { console.error('AWS reports error', e); }
  }

  function awsRenderReports(data) {
    const typeColors = {'EC2 Instance':'#FF9900','S3 Bucket':'#569A31','Lambda Function':'#D86613','Cost':'#ffc107'};
    document.getElementById('awsReportsBody').innerHTML = data.map(r => {
      const sc = r.status === 'running' || r.status === 'active' ? 'text-success' : r.status === 'stopped' || r.status === 'inactive' ? 'text-danger' : 'text-warning';
      return `<tr><td><span class="badge" style="background:${typeColors[r.type]||'#6c757d'}">${r.type}</span></td><td>${r.name}</td><td><small>${r.detail}</small></td><td class="${sc}">${r.status}</td><td>${r.metric}</td></tr>`;
    }).join('');
  }

  /* ── Test API ────────────────────────────────────────────────────── */
  async function awsTestApiCall() {
    const endpoint = document.getElementById('awsTestEndpoint').value;
    document.getElementById('awsTestResult').textContent = 'Calling AWS SDK…';
    try {
      const r = await fetch('/api/connectors/aws/test-call', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ endpoint }) });
      const d = await r.json();
      document.getElementById('awsTestResult').textContent = JSON.stringify(d, null, 2);
    } catch(e) {
      document.getElementById('awsTestResult').textContent = 'Error: ' + e.message;
    }
  }

  /* ── Settings ────────────────────────────────────────────────────── */
  function awsSaveSettings() {
    document.getElementById('awsSettingsSaved').style.display = 'inline';
    setTimeout(() => { document.getElementById('awsSettingsSaved').style.display = 'none'; }, 2000);
  }

  /* ── Tab listeners ───────────────────────────────────────────────── */
  document.addEventListener('DOMContentLoaded', function() {
    const awsTabEl = document.getElementById('awsTabs');
    if (awsTabEl) {
      awsTabEl.addEventListener('shown.bs.tab', function(e) {
        const target = e.target.getAttribute('href');
        if (target === '#awsEc2Tab' && !awsState.ec2) awsLoadEc2();
        if (target === '#awsS3Tab' && !awsState.s3) awsLoadS3();
        if (target === '#awsLambdaTab' && !awsState.lambda) awsLoadLambda();
        if (target === '#awsCostTab' && !awsState.cost) awsLoadCostExplorer();
        if (target === '#awsReportsTab' && !awsState.reports) awsLoadReports();
      });
    }
  });

  /* ── CSV Exports ─────────────────────────────────────────────────── */
  function awsExportEc2()     { const rows = [...document.getElementById('awsEc2Body').querySelectorAll('tr')].map(r => [...r.cells].map(c => c.textContent.trim())); downloadCSV('aws_ec2_instances.csv', ['Instance ID','Name','Type','AZ','Status','CPU','RAM','Storage','Public IP'], rows); }
  function awsExportS3()      { const rows = [...document.getElementById('awsS3Body').querySelectorAll('tr')].map(r => [...r.cells].map(c => c.textContent.trim())); downloadCSV('aws_s3_buckets.csv', ['Bucket','Storage Class','Objects','Size (GB)','Versioning','Created','Last Modified'], rows); }
  function awsExportLambda()  { const rows = [...document.getElementById('awsLambdaBody').querySelectorAll('tr')].map(r => [...r.cells].map(c => c.textContent.trim())); downloadCSV('aws_lambda_functions.csv', ['Function','Runtime','Memory','Timeout','Invocations','Avg Duration','Errors','Status'], rows); }
  function awsExportCost()    { const rows = [...document.getElementById('awsCostBody').querySelectorAll('tr')].map(r => [...r.cells].map(c => c.textContent.trim())); downloadCSV('aws_cost_explorer.csv', ['Month','EC2','S3','Lambda','RDS','CloudFront','Other','Total'], rows); }
  function awsExportReports() { const rows = [...document.getElementById('awsReportsBody').querySelectorAll('tr')].map(r => [...r.cells].map(c => c.textContent.trim())); downloadCSV('aws_reports.csv', ['Type','Name','Detail','Status','Metric'], rows); }

  // ═══════════════════════════════════════════════════════════════════════════
  // VERCEL ENGINE  (Phase 30)
  // ═══════════════════════════════════════════════════════════════════════════
  let vcState = {};

  async function vcInit() {
    vcState = {};
    vcLoadOverview();
  }

  /* ── Overview ─────────────────────────────────────────────────────── */
  async function vcLoadOverview() {
    try {
      const r = await fetch('/api/connectors/vercel/overview');
      const d = await r.json();
      vcState.overview = d;
      vcRenderOverview(d);
    } catch(e) { console.error('Vercel overview error', e); }
  }

  function vcRenderOverview(d) {
    document.getElementById('vcKpiDeploys').textContent = d.total_deployments;
    document.getElementById('vcKpiToday').textContent = d.deployments_today;
    document.getElementById('vcKpiDomains').textContent = d.domains;
    document.getElementById('vcKpiBandwidth').textContent = d.bandwidth_gb + ' GB';
    document.getElementById('vcKpiBuilds').textContent = d.builds_this_month;
    document.getElementById('vcKpiAvgBuild').textContent = d.avg_build_time_s + 's';
    document.getElementById('vcKpiProjects').textContent = d.projects;
    document.getElementById('vcKpiEdge').textContent = d.edge_functions;
    document.getElementById('vcKpiServerless').textContent = d.serverless_invocations_30d.toLocaleString();
    document.getElementById('vcKpiPlan').textContent = d.plan;
    // Deploy trend chart
    const ctx = document.getElementById('vercelDeployChart');
    if (ctx && typeof Chart !== 'undefined') {
      if (vcState.deployChart) vcState.deployChart.destroy();
      vcState.deployChart = new Chart(ctx, { type: 'bar', data: { labels: d.deploy_trend.map(t => t.date.slice(5)), datasets: [{ label: 'Succeeded', data: d.deploy_trend.map(t => t.succeeded), backgroundColor: '#00c853' }, { label: 'Failed', data: d.deploy_trend.map(t => t.failed), backgroundColor: '#ff1744' }] }, options: { responsive: true, plugins: { legend: { labels: { color: '#ccc' } } }, scales: { x: { stacked: true, ticks: { color: '#999' } }, y: { stacked: true, ticks: { color: '#999', stepSize: 1 } } } } });
    }
  }

  /* ── Deployments ──────────────────────────────────────────────────── */
  async function vcLoadDeployments() {
    const state = document.getElementById('vcDeployStateFilter').value;
    const target = document.getElementById('vcDeployTargetFilter').value;
    const project = document.getElementById('vcDeployProjectFilter').value;
    let url = '/api/connectors/vercel/deployments?';
    if (state) url += `state=${state}&`;
    if (target) url += `target=${target}&`;
    if (project) url += `project=${project}&`;
    try {
      const r = await fetch(url);
      const d = await r.json();
      vcState.deployments = d;
      vcRenderDeployments(d);
    } catch(e) { console.error('Vercel deployments error', e); }
  }

  function vcRenderDeployments(data) {
    const stateColors = { 'READY': 'text-success', 'ERROR': 'text-danger', 'BUILDING': 'text-warning', 'CANCELED': 'text-secondary' };
    const stateIcons = { 'READY': 'bi-check-circle-fill', 'ERROR': 'bi-x-circle-fill', 'BUILDING': 'bi-arrow-repeat', 'CANCELED': 'bi-dash-circle' };
    document.getElementById('vcDeploymentsBody').innerHTML = data.map(d => `<tr>
      <td><code>${d.uid}</code></td><td>${d.name}</td><td title="${d.commit_sha}">${d.commit.substring(0,30)}</td>
      <td><span class="badge bg-secondary">${d.branch}</span></td>
      <td><span class="badge ${d.target==='production'?'bg-success':'bg-info'}">${d.target}</span></td>
      <td class="${stateColors[d.state]||''}"><i class="bi ${stateIcons[d.state]||''} me-1"></i>${d.state}</td>
      <td>${d.duration_s ? d.duration_s+'s' : '—'}</td><td>${d.creator.split('@')[0]}</td>
      <td>${d.created.substring(0,10)}</td></tr>`).join('');
  }

  /* ── Domains ─────────────────────────────────────────────────────── */
  async function vcLoadDomains() {
    const status = document.getElementById('vcDomainStatusFilter').value;
    let url = '/api/connectors/vercel/domains?';
    if (status) url += `status=${status}&`;
    try {
      const r = await fetch(url);
      const d = await r.json();
      vcState.domains = d;
      vcRenderDomains(d);
    } catch(e) { console.error('Vercel domains error', e); }
  }

  function vcRenderDomains(data) {
    const valid = data.filter(d => d.status === 'valid').length;
    const pending = data.filter(d => d.status === 'pending').length;
    const expired = data.filter(d => d.status === 'expired').length;
    document.getElementById('vcDomainCards').innerHTML = `
      <div class="col-md-4"><div class="card bg-dark border-success"><div class="card-body text-center"><small class="text-muted">Valid</small><h4 class="text-success mb-0">${valid}</h4></div></div></div>
      <div class="col-md-4"><div class="card bg-dark border-warning"><div class="card-body text-center"><small class="text-muted">Pending</small><h4 class="text-warning mb-0">${pending}</h4></div></div></div>
      <div class="col-md-4"><div class="card bg-dark border-danger"><div class="card-body text-center"><small class="text-muted">Expired</small><h4 class="text-danger mb-0">${expired}</h4></div></div></div>`;
    const sc = { 'valid': 'text-success', 'pending': 'text-warning', 'expired': 'text-danger' };
    document.getElementById('vcDomainsBody').innerHTML = data.map(d => `<tr>
      <td><code>${d.name}</code></td><td>${d.project}</td>
      <td class="${sc[d.status]||''}">${d.status}</td>
      <td class="${sc[d.ssl]||''}">${d.ssl}</td>
      <td>${d.ssl_expiry || '—'}</td><td>${d.dns_type}</td>
      <td>${d.redirect || '—'}</td></tr>`).join('');
  }

  /* ── Logs ─────────────────────────────────────────────────────────── */
  async function vcLoadLogs() {
    const depl = document.getElementById('vcLogDeployFilter').value;
    const level = document.getElementById('vcLogLevelFilter').value;
    const search = document.getElementById('vcLogSearch').value;
    let url = '/api/connectors/vercel/logs?';
    if (depl) url += `deployment=${depl}&`;
    if (level) url += `level=${level}&`;
    if (search) url += `search=${encodeURIComponent(search)}&`;
    try {
      const r = await fetch(url);
      const d = await r.json();
      vcState.logs = d;
      vcRenderLogs(d);
    } catch(e) { console.error('Vercel logs error', e); }
  }

  function vcRenderLogs(data) {
    const lc = { 'info': 'text-info', 'warning': 'text-warning', 'error': 'text-danger' };
    const li = { 'info': 'bi-info-circle', 'warning': 'bi-exclamation-triangle', 'error': 'bi-x-octagon' };
    document.getElementById('vcLogsBody').innerHTML = data.map(l => `<tr>
      <td><code>${l.deployment}</code></td>
      <td>${l.timestamp.replace('T',' ').replace('Z','')}</td>
      <td class="${lc[l.level]||''}"><i class="bi ${li[l.level]||''} me-1"></i>${l.level}</td>
      <td>${l.message}</td><td>${l.source}</td></tr>`).join('');
  }

  /* ── Analytics ───────────────────────────────────────────────────── */
  async function vcLoadAnalytics() {
    try {
      const r = await fetch('/api/connectors/vercel/analytics');
      const d = await r.json();
      vcState.analytics = d;
      vcRenderAnalytics(d);
    } catch(e) { console.error('Vercel analytics error', e); }
  }

  function vcRenderAnalytics(d) {
    document.getElementById('vcAnalyticsKpis').innerHTML = `
      <div class="col-md-2"><div class="card bg-dark border-secondary"><div class="card-body text-center"><small class="text-muted">Total Visitors</small><h4 class="mb-0 text-white">${d.total_visitors.toLocaleString()}</h4></div></div></div>
      <div class="col-md-2"><div class="card bg-dark border-secondary"><div class="card-body text-center"><small class="text-muted">Unique</small><h4 class="mb-0 text-info">${d.unique_visitors.toLocaleString()}</h4></div></div></div>
      <div class="col-md-2"><div class="card bg-dark border-secondary"><div class="card-body text-center"><small class="text-muted">Page Views</small><h4 class="mb-0 text-primary">${d.page_views.toLocaleString()}</h4></div></div></div>
      <div class="col-md-2"><div class="card bg-dark border-secondary"><div class="card-body text-center"><small class="text-muted">Bandwidth</small><h4 class="mb-0 text-success">${d.bandwidth_gb} GB</h4></div></div></div>
      <div class="col-md-2"><div class="card bg-dark border-secondary"><div class="card-body text-center"><small class="text-muted">Avg Response</small><h4 class="mb-0 text-warning">${d.avg_response_ms} ms</h4></div></div></div>
      <div class="col-md-2"><div class="card bg-dark border-secondary"><div class="card-body text-center"><small class="text-muted">Cache Hit</small><h4 class="mb-0 text-success">${d.cache_hit_rate}%</h4></div></div></div>`;
    // Visitors chart
    const ctx = document.getElementById('vercelVisitorsChart');
    if (ctx && typeof Chart !== 'undefined') {
      if (vcState.visitorsChart) vcState.visitorsChart.destroy();
      vcState.visitorsChart = new Chart(ctx, { type: 'line', data: { labels: d.daily_visitors.map(v => v.date.slice(5)), datasets: [{ label: 'Visitors', data: d.daily_visitors.map(v => v.visitors), borderColor: '#fff', backgroundColor: 'rgba(255,255,255,0.1)', fill: true, tension: 0.3 }, { label: 'Page Views', data: d.daily_visitors.map(v => v.page_views), borderColor: '#00c853', backgroundColor: 'rgba(0,200,83,0.1)', fill: true, tension: 0.3 }] }, options: { responsive: true, plugins: { legend: { labels: { color: '#ccc' } } }, scales: { x: { ticks: { color: '#999' } }, y: { ticks: { color: '#999' } } } } });
    }
    // Top pages
    document.getElementById('vcTopPagesBody').innerHTML = d.top_pages.map(p => `<tr><td><code>${p.path}</code></td><td>${p.views.toLocaleString()}</td><td>${p.visitors.toLocaleString()}</td><td>${p.avg_duration_s}s</td></tr>`).join('');
    // Referrers
    document.getElementById('vcReferrersBody').innerHTML = d.top_referrers.map(r => `<tr><td>${r.source}</td><td>${r.visitors.toLocaleString()}</td><td>${r.pct}%</td></tr>`).join('');
  }

  /* ── Reports ─────────────────────────────────────────────────────── */
  async function vcLoadReports() {
    try {
      const r = await fetch('/api/connectors/vercel/reports');
      const d = await r.json();
      vcState.reports = d;
      vcRenderReports(d);
    } catch(e) { console.error('Vercel reports error', e); }
  }

  function vcRenderReports(data) {
    const tc = { 'Deployment': '#fff', 'Domain': '#00c853', 'Page': '#2196f3' };
    const sc = { 'READY': 'text-success', 'ERROR': 'text-danger', 'BUILDING': 'text-warning', 'CANCELED': 'text-secondary', 'valid': 'text-success', 'pending': 'text-warning', 'expired': 'text-danger', 'active': 'text-info' };
    document.getElementById('vcReportsBody').innerHTML = data.map(r => `<tr>
      <td><span class="badge" style="background:${tc[r.type]||'#6c757d'};color:${r.type==='Deployment'?'#000':'#fff'}">${r.type}</span></td>
      <td>${r.name}</td><td><small>${r.detail}</small></td>
      <td class="${sc[r.status]||''}">${r.status}</td><td>${r.metric}</td></tr>`).join('');
  }

  /* ── Test API ────────────────────────────────────────────────────── */
  async function vcTestApiCall() {
    const endpoint = document.getElementById('vcTestEndpoint').value;
    document.getElementById('vcTestResult').textContent = 'Calling Vercel API…';
    try {
      const r = await fetch('/api/connectors/vercel/test-call', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ endpoint }) });
      const d = await r.json();
      document.getElementById('vcTestResult').textContent = JSON.stringify(d, null, 2);
    } catch(e) { document.getElementById('vcTestResult').textContent = 'Error: ' + e.message; }
  }

  /* ── Settings ────────────────────────────────────────────────────── */
  function vcSaveSettings() {
    document.getElementById('vcSettingsSaved').style.display = 'inline';
    setTimeout(() => { document.getElementById('vcSettingsSaved').style.display = 'none'; }, 2000);
  }

  /* ── Tab listeners ───────────────────────────────────────────────── */
  document.addEventListener('DOMContentLoaded', function() {
    const vcTabEl = document.getElementById('vercelTabs');
    if (vcTabEl) {
      vcTabEl.addEventListener('shown.bs.tab', function(e) {
        const target = e.target.getAttribute('href');
        if (target === '#vercelDeploymentsTab' && !vcState.deployments) vcLoadDeployments();
        if (target === '#vercelDomainsTab' && !vcState.domains) vcLoadDomains();
        if (target === '#vercelLogsTab' && !vcState.logs) vcLoadLogs();
        if (target === '#vercelAnalyticsTab' && !vcState.analytics) vcLoadAnalytics();
        if (target === '#vercelReportsTab' && !vcState.reports) vcLoadReports();
      });
    }
  });

  /* ── CSV Exports ─────────────────────────────────────────────────── */
  function vcExportDeployments() { const rows = [...document.getElementById('vcDeploymentsBody').querySelectorAll('tr')].map(r => [...r.cells].map(c => c.textContent.trim())); downloadCSV('vercel_deployments.csv', ['UID','Project','Commit','Branch','Target','State','Duration','Creator','Date'], rows); }
  function vcExportDomains()     { const rows = [...document.getElementById('vcDomainsBody').querySelectorAll('tr')].map(r => [...r.cells].map(c => c.textContent.trim())); downloadCSV('vercel_domains.csv', ['Domain','Project','Status','SSL','SSL Expiry','DNS','Redirect'], rows); }
  function vcExportLogs()        { const rows = [...document.getElementById('vcLogsBody').querySelectorAll('tr')].map(r => [...r.cells].map(c => c.textContent.trim())); downloadCSV('vercel_logs.csv', ['Deployment','Timestamp','Level','Message','Source'], rows); }
  function vcExportReports()     { const rows = [...document.getElementById('vcReportsBody').querySelectorAll('tr')].map(r => [...r.cells].map(c => c.textContent.trim())); downloadCSV('vercel_reports.csv', ['Type','Name','Detail','Status','Metric'], rows); }

  // ── CSV Download Utility ────────────────────────────────────────────────
  function downloadCSV(filename, headers, rows) {
    const escape = v => `"${String(v).replace(/"/g, '""')}"`;
    const csv = [headers.map(escape).join(','), ...rows.map(r => r.map(escape).join(','))].join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    URL.revokeObjectURL(a.href);
    if (window.showToast) window.showToast('Export', `Downloaded ${filename}`, 'success');
  }

  // Load statuses on page load
  window.addEventListener('DOMContentLoaded', loadConnectorStatuses);
  window.addEventListener('camarad:client-changed', function() { loadConnectorStatuses(); });
</script>

<style>
  .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }
  .nav-link.active {
    background-color: #0d6efd;
  }

  /* Core fix: forțează text light pe fundal dark */
  body, .modal-content, .card, .list-group-item, .tab-pane {
    color: #e0e0e0 !important; /* gri-deschis pentru text principal */
  }

  .card-body, .card-title, .card-text, h5, h6, .form-label, .nav-link {
    color: #ffffff !important; /* alb pur pentru titluri și label-uri */
  }

  .text-muted {
    color: #a0a0a0 !important; /* gri mediu pentru muted text */
  }

  .bg-dark {
    background-color: #0d1117 !important; /* fundal consistent */
  }

  .form-control, .form-select {
    background-color: #161b22 !important;
    color: #ffffff !important;
    border-color: #30363d !important;
  }

  .form-control:focus, .form-select:focus {
    border-color: #58a6ff !important;
    box-shadow: 0 0 0 0.25rem rgba(88,166,255,0.25) !important;
  }

  /* Fix badge contrast */
  .badge.bg-success {
    background-color: #238636 !important;
    color: white !important;
  }

  .badge.bg-warning {
    background-color: #bb8009 !important;
    color: white !important;
  }

  .badge.bg-danger {
    background-color: #c94a4a !important;
    color: white !important;
  }

  /* Sidebar și active state */
  .sidebar .nav-link.active {
    background-color: #21262d !important;
    color: #ffffff !important;
  }

  /* Card hover fix */
  .card:hover {
    border-color: #58a6ff !important;
    box-shadow: 0 0 15px rgba(88,166,255,0.3) !important;
  }
</style>
{% endblock %}


