{% extends "base.html" %}

{% block content %}
        <!-- Header -->
        <div class="d-flex align-items-center mb-4">
          <div class="me-3 text-center">
            <div id="avatarContainer" class="agent-avatar-large avatar-container animate micro-tilt" style="--avatar-accent: #58a6ff;">
              <!-- SVG avatar rendered by JS -->
            </div>
            <div id="avatarPhotoWrap" class="avatar-photo-wrap" style="display:none; --avatar-accent: #58a6ff; margin: 0 auto;">
              <img id="avatarPreview" src="" alt="Agent Avatar">
            </div>
            <input type="file" id="avatarUpload" accept="image/*" style="display: none;">
            <div class="avatar-expr-picker mt-2" id="exprPicker">
              <button class="expr-btn active" data-expr="neutral" title="Neutral">üòê</button>
              <button class="expr-btn" data-expr="smile" title="Happy">üòä</button>
              <button class="expr-btn" data-expr="think" title="Thinking">ü§î</button>
              <button class="expr-btn" data-expr="surprised" title="Surprised">üòÆ</button>
              <button class="expr-btn" data-expr="serious" title="Serious">üò†</button>
              <button class="expr-btn" data-expr="wink" title="Wink">üòâ</button>
              <button class="expr-btn" data-expr="excited" title="Excited">ü§©</button>
            </div>
            <div class="d-flex gap-1 mt-1 justify-content-center">
              <button class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('avatarUpload').click()">
                <i class="bi bi-camera me-1"></i>Upload Photo
              </button>
              <button class="btn btn-sm btn-outline-danger" id="removePhotoBtn" style="display:none" onclick="removeCustomPhoto()">
                <i class="bi bi-x-circle me-1"></i>Remove
              </button>
            </div>
          </div>
          <div>
            <h2 id="agentTitle" class="agent-name-accent" style="--avatar-accent: #58a6ff;">{{ agent_title or slug.replace('-', ' ').title() }}</h2>
            <p class="text-muted">Configure and manage this AI agent</p>
          </div>
          <div class="ms-auto">
            <a href="/agents" class="btn btn-outline-secondary">‚Üê Back to Agents</a>
          </div>
        </div>

        <!-- Tabs -->
        <ul class="nav nav-tabs mb-4" id="agentTabs">
          <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#general" type="button">General</button>
          </li>
          <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#llm" type="button">LLM & Model</button>
          </li>
          <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#knowledge" type="button">Knowledge & RAG</button>
          </li>
          <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#training" type="button">Training</button>
          </li>
          <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#functions" type="button">Functions & Tools</button>
          </li>
          <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#test" type="button">Test & Debug</button>
          </li>
        </ul>

        <div class="tab-content">
          <!-- General Tab -->
          <div class="tab-pane fade show active" id="general">
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Agent Name</label>
                  <input type="text" class="form-control bg-dark text-light border-secondary" id="agentName" value="{{ agent_title or slug.replace('-', ' ').title() }}">
                </div>
                <div class="mb-3">
                  <label class="form-label">Workspace</label>
                  <select class="form-select bg-dark text-light border-secondary" id="agentWorkspace">
                    <option>Personal</option>
                    <option>Business</option>
                    <option>Agency</option>
                    <option>Development</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">Status</label>
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="agentStatus" checked>
                    <label class="form-check-label" for="agentStatus">Active</label>
                  </div>
                </div>

                <!-- Avatar Customization Panel -->
                <div class="avatar-customize-panel" id="avatarCustomizePanel">
                  <h6 class="mb-3"><i class="bi bi-palette me-2"></i>Avatar Customization</h6>
                  
                  <div class="customize-section">
                    <label>Accent Color</label>
                    <div class="swatch-group" id="accentSwatches">
                      <div class="color-swatch" style="background:#1f6feb" data-color="#1f6feb" title="Blue"></div>
                      <div class="color-swatch" style="background:#8957e5" data-color="#8957e5" title="Purple"></div>
                      <div class="color-swatch" style="background:#e5534b" data-color="#e5534b" title="Red"></div>
                      <div class="color-swatch" style="background:#3fb950" data-color="#3fb950" title="Green"></div>
                      <div class="color-swatch" style="background:#d29922" data-color="#d29922" title="Gold"></div>
                      <div class="color-swatch" style="background:#f0883e" data-color="#f0883e" title="Orange"></div>
                      <div class="color-swatch" style="background:#f778ba" data-color="#f778ba" title="Pink"></div>
                      <div class="color-swatch" style="background:#58a6ff" data-color="#58a6ff" title="Sky"></div>
                      <div class="color-swatch" style="background:#da3633" data-color="#da3633" title="Crimson"></div>
                      <div class="color-swatch" style="background:#6e40c9" data-color="#6e40c9" title="Violet"></div>
                    </div>
                  </div>

                  <div class="customize-section">
                    <label>Skin Tone</label>
                    <div class="swatch-group" id="skinSwatches">
                      <div class="color-swatch" style="background:#FDBCB4" data-color="#FDBCB4" title="Light"></div>
                      <div class="color-swatch" style="background:#E0AC69" data-color="#E0AC69" title="Warm"></div>
                      <div class="color-swatch" style="background:#D4A574" data-color="#D4A574" title="Medium"></div>
                      <div class="color-swatch" style="background:#C68642" data-color="#C68642" title="Tan"></div>
                      <div class="color-swatch" style="background:#8D5524" data-color="#8D5524" title="Brown"></div>
                      <div class="color-swatch" style="background:#6B4423" data-color="#6B4423" title="Dark"></div>
                    </div>
                  </div>

                  <div class="customize-section">
                    <label>Hair Color</label>
                    <div class="swatch-group" id="hairSwatches">
                      <div class="color-swatch" style="background:#1A1A1A" data-color="#1A1A1A" title="Black"></div>
                      <div class="color-swatch" style="background:#2C2C2C" data-color="#2C2C2C" title="Dark"></div>
                      <div class="color-swatch" style="background:#4A4A4A" data-color="#4A4A4A" title="Grey"></div>
                      <div class="color-swatch" style="background:#8B4513" data-color="#8B4513" title="Brown"></div>
                      <div class="color-swatch" style="background:#D4A017" data-color="#D4A017" title="Blonde"></div>
                      <div class="color-swatch" style="background:#FF6B6B" data-color="#FF6B6B" title="Red"></div>
                      <div class="color-swatch" style="background:#7B2D8E" data-color="#7B2D8E" title="Purple"></div>
                      <div class="color-swatch" style="background:#2196F3" data-color="#2196F3" title="Blue"></div>
                    </div>
                  </div>

                  <div class="d-flex gap-2 mt-2">
                    <button class="btn btn-sm btn-outline-primary flex-fill" onclick="resetAvatarToDefault()">
                      <i class="bi bi-arrow-counterclockwise me-1"></i>Reset Default
                    </button>
                    <button class="btn btn-sm btn-primary flex-fill" onclick="saveAvatarCustomization()">
                      <i class="bi bi-check-lg me-1"></i>Save Avatar
                    </button>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Description</label>
                  <textarea class="form-control bg-dark text-light border-secondary" id="agentDescription" rows="5">This agent specializes in {{ slug.replace('-', ' ') }}.</textarea>
                </div>
              </div>
            </div>
            <button class="btn btn-primary" onclick="saveGeneral()">Save General Settings</button>
          </div>

          <!-- LLM & Model Tab -->
          <div class="tab-pane fade" id="llm">
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">LLM Provider</label>
                  <select class="form-select bg-dark text-light border-secondary" id="llmProvider">
                    <option>xAI / Grok</option>
                    <option>OpenAI</option>
                    <option>Anthropic (Claude)</option>
                    <option>Google Gemini</option>
                    <option>Meta Llama</option>
                    <option>Mistral</option>
                    <option>Cohere</option>
                    <option>Perplexity</option>
                    <option>Hugging Face</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">Model</label>
                  <select class="form-select bg-dark text-light border-secondary" id="llmModel">
                    <option>Grok-1</option>
                    <option>GPT-4o</option>
                    <option>Claude-3.5</option>
                    <option>Gemini-1.5</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">Temperature</label>
                  <input type="range" class="form-range" id="temperature" min="0" max="2" step="0.1" value="0.7">
                  <small class="text-muted">Current: <span id="tempValue">0.7</span></small>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Bring Your Own Key (BYOK)</label>
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="byokToggle">
                    <label class="form-check-label" for="byokToggle">Use custom API key</label>
                  </div>
                </div>
                <div class="mb-3" id="apiKeyGroup" style="display: none;">
                  <label class="form-label">API Key</label>
                  <input type="password" class="form-control bg-dark text-light border-secondary" id="apiKey" placeholder="sk-...">
                </div>
                <div class="mb-3">
                  <label class="form-label">Max Tokens</label>
                  <input type="number" class="form-control bg-dark text-light border-secondary" id="maxTokens" value="4096">
                </div>
              </div>
            </div>
            <button class="btn btn-primary" onclick="saveLLM()">Save LLM Settings</button>
          </div>

          <!-- Knowledge & RAG Tab -->
          <div class="tab-pane fade" id="knowledge">
            <div class="mb-3">
              <label class="form-label">Enable RAG</label>
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="ragToggle" checked>
                <label class="form-check-label" for="ragToggle">Use Retrieval-Augmented Generation</label>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Upload Documents</label>
              <input type="file" class="form-control bg-dark text-light border-secondary" id="docUpload" multiple accept=".pdf,.txt,.md">
              <button class="btn btn-outline-primary mt-2" onclick="uploadDocs()">Upload & Ingest</button>
            </div>
            <div class="mb-3">
              <label class="form-label">Existing Knowledge Chunks</label>
              <ul class="list-group bg-dark" id="knowledgeList">
                <li class="list-group-item bg-dark border-secondary">Sample chunk 1</li>
                <li class="list-group-item bg-dark border-secondary">Sample chunk 2</li>
              </ul>
            </div>
            <button class="btn btn-primary" onclick="saveKnowledge()">Save Knowledge Settings</button>
          </div>

          <!-- Training Tab -->
          <div class="tab-pane fade" id="training">
            <div class="mb-3">
              <label class="form-label">Training Status</label>
              <p class="text-muted">Not trained yet</p>
            </div>
            <div class="mb-3">
              <label class="form-label">Upload Training Dataset (JSONL)</label>
              <input type="file" class="form-control bg-dark text-light border-secondary" id="datasetUpload" accept=".jsonl">
            </div>
            <div class="mb-3">
              <label class="form-label">LoRA Parameters</label>
              <div class="row">
                <div class="col-md-4">
                  <input type="number" class="form-control bg-dark text-light border-secondary" placeholder="Rank" value="8">
                </div>
                <div class="col-md-4">
                  <input type="number" class="form-control bg-dark text-light border-secondary" placeholder="Alpha" value="16">
                </div>
                <div class="col-md-4">
                  <input type="number" class="form-control bg-dark text-light border-secondary" placeholder="Dropout" value="0.05">
                </div>
              </div>
            </div>
            <button class="btn btn-success" onclick="startTraining()">Start Training</button>
          </div>

          <!-- Functions & Tools Tab -->
          <div class="tab-pane fade" id="functions">
            <div class="mb-3">
              <label class="form-label">Connector Integrations</label>
              <div class="row">
                <div class="col-md-6">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="googleAdsCheck">
                    <label class="form-check-label" for="googleAdsCheck">Google Ads</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="ga4Check">
                    <label class="form-check-label" for="ga4Check">GA4</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="githubCheck">
                    <label class="form-check-label" for="githubCheck">GitHub</label>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="stripeCheck">
                    <label class="form-check-label" for="stripeCheck">Stripe</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="hubspotCheck">
                    <label class="form-check-label" for="hubspotCheck">HubSpot</label>
                  </div>
                </div>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Custom Tools</label>
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="customToolsToggle">
                <label class="form-check-label" for="customToolsToggle">Enable custom functions</label>
              </div>
            </div>
            <button class="btn btn-outline-primary" onclick="addCustomFunction()">Add Custom Function</button>
            <button class="btn btn-primary mt-3" onclick="saveFunctions()">Save Functions Settings</button>
          </div>

          <!-- Test & Debug Tab -->
          <div class="tab-pane fade" id="test">
            <h5 class="mb-3">Test & Debug Agent</h5>
            <p class="text-muted small mb-4">Chat directly with {{ agent_title or slug.replace('-', ' ').title() }} (mock with real RAG from DB).</p>

            <div id="testChat" class="border border-secondary rounded p-3 mb-3 bg-dark" style="height: 400px; overflow-y: auto;"></div>

            <div class="input-group">
              <input type="text" id="testInput" class="form-control bg-dark text-light border-secondary" placeholder="Ask {{ agent_title or slug.replace('-', ' ').title() }} anything...">
              <button class="btn btn-primary" id="testSend">Send</button>
            </div>

            <button class="btn btn-sm btn-outline-danger mt-2" onclick="clearAgentMemory()">Clear Memory</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
  const agentSlug = '{{ slug }}';
  const agentName = localStorage.getItem(`agent_${agentSlug}_name`) || '{{ slug.replace("-", " ").title() }}';
  const llmChoice = JSON.parse(localStorage.getItem(`agent_${agentSlug}_llm`) || '{}').provider || 'Grok';

  // Chat Test & Debug cu RAG real din DB
  const testChat = document.getElementById('testChat');
  const testInput = document.getElementById('testInput');
  const testSend = document.getElementById('testSend');

  let conversation = JSON.parse(localStorage.getItem(`agent_${agentSlug}_chat`)) || [];
  let suppressTurnRagSpend = false;

  async function loadConversation() {
    testChat.innerHTML = '';
    conversation.forEach(msg => {
      const div = document.createElement('div');
      div.className = `mb-3 ${msg.role === 'user' ? 'text-end' : 'text-start'}`;
      div.innerHTML = `
        <div class="d-inline-block p-3 rounded ${msg.role === 'user' ? 'bg-primary text-white' : 'bg-secondary text-light'}">
          <strong>${msg.role === 'user' ? 'You' : agentName} (${msg.llm || 'Grok'}):</strong><br>
          ${msg.content}
        </div>
      `;
      testChat.appendChild(div);
    });
    testChat.scrollTop = testChat.scrollHeight;
  }

  async function addMessage(role, content, llm = llmChoice) {
    conversation.push({ role, content, llm });
    localStorage.setItem(`agent_${agentSlug}_chat`, JSON.stringify(conversation));
    loadConversation();
  }

  async function getRagContext(query) {
    let context = '';

    // CT spend gate for deep RAG lookups
    if (!suppressTurnRagSpend && window.spendCT && typeof window.spendCT === 'function') {
      const ragCost = Math.max(15, Math.min(30, 15 + (Math.floor(String(query || '').length / 100) * 5)));
      const spend = await window.spendCT(ragCost, 'rag_query', 'Agent RAG query: ' + String(query || '').slice(0, 80), { silentSuccess: true });
      if (!spend || spend.success !== true) {
        return '‚ö†Ô∏è Insufficient CT for deep RAG lookup. Use Top-up in Settings to continue.';
      }
    }

    // ‚îÄ‚îÄ Agent-to-connector relevance map ‚îÄ‚îÄ
    const connectorMap = {
      'ppc-specialist':        ['Google Ads', 'Meta Ads', 'Twitter/X Ads'],
      'seo-content':           ['Google Analytics 4', 'Google Tag Manager'],
      'creative-director':     ['Meta Ads', 'Google Ads'],
      'social-media':          ['Meta Ads', 'Twitter/X Ads', 'Telegram'],
      'performance-analytics': ['Google Analytics 4', 'Google Tag Manager', 'Google Ads', 'Datadog'],
      'ceo-strategy':          ['Google Analytics 4', 'Stripe', 'HubSpot'],
      'cto-innovation':        ['GitHub', 'GitLab', 'Google Cloud Platform', 'Microsoft Azure'],
      'cmo-growth':            ['Google Ads', 'Meta Ads', 'Google Analytics 4', 'Mailchimp', 'Klaviyo', 'HubSpot'],
      'cfo-finance':           ['Stripe', 'PayPal', 'Shopify'],
      'coo-operations':        ['Notion', 'Todoist', 'Stripe', 'HubSpot', 'Pipedrive'],
      'devops-infra':          ['GitHub', 'GitHub Actions', 'Google Cloud Platform', 'Microsoft Azure', 'Vercel', 'Netlify', 'Render'],
      'fullstack-dev':         ['GitHub', 'GitLab', 'Vercel', 'Netlify', 'Sentry'],
      'backend-architect':     ['GitHub', 'Google Cloud Platform', 'Microsoft Azure', 'Datadog', 'Sentry'],
      'frontend-uiux':         ['GitHub', 'Vercel', 'Netlify', 'Sentry'],
      'security-quality':      ['Snyk', 'SonarQube', 'Sentry', 'GitHub'],
      'personal-mentor':       ['Notion', 'Todoist'],
      'fitness-wellness':      ['Strava'],
      'creative-muse':         ['Notion'],
    };
    const relevantConnectors = connectorMap[agentSlug] || [];

    // ‚îÄ‚îÄ Phase 1: Prioritized API docs from relevant connectors ‚îÄ‚îÄ
    let apiDocsFound = 0;
    if (relevantConnectors.length > 0) {
      for (const connector of relevantConnectors.slice(0, 3)) {
        try {
          const res = await fetch(`/api/rag/api-docs?q=${encodeURIComponent(query)}&connector=${encodeURIComponent(connector)}&limit=2`);
          if (res.ok) {
            const results = await res.json();
            if (results.length > 0 && apiDocsFound === 0) {
              context += 'üìö **Relevant API Documentation:**\n\n';
            }
            results.forEach(r => {
              const cleanTitle = (r.title || r.connector).replace(/\u00a0/g, ' ').substring(0, 80);
              context += `üìñ <a href="${r.url}" target="_blank" class="text-info">${cleanTitle}</a> <small class="text-muted">(${r.connector} ‚Äì ${r.section_type})</small>\n`;
              context += `${(r.content_preview || '').substring(0, 300)}...\n\n`;
              apiDocsFound++;
            });
          }
        } catch (err) {
          console.error(`API docs error for ${connector}:`, err);
        }
        if (apiDocsFound >= 3) break;
      }
    }

    // ‚îÄ‚îÄ Phase 2: Fallback general API docs if no connector-specific results ‚îÄ‚îÄ
    if (apiDocsFound === 0) {
      try {
        const res = await fetch(`/api/rag/api-docs?q=${encodeURIComponent(query)}&limit=3`);
        if (res.ok) {
          const results = await res.json();
          if (results.length > 0) {
            context += 'üìö **API Documentation:**\n\n';
            results.forEach(r => {
              const cleanTitle = (r.title || r.connector).replace(/\u00a0/g, ' ').substring(0, 80);
              context += `üìñ <a href="${r.url}" target="_blank" class="text-info">${cleanTitle}</a> <small class="text-muted">(${r.connector} ‚Äì ${r.section_type})</small>\n`;
              context += `${(r.content_preview || '').substring(0, 300)}...\n\n`;
            });
          }
        }
      } catch (err) {
        console.error('General API docs RAG error:', err);
      }
    }

    // ‚îÄ‚îÄ Phase 3: Knowledge base (McKinsey/BCG reports) ‚îÄ‚îÄ
    try {
      const res = await fetch(`/api/rag/search?q=${encodeURIComponent(query)}&limit=2`);
      if (res.ok) {
        const chunks = await res.json();
        if (chunks.length > 0) {
          context += 'üìä **Insights from Knowledge Base:**\n\n';
          chunks.forEach(c => {
            context += `**${c.title}** <small class="text-muted">(${c.source})</small>\n${c.summary}\n${c.content.substring(0, 300)}...\n\n`;
          });
        }
      }
    } catch (err) {
      console.error('Knowledge base RAG error:', err);
    }

    return context;
  }

  async function mockAgentResponse(userMsg) {
    // Typing indicator
    const typing = document.createElement('div');
    typing.className = 'text-start mb-3';
    typing.innerHTML = `<div class="d-inline-block p-3 rounded bg-secondary text-light"><i class="bi bi-three-dots"></i> Thinking...</div>`;
    testChat.appendChild(typing);
    testChat.scrollTop = testChat.scrollHeight;

    // Try real backend first (includes simulate_response + connector-specific RAG)
    try {
      const wsMap = {
        'ppc-specialist': 'agency', 'seo-content': 'agency', 'creative-director': 'agency',
        'social-media': 'agency', 'performance-analytics': 'agency',
        'ceo-strategy': 'business', 'cto-innovation': 'business', 'cmo-growth': 'business',
        'cfo-finance': 'business', 'coo-operations': 'business',
        'life-coach': 'personal', 'psychologist': 'personal', 'personal-mentor': 'personal',
        'fitness-wellness': 'personal', 'creative-muse': 'personal',
        'devops-infra': 'development', 'fullstack-dev': 'development',
        'backend-architect': 'development', 'frontend-uiux': 'development',
        'security-quality': 'development'
      };
      const ws = wsMap[agentSlug] || 'agency';

      const res = await fetch(`/chat/${ws}/${agentSlug}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: userMsg })
      });

      if (res.ok) {
        const data = await res.json();
        typing.remove();

        let fullResponse = data.response_html || data.response || 'No response';

        // Check if backend already included API docs (from get_api_docs_context)
        const hasBackendDocs = fullResponse.includes('üìö') || fullResponse.includes('Relevant API Documentation');

        // If backend didn't include docs, fetch client-side RAG for extra richness
        if (!hasBackendDocs) {
          const ragContext = await getRagContext(userMsg);
          if (ragContext) {
            fullResponse += '\n\n---\n\n' + ragContext;
          }
        }

        addMessage('assistant', fullResponse);
        return;
      }
    } catch (err) {
      console.warn('Backend POST failed, falling back to client RAG:', err);
    }

    // Fallback: client-side RAG only (with connector prioritization)
    const ragContext = await getRagContext(userMsg);
    typing.remove();

    let response = `**${agentName}** (using ${llmChoice}):\n\n`;
    if (ragContext) {
      response += ragContext + '\n\n---\n\n';
      response += `üí° **Analysis:** Based on the documentation and knowledge above, here are key takeaways for "${userMsg}":\n`;
      response += `- Review the linked documentation for implementation details\n`;
      response += `- Apply the insights to your specific use case\n`;
      response += `- Need deeper analysis? Ask a more specific question.\n`;
    } else {
      response += `Regarding "${userMsg}": I'm working on this. Try asking about specific topics related to my connected tools for richer context.`;
    }
    addMessage('assistant', response);
  }

  function estimateAgentChatCost(message) {
    const text = String(message || '');
    const lower = text.toLowerCase();
    let cost = 5;

    const looksHeavy = text.length > 50
      || text.includes('?')
      || /(how|list|campaign|api|roas|budget|ctr|conversion|report|connector|seo|ga4|google ads)/i.test(text);
    if (looksHeavy) {
      const heavyBonus = 15 + (Math.floor(text.length / 100) * 5);
      cost += Math.max(15, Math.min(30, heavyBonus));
    }

    const looksToolish = /(generate|create|build|run|export|sync|fetch|webhook|deploy|boardroom|asset)/i.test(lower);
    if (looksToolish) cost += 20;

    return cost;
  }

  // Send message
  testSend.onclick = async () => {
    const msg = testInput.value.trim();
    if (!msg) return;

    const msgCost = estimateAgentChatCost(msg);
    if (window.spendCT && typeof window.spendCT === 'function') {
      const spend = await window.spendCT(msgCost, 'chat_message', 'Agent detail chat: ' + msg.substring(0, 80), { silentSuccess: true });
      if (!spend || spend.success !== true) {
        return;
      }
    }

    addMessage('user', msg);
    testInput.value = '';
    suppressTurnRagSpend = true;
    try {
      await mockAgentResponse(msg);
    } finally {
      suppressTurnRagSpend = false;
      if (window.updateBalance && typeof window.updateBalance === 'function') {
        window.updateBalance();
      }
    }
  };

  testInput.onkeydown = e => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      testSend.click();
    }
  };

  function clearAgentMemory() {
    if (confirm('Clear conversation history?')) {
      conversation = [];
      localStorage.removeItem(`agent_${agentSlug}_chat`);
      loadConversation();
    }
  }

  // Load ini»õial
  loadConversation();
  loadAgentConfig();

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // ‚îÄ‚îÄ AVATAR SYSTEM INITIALIZATION (Level 2) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  var currentExpression = 'neutral';
  var hasCustomPhoto = false;
  
  function initAvatar() {
    var container = document.getElementById('avatarContainer');
    if (!container || !window.CamaradAvatars) return;
    
    var profile = window.CamaradAvatars.getProfile(agentSlug);
    if (profile) {
      container.style.setProperty('--avatar-accent', profile.accentColor);
      document.getElementById('agentTitle').style.setProperty('--avatar-accent', profile.accentColor);
      document.getElementById('avatarPhotoWrap').style.setProperty('--avatar-accent', profile.accentColor);
    }
    
    window.CamaradAvatars.render(container, agentSlug, {
      size: 96,
      expression: currentExpression,
      animate: true
    });
    
    // Start expression cycling for "alive" feel
    window.CamaradAvatars.startExpressionCycle(container, agentSlug, 10000);
  }
  
  function showSVGAvatar() {
    document.getElementById('avatarContainer').style.display = 'flex';
    document.getElementById('avatarPhotoWrap').style.display = 'none';
    document.getElementById('removePhotoBtn').style.display = 'none';
    hasCustomPhoto = false;
    initAvatar();
  }
  
  function showPhotoAvatar(src) {
    document.getElementById('avatarContainer').style.display = 'none';
    document.getElementById('avatarPhotoWrap').style.display = 'block';
    document.getElementById('avatarPreview').src = src;
    document.getElementById('removePhotoBtn').style.display = 'inline-block';
    hasCustomPhoto = true;
  }
  
  window.removeCustomPhoto = function() {
    if (!confirm('Remove custom photo and restore SVG avatar?')) return;
    showSVGAvatar();
    // Save removal to DB
    saveAgentConfig({ avatar_base64: null });
    if (window.showToast) window.showToast('Photo Removed', 'SVG avatar restored.', 'info', 2000);
  };
  
  // Expression picker buttons
  var exprPicker = document.getElementById('exprPicker');
  if (exprPicker) {
    exprPicker.querySelectorAll('.expr-btn').forEach(function(btn) {
      btn.addEventListener('click', function() {
        exprPicker.querySelectorAll('.expr-btn').forEach(function(b) { b.classList.remove('active'); });
        btn.classList.add('active');
        currentExpression = btn.getAttribute('data-expr');
        var container = document.getElementById('avatarContainer');
        if (container && window.CamaradAvatars) {
          window.CamaradAvatars.setExpression(container, agentSlug, currentExpression);
          container.querySelector('svg').classList.add('avatar-expression-swap');
        }
      });
    });
  }
  
  // Init avatar on load
  initAvatar();

  // ‚îÄ‚îÄ Avatar Customization Logic (Level 2: DB-persisted) ‚îÄ‚îÄ
  var avatarCustom = null;
  
  function applyCustomColors() {
    if (!avatarCustom || !window.CamaradAvatars) return;
    var p = window.CamaradAvatars.PROFILES[agentSlug];
    if (!p) return;
    if (avatarCustom.accent) {
      p.accentColor = avatarCustom.accent;
      document.getElementById('avatarContainer').style.setProperty('--avatar-accent', avatarCustom.accent);
      document.getElementById('agentTitle').style.setProperty('--avatar-accent', avatarCustom.accent);
      document.getElementById('avatarPhotoWrap').style.setProperty('--avatar-accent', avatarCustom.accent);
    }
    if (avatarCustom.skin) p.skinTone = avatarCustom.skin;
    if (avatarCustom.hair) p.hairColor = avatarCustom.hair;
    initAvatar();
  }
  
  // Initialize swatch click handlers
  function setupSwatches(groupId, propKey) {
    var group = document.getElementById(groupId);
    if (!group) return;
    group.querySelectorAll('.color-swatch').forEach(function(sw) {
      sw.addEventListener('click', function() {
        group.querySelectorAll('.color-swatch').forEach(function(s) { s.classList.remove('active'); });
        sw.classList.add('active');
        if (!avatarCustom) avatarCustom = {};
        avatarCustom[propKey] = sw.getAttribute('data-color');
        applyCustomColors();
      });
    });
    // Highlight current
    if (avatarCustom && avatarCustom[propKey]) {
      var active = group.querySelector('[data-color="' + avatarCustom[propKey] + '"]');
      if (active) active.classList.add('active');
    } else if (window.CamaradAvatars) {
      var profile = window.CamaradAvatars.getProfile(agentSlug);
      if (profile) {
        var colorMap = { accent: profile.accentColor, skin: profile.skinTone, hair: profile.hairColor };
        var active = group.querySelector('[data-color="' + colorMap[propKey] + '"]');
        if (active) active.classList.add('active');
      }
    }
  }
  
  setupSwatches('accentSwatches', 'accent');
  setupSwatches('skinSwatches', 'skin');
  setupSwatches('hairSwatches', 'hair');
  
  if (avatarCustom) applyCustomColors();
  
  window.saveAvatarCustomization = function() {
    // Save to DB via API (not just localStorage)
    saveAgentConfig({ avatar_colors: avatarCustom || {} });
    if (window.showToast) window.showToast('Avatar Saved', 'Custom avatar colors persisted to database.', 'success', 2500);
  };
  
  window.resetAvatarToDefault = function() {
    avatarCustom = null;
    // Clear from DB
    saveAgentConfig({ avatar_colors: null });
    if (window.showToast) window.showToast('Avatar Reset', 'Restoring default avatar...', 'info', 1500);
    setTimeout(function() { location.reload(); }, 800);
  };

  async function loadAgentConfig() {
    try {
      const res = await fetch(`/api/agents/${agentSlug}`);
      const config = await res.json();
      
      // Load general
      if (config.custom_name) {
        document.getElementById('agentName').value = config.custom_name;
        document.getElementById('agentTitle').textContent = config.custom_name;
      }
      
      // Load LLM
      if (config.llm_provider) document.getElementById('llmProvider').value = config.llm_provider;
      if (config.llm_model) document.getElementById('llmModel').value = config.llm_model;
      if (config.temperature) document.getElementById('temperature').value = config.temperature;
      if (config.api_key) document.getElementById('apiKey').value = config.api_key;
      if (config.max_tokens) document.getElementById('maxTokens').value = config.max_tokens;
      updateTempValue();

      // Load knowledge
      if (config.rag_enabled !== undefined) document.getElementById('ragToggle').checked = config.rag_enabled;

      // Load avatar ‚Äî if custom uploaded image exists, show it; otherwise keep SVG
      if (config.avatar_base64) {
        showPhotoAvatar('data:image/png;base64,' + config.avatar_base64);
      }
      
      // Load avatar colors from DB (Level 2)
      if (config.avatar_colors && typeof config.avatar_colors === 'object') {
        avatarCustom = config.avatar_colors;
        applyCustomColors();
        // Highlight active swatches
        ['accent', 'skin', 'hair'].forEach(function(key) {
          var groupId = key === 'accent' ? 'accentSwatches' : key === 'skin' ? 'skinSwatches' : 'hairSwatches';
          var group = document.getElementById(groupId);
          if (group && avatarCustom[key]) {
            var active = group.querySelector('[data-color="' + avatarCustom[key] + '"]');
            if (active) active.classList.add('active');
          }
        });
      }
      
      // Status
      if (config.status) document.getElementById('agentStatus').checked = config.status === 'Active';
    } catch (err) {
      console.error('Error loading config', err);
    }
  }

  // Avatar upload preview and save
  document.getElementById('avatarUpload').addEventListener('change', function(event) {
    const file = event.target.files[0];
    if (file) {
      if (file.size > 2 * 1024 * 1024) {
        if (window.showToast) window.showToast('File Too Large', 'Max 2MB. Please resize your image.', 'warning');
        return;
      }
      const reader = new FileReader();
      reader.onload = function(e) {
        showPhotoAvatar(e.target.result);
        // Save to DB
        const base64 = e.target.result.split(',')[1];
        saveAgentConfig({ avatar_base64: base64 });
        if (window.showToast) window.showToast('Photo Uploaded', 'Custom avatar photo saved. Visible across all views.', 'success', 3000);
      };
      reader.readAsDataURL(file);
    }
  });

  // Save agent config to DB
  async function saveAgentConfig(extraData = {}) {
    const config = {
      custom_name: document.getElementById('agentName').value,
      avatar_base64: extraData.avatar_base64 !== undefined ? extraData.avatar_base64 : (hasCustomPhoto ? document.getElementById('avatarPreview').src.split(',')[1] : null),
      avatar_colors: extraData.avatar_colors !== undefined ? extraData.avatar_colors : avatarCustom,
      llm_provider: document.getElementById('llmProvider').value,
      llm_model: document.getElementById('llmModel').value,
      api_key: document.getElementById('apiKey').value,
      temperature: parseFloat(document.getElementById('temperature').value),
      max_tokens: parseInt(document.getElementById('maxTokens').value),
      rag_enabled: document.getElementById('ragToggle').checked,
      status: document.getElementById('agentStatus').checked ? 'Active' : 'Inactive',
      ...extraData
    };

    try {
      const res = await fetch(`/api/agents/${agentSlug}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(config)
      });
      if (res.ok) {
        if (window.showToast) window.showToast('Saved', 'Agent configuration saved to database.', 'success', 2000);
        // Update title display if custom name changed
        var nameInput = document.getElementById('agentName').value;
        if (nameInput) document.getElementById('agentTitle').textContent = nameInput;
      } else {
        if (window.showToast) window.showToast('Error', 'Failed to save agent config.', 'danger');
      }
    } catch (err) {
      if (window.showToast) window.showToast('Network Error', err.message, 'danger');
    }
  }

  // Mock save functions (now use unified save)
  function saveGeneral() {
    saveAgentConfig();
  }

  function saveLLM() {
    saveAgentConfig();
  }

  function saveKnowledge() {
    saveAgentConfig();
  }

  function uploadDocs() {
    if (window.showToast) window.showToast('Documents Ingested', 'Files uploaded and processed for RAG (mock).', 'success', 2500);
  }

  function startTraining() {
    if (window.showToast) window.showToast('Training Started', 'Fine-tuning job queued. ETA ~15min (mock).', 'info', 3000);
  }

  function saveFunctions() {
    if (window.showToast) window.showToast('Functions Saved', 'Tool integrations updated (mock).', 'success', 2000);
  }

  function addCustomFunction() {
    if (window.showToast) window.showToast('Custom Function', 'Function template added (mock).', 'info', 2000);
  }

  // Update temp value
  function updateTempValue() {
    document.getElementById('tempValue').textContent = document.getElementById('temperature').value;
  }

  // Load config on load
  window.addEventListener('DOMContentLoaded', loadAgentConfig);
</script>

<style>
  /* Core fix: for»õeazƒÉ text light pe fundal dark */
  body, .modal-content, .card, .list-group-item, .tab-pane {
    color: #e0e0e0 !important; /* gri-deschis pentru text principal */
  }

  .card-body, .card-title, .card-text, h5, h6, .form-label, .nav-link {
    color: #ffffff !important; /* alb pur pentru titluri »ôi label-uri */
  }

  .text-muted {
    color: #a0a0a0 !important; /* gri mediu pentru muted text */
  }

  .bg-dark {
    background-color: #0d1117 !important; /* fundal consistent */
  }

  .form-control, .form-select {
    background-color: #161b22 !important;
    color: #ffffff !important;
    border-color: #30363d !important;
  }

  .form-control:focus, .form-select:focus {
    border-color: #58a6ff !important;
    box-shadow: 0 0 0 0.25rem rgba(88,166,255,0.25) !important;
  }

  /* Fix badge contrast */
  .badge.bg-success {
    background-color: #238636 !important;
    color: white !important;
  }

  .badge.bg-warning {
    background-color: #bb8009 !important;
    color: white !important;
  }

  .badge.bg-danger {
    background-color: #c94a4a !important;
    color: white !important;
  }

  /* Sidebar »ôi active state */
  .sidebar .nav-link.active {
    background-color: #21262d !important;
    color: #ffffff !important;
  }

  /* Card hover fix */
  .card:hover {
    border-color: #58a6ff !important;
    box-shadow: 0 0 15px rgba(88,166,255,0.3) !important;
  }
</style>
{% endblock %}
