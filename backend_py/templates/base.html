<!doctype html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  {% if google_site_verification %}
  <meta name="google-site-verification" content="{{ google_site_verification }}">
  {% endif %}
  {% if gtm_container_id %}
  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','{{ gtm_container_id }}');</script>
  <!-- End Google Tag Manager -->
  {% endif %}
  <title>Camarad.AI - {% block title %}{% endblock %}</title>
  <link rel="icon" type="image/x-icon" href="/static/brand/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/static/brand/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/static/brand/favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/static/brand/apple-touch-icon.png">
  <link rel="manifest" href="/static/brand/site.webmanifest">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="/static/css/avatars.css" rel="stylesheet">
  <style>
    body { background: #0d1117; color: #e0e0e0; font-family: system-ui, sans-serif; }
    #sidebar {
      position: fixed;
      top: 0;
      left: 0;
      bottom: 0;
      width: 280px;
      background: #0d1117;
      border-right: 1px solid #30363d;
      overflow: hidden;
      z-index: 1000;
      transition: transform 0.3s ease;
    }
    .sidebar-scroll {
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      padding: 0.75rem 0.75rem 0 0.75rem;
    }
    .sidebar-footer-dock {
      position: relative;
      border-top: 1px solid #30363d;
      padding: 0.75rem;
      background: linear-gradient(180deg, #111820, #0d1117);
    }
    main {
      margin-left: 280px;
      transition: margin-left 0.3s ease;
    }
    .user-chip-btn {
      border-color: #2f81f7;
      color: #c9d1d9;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      background: linear-gradient(180deg, #0f1724, #0d1117);
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.25);
    }
    .user-chip-btn:hover {
      border-color: #58a6ff;
      color: #e6edf3;
      background: linear-gradient(180deg, #121c2d, #0f1520);
    }
    .user-chip-avatar {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 700;
      color: #fff;
      background: linear-gradient(135deg, #1f6feb, #58a6ff);
      border: 1px solid rgba(255, 255, 255, 0.22);
    }
    .user-chip-name {
      font-weight: 600;
      max-width: 130px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .user-chip-ct {
      font-size: 0.72rem;
      font-weight: 700;
    }
    .user-chip-meta {
      min-width: 260px;
      line-height: 1.35;
    }
    .sidebar-footer-dock .user-chip-btn {
      width: 100%;
      justify-content: flex-start;
    }
    .sidebar-footer-dock .dropdown-menu {
      width: 100%;
      min-width: 0;
    }
    .sidebar-footer-dock .user-chip-meta {
      min-width: 0;
      white-space: normal;
    }
    body.pref-compact-sidebar #sidebar {
      width: 240px;
    }
    body.pref-compact-sidebar main {
      margin-left: 240px;
    }
    body.pref-reduce-motion *,
    body.pref-reduce-motion *::before,
    body.pref-reduce-motion *::after {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
      scroll-behavior: auto !important;
    }
    @media (max-width: 992px) {
      #sidebar {
        transform: translateX(-100%);
      }
      #sidebar.show {
        transform: translateX(0);
      }
      main {
        margin-left: 0 !important;
      }
    }
    .nav-link {
      color: #e0e0e0 !important;
    }
    .nav-link:hover, .nav-link.active {
      background: #21262d !important;
      color: #ffffff !important;
    }
    .card {
      background: #161b22;
      border: 1px solid #30363d;
    }
    .card:hover {
      border-color: #58a6ff;
      box-shadow: 0 0 15px rgba(88,166,255,0.3);
    }
    /* ── Toast Notifications ── */
    #toast-container {
      position: fixed;
      top: 16px;
      right: 16px;
      z-index: 11000;
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-width: 380px;
    }
    .camarad-toast {
      padding: 12px 18px;
      border-radius: 10px;
      color: #fff;
      font-size: 0.9rem;
      display: flex;
      align-items: flex-start;
      gap: 10px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
      animation: toastSlideIn 0.35s ease;
      cursor: pointer;
      transition: opacity 0.3s, transform 0.3s;
    }
    .camarad-toast:hover { opacity: 0.85; }
    .camarad-toast.toast-success { background: linear-gradient(135deg, #238636, #2ea043); }
    .camarad-toast.toast-info    { background: linear-gradient(135deg, #1f6feb, #58a6ff); }
    .camarad-toast.toast-warning { background: linear-gradient(135deg, #9e6a03, #d29922); }
    .camarad-toast.toast-error   { background: linear-gradient(135deg, #da3633, #f85149); }
    .camarad-toast.toast-push    { background: linear-gradient(135deg, #6e40c9, #8957e5); }
    .camarad-toast.toast-exit {
      opacity: 0;
      transform: translateX(100%);
    }
    @keyframes toastSlideIn {
      from { opacity: 0; transform: translateX(100%); }
      to   { opacity: 1; transform: translateX(0); }
    }
    .toast-icon { font-size: 1.2rem; flex-shrink: 0; margin-top: 1px; }
    .toast-body { flex: 1; }
    .toast-title { font-weight: 600; font-size: 0.85rem; margin-bottom: 2px; }
    .toast-msg { font-size: 0.82rem; opacity: 0.9; }
    .toast-time { font-size: 0.7rem; opacity: 0.6; margin-top: 2px; }
    /* ── Notification History Panel ── */
    #notif-panel {
      position: fixed;
      top: 0; right: -380px;
      width: 380px; height: 100vh;
      background: #161b22;
      border-left: 1px solid #30363d;
      z-index: 10500;
      transition: right 0.3s ease;
      display: flex;
      flex-direction: column;
    }
    #notif-panel.open { right: 0; }
    #notif-panel .notif-header {
      padding: 16px;
      border-bottom: 1px solid #30363d;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #notif-panel .notif-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }
    .notif-item {
      padding: 10px 12px;
      border-radius: 8px;
      margin-bottom: 6px;
      font-size: 0.85rem;
      border-left: 3px solid;
      background: #0d1117;
    }
    .notif-item.n-success { border-color: #2ea043; }
    .notif-item.n-info    { border-color: #58a6ff; }
    .notif-item.n-warning { border-color: #d29922; }
    .notif-item.n-error   { border-color: #f85149; }
    .notif-item.n-push    { border-color: #8957e5; }
    .notif-item .notif-time { font-size: 0.7rem; color: #8b949e; }
    #notif-badge {
      position: absolute;
      top: -4px; right: -4px;
      background: #f85149;
      color: #fff;
      border-radius: 50%;
      width: 18px; height: 18px;
      font-size: 0.65rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
    }
    /* Active Context Radar Widget */
    #acx-widget {
      position: fixed;
      right: 18px;
      bottom: 18px;
      z-index: 10920;
      pointer-events: none;
    }
    #acx-widget * {
      box-sizing: border-box;
    }
    .acx-compact {
      position: relative;
      width: 124px;
      height: 124px;
      border-radius: 50%;
      overflow: hidden;
      border: 1px solid #30363d;
      background: #0d1117;
      box-shadow: 0 14px 28px rgba(0, 0, 0, 0.45);
      pointer-events: auto;
      transition: transform 0.2s ease, opacity 0.2s ease, box-shadow 0.2s ease;
      user-select: none;
    }
    .acx-compact:hover {
      transform: translateY(-2px);
      box-shadow: 0 18px 34px rgba(0, 0, 0, 0.52);
    }
    .acx-compact.is-dimmed {
      opacity: 0.35;
    }
    .acx-quadrant {
      position: absolute;
      width: 50%;
      height: 50%;
      border: 0;
      color: #fff;
      margin: 0;
      padding: 7px 6px 5px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      align-items: center;
      font-size: 0.64rem;
      cursor: pointer;
      transition: filter 0.2s ease, transform 0.2s ease;
    }
    .acx-quadrant:hover,
    .acx-quadrant:focus-visible,
    .acx-quadrant.active {
      filter: brightness(1.08);
      transform: scale(1.03);
      z-index: 2;
    }
    .acx-q-development {
      top: 0;
      left: 0;
      border-top-left-radius: 999px;
      background: linear-gradient(150deg, #198754, #0f5132);
    }
    .acx-q-personal {
      top: 0;
      right: 0;
      border-top-right-radius: 999px;
      background: linear-gradient(150deg, #6c757d, #495057);
    }
    .acx-q-agency {
      left: 0;
      bottom: 0;
      border-bottom-left-radius: 999px;
      background: linear-gradient(150deg, #fd7e14, #c95f00);
    }
    .acx-q-business {
      right: 0;
      bottom: 0;
      border-bottom-right-radius: 999px;
      background: linear-gradient(150deg, #0d6efd, #0b5ed7);
    }
    .acx-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
      opacity: 0.95;
      font-size: 0.9rem;
    }
    .acx-kpi {
      font-weight: 700;
      font-size: 0.7rem;
      line-height: 1;
      letter-spacing: 0.02em;
    }
    .acx-bar {
      width: 88%;
      height: 3px;
      border-radius: 999px;
      overflow: hidden;
      background: rgba(255, 255, 255, 0.28);
    }
    .acx-fill {
      display: block;
      height: 100%;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 999px;
      transition: width 0.25s ease;
    }
    .acx-center {
      position: absolute;
      inset: 34px;
      border: 1px solid rgba(255, 255, 255, 0.22);
      border-radius: 50%;
      background: radial-gradient(circle at 36% 28%, rgba(97, 218, 251, 0.2), rgba(18, 24, 32, 0.95) 68%);
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      line-height: 1;
      box-shadow: inset 0 0 14px rgba(0, 0, 0, 0.35);
      cursor: pointer;
      transition: transform 0.2s ease, border-color 0.2s ease;
      z-index: 3;
      padding: 0;
    }
    .acx-center:hover,
    .acx-center:focus-visible {
      transform: scale(1.04);
      border-color: rgba(88, 166, 255, 0.7);
    }
    .acx-center-label {
      font-size: 0.55rem;
      opacity: 0.78;
      margin-bottom: 2px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }
    .acx-center-score {
      font-weight: 700;
      font-size: 0.92rem;
    }
    #acx-tooltip {
      position: absolute;
      right: 132px;
      bottom: 48px;
      min-width: 184px;
      max-width: 260px;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #30363d;
      background: #161b22;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.45);
      color: #dbe4ee;
      font-size: 0.75rem;
      line-height: 1.35;
      opacity: 0;
      transform: translateX(8px);
      pointer-events: none;
      transition: opacity 0.18s ease, transform 0.18s ease;
    }
    #acx-tooltip.show {
      opacity: 1;
      transform: translateX(0);
    }
    .acx-panel {
      position: fixed;
      right: 18px;
      bottom: 18px;
      width: min(460px, calc(100vw - 28px));
      max-height: min(78vh, 520px);
      background: #0f141b;
      border: 1px solid #30363d;
      border-radius: 14px;
      box-shadow: 0 22px 45px rgba(0, 0, 0, 0.55);
      padding: 14px;
      overflow-y: auto;
      display: none;
      pointer-events: auto;
    }
    .acx-panel.show {
      display: block;
    }
    .acx-panel-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      gap: 12px;
    }
    .acx-panel-title {
      font-size: 1rem;
      margin: 0;
      color: #f0f6fc;
      font-weight: 600;
    }
    .acx-overview {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 10px;
      padding: 10px 12px;
      border: 1px solid #30363d;
      border-radius: 10px;
      background: rgba(13, 17, 23, 0.88);
    }
    .acx-overview-score {
      display: flex;
      flex-direction: column;
      line-height: 1.1;
    }
    .acx-overview-score .value {
      font-size: 1.3rem;
      font-weight: 700;
      color: #8db9ff;
    }
    .acx-overview-score .label {
      font-size: 0.7rem;
      color: #8b949e;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }
    .acx-overview-meta {
      font-size: 0.76rem;
      color: #9ca8b8;
      text-align: right;
      line-height: 1.35;
    }
    .acx-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }
    .acx-card {
      border: 1px solid #30363d;
      border-radius: 10px;
      background: #161b22;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 176px;
      transition: border-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
      cursor: pointer;
    }
    .acx-card:hover {
      border-color: #4f6077;
      transform: translateY(-1px);
    }
    .acx-card.is-focused {
      border-color: #58a6ff;
      box-shadow: 0 0 0 1px rgba(88, 166, 255, 0.35);
    }
    .acx-card-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .acx-card-title {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.86rem;
      font-weight: 600;
      color: #f0f6fc;
      min-width: 0;
    }
    .acx-score {
      font-weight: 700;
      font-size: 0.98rem;
      line-height: 1;
    }
    .acx-card[data-ws="personal"] .acx-score { color: #b8c0cc; }
    .acx-card[data-ws="business"] .acx-score { color: #4ea1ff; }
    .acx-card[data-ws="agency"] .acx-score { color: #ffb066; }
    .acx-card[data-ws="development"] .acx-score { color: #4ed597; }
    .acx-card-summary {
      font-size: 0.74rem;
      color: #b4bfcd;
      line-height: 1.32;
      min-height: 28px;
    }
    .acx-kpi-list {
      display: grid;
      gap: 4px;
    }
    .acx-kpi-item {
      font-size: 0.72rem;
      color: #9eabbc;
      line-height: 1.3;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .acx-alert {
      font-size: 0.71rem;
      color: #d0d9e6;
      padding: 5px 6px;
      border-left: 3px solid #58a6ff;
      background: rgba(13, 17, 23, 0.65);
      border-radius: 6px;
      line-height: 1.3;
      min-height: 34px;
    }
    .acx-actions {
      margin-top: auto;
      display: flex;
      gap: 6px;
    }
    .acx-actions .btn {
      font-size: 0.69rem;
      padding: 4px 7px;
      line-height: 1.2;
      white-space: nowrap;
    }
    body.acx-global-enabled #activeContextWidget,
    body.acx-global-enabled #activeContextLauncher {
      display: none !important;
    }
    @media (max-width: 992px) {
      #acx-widget {
        right: 12px;
        bottom: 12px;
      }
      .acx-panel {
        right: 12px;
        bottom: 12px;
        width: min(460px, calc(100vw - 24px));
      }
    }
    @media (max-width: 768px) {
      .acx-compact {
        width: 108px;
        height: 108px;
      }
      .acx-center {
        inset: 29px;
      }
      .acx-center-score {
        font-size: 0.82rem;
      }
      #acx-tooltip {
        display: none !important;
      }
      .acx-panel {
        left: 12px;
        right: 12px;
        width: auto;
        max-height: 72vh;
      }
      .acx-grid {
        grid-template-columns: 1fr;
      }
    }
    /* Active Context Drawer Overrides */
    #acx-widget {
      position: fixed;
      top: calc(50% - 46px);
      right: 2px;
      bottom: auto;
      width: 14px;
      transform: none;
    }
    .acx-compact {
      margin-left: 8px;
      width: 6px;
      height: 92px;
      display: grid;
      grid-template-rows: repeat(4, minmax(0, 1fr));
      border-radius: 999px;
      overflow: hidden;
      border: 1px solid rgba(48, 54, 61, 0.68);
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.34);
      background: #0d1117;
      opacity: 0.58;
      transition: opacity 0.18s ease, box-shadow 0.2s ease;
    }
    .acx-compact:hover,
    .acx-compact:focus-within {
      transform: none;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.42);
      opacity: 0.92;
    }
    .acx-compact.is-dimmed {
      opacity: 0.2;
    }
    .acx-quadrant {
      position: static;
      width: auto;
      height: auto;
      padding: 0;
      margin: 0;
      border: 0;
      border-radius: 0;
      transition: opacity 0.2s ease, filter 0.2s ease;
      transform: none;
      min-width: 0;
      min-height: 0;
    }
    .acx-quadrant + .acx-quadrant {
      border-top: 1px solid rgba(255, 255, 255, 0.16);
    }
    .acx-q-personal,
    .acx-q-business,
    .acx-q-agency,
    .acx-q-development {
      top: auto;
      right: auto;
      bottom: auto;
      left: auto;
      border-radius: 0;
    }
    .acx-q-personal {
      background: linear-gradient(180deg, #7b838a, #656e76);
    }
    .acx-q-business {
      background: linear-gradient(180deg, #2b79ff, #0d6efd);
    }
    .acx-q-agency {
      background: linear-gradient(180deg, #ff973e, #fd7e14);
    }
    .acx-q-development {
      background: linear-gradient(180deg, #2ba56f, #198754);
    }
    .acx-quadrant:hover,
    .acx-quadrant:focus-visible,
    .acx-quadrant.active {
      transform: none;
      filter: brightness(1.08);
    }
    .acx-icon,
    .acx-kpi,
    .acx-bar,
    .acx-center,
    .acx-center-label,
    .acx-center-score {
      display: none !important;
    }
    #acx-tooltip {
      min-width: 184px;
      max-width: 244px;
      right: 16px;
      top: 50%;
      bottom: auto;
      font-size: 0.72rem;
      line-height: 1.35;
      transform: translate(-6px, -50%);
    }
    #acx-tooltip.show {
      transform: translate(0, -50%);
    }
    .acx-tip-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }
    .acx-tip-row:last-child {
      margin-bottom: 0;
    }
    .acx-tip-name {
      color: #c9d1d9;
      font-size: 0.71rem;
      letter-spacing: 0.02em;
    }
    .acx-tip-value {
      font-weight: 700;
      color: #f0f6fc;
      font-size: 0.74rem;
      min-width: 40px;
      text-align: right;
    }
    .acx-tip-foot {
      margin-top: 6px;
      padding-top: 6px;
      border-top: 1px solid rgba(139, 148, 158, 0.28);
      color: #8b949e;
      font-size: 0.68rem;
    }
    .acx-maturity-wrap {
      border: 1px solid #30363d;
      border-radius: 10px;
      background: #0d1117;
      padding: 10px;
    }
    .acx-maturity-ring {
      position: relative;
      width: 156px;
      height: 156px;
      border-radius: 50%;
      margin: 0 auto;
      display: grid;
      place-items: center;
    }
    .acx-maturity-ring::before {
      content: '';
      position: absolute;
      inset: 22px;
      border-radius: 50%;
      background: #0f141b;
      border: 1px solid #30363d;
      box-shadow: inset 0 0 12px rgba(0, 0, 0, 0.45);
    }
    .acx-maturity-core {
      position: relative;
      z-index: 1;
      text-align: center;
      line-height: 1;
    }
    .acx-maturity-core strong {
      display: block;
      font-size: 1.05rem;
      color: #dbe5f3;
      letter-spacing: 0.02em;
    }
    .acx-maturity-core small {
      color: #8b949e;
      font-size: 0.62rem;
      letter-spacing: 0.05em;
    }
    .acx-maturity-legend {
      margin-top: 10px;
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 6px 8px;
    }
    .acx-maturity-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      font-size: 0.72rem;
      color: #b5c1cf;
    }
    .acx-maturity-item .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 5px;
      display: inline-block;
      box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.12);
    }
    .acx-maturity-item .label {
      display: inline-flex;
      align-items: center;
      color: #c7d1de;
    }
    .acx-maturity-item .value {
      color: #f0f6fc;
      font-weight: 700;
    }
    #acx-overlay {
      position: fixed;
      inset: 0;
      background: rgba(1, 4, 9, 0.56);
      z-index: 10910;
      display: none;
      pointer-events: none;
    }
    #acx-overlay.show {
      display: block;
      pointer-events: auto;
    }
    .acx-panel {
      top: 0;
      right: 0;
      bottom: 0;
      width: min(420px, calc(100vw - 16px));
      max-height: 100vh;
      height: 100vh;
      border-radius: 0;
      border-left: 1px solid #30363d;
      border-top: 0;
      border-right: 0;
      border-bottom: 0;
      transform: translateX(100%);
      transition: transform 0.24s ease;
      padding: 12px;
      display: block;
      pointer-events: none;
      z-index: 10930;
      overflow-y: auto;
    }
    .acx-panel.show {
      transform: translateX(0);
      pointer-events: auto;
    }
    .acx-panel-head {
      margin-bottom: 8px;
      justify-content: space-between;
    }
    .acx-head-cmi {
      font-size: 1.35rem;
      font-weight: 700;
      color: #8db9ff;
      line-height: 1;
      letter-spacing: 0.01em;
      padding-left: 2px;
    }
    .acx-panel-title,
    .acx-overview-score,
    .acx-overview-score .label {
      display: none !important;
    }
    .acx-overview {
      margin-bottom: 10px;
      padding: 6px 8px;
      background: transparent;
      border: 0;
      justify-content: flex-start;
    }
    .acx-overview-meta {
      text-align: left;
      font-size: 0.72rem;
      color: #8b949e;
    }
    .acx-grid {
      grid-template-columns: 1fr;
      gap: 8px;
    }
    .acx-card {
      min-height: auto;
    }
    .acx-selection-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border: 1px solid #30363d;
      border-radius: 999px;
      padding: 4px 9px;
      font-size: 0.73rem;
      color: #b7c2d0;
      background: #0d1117;
      margin-bottom: 8px;
      white-space: nowrap;
    }
    .acx-selection-grid {
      display: grid;
      grid-template-columns: minmax(72px, 92px) 1fr;
      gap: 6px 8px;
      margin-bottom: 10px;
    }
    .acx-selection-grid .k {
      color: #8b949e;
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    .acx-selection-grid .v {
      color: #d2dbe8;
      font-size: 0.78rem;
      line-height: 1.25;
      word-break: break-word;
    }
    @media (max-width: 768px) {
      #acx-widget {
        right: 1px;
        width: 12px;
      }
      .acx-compact {
        margin-left: 7px;
        width: 5px;
        height: 78px;
      }
      #acx-tooltip {
        right: 14px;
        top: 50%;
      }
      .acx-panel {
        width: min(420px, 100vw);
      }
      .acx-selection-grid {
        grid-template-columns: 1fr;
      }
      .acx-maturity-ring {
        width: 138px;
        height: 138px;
      }
      .acx-maturity-ring::before {
        inset: 20px;
      }
    }
  </style>
</head>
<body>
  {% if gtm_container_id %}
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id={{ gtm_container_id }}"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->
  {% endif %}
  <!-- Toast container -->
  <div id="toast-container"></div>

  <!-- Notification History Panel -->
  <div id="notif-panel">
    <div class="notif-header">
      <h6 class="mb-0 text-white"><i class="bi bi-bell me-2"></i>Notifications</h6>
      <div>
        <button class="btn btn-sm btn-outline-secondary me-1" onclick="clearNotifications()" title="Clear all"><i class="bi bi-trash"></i></button>
        <button class="btn btn-sm btn-outline-light" onclick="toggleNotifPanel()"><i class="bi bi-x-lg"></i></button>
      </div>
    </div>
    <div class="notif-list" id="notif-list">
      <p class="text-muted text-center mt-4" id="notif-empty">No notifications yet</p>
    </div>
  </div>

  <button class="btn btn-outline-light position-fixed top-0 start-0 m-3 d-lg-none z-3" type="button" onclick="document.getElementById('sidebar').classList.toggle('show')">
    <i class="bi bi-list fs-3"></i>
  </button>

  {% include "sidebar.html" %}

  <main class="p-4">
    {% block content %}{% endblock %}
  </main>
  <div id="acx-widget" aria-live="polite">
    <div id="acx-tooltip" role="status" aria-live="polite"></div>

    <div id="acx-compact" class="acx-compact" role="button" tabindex="0" aria-label="Open Inspector panel" title="Open Inspector">
      <button type="button" class="acx-quadrant acx-q-personal" data-ws="personal" data-tip="Personal: routines, focus, and engagement.">
        <span class="acx-kpi" id="acx-score-personal">78%</span>
        <span class="acx-bar"><span class="acx-fill" id="acx-bar-personal" style="width:78%"></span></span>
      </button>
      <button type="button" class="acx-quadrant acx-q-business" data-ws="business" data-tip="Business: revenue, runway, and pacing health.">
        <span class="acx-kpi" id="acx-score-business">85%</span>
        <span class="acx-bar"><span class="acx-fill" id="acx-bar-business" style="width:85%"></span></span>
      </button>
      <button type="button" class="acx-quadrant acx-q-agency" data-ws="agency" data-tip="Agency: campaign outcomes and lead velocity.">
        <span class="acx-kpi" id="acx-score-agency">68%</span>
        <span class="acx-bar"><span class="acx-fill" id="acx-bar-agency" style="width:68%"></span></span>
      </button>
      <button type="button" class="acx-quadrant acx-q-development" data-ws="development" data-tip="Development: deployments, uptime, and issue pressure.">
        <span class="acx-kpi" id="acx-score-development">92%</span>
        <span class="acx-bar"><span class="acx-fill" id="acx-bar-development" style="width:92%"></span></span>
      </button>
    </div>
  </div>

  <section id="acx-panel" class="acx-panel" aria-hidden="true">
      <div class="acx-panel-head">
        <div class="acx-head-cmi"><span id="acx-panel-score">81%</span></div>
        <button type="button" class="btn btn-sm btn-outline-light" id="acx-close-btn" aria-label="Close panel"><i class="bi bi-x-lg"></i></button>
      </div>
      <div class="acx-overview">
        <div class="acx-overview-meta" id="acx-panel-meta">Loading context...</div>
      </div>
      <div class="acx-grid" id="acx-grid"></div>
    </section>
  <div id="acx-overlay" aria-hidden="true"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/static/js/avatars.js"></script>
  <script>
    // ── Global Camarad.ai System ────────────────────────────────────
    (function() {
      var TOAST_ICONS = {
        success: 'bi-check-circle-fill',
        info:    'bi-info-circle-fill',
        warning: 'bi-exclamation-triangle-fill',
        error:   'bi-x-circle-fill',
        push:    'bi-bell-fill'
      };

      // ── Cookie helper ──
      function getCookie(name) {
        var m = document.cookie.match(new RegExp('(?:^|; )' + name + '=([^;]*)'));
        return m ? decodeURIComponent(m[1]) : null;
      }

      var uid = parseInt(getCookie('camarad_user_id') || '0', 10) || 0;
      var uname = uid > 0 ? ('user-' + uid) : 'Guest';

      function ensureAuthBoot() {
        return fetch('/api/auth/status', { credentials: 'same-origin' })
          .then(function(r) { return r.json(); })
          .then(function(st) {
            if (!st || !st.authenticated || !st.user_id) {
              var next = window.location.pathname + (window.location.search || '');
              window.location.href = '/signup?next=' + encodeURIComponent(next || '/app');
              throw new Error('unauthenticated');
            }
            uid = parseInt(st.user_id, 10) || 0;
            uname = String(st.display_name || ('user-' + uid));
            document.cookie = 'camarad_user_id=' + uid + '; path=/; max-age=2592000';
            return st;
          });
      }

      var userSettingsCache = null;
      var userSnapshotCache = null;
      var ctPricingRuntimeOverrides = null;

      function applyRuntimeUserSettings(settingsPayload) {
        var settings = settingsPayload && typeof settingsPayload === "object" ? settingsPayload : {};
        userSettingsCache = settings;

        var appearance = settings.appearance || {};
        var theme = String(appearance.theme || "dark").toLowerCase();
        document.documentElement.setAttribute("data-bs-theme", theme === "light" ? "light" : "dark");

        var prefs = settings.preferences || {};
        document.body.classList.toggle("pref-compact-sidebar", !!prefs.compact_sidebar);
        document.body.classList.toggle("pref-reduce-motion", !!prefs.reduce_motion);

        try {
          localStorage.setItem('camarad_default_workspace', String(prefs.default_workspace || 'agency').toLowerCase());
          localStorage.setItem('camarad_default_landing', String(prefs.default_landing || 'orchestrator').toLowerCase());
        } catch (e) {}

        var economy = settings.economy || {};
        var ecoCap = Number(economy.max_per_message);
        if (!isFinite(ecoCap) || ecoCap <= 0) ecoCap = 80;
        var ecoMultiplier = Number(economy.cost_multiplier);
        if (!isFinite(ecoMultiplier) || ecoMultiplier <= 0) ecoMultiplier = 1;

        ctPricingRuntimeOverrides = {
          chat_message_cap: Math.max(20, Math.min(500, ecoCap)),
          cost_multiplier: Math.max(0.1, Math.min(2, ecoMultiplier))
        };

        if (window.CamaradCTPricing && typeof window.CamaradCTPricing === 'object') {
          window.CamaradCTPricing.chat_message_cap = ctPricingRuntimeOverrides.chat_message_cap;
          window.CamaradCTPricing.cost_multiplier = ctPricingRuntimeOverrides.cost_multiplier;
        }
      }

      function normalizeWorkspaceHint(raw) {
        return String(raw || 'agency').trim().toLowerCase().replace(/\s+/g, '-');
      }

      function getDefaultWorkspaceFromSettings() {
        var prefs = (userSettingsCache && userSettingsCache.preferences) || {};
        var ws = normalizeWorkspaceHint(prefs.default_workspace || '');
        if (ws === 'personal' || ws === 'business' || ws === 'agency' || ws === 'development') {
          return ws;
        }
        try {
          var saved = normalizeWorkspaceHint(localStorage.getItem('camarad_default_workspace') || '');
          if (saved === 'personal' || saved === 'business' || saved === 'agency' || saved === 'development') {
            return saved;
          }
        } catch (e) {}
        return 'agency';
      }

      function inferToastChannel(channelHint) {
        if (channelHint) return String(channelHint).toLowerCase();
        var path = String(window.location.pathname || '').toLowerCase();
        if (path.indexOf('/chat/') === 0) return 'chat';
        if (path.indexOf('/connectors') === 0) return 'connector';
        if (path.indexOf('/boardroom') === 0) return 'boardroom';
        return 'system';
      }

      function shouldShowToastForChannel(channelHint) {
        var notif = (userSettingsCache && userSettingsCache.notifications) || {};
        if (notif.toast_enabled === false) return false;

        var channel = inferToastChannel(channelHint);
        if (channel === 'chat') return notif.chat_alerts !== false;
        if (channel === 'connector') return notif.connector_alerts !== false;
        if (channel === 'boardroom') return notif.boardroom_alerts !== false;
        return true;
      }

      window.applyUserSettings = applyRuntimeUserSettings;
      window.loadUserSettings = function(force) {
        if (!force && userSettingsCache) return Promise.resolve(userSettingsCache);
        if (!uid) {
          return Promise.resolve({
            appearance: { theme: "dark" },
            preferences: { compact_sidebar: false, reduce_motion: false }
          });
        }
        return fetch("/api/settings/user", { headers: { "X-User-ID": String(uid) } })
          .then(function(r) {
            if (!r.ok) throw new Error("Settings unavailable");
            return r.json();
          })
          .then(function(resp) {
            var payload = (resp && resp.settings && typeof resp.settings === "object") ? resp.settings : {};
            applyRuntimeUserSettings(payload);
            return payload;
          })
          .catch(function() {
            var fallback = {
              appearance: { theme: "dark" },
              preferences: { compact_sidebar: false, reduce_motion: false }
            };
            applyRuntimeUserSettings(fallback);
            return fallback;
          });
      };

      window.CamaradUserSettings = {
        get: function() { return userSettingsCache ? JSON.parse(JSON.stringify(userSettingsCache)) : null; },
        refresh: function() { return window.loadUserSettings(true); },
        apply: function(payload) { applyRuntimeUserSettings(payload || {}); }
      };

      // ── Update user label + snapshot chip ──
      var label = document.getElementById('currentUserLabel');
      if (label) label.textContent = uname;
      var devUserLabel = document.getElementById('devCurrentUser');
      if (devUserLabel) devUserLabel.textContent = uname;
      var dd = document.getElementById('userDropdown');
      if (dd) {
        dd.querySelectorAll('.dropdown-item').forEach(function(item) {
          if (item.textContent.indexOf(uname) !== -1) item.classList.add('active', 'bg-primary');
        });
      }

      function formatCompactNumber(n) {
        var v = Number(n || 0);
        if (!isFinite(v)) v = 0;
        return v.toLocaleString('en-US');
      }

      function applyUserSnapshotToChip(snapshot) {
        var s = snapshot && typeof snapshot === 'object' ? snapshot : {};
        var name = String(s.display_name || s.username || uname || 'User').trim() || 'User';
        var plan = String(s.plan || s.tier || (s.is_premium ? 'premium' : 'free')).toLowerCase();
        var ctBalance = Number(s.ct_balance || 0);
        if (!isFinite(ctBalance) || ctBalance < 0) ctBalance = 0;
        var reqToday = Number(s.requests_today || 0);
        if (!isFinite(reqToday) || reqToday < 0) reqToday = 0;
        var activeClient = s.active_client && typeof s.active_client === 'object' ? s.active_client : null;

        var nameEl = document.getElementById('userSnapshotName');
        if (nameEl) nameEl.textContent = name;

        var avatarEl = document.getElementById('userSnapshotAvatar');
        if (avatarEl) {
          var initial = String(name || 'U').trim().charAt(0).toUpperCase() || 'U';
          avatarEl.textContent = initial;
        }

        var ctEl = document.getElementById('userSnapshotCT');
        if (ctEl) ctEl.textContent = formatCompactNumber(ctBalance) + ' CT';

        var metaEl = document.getElementById('userSnapshotMeta');
        if (metaEl) {
          var clientLabel = activeClient && activeClient.display_name
            ? activeClient.display_name
            : 'None';
          metaEl.innerHTML = ''
            + '<div><strong>' + escHtmlSafe(name) + '</strong> · ' + escHtmlSafe(plan.toUpperCase()) + '</div>'
            + '<div class="mt-1">Requests today: ' + escHtmlSafe(String(reqToday)) + '</div>'
            + '<div>Active client: ' + escHtmlSafe(clientLabel) + '</div>';
        }
      }

      window.loadUserSnapshot = function(force) {
        if (!force && userSnapshotCache) {
          applyUserSnapshotToChip(userSnapshotCache);
          return Promise.resolve(userSnapshotCache);
        }

        return fetch('/api/user/snapshot', {
          cache: 'no-store',
          headers: { 'X-User-ID': String(uid || 0) }
        })
          .then(function(r) {
            if (!r.ok) throw new Error('Snapshot unavailable');
            return r.json();
          })
          .then(function(payload) {
            userSnapshotCache = payload || {};
            applyUserSnapshotToChip(userSnapshotCache);
            return userSnapshotCache;
          })
          .catch(function() {
            var fallback = {
              username: uname,
              display_name: uname,
              plan: (uid === 3 ? 'premium' : 'free'),
              ct_balance: (uid === 3 ? 50000 : 10000),
              requests_today: 0,
              active_client: null
            };
            userSnapshotCache = fallback;
            applyUserSnapshotToChip(fallback);
            return fallback;
          });
      };

      // ═══════════════════════════════════════════════════════════════
      // ── CT ECONOMY HELPERS ─────────────────────────────────────────
      // ═══════════════════════════════════════════════════════════════
      var CT_PRICING = {
        chat_base: 5,
        chat_message_cap: 80,
        rag_min: 15,
        rag_max: 30,
        flow_base: 20,
        flow_per_node: 10,
        flow_max: 150,
        asset_gen: 80,
        boardroom_min: 100,
        boardroom_max: 250,
        cost_multiplier: 1
      };
      window.CamaradCTPricing = Object.assign({}, CT_PRICING);
      if (ctPricingRuntimeOverrides && typeof ctPricingRuntimeOverrides === 'object') {
        window.CamaradCTPricing.chat_message_cap = Number(ctPricingRuntimeOverrides.chat_message_cap || window.CamaradCTPricing.chat_message_cap);
        window.CamaradCTPricing.cost_multiplier = Number(ctPricingRuntimeOverrides.cost_multiplier || window.CamaradCTPricing.cost_multiplier || 1);
      }

      window.updateBalance = function() {
        if (window.loadUserSnapshot && typeof window.loadUserSnapshot === 'function') {
          return window.loadUserSnapshot(true);
        }
        return Promise.resolve(null);
      };

      window.spendCT = async function(amount, eventType, description, opts) {
        var requested = Math.round(Number(amount || 0));
        if (!isFinite(requested) || requested <= 0) {
          return { success: true, skipped: true, requested_amount: 0, charged_amount: 0 };
        }

        var options = opts && typeof opts === 'object' ? opts : {};
        var requestId = String(options.request_id || (window.crypto && window.crypto.randomUUID ? window.crypto.randomUUID() : ('req-' + Date.now() + '-' + Math.floor(Math.random() * 1e6))));
        var ev = String(eventType || 'unknown').trim().toLowerCase() || 'unknown';
        var desc = String(description || '').trim();
        var charged = requested;
        var capped = false;

        if (ev === 'chat_message') {
          var runtimeCap = (window.CamaradCTPricing && window.CamaradCTPricing.chat_message_cap) || CT_PRICING.chat_message_cap || 80;
          var cap = Number(options.cap_amount || runtimeCap);
          if (!isFinite(cap) || cap <= 0) cap = 80;
          if (charged > cap) {
            charged = cap;
            capped = true;
          }

          if (!options.silentEstimate && charged > CT_PRICING.chat_base && window.showToast) {
            if (capped) {
              window.showToast('Usage', 'Est. cost: ' + charged + ' CT (capped at ' + cap + ' CT).', 'warning', 1800, 'chat');
            } else {
              window.showToast('Usage', 'Est. cost: ' + charged + ' CT.', 'info', 1300, 'chat');
            }
          }
        }

        try {
          var r = await fetch('/api/user/spend', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              amount: charged,
              event_type: ev,
              description: desc,
              request_id: requestId
            })
          });

          var payload = {};
          try { payload = await r.json(); } catch (_) { payload = {}; }

          if (!r.ok || payload.success !== true) {
            var errMsg = String(payload.error || payload.message || ('Insufficient CT balance (' + charged + ' CT needed).'));
            if (window.showToast) {
              window.showToast('Balance', errMsg, 'error');
            }
            return { success: false, error: errMsg, status: r.status, payload: payload, request_id: requestId, requested_amount: requested, charged_amount: charged, capped: capped };
          }

          if (window.loadUserSnapshot && typeof window.loadUserSnapshot === 'function') {
            await window.loadUserSnapshot(true);
          }

          var actualCharged = Number(payload.spent);
          if (!isFinite(actualCharged) || actualCharged <= 0) actualCharged = charged;

          if (!options.silentSuccess && window.showToast) {
            var msg = 'Spent ' + actualCharged + ' CT (' + ev + ').';
            if (capped) msg += ' (cap applied)';
            if (Number(payload.cost_multiplier || 1) !== 1) {
              msg += ' x' + Number(payload.cost_multiplier).toFixed(2) + ' preset';
            }
            window.showToast('Usage', msg, payload.low_balance ? 'warning' : 'info', 2200, 'system');
          }

          try {
            window.dispatchEvent(new CustomEvent('camarad:ct-updated', {
              detail: {
                requested_amount: requested,
                charged_amount: charged,
                capped: capped,
                event_type: ev,
                balance: Number(payload.new_balance || 0)
              }
            }));
          } catch (_) {}

          return { success: true, payload: payload, request_id: String(payload.request_id || requestId), requested_amount: requested, charged_amount: charged, actual_charged: actualCharged, capped: capped };
        } catch (err) {
          if (window.showToast) {
            window.showToast('Balance', 'CT spend failed: ' + err.message, 'error');
          }
          return { success: false, error: err.message, request_id: requestId, requested_amount: requested, charged_amount: charged, capped: capped };
        }
      };
      // ═══════════════════════════════════════════════════════════════
      // ── TOAST NOTIFICATION SYSTEM ──────────────────────────────────
      // ═══════════════════════════════════════════════════════════════
      var notifications = JSON.parse(localStorage.getItem('camarad_notifs_' + uid) || '[]');
      var unreadCount = 0;

      function saveNotifs() {
        // Keep max 50
        if (notifications.length > 50) notifications = notifications.slice(-50);
        localStorage.setItem('camarad_notifs_' + uid, JSON.stringify(notifications));
      }

      /**
       * Show a toast notification.
       * @param {string} title - Bold title text
       * @param {string} message - Body text
       * @param {string} type - success|info|warning|error|push
       * @param {number} duration - ms before auto-dismiss (0 = sticky)
       */
      window.showToast = function(title, message, type, duration, channel) {
        type = type || 'info';
        duration = (duration !== undefined) ? duration : 4000;

        if (!shouldShowToastForChannel(channel)) return null;
        var resolvedChannel = inferToastChannel(channel);

        var container = document.getElementById('toast-container');
        if (!container) return null;

        var toast = document.createElement('div');
        toast.className = 'camarad-toast toast-' + type;
        var now = new Date();
        var timeStr = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        toast.innerHTML = '<span class="toast-icon"><i class="bi ' + (TOAST_ICONS[type]||TOAST_ICONS.info) + '"></i></span>'
          + '<div class="toast-body">'
          + '<div class="toast-title">' + title + '</div>'
          + (message ? '<div class="toast-msg">' + message + '</div>' : '')
          + '<div class="toast-time">' + timeStr + '</div>'
          + '</div>';

        toast.onclick = function() { dismissToast(toast); };
        container.appendChild(toast);

        // Store in history
        notifications.push({ title: title, message: message, type: type, channel: resolvedChannel, time: now.toISOString() });
        saveNotifs();
        unreadCount++;
        updateBadge();
        renderNotifList();

        // Auto-dismiss
        if (duration > 0) {
          setTimeout(function() { dismissToast(toast); }, duration);
        }
        return toast;
      };

      function dismissToast(el) {
        if (!el || el.classList.contains('toast-exit')) return;
        el.classList.add('toast-exit');
        setTimeout(function() { if (el.parentNode) el.parentNode.removeChild(el); }, 350);
      }

      // ── Notification panel ──
      window.toggleNotifPanel = function() {
        var panel = document.getElementById('notif-panel');
        if (panel) {
          panel.classList.toggle('open');
          if (panel.classList.contains('open')) {
            unreadCount = 0;
            updateBadge();
          }
        }
      };

      window.clearNotifications = function() {
        notifications = [];
        saveNotifs();
        unreadCount = 0;
        updateBadge();
        renderNotifList();
      };

      function updateBadge() {
        var badge = document.getElementById('notif-badge');
        if (badge) {
          badge.textContent = unreadCount;
          badge.style.display = unreadCount > 0 ? 'flex' : 'none';
        }
      }

      function renderNotifList() {
        var list = document.getElementById('notif-list');
        var empty = document.getElementById('notif-empty');
        if (!list) return;

        // Clear existing items (keep empty placeholder)
        list.querySelectorAll('.notif-item').forEach(function(el) { el.remove(); });

        if (notifications.length === 0) {
          if (empty) empty.style.display = 'block';
          return;
        }
        if (empty) empty.style.display = 'none';

        // Render newest first
        for (var i = notifications.length - 1; i >= 0; i--) {
          var n = notifications[i];
          var div = document.createElement('div');
          div.className = 'notif-item n-' + (n.type || 'info');
          var d = new Date(n.time);
          var ts = d.toLocaleDateString([], {month:'short', day:'numeric'}) + ' ' + d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
          div.innerHTML = '<div><strong>' + n.title + '</strong></div>'
            + (n.message ? '<div style="opacity:0.8;font-size:0.8rem">' + n.message + '</div>' : '')
            + '<div class="notif-time">' + ts + '</div>';
          list.appendChild(div);
        }
      }

      // Render stored notifs on load
      renderNotifList();
      updateBadge();

      // ── Push Simulation (mock connector alerts) ──
      var pushMessages = [
        { title: 'Google Ads Alert', msg: 'Campaign "Summer Sale" budget 80% spent — consider increasing.', type: 'push', channel: 'connector' },
        { title: 'Connector Expired', msg: 'Meta Ads token expires in 2 days — reconnect to avoid data gaps.', type: 'warning', channel: 'connector' },
        { title: 'RAG Index Updated', msg: 'Knowledge base refreshed with 4 new document chunks.', type: 'info', channel: 'chat' },
        { title: 'Flow Completed', msg: 'Orchestrator flow "Lead Gen Pipeline" finished — 3 agents ran successfully.', type: 'success', channel: 'system' },
        { title: 'Security Alert', msg: 'Unusual login attempt detected from new IP 185.x.x.x.', type: 'error', channel: 'system' },
        { title: 'Stripe Webhook', msg: 'New subscription: Alice upgraded to Premium plan ($49/mo).', type: 'push', channel: 'connector' },
        { title: 'GitHub Activity', msg: '3 new commits pushed to main branch by devops-bot.', type: 'info', channel: 'connector' },
        { title: 'Analytics Spike', msg: 'GA4 traffic +45% vs last week — blog post going viral.', type: 'success', channel: 'connector' },
        { title: 'Boardroom Pulse', msg: 'Consensus shifted on strategy topic. Review boardroom summary.', type: 'info', channel: 'boardroom' }
      ];

      function schedulePush() {
        var delay = 25000 + Math.random() * 40000; // 25-65s
        setTimeout(function() {
          var p = pushMessages[Math.floor(Math.random() * pushMessages.length)];
          window.showToast(p.title, p.msg, p.type, 6000, p.channel || 'system');
          schedulePush();
        }, delay);
      }
      // Start push simulation after 8s
      setTimeout(schedulePush, 8000);

      // ═══════════════════════════════════════════════════════════════
      // ── DEV USER SWITCHER (mock QA only) ─────────────────────────────
      window.switchDevUser = function(userId, name) {
        var nextId = parseInt(userId, 10);
        if (!isFinite(nextId) || nextId <= 0) nextId = 0;
        var resolvedName = String(name || ('User' + nextId)).trim() || ('User' + nextId);

        document.cookie = 'camarad_user_id=' + nextId + '; path=/; max-age=31536000';
        try {
          localStorage.removeItem('camarad_client_id');
          localStorage.removeItem('camarad_client_name');
          document.cookie = 'camarad_client_id=; path=/; max-age=0';
        } catch (e) {}

        if (label) label.textContent = resolvedName;
        var devLabel = document.getElementById('devCurrentUser');
        if (devLabel) devLabel.textContent = resolvedName;

        window.showToast('Dev Tools', 'Mock user switched to ' + resolvedName + ' — reloading...', 'info', 1200);
        setTimeout(function() { location.reload(); }, 700);
      };

      // Backward-compatible alias for existing onclick handlers.
      window.switchUser = window.switchDevUser;
      window.logoutCurrentUser = function() {
        return fetch('/api/auth/logout', { method: 'POST', credentials: 'same-origin' })
          .catch(function(){})
          .then(function() {
            try {
              localStorage.removeItem('camarad_client_id');
              localStorage.removeItem('camarad_client_name');
            } catch (e) {}
            window.location.href = '/signup';
          });
      };

      // ═══════════════════════════════════════════════════════════════
      // ── CLIENT CONTEXT ─────────────────────────────────────────────
      // ═══════════════════════════════════════════════════════════════
      function parseClientId(raw) {
        var n = parseInt(String(raw || '').trim(), 10);
        return isFinite(n) && n > 0 ? n : null;
      }

      function escapeAttr(val) {
        return escHtmlSafe(val).replace(/`/g, '&#96;');
      }

      function getClientDisplayName(client) {
        if (!client || typeof client !== 'object') return 'None';
        var type = String(client.type || '').toLowerCase();
        var label = '';
        if (type === 'company') {
          label = String(client.company_name || '').trim();
        } else {
          label = String(client.name || '').trim();
        }
        if (!label) {
          label = String(client.display_name || '').trim();
        }
        if (!label) {
          label = 'Client ' + String(client.id || '');
        }
        return label;
      }

      function humanizeSlug(raw) {
        var s = String(raw || '').trim();
        if (s.toLowerCase() === 'life-coach') return 'Personal Assistant';
        return s
          .replace(/[-_]+/g, ' ')
          .replace(/\s+/g, ' ')
          .trim()
          .replace(/\b\w/g, function(ch) { return ch.toUpperCase(); });
      }

      function setClientCookie(clientId) {
        if (!clientId) {
          document.cookie = 'camarad_client_id=; path=/; max-age=0';
          return;
        }
        document.cookie = 'camarad_client_id=' + clientId + '; path=/; max-age=31536000';
      }

      function readStoredClientId() {
        var ls = null;
        try {
          ls = parseClientId(localStorage.getItem('camarad_client_id'));
        } catch (e) {}
        if (ls) return ls;
        return parseClientId(getCookie('camarad_client_id'));
      }

      var clientsCache = [];
      var clientAccountsCache = [];
      var activeClientId = readStoredClientId();
      var activeClientName = 'None';
      try {
        activeClientName = String(localStorage.getItem('camarad_client_name') || '').trim() || 'None';
      } catch (e) {}

      function syncActiveClientLabels() {
        var labelEl = document.getElementById('currentClientLabel');
        var text = activeClientId ? activeClientName : 'None';
        if (labelEl) {
          labelEl.textContent = text;
        }

        document.querySelectorAll('.active-client-label').forEach(function(el) {
          el.textContent = 'Active Client: ' + text;
        });
      }

      function getActiveClientObject() {
        if (!activeClientId) return null;
        var match = clientsCache.find(function(c) { return Number(c.id) === Number(activeClientId); });
        if (match) return match;
        return {
          id: activeClientId,
          display_name: activeClientName,
          name: activeClientName,
          type: 'person'
        };
      }

      function persistActiveClient(clientId, clientName) {
        activeClientId = parseClientId(clientId);
        activeClientName = activeClientId ? String(clientName || 'Client').trim() : 'None';
        if (!activeClientId) activeClientName = 'None';

        try {
          if (activeClientId) {
            localStorage.setItem('camarad_client_id', String(activeClientId));
            localStorage.setItem('camarad_client_name', activeClientName);
          } else {
            localStorage.removeItem('camarad_client_id');
            localStorage.removeItem('camarad_client_name');
          }
        } catch (e) {}

        setClientCookie(activeClientId);
        syncActiveClientLabels();
      }

      function dispatchClientChanged() {
        var detail = {
          client_id: activeClientId || null,
          client_name: activeClientId ? activeClientName : 'None'
        };
        try {
          window.dispatchEvent(new CustomEvent('camarad:client-changed', { detail: detail }));
        } catch (e) {}
      }

      function statusBadgeClass(status) {
        var s = String(status || '').toLowerCase();
        if (s === 'connected' || s === 'active' || s === 'ok') return 'bg-success';
        if (s === 'error' || s === 'failed') return 'bg-danger';
        if (s === 'pending' || s === 'disconnected') return 'bg-warning text-dark';
        return 'bg-secondary';
      }

      function shouldAttachClientHeaders(urlStr) {
        try {
          var u = new URL(String(urlStr || ''), window.location.origin);
          return u.origin === window.location.origin && u.pathname.indexOf('/api/') === 0;
        } catch (e) {
          return false;
        }
      }

      function wrapFetchWithClientHeaders() {
        if (window.__camaradFetchWrapped) return;
        var nativeFetch = window.fetch.bind(window);
        window.fetch = function(input, init) {
          var url = '';
          if (typeof input === 'string') {
            url = input;
          } else if (input && typeof input.url === 'string') {
            url = input.url;
          }

          if (!shouldAttachClientHeaders(url)) {
            return nativeFetch(input, init);
          }

          var cfg = init ? Object.assign({}, init) : {};
          var headers = new Headers();

          if (typeof Request !== 'undefined' && input instanceof Request) {
            input.headers.forEach(function(v, k) { headers.set(k, v); });
          }

          if (cfg.headers) {
            var extra = new Headers(cfg.headers);
            extra.forEach(function(v, k) { headers.set(k, v); });
          }

          var currentUid = parseInt(getCookie('camarad_user_id') || '0', 10) || 0;
          if (currentUid > 0) {
            headers.set('X-User-ID', String(currentUid));
          } else {
            headers.delete('X-User-ID');
          }

          var currentCid = readStoredClientId();
          if (currentCid) {
            headers.set('X-Client-ID', String(currentCid));
          } else {
            headers.delete('X-Client-ID');
          }

          cfg.headers = headers;
          return nativeFetch(input, cfg);
        };
        window.__camaradFetchWrapped = true;
      }

      function formatClientAccountCountLabel(count) {
        var n = Number(count || 0);
        if (!Number.isFinite(n) || n < 0) n = 0;
        return n + ' ' + (n === 1 ? 'cont' : 'conturi');
      }

      function renderClientDropdown() {
        var dd = document.getElementById('clientDropdown');
        if (!dd) return;
        var html = '';
        if (activeClientId) {
          html += '<li><a class="dropdown-item text-info d-flex justify-content-between align-items-center" href="#" onclick="if(window.openClientInspector){window.openClientInspector(' + Number(activeClientId) + ');} return false;"><span><i class="bi bi-layout-sidebar-inset-reverse me-2"></i>Current Client</span><i class="bi bi-chevron-right small"></i></a></li>';
          html += '<li><hr class="dropdown-divider border-secondary"></li>';
        }
        html += '<li><a class="dropdown-item text-light' + (!activeClientId ? ' active bg-primary' : '') + '" href="#" onclick="switchClient(null); return false;"><i class="bi bi-slash-circle me-2"></i>None</a></li>';
        if (clientsCache.length) {
          html += '<li><hr class="dropdown-divider border-secondary"></li>';
        }

        clientsCache.forEach(function(client) {
          var cid = Number(client.id);
          if (!Number.isFinite(cid) || cid <= 0) return;

          var name = getClientDisplayName(client);
          var activeCls = activeClientId && Number(activeClientId) === cid ? ' active bg-primary' : '';
          var icon = String(client.type || '').toLowerCase() === 'company' ? 'bi-buildings' : 'bi-person-vcard';
          var count = Number(client.account_count || client.accounts_count || 0);
          if (!Number.isFinite(count) || count < 0) count = 0;
          var countLabel = formatClientAccountCountLabel(count);
          var badgeClass = count > 0 ? 'bg-success' : 'bg-secondary';

          html += ''
            + '<li>'
            + '<a class="dropdown-item text-light d-flex justify-content-between align-items-center' + activeCls + '" href="#" onclick="switchClient(' + cid + '); return false;">'
            + '<span><i class="bi ' + icon + ' me-2"></i>' + escHtmlSafe(name) + '</span>'
            + '<span class="badge ' + badgeClass + ' ms-2">' + escHtmlSafe(countLabel) + '</span>'
            + '</a>'
            + '</li>';
        });

        dd.innerHTML = html;
      }

      function renderClientAccounts(accounts) {
        var list = document.getElementById('clientAccountsList');
        if (!list) return;

        if (!activeClientId) {
          list.innerHTML = '<div class="text-muted small px-2 py-1">No client selected</div>';
          return;
        }

        if (!accounts || !accounts.length) {
          list.innerHTML = '<div class="text-muted small px-2 py-1">No accounts linked</div>';
          return;
        }

        list.innerHTML = accounts.map(function(acc) {
          var slug = String(acc.connector_slug || 'connector');
          var label = humanizeSlug(slug);
          var accountName = String(acc.account_name || acc.account_id || 'Account').trim();
          var status = String(acc.status || 'pending');
          return ''
            + '<div class="list-group-item bg-transparent border-secondary py-2 px-2">'
            + '<div class="d-flex justify-content-between align-items-start gap-2">'
            + '<div class="small">'
            + '<div class="fw-semibold text-light">' + escHtmlSafe(label) + '</div>'
            + '<div class="text-muted">' + escHtmlSafe(accountName) + '</div>'
            + '</div>'
            + '<span class="badge ' + statusBadgeClass(status) + '">' + escHtmlSafe(status) + '</span>'
            + '</div>'
            + '</div>';
        }).join('');
      }

      function getConnectorMockAccounts(slug) {
        var key = String(slug || '').trim();
        if (!key) return Promise.resolve([]);

        if (key === 'google-ads') {
          return fetch('/api/connectors/google-ads/accounts')
            .then(function(r) { return r.json(); })
            .then(function(data) {
              return (data.accounts || []).map(function(a) {
                return { id: a.id, name: a.name || a.id };
              });
            })
            .catch(function() { return []; });
        }

        if (key === 'ga4') {
          return fetch('/api/connectors/ga4/properties')
            .then(function(r) { return r.json(); })
            .then(function(data) {
              return (data.properties || []).map(function(a) {
                return { id: a.id, name: a.name || a.id };
              });
            })
            .catch(function() { return []; });
        }

        if (key === 'google-search-console') {
          return fetch('/api/connectors/google-search-console/properties')
            .then(function(r) { return r.json(); })
            .then(function(data) {
              return (data.properties || []).map(function(a) {
                return { id: a.id, name: a.name || a.id };
              });
            })
            .catch(function() { return []; });
        }

        if (key === 'google-tag-manager') {
          return fetch('/api/connectors/google-tag-manager/containers')
            .then(function(r) { return r.json(); })
            .then(function(data) {
              return (data.containers || []).map(function(a) {
                return { id: a.id, name: a.name || a.id };
              });
            })
            .catch(function() { return []; });
        }

        return Promise.resolve([
          { id: key + '-main', name: humanizeSlug(key) + ' Main Account' },
          { id: key + '-secondary', name: humanizeSlug(key) + ' Secondary' },
          { id: key + '-sandbox', name: humanizeSlug(key) + ' Sandbox' }
        ]);
      }

      window.openClientInspector = function(clientId, labelHint) {
        var cid = parseClientId(clientId);
        if (!cid) {
          if (typeof window.setActiveContextSelection === 'function') {
            window.setActiveContextSelection({ kind: 'canvas' });
          }
          return;
        }

        var client = clientsCache.find(function(c) { return Number(c.id) === Number(cid); }) || null;
        var label = String(labelHint || '').trim();
        if (!label) {
          label = client ? getClientDisplayName(client) : ('Client ' + String(cid));
        }

        if (typeof window.setActiveContextSelection === 'function') {
          window.setActiveContextSelection({
            kind: 'client',
            type: 'client',
            nodeType: 'client',
            id: String(cid),
            client_id: cid,
            label: label,
            name: client ? (client.name || '') : '',
            company_name: client ? (client.company_name || '') : '',
            client_type: client ? (client.type || 'person') : 'person',
            email: client ? (client.email || '') : '',
            website: client ? (client.website || '') : '',
            phone: client ? (client.phone || '') : '',
            address: client ? (client.address || '') : '',
            notes: client ? (client.notes || '') : '',
            workspace: 'business'
          });
        }
      };

      window.switchClient = function(clientId, name) {
        persistActiveClient(clientId, name);
        renderClientDropdown();
        loadClientAccounts();

        // Clear per-client caches so next fetch uses current client scope.
        if (typeof sidebarAgentsCache !== 'undefined') {
          sidebarAgentsCache = [];
        }

        if (window.loadSidebarChats) window.loadSidebarChats();
        dispatchClientChanged();

        if (activeClientId) {
          window.openClientInspector(activeClientId, activeClientName);
        }

        if (window.showToast) {
          window.showToast('Client', 'Active client set to ' + (activeClientId ? activeClientName : 'None') + '.', 'info', 1400);
        }
      };

      window.loadClients = function() {
        return fetch('/api/clients')
          .then(function(r) { return r.json(); })
          .then(function(list) {
            clientsCache = Array.isArray(list) ? list : [];

            if (activeClientId) {
              var found = clientsCache.find(function(c) { return Number(c.id) === Number(activeClientId); });
              if (!found) {
                persistActiveClient(null, 'None');
              } else {
                activeClientName = getClientDisplayName(found);
                persistActiveClient(activeClientId, activeClientName);
              }
            }

            syncActiveClientLabels();
            renderClientDropdown();
            loadClientAccounts();
            dispatchClientChanged();
            return clientsCache;
          })
          .catch(function() {
            clientsCache = [];
            renderClientDropdown();
            renderClientAccounts([]);
            return [];
          });
      };

      window.loadClientAccounts = function() {
        if (!activeClientId) {
          clientAccountsCache = [];
          renderClientAccounts([]);
          renderClientDropdown();
          return Promise.resolve([]);
        }

        return fetch('/api/client_connectors?client_id=' + encodeURIComponent(activeClientId))
          .then(function(r) { return r.json(); })
          .then(function(list) {
            clientAccountsCache = Array.isArray(list) ? list : [];
            var current = clientsCache.find(function(c) { return Number(c.id) === Number(activeClientId); });
            if (current) {
              current.account_count = clientAccountsCache.length;
            }
            renderClientDropdown();
            renderClientAccounts(clientAccountsCache);
            dispatchClientChanged();
            return clientAccountsCache;
          })
          .catch(function() {
            clientAccountsCache = [];
            var current = clientsCache.find(function(c) { return Number(c.id) === Number(activeClientId); });
            if (current) {
              current.account_count = 0;
            }
            renderClientDropdown();
            renderClientAccounts([]);
            return [];
          });
      };

      window.toggleClientTypeFields = function() {
        var typeEl = document.getElementById('clientType');
        var type = typeEl ? String(typeEl.value || 'person') : 'person';
        var personWrap = document.getElementById('clientNameWrap');
        var companyWrap = document.getElementById('clientCompanyWrap');
        if (personWrap) personWrap.style.display = type === 'person' ? '' : 'none';
        if (companyWrap) companyWrap.style.display = type === 'company' ? '' : 'none';
      };

      window.openNewClientModal = function() {
        var modalEl = document.getElementById('newClientModal');
        if (!modalEl) return;
        if (modalEl.parentNode !== document.body) document.body.appendChild(modalEl);
        var modal = new bootstrap.Modal(modalEl);
        modal.show();
        window.toggleClientTypeFields();
      };

      window.createClient = function() {
        var payload = {
          type: (document.getElementById('clientType') || {}).value || 'person',
          name: ((document.getElementById('clientName') || {}).value || '').trim(),
          company_name: ((document.getElementById('clientCompanyName') || {}).value || '').trim(),
          email: ((document.getElementById('clientEmail') || {}).value || '').trim(),
          website: ((document.getElementById('clientWebsite') || {}).value || '').trim(),
          notes: ((document.getElementById('clientNotes') || {}).value || '').trim()
        };

        fetch('/api/clients', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        })
          .then(function(r) { return r.json(); })
          .then(function(resp) {
            if (!resp.success || !resp.client) {
              throw new Error(resp.error || 'Failed to create client');
            }
            var modalEl = document.getElementById('newClientModal');
            var modal = bootstrap.Modal.getInstance(modalEl);
            if (modal) modal.hide();
            var display = getClientDisplayName(resp.client);
            return window.loadClients().then(function() {
              window.switchClient(resp.client.id, display);
            });
          })
          .catch(function(err) {
            if (window.showToast) window.showToast('Client', err.message, 'error');
          });
      };

      function fillConnectorOptions() {
        var select = document.getElementById('clientAccountConnector');
        if (!select) return Promise.resolve();

        return fetch('/api/connectors/list?all=1')
          .then(function(r) { return r.json(); })
          .then(function(list) {
            var connectors = Array.isArray(list) ? list : [];
            select.innerHTML = connectors.map(function(c) {
              return '<option value="' + escapeAttr(c.slug) + '">' + escHtmlSafe(c.name || humanizeSlug(c.slug)) + '</option>';
            }).join('');
          })
          .catch(function() {
            select.innerHTML = '<option value="google-ads">Google Ads</option><option value="ga4">GA4</option><option value="hubspot">HubSpot</option>';
          });
      }

      window.loadMockAccountsForSelectedConnector = function() {
        var connectorEl = document.getElementById('clientAccountConnector');
        var accountEl = document.getElementById('clientAccountOption');
        if (!connectorEl || !accountEl) return;

        var slug = String(connectorEl.value || '').trim();
        getConnectorMockAccounts(slug).then(function(accounts) {
          var list = Array.isArray(accounts) && accounts.length ? accounts : [{ id: slug + '-account', name: humanizeSlug(slug) + ' Account' }];
          accountEl.innerHTML = list.map(function(a) {
            return '<option value="' + escapeAttr(a.id) + '">' + escHtmlSafe(a.name || a.id) + '</option>';
          }).join('');
        });
      };

      window.openAddClientAccountModal = function() {
        if (!activeClientId) {
          if (window.showToast) window.showToast('Client', 'Select a client first.', 'warning');
          return;
        }

        var modalEl = document.getElementById('addClientAccountModal');
        if (!modalEl) return;
        if (modalEl.parentNode !== document.body) document.body.appendChild(modalEl);

        fillConnectorOptions().then(function() {
          window.loadMockAccountsForSelectedConnector();
          var modal = new bootstrap.Modal(modalEl);
          modal.show();
        });
      };

      window.createClientAccountLink = function() {
        if (!activeClientId) {
          if (window.showToast) window.showToast('Client', 'Select a client first.', 'warning');
          return;
        }

        var connectorEl = document.getElementById('clientAccountConnector');
        var accountEl = document.getElementById('clientAccountOption');
        var statusEl = document.getElementById('clientAccountStatus');
        if (!connectorEl || !accountEl) return;

        var accountName = '';
        if (accountEl.options && accountEl.selectedIndex >= 0) {
          accountName = String(accountEl.options[accountEl.selectedIndex].text || '').trim();
        }

        var payload = {
          client_id: activeClientId,
          connector_slug: String(connectorEl.value || '').trim(),
          account_id: String(accountEl.value || '').trim(),
          account_name: accountName,
          status: String((statusEl || {}).value || 'pending').trim().toLowerCase()
        };

        fetch('/api/client_connectors', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        })
          .then(function(r) { return r.json(); })
          .then(function(resp) {
            if (!resp.success) {
              throw new Error(resp.error || 'Failed to link account');
            }
            var modalEl = document.getElementById('addClientAccountModal');
            var modal = bootstrap.Modal.getInstance(modalEl);
            if (modal) modal.hide();
            return window.loadClientAccounts();
          })
          .then(function() {
            if (window.showToast) window.showToast('Client', 'Account linked successfully.', 'success');
          })
          .catch(function(err) {
            if (window.showToast) window.showToast('Client', err.message, 'error');
          });
      };

      window.openActiveClientDetailsFromSidebar = function() {
        if (!activeClientId) {
          if (window.showToast) window.showToast('Client', 'Select a client first.', 'info', 1400);
          return;
        }
        if (typeof window.openClientInspector === 'function') {
          window.openClientInspector(activeClientId, activeClientName);
        }
      };

      // UX: allow opening client drawer quickly from any page header/footer labels.
      document.addEventListener('click', function(ev) {
        var hit = ev.target && ev.target.closest ? ev.target.closest('.active-client-label') : null;
        if (!hit) return;
        if (!activeClientId) return;
        if (typeof window.openClientInspector === 'function') {
          window.openClientInspector(activeClientId, activeClientName);
        }
      });

      // UX: double-click current client dropdown button to open details (single click still opens dropdown).
      try {
        var currentBtn = document.getElementById('currentClientBtn');
        if (currentBtn) {
          currentBtn.addEventListener('dblclick', function() {
            if (!activeClientId) return;
            if (typeof window.openClientInspector === 'function') {
              window.openClientInspector(activeClientId, activeClientName);
            }
          });
        }
      } catch (e) {}

      wrapFetchWithClientHeaders();
      ensureAuthBoot()
        .then(function() { return window.loadUserSettings(); })
        .then(function() { return window.loadUserSnapshot(); })
        .then(function() { syncActiveClientLabels(); })
        .catch(function() {});

      window.CamaradClient = {
        getActiveClientId: function() { return activeClientId || null; },
        getActiveClientName: function() { return activeClientId ? activeClientName : 'None'; },
        getActiveClient: function() {
          var client = getActiveClientObject();
          if (!client) return null;
          return Object.assign({}, client, { display_name: getClientDisplayName(client) });
        },
        getClientAccounts: function() { return Array.isArray(clientAccountsCache) ? clientAccountsCache.slice() : []; },
        refresh: function() { return window.loadClients(); }
      };

      // ═══════════════════════════════════════════════════════════════
      // ── EXPORT / IMPORT ────────────────────────────────────────────
      // ═══════════════════════════════════════════════════════════════
      window.exportAllConfig = function() {
        fetch('/api/export')
          .then(function(r) { return r.json(); })
          .then(function(data) {
            var blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'camarad-backup-user' + uid + '-' + new Date().toISOString().slice(0,10) + '.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            var chatsCount = (data.chats || []).length;
            var messagesCount = (data.chats || []).reduce(function(sum, c) { return sum + ((c.messages || []).length); }, 0);
            window.showToast('Export Complete', data.agents.length + ' agents, ' + data.connectors.length + ' connectors, ' + data.flows.length + ' flows, ' + chatsCount + ' chats (' + messagesCount + ' messages) exported.', 'success');
          })
          .catch(function(e) { window.showToast('Export Failed', e.message, 'error'); });
      };

      window.importAllConfig = function(input) {
        if (!input.files || !input.files[0]) return;
        var file = input.files[0];
        var reader = new FileReader();
        reader.onload = function(ev) {
          try {
            var data = JSON.parse(ev.target.result);
          } catch(e) {
            window.showToast('Import Failed', 'Invalid JSON: ' + e.message, 'error');
            return;
          }
          var importChats = data.chats || data.conversations || [];
          var importMessages = importChats.reduce(function(sum, c) { return sum + ((c.messages || []).length); }, 0);
          if (!confirm('Import ' + (data.agents||[]).length + ' agents, ' + (data.connectors||[]).length + ' connectors, ' + (data.flows||[]).length + ' flows, ' + importChats.length + ' chats (' + importMessages + ' messages)?')) return;
          fetch('/api/import', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
          })
          .then(function(r) { return r.json(); })
          .then(function(d) {
            if (d.success) {
              window.showToast('Import Complete', d.message, 'success');
              setTimeout(function() { location.reload(); }, 1200);
            } else {
              window.showToast('Import Error', d.error || 'Unknown error', 'error');
            }
          })
          .catch(function(e) { window.showToast('Import Failed', e.message, 'error'); });
        };
        reader.readAsText(file);
        input.value = '';
      };

      // ═══════════════════════════════════════════════════════════════
      // ── SIDEBAR CHAT LIST (multi-chat) ─────────────────────────────
      // ═══════════════════════════════════════════════════════════════
      var sidebarAgentsCache = [];
      var workspaceLabelMap = {
        personal: 'Personal',
        business: 'Business',
        agency: 'Agency',
        development: 'Development'
      };

      function escHtmlSafe(v) {
        return String(v === undefined || v === null ? '' : v)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }

      function normalizeWorkspaceSlug(raw) {
        return String(raw || 'agency').trim().toLowerCase().replace(/\s+/g, '-');
      }

      function workspaceLabel(slug) {
        var ws = normalizeWorkspaceSlug(slug);
        return workspaceLabelMap[ws] || (ws.charAt(0).toUpperCase() + ws.slice(1));
      }

      function getPathParts() {
        return window.location.pathname.split('/').filter(Boolean);
      }

      function inferCurrentWorkspaceSlug() {
        var parts = getPathParts();
        if (parts[0] === 'chat' && parts[1]) return normalizeWorkspaceSlug(parts[1]);
        if (parts[0] === 'workspace' && parts[1]) return normalizeWorkspaceSlug(parts[1]);
        return normalizeWorkspaceSlug(getDefaultWorkspaceFromSettings());
      }

      function inferCurrentAgentSlug() {
        var parts = getPathParts();
        if (parts[0] === 'chat' && parts[2]) return parts[2];
        return '';
      }

      function formatTimeAgo(isoStr) {
        if (!isoStr) return '';
        var d = new Date(isoStr);
        if (isNaN(d.getTime())) return '';
        var now = new Date();
        var diff = (now - d) / 1000;
        if (diff < 60) return 'now';
        if (diff < 3600) return Math.floor(diff / 60) + 'm';
        if (diff < 86400) return Math.floor(diff / 3600) + 'h';
        if (diff < 604800) return Math.floor(diff / 86400) + 'd';
        return d.toLocaleDateString([], {month:'short', day:'numeric'});
      }

      function fetchSidebarAgents() {
        if (sidebarAgentsCache.length) return Promise.resolve(sidebarAgentsCache);
        return fetch('/api/agents/list')
          .then(function(r) { return r.json(); })
          .then(function(data) {
            sidebarAgentsCache = Array.isArray(data) ? data : [];
            return sidebarAgentsCache;
          })
          .catch(function() {
            sidebarAgentsCache = [];
            return [];
          });
      }

      function renderSidebarNewChatAgentOptions(wsSlug, preferredAgentSlug) {
        var select = document.getElementById('sidebarNewChatAgent');
        if (!select) return;

        var normalizedWs = normalizeWorkspaceSlug(wsSlug);
        var filtered = sidebarAgentsCache.filter(function(a) {
          return normalizeWorkspaceSlug(a.workspace_slug || a.workspace) === normalizedWs;
        });

        if (!filtered.length) {
          filtered = sidebarAgentsCache.slice();
        }

        filtered.sort(function(a, b) {
          return String(a.name || a.slug || '').localeCompare(String(b.name || b.slug || ''));
        });

        select.innerHTML = filtered.map(function(a) {
          var status = a.status ? ' [' + a.status + ']' : '';
          return '<option value="' + escHtmlSafe(a.slug) + '">' + escHtmlSafe((a.name || a.slug) + status) + '</option>';
        }).join('');

        if (preferredAgentSlug) {
          var hasPreferred = filtered.some(function(a) { return a.slug === preferredAgentSlug; });
          if (hasPreferred) select.value = preferredAgentSlug;
        }
      }

      window.openSidebarNewChatModal = function() {
        var modalEl = document.getElementById('sidebarNewChatModal');
        if (!modalEl) return;
        if (modalEl.parentNode !== document.body) document.body.appendChild(modalEl);

        var wsSelect = document.getElementById('sidebarNewChatWorkspace');
        var titleInput = document.getElementById('sidebarNewChatTitle');
        var preferredWs = inferCurrentWorkspaceSlug();
        var preferredAgent = inferCurrentAgentSlug();

        if (wsSelect) wsSelect.value = preferredWs;
        if (titleInput) titleInput.value = '';

        fetchSidebarAgents().then(function() {
          renderSidebarNewChatAgentOptions(preferredWs, preferredAgent);
          if (wsSelect && !wsSelect.dataset.boundChange) {
            wsSelect.addEventListener('change', function() {
              renderSidebarNewChatAgentOptions(wsSelect.value, '');
            });
            wsSelect.dataset.boundChange = '1';
          }
        });

        var modal = new bootstrap.Modal(modalEl);
        modal.show();
      };

      window.createSidebarNewChat = function() {
        var wsSelect = document.getElementById('sidebarNewChatWorkspace');
        var agentSelect = document.getElementById('sidebarNewChatAgent');
        var titleInput = document.getElementById('sidebarNewChatTitle');

        var workspaceSlug = wsSelect ? normalizeWorkspaceSlug(wsSelect.value) : 'agency';
        var agentSlug = agentSelect ? String(agentSelect.value || '').trim() : '';
        var title = titleInput ? String(titleInput.value || '').trim() : '';

        if (!agentSlug) {
          window.showToast('New Chat', 'Select an agent first.', 'warning');
          return;
        }

        fetch('/api/conversations/new', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            workspace_slug: workspaceSlug,
            agent_slug: agentSlug,
            title: title
          })
        })
        .then(function(r) { return r.json(); })
        .then(function(d) {
          if (!d.success) {
            throw new Error(d.error || 'Could not create chat');
          }
          var modalEl = document.getElementById('sidebarNewChatModal');
          var modal = bootstrap.Modal.getInstance(modalEl);
          if (modal) modal.hide();
          window.loadSidebarChats();
          var target = d.redirect || d.url || ('/chat/' + workspaceSlug + '/' + agentSlug);
          window.location.href = target;
        })
        .catch(function(e) {
          window.showToast('New Chat Failed', e.message, 'error');
        });
      };

      window.loadSidebarChats = function() {
        var chatList = document.getElementById('sidebar-chat-list');
        if (!chatList) return;
        function renderConversations(convs, usedGlobalFallback) {
          chatList.innerHTML = '';
          if (!convs || convs.length === 0) {
            chatList.innerHTML = '<p class="text-muted small px-2">No chats yet. Start one!</p>';
            return;
          }

          if (usedGlobalFallback) {
            var hint = document.createElement('p');
            hint.className = 'text-muted small px-2 mb-2';
            hint.textContent = 'Showing legacy chats (not yet scoped to active client).';
            chatList.appendChild(hint);
          }

          var urlParams = new URLSearchParams(window.location.search);
          var currentConvId = parseInt(urlParams.get('conv_id') || '0', 10);

          convs.forEach(function(c) {
            var a = document.createElement('a');
            a.href = '/chat/' + encodeURIComponent(c.workspace_slug) + '/' + encodeURIComponent(c.agent_slug) + '?conv_id=' + c.id;
            a.className = 'list-group-item list-group-item-action bg-transparent border-0 py-2 px-2 text-light';
            a.style.fontSize = '0.85rem';
            a.style.borderLeft = '2px solid transparent';

            if (currentConvId && currentConvId === c.id) {
              a.style.borderLeftColor = '#58a6ff';
              a.style.background = '#21262d';
            }

            var miniAvatar = '';
            if (c.avatar_base64) {
              miniAvatar = '<span class="sidebar-avatar"><img src="data:image/png;base64,' + c.avatar_base64 + '" alt="avatar" style="width:24px;height:24px;border-radius:50%;object-fit:cover;border:1px solid #30363d;"></span>';
            } else if (window.CamaradAvatars) {
              miniAvatar = '<span class="sidebar-avatar">' + window.CamaradAvatars.getMini(c.agent_slug) + '</span>';
            } else {
              miniAvatar = '<i class="bi bi-chat-dots mt-1" style="opacity:0.6"></i>';
            }

            var title = c.title || c.agent_name || c.agent_slug.replace(/-/g, ' ');
            if (title.length > 36) title = title.substring(0, 36) + '…';

            var preview = c.last_message || 'No messages yet';
            if (preview.length > 56) preview = preview.substring(0, 56) + '…';

            var wsName = c.workspace_name || workspaceLabel(c.workspace_slug);
            var timeAgo = formatTimeAgo(c.last_activity || c.last_message_at || c.created_at);
            var d = new Date(c.last_activity || c.last_message_at || c.created_at || Date.now());
            var exactTs = isNaN(d.getTime()) ? '' : d.toLocaleString();

            var unreadBadge = '';
            if (c.unread && c.unread > 0) {
              unreadBadge = '<span class="badge bg-primary ms-1">' + c.unread + '</span>';
            }

            a.innerHTML = '<div class="d-flex align-items-start gap-2">'
              + miniAvatar
              + '<div class="flex-fill overflow-hidden">'
              + '<div class="d-flex justify-content-between align-items-start gap-1">'
              + '<span class="text-truncate" style="font-weight:500">' + escHtmlSafe(title) + unreadBadge + '</span>'
              + '<small class="text-muted ms-1" style="white-space:nowrap;font-size:0.7rem" title="' + escHtmlSafe(exactTs) + '">' + escHtmlSafe(timeAgo) + '</small>'
              + '</div>'
              + '<div class="text-muted text-truncate" style="font-size:0.72rem">' + escHtmlSafe(wsName) + ' · ' + escHtmlSafe(c.agent_name || c.agent_slug) + '</div>'
              + '<div class="text-muted text-truncate" style="font-size:0.78rem">' + escHtmlSafe(preview) + '</div>'
              + '</div></div>';
            chatList.appendChild(a);
          });
        }

        fetch('/api/conversations')
          .then(function(r) { return r.json(); })
          .then(function(convs) {
            if (Array.isArray(convs) && convs.length > 0) {
              renderConversations(convs, false);
              return;
            }
            var activeCid = readStoredClientId();
            if (!activeCid) {
              renderConversations([], false);
              return;
            }
            fetch('/api/conversations?include_global=1')
              .then(function(r) { return r.json(); })
              .then(function(globalConvs) {
                renderConversations(globalConvs, Array.isArray(globalConvs) && globalConvs.length > 0);
              })
              .catch(function() {
                chatList.innerHTML = '<p class="text-muted small px-2">Error loading chats</p>';
              });
          })
          .catch(function() {
            chatList.innerHTML = '<p class="text-muted small px-2">Error loading chats</p>';
          });
      };

      // Load chats and clients on page load
      window.loadSidebarChats();
      window.loadClients();
    })();
  </script>
  <script>
    (function() {
      'use strict';

      var ACX_QUEUE_KEY = 'camarad_active_context_flow_add';
      var ACX_REFRESH_MS = 60000;
      var WS_ORDER = ['personal', 'business', 'agency', 'development'];
      var WS_META = {
        personal: {
          label: 'Personal',
          icon: 'bi-person-heart',
          tooltip: 'Personal: routines, focus, and engagement.',
          fallbackAgent: 'ceo-strategy'
        },
        business: {
          label: 'Business',
          icon: 'bi-briefcase',
          tooltip: 'Business: revenue, runway, and pacing health.',
          fallbackAgent: 'cfo-finance'
        },
        agency: {
          label: 'Agency',
          icon: 'bi-megaphone',
          tooltip: 'Agency: campaign outcomes and lead velocity.',
          fallbackAgent: 'cmo-growth'
        },
        development: {
          label: 'Development',
          icon: 'bi-code-slash',
          tooltip: 'Development: deployments, uptime, and issue pressure.',
          fallbackAgent: 'devops-infra'
        }
      };

      var WS_COLORS = {
        personal: '#6c757d',
        business: '#0d6efd',
        agency: '#fd7e14',
        development: '#198754'
      };

      var state = {
        focused: 'business',
        isOpen: false,
        mode: 'overview',
        selection: null,
        globalScore: 81,
        lastUpdated: new Date().toISOString(),
        workspaces: {},
        agentsCatalog: [],
        connectorsCatalog: [],
        agentConfigCache: {},
        connectorConfigCache: {},
        agentBriefCache: {},
        agentConversationCache: {},
        selectionSeq: 0,
        apiSnapshot: null
      };

      var el = {
        widget: document.getElementById('acx-widget'),
        compact: document.getElementById('acx-compact'),
        center: document.getElementById('acx-center'),
        tooltip: document.getElementById('acx-tooltip'),
        panel: document.getElementById('acx-panel'),
        panelScore: document.getElementById('acx-panel-score'),
        panelMeta: document.getElementById('acx-panel-meta'),
        grid: document.getElementById('acx-grid'),
        closeBtn: document.getElementById('acx-close-btn'),
        centerScore: document.getElementById('acx-center-score'),
        overlay: document.getElementById('acx-overlay')
      };

      if (!el.widget || !el.compact || !el.panel || !el.grid || !el.overlay) {
        return;
      }

      document.body.classList.add('acx-global-enabled');

      function clamp(v, min, max) {
        var n = Number(v);
        if (isNaN(n)) n = 0;
        if (n < min) return min;
        if (n > max) return max;
        return n;
      }

      function hexToRgba(hex, alpha) {
        var h = String(hex || '').replace('#', '').trim();
        if (h.length === 3) {
          h = h.split('').map(function(ch) { return ch + ch; }).join('');
        }
        if (!/^[0-9a-fA-F]{6}$/.test(h)) {
          return 'rgba(120, 130, 145, ' + String(alpha) + ')';
        }
        var r = parseInt(h.slice(0, 2), 16);
        var g = parseInt(h.slice(2, 4), 16);
        var b = parseInt(h.slice(4, 6), 16);
        return 'rgba(' + r + ', ' + g + ', ' + b + ', ' + String(alpha) + ')';
      }

      function buildMaturityVisual() {
        var personal = clamp((state.workspaces.personal || {}).score, 0, 100);
        var business = clamp((state.workspaces.business || {}).score, 0, 100);
        var agency = clamp((state.workspaces.agency || {}).score, 0, 100);
        var development = clamp((state.workspaces.development || {}).score, 0, 100);

        var aPersonal = (0.24 + (personal / 100) * 0.76).toFixed(3);
        var aBusiness = (0.24 + (business / 100) * 0.76).toFixed(3);
        var aAgency = (0.24 + (agency / 100) * 0.76).toFixed(3);
        var aDevelopment = (0.24 + (development / 100) * 0.76).toFixed(3);

        var ringGradient = 'conic-gradient('
          + hexToRgba(WS_COLORS.personal, aPersonal) + ' 0 25%,'
          + hexToRgba(WS_COLORS.business, aBusiness) + ' 25% 50%,'
          + hexToRgba(WS_COLORS.agency, aAgency) + ' 50% 75%,'
          + hexToRgba(WS_COLORS.development, aDevelopment) + ' 75% 100%)';

        var items = [
          { key: 'personal', label: 'Personal', score: personal },
          { key: 'business', label: 'Business', score: business },
          { key: 'agency', label: 'Agency', score: agency },
          { key: 'development', label: 'Development', score: development }
        ];

        var legendHtml = items.map(function(item) {
          var color = WS_COLORS[item.key] || '#8b949e';
          return ''
            + '<div class="acx-maturity-item">'
            + '<span class="label"><span class="dot" style="background:' + color + '"></span>' + esc(item.label) + '</span>'
            + '<span class="value">' + item.score + '%</span>'
            + '</div>';
        }).join('');

        return ''
          + '<div class="acx-maturity-wrap">'
          + '<div class="acx-maturity-ring" style="background:' + ringGradient + ';">'
          + '<div class="acx-maturity-core"><strong>' + clamp(state.globalScore, 0, 100) + '%</strong><small>CMI</small></div>'
          + '</div>'
          + '<div class="acx-maturity-legend">' + legendHtml + '</div>'
          + '</div>';
      }

      function esc(value) {
        return String(value === undefined || value === null ? '' : value)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }

      function normalizeWorkspace(raw) {
        return String(raw || '').trim().toLowerCase().replace(/\s+/g, '-');
      }

      function formatMoney(v) {
        var n = Number(v || 0);
        if (!isFinite(n) || n === 0) return '$' + '0';
        return '$' + n.toLocaleString();
      }

      function getCookie(name) {
        var m = document.cookie.match(new RegExp('(?:^|; )' + name + '=([^;]*)'));
        return m ? decodeURIComponent(m[1]) : null;
      }

      function currentUserId() {
        return parseInt(getCookie('camarad_user_id') || '0', 10) || 0;
      }

      function relativeTime(isoStr) {
        if (!isoStr) return 'just now';
        var d = new Date(isoStr);
        if (isNaN(d.getTime())) return 'just now';
        var seconds = Math.floor((Date.now() - d.getTime()) / 1000);
        if (seconds < 60) return 'just now';
        if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
        if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
        return Math.floor(seconds / 86400) + 'd ago';
      }

      function toast(msg, type) {
        if (window.showToast) {
          window.showToast('Active Context', msg, type || 'info');
        }
      }

      function defaultWorkspaceData() {
        return {
          personal: {
            score: 78,
            summary: 'Tasks: 12 | Streak: 8 days.',
            kpis: ['Tasks: 12', 'Habit streak: 8 days', 'Mood trend: +6%'],
            alert: 'Energy drop detected after 17:00. Consider lighter tasks.',
            targetAgent: ''
          },
          business: {
            score: 85,
            summary: 'MRR: $4,812 | ROAS avg: 3.8x.',
            kpis: ['MRR: $4,812', 'Cash flow: stable', 'ROAS avg: 3.8x'],
            alert: 'ROAS dipped under 3x on one campaign. Review allocation.',
            targetAgent: ''
          },
          agency: {
            score: 68,
            summary: 'Reach: 145k | Leads this week: 23.',
            kpis: ['ROAS ads: 2.9x', 'Leads this week: 23', 'Sentiment: positive'],
            alert: 'Creative fatigue rising on top ad set. Rotate variants.',
            targetAgent: ''
          },
          development: {
            score: 92,
            summary: 'Deployments stable | Open issues: 8.',
            kpis: ['Deploy success: 98%', 'Open issues: 8', 'Uptime: 99.96%'],
            alert: 'One medium-priority issue waiting for triage.',
            targetAgent: ''
          }
        };
      }

      function computeGlobalScore() {
        var total = 0;
        var count = 0;
        WS_ORDER.forEach(function(wsKey) {
          var ws = state.workspaces[wsKey];
          if (!ws) return;
          total += clamp(ws.score, 0, 100);
          count += 1;
        });
        return count ? Math.round(total / count) : 0;
      }

      function findAgentBySlug(slug) {
        if (!slug) return null;
        for (var i = 0; i < state.agentsCatalog.length; i++) {
          if (state.agentsCatalog[i].slug === slug) return state.agentsCatalog[i];
        }
        return null;
      }

      function pickAgentForWorkspace(wsKey) {
        var wsState = state.workspaces[wsKey] || {};
        var direct = findAgentBySlug(wsState.targetAgent);
        if (direct) {
          return {
            slug: direct.slug,
            name: direct.name || direct.slug,
            workspace_slug: normalizeWorkspace(direct.workspace_slug || direct.workspace || wsKey) || wsKey
          };
        }

        var sameWorkspace = state.agentsCatalog.filter(function(a) {
          return normalizeWorkspace(a.workspace_slug || a.workspace) === wsKey;
        });

        if (sameWorkspace.length) {
          var active = sameWorkspace.find(function(a) {
            return String(a.status || '').toLowerCase() === 'active';
          }) || sameWorkspace[0];

          return {
            slug: active.slug,
            name: active.name || active.slug,
            workspace_slug: normalizeWorkspace(active.workspace_slug || active.workspace || wsKey) || wsKey
          };
        }

        var fallbackSlug = WS_META[wsKey] ? WS_META[wsKey].fallbackAgent : '';
        if (!fallbackSlug) return null;

        return {
          slug: fallbackSlug,
          name: fallbackSlug.replace(/-/g, ' '),
          workspace_slug: wsKey
        };
      }

      function humanizeSlug(slug) {
        var raw = String(slug || '').trim();
        if (!raw) return 'Item';
        if (raw.toLowerCase() === 'life-coach') return 'Personal Assistant';
        return raw.replace(/[-_]+/g, ' ').replace(/\s+/g, ' ').trim().replace(/\b\w/g, function(ch) { return ch.toUpperCase(); });
      }

      function statusBadgeClass(status) {
        var s = String(status || '').toLowerCase();
        if (s === 'active' || s === 'connected' || s === 'live' || s === 'ok') return 'bg-success';
        if (s === 'error' || s === 'failed' || s === 'inactive') return 'bg-danger';
        if (s === 'disconnected' || s === 'warning' || s === 'pending' || s === 'ready') return 'bg-warning text-dark';
        return 'bg-secondary';
      }

      function connectorOverviewEndpoint(slug) {
        var s = String(slug || '').trim();
        if (!s) return '';
        return '/api/connectors/' + encodeURIComponent(s) + '/overview';
      }

      function findAgentCatalogEntry(slug) {
        if (!slug) return null;
        return state.agentsCatalog.find(function(a) { return a && a.slug === slug; }) || null;
      }

      function findConnectorCatalogEntry(slug) {
        if (!slug) return null;
        return state.connectorsCatalog.find(function(c) { return c && c.slug === slug; }) || null;
      }

      async function fetchConnectorsCatalog() {
        try {
          var res = await fetch('/api/connectors/list', { cache: 'no-store' });
          var data = await res.json();
          state.connectorsCatalog = Array.isArray(data)
            ? data.filter(function(c) { return c && c.slug; })
            : [];
        } catch (err) {
          state.connectorsCatalog = [];
        }
      }

      async function ensureCatalogsLoaded() {
        if (!state.agentsCatalog.length) {
          await fetchAgentsCatalog();
        }
        if (!state.connectorsCatalog.length) {
          await fetchConnectorsCatalog();
        }
      }

      async function getAgentConfig(slug) {
        if (!slug) return {};
        if (state.agentConfigCache[slug]) return state.agentConfigCache[slug];
        try {
          var res = await fetch('/api/agents/' + encodeURIComponent(slug), { cache: 'no-store' });
          var data = await res.json();
          state.agentConfigCache[slug] = data || {};
        } catch (err) {
          state.agentConfigCache[slug] = {};
        }
        return state.agentConfigCache[slug];
      }

      async function getAgentBrief(slug) {
        if (!slug) return null;
        if (state.agentBriefCache[slug]) return state.agentBriefCache[slug];
        try {
          var res = await fetch('/api/orchestrator/agent-brief/' + encodeURIComponent(slug), { cache: 'no-store' });
          if (!res.ok) {
            state.agentBriefCache[slug] = null;
          } else {
            state.agentBriefCache[slug] = await res.json();
          }
        } catch (err) {
          state.agentBriefCache[slug] = null;
        }
        return state.agentBriefCache[slug];
      }

      function asDataImageSrc(raw, fallbackMime) {
        var value = String(raw || '').trim();
        if (!value) return '';
        if (value.indexOf('data:image') === 0) return value;
        return 'data:' + (fallbackMime || 'image/png') + ';base64,' + value;
      }

      function maskApiKey(value) {
        var v = String(value || '').trim();
        if (!v) return '';
        if (v.length <= 6) return '••••••';
        return v.slice(0, 3) + '••••••' + v.slice(-2);
      }

      async function getAgentConversationStats(slug, wsSlug) {
        if (!slug) {
          return { totalChats: 0, totalMessages: 0, lastResponseAt: '', lastMessage: '' };
        }

        var key = String(slug) + '::' + (wsSlug || 'any');
        if (state.agentConversationCache[key]) {
          return state.agentConversationCache[key];
        }

        var data = [];
        try {
          var res = await fetch('/api/conversations', { cache: 'no-store' });
          data = await res.json();
        } catch (err) {
          data = [];
        }

        var list = Array.isArray(data) ? data : [];
        var normalizedWs = normalizeWorkspace(wsSlug || '');
        var matches = list.filter(function(c) {
          return c && c.agent_slug === slug;
        });

        if (normalizedWs) {
          var wsMatches = matches.filter(function(c) {
            return normalizeWorkspace(c.workspace_slug || '') === normalizedWs;
          });
          if (wsMatches.length) {
            matches = wsMatches;
          }
        }

        var totalMessages = matches.reduce(function(sum, c) {
          return sum + (Number(c.msg_count || 0) || 0);
        }, 0);

        var latest = matches[0] || null;
        var result = {
          totalChats: matches.length,
          totalMessages: totalMessages,
          lastResponseAt: latest ? (latest.last_message_at || latest.last_activity || '') : '',
          lastMessage: latest ? String(latest.last_message || '') : ''
        };

        state.agentConversationCache[key] = result;
        return result;
      }

      async function saveAgentConfigPatch(slug, patch) {
        if (!slug) {
          throw new Error('Missing agent slug');
        }

        var current = await getAgentConfig(slug);
        var base = current && typeof current === 'object' ? current : {};
        var next = patch && typeof patch === 'object' ? patch : {};

        var payload = {
          custom_name: next.custom_name !== undefined ? next.custom_name : (base.custom_name || humanizeSlug(slug)),
          avatar_base64: next.avatar_base64 !== undefined ? next.avatar_base64 : (base.avatar_base64 || null),
          avatar_colors: next.avatar_colors !== undefined ? next.avatar_colors : (base.avatar_colors || null),
          llm_provider: next.llm_provider !== undefined ? next.llm_provider : (base.llm_provider || 'Grok'),
          llm_model: next.llm_model !== undefined ? next.llm_model : (base.llm_model || 'grok-beta'),
          api_key: next.api_key !== undefined ? next.api_key : (base.api_key || ''),
          temperature: next.temperature !== undefined ? Number(next.temperature) : Number(base.temperature || 0.7),
          max_tokens: next.max_tokens !== undefined ? parseInt(next.max_tokens, 10) : parseInt(base.max_tokens || 2048, 10),
          rag_enabled: next.rag_enabled !== undefined ? !!next.rag_enabled : !!base.rag_enabled,
          status: next.status !== undefined ? String(next.status || 'Active') : String(base.status || 'Active')
        };

        if (!isFinite(payload.temperature)) payload.temperature = 0.7;
        if (!isFinite(payload.max_tokens) || payload.max_tokens <= 0) payload.max_tokens = 2048;

        var resp = await fetch('/api/agents/' + encodeURIComponent(slug), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!resp.ok) {
          throw new Error('Agent save failed (HTTP ' + resp.status + ')');
        }

        state.agentConfigCache[slug] = payload;
        return payload;
      }

      async function saveConnectorConfigPatch(slug, patch) {
        if (!slug) {
          throw new Error('Missing connector slug');
        }

        var current = await getConnectorConfig(slug);
        var base = current && typeof current === 'object' ? current : {};
        var next = patch && typeof patch === 'object' ? patch : {};

        var baseCfg = (base.config && typeof base.config === 'object') ? base.config : {};
        var nextCfg = (next.config && typeof next.config === 'object') ? next.config : {};
        var mergedCfg = Object.assign({}, baseCfg, nextCfg);

        if (next.custom_name !== undefined) {
          var customName = String(next.custom_name || '').trim();
          if (customName) {
            mergedCfg.custom_name = customName;
          } else {
            delete mergedCfg.custom_name;
          }
        }

        var payload = {
          status: next.status !== undefined ? String(next.status || 'Disconnected') : String(base.status || 'Disconnected'),
          config: mergedCfg
        };

        if (next.custom_name !== undefined) {
          payload.custom_name = String(next.custom_name || '').trim();
        }

        var resp = await fetch('/api/connectors/' + encodeURIComponent(slug), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!resp.ok) {
          throw new Error('Connector save failed (HTTP ' + resp.status + ')');
        }

        delete state.connectorConfigCache[slug];
        return await getConnectorConfig(slug);
      }

      function readFileAsDataUrl(file) {
        return new Promise(function(resolve, reject) {
          var reader = new FileReader();
          reader.onload = function() { resolve(String(reader.result || '')); };
          reader.onerror = function() { reject(new Error('Failed to read file')); };
          reader.readAsDataURL(file);
        });
      }

      async function handleAgentAvatarInput(inputEl) {
        if (!inputEl || !inputEl.files || !inputEl.files[0]) return;

        var file = inputEl.files[0];
        if (!String(file.type || '').toLowerCase().startsWith('image/')) {
          toast('Please choose an image file.', 'warning');
          inputEl.value = '';
          return;
        }

        if (Number(file.size || 0) > 2 * 1024 * 1024) {
          toast('Avatar image is too large (max 2MB).', 'warning');
          inputEl.value = '';
          return;
        }

        var slug = String(inputEl.getAttribute('data-slug') || '').trim();
        if (!slug) {
          toast('Missing agent slug for avatar upload.', 'warning');
          inputEl.value = '';
          return;
        }

        try {
          var dataUrl = await readFileAsDataUrl(file);
          var base64 = dataUrl.indexOf(',') >= 0 ? dataUrl.split(',')[1] : dataUrl;

          var avatarEl = document.getElementById('acx-agent-avatar');
          if (avatarEl) {
            avatarEl.setAttribute('src', dataUrl);
            avatarEl.setAttribute('data-pending-base64', base64);
            avatarEl.style.display = 'block';
          }
          var avatarFallback = document.getElementById('acx-agent-avatar-fallback');
          if (avatarFallback) {
            avatarFallback.style.display = 'none';
          }

          await saveAgentConfigPatch(slug, { avatar_base64: base64 });
          state.agentConversationCache = {};
          await fetchAgentsCatalog();
          toast('Avatar updated.', 'success');
        } catch (errAvatar) {
          toast('Avatar update failed: ' + (errAvatar && errAvatar.message ? errAvatar.message : 'unknown'), 'warning');
        } finally {
          inputEl.value = '';
        }
      }

      async function getConnectorConfig(slug) {
        if (!slug) return {};
        if (state.connectorConfigCache[slug]) return state.connectorConfigCache[slug];
        try {
          var res = await fetch('/api/connectors/' + encodeURIComponent(slug), { cache: 'no-store' });
          var data = await res.json();
          state.connectorConfigCache[slug] = data || {};
        } catch (err) {
          state.connectorConfigCache[slug] = {};
        }
        return state.connectorConfigCache[slug];
      }

      async function fetchConnectorOverview(slug) {
        var endpoint = connectorOverviewEndpoint(slug);
        if (!endpoint) return null;
        try {
          var res = await fetch(endpoint, { cache: 'no-store' });
          if (!res.ok) return null;
          var data = await res.json();
          return data && typeof data === 'object' ? data : null;
        } catch (err) {
          return null;
        }
      }

      function pickConfigValue(configObj, keys) {
        if (!configObj || typeof configObj !== 'object') return '';
        for (var i = 0; i < keys.length; i++) {
          var k = keys[i];
          if (configObj[k] !== undefined && configObj[k] !== null && String(configObj[k]).trim() !== '') {
            return String(configObj[k]);
          }
        }
        return '';
      }
      function getSignalByType(api, signalType, fallbackText) {
        var signals = Array.isArray((api || {}).contextual_signals) ? api.contextual_signals : [];
        var found = signals.find(function(s) {
          return String((s && s.type) || '').toLowerCase() === signalType;
        });
        return found && found.message ? found.message : fallbackText;
      }

      function hydrateFromApi(api) {
        var data = defaultWorkspaceData();

        var session = (api || {}).session || {};
        var business = (api || {}).business_context || {};
        var accounting = business.accounting_summary || {};
        var activeConnectors = Array.isArray(api.active_connectors) ? api.active_connectors.length : 0;
        var activeAgents = Array.isArray(api.active_agents) ? api.active_agents : [];
        var activeAgentsCount = activeAgents.length;
        var recentConvs = Array.isArray(api.recent_conversations) ? api.recent_conversations.length : 0;
        var interactionsToday = Number(session.interactions_today || 0);
        var cmiApprox = Number(((api || {}).maturity_snapshot || {}).cmi_score_approx || 42.8);
        var mrr = Number(accounting.mrr || 0);
        var runRate = String(accounting.runway || 'n/a');
        var health = String(accounting.health || 'stable');

        data.personal.score = clamp(66 + interactionsToday * 3 + recentConvs, 38, 97);
        data.personal.summary = 'Interactions: ' + interactionsToday + ' | Recent chats: ' + recentConvs + '.';
        data.personal.kpis = [
          'Tasks: ' + Math.max(6, interactionsToday + 5),
          'Recent chats: ' + recentConvs,
          'Workspace: ' + String(session.current_workspace || 'agency')
        ];
        data.personal.alert = getSignalByType(api, 'insight', data.personal.alert);

        data.business.score = clamp(Math.round(58 + (cmiApprox * 0.55) + (health === 'healthy' ? 6 : -5)), 34, 98);
        data.business.summary = 'MRR: ' + formatMoney(mrr) + ' | Runway: ' + runRate + '.';
        data.business.kpis = [
          'MRR: ' + formatMoney(mrr),
          'Runway: ' + runRate,
          'Health: ' + health
        ];
        data.business.alert = getSignalByType(api, 'alert', data.business.alert);

        data.agency.score = clamp(60 + activeConnectors * 4 + Math.min((api.contextual_signals || []).length * 2, 8), 36, 95);
        data.agency.summary = 'Connected tools: ' + activeConnectors + ' | Leads active.';
        data.agency.kpis = [
          'Connected tools: ' + activeConnectors,
          'Recent convs: ' + recentConvs,
          'Signals: ' + (Array.isArray(api.contextual_signals) ? api.contextual_signals.length : 0)
        ];
        data.agency.alert = getSignalByType(api, 'opportunity', data.agency.alert);

        data.development.score = clamp(70 + activeAgentsCount * 3 + Math.min(activeConnectors * 2, 12), 40, 99);
        data.development.summary = 'Active agents: ' + activeAgentsCount + ' | Connectors: ' + activeConnectors + '.';
        data.development.kpis = [
          'Active agents: ' + activeAgentsCount,
          'Connected tools: ' + activeConnectors,
          'Snapshot: ' + relativeTime(api.timestamp)
        ];
        data.development.alert = 'Infra stable. Keep issue triage under 10 open items.';

        if (state.agentsCatalog.length && activeAgents.length) {
          WS_ORDER.forEach(function(wsKey) {
            var match = state.agentsCatalog.find(function(a) {
              if (!a || !a.slug) return false;
              var inActive = activeAgents.some(function(raw) {
                return raw && raw.slug === a.slug;
              });
              if (!inActive) return false;
              return normalizeWorkspace(a.workspace_slug || a.workspace) === wsKey;
            });
            if (match) {
              data[wsKey].targetAgent = match.slug;
            }
          });
        }

        WS_ORDER.forEach(function(wsKey) {
          if (!data[wsKey].targetAgent && WS_META[wsKey].fallbackAgent) {
            data[wsKey].targetAgent = WS_META[wsKey].fallbackAgent;
          }
        });

        return data;
      }

      function inferWorkspaceFromSelection(selection) {
        var raw = selection && (selection.workspace || selection.workspace_slug || selection.ws || '');
        var ws = normalizeWorkspace(raw);
        if (!WS_META[ws]) {
          ws = state.focused && WS_META[state.focused] ? state.focused : 'business';
        }
        return ws;
      }

      function renderCompact() {
        WS_ORDER.forEach(function(wsKey) {
          var ws = state.workspaces[wsKey] || {};
          var score = clamp(ws.score, 0, 100);
          var scoreEl = document.getElementById('acx-score-' + wsKey);
          var barEl = document.getElementById('acx-bar-' + wsKey);
          var quadEl = el.compact.querySelector('.acx-quadrant[data-ws="' + wsKey + '"]');

          if (scoreEl) scoreEl.textContent = score + '%';
          if (barEl) barEl.style.width = score + '%';
          if (quadEl) {
            quadEl.style.opacity = String(0.28 + (score / 100) * 0.66);
          }
        });

        if (el.centerScore) {
          el.centerScore.textContent = clamp(state.globalScore, 0, 100) + '%';
        }

        if (el.panelScore) {
          el.panelScore.textContent = clamp(state.globalScore, 0, 100) + '%';
        }

        var cmiText = 'CMI ' + clamp(state.globalScore, 0, 100) + '%';
        if (el.center) {
          el.center.setAttribute('aria-label', 'Open Inspector (' + cmiText + ')');
        }
        if (el.compact) {
          el.compact.setAttribute('aria-label', 'Open Inspector panel, ' + cmiText);
        }
      }

      function renderOverview() {
        function buildActiveClientOverviewCard() {
          var client = null;
          var accounts = [];
          try {
            client = (window.CamaradClient && typeof window.CamaradClient.getActiveClient === 'function')
              ? window.CamaradClient.getActiveClient()
              : null;
          } catch (errClient) {
            client = null;
          }
          try {
            accounts = (window.CamaradClient && typeof window.CamaradClient.getClientAccounts === 'function')
              ? (window.CamaradClient.getClientAccounts() || [])
              : [];
          } catch (errAccounts) {
            accounts = [];
          }

          var hasClient = !!client;
          var displayName = hasClient
            ? (client.display_name || client.company_name || client.name || ('Client ' + String(client.id || ''))).trim()
            : 'None';
          var typeLabel = hasClient ? (String(client.type || 'person').toLowerCase() === 'company' ? 'Company' : 'Person') : 'Not selected';
          var statusBadge = hasClient
            ? '<span class="badge bg-primary">Active</span>'
            : '<span class="badge bg-secondary">None</span>';
          var linkedCount = Array.isArray(accounts) ? accounts.length : 0;
          var preview = hasClient
            ? (linkedCount ? (linkedCount + ' connected account' + (linkedCount === 1 ? '' : 's')) : 'No connected accounts yet')
            : 'Select a client from sidebar to scope data.';
          var accountLines = (Array.isArray(accounts) ? accounts.slice(0, 3) : []).map(function(acc) {
            var connectorName = humanizeSlug(acc.connector_slug || 'connector');
            var accountName = String(acc.account_name || acc.account_id || 'Account').trim();
            var status = String(acc.status || 'pending');
            return '<div class="acx-kpi-item">' + esc(connectorName + ': ' + accountName + ' (' + status + ')') + '</div>';
          }).join('');
          if (!accountLines) {
            accountLines = '<div class="acx-kpi-item text-muted">No linked connector accounts.</div>';
          }

          return ''
            + '<article class="acx-card is-focused" data-ws="' + (state.focused || 'business') + '" style="cursor:default;">'
            + '<div class="acx-card-head">'
            + '<div class="acx-card-title"><i class="bi bi-buildings"></i><span>Active Client</span></div>'
            + statusBadge
            + '</div>'
            + '<div class="acx-selection-grid mb-2">'
            + '<div class="k">Name</div><div class="v">' + esc(displayName) + '</div>'
            + '<div class="k">Type</div><div class="v">' + esc(typeLabel) + '</div>'
            + '<div class="k">Accounts</div><div class="v">' + String(linkedCount) + '</div>'
            + '</div>'
            + '<div class="acx-card-summary">' + esc(preview) + '</div>'
            + '<div class="acx-kpi-list">' + accountLines + '</div>'
            + '</article>';
        }

        var cardsHtml = WS_ORDER.map(function(wsKey) {
          var meta = WS_META[wsKey];
          var ws = state.workspaces[wsKey] || {};
          var focusClass = state.focused === wsKey ? ' is-focused' : '';
          var score = clamp(ws.score, 0, 100);
          var summary = ws.summary || (meta.label + ' context pending.');
          var alertText = ws.alert || 'No critical alerts right now.';
          var kpis = Array.isArray(ws.kpis) ? ws.kpis.slice(0, 3) : [];
          var kpiHtml = kpis.map(function(line) {
            return '<div class="acx-kpi-item">' + esc(line) + '</div>';
          }).join('');

          return ''
            + '<article class="acx-card' + focusClass + '" data-ws="' + wsKey + '">'
            + '<div class="acx-card-head">'
            + '<div class="acx-card-title"><i class="bi ' + meta.icon + '"></i><span>' + meta.label + '</span></div>'
            + '<div class="acx-score">' + score + '%</div>'
            + '</div>'
            + '<div class="acx-card-summary">' + esc(summary) + '</div>'
            + '<div class="acx-kpi-list">' + kpiHtml + '</div>'
            + '<div class="acx-alert">' + esc(alertText) + '</div>'
            + '<div class="acx-actions">'
            + '<button type="button" class="btn btn-outline-primary" data-acx-action="send" data-ws="' + wsKey + '"><i class="bi bi-send me-1"></i>Send</button>'
            + '<button type="button" class="btn btn-outline-success" data-acx-action="add" data-ws="' + wsKey + '"><i class="bi bi-plus-circle me-1"></i>Add</button>'
            + '</div>'
            + '</article>';
        }).join('');

        var maturityHtml = buildMaturityVisual();
        var clientCardHtml = buildActiveClientOverviewCard();
        el.grid.innerHTML = maturityHtml + clientCardHtml + cardsHtml;
        if (el.panelMeta) {
          el.panelMeta.textContent = 'Indices expanded | updated ' + relativeTime(state.lastUpdated);
        }
      }
            async function renderSelection(selection) {
        if (!selection || selection.kind === 'canvas') {
          state.mode = 'overview';
          renderOverview();
          return;
        }

        var seq = ++state.selectionSeq;
        var wsKey = inferWorkspaceFromSelection(selection);
        var wsMeta = WS_META[wsKey] || WS_META.business;
        var wsState = state.workspaces[wsKey] || {};
        var selectionKind = String(selection.kind || '').toLowerCase();
        var typeRaw = String(selection.nodeType || selection.type || selection.kind || 'node').toLowerCase();
        var label = selection.label || selection.name || humanizeSlug(selection.slug || typeRaw);
        var slug = String(selection.slug || '').trim();
        var nodeId = String(selection.id || '').trim();

        function stale() {
          return seq !== state.selectionSeq || state.mode !== 'selection';
        }

        function setMeta(text) {
          if (el.panelMeta) {
            el.panelMeta.textContent = text;
          }
        }

        function kv(key, value) {
          return '<div class="k">' + esc(key) + '</div><div class="v">' + esc(value || 'n/a') + '</div>';
        }

        function actionBtn(action, text, btnClass, attrs) {
          var a = attrs || '';
          return '<button type="button" class="btn ' + btnClass + '" data-acx-node-action="' + esc(action) + '" ' + a + '>' + text + '</button>';
        }

        function statusBadge(status) {
          var value = status || 'n/a';
          return '<span class="badge ' + statusBadgeClass(value) + '">' + esc(value) + '</span>';
        }

                if (selectionKind === 'client' || typeRaw === 'client') {
          var selectedClientId = parseInt(selection.client_id || selection.id || '', 10);
          if (!isFinite(selectedClientId) || selectedClientId <= 0) {
            el.grid.innerHTML = '<article class="acx-card is-focused" data-ws="' + wsKey + '"><div class="acx-card-summary">Select a valid client from sidebar.</div></article>';
            setMeta('Client selection unavailable.');
            return;
          }

          var clientLoadingHtml = ''
            + '<article class="acx-card is-focused" data-ws="' + wsKey + '">'
            + '<div class="acx-selection-chip"><i class="bi bi-buildings"></i><span>Client</span></div>'
            + '<div class="acx-card-summary">Loading client details...</div>'
            + '</article>';
          el.grid.innerHTML = clientLoadingHtml;
          setMeta('Client selected | loading details...');

          var clientRecord = null;
          var linkedAccounts = [];

          try {
            var clientResp = await fetch('/api/clients/' + encodeURIComponent(selectedClientId), { cache: 'no-store' });
            if (clientResp.ok) {
              clientRecord = await clientResp.json();
            }
          } catch (errClientFetch) {
            clientRecord = null;
          }

          try {
            var accountsResp = await fetch('/api/client_connectors?client_id=' + encodeURIComponent(selectedClientId), { cache: 'no-store' });
            if (accountsResp.ok) {
              var accountsData = await accountsResp.json();
              linkedAccounts = Array.isArray(accountsData) ? accountsData : [];
            }
          } catch (errAccountsFetch) {
            linkedAccounts = [];
          }

          if (stale()) return;

          var clientType = String((clientRecord && clientRecord.type) || selection.client_type || 'person').toLowerCase();
          var displayName = String((clientRecord && clientRecord.display_name) || selection.label || (clientRecord && (clientRecord.company_name || clientRecord.name)) || ('Client ' + selectedClientId)).trim();
          if (!displayName) displayName = 'Client ' + selectedClientId;

          var email = String((clientRecord && clientRecord.email) || selection.email || '').trim();
          var website = String((clientRecord && clientRecord.website) || selection.website || '').trim();
          var phone = String((clientRecord && clientRecord.phone) || selection.phone || '').trim();
          var address = String((clientRecord && clientRecord.address) || selection.address || '').trim();
          var notes = String((clientRecord && clientRecord.notes) || selection.notes || '').trim();

          var contactRows = '';
          if (email) contactRows += kv('Email', email);
          if (website) contactRows += kv('Website', website);
          if (phone) contactRows += kv('Phone', phone);
          if (address) contactRows += kv('Address', address);
          if (!contactRows) contactRows = kv('Contact', 'No contact details yet');

          var accountsHtml = '';
          if (!linkedAccounts.length) {
            accountsHtml = ''
              + '<div class="acx-card" style="cursor:default; min-height:auto;">'
              + '<div class="acx-card-summary">No accounts linked for this client.</div>'
              + '<div class="mt-2">'
              + actionBtn('open-client-add-account', '<i class="bi bi-plus-lg me-1"></i>Add first account', 'btn-outline-primary', 'data-client-id="' + esc(String(selectedClientId)) + '"')
              + '</div>'
              + '</div>';
          } else {
            accountsHtml = linkedAccounts.slice(0, 8).map(function(acc) {
              var connectorLabel = humanizeSlug(acc.connector_slug || 'connector');
              var accountLabel = String(acc.account_name || acc.account_id || 'Account').trim();
              var status = String(acc.status || 'pending').trim() || 'pending';
              var linkId = String(acc.id || '').trim();

              var disconnectBtn = '';
              if (linkId) {
                disconnectBtn = actionBtn(
                  'unlink-client-account',
                  '<i class="bi bi-unlink me-1"></i>Disconnect',
                  'btn-outline-danger',
                  'data-link-id="' + esc(linkId) + '" data-client-id="' + esc(String(selectedClientId)) + '"'
                );
              }

              return ''
                + '<div class="acx-card" style="cursor:default; min-height:auto;">'
                + '<div class="acx-card-head">'
                + '<div class="acx-card-title"><i class="bi bi-plug"></i><span>' + esc(connectorLabel) + '</span></div>'
                + '<span class="badge ' + statusBadgeClass(status) + '">' + esc(status) + '</span>'
                + '</div>'
                + '<div class="acx-card-summary">' + esc(accountLabel) + '</div>'
                + (disconnectBtn ? ('<div class="mt-1">' + disconnectBtn + '</div>') : '')
                + '</div>';
            }).join('');
          }
          var personName = String((clientRecord && clientRecord.name) || selection.name || '').trim();
          var companyName = String((clientRecord && clientRecord.company_name) || selection.company_name || '').trim();
          if (!personName && clientType === 'person') personName = displayName;
          if (!companyName && clientType === 'company') companyName = displayName;

          var clientHtml = ''
            + '<article class="acx-card is-focused" data-ws="' + wsKey + '" style="cursor:default;">'
            + '<div class="acx-selection-chip"><i class="bi bi-buildings"></i><span>' + esc(displayName) + '</span><span class="badge bg-secondary">' + esc(clientType === 'company' ? 'Company' : 'Person') + '</span></div>'
            + '<div class="acx-selection-grid">'
            + kv('Client ID', String(selectedClientId))
            + kv('Workspace', wsMeta.label)
            + kv('Accounts', String(linkedAccounts.length))
            + kv('Scope', 'Client filtered')
            + '</div>'

            + '<div class="row g-2 mb-2">'
            + '<div class="col-6">'
            + '<label class="form-label small text-muted mb-1">Type</label>'
            + '<select id="acx-client-type" class="form-select form-select-sm bg-dark text-light border-secondary">'
            + '<option value="person"' + (clientType === 'person' ? ' selected' : '') + '>Person</option>'
            + '<option value="company"' + (clientType === 'company' ? ' selected' : '') + '>Company</option>'
            + '</select>'
            + '</div>'
            + '<div class="col-6">'
            + '<label class="form-label small text-muted mb-1">Name</label>'
            + '<input id="acx-client-name" type="text" class="form-control form-control-sm bg-dark text-light border-secondary" value="' + esc(personName) + '" placeholder="John Doe">'
            + '</div>'
            + '</div>'

            + '<div class="mb-2">'
            + '<label class="form-label small text-muted mb-1">Company Name</label>'
            + '<input id="acx-client-company" type="text" class="form-control form-control-sm bg-dark text-light border-secondary" value="' + esc(companyName) + '" placeholder="TechStart Agency">'
            + '</div>'

            + '<div class="mb-2">'
            + '<label class="form-label small text-muted mb-1">Email</label>'
            + '<input id="acx-client-email" type="email" class="form-control form-control-sm bg-dark text-light border-secondary" value="' + esc(email) + '" placeholder="client@example.com">'
            + '</div>'

            + '<div class="mb-2">'
            + '<label class="form-label small text-muted mb-1">Website</label>'
            + '<input id="acx-client-website" type="text" class="form-control form-control-sm bg-dark text-light border-secondary" value="' + esc(website) + '" placeholder="https://example.com">'
            + '</div>'

            + '<div class="mb-2">'
            + '<label class="form-label small text-muted mb-1">Phone</label>'
            + '<input id="acx-client-phone" type="text" class="form-control form-control-sm bg-dark text-light border-secondary" value="' + esc(phone) + '" placeholder="+1 555 123 456">'
            + '</div>'

            + '<div class="mb-2">'
            + '<label class="form-label small text-muted mb-1">Address</label>'
            + '<input id="acx-client-address" type="text" class="form-control form-control-sm bg-dark text-light border-secondary" value="' + esc(address) + '" placeholder="Street, City">'
            + '</div>'

            + '<div class="mb-2">'
            + '<label class="form-label small text-muted mb-1">Notes</label>'
            + '<textarea id="acx-client-notes" rows="3" class="form-control form-control-sm bg-dark text-light border-secondary" placeholder="Optional notes">' + esc(notes) + '</textarea>'
            + '</div>'

            + '<div class="acx-actions">'
            + actionBtn('save-client', '<i class="bi bi-save me-1"></i>Save', 'btn-outline-success', 'data-client-id="' + esc(String(selectedClientId)) + '"')
            + actionBtn('open-new-client-chat', '<i class="bi bi-chat-dots me-1"></i>New Chat', 'btn-outline-primary', 'data-client-id="' + esc(String(selectedClientId)) + '"')
            + actionBtn('open-client-add-account', '<i class="bi bi-plus-lg me-1"></i>Add Account', 'btn-outline-secondary', 'data-client-id="' + esc(String(selectedClientId)) + '"')
            + '</div>'

            + '<div class="mt-2 d-flex gap-2 flex-wrap">'
            + actionBtn('refresh-client-accounts', '<i class="bi bi-arrow-repeat me-1"></i>Refresh', 'btn-outline-secondary', 'data-client-id="' + esc(String(selectedClientId)) + '"')
            + actionBtn('delete-client', '<i class="bi bi-trash me-1"></i>Delete', 'btn-outline-danger', 'data-client-id="' + esc(String(selectedClientId)) + '"')
            + actionBtn('help-client', '<i class="bi bi-question-circle me-1"></i>Help', 'btn-outline-info', '')
            + '</div>'
            + '</article>'
            + accountsHtml;

          el.grid.innerHTML = clientHtml;
          setMeta('Client selected | updated ' + relativeTime(state.lastUpdated));
          return;
        }

                if (selectionKind === 'connection' || typeRaw === 'connection') {
          var connFrom = String(selection.from || 'n/a');
          var connTo = String(selection.to || 'n/a');
          var connFromType = String(selection.from_type || 'node').trim().toLowerCase() || 'node';
          var connToType = String(selection.to_type || 'node').trim().toLowerCase() || 'node';
          var connFromStatus = String(selection.from_status || '').trim();
          var connToStatus = String(selection.to_status || '').trim();
          var connDataType = normalizeConnectionDataType(selection.connection_data_type || selection.data_type || 'text');
          var connStatus = normalizeConnectionStatus(selection.connection_status || selection.status || 'active');
          var connPayload = (selection.last_payload !== undefined && selection.last_payload !== null)
            ? String(selection.last_payload)
            : '';
          if (!connPayload.trim()) {
            connPayload = buildConnectionFallbackPayload(connDataType, connFrom, connTo);
          }

          var connLastTransmission = String(selection.last_transmission || selection.lastTransmission || '').trim();
          var connLastRelative = connLastTransmission ? relativeTime(connLastTransmission) : 'never';

          var nodeBadgeClass = function(nodeType) {
            var t = String(nodeType || '').toLowerCase();
            if (t === 'agent') return 'bg-primary-subtle text-primary-emphasis';
            if (t === 'connector') return 'bg-warning-subtle text-warning-emphasis';
            if (t === 'trigger') return 'bg-success-subtle text-success-emphasis';
            if (t === 'condition') return 'bg-info-subtle text-info-emphasis';
            if (t === 'output') return 'bg-danger-subtle text-danger-emphasis';
            return 'bg-secondary-subtle text-secondary-emphasis';
          };

          var connHtml = ''
            + '<article class="acx-card is-focused" data-ws="' + wsKey + '">'
            + '<div class="acx-selection-chip"><i class="bi bi-bezier2"></i><span>Connection</span>' + connectionStatusBadge(connStatus) + '</div>'

            + '<div class="acx-grid-two" style="margin-bottom:10px;">'
            + '<div class="acx-kpi">'
            + '<div class="label">From</div>'
            + '<div class="value"><span class="badge ' + nodeBadgeClass(connFromType) + '">' + esc(connFromType.toUpperCase()) + '</span></div>'
            + '<div class="hint">' + esc(connFrom) + (connFromStatus ? (' • ' + esc(connFromStatus)) : '') + '</div>'
            + '</div>'
            + '<div class="acx-kpi">'
            + '<div class="label">To</div>'
            + '<div class="value"><span class="badge ' + nodeBadgeClass(connToType) + '">' + esc(connToType.toUpperCase()) + '</span></div>'
            + '<div class="hint">' + esc(connTo) + (connToStatus ? (' • ' + esc(connToStatus)) : '') + '</div>'
            + '</div>'
            + '</div>'

            + '<div class="acx-form-group">'
            + '<div class="acx-field-label">Data type transmitted</div>'
            + '<select id="acx-connection-data-type" class="form-select form-select-sm bg-dark text-light border-secondary">'
            + '<option value="text"' + (connDataType === 'text' ? ' selected' : '') + '>Text / Response</option>'
            + '<option value="json"' + (connDataType === 'json' ? ' selected' : '') + '>JSON</option>'
            + '<option value="metrics"' + (connDataType === 'metrics' ? ' selected' : '') + '>Metrics</option>'
            + '<option value="file"' + (connDataType === 'file' ? ' selected' : '') + '>File / Asset</option>'
            + '<option value="event"' + (connDataType === 'event' ? ' selected' : '') + '>Event</option>'
            + '</select>'
            + '</div>'

            + '<div class="acx-form-group">'
            + '<div class="acx-field-label">Connection status</div>'
            + '<select id="acx-connection-status" class="form-select form-select-sm bg-dark text-light border-secondary">'
            + '<option value="active"' + (connStatus === 'active' ? ' selected' : '') + '>Active</option>'
            + '<option value="pending"' + (connStatus === 'pending' ? ' selected' : '') + '>Pending</option>'
            + '<option value="error"' + (connStatus === 'error' ? ' selected' : '') + '>Error</option>'
            + '</select>'
            + '<div id="acx-connection-last" class="acx-hint">Last transmission: ' + esc(connLastRelative) + '</div>'
            + '</div>'

            + '<div class="acx-form-group">'
            + '<div class="acx-field-label">Last payload preview (mock)</div>'
            + '<textarea id="acx-connection-preview" rows="5" class="form-control form-control-sm bg-dark text-light border-secondary" style="white-space:pre;">' + esc(connPayload) + '</textarea>'
            + '</div>'

            + '<div class="acx-selection-grid">'
            + kv('Connection ID', selection.id || 'n/a')
            + kv('Workspace', wsMeta.label)
            + kv('Path', connFrom + ' -> ' + connTo)
            + kv('Status', connStatus)
            + '</div>'

            + '<div class="acx-actions">'
            + actionBtn('test-connection', '<i class="bi bi-play-circle me-1"></i>Test', 'btn-outline-primary', 'data-connection-id="' + esc(selection.id || '') + '"')
            + actionBtn('save-connection', '<i class="bi bi-save me-1"></i>Save', 'btn-outline-success', 'data-connection-id="' + esc(selection.id || '') + '"')
            + actionBtn('delete-connection', '<i class="bi bi-trash me-1"></i>Delete', 'btn-outline-danger', 'data-connection-id="' + esc(selection.id || '') + '"')
            + '</div>'
            + '<div class="mt-2 d-flex gap-2 flex-wrap">'
            + actionBtn('view-data-flow', '<i class="bi bi-diagram-3 me-1"></i>View Data', 'btn-outline-secondary', 'data-connection-id="' + esc(selection.id || '') + '"')
            + actionBtn('help-connection', '<i class="bi bi-question-circle me-1"></i>Help', 'btn-outline-info', '')
            + '</div>'
            + '</article>';

          el.grid.innerHTML = connHtml;
          setMeta('Connection selected | updated ' + relativeTime(state.lastUpdated));
          return;
        }

        if (typeRaw === 'agent') {
          var loadingHtml = ''
            + '<article class="acx-card is-focused" data-ws="' + wsKey + '">'
            + '<div class="acx-selection-chip"><i class="bi bi-robot"></i><span>' + esc(label) + '</span></div>'
            + '<div class="acx-card-summary">Loading agent details...</div>'
            + '</article>';
          el.grid.innerHTML = loadingHtml;
          setMeta('Agent selected | loading details...');

          await ensureCatalogsLoaded();
          var agentCatalog = findAgentCatalogEntry(slug);
          var agentCfg = await getAgentConfig(slug);
          var agentBrief = await getAgentBrief(slug);
          var wsSlug = normalizeWorkspace((selection.workspace_slug || selection.workspace || (agentCatalog && agentCatalog.workspace_slug) || wsKey || 'agency')) || wsKey;
          var conversationStats = await getAgentConversationStats(slug, wsSlug);
          if (stale()) return;

          var displayName = selection.label || agentCfg.custom_name || (agentCatalog && agentCatalog.name) || humanizeSlug(slug || 'agent');
          var agentStatus = selection.status || agentCfg.status || (agentCatalog && agentCatalog.status) || 'Active';
          var provider = agentCfg.llm_provider || 'Grok';
          var model = agentCfg.llm_model || 'grok-beta';
          var ragEnabled = !!agentCfg.rag_enabled;
          var ragChunks = Number(agentCfg.rag_chunks || 0);
          if (!isFinite(ragChunks) || ragChunks < 0) ragChunks = 0;
          var liveConnectors = agentBrief && agentBrief.total_live !== undefined ? String(agentBrief.total_live) : 'n/a';
          var temperature = Number(agentCfg.temperature);
          if (!isFinite(temperature)) temperature = 0.7;
          var maxTokens = parseInt(agentCfg.max_tokens, 10);
          if (!isFinite(maxTokens) || maxTokens <= 0) maxTokens = 2048;

          var activeChats = Number(agentCfg.active_conversations || conversationStats.totalChats || 0) || 0;
          var lastResponseAt = agentCfg.last_response_time || conversationStats.lastResponseAt || '';
          var lastResponseText = lastResponseAt ? relativeTime(lastResponseAt) : 'No replies yet';
          var lastMessagePreview = String(conversationStats.lastMessage || '').trim();
          if (lastMessagePreview.length > 120) {
            lastMessagePreview = lastMessagePreview.slice(0, 120) + '...';
          }

          var apiKey = String(agentCfg.api_key || '');
          var byokEnabled = apiKey.trim().length > 0;
          var maskedKey = maskApiKey(apiKey);

          var avatarSrc = asDataImageSrc(agentCfg.avatar_base64 || '');
          var hasAvatar = !!avatarSrc;

          var providerOptions = ['Grok', 'OpenAI', 'Anthropic', 'Gemini'];
          var providerHtml = providerOptions.map(function(opt) {
            return '<option value="' + esc(opt) + '"' + (String(provider).toLowerCase() === String(opt).toLowerCase() ? ' selected' : '') + '>' + esc(opt) + '</option>';
          }).join('');

          var agentHtml = ''
            + '<article class="acx-card is-focused" data-ws="' + wsKey + '">'
            + '<div class="acx-selection-chip"><i class="bi bi-robot"></i><span>Agent Inspector</span>' + statusBadge(agentStatus) + '</div>'
            + '<div class="d-flex align-items-center gap-2 mb-2">'
            + '<div class="position-relative" style="width:76px;height:76px;">'
            + '<img id="acx-agent-avatar" src="' + esc(avatarSrc) + '" alt="' + esc(displayName) + '" style="width:76px;height:76px;border-radius:50%;object-fit:cover;border:1px solid #30363d;display:' + (hasAvatar ? 'block' : 'none') + ';">'
            + '<div id="acx-agent-avatar-fallback" style="width:76px;height:76px;border-radius:50%;display:' + (hasAvatar ? 'none' : 'grid') + ';place-items:center;background:#161b22;border:1px solid #30363d;"><i class="bi bi-robot" style="font-size:1.4rem;color:#8b949e"></i></div>'
            + '<input id="acx-agent-avatar-upload" type="file" accept="image/*" data-slug="' + esc(slug) + '" style="display:none;">'
            + '<button type="button" class="btn btn-sm btn-outline-light" data-acx-node-action="pick-agent-avatar" data-slug="' + esc(slug) + '" style="position:absolute;right:-4px;bottom:-4px;border-radius:999px;padding:0.15rem 0.35rem;"><i class="bi bi-camera"></i></button>'
            + '</div>'
            + '<div class="flex-fill">'
            + '<label class="form-label small text-muted mb-1">Name</label>'
            + '<input id="acx-agent-name" type="text" class="form-control form-control-sm bg-dark text-light border-secondary" value="' + esc(displayName) + '" placeholder="Agent name">'
            + '<div class="small text-muted mt-1">Slug: ' + esc(slug || 'n/a') + '</div>'
            + '</div>'
            + '</div>'

            + '<div class="mb-2">'
            + '<label class="form-label small text-muted mb-1">Status</label>'
            + '<select id="acx-agent-status" class="form-select form-select-sm bg-dark text-light border-secondary">'
            + '<option value="Active"' + (String(agentStatus).toLowerCase() === 'active' ? ' selected' : '') + '>Active</option>'
            + '<option value="Inactive"' + (String(agentStatus).toLowerCase() === 'inactive' ? ' selected' : '') + '>Inactive</option>'
            + '<option value="Ready"' + (String(agentStatus).toLowerCase() === 'ready' ? ' selected' : '') + '>Ready</option>'
            + '</select>'
            + '</div>'

            + '<div class="mb-2">'
            + '<label class="form-label small text-muted mb-1">LLM Provider</label>'
            + '<select id="acx-agent-provider" class="form-select form-select-sm bg-dark text-light border-secondary">' + providerHtml + '</select>'
            + '</div>'

            + '<div class="mb-2">'
            + '<label class="form-label small text-muted mb-1">Model</label>'
            + '<input id="acx-agent-model" type="text" class="form-control form-control-sm bg-dark text-light border-secondary" value="' + esc(model) + '" placeholder="grok-beta">'
            + '</div>'

            + '<div class="mb-2">'
            + '<label class="form-label small text-muted mb-1">Temperature <span id="acx-agent-temperature-value">' + esc(temperature.toFixed(1)) + '</span></label>'
            + '<input id="acx-agent-temperature" type="range" class="form-range" min="0" max="2" step="0.1" value="' + esc(temperature.toFixed(1)) + '">'
            + '</div>'

            + '<div class="mb-2">'
            + '<label class="form-label small text-muted mb-1">Max tokens</label>'
            + '<input id="acx-agent-max-tokens" type="number" min="64" max="32768" step="1" class="form-control form-control-sm bg-dark text-light border-secondary" value="' + esc(String(maxTokens)) + '">'
            + '</div>'

            + '<div class="form-check form-switch mb-1">'
            + '<input id="acx-agent-byok-toggle" class="form-check-input" type="checkbox" role="switch"' + (byokEnabled ? ' checked' : '') + '>'
            + '<label class="form-check-label small text-muted" for="acx-agent-byok-toggle">BYOK API key</label>'
            + '</div>'
            + '<div class="mb-2">'
            + '<input id="acx-agent-api-key" type="password" class="form-control form-control-sm bg-dark text-light border-secondary" placeholder="' + esc(maskedKey || 'Enter API key') + '"' + (byokEnabled ? '' : ' disabled') + '>'
            + '</div>'

            + '<div class="form-check form-switch mb-2">'
            + '<input id="acx-agent-rag-enabled" class="form-check-input" type="checkbox" role="switch"' + (ragEnabled ? ' checked' : '') + '>'
            + '<label class="form-check-label small text-muted" for="acx-agent-rag-enabled">RAG enabled (' + esc(String(ragChunks)) + ' chunks)</label>'
            + '</div>'

            + '<div class="acx-selection-grid">'
            + kv('Workspace', wsMeta.label)
            + kv('Last response', lastResponseText)
            + kv('Active chats', String(activeChats))
            + kv('Messages', String(conversationStats.totalMessages || 0))
            + kv('Live connectors', liveConnectors)
            + kv('Node links', String(selection.connections || 0))
            + '</div>'

            + '<div class="acx-card-summary">' + esc(lastMessagePreview || 'No recent message preview.') + '</div>'
            + '<div class="acx-actions">'
            + actionBtn('save-agent', '<i class="bi bi-save me-1"></i>Save', 'btn-outline-success', 'data-slug="' + esc(slug) + '" data-node-id="' + esc(nodeId) + '" data-workspace="' + esc(wsSlug) + '"')
            + actionBtn('chat-agent', '<i class="bi bi-chat-dots me-1"></i>Chat', 'btn-outline-primary', 'data-slug="' + esc(slug) + '" data-workspace="' + esc(wsSlug) + '"')
            + actionBtn('edit-agent', '<i class="bi bi-sliders me-1"></i>Edit Full', 'btn-outline-secondary', 'data-slug="' + esc(slug) + '"')
            + actionBtn('delete-node', '<i class="bi bi-trash me-1"></i>Delete', 'btn-outline-danger', 'data-node-id="' + esc(nodeId) + '"')
            + '</div>'
            + '<div class="mt-2 d-flex gap-2">'
            + actionBtn('manage-agent-knowledge', '<i class="bi bi-journal-richtext me-1"></i>Knowledge', 'btn-outline-info', 'data-slug="' + esc(slug) + '"')
            + actionBtn('help-agent', '<i class="bi bi-question-circle me-1"></i>Help', 'btn-outline-info', '')
            + '</div>'
            + '</article>';

          el.grid.innerHTML = agentHtml;
          setMeta('Agent selected | updated ' + relativeTime(state.lastUpdated));
          return;
        }
        if (typeRaw === 'connector') {
          var connLoading = ''
            + '<article class="acx-card is-focused" data-ws="' + wsKey + '">'
            + '<div class="acx-selection-chip"><i class="bi bi-plug"></i><span>' + esc(label) + '</span></div>'
            + '<div class="acx-card-summary">Loading connector details...</div>'
            + '</article>';
          el.grid.innerHTML = connLoading;
          setMeta('Connector selected | loading details...');

          await ensureCatalogsLoaded();
          var connectorCatalog = findConnectorCatalogEntry(slug);
          var connectorCfg = await getConnectorConfig(slug);
          var connectorOverview = await fetchConnectorOverview(slug);
          if (stale()) return;

          var cfgObj = (connectorCfg && connectorCfg.config && typeof connectorCfg.config === 'object') ? connectorCfg.config : {};
          var connectorName = selection.label || cfgObj.custom_name || connectorCfg.custom_name || (connectorCatalog && connectorCatalog.name) || humanizeSlug(slug || 'connector');
          var connectorStatus = selection.status || connectorCfg.status || (connectorCatalog && connectorCatalog.status) || 'Disconnected';
          var accountText = pickConfigValue(cfgObj, ['account', 'account_id', 'customer_id', 'portal', 'workspace', 'store', 'property_id', 'account_name']);
          var regionText = pickConfigValue(cfgObj, ['region', 'country', 'locale']);
          var filtersText = pickConfigValue(cfgObj, ['filters', 'segment', 'campaign_filter']);
          var lastSyncText = connectorCfg.last_connected ? relativeTime(connectorCfg.last_connected) : 'Never';

          var rawApiKey = pickConfigValue(cfgObj, ['api_key', 'apiKey', 'access_token', 'token', 'secret', 'key']);
          var byokEnabled = String(rawApiKey || '').trim().length > 0;
          var maskedApiKey = maskApiKey(rawApiKey);

          var primitiveKpis = [];
          if (connectorOverview) {
            Object.keys(connectorOverview).forEach(function(k) {
              if (primitiveKpis.length >= 4) return;
              var v = connectorOverview[k];
              if (typeof v === 'string' || typeof v === 'number' || typeof v === 'boolean') {
                primitiveKpis.push({ key: k, value: String(v) });
              }
            });
          }

          var kpiHtml = primitiveKpis.length
            ? '<ul class="list-group list-group-flush small">' + primitiveKpis.map(function(item) {
                return '<li class="list-group-item bg-transparent border-secondary px-0 py-1">'
                  + '<span class="text-muted">' + esc(item.key) + ':</span> '
                  + '<span class="text-light">' + esc(item.value) + '</span>'
                  + '</li>';
              }).join('') + '</ul>'
            : '<div class="text-muted small">No KPI snapshot yet for this connector.</div>';

          var connectorHtml = ''
            + '<article class="acx-card is-focused" data-ws="' + wsKey + '">'
            + '<div class="acx-selection-chip"><i class="bi bi-plug"></i><span>Connector Inspector</span>' + statusBadge(connectorStatus) + '</div>'

            + '<div class="mb-2">'
            + '<label class="form-label small text-muted mb-1">Name</label>'
            + '<input id="acx-connector-name" type="text" class="form-control form-control-sm bg-dark text-light border-secondary" value="' + esc(connectorName) + '" placeholder="Connector name">'
            + '<div class="small text-muted mt-1">Slug: ' + esc(slug || 'n/a') + '</div>'
            + '</div>'

            + '<div class="mb-2">'
            + '<label class="form-label small text-muted mb-1">Status</label>'
            + '<select id="acx-connector-status" class="form-select form-select-sm bg-dark text-light border-secondary">'
            + '<option value="Connected"' + (String(connectorStatus).toLowerCase() === 'connected' ? ' selected' : '') + '>Connected</option>'
            + '<option value="Disconnected"' + (String(connectorStatus).toLowerCase() === 'disconnected' ? ' selected' : '') + '>Disconnected</option>'
            + '<option value="Soon"' + (String(connectorStatus).toLowerCase() === 'soon' ? ' selected' : '') + '>Soon</option>'
            + '</select>'
            + '</div>'

            + '<div class="mb-2">'
            + '<label class="form-label small text-muted mb-1">Account / Workspace</label>'
            + '<input id="acx-connector-account" type="text" class="form-control form-control-sm bg-dark text-light border-secondary" value="' + esc(accountText || '') + '" placeholder="Account ID / Workspace">'
            + '</div>'

            + '<div class="mb-2">'
            + '<label class="form-label small text-muted mb-1">Region</label>'
            + '<input id="acx-connector-region" type="text" class="form-control form-control-sm bg-dark text-light border-secondary" value="' + esc(regionText || '') + '" placeholder="eu-west, us-east, global">'
            + '</div>'

            + '<div class="mb-2">'
            + '<label class="form-label small text-muted mb-1">Filters</label>'
            + '<input id="acx-connector-filters" type="text" class="form-control form-control-sm bg-dark text-light border-secondary" value="' + esc(filtersText || '') + '" placeholder="campaign:brand, status:active">'
            + '</div>'

            + '<div class="form-check form-switch mb-1">'
            + '<input id="acx-connector-byok-toggle" class="form-check-input" type="checkbox" role="switch"' + (byokEnabled ? ' checked' : '') + '>'
            + '<label class="form-check-label small text-muted" for="acx-connector-byok-toggle">BYOK API key</label>'
            + '</div>'
            + '<div class="mb-2">'
            + '<input id="acx-connector-api-key" type="password" class="form-control form-control-sm bg-dark text-light border-secondary" placeholder="' + esc(maskedApiKey || 'Enter API key') + '"' + (byokEnabled ? '' : ' disabled') + '>'
            + '</div>'

            + '<div class="acx-selection-grid">'
            + kv('Workspace', wsMeta.label)
            + kv('Last sync', lastSyncText)
            + kv('Node links', String(selection.connections || 0))
            + kv('Status', connectorStatus)
            + '</div>'

            + '<div class="acx-card-summary">' + kpiHtml + '</div>'
            + '<div class="acx-actions">'
            + actionBtn('save-connector', '<i class="bi bi-save me-1"></i>Save', 'btn-outline-success', 'data-slug="' + esc(slug) + '" data-node-id="' + esc(nodeId) + '"')
            + actionBtn('fetch-connector', '<i class="bi bi-arrow-repeat me-1"></i>Fetch', 'btn-outline-primary', 'data-slug="' + esc(slug) + '"')
            + actionBtn('test-connector', '<i class="bi bi-activity me-1"></i>Test', 'btn-outline-info', 'data-slug="' + esc(slug) + '"')
            + actionBtn('reconnect-connector', '<i class="bi bi-link-45deg me-1"></i>Reconnect', 'btn-outline-warning', 'data-slug="' + esc(slug) + '" data-node-id="' + esc(nodeId) + '"')
            + '</div>'
            + '<div class="mt-2 d-flex gap-2">'
            + actionBtn('view-connector', '<i class="bi bi-box-arrow-up-right me-1"></i>View Full', 'btn-outline-secondary', 'data-slug="' + esc(slug) + '"')
            + actionBtn('delete-node', '<i class="bi bi-trash me-1"></i>Delete', 'btn-outline-danger', 'data-node-id="' + esc(nodeId) + '"')
            + actionBtn('help-connector', '<i class="bi bi-question-circle me-1"></i>Help', 'btn-outline-info', '')
            + '</div>'
            + '</article>';

          el.grid.innerHTML = connectorHtml;
          setMeta('Connector selected | updated ' + relativeTime(state.lastUpdated));
          return;
        }

        if (typeRaw === 'trigger') {
          var triggerType = String(selection.trigger_type || 'incoming_message').toLowerCase();
          var triggerDescription = selection.trigger_description || label || 'New incoming message';
          var triggerPriority = String(selection.trigger_priority || 'p2').toLowerCase();
          var triggerEnabled = selection.trigger_enabled !== false && String(selection.trigger_enabled || '1') !== '0';

          var triggerHtml = ''
            + '<article class="acx-card is-focused" data-ws="' + wsKey + '">'
            + '<div class="acx-selection-chip"><i class="bi bi-lightning-charge"></i><span>Trigger</span></div>'
            + '<div class="mb-2">'
            + '<label class="form-label small text-muted mb-1">Trigger Type</label>'
            + '<select id="acx-trigger-type" class="form-select form-select-sm bg-dark text-light border-secondary">'
            + '<option value="incoming_message"' + (triggerType === 'incoming_message' ? ' selected' : '') + '>New Incoming Message</option>'
            + '<option value="schedule"' + (triggerType === 'schedule' ? ' selected' : '') + '>Schedule (cron)</option>'
            + '<option value="webhook"' + (triggerType === 'webhook' ? ' selected' : '') + '>Webhook</option>'
            + '<option value="manual"' + (triggerType === 'manual' ? ' selected' : '') + '>Manual Button</option>'
            + '<option value="connector_event"' + (triggerType === 'connector_event' ? ' selected' : '') + '>Connector Event</option>'
            + '</select>'
            + '</div>'
            + '<div class="mb-2">'
            + '<label class="form-label small text-muted mb-1">Description</label>'
            + '<input id="acx-trigger-description" type="text" class="form-control form-control-sm bg-dark text-light border-secondary" value="' + esc(triggerDescription) + '" placeholder="Triggered when new lead comes in">'
            + '</div>'
            + '<div class="mb-2">'
            + '<label class="form-label small text-muted mb-1">Priority</label>'
            + '<select id="acx-trigger-priority" class="form-select form-select-sm bg-dark text-light border-secondary">'
            + '<option value="p1"' + (triggerPriority === 'p1' ? ' selected' : '') + '>P1 - Critical</option>'
            + '<option value="p2"' + (triggerPriority === 'p2' ? ' selected' : '') + '>P2 - Normal</option>'
            + '<option value="p3"' + (triggerPriority === 'p3' ? ' selected' : '') + '>P3 - Low</option>'
            + '</select>'
            + '</div>'
            + '<div class="form-check form-switch mb-2">'
            + '<input id="acx-trigger-enabled" class="form-check-input" type="checkbox" role="switch"' + (triggerEnabled ? ' checked' : '') + '>'
            + '<label class="form-check-label small text-muted" for="acx-trigger-enabled">Enabled</label>'
            + '</div>'
            + '<div class="acx-selection-grid">'
            + kv('Workspace', wsMeta.label)
            + kv('Node links', String(selection.connections || 0))
            + '</div>'
            + '<div class="acx-actions">'
            + actionBtn('test-trigger', '<i class="bi bi-play-circle me-1"></i>Test', 'btn-outline-primary', 'data-node-id="' + esc(nodeId) + '"')
            + actionBtn('save-trigger', '<i class="bi bi-save me-1"></i>Save', 'btn-outline-success', 'data-node-id="' + esc(nodeId) + '"')
            + actionBtn('delete-node', '<i class="bi bi-trash me-1"></i>Delete', 'btn-outline-danger', 'data-node-id="' + esc(nodeId) + '"')
            + '</div>'
            + '<div class="mt-2">'
            + actionBtn('help-trigger', '<i class="bi bi-question-circle me-1"></i>Help', 'btn-outline-info', '')
            + '</div>'
            + '</article>';
          el.grid.innerHTML = triggerHtml;
          setMeta('Trigger selected | updated ' + relativeTime(state.lastUpdated));
          return;
        }

                if (typeRaw === 'condition') {
          var conditionMetric = String(selection.condition_metric || 'ROAS').trim() || 'ROAS';
          var conditionOperator = String(selection.condition_operator || '>').trim() || '>';
          var conditionValue = (selection.condition_value !== undefined && selection.condition_value !== null)
            ? String(selection.condition_value)
            : '3.0';
          if (!conditionValue.trim()) conditionValue = '3.0';
          var conditionThen = String(selection.condition_then_label || 'Yes').trim() || 'Yes';
          var conditionElse = String(selection.condition_else_label || 'No').trim() || 'No';

          var conditionHtml = ''
            + '<article class="acx-card is-focused" data-ws="' + wsKey + '">'
            + '<div class="acx-selection-chip"><i class="bi bi-signpost-split"></i><span>Condition Editor</span></div>'

            + '<div class="mb-2">'
            + '<label class="form-label small text-muted mb-1">Metric / Variable</label>'
            + '<select id="acx-condition-metric" class="form-select form-select-sm bg-dark text-light border-secondary">'
            + '<option value="ROAS"' + (conditionMetric === 'ROAS' ? ' selected' : '') + '>ROAS</option>'
            + '<option value="Spend"' + (conditionMetric === 'Spend' ? ' selected' : '') + '>Spend</option>'
            + '<option value="Conversions"' + (conditionMetric === 'Conversions' ? ' selected' : '') + '>Conversions</option>'
            + '<option value="CTR"' + (conditionMetric === 'CTR' ? ' selected' : '') + '>CTR</option>'
            + '<option value="Custom Variable"' + (conditionMetric === 'Custom Variable' ? ' selected' : '') + '>Custom Variable</option>'
            + '</select>'
            + '</div>'

            + '<div class="mb-2">'
            + '<label class="form-label small text-muted mb-1">Operator</label>'
            + '<select id="acx-condition-operator" class="form-select form-select-sm bg-dark text-light border-secondary">'
            + '<option value=">"' + (conditionOperator === '>' ? ' selected' : '') + '>&gt;</option>'
            + '<option value="<"' + (conditionOperator === '<' ? ' selected' : '') + '>&lt;</option>'
            + '<option value=">="' + (conditionOperator === '>=' ? ' selected' : '') + '>&ge;</option>'
            + '<option value="<="' + (conditionOperator === '<=' ? ' selected' : '') + '>&le;</option>'
            + '<option value="=="' + (conditionOperator === '==' ? ' selected' : '') + '>==</option>'
            + '<option value="!="' + (conditionOperator === '!=' ? ' selected' : '') + '>!=</option>'
            + '<option value="contains"' + (conditionOperator === 'contains' ? ' selected' : '') + '>contains</option>'
            + '</select>'
            + '</div>'

            + '<div class="mb-2">'
            + '<label class="form-label small text-muted mb-1">Value / Threshold</label>'
            + '<input id="acx-condition-value" type="text" class="form-control form-control-sm bg-dark text-light border-secondary" value="' + esc(conditionValue) + '" placeholder="3.0">'
            + '</div>'

            + '<div class="row g-2 mb-2">'
            + '<div class="col-6">'
            + '<label class="form-label small text-muted mb-1">Then label</label>'
            + '<input id="acx-condition-then" type="text" class="form-control form-control-sm bg-dark text-light border-secondary" value="' + esc(conditionThen) + '" placeholder="Yes">'
            + '</div>'
            + '<div class="col-6">'
            + '<label class="form-label small text-muted mb-1">Else label</label>'
            + '<input id="acx-condition-else" type="text" class="form-control form-control-sm bg-dark text-light border-secondary" value="' + esc(conditionElse) + '" placeholder="No">'
            + '</div>'
            + '</div>'

            + '<div class="acx-selection-grid">'
            + kv('Rule', conditionMetric + ' ' + conditionOperator + ' ' + conditionValue)
            + kv('Workspace', wsMeta.label)
            + kv('Status', selection.status || 'active')
            + kv('Node links', String(selection.connections || 0))
            + '</div>'

            + '<div class="acx-actions">'
            + actionBtn('test-condition', '<i class="bi bi-check2-circle me-1"></i>Test', 'btn-outline-primary', 'data-node-id="' + esc(nodeId) + '"')
            + actionBtn('save-condition', '<i class="bi bi-save me-1"></i>Save', 'btn-outline-success', 'data-node-id="' + esc(nodeId) + '"')
            + actionBtn('delete-node', '<i class="bi bi-trash me-1"></i>Delete', 'btn-outline-danger', 'data-node-id="' + esc(nodeId) + '"')
            + '</div>'
            + '<div class="mt-2">'
            + actionBtn('help-condition', '<i class="bi bi-question-circle me-1"></i>Help', 'btn-outline-info', '')
            + '</div>'
            + '</article>';
          el.grid.innerHTML = conditionHtml;
          setMeta('Condition selected | updated ' + relativeTime(state.lastUpdated));
          return;
        }
                if (typeRaw === 'output') {
          var outputFormat = String(selection.output_format || 'text').trim().toLowerCase();
          if (!outputFormat) outputFormat = 'text';

          var outputTemplate = (selection.output_template !== undefined && selection.output_template !== null)
            ? String(selection.output_template)
            : 'Here is your result: {{last_agent_response}}';
          if (!outputTemplate.trim()) outputTemplate = 'Here is your result: {{last_agent_response}}';

          var outputDestination = String(selection.output_destination || 'chat').trim().toLowerCase();
          if (!outputDestination) outputDestination = 'chat';

          var outputPreview = buildOutputPreview(outputTemplate, outputFormat);

          var outputHtml = ''
            + '<article class="acx-card is-focused" data-ws="' + wsKey + '">'
            + '<div class="acx-selection-chip"><i class="bi bi-box-arrow-right"></i><span>Output</span></div>'

            + '<div class="acx-form-group">'
            + '<div class="acx-field-label">Output format</div>'
            + '<select id="acx-output-format" class="form-select form-select-sm bg-dark text-light border-secondary">'
            + '<option value="text"' + (outputFormat === 'text' ? ' selected' : '') + '>Text</option>'
            + '<option value="json"' + (outputFormat === 'json' ? ' selected' : '') + '>JSON</option>'
            + '<option value="markdown"' + (outputFormat === 'markdown' ? ' selected' : '') + '>Markdown</option>'
            + '<option value="html"' + (outputFormat === 'html' ? ' selected' : '') + '>HTML</option>'
            + '</select>'
            + '</div>'

            + '<div class="acx-form-group">'
            + '<div class="acx-field-label">Message template</div>'
            + '<textarea id="acx-output-template" rows="4" class="form-control form-control-sm bg-dark text-light border-secondary" placeholder="Here is your result: {{last_agent_response}}">' + esc(outputTemplate) + '</textarea>'
            + '<div class="acx-hint">Use placeholders like {{last_agent_response}}, {{roas}}, {{spend}}, {{campaign_name}}.</div>'
            + '</div>'

            + '<div class="acx-form-group">'
            + '<div class="acx-field-label">Destination</div>'
            + '<select id="acx-output-destination" class="form-select form-select-sm bg-dark text-light border-secondary">'
            + '<option value="chat"' + (outputDestination === 'chat' ? ' selected' : '') + '>Chat Response</option>'
            + '<option value="email"' + (outputDestination === 'email' ? ' selected' : '') + '>Email</option>'
            + '<option value="webhook"' + (outputDestination === 'webhook' ? ' selected' : '') + '>Webhook</option>'
            + '<option value="slack"' + (outputDestination === 'slack' ? ' selected' : '') + '>Slack</option>'
            + '</select>'
            + '</div>'

            + '<div class="acx-form-group">'
            + '<div class="acx-field-label">Preview (mock)</div>'
            + '<pre id="acx-output-preview" class="form-control form-control-sm bg-dark text-light border-secondary" style="min-height:88px; white-space:pre-wrap;">' + esc(outputPreview) + '</pre>'
            + '</div>'

            + '<div class="acx-selection-grid">'
            + kv('Label', label)
            + kv('Format', outputFormat.toUpperCase())
            + kv('Destination', outputDestination)
            + kv('Workspace', wsMeta.label)
            + kv('Node links', String(selection.connections || 0))
            + '</div>'
            + '<div class="acx-card-summary">Define the final payload and where it should be sent at the end of the flow.</div>'
            + '<div class="acx-actions">'
            + actionBtn('test-output', '<i class="bi bi-play-circle me-1"></i>Test', 'btn-outline-primary', 'data-node-id="' + esc(nodeId) + '"')
            + actionBtn('save-output', '<i class="bi bi-save me-1"></i>Save', 'btn-outline-success', 'data-node-id="' + esc(nodeId) + '"')
            + actionBtn('delete-node', '<i class="bi bi-trash me-1"></i>Delete', 'btn-outline-danger', 'data-node-id="' + esc(nodeId) + '"')
            + '</div>'
            + '<div class="mt-2">'
            + actionBtn('help-output', '<i class="bi bi-question-circle me-1"></i>Help', 'btn-outline-info', '')
            + '</div>'
            + '</article>';
          el.grid.innerHTML = outputHtml;
          setMeta('Output selected | updated ' + relativeTime(state.lastUpdated));
          return;
        }

        var fallbackHtml = ''
          + '<article class="acx-card is-focused" data-ws="' + wsKey + '">'
          + '<div class="acx-selection-chip"><i class="bi ' + wsMeta.icon + '"></i><span>' + esc(wsMeta.label) + '</span><strong class="ms-1">' + clamp(wsState.score || state.globalScore, 0, 100) + '%</strong></div>'
          + '<div class="acx-selection-grid">'
          + kv('Type', typeRaw)
          + kv('Label', label)
          + kv('Status', selection.status || 'n/a')
          + kv('Workspace', wsMeta.label)
          + '</div>'
          + '<div class="acx-card-summary">Selection details are active here.</div>'
          + '</article>';

        el.grid.innerHTML = fallbackHtml;
        setMeta('Selection active | updated ' + relativeTime(state.lastUpdated));
      }

      function showTooltip(text, asHtml) {
        if (!el.tooltip) return;
        if (!text) {
          el.tooltip.classList.remove('show');
          el.tooltip.innerHTML = '';
          return;
        }
        if (asHtml) {
          el.tooltip.innerHTML = text;
        } else {
          el.tooltip.textContent = text;
        }
        el.tooltip.classList.add('show');
      }

      function showContextTooltip() {
        var rows = WS_ORDER.map(function(wsKey) {
          var ws = state.workspaces[wsKey] || {};
          var meta = WS_META[wsKey] || {};
          var score = clamp(ws.score, 0, 100);
          return ''
            + '<div class="acx-tip-row">'
            + '<span class="acx-tip-name">' + esc(meta.label || wsKey) + '</span>'
            + '<span class="acx-tip-value">' + score + '%</span>'
            + '</div>';
        }).join('');

        var foot = '<div class="acx-tip-foot">CMI ' + clamp(state.globalScore, 0, 100)
          + '% • updated ' + esc(relativeTime(state.lastUpdated)) + '</div>';

        showTooltip(rows + foot, true);
      }

      function renderCurrentMode() {
        if (state.mode === 'selection' && state.selection) {
          renderSelection(state.selection);
          return;
        }
        renderOverview();
      }

      function setPanelOpen(open) {
        state.isOpen = !!open;
        el.panel.classList.toggle('show', state.isOpen);
        el.overlay.classList.toggle('show', state.isOpen);
        el.panel.setAttribute('aria-hidden', state.isOpen ? 'false' : 'true');
        el.compact.classList.toggle('is-dimmed', state.isOpen);
        if (!state.isOpen) {
          showTooltip('');
        } else {
          renderCurrentMode();
        }
      }

      function setFocus(wsKey, shouldOpen) {
        if (!WS_META[wsKey]) return;
        state.focused = wsKey;
        state.mode = 'overview';
        state.selection = null;

        var quadrants = el.compact.querySelectorAll('.acx-quadrant');
        quadrants.forEach(function(q) {
          q.classList.toggle('active', q.getAttribute('data-ws') === wsKey);
        });

        if (state.isOpen || shouldOpen) {
          renderOverview();
        }

        if (shouldOpen) {
          setPanelOpen(true);
        }
      }

      function buildFlowPayload(wsKey) {
        var meta = WS_META[wsKey];
        var ws = state.workspaces[wsKey] || {};
        var shortAlert = String(ws.alert || (meta.label + ' signal')).split('. ')[0];

        return {
          source: 'active-context-radar',
          created_at: new Date().toISOString(),
          workspace_slug: wsKey,
          node: {
            type: 'condition',
            slug: '',
            status: '',
            workspace_slug: wsKey,
            name: meta.label + ': ' + shortAlert
          },
          context: {
            score: clamp(ws.score, 0, 100),
            summary: ws.summary || '',
            alert: ws.alert || ''
          }
        };
      }

      function addToFlow(wsKey) {
        if (!WS_META[wsKey]) return;

        var payload = buildFlowPayload(wsKey);
        try {
          localStorage.setItem(ACX_QUEUE_KEY, JSON.stringify(payload));
        } catch (err) {
          // Ignore storage failures and still try direct add on orchestrator.
        }

        var onOrchestrator = window.location.pathname.indexOf('/orchestrator') === 0;
        if (onOrchestrator && typeof window.addNode === 'function') {
          try {
            window.addNode(
              payload.node.type,
              payload.node.slug || '',
              payload.node.name || '',
              payload.node.status || '',
              payload.node.workspace_slug || wsKey
            );
            try {
              localStorage.removeItem(ACX_QUEUE_KEY);
            } catch (errRemove) {
              // No-op.
            }
            toast('Added ' + WS_META[wsKey].label + ' context node to flow.', 'success');
            return;
          } catch (errDirect) {
            // Fallback to queued mode below.
          }
        }

        toast('Context queued. Open Orchestrator to insert the node.', 'info');
      }

      function sendToAgent(wsKey) {
        if (!WS_META[wsKey]) return;

        var ws = state.workspaces[wsKey] || {};
        var target = pickAgentForWorkspace(wsKey);
        if (!target || !target.slug) {
          toast('No agent found for ' + WS_META[wsKey].label + '.', 'warning');
          return;
        }

        var contextText = (ws.alert || ('Review ' + WS_META[wsKey].label + ' context'))
          + ' | Score ' + clamp(ws.score, 0, 100) + '%';

        var wsSlug = normalizeWorkspace(target.workspace_slug || wsKey) || wsKey;
        var url = '/chat/' + encodeURIComponent(wsSlug)
          + '/' + encodeURIComponent(target.slug)
          + '?from=active-context&context=' + encodeURIComponent(contextText);

        window.location.href = url;
      }

            function normalizeConnectionDataType(value) {
        var t = String(value || '').trim().toLowerCase();
        if (t === 'json' || t === 'metrics' || t === 'file' || t === 'event') return t;
        return 'text';
      }

      function normalizeConnectionStatus(value) {
        var status = String(value || '').trim().toLowerCase();
        if (status === 'error' || status === 'pending') return status;
        return 'active';
      }

      function connectionStatusBadge(status) {
        var normalized = normalizeConnectionStatus(status);
        var label = normalized === 'error' ? 'error' : (normalized === 'pending' ? 'pending' : 'active');
        var badgeClass = 'bg-success-subtle text-success-emphasis';
        if (normalized === 'pending') badgeClass = 'bg-warning-subtle text-warning-emphasis';
        if (normalized === 'error') badgeClass = 'bg-danger-subtle text-danger-emphasis';
        return '<span class="badge ' + badgeClass + '">' + esc(label) + '</span>';
      }

      function buildConnectionFallbackPayload(dataType, fromLabel, toLabel) {
        var nowIso = new Date().toISOString();
        var normalized = normalizeConnectionDataType(dataType);
        var fromText = String(fromLabel || 'source');
        var toText = String(toLabel || 'target');

        if (normalized === 'json' || normalized === 'metrics') {
          return JSON.stringify({
            from: fromText,
            to: toText,
            message: 'Mock payload delivered',
            timestamp: nowIso
          }, null, 2);
        }

        if (normalized === 'event') {
          return 'event=flow.step.completed; from=' + fromText + '; to=' + toText + '; at=' + nowIso;
        }

        if (normalized === 'file') {
          return 'file://mock/connection-payload.csv';
        }

        return 'Flow payload from ' + fromText + ' to ' + toText + ' @ ' + nowIso;
      }

      function readConnectionInspectorPayload() {
        var dataTypeEl = document.getElementById('acx-connection-data-type');
        var statusEl = document.getElementById('acx-connection-status');
        var previewEl = document.getElementById('acx-connection-preview');

        var currentFrom = state.selection && state.selection.from ? String(state.selection.from) : 'source';
        var currentTo = state.selection && state.selection.to ? String(state.selection.to) : 'target';

        var dataType = normalizeConnectionDataType(dataTypeEl ? dataTypeEl.value : (state.selection && state.selection.connection_data_type));
        var status = normalizeConnectionStatus(statusEl ? statusEl.value : (state.selection && state.selection.connection_status));
        var payload = previewEl ? String(previewEl.value || '') : '';
        if (!payload.trim()) {
          payload = buildConnectionFallbackPayload(dataType, currentFrom, currentTo);
        }

        var lastTransmission = '';
        if (state.selection) {
          lastTransmission = String(state.selection.last_transmission || state.selection.lastTransmission || '').trim();
        }
        if (!lastTransmission) {
          lastTransmission = new Date().toISOString();
        }

        return {
          connection_data_type: dataType,
          connection_status: status,
          status: status,
          last_payload: payload,
          last_transmission: lastTransmission
        };
      }

      function syncConnectionDraftToCanvas() {
        if (!state.selection || !state.selection.id) return;
        var kind = String(state.selection.kind || state.selection.nodeType || '').toLowerCase();
        if (kind !== 'connection') return;

        var draft = readConnectionInspectorPayload();

        if (typeof window.updateOrchestratorConnectionConfig === 'function') {
          var saved = window.updateOrchestratorConnectionConfig(state.selection.id, draft);
          if (saved && typeof saved === 'object') {
            if (saved.data_type !== undefined) draft.connection_data_type = saved.data_type;
            if (saved.status !== undefined) draft.connection_status = normalizeConnectionStatus(saved.status);
            if (saved.last_payload !== undefined) draft.last_payload = String(saved.last_payload);
            if (saved.last_transmission !== undefined) draft.last_transmission = String(saved.last_transmission);
          }
        }

        state.selection.connection_data_type = draft.connection_data_type;
        state.selection.connection_status = draft.connection_status;
        state.selection.status = draft.connection_status;
        state.selection.last_payload = draft.last_payload;
        state.selection.last_transmission = draft.last_transmission;

        var previewEl = document.getElementById('acx-connection-preview');
        if (previewEl && previewEl.value !== draft.last_payload) {
          previewEl.value = draft.last_payload;
        }

        var lastEl = document.getElementById('acx-connection-last');
        if (lastEl) {
          lastEl.textContent = 'Last transmission: ' + relativeTime(draft.last_transmission);
        }
      }

      function readConditionInspectorPayload() {
        var metricEl = document.getElementById('acx-condition-metric');
        var operatorEl = document.getElementById('acx-condition-operator');
        var valueEl = document.getElementById('acx-condition-value');
        var thenEl = document.getElementById('acx-condition-then');
        var elseEl = document.getElementById('acx-condition-else');

        var metric = metricEl ? String(metricEl.value || '').trim() : '';
        var operator = operatorEl ? String(operatorEl.value || '').trim() : '';
        var value = valueEl ? String(valueEl.value || '').trim() : '';
        var thenLabel = thenEl ? String(thenEl.value || '').trim() : '';
        var elseLabel = elseEl ? String(elseEl.value || '').trim() : '';

        if (!metric) metric = 'ROAS';
        if (!operator) operator = '>';
        if (!value) value = '3.0';
        if (!thenLabel) thenLabel = 'Yes';
        if (!elseLabel) elseLabel = 'No';

        return {
          condition_metric: metric,
          condition_operator: operator,
          condition_value: value,
          condition_then_label: thenLabel,
          condition_else_label: elseLabel,
          label: metric + ' ' + operator + ' ' + value
        };
      }

      function syncConditionDraftToCanvas() {
        if (!state.selection || !state.selection.id) return;
        if (String(state.selection.nodeType || '').toLowerCase() !== 'condition') return;
        if (typeof window.updateOrchestratorConditionConfig !== 'function') return;

        var draft = readConditionInspectorPayload();
        var ok = window.updateOrchestratorConditionConfig(state.selection.id, draft);
        if (!ok) return;

        state.selection.condition_metric = draft.condition_metric;
        state.selection.condition_operator = draft.condition_operator;
        state.selection.condition_value = draft.condition_value;
        state.selection.condition_then_label = draft.condition_then_label;
        state.selection.condition_else_label = draft.condition_else_label;
        state.selection.label = draft.label;
      }

      function normalizeOutputFormat(value) {
        var normalized = String(value || '').trim().toLowerCase();
        if (normalized === 'json' || normalized === 'markdown' || normalized === 'html') return normalized;
        return 'text';
      }

      function normalizeOutputDestination(value) {
        var normalized = String(value || '').trim().toLowerCase();
        if (normalized === 'email' || normalized === 'webhook' || normalized === 'slack') return normalized;
        return 'chat';
      }

      function buildOutputPreview(template, format) {
        var safeTemplate = String(template || '').trim();
        if (!safeTemplate) safeTemplate = 'Here is your result: {{last_agent_response}}';

        var rendered = safeTemplate
          .replace(/\{\{\s*last_agent_response\s*\}\}/gi, 'Mock PPC report: ROAS 4.2x')
          .replace(/\{\{\s*roas\s*\}\}/gi, '4.2x')
          .replace(/\{\{\s*spend\s*\}\}/gi, '$412')
          .replace(/\{\{\s*campaign_name\s*\}\}/gi, 'Summer Sale RO');

        var mode = normalizeOutputFormat(format);
        if (mode === 'json') {
          try {
            return JSON.stringify({
              destination: 'chat',
              message: rendered,
              status: 'ok'
            }, null, 2);
          } catch (errJson) {
            return rendered;
          }
        }

        if (mode === 'markdown') {
          return '### Flow Output\n\n' + rendered;
        }

        if (mode === 'html') {
          return '<p>' + rendered.replace(/\n/g, '<br>') + '</p>';
        }

        return rendered;
      }

      function formatOutputInspectorLabel(destination, format) {
        var destinationLabelMap = {
          chat: 'Chat response',
          email: 'Email',
          webhook: 'Webhook',
          slack: 'Slack'
        };
        var destinationKey = normalizeOutputDestination(destination);
        var formatKey = normalizeOutputFormat(format);
        var destinationLabel = destinationLabelMap[destinationKey] || ('Output to ' + destinationKey);
        return destinationLabel + ' (' + formatKey + ')';
      }

      function readOutputInspectorPayload() {
        var formatEl = document.getElementById('acx-output-format');
        var templateEl = document.getElementById('acx-output-template');
        var destinationEl = document.getElementById('acx-output-destination');

        var outputFormat = normalizeOutputFormat(formatEl ? formatEl.value : 'text');
        var outputTemplate = templateEl ? String(templateEl.value || '') : '';
        if (!outputTemplate.trim()) {
          outputTemplate = 'Here is your result: {{last_agent_response}}';
        }
        var outputDestination = normalizeOutputDestination(destinationEl ? destinationEl.value : 'chat');

        return {
          output_format: outputFormat,
          output_template: outputTemplate,
          output_destination: outputDestination,
          label: formatOutputInspectorLabel(outputDestination, outputFormat)
        };
      }

      function syncOutputDraftToCanvas() {
        if (!state.selection || !state.selection.id) return;
        if (String(state.selection.nodeType || '').toLowerCase() !== 'output') return;

        var draft = readOutputInspectorPayload();
        var previewEl = document.getElementById('acx-output-preview');
        if (previewEl) {
          previewEl.textContent = buildOutputPreview(draft.output_template, draft.output_format);
        }

        if (typeof window.updateOrchestratorOutputConfig === 'function') {
          var ok = window.updateOrchestratorOutputConfig(state.selection.id, draft);
          if (!ok) return;
        }

        state.selection.output_format = draft.output_format;
        state.selection.output_template = draft.output_template;
        state.selection.output_destination = draft.output_destination;
        state.selection.label = draft.label;
      }

      async function handleNodeAction(actionBtn) {
        if (!actionBtn) return;

        var action = String(actionBtn.getAttribute('data-acx-node-action') || '').trim();
        var slug = String(actionBtn.getAttribute('data-slug') || (state.selection && state.selection.slug) || '').trim();
        var nodeId = String(actionBtn.getAttribute('data-node-id') || (state.selection && state.selection.id) || '').trim();
        var connectionId = String(actionBtn.getAttribute('data-connection-id') || (state.selection && state.selection.id) || '').trim();
        var wsHint = String(actionBtn.getAttribute('data-workspace') || (state.selection && (state.selection.workspace_slug || state.selection.workspace)) || state.focused || 'agency');
        var wsSlug = normalizeWorkspace(wsHint) || 'agency';
        var clientIdRaw = actionBtn.getAttribute('data-client-id') || (state.selection && (state.selection.client_id || state.selection.id)) || '';
        var clientId = parseInt(String(clientIdRaw).trim(), 10);
        if (!isFinite(clientId) || clientId <= 0) clientId = null;
        var linkIdRaw = actionBtn.getAttribute('data-link-id') || '';
        var linkId = parseInt(String(linkIdRaw).trim(), 10);
        if (!isFinite(linkId) || linkId <= 0) linkId = null;

        if (action === 'open-new-client-chat') {
          var currentClient = null;
          if (window.CamaradClient && typeof window.CamaradClient.getActiveClient === 'function') {
            currentClient = window.CamaradClient.getActiveClient();
          }
          var clientLabel = currentClient
            ? (currentClient.display_name || currentClient.company_name || currentClient.name || ('Client ' + String(currentClient.id || '')))
            : (state.selection && state.selection.label ? state.selection.label : 'Client');

          if (typeof window.openSidebarNewChatModal === 'function') {
            window.openSidebarNewChatModal();
            var wsSelect = document.getElementById('sidebarNewChatWorkspace');
            if (wsSelect) wsSelect.value = 'business';
            var titleInput = document.getElementById('sidebarNewChatTitle');
            if (titleInput && !String(titleInput.value || '').trim()) {
              titleInput.value = String(clientLabel).trim() + ' chat';
            }
          } else {
            window.location.href = '/workspace/business';
          }
          toast('New chat ready for ' + String(clientLabel).trim() + '.', 'info');
          return;
        }

        if (action === 'open-client-add-account') {
          if (clientId && typeof window.switchClient === 'function') {
            var selectedLabel = state.selection && state.selection.label ? state.selection.label : ('Client ' + String(clientId));
            window.switchClient(clientId, selectedLabel);
          }
          if (typeof window.openAddClientAccountModal === 'function') {
            window.openAddClientAccountModal();
          } else {
            toast('Add Account modal is unavailable on this page.', 'warning');
          }
          return;
        }

        if (action === 'refresh-client-accounts') {
          if (typeof window.loadClientAccounts === 'function') {
            try {
              await window.loadClientAccounts();
              if (state.selection) {
                await renderSelection(state.selection);
              }
              toast('Client accounts refreshed.', 'success');
            } catch (errRefreshClient) {
              toast('Refresh failed: ' + (errRefreshClient && errRefreshClient.message ? errRefreshClient.message : 'unknown'), 'warning');
            }
          } else {
            toast('Client account loader is unavailable.', 'warning');
          }
          return;
        }

        if (action === 'unlink-client-account') {
          if (!linkId) {
            toast('Missing linked account id.', 'warning');
            return;
          }
          try {
            var unlinkResp = await fetch('/api/client_connectors/' + encodeURIComponent(linkId), {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ status: 'disconnected' })
            });
            if (!unlinkResp.ok) {
              toast('Disconnect failed (HTTP ' + unlinkResp.status + ').', 'warning');
              return;
            }

            if (typeof window.loadClientAccounts === 'function') {
              await window.loadClientAccounts();
            }
            if (state.selection) {
              await renderSelection(state.selection);
            }
            toast('Account disconnected.', 'success');
          } catch (errUnlink) {
            toast('Disconnect error: ' + (errUnlink && errUnlink.message ? errUnlink.message : 'unknown'), 'warning');
          }
          return;
        }

        if (action === 'help-client') {
          toast('Client context scopes agents, connectors, chats and flows. Link accounts to activate contextual data.', 'info');
          return;
        }

        if (action === 'save-client') {
          if (!clientId) {
            toast('Missing client id for save.', 'warning');
            return;
          }

          var typeEl = document.getElementById('acx-client-type');
          var nameElClient = document.getElementById('acx-client-name');
          var companyElClient = document.getElementById('acx-client-company');
          var emailElClient = document.getElementById('acx-client-email');
          var websiteElClient = document.getElementById('acx-client-website');
          var phoneElClient = document.getElementById('acx-client-phone');
          var addressElClient = document.getElementById('acx-client-address');
          var notesElClient = document.getElementById('acx-client-notes');

          var payloadClient = {
            type: typeEl ? String(typeEl.value || 'person').trim().toLowerCase() : 'person',
            name: nameElClient ? String(nameElClient.value || '').trim() : '',
            company_name: companyElClient ? String(companyElClient.value || '').trim() : '',
            email: emailElClient ? String(emailElClient.value || '').trim() : '',
            website: websiteElClient ? String(websiteElClient.value || '').trim() : '',
            phone: phoneElClient ? String(phoneElClient.value || '').trim() : '',
            address: addressElClient ? String(addressElClient.value || '').trim() : '',
            notes: notesElClient ? String(notesElClient.value || '').trim() : ''
          };

          try {
            var saveResp = await fetch('/api/clients/' + encodeURIComponent(clientId), {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payloadClient)
            });
            var saveJson = await saveResp.json().catch(function() { return {}; });
            if (!saveResp.ok || !saveJson.success) {
              toast('Client save failed: ' + (saveJson.error || ('HTTP ' + saveResp.status)), 'warning');
              return;
            }

            if (typeof window.loadClients === 'function') {
              await window.loadClients();
            }

            if (state.selection) {
              state.selection.client_id = clientId;
              state.selection.id = String(clientId);
              if (saveJson.client) {
                state.selection.label = saveJson.client.display_name || state.selection.label;
                state.selection.name = saveJson.client.name || '';
                state.selection.company_name = saveJson.client.company_name || '';
                state.selection.client_type = saveJson.client.type || state.selection.client_type;
                state.selection.email = saveJson.client.email || '';
                state.selection.website = saveJson.client.website || '';
                state.selection.phone = saveJson.client.phone || '';
                state.selection.address = saveJson.client.address || '';
                state.selection.notes = saveJson.client.notes || '';
              }
              await renderSelection(state.selection);
            }

            toast('Client saved.', 'success');
          } catch (errSaveClient) {
            toast('Client save error: ' + (errSaveClient && errSaveClient.message ? errSaveClient.message : 'unknown'), 'warning');
          }
          return;
        }

        if (action === 'delete-client') {
          if (!clientId) {
            toast('Missing client id for delete.', 'warning');
            return;
          }
          if (!window.confirm('Delete this client? Linked accounts will be removed and scoped data detached.')) {
            return;
          }

          try {
            var delResp = await fetch('/api/clients/' + encodeURIComponent(clientId), { method: 'DELETE' });
            var delJson = await delResp.json().catch(function() { return {}; });
            if (!delResp.ok || !delJson.success) {
              toast('Client delete failed: ' + (delJson.error || ('HTTP ' + delResp.status)), 'warning');
              return;
            }

            var activeId = null;
            if (window.CamaradClient && typeof window.CamaradClient.getActiveClientId === 'function') {
              activeId = window.CamaradClient.getActiveClientId();
            }

            if (activeId && Number(activeId) === Number(clientId) && typeof window.switchClient === 'function') {
              window.switchClient(null, 'None');
            } else if (typeof window.loadClients === 'function') {
              await window.loadClients();
            }

            state.mode = 'overview';
            state.selection = null;
            renderOverview();
            setPanelOpen(true);
            toast('Client deleted.', 'success');
          } catch (errDeleteClient) {
            toast('Client delete error: ' + (errDeleteClient && errDeleteClient.message ? errDeleteClient.message : 'unknown'), 'warning');
          }
          return;
        }

        if (action === 'chat-agent') {
          if (!slug) {
            toast('Missing agent slug for chat.', 'warning');
            return;
          }
          window.location.href = '/chat/' + encodeURIComponent(wsSlug) + '/' + encodeURIComponent(slug);
          return;
        }

        if (action === 'pick-agent-avatar') {
          var avatarInput = document.getElementById('acx-agent-avatar-upload');
          if (!avatarInput) {
            toast('Avatar upload is unavailable for this selection.', 'warning');
            return;
          }
          if (slug) avatarInput.setAttribute('data-slug', slug);
          avatarInput.click();
          return;
        }

        if (action === 'save-agent') {
          if (!slug) {
            toast('Missing agent slug for save.', 'warning');
            return;
          }

          var nameEl = document.getElementById('acx-agent-name');
          var statusEl = document.getElementById('acx-agent-status');
          var providerEl = document.getElementById('acx-agent-provider');
          var modelEl = document.getElementById('acx-agent-model');
          var tempEl = document.getElementById('acx-agent-temperature');
          var maxTokensEl = document.getElementById('acx-agent-max-tokens');
          var ragEl = document.getElementById('acx-agent-rag-enabled');
          var byokEl = document.getElementById('acx-agent-byok-toggle');
          var apiKeyEl = document.getElementById('acx-agent-api-key');
          var avatarEl = document.getElementById('acx-agent-avatar');

          var customName = nameEl ? String(nameEl.value || '').trim() : '';
          if (!customName) customName = state.selection && state.selection.label ? String(state.selection.label) : humanizeSlug(slug);

          var temperature = tempEl ? Number(tempEl.value) : 0.7;
          if (!isFinite(temperature)) temperature = 0.7;
          temperature = Math.min(2, Math.max(0, temperature));

          var maxTokens = maxTokensEl ? parseInt(maxTokensEl.value, 10) : 2048;
          if (!isFinite(maxTokens)) maxTokens = 2048;
          maxTokens = Math.min(32768, Math.max(64, maxTokens));

          var patch = {
            custom_name: customName,
            status: statusEl ? String(statusEl.value || 'Active') : 'Active',
            llm_provider: providerEl ? String(providerEl.value || 'Grok') : 'Grok',
            llm_model: modelEl ? (String(modelEl.value || 'grok-beta').trim() || 'grok-beta') : 'grok-beta',
            temperature: temperature,
            max_tokens: maxTokens,
            rag_enabled: !!(ragEl && ragEl.checked)
          };

          var byokEnabled = !!(byokEl && byokEl.checked);
          var apiValue = apiKeyEl ? String(apiKeyEl.value || '').trim() : '';
          if (!byokEnabled) {
            patch.api_key = '';
          } else if (apiValue) {
            patch.api_key = apiValue;
          }

          var pendingAvatar = avatarEl ? String(avatarEl.getAttribute('data-pending-base64') || '').trim() : '';
          if (pendingAvatar) {
            patch.avatar_base64 = pendingAvatar;
          }

          try {
            var savedCfg = await saveAgentConfigPatch(slug, patch);
            state.agentConversationCache = {};
            await fetchAgentsCatalog();

            if (typeof window.updateOrchestratorNodePresentation === 'function' && nodeId) {
              window.updateOrchestratorNodePresentation(nodeId, {
                label: savedCfg.custom_name || customName,
                status: savedCfg.status || patch.status || 'Active'
              });
            }

            if (state.selection) {
              state.selection.label = savedCfg.custom_name || customName;
              state.selection.status = savedCfg.status || patch.status || state.selection.status;
              state.selection.slug = slug;
            }

            await renderSelection(state.selection || { kind: 'canvas' });
            toast('Agent saved.', 'success');
          } catch (errSaveAgent) {
            toast('Agent save failed: ' + (errSaveAgent && errSaveAgent.message ? errSaveAgent.message : 'unknown'), 'warning');
          }
          return;
        }

        if (action === 'manage-agent-knowledge') {
          if (!slug) {
            toast('Missing agent slug for knowledge view.', 'warning');
            return;
          }
          window.location.href = '/agent/' + encodeURIComponent(slug) + '#knowledge';
          return;
        }

        if (action === 'help-agent') {
          toast('Configure name, LLM, RAG and BYOK here. Use Chat to test behavior immediately.', 'info');
          return;
        }

        if (action === 'edit-agent') {
          if (!slug) {
            toast('Missing agent slug for edit.', 'warning');
            return;
          }
          window.location.href = '/agent/' + encodeURIComponent(slug);
          return;
        }

        if (action === 'delete-node') {
          if (typeof window.deleteOrchestratorNodeById === 'function' && nodeId) {
            var ok = window.deleteOrchestratorNodeById(nodeId);
            if (ok) {
              toast('Node deleted from flow.', 'success');
              state.mode = 'overview';
              state.selection = null;
              setFocus(state.focused || 'business', true);
            } else {
              toast('Node could not be deleted.', 'warning');
            }
          } else {
            toast('Delete node is available in Orchestrator canvas.', 'warning');
          }
          return;
        }

                if (action === 'test-connection') {
          if (!connectionId) {
            toast('Missing connection id for test.', 'warning');
            return;
          }

          var testConnPayload = readConnectionInspectorPayload();
          testConnPayload.last_transmission = new Date().toISOString();

          if (typeof window.updateOrchestratorConnectionConfig === 'function') {
            var testConnSaved = window.updateOrchestratorConnectionConfig(connectionId, testConnPayload);
            if (testConnSaved && typeof testConnSaved === 'object') {
              if (testConnSaved.data_type !== undefined) testConnPayload.connection_data_type = testConnSaved.data_type;
              if (testConnSaved.status !== undefined) testConnPayload.connection_status = normalizeConnectionStatus(testConnSaved.status);
              if (testConnSaved.last_payload !== undefined) testConnPayload.last_payload = String(testConnSaved.last_payload);
              if (testConnSaved.last_transmission !== undefined) testConnPayload.last_transmission = String(testConnSaved.last_transmission);
            }
          }

          if (state.selection) {
            state.selection.connection_data_type = testConnPayload.connection_data_type;
            state.selection.connection_status = testConnPayload.connection_status;
            state.selection.status = testConnPayload.connection_status;
            state.selection.last_payload = testConnPayload.last_payload;
            state.selection.last_transmission = testConnPayload.last_transmission;
          }

          var testPreviewEl = document.getElementById('acx-connection-preview');
          if (testPreviewEl) {
            testPreviewEl.value = String(testConnPayload.last_payload || '');
          }
          var testLastEl = document.getElementById('acx-connection-last');
          if (testLastEl) {
            testLastEl.textContent = 'Last transmission: ' + relativeTime(testConnPayload.last_transmission);
          }

          toast('Connection test passed (' + testConnPayload.connection_data_type + ').', 'success');
          return;
        }

        if (action === 'save-connection') {
          if (!connectionId) {
            toast('Missing connection id for save.', 'warning');
            return;
          }

          var connPayload = readConnectionInspectorPayload();

          if (typeof window.updateOrchestratorConnectionConfig === 'function') {
            var connSaved = window.updateOrchestratorConnectionConfig(connectionId, connPayload);
            if (!connSaved) {
              toast('Connection could not be saved.', 'warning');
              return;
            }
            if (typeof connSaved === 'object') {
              if (connSaved.data_type !== undefined) connPayload.connection_data_type = connSaved.data_type;
              if (connSaved.status !== undefined) connPayload.connection_status = normalizeConnectionStatus(connSaved.status);
              if (connSaved.last_payload !== undefined) connPayload.last_payload = String(connSaved.last_payload);
              if (connSaved.last_transmission !== undefined) connPayload.last_transmission = String(connSaved.last_transmission);
            }
          }

          if (state.selection) {
            state.selection.connection_data_type = connPayload.connection_data_type;
            state.selection.connection_status = connPayload.connection_status;
            state.selection.status = connPayload.connection_status;
            state.selection.last_payload = connPayload.last_payload;
            state.selection.last_transmission = connPayload.last_transmission;
          }

          await renderSelection(state.selection || { kind: 'canvas' });
          toast('Connection saved.', 'success');
          return;
        }

        if (action === 'delete-connection') {
          if (typeof window.deleteOrchestratorConnection === 'function' && connectionId) {
            var removed = window.deleteOrchestratorConnection(connectionId);
            if (removed) {
              toast('Connection removed.', 'success');
              state.mode = 'overview';
              state.selection = null;
              setFocus(state.focused || 'business', true);
            } else {
              toast('Connection could not be removed.', 'warning');
            }
          } else {
            toast('Connection delete is available in Orchestrator canvas.', 'warning');
          }
          return;
        }

        if (action === 'view-data-flow') {
          var dataFlow = readConnectionInspectorPayload();
          var sample = String(dataFlow.last_payload || '');
          if (sample.length > 140) sample = sample.slice(0, 140) + '...';
          toast('Data flow: ' + sample, 'info');
          return;
        }

        if (action === 'help-connection') {
          toast('Connection moves data from source node to target node. Use Test to validate payload and status.', 'info');
          return;
        }

        if (action === 'test-trigger') {
          var triggerTypeEl = document.getElementById('acx-trigger-type');
          var triggerTypeText = triggerTypeEl ? String(triggerTypeEl.value || 'trigger').replace(/[_-]+/g, ' ') : 'trigger';
          toast('Trigger test executed (' + triggerTypeText + ').', 'info');
          return;
        }

        if (action === 'save-trigger') {
          if (!nodeId) {
            toast('Missing trigger node id.', 'warning');
            return;
          }

          var typeEl = document.getElementById('acx-trigger-type');
          var descEl = document.getElementById('acx-trigger-description');
          var priorityEl = document.getElementById('acx-trigger-priority');
          var enabledEl = document.getElementById('acx-trigger-enabled');

          var triggerPayload = {
            trigger_type: typeEl ? String(typeEl.value || 'incoming_message') : 'incoming_message',
            trigger_description: descEl ? String(descEl.value || '').trim() : '',
            trigger_priority: priorityEl ? String(priorityEl.value || 'p2') : 'p2',
            trigger_enabled: !!(enabledEl && enabledEl.checked)
          };

          if (!triggerPayload.trigger_description) {
            triggerPayload.trigger_description = state.selection && state.selection.label ? String(state.selection.label) : 'Trigger';
          }

          if (typeof window.updateOrchestratorTriggerConfig === 'function') {
            var saved = window.updateOrchestratorTriggerConfig(nodeId, triggerPayload);
            if (!saved) {
              toast('Trigger could not be saved.', 'warning');
              return;
            }
          }

          if (state.selection) {
            state.selection.trigger_type = triggerPayload.trigger_type;
            state.selection.trigger_description = triggerPayload.trigger_description;
            state.selection.trigger_priority = triggerPayload.trigger_priority;
            state.selection.trigger_enabled = triggerPayload.trigger_enabled;
            state.selection.label = triggerPayload.trigger_description;
          }

          await renderSelection(state.selection || { kind: 'canvas' });
          toast('Trigger saved.', 'success');
          return;
        }

        if (action === 'help-trigger') {
          toast('Trigger starts the flow when the selected event happens. Use Test before Run.', 'info');
          return;
        }

        if (action === 'edit-condition') {
          toast('Condition editor is now inline. Update fields and click Save.', 'info');
          return;
        }

        if (action === 'test-condition') {
          var c = readConditionInspectorPayload();
          var metricKey = String(c.condition_metric || '').toLowerCase();
          var sampleByMetric = {
            roas: 3.4,
            spend: 1250,
            conversions: 17,
            ctr: 2.6
          };
          var sample = (sampleByMetric[metricKey] !== undefined) ? sampleByMetric[metricKey] : 1;
          var op = c.condition_operator;
          var rawThreshold = c.condition_value;

          var pass = false;
          if (op === 'contains') {
            pass = String(sample).toLowerCase().indexOf(String(rawThreshold).toLowerCase()) >= 0;
          } else {
            var left = Number(sample);
            var right = Number(rawThreshold);
            if (!isFinite(left) || !isFinite(right)) {
              left = String(sample);
              right = String(rawThreshold);
            }
            if (op === '>') pass = left > right;
            else if (op === '<') pass = left < right;
            else if (op === '>=') pass = left >= right;
            else if (op === '<=') pass = left <= right;
            else if (op === '==') pass = String(left) === String(right);
            else if (op === '!=') pass = String(left) !== String(right);
          }

          toast('Condition test: ' + c.condition_metric + ' (' + sample + ') ' + op + ' ' + rawThreshold + ' -> ' + (pass ? 'TRUE' : 'FALSE'), pass ? 'success' : 'info');
          return;
        }

        if (action === 'save-condition') {
          if (!nodeId) {
            toast('Missing condition node id.', 'warning');
            return;
          }

          var conditionPayload = readConditionInspectorPayload();

          if (typeof window.updateOrchestratorConditionConfig === 'function') {
            var savedCondition = window.updateOrchestratorConditionConfig(nodeId, conditionPayload);
            if (!savedCondition) {
              toast('Condition could not be saved.', 'warning');
              return;
            }
          }

          if (state.selection) {
            state.selection.condition_metric = conditionPayload.condition_metric;
            state.selection.condition_operator = conditionPayload.condition_operator;
            state.selection.condition_value = conditionPayload.condition_value;
            state.selection.condition_then_label = conditionPayload.condition_then_label;
            state.selection.condition_else_label = conditionPayload.condition_else_label;
            state.selection.label = conditionPayload.label;
          }

          await renderSelection(state.selection || { kind: 'canvas' });
          toast('Condition saved.', 'success');
          return;
        }

        if (action === 'help-condition') {
          toast('Condition evaluates an incoming metric. If TRUE it follows Then branch, otherwise Else.', 'info');
          return;
        }

                if (action === 'edit-output') {
          toast('Output editor is now inline. Update fields and click Save.', 'info');
          return;
        }

        if (action === 'test-output') {
          var testOutputPayload = readOutputInspectorPayload();
          var testPreview = buildOutputPreview(testOutputPayload.output_template, testOutputPayload.output_format);
          var testPreviewEl = document.getElementById('acx-output-preview');
          if (testPreviewEl) {
            testPreviewEl.textContent = testPreview;
          }
          syncOutputDraftToCanvas();
          toast('Output test: ' + testOutputPayload.output_destination + ' (' + testOutputPayload.output_format + ') ready.', 'info');
          return;
        }

        if (action === 'save-output') {
          if (!nodeId) {
            toast('Missing output node id.', 'warning');
            return;
          }

          var outputPayload = readOutputInspectorPayload();

          if (typeof window.updateOrchestratorOutputConfig === 'function') {
            var savedOutput = window.updateOrchestratorOutputConfig(nodeId, outputPayload);
            if (!savedOutput) {
              toast('Output could not be saved.', 'warning');
              return;
            }
          }

          if (state.selection) {
            state.selection.output_format = outputPayload.output_format;
            state.selection.output_template = outputPayload.output_template;
            state.selection.output_destination = outputPayload.output_destination;
            state.selection.label = outputPayload.label;
          }

          await renderSelection(state.selection || { kind: 'canvas' });
          toast('Output saved.', 'success');
          return;
        }

        if (action === 'help-output') {
          toast('Output sends the final flow result to chat/email/webhook/slack. Use placeholders and Test before Run.', 'info');
          return;
        }

        if (action === 'save-connector') {
          if (!slug) {
            toast('Missing connector slug for save.', 'warning');
            return;
          }

          var connectorNameEl = document.getElementById('acx-connector-name');
          var connectorStatusEl = document.getElementById('acx-connector-status');
          var connectorAccountEl = document.getElementById('acx-connector-account');
          var connectorRegionEl = document.getElementById('acx-connector-region');
          var connectorFiltersEl = document.getElementById('acx-connector-filters');
          var connectorByokEl = document.getElementById('acx-connector-byok-toggle');
          var connectorApiKeyEl = document.getElementById('acx-connector-api-key');

          var customName = connectorNameEl ? String(connectorNameEl.value || '').trim() : '';
          if (!customName) {
            customName = state.selection && state.selection.label ? String(state.selection.label) : humanizeSlug(slug);
          }

          var statusValue = connectorStatusEl ? String(connectorStatusEl.value || 'Disconnected') : 'Disconnected';
          var cfgPatch = {};

          if (connectorAccountEl) cfgPatch.account = String(connectorAccountEl.value || '').trim();
          if (connectorRegionEl) cfgPatch.region = String(connectorRegionEl.value || '').trim();
          if (connectorFiltersEl) cfgPatch.filters = String(connectorFiltersEl.value || '').trim();

          var byokEnabledConn = !!(connectorByokEl && connectorByokEl.checked);
          var apiConnValue = connectorApiKeyEl ? String(connectorApiKeyEl.value || '').trim() : '';
          if (!byokEnabledConn) {
            cfgPatch.api_key = '';
          } else if (apiConnValue) {
            cfgPatch.api_key = apiConnValue;
          }

          try {
            var savedConnector = await saveConnectorConfigPatch(slug, {
              status: statusValue,
              custom_name: customName,
              config: cfgPatch
            });

            await fetchConnectorsCatalog();

            if (typeof window.updateOrchestratorNodePresentation === 'function' && nodeId) {
              window.updateOrchestratorNodePresentation(nodeId, {
                label: customName,
                status: (savedConnector && savedConnector.status) ? savedConnector.status : statusValue
              });
            }

            if (state.selection) {
              state.selection.label = customName;
              state.selection.status = (savedConnector && savedConnector.status) ? savedConnector.status : statusValue;
              state.selection.slug = slug;
            }

            await renderSelection(state.selection || { kind: 'canvas' });
            toast('Connector saved.', 'success');
          } catch (errSaveConnector) {
            toast('Connector save failed: ' + (errSaveConnector && errSaveConnector.message ? errSaveConnector.message : 'unknown'), 'warning');
          }
          return;
        }

        if (action === 'view-connector') {
          if (!slug) {
            toast('Missing connector slug for view.', 'warning');
            return;
          }
          window.location.href = '/connectors?focus=' + encodeURIComponent(slug);
          return;
        }

        if (action === 'help-connector') {
          toast('Connector inspector controls status, account settings and API key. Use Fetch/Test before Run.', 'info');
          return;
        }

        if (action === 'fetch-connector') {
          if (!slug) {
            toast('Missing connector slug.', 'warning');
            return;
          }
          var overview = await fetchConnectorOverview(slug);
          if (!overview) {
            toast('No overview data available for this connector.', 'warning');
            return;
          }
          var previewKeys = Object.keys(overview).slice(0, 3);
          var preview = previewKeys.map(function(k) { return k + ': ' + String(overview[k]); }).join(' | ');
          toast('Connector data fetched: ' + (preview || 'ok'), 'success');
          if (state.selection && state.selection.slug === slug) {
            await renderSelection(state.selection);
          }
          return;
        }

        if (action === 'test-connector') {
          if (!slug) {
            toast('Missing connector slug.', 'warning');
            return;
          }
          try {
            var resp = await fetch('/api/connectors/' + encodeURIComponent(slug) + '/test-call', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({})
            });
            if (!resp.ok) {
              toast('Connector test failed (HTTP ' + resp.status + ').', 'warning');
              return;
            }
            toast('Connector test call completed.', 'success');
          } catch (err) {
            toast('Connector test error: ' + (err && err.message ? err.message : 'network'), 'warning');
          }
          return;
        }

        if (action === 'reconnect-connector') {
          if (!slug) {
            toast('Missing connector slug.', 'warning');
            return;
          }
          try {
            var reconnected = await saveConnectorConfigPatch(slug, { status: 'Connected' });
            await fetchConnectorsCatalog();

            if (typeof window.updateOrchestratorNodePresentation === 'function' && nodeId) {
              window.updateOrchestratorNodePresentation(nodeId, {
                status: 'Connected'
              });
            }

            toast('Connector marked as connected.', 'success');
            if (state.selection && state.selection.slug === slug) {
              state.selection.status = (reconnected && reconnected.status) ? reconnected.status : 'Connected';
              await renderSelection(state.selection);
            }
          } catch (errReconnect) {
            toast('Reconnect error: ' + (errReconnect && errReconnect.message ? errReconnect.message : 'unknown'), 'warning');
          }
          return;
        }
      }

      async function fetchAgentsCatalog() {
        try {
          var res = await fetch('/api/agents/list', { cache: 'no-store' });
          var data = await res.json();
          state.agentsCatalog = Array.isArray(data)
            ? data.filter(function(a) { return a && a.slug; })
            : [];
        } catch (err) {
          state.agentsCatalog = [];
        }
      }

      async function refreshContext() {
        try {
          if (!state.agentsCatalog.length) {
            await fetchAgentsCatalog();
          }

          var res = await fetch('/api/active-context', { cache: 'no-store' });
          if (!res.ok) {
            throw new Error('Context HTTP ' + res.status);
          }

          var api = await res.json();
          state.apiSnapshot = api;
          state.workspaces = hydrateFromApi(api);
          state.lastUpdated = api.timestamp || new Date().toISOString();
          state.globalScore = computeGlobalScore();
        } catch (err) {
          if (!state.workspaces || !Object.keys(state.workspaces).length) {
            state.workspaces = defaultWorkspaceData();
          }
          state.lastUpdated = new Date().toISOString();
          state.globalScore = computeGlobalScore();
        }

        renderCompact();
        if (state.mode === 'overview') {
          setFocus(state.focused || 'business', false);
        } else if (state.isOpen) {
          renderSelection(state.selection || {});
        }
      }

      function bindEvents() {
        var quadrants = el.compact.querySelectorAll('.acx-quadrant');

        el.compact.addEventListener('mouseenter', function() {
          if (!state.isOpen) showContextTooltip();
        });
        el.compact.addEventListener('mouseleave', function() {
          showTooltip('');
        });
        el.compact.addEventListener('focusin', function() {
          if (!state.isOpen) showContextTooltip();
        });
        el.compact.addEventListener('focusout', function() {
          showTooltip('');
        });

        quadrants.forEach(function(q) {
          var wsKey = q.getAttribute('data-ws');

          q.addEventListener('click', function(ev) {
            ev.preventDefault();
            ev.stopPropagation();
            setFocus(wsKey, true);
          });
        });

        el.compact.addEventListener('click', function(ev) {
          if (ev.target && ev.target.closest && ev.target.closest('.acx-quadrant')) {
            return;
          }
          ev.preventDefault();
          if (state.isOpen && state.mode === 'overview') {
            setPanelOpen(false);
          } else {
            state.mode = 'overview';
            state.selection = null;
            setFocus(state.focused || 'business', true);
          }
        });

        if (el.center) {
          el.center.addEventListener('click', function(ev) {
            ev.preventDefault();
            ev.stopPropagation();
            if (state.isOpen) {
              setPanelOpen(false);
            } else {
              state.mode = 'overview';
              state.selection = null;
              setFocus(state.focused || 'business', true);
            }
          });
        }

        el.compact.addEventListener('keydown', function(ev) {
          if (ev.key === 'Enter' || ev.key === ' ') {
            ev.preventDefault();
            if (state.isOpen) {
              setPanelOpen(false);
            } else {
              state.mode = 'overview';
              state.selection = null;
              setFocus(state.focused || 'business', true);
            }
          }
        });

        if (el.closeBtn) {
          el.closeBtn.addEventListener('click', function(ev) {
            ev.preventDefault();
            setPanelOpen(false);
          });
        }

        if (el.overlay) {
          el.overlay.addEventListener('click', function() {
            setPanelOpen(false);
          });
        }

        el.grid.addEventListener('click', function(ev) {
          var nodeActionBtn = ev.target.closest('[data-acx-node-action]');
          if (nodeActionBtn) {
            ev.stopPropagation();
            handleNodeAction(nodeActionBtn);
            return;
          }

          var actionBtn = ev.target.closest('[data-acx-action]');
          if (actionBtn) {
            ev.stopPropagation();
            var action = actionBtn.getAttribute('data-acx-action');
            var wsKey = actionBtn.getAttribute('data-ws');
            if (action === 'send') {
              sendToAgent(wsKey);
              return;
            }
            if (action === 'add') {
              addToFlow(wsKey);
              return;
            }
          }

          var card = ev.target.closest('.acx-card');
          if (card && card.getAttribute('data-ws') && state.mode === 'overview') {
            setFocus(card.getAttribute('data-ws'), false);
          }
        });

        el.grid.addEventListener('change', function(ev) {
          var target = ev.target;
          if (!target) return;

          if (target.id === 'acx-agent-avatar-upload') {
            handleAgentAvatarInput(target);
            return;
          }

          if (target.id === 'acx-agent-byok-toggle') {
            var keyInput = document.getElementById('acx-agent-api-key');
            if (keyInput) {
              keyInput.disabled = !target.checked;
              if (!target.checked) keyInput.value = '';
            }
            return;
          }
          if (target.id === 'acx-connector-byok-toggle') {
            var connectorKeyInput = document.getElementById('acx-connector-api-key');
            if (connectorKeyInput) {
              connectorKeyInput.disabled = !target.checked;
              if (!target.checked) connectorKeyInput.value = '';
            }
            return;
          }

                    if (
            target.id === 'acx-condition-metric'
            || target.id === 'acx-condition-operator'
            || target.id === 'acx-condition-then'
            || target.id === 'acx-condition-else'
          ) {
            syncConditionDraftToCanvas();
            return;
          }

                    if (
            target.id === 'acx-output-format'
            || target.id === 'acx-output-destination'
          ) {
            syncOutputDraftToCanvas();
            return;
          }

          if (
            target.id === 'acx-connection-data-type'
            || target.id === 'acx-connection-status'
          ) {
            syncConnectionDraftToCanvas();
            return;
          }
        });

        el.grid.addEventListener('input', function(ev) {
          var target = ev.target;
          if (!target) return;

          if (target.id === 'acx-agent-temperature') {
            var valueEl = document.getElementById('acx-agent-temperature-value');
            if (valueEl) {
              var n = Number(target.value);
              if (!isFinite(n)) n = 0.7;
              valueEl.textContent = n.toFixed(1);
            }
            return;
          }

                    if (target.id === 'acx-condition-value') {
            syncConditionDraftToCanvas();
            return;
          }

                    if (target.id === 'acx-output-template') {
            syncOutputDraftToCanvas();
            return;
          }

          if (target.id === 'acx-connection-preview') {
            syncConnectionDraftToCanvas();
            return;
          }
        });

        document.addEventListener('keydown', function(ev) {
          if (ev.key === 'Escape' && state.isOpen) {
            setPanelOpen(false);
          }
        });
      }

      window.setActiveContextSelection = function(selection) {
        if (!selection || selection.kind === 'canvas') {
          state.mode = 'overview';
          state.selection = null;
          setFocus(state.focused || 'business', true);
          return;
        }

        state.mode = 'selection';
        state.selection = selection;

        var wsKey = inferWorkspaceFromSelection(selection);
        state.focused = wsKey;
        var quadrants = el.compact.querySelectorAll('.acx-quadrant');
        quadrants.forEach(function(q) {
          q.classList.toggle('active', q.getAttribute('data-ws') === wsKey);
        });

        renderSelection(selection);
        setPanelOpen(true);
      };

      window.openActiveContextDrawer = function() {
        state.mode = 'overview';
        state.selection = null;
        setFocus(state.focused || 'business', true);
      };

      window.closeActiveContextDrawer = function() {
        setPanelOpen(false);
      };

      // Inspector aliases (keeps existing Active Context API backwards-compatible).
      window.setInspectorSelection = window.setActiveContextSelection;
      window.openInspectorDrawer = window.openActiveContextDrawer;
      window.closeInspectorDrawer = window.closeActiveContextDrawer;

      state.workspaces = defaultWorkspaceData();
      state.globalScore = computeGlobalScore();

      bindEvents();
      renderCompact();
      renderOverview();
      setFocus(state.focused, false);
      refreshContext();
      setInterval(refreshContext, ACX_REFRESH_MS);
    })();
  </script>
  {% block extra_js %}{% endblock %}
</body>
</html>






























